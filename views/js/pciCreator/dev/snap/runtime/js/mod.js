define([],function(){"use strict";var panel_Left,stageSaver,worldwatcher,importString="",attemptLimit=0,mod={},world;return mod.snap=function(id,$container,config){function localize(t){return SnapTranslator.translate(t)}function Localizer(t,e){this.language=t||"en",this.dict=e||{}}function nop(){return null}function localize(t){return dicofr[t]?dicofr[t]:t}function isNil(t){return void 0===t||null===t}function contains(t,e){return-1!==t.indexOf(e)}function detect(t,e){var o,i=t.length;for(o=0;o<i;o+=1)if(e.call(null,t[o]))return t[o];return null}function sizeOf(t){var e,o=0;for(e in t)Object.prototype.hasOwnProperty.call(t,e)&&(o+=1);return o}function isString(t){return"string"==typeof t||t instanceof String}function isObject(t){return null!==t&&("object"==typeof t||t instanceof Object)}function radians(t){return t*Math.PI/180}function degrees(t){return 180*t/Math.PI}function fontHeight(t){return 1.2*Math.max(t,MorphicPreferences.minimumFontHeight)}function isWordChar(t){return t.match(/[A-zÀ-ÿ0-9]/)}function newCanvas(t,e){var o,i;return i=t||{x:0,y:0},o=document.createElement("canvas"),o.width=i.x,o.height=i.y,e&&o.isRetinaEnabled&&(o.isRetinaEnabled=!1),o}function getMinimumFontHeight(){var t,e,o,i,r=document.createElement("canvas");for(r.width=50,r.height=50,(t=r.getContext("2d")).font="1px serif",e=t.measureText("I").width,t.fillStyle="black",t.textBaseline="bottom",t.fillText("I",0,50),i=0;i<50;i+=1)for(o=0;o<e;o+=1)if(0!==t.getImageData(o,i,1,1).data[3])return 50-i+1;return 0}function getBlurredShadowSupport(){var t,e,o;return t=document.createElement("canvas"),t.width=10,t.height=10,o=t.getContext("2d"),o.fillStyle="rgb(255, 0, 0)",o.beginPath(),o.arc(5,5,5,0,2*Math.PI,!0),o.closePath(),o.fill(),e=document.createElement("canvas"),e.width=10,e.height=10,o=e.getContext("2d"),o.shadowBlur=10,o.shadowColor="rgba(0, 0, 255, 1)",o.drawImage(t,0,0),!!o.getImageData(0,0,1,1).data[3]}function getDocumentPositionOf(t){var e,o;if(null===t)return{x:0,y:0};for(e={x:t.offsetLeft,y:t.offsetTop},o=t.offsetParent;null!==o;)e.x+=o.offsetLeft,e.y+=o.offsetTop,o!==document.body&&o!==document.documentElement&&(e.x-=o.scrollLeft,e.y-=o.scrollTop),o=o.offsetParent;return e}function copy(t){var e,o,i,r,n,s;if("object"!=typeof t)return t;if(e=t.valueOf(),t!==e)return new t.constructor(e);if(t instanceof t.constructor&&t.constructor!==Object)for(o=Object.create(t.constructor.prototype),n=(r=Object.keys(t)).length,s=0;s<n;s+=1)o[i=r[s]]=t[i];else{o={};for(i in t)o[i]=t[i]}return o}function enableRetinaSupport(){function t(t){return t.isRetinaEnabled?(i||1)/o:1}var e=document.createElement("canvas").getContext("2d"),o=e.webkitBackingStorePixelRatio||e.mozBackingStorePixelRatio||e.msBackingStorePixelRatio||e.oBackingStorePixelRatio||e.backingStorePixelRatio||1,i=Math.ceil(window.devicePixelRatio),r=HTMLCanvasElement.prototype,n=CanvasRenderingContext2D.prototype,s={drawImage:n.drawImage,getImageData:n.getImageData,width:Object.getOwnPropertyDescriptor(r,"width"),height:Object.getOwnPropertyDescriptor(r,"height"),shadowOffsetX:Object.getOwnPropertyDescriptor(n,"shadowOffsetX"),shadowOffsetY:Object.getOwnPropertyDescriptor(n,"shadowOffsetY"),shadowBlur:Object.getOwnPropertyDescriptor(n,"shadowBlur")};o!==i&&(Object.keys(s).some(function(t){var e=s[t];return e.hasOwnProperty("configurable")&&!e.configurable})||(r._isRetinaEnabled=!0,r._bak=s,Object.defineProperty(r,"isRetinaEnabled",{get:function(){return this._isRetinaEnabled},set:function(e){var o=t(this),i=this.width,r=this.height;this._isRetinaEnabled=e,t(this)!=o&&(this.width=i,this.height=r)},configurable:!0}),Object.defineProperty(r,"width",{get:function(){return s.width.get.call(this)/t(this)},set:function(e){try{var o,i=t(this);s.width.set.call(this,e*i),(o=this.getContext("2d")).restore(),o.save(),o.scale(i,i)}catch(t){console.log("Retina Display Support Problem",t),s.width.set.call(this,e)}}}),Object.defineProperty(r,"height",{get:function(){return s.height.get.call(this)/t(this)},set:function(e){var o,i=t(this);s.height.set.call(this,e*i),(o=this.getContext("2d")).restore(),o.save(),o.scale(i,i)}}),n.drawImage=function(e){var o,i,r,n,a,h,l,p,c=t(e);switch(arguments.length){case 9:o=arguments[1],i=arguments[2],r=arguments[3],n=arguments[4],a=arguments[5],h=arguments[6],l=arguments[7],p=arguments[8];break;case 5:o=0,i=0,r=e.width,n=e.height,a=arguments[1],h=arguments[2],l=arguments[3],p=arguments[4];break;case 3:o=0,i=0,r=e.width,n=e.height,a=arguments[1],h=arguments[2],l=e.width,p=e.height;break;default:throw Error("Called drawImage() with "+arguments.length+" arguments")}s.drawImage.call(this,e,o*c,i*c,r*c,n*c,a,h,l,p)},n.getImageData=function(e,o,i,r){var n=t(this.canvas);return s.getImageData.call(this,e*n,o*n,i*n,r*n)},Object.defineProperty(n,"shadowOffsetX",{get:function(){return s.shadowOffsetX.get.call(this)/t(this.canvas)},set:function(e){var o=t(this.canvas);s.shadowOffsetX.set.call(this,e*o)}}),Object.defineProperty(n,"shadowOffsetY",{get:function(){return s.shadowOffsetY.get.call(this)/t(this.canvas)},set:function(e){var o=t(this.canvas);s.shadowOffsetY.set.call(this,e*o)}}),Object.defineProperty(n,"shadowBlur",{get:function(){return s.shadowBlur.get.call(this)/t(this.canvas)},set:function(e){var o=t(this.canvas);s.shadowBlur.set.call(this,e*o)}})))}function isRetinaSupported(){var t=document.createElement("canvas").getContext("2d"),e=t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1,o=HTMLCanvasElement.prototype,i=CanvasRenderingContext2D.prototype,r={drawImage:i.drawImage,getImageData:i.getImageData,width:Object.getOwnPropertyDescriptor(o,"width"),height:Object.getOwnPropertyDescriptor(o,"height"),shadowOffsetX:Object.getOwnPropertyDescriptor(i,"shadowOffsetX"),shadowOffsetY:Object.getOwnPropertyDescriptor(i,"shadowOffsetY"),shadowBlur:Object.getOwnPropertyDescriptor(i,"shadowBlur")};return e!==window.devicePixelRatio&&!Object.keys(r).some(function(t){var e=r[t];return e.hasOwnProperty("configurable")&&!e.configurable})}function isRetinaEnabled(){return HTMLCanvasElement.prototype.hasOwnProperty("_isRetinaEnabled")}function disableRetinaSupport(){var t,e,o;isRetinaEnabled()&&(t=HTMLCanvasElement.prototype,e=CanvasRenderingContext2D.prototype,o=t._bak,Object.defineProperty(t,"width",o.width),Object.defineProperty(t,"height",o.height),e.drawImage=o.drawImage,e.getImageData=o.getImageData,Object.defineProperty(e,"shadowOffsetX",o.shadowOffsetX),Object.defineProperty(e,"shadowOffsetY",o.shadowOffsetY),Object.defineProperty(e,"shadowBlur",o.shadowBlur),delete t._isRetinaEnabled,delete t.isRetinaEnabled,delete t._bak)}function normalizeCanvas(t,e){var o;return t.isRetinaEnabled?((o=newCanvas(new Point(t.width,t.height),!0)).getContext("2d").drawImage(t,0,0),e?o:(t.isRetinaEnabled=!1,t.width=o.width,t.height=o.height,t.getContext("2d").drawImage(o,0,0),t)):t}function Animation(t,e,o,i,r,n){this.setter=t,this.getter=e,this.delta=o||0,this.duration=i||0,this.easing=isString(r)?this.easings[r]||this.easings.sinusoidal:r||this.easings.sinusoidal,this.onComplete=n||null,this.endTime=null,this.destination=null,this.isActive=!1,this.start()}function Color(t,e,o,i){this.r=t||0,this.g=e||0,this.b=o||0,this.a=i||(0===i?0:1)}function Point(t,e){this.x=t||0,this.y=e||0}function Rectangle(t,e,o,i){this.init(new Point(t||0,e||0),new Point(o||0,i||0))}function Node(t,e){this.init(t||null,e||[])}function Morph(){this.init()}function ShadowMorph(){this.init()}function HandleMorph(t,e,o,i,r,n){this.init(t,e,o,i,r,n)}function PenMorph(){this.init()}function ColorPaletteMorph(t,e){this.init(t||null,e||new Point(80,50))}function GrayPaletteMorph(t,e){this.init(t||null,e||new Point(80,10))}function ColorPickerMorph(t){this.init(t||new Color(255,255,255))}function BlinkerMorph(t){this.init(t)}function CursorMorph(t){this.init(t)}function BoxMorph(t,e,o){this.init(t,e,o)}function SpeechBubbleMorph(t,e,o,i,r,n,s){this.init(t,e,o,i,r,n,s)}function CircleBoxMorph(t){this.init(t||"vertical")}function SliderButtonMorph(t){this.init(t)}function SliderMorph(t,e,o,i,r,n){this.init(t||1,e||100,o||50,i||10,r||"vertical",n)}function MouseSensorMorph(t,e,o){this.init(t,e,o)}function InspectorMorph(t){this.init(t)}function MenuMorph(t,e,o,i){this.init(t,e,o,i)}function StringMorph(t,e,o,i,r,n,s,a,h,l){this.init(t,e,o,i,r,n,s,a,h,l)}function TextMorph(t,e,o,i,r,n,s,a,h,l){this.init(t,e,o,i,r,n,s,a,h,l)}function TriggerMorph(t,e,o,i,r,n,s,a,h,l,p){this.init(t,e,o,i,r,n,s,a,h,l,p)}function MenuItemMorph(t,e,o,i,r,n,s,a,h,l,p,c){this.shortcutString=c||null,this.shortcut=null,this.init(t,e,o,i,r,n,s,a,h,l,p)}function FrameMorph(t){this.init(t)}function ScrollFrameMorph(t,e,o){this.init(t,e,o)}function ListMorph(t,e,o,i){this.init(t||[],e||function(t){return isString(t)?t:t.toSource?t.toSource():t.toString()},o||[],i)}function StringFieldMorph(t,e,o,i,r,n,s){this.init(t||"",e||100,o||12,i||"sans-serif",r||!1,n||!1,s)}function BouncerMorph(){this.init()}function HandMorph(t){this.init(t)}function WorldMorph(t,e){this.init(t,e)}function PushButtonMorph(t,e,o,i,r,n){this.init(t,e,o,i,r,n)}function ToggleButtonMorph(t,e,o,i,r,n,s,a,h,l,p){this.init(t,e,o,i,r,n,s,a,h,l,p)}function TabMorph(t,e,o,i,r,n,s){this.init(t,e,o,i,r,n,s)}function ToggleMorph(t,e,o,i,r,n,s,a,h,l){this.init(t,e,o,i,r,n,s,a,h,l)}function ToggleElementMorph(t,e,o,i,r,n,s,a){this.init(t,e,o,i,r,n,s,a)}function DialogBoxMorph(t,e,o){this.init(t,e,o)}function AlignmentMorph(t,e){this.init(t,e)}function InputFieldMorph(t,e,o,i){this.init(t,e,o,i)}function PianoMenuMorph(t,e,o,i){this.init(t,e,o,i)}function PianoKeyMorph(t,e,o,i,r,n,s,a,h,l,p,c){this.init(t,e,o,i,r,n,s,a,h,l,p,c),this.feedback=c}function SyntaxElementMorph(){this.init()}function BlockMorph(){this.init()}function CommandBlockMorph(){this.init()}function HatBlockMorph(){this.init()}function ReporterBlockMorph(t){this.init(t)}function RingMorph(){this.init()}function ScriptsMorph(){this.init()}function ArgMorph(t){this.init(t)}function CommandSlotMorph(){this.init()}function RingCommandSlotMorph(){this.init()}function CSlotMorph(){this.init()}function InputSlotMorph(t,e,o,i){this.init(t,e,o,i)}function TemplateSlotMorph(t){this.init(t)}function BooleanSlotMorph(t){this.init(t)}function ArrowMorph(t,e,o,i){this.init(t,e,o,i)}function TextSlotMorph(t,e,o,i){this.init(t,e,o,i)}function ColorSlotMorph(t){this.init(t)}function BlockHighlightMorph(){this.threadCount=0,this.init()}function MultiArgMorph(t,e,o,i,r,n,s,a,h){this.init(t,e,o,i,r,n,s,a,h)}function ArgLabelMorph(t,e){this.init(t,e)}function FunctionSlotMorph(t){this.init(t)}function ReporterSlotMorph(t){this.init(t)}function RingReporterSlotMorph(t){this.init(t)}function CommentMorph(t){this.init(t)}function ScriptFocusMorph(t,e,o){this.init(t,e,o)}function snapEquals(t,e){if(t instanceof List||e instanceof List)return t instanceof List&&e instanceof List&&t.equalTo(e);var o,i=+t,r=+e,n=[!0,!1,""];for(o=9;o<=13;o+=1)n.push(String.fromCharCode(o));return n.push(String.fromCharCode(160)),(isNaN(i)||isNaN(r)||[t,e].some(function(t){return contains(n,t)||isString(t)&&t.indexOf(" ")>-1}))&&(i=t,r=e),isString(i)&&isString(r)?i.toLowerCase()===r.toLowerCase():i===r}function invoke(t,e,o,i,r,n){var s=new Process,a=i?Date.now()+i:null;if(t instanceof Context)o&&(t=s.reportContextFor(o)),s.initializeFor(t,e||new List);else{if(!(t instanceof BlockMorph)){if(t.evaluate)return t.evaluate();throw new Error("expecting a block or ring but getting "+t)}if(s.topBlock=t,!o)throw new Error("expecting a receiver but getting "+o);s.homeContext=new Context,s.homeContext.receiver=o,o.variables&&(s.homeContext.variables.parentFrame=o.variables),s.context=new Context(null,t.blockSequence(),s.homeContext)}for(n&&(s.isCatchingErrors=!1);s.isRunning();){if(a&&Date.now()>a)throw new Error(localize(r||"a synchronous Snap! script has timed out"));s.runStep(a)}return s.homeContext.inputs[0]}function ThreadManager(){this.processes=[],this.wantsToPause=!1}function compteur(){compteurGo++,$container.find(".compteur").html(";Nombre de tentatives : "+compteurGo);var t=config.Attemptlimiter-compteurGo;t>1&&(world.children[0].projectName=" ATTENTION : Il vous reste "+(t-1)+" tentatives !"),1==t&&(world.children[0].projectName=" ATTENTION DERNIERE TENTATIVE !"),world.children[0].controlBar.updateLabel(),compteurGo>=config.Attemptlimiter&&0!=config.Attemptlimiter&&($container.find("#world").hide(),$container.find(".snapy").append("<div style='width : 100%; height:900px; background-Color:#ce8686; opacity: 1;padding:25%; font-size: 20px; position:fixed;'></div"),$container.find(".snapy").append("<div style='width : 100%; height:900px; padding:25%; font-size:40px; position:fixed; opacity: 1' >NOMBRE D'ESSAIS MAXIMUM ATTEINT SOUMETTEZ VOTRE REPONSE POUR CONTINUER</div>"))}function Process(t,e,o,i){this.topBlock=t||null,this.receiver=e,this.instrument=e?e.instrument:null,this.readyToYield=!1,this.readyToTerminate=!1,this.isDead=!1,this.isClicked=!1,this.isShowingResult=!1,this.errorFlag=!1,this.context=null,this.homeContext=new Context(null,null,null,e),this.lastYield=Date.now(),this.isFirstStep=!0,this.isAtomic=!1,this.prompter=null,this.httpRequest=null,this.isPaused=!1,this.pauseOffset=null,this.frameCount=0,this.exportResult=!1,this.onComplete=o||null,this.procedureCount=0,this.flashingContext=null,this.isInterrupted=!1,t&&(this.homeContext.variables.parentFrame=this.homeContext.receiver.variables,this.context=new Context(null,t.blockSequence(),this.homeContext),i&&this.pushContext("doYield"))}function Context(t,e,o,i){this.outerContext=o||null,this.parentContext=t||null,this.expression=e||null,this.receiver=i||null,this.origin=i||null,this.variables=new VariableFrame,this.outerContext&&(this.variables.parentFrame=this.outerContext.variables,this.receiver=this.outerContext.receiver),this.inputs=[],this.pc=0,this.isContinuation=!1,this.startTime=null,this.activeAudio=null,this.activeNote=null,this.isCustomBlock=!1,this.emptySlots=0,this.tag=null,this.isFlashing=!1}function Variable(t,e){this.value=t,this.isTransient=e||!1}function VariableFrame(t,e){this.vars={},this.parentFrame=t||null,this.owner=e||null}function isSnapObject(t){return t instanceof SpriteMorph||t instanceof StageMorph}function SpriteMorph(t){this.init(t)}function SpriteHighlightMorph(){this.init()}function StageMorph(t){this.init(t)}function SpriteBubbleMorph(t,e,o,i){this.init(t,e,o,i)}function Costume(t,e,o){this.contents=t?normalizeCanvas(t,!0):newCanvas(null,!0),this.shrinkToFit(this.maxExtent()),this.name=e||null,this.rotationCenter=o||this.center(),this.version=Date.now(),this.loaded=null}function SVG_Costume(t,e,o){this.contents=t,this.shrinkToFit(this.maxExtent()),this.name=e||null,this.rotationCenter=o||this.center(),this.version=Date.now(),this.loaded=null}function CostumeEditorMorph(t){this.init(t)}function Sound(t,e){this.audio=t,this.name=e||"Sound"}function Note(t){this.pitch=0===t?0:t||69,this.setupContext(),this.oscillator=null}function CellMorph(t,e,o,i){this.init(t,e,o,i)}function WatcherMorph(t,e,o,i,r){this.init(t,e,o,i,r)}function StagePrompterMorph(t){this.init(t)}function IDE_Morph(t){this.init(t)}function ProjectDialogMorph(t,e){this.init(t,e)}function LibraryImportDialogMorph(t,e){this.init(t,e)}function SpriteIconMorph(t,e){this.init(t,e)}function CostumeIconMorph(t,e){this.init(t,e)}function TurtleIconMorph(t,e){this.init(t,e)}function WardrobeMorph(t,e){this.init(t,e)}function SoundIconMorph(t,e){this.init(t,e)}function JukeboxMorph(t,e){this.init(t,e)}function StageHandleMorph(t){this.init(t)}function PaletteHandleMorph(t){this.init(t)}function CamSnapshotDialogMorph(t,e,o,i){this.init(t,e,o,i)}function PaintEditorMorph(){this.init()}function PaintColorPickerMorph(t,e){this.init(t,e)}function PaintCanvasMorph(t){this.init(t)}function List(t){this.type=null,this.contents=t||[],this.first=null,this.rest=null,this.isLinked=!1,this.lastChanged=Date.now()}function ListWatcherMorph(t,e){this.init(t,e)}function CustomBlockDefinition(t,e){this.body=null,this.scripts=[],this.category=null,this.isGlobal=!1,this.type="command",this.spec=t||"",this.declarations={},this.variableNames=[],this.comment=null,this.codeMapping=null,this.codeHeader=null,this.translations={},this.receiver=e||null,this.editorDimensions=null,this.cachedIsRecursive=null,this.cachedTranslation=null}function CustomCommandBlockMorph(t,e){this.init(t,e)}function CustomReporterBlockMorph(t,e,o){this.init(t,e,o)}function JaggedBlockMorph(t){this.init(t)}function BlockDialogMorph(t,e,o){this.init(t,e,o)}function BlockEditorMorph(t,e){this.init(t,e)}function PrototypeHatBlockMorph(t){this.init(t)}function BlockLabelFragment(t){this.labelString=t||"",this.type="%s",this.defaultValue="",this.options="",this.isReadOnly=!1,this.isDeleted=!1}function BlockLabelFragmentMorph(t){this.init(t)}function BlockLabelPlaceHolderMorph(){this.init()}function BlockInputFragmentMorph(t){this.init(t)}function InputSlotDialogMorph(t,e,o,i,r){this.init(t,e,o,i,r)}function VariableDialogMorph(t,e,o){this.init(t,e,o)}function BlockExportDialogMorph(t,e){this.init(t,e)}function BlockImportDialogMorph(t,e,o){this.init(t,e,o)}function BlockRemovalDialogMorph(t,e){this.init(t,e)}function Table(t,e){this.colCount=+t,this.rowCount=+e,this.colNames=[],this.rowNames=[],this.contents=new Array(+e);for(var o=0;o<e;o+=1)this.contents[o]=new Array(+t);this.lastChanged=Date.now()}function TableCellMorph(t,e,o){this.init(t,e,o)}function TableMorph(t,e,o,i,r,n,s,a,h,l){this.init(t,e,o,i,r,n,s,a,h,l)}function TableFrameMorph(t,e){this.init(t,e)}function TableDialogMorph(t,e,o,i){this.init(t,e,o,i)}function SymbolMorph(t,e,o,i,r){this.init(t,e,o,i,r)}function ReadStream(t){this.contents=t||"",this.index=0}function XML_Element(t,e,o){this.init(t,e,o)}function XML_Serializer(){this.contents=[],this.media=[],this.isCollectingMedia=!1,this.isExportingBlocksLibrary=!1}function SnapSerializer(){this.init()}function Cloud(t){this.username=null,this.password=null,this.url=t,this.session=null,this.limo=null,this.route=null,this.api={}}function LeftReducer(){panel_Left.setPaletteWidth(1)}function LeftExpand(){panel_Left.setPaletteWidth(200)}function loop(){requestAnimationFrame(loop),world.doOneCycle()}function importator(){var t=world.children[0],e=document.createElement("input");t.filePicker&&(document.body.removeChild(t.filePicker),t.filePicker=null),e.type="file",e.style.color="transparent",e.style.backgroundColor="transparent",e.style.border="none",e.style.outline="none",e.style.position="absolute",e.style.top="0px",e.style.left="0px",e.style.width="0px",e.style.height="0px",e.style.display="none",e.addEventListener("change",function(){document.body.removeChild(e),t.filePicker=null,world.hand.processDrop(e.files)},!1),document.body.appendChild(e),t.filePicker=e,e.click()}var Localizer,SnapTranslator=new Localizer;importString="shield"==config.snapScriptSaver?"":config.snapScriptSaver,Localizer.prototype.translate=function(t){return Object.prototype.hasOwnProperty.call(this.dict[this.language],t)?this.dict[this.language][t]:t},Localizer.prototype.languages=function(){var t,e=[];for(t in this.dict)Object.prototype.hasOwnProperty.call(this.dict,t)&&e.push(t);return e.sort()},Localizer.prototype.languageName=function(t){return this.dict[t].language_name||t},Localizer.prototype.credits=function(){var t="",e=this;return this.languages().forEach(function(o){t=t+"\n"+e.languageName(o)+" ("+o+") - "+e.dict[o].language_translator+" - "+e.dict[o].last_changed}),t},Localizer.prototype.unload=function(){var t,e=["language_name","language_translator","last_changed"],o=this;this.languages().forEach(function(i){var r;if("en"!==i){t=o.dict[i];for(r in t)Object.prototype.hasOwnProperty.call(t,r)&&!contains(e,r)&&delete t[r]}})},SnapTranslator.dict.en={language_name:"English",language_translator:"Jens Mönig","translator_e-mail":"jens@moenig.org",last_changed:"2015-12-22",any:"random","file menu import hint":"load an exported project file\nor block library, a costume\nor a sound","settings menu prefer empty slots hint":"check to focus on empty slots\nwhen dragging & dropping reporters","costumes tab help":"import a picture from another web page or from\na file on your computer by dropping it here\n","block deletion dialog text":"Are you sure you want to delete this\ncustom block and all its instances?","download to disk text":"This item could not be opened in a new tab.\nIt has been saved to your browser's downloads folder.","unable to export text":"This item could not be exported from Snap!.\nIt's likely that your project may contain a lot of media (sounds and images) or that you are using an older browser.Please try using a recent version of Chrome, Firefox, or Safari."},SnapTranslator.dict.fr={language_name:"Français",language_translator:"Jean-Jacques Valliet, Mark Rafter, Martin Quinson, Damien Caselli","translator_e-mail":"i.scool@mac.com",last_changed:"2016-10-27"};var morphicVersion="2017-September-26",modules={},useBlurredShadows=getBlurredShadowSupport(),standardSettings={minimumFontHeight:getMinimumFontHeight(),globalFontFamily:"",menuFontName:"sans-serif",menuFontSize:12,bubbleHelpFontSize:10,prompterFontName:"sans-serif",prompterFontSize:12,prompterSliderSize:10,handleSize:15,scrollBarSize:12,mouseScrollAmount:40,useSliderForInput:!1,useVirtualKeyboard:!0,isTouchDevice:!1,rasterizeSVGs:!1,isFlat:!1,grabThreshold:5},touchScreenSettings={minimumFontHeight:standardSettings.minimumFontHeight,globalFontFamily:"",menuFontName:"sans-serif",menuFontSize:24,bubbleHelpFontSize:18,prompterFontName:"sans-serif",prompterFontSize:24,prompterSliderSize:20,handleSize:26,scrollBarSize:24,mouseScrollAmount:40,useSliderForInput:!0,useVirtualKeyboard:!0,isTouchDevice:!1,rasterizeSVGs:!1,isFlat:!1,grabThreshold:5},MorphicPreferences=standardSettings;enableRetinaSupport();var dicofr={language_name:"Français",language_translator:"Jean-Jacques Valliet, Mark Rafter, Martin Quinson, Damien Caselli","translator_e-mail":"i.scool@mac.com",last_changed:"2016-10-27",untitled:"Sans Titre","development mode":"mode développeur",Motion:"Mouvement",Looks:"Apparence",Sound:"Sons",Pen:"Stylo",Control:"Contrôles",Sensing:"Capteurs",Operators:"Opérateurs",Variables:"Variables",Lists:"Listes",Other:"Autres",draggable:"déplaçable avec la souris",Scripts:"Scripts",Costumes:"Costumes",Sounds:"Sons",Sprite:"Lutin",Stage:"Scène","don't rotate":"le lutin ne pivote jamais","can rotate":"le lutin pivote \nautour de son centre de rotation","only face left/right":"le lutin reste en position horizontale \nsoit vers la gauche soit vers la droite ","add a new sprite":"ajouter un nouveau lutin","add a new Turtle sprite":"ajouter un nouveau lutin Tortue","costumes tab help":"Importer une image depuis votre ordinateur ou une page web \npar un presser-glisser-déposer dans l'aire des costumes","import a sound from your computer\nby dragging it into here":"Importer un son depuis votre ordinateur \npar un presser-glisser-déposer dans l'aire des sons","Stage selected:\nno motion primitives":"Scène sélectionnée :\naucune brique de déplaçement","move %n steps":"avancer de %n pas","turn %clockwise %n degrees":"tourner de %n degrés %clockwise","turn %counterclockwise %n degrees":"tourner de %n degrés %counterclockwise","point in direction %dir":"se diriger en faisant un angle de %dir","point towards %dst":"se diriger vers %dst","go to x: %n y: %n":"aller à x: %n y: %n","go to %dst":"aller à %dst","glide %n secs to x: %n y: %n":"glisser en %n sec. à x: %n y: %n","change x by %n":"ajouter %n à x","set x to %n":"donner la valeur %n à x","change y by %n":"ajouter %n à y","set y to %n":"donner la valeur %n à y","if on edge, bounce":"rebondir si le bord est atteint","x position":"position x","y position":"position y",direction:"direction","switch to costume %cst":"basculer sur le costume %cst","next costume":"costume suivant","costume #":"costume n°","say %s for %n secs":"dire %s pendant %n sec.","say %s":"dire %s","think %s for %n secs":"penser %s pendant %n sec.","think %s":"penser %s","Hello!":"Salut !","Hmm...":"Mmmh...","change %eff effect by %n":"ajouter à l'effet %eff %n","set %eff effect to %n":"mettre l'effet %eff à %n","clear graphic effects":"annuler les effets graphiques","change size by %n":"ajouter %n à la taille","set size to %n %":"choisir %n % de la taille initiale",size:"taille",show:"montrer",hide:"cacher","go to front":"envoyer au premier plan","go back %n layers":"déplacer de %n plan arrière","development mode \ndebugging primitives:":"mode développement \ndebugging primitives:","console log %mult%s":"console log %mult%s","alert %mult%s":"Pop-up: %mult%s","play sound %snd":"jouer le son %snd","play sound %snd until done":"jouer le son %snd jusqu'au bout","stop all sounds":"arrêter tous les sons","rest for %n beats":"faire une pause pour %n temps","play note %n for %n beats":"jouer la note %n pour %n temps","change tempo by %n":"ajouter %n au tempo","set tempo to %n bpm":"choisir le tempo à %n bpm",tempo:"tempo",clear:"effacer tout","pen down":"stylo en position d'écriture","pen up":"relever le stylo","set pen color to %clr":"mettre la couleur %clr pour le stylo","change pen color by %n":"ajouter %n à la couleur du stylo","set pen color to %n":"choisir la couleur %n pour le stylo","change pen shade by %n":"ajouter %n à l'intensité du stylo ","set pen shade to %n":"choisir l'intensité %n pour le stylo","change pen size by %n":"ajouter %n à la taille du stylo ","set pen size to %n":"choisir la taille %n pour le stylo",stamp:"estampiller",fill:"remplir","when %greenflag clicked":"Quand %greenflag est pressé","when %keyHat key pressed":"Quand %keyHat est pressé","when I am clicked":"Quand je suis pressé ","when I am %interaction":"Quand je suis %interaction","when I receive %msgHat":"Quand je reçois %msgHat","broadcast %msg":"envoyer à tous %msg","broadcast %msg and wait":"envoyer à tous %msg et attendre","Message name":"Nom du message","wait %n secs":"attendre %n sec.","wait until %b":"attendre jusqu'à %b","forever %c":"répéter indéfiniment %c","repeat %n %c":"répéter %n fois %c","repeat until %b %c":"répéter jusqu'à %b %c","if %b %c":"si %b %c","if %b %c else %c":"si %b %c sinon %c","report %s":"rapporte %s","stop block":"arrêter le bloc","stop script":"arrêter le script","stop %stopOthersChoices":"arrêter %stopOthersChoices","stop %stopChoices":"arrêter %stopChoices","stop all %stop":"arrêter tout %stop","run %cmdRing %inputs":"exécute %cmdRing  %inputs","launch %cmdRing %inputs":"lance %cmdRing %inputs","call %repRing %inputs":"appelle %repRing %inputs","run %cmdRing w/continuation":"exécute %cmdRing avec continuation","call %cmdRing w/continuation":"appelle %cmdRing avec continuation","warp %c":"Englobe %c","when I start as a clone":"Quand je commence comme clone","create a clone of %cln":"Clone %cln",myself:"moi-même","delete this clone":"supprime ce clone","pause all %pause":"mettre en pause %pause","all but this script":"tout sauf ce script","other scripts in sprite":"les autres scripts de ce lutin","this script":"ce script","this block":"ce bloc","touching %col ?":"%col touché ?","touching %clr ?":"couleur %clr touchée ?","color %clr is touching %clr ?":"couleur %clr touche %clr ?","ask %s and wait":"demander %s et attendre","what's your name?":"Quel est ton nom ?",answer:"réponse","mouse x":"souris x","mouse y":"souris y","mouse down?":"souris pressée ?","key %key pressed?":"touche %key pressée ?","distance to %dst":"distance de %dst","reset timer":"réinitialiser le chronomètre",timer:"chronomètre","%att of %spr":"%att de %spr","my %get":"attribut %get","http:// %s":"http:// %s","turbo mode?":"turbo mode activé ?","set turbo mode to %b":"turbo mode prend la valeur %b","filtered for %clr":"filtré pour %clr","stack size":"taille de la pile",frames:"cadres","%n mod %n":"%n mod %n","round %n":"arrondi de %n","%fun of %n":"%fun appliqué à %n","pick random %n to %n":"nombre aléatoire entre %n et %n","%b and %b":"%b et %b","%b or %b":"%b ou %b","not %b":"non %b",true:"vrai",false:"faux","join %words":"regroupe %words","split %s by %delim":"découpe %s entre les %delim",hello:"Bonjour",world:"Monde","letter %n of %s":"lettre %n de %s","length of %s":"longueur de %s","unicode of %s":"valeur unicode de %s","unicode %n as letter":"unicode %n comme lettre","is %s a %typ ?":"%s est un(e) %typ ?","is %s identical to %s ?":"%s est identique à %s ?","type of %s":"type de %s","Make a variable":"Nouvelle variable","Variable name":"Nom de la variable","Delete a variable":"Supprimer une variable","set %var to %s":"%var prend la valeur %s","change %var by %n":"ajouter à %var %n","show variable %var":"afficher la variable %var","hide variable %var":"cacher la variable %var","script variables %scriptVars":"variables du script %scriptVars","list %exp":"liste %exp","%s in front of %l":"%s au début de %l","item %idx of %l":"élément %idx de %l","all but first of %l":"tous sauf le premier de %l","length of %l":"longueur de %l","%l contains %s":"%l contient %s",thing:"qqchose","add %s to %l":"ajouter %s à %l","delete %ida of %l":"supprimer l'élément %ida de %l","insert %s at %idx of %l":"insérer %s en position %idx de %l","replace item %idx of %l with %s":"remplacer l'élément %idx de %l par %s","Make a block":"Nouveau bloc","About...":"À propos de Snap!...","Reference manual":"Manuel de référence","Snap! website":"Snap! le site web","Download source":"Télécharger le code source","Switch back to user mode":"Revenir en mode utilisateur","disable deep-Morphic\ncontext menus\nand show user-friendly ones":"désactiver la fonction morphic","Switch to dev mode":"Passer en mode développeur","enable Morphic\ncontext menus\nand inspectors,\nnot user-friendly!":"activer la fonction morphic","Project notes...":"Notes du projet...",New:"Nouveau","Open...":"Ouvrir...",Save:"Sauvegarder","Save As...":"Sauvegarder sous...","Import...":"Importer...","file menu import hint":"importer un projet exporté,\nune bibliothèque de blocs\nun costume ou un son","Export project as plain text...":"Exporter le projet comme texte...","Export project...":"Exporter le projet...","save project data as XML\nto your downloads folder":"sauvegarder le projet au\nformat XML dans votre\ndossier Téléchargements","show project data as XML\nin a new browser window":"ouvrir le projet au format XML\ndans une nouvelle fenêtre de votre navigateur","Export blocks...":"Exporter les blocs ","show global custom block definitions as XML\nin a new browser window":"montrer les définitions de bloc global personnalisé au format XML \ndans une nouvelle fenêtre de navigateur","Unused blocks...":"Blocs inutilisés...","find unused global custom blocks\nand remove their definitions":"trouver et supprimer les blocs personnalisés inutilisés","Remove unused blocks":"Supprimer les blocs inutilisés","there are currently no unused\nglobal custom blocks in this project":"Aucun bloc inutilisé dans ce projet","unused block(s) removed":"bloc(s) inutilisé(s) supprimé(s)","Export summary...":"Exporter un résumé...","open a new browser browser window\n with a summary of this project":"voir un résumé de ce projet dans\nune nouvelle fenêtre du navigateur","Import tools":"Importer les outils","load the official library of\npowerful blocks":"Importer la bibliothèque officielle\nd'outils avancés","Libraries...":"Bibliothèques...","Import library":"Importer une bibliothèque","Language...":"Langue...","Blurred shadows":"Ombres floues","uncheck to use solid drop\nshadows and highlights":"Décocher pour utiliser des rehauts et des ombres \n portées floues","check to use blurred drop\nshadows and highlights":"cocher pour utiliser des rehauts et des ombres \n portées pleines","Zebra coloring":"Colorations alternées","check to enable alternating\ncolors for nested blocks":"cocher pour activer des couleurs alternées \n pour les blocs emboîtés","uncheck to disable alternating\ncolors for nested block":"décocher pour désactiver des couleurs alternées \n pour les blocs emboîtés","Prefer empty slot drops":"Préférer des entrées vides","settings menu prefer empty slots hint":"cocher pour préférer des entrées vides \nlors du glisser-déposer d'un reporter","uncheck to allow dropped\nreporters to kick out others":"décocher pour ne pas préférer des entrées vides \nlors du glisser-déposer d'un reporter","Long form input dialog":"Boîte d'entrée en mode détaillé","check to always show slot\ntypes in the input dialog":"cocher pour toujours ouvrir la boîte de dialogue \nd'entrée en mode détaillé : avec tous les types de blocs","uncheck to use the input\ndialog in short form":"décocher pour utiliser la boîte de dialogue \nd'entrée en mode simple ","Virtual keyboard":"Clavier virtuel","uncheck to disable\nvirtual keyboard support\nfor mobile devices":"décocher pour désactiver le clavier virtuel pour \nles tablettes et smartphones : mobile devices  ","check to enable\nvirtual keyboard support\nfor mobile devices":"cocher pour activer le clavier virtuel pour \nles tablettes et smartphones : mobile devices  ","Input sliders":"Entrée curseurs","uncheck to disable\ninput sliders for\nentry fields":"décocher pour désactiver le curseur coulissant \ndans le champ de saisie","check to enable\ninput sliders for\nentry fields":"cocher pour activer un curseur coulissant \ndans le champ de saisie ","Clicking sound":"Cliquetis","uncheck to turn\nblock clicking\nsound off":"décocher pour désactiver le cliquetis \nlors de l'emboîtement des blocs","check to turn\nblock clicking\nsound on":"cocher pour activer le cliquetis \nlors de l'emboîtement des blocs","Turbo mode":"Mode turbo","check to prioritize\nscript execution":"cocher pour favoriser l'exécution du script","uncheck to run scripts\nat normal speed":"décocher pour exécuter le script en vitesse normale","Flat design":"Style alégé","check for alternative\nGUI design":"cocher pour un style d'interface alternatif","uncheck for default\nGUI design":"décocher pour le style classique d'interface","Keyboard Editing":"Édition au clavier","uncheck to disable\nkeyboard editing support":"décocher pour désactiver l'édition au clavier","check to enable\nkeyboard editing support":"cocher pour activer l'édition au clavier","Thread safe scripts":"Scripts réentrants","check to disallow\nscript reentrance":"cocher pour interdire\n la réentrance des scripts\net les exécuter séparément","uncheck to allow\nscript reentrance":"décocher pour permettre\n la réentrance des scripts\noù certains s'exécutent en paralèlle","Prefer smooth animations":"Vitesse d'animation fixe","uncheck for greater speed\nat variable frame rates":"décocher pour une vitesse\nd'animation maximale (mais variable)","check for smooth, predictable\nanimations across computers":"cocher pour une vitesse d'animation\nfixe et identique sur tous les ordinateurs","with inputs":"avec entrées","input names:":"renseigner un nom :","Input Names:":"Renseigner un nom :",help:"Aide","hide primitives":"Masquer les blocs de base","show primitives":"Afficher les blocs de base","help...":"Aide...",duplicate:"dupliquer","make a copy\nand pick it up":"faire une copie\n et le déplacer","only duplicate this block":"ne dupliquer que ce bloc",delete:"supprimer","script pic...":"image du script...","open a new window\nwith a picture of this script":"ouvrir une nouvelle fenêtre avec une \nimage .png de ce script",ringify:"entourer",unringify:"détourer","delete block definition...":"supprimer les définitions de bloc","edit...":"éditer...",edit:"éditer",move:"déplacer","detach from":"Détacher de","detach all parts":"Détacher toutes les parties","export...":"Exporter...","paint a new sprite":"dessiner un nouveau lutin","clean up":"effacer","arrange scripts\nvertically":"arrange scripts\nvertically","add comment":"ajouter un commentaire","make a block...":"créer un nouveau bloc...",rename:"renommer",export:"exporter","rename costume":"renommer un costume","Paint a new costume":"Dessiner un nouveau costume","Play sound":"jouer un son","Stop sound":"arrêter un son",Stop:"arrêter",Play:"jouer","rename sound":"renommer un son",OK:"OK",Ok:"Ok",Cancel:"Annuler",Yes:"Oui",No:"Non",Open:"Ouvrir",Browser:"Navigateur",Examples:"Exemples",Help:"Aide",Untitled:"Sans titre","Open Project":"Ouvrir un projet","(empty)":"(vide)","Saved!":"Enregistrê !","Delete Project":"Supprimer un projet","Are you sure you want to delete":"Souhaitez-vous vraiment supprimer ?","rename...":"Renommer...","Costume Editor":"êditeur de costumes","click or drag crosshairs to move the rotation center":"cliquez ou faites dêfiler la ligne de mire  pour dêfinir le centre de rotation du costume","Project Notes":"Notes du projet","New Project":"Nouveau projet","Replace the current project with a new one?":"Remplacer le projet actuel par un nouveau ?","Open Projekt":"Ouvrir un projet","Save Project As...":"Sauvegarder le projet sous...","Export blocks":"exporter des blocs","this project doesn't have any\ncustom global blocks yet":"ce projet ne contient pas \nde bloc global personnalisé",select:"sélectionner",all:"tout",none:"aucun","for all sprites":"pour tous les lutins","for this sprite only":"pour ce lutin uniquement","Change block":"Changer le bloc",Command:"Commande",Reporter:"Reporter",Predicate:"Prédicat","Block Editor":"Éditeur de bloc",Apply:"Appliquer","Delete Custom Block":"Effacer le bloc personnalisé","block deletion dialog text":"Êtes-vous sûr de vouloir supprimer ce bloc personnalisé \net toutes ses instances ?","Create input name":"Créer le nom de l'entrée","Edit input name":"Éditer le nom de l'entrée","Edit label fragment":"Éditer le fragment du label","Title text":"Texte du titre","Input name":"Nom de l'entrée",Delete:"Supprimer",Object:"Objet",Number:"Nombre",Text:"Texte",List:"Liste","Any type":"Tout type","Boolean (T/F)":"Booléen (V/F)","Command\n(inline)":"Commande\n(en ligne)","Command\n(C-shape)":"Commande\n(en forme de C)","Any\n(unevaluated)":"Tout type\n(non évaluée)","Boolean\n(unevaluated)":"Booléen\n(non évaluée)","Single input.":"Entrée unique.","Default Value:":"Valeur par défaut :","Multiple inputs (value is list of inputs)":"Entrées multiples (la valeur est une liste des entrées)","Upvar - make internal variable visible to caller":"Upvar - Rendre la variable interne visible pour l'appelant",whitespace:"espaces blancs",line:"lignes",tab:"tabulations",cr:"retours de ligne",letter:"lettres","About Snap":"À propos de Snap","Back...":"Retour...","License...":"Licence...","Modules...":"Modules...","Credits...":"Contributeurs...","Translators...":"Traducteurs...",License:"License","current module versions:":"Versions du module courant :",Contributors:"Contributeurs",Translations:"Traductions",normal:"normal",large:"grand",slider:"curseur","slider min...":"min...","slider max...":"max...","Slider minimum value":"Valeur minimale du curseur","Slider maximum value":"Valeur maximale du curseur","length: ":"Longueur : ","add comment here...":"ajoute un commentaire ici","(90) right":"(90) à droite","(-90) left":"(-90) à gauche","(0) up":"(0) vers le haut","(180) down":"(180) vers le bas","mouse-pointer":"pointeur souris",edge:"bord","pen trails":"traces de stylo",Turtle:"Pointeur",Empty:"Vide",color:"couleur",fisheye:"fisheye",whirl:"tourbillon",pixelate:"pixelisation",mosaic:"mosaïque",saturation:"saturation",brightness:"luminosité",ghost:"transparence",negative:"négatif",comic:"moiré",confetti:"confetti",space:"espace","up arrow":"flèche vers le haut","down arrow":"flèche vers le bas","right arrow":"flèche vers la droite","left arrow":"flèche vers la gauche",a:"a",b:"b",c:"c",d:"d",e:"e",f:"f",g:"g",h:"h",i:"i",j:"j",k:"k",l:"l",m:"m",n:"n",o:"o",p:"p",q:"q",r:"r",s:"s",t:"t",u:"u",v:"v",w:"w",x:"x",y:"y",z:"z",0:"0",1:"1",2:"2",3:"3",4:"4",5:"5",6:"6",7:"7",8:"8",9:"9","new...":"nouveau...",abs:"v. absolue",sqrt:"racine",sin:"sin",cos:"cos",tan:"tan",asin:"asin",acos:"acos",atan:"atan",ln:"ln","e^":"e^",number:"nombre",text:"texte",Boolean:"booléen",list:"liste",command:"bloc de commande",reporter:"bloc reporter",predicate:"prédicat",last:"dernier",any:"n'importe quel","find blocks...":"chercher des blocs...","hide primitives":"cacher les primitives","show primitives":"montrer les primitives","Login...":"Connexion...","Signup...":"S'enregistrer...","Reset Password...":"Remise à zéro du mot de passe...","show all":"tout montrer","pic...":"image...","open a new window\nwith a picture of the stage":"ouvre une nouvelle fenêtre\navec une image de la scène","scripts pic...":"image des scripts...","open a new window\nwith a picture of all scripts":"ouvre une nouvelle fenêtre\navec une image de tous les scripts","Stage size...":"Taille de la scène...","Zoom blocks...":"Agrandir les blocs...","Plain prototype labels":"Étiquettes simples de définition","uncheck to always show (+) symbols\nin block prototype labels":"décocher pour montrer en permanance le symbole (+)\ndans les étiquettes de définition de bloc","check to hide (+) symbols\nin block prototype labels":"cocher pour cacher le symbole (+)\ndans les étiquettes de définition de bloc","check for flat ends of lines":"cocher pour dessiner des fins de ligne plates","uncheck for round ends of lines":"décocher pour dessiner des fins de lignes arrondies","Flat line ends":"Fins de ligne plates","Codification support":"Support de la « codification »","uncheck to disable\nblock to text mapping features":"décocher pour déactiver\nla fonction de transformation :\nbloc vers texte","check for block\nto text mapping features":"cocher pour activer\nla fonction de transformation :\nbloc vers texte","Inheritance support":"Support de l'héritage","current %dates":"date courante %dates",year:"année",month:"mois",date:"jour",hour:"heure",minute:"minute",second:"seconde","time in milliseconds":"heure en millisecondes","day of week":"jour de la semaine",brightness:"luminosité",transparence:"transparence",negative:"négatif",comic:"bande dessinée",clicked:"cliqué",pressed:"pressé",dropped:"déposé","mouse-entered":"survolé","mouse-departed":"quitté","when %b":"Quand %b","JavaScript function ( %mult%s ) { %code }":"fonction JavaScript ( %mult%s ) { %code }","Press CTRL+C one more time to effectively copy to clipboard.":"Taper une nouvelle fois sur CTRL+C pour copier effectivement vers le presse-papier.","Press CTRL+V one more time to effectively paste from clipboard.":"Taper une nouvelle fois sur CTRL+V pour coller effectivement depuis le presse-papier.","Press CTRL+X one more time to effectively cut to clipboard.":"Taper une nouvelle fois sur CTRL+X pour couper effectivement vers le presse-papier.",undo:"défaire","Paintbrush tool\n(free draw)":"Pinceau\n(dessin à main levée)","Stroked Rectangle\n(shift: square)":"Rectangle\n(Maj : carré)","Stroked Ellipse\n(shift: circle)":"Ellipse\n(Maj : cercle)","Eraser tool":"Gomme","Set the rotation center":"Fixer le centre de rotation","Line tool\n(shift: vertical/horizontal)":"Ligne\n(Maj: verticale/horizontale)","Filled Rectangle\n(shift: square)":"Rectangle plein\n(Maj: carré)","Filled Ellipse\n(shift: circle)":"Ellipse pleine\n(Maj: cercle)","Fill a region":"Remplir une région","Pipette tool\n(pick a color anywhere)":"Pipette\n(sélectionnez une couleur n'importe où)",grow:"agrandir",shrink:"réduire","flip ↔":"miroir ↔","flip ↕":"miroir ↕","Brush size":"Taille de pinceau","Constrain proportions of shapes?\n(you can also hold shift)":"Contraindre les proportions de la forme ?\n(vous pouvez aussi maintenir appuyé Maj)"};Animation.prototype.easings={linear:function(t){return t},sinusoidal:function(t){return 1-Math.cos(radians(90*t))},quadratic:function(t){return t<.5?2*t*t:(4-2*t)*t-1},cubic:function(t){return t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1},elastic:function(t){return(t-=.5)<0?(.01+.01/t)*Math.sin(50*t):(.02-.01/t)*Math.sin(50*t)+1},sine_in:function(t){return 1-Math.sin(radians(90+90*t))},quad_in:function(t){return t*t},cubic_in:function(t){return t*t*t},elastic_in:function(t){return(.04-.04/t)*Math.sin(25*t)+1},sine_out:function(t){return Math.sin(radians(90*t))},quad_out:function(t){return t*(2-t)},elastic_out:function(t){return.04*t/--t*Math.sin(25*t)}},Animation.prototype.start=function(){this.endTime=Date.now()+this.duration,this.destination=this.getter.call(this)+this.delta,this.isActive=!0},Animation.prototype.step=function(){if(this.isActive){var t=Date.now();t>this.endTime?(this.setter(this.destination),this.isActive=!1,this.onComplete&&this.onComplete()):this.setter(this.destination-this.delta*this.easing((this.endTime-t)/this.duration))}},Color.prototype.toString=function(){return"rgba("+Math.round(this.r)+","+Math.round(this.g)+","+Math.round(this.b)+","+this.a+")"},Color.prototype.copy=function(){return new Color(this.r,this.g,this.b,this.a)},Color.prototype.eq=function(t){return t&&this.r===t.r&&this.g===t.g&&this.b===t.b},Color.prototype.hsv=function(){var t,e,o,i,r,n,s=this.r/255,a=this.g/255,h=this.b/255;if(t=Math.max(s,a,h),e=Math.min(s,a,h),o=t,i=t,r=t,n=t-e,i=0===t?0:n/t,t===e)o=0;else{switch(t){case s:o=(a-h)/n+(a<h?6:0);break;case a:o=(h-s)/n+2;break;case h:o=(s-a)/n+4}o/=6}return[o,i,r]},Color.prototype.set_hsv=function(t,e,o){var i,r,n,s,a;switch(i=Math.floor(6*t),r=6*t-i,n=o*(1-e),s=o*(1-r*e),a=o*(1-(1-r)*e),i%6){case 0:this.r=o,this.g=a,this.b=n;break;case 1:this.r=s,this.g=o,this.b=n;break;case 2:this.r=n,this.g=o,this.b=a;break;case 3:this.r=n,this.g=s,this.b=o;break;case 4:this.r=a,this.g=n,this.b=o;break;case 5:this.r=o,this.g=n,this.b=s}this.r*=255,this.g*=255,this.b*=255},Color.prototype.mixed=function(t,e){var o=Math.min(Math.max(t,0),1),i=1-o;return new Color(this.r*o+e.r*i,this.g*o+e.g*i,this.b*o+e.b*i)},Color.prototype.darker=function(t){var e=.8333;return t&&(e=(100-t)/100),this.mixed(e,new Color(0,0,0))},Color.prototype.lighter=function(t){var e=.8333;return t&&(e=(100-t)/100),this.mixed(e,new Color(255,255,255))},Color.prototype.dansDarker=function(){var t=this.hsv(),e=new Color,o=Math.max(t[2]-.16,0);return e.set_hsv(t[0],t[1],o),e},Color.prototype.inverted=function(){return new Color(255-this.r,255-this.g,255-this.b)},Point.prototype.toString=function(){return Math.round(this.x.toString())+"@"+Math.round(this.y.toString())},Point.prototype.copy=function(){return new Point(this.x,this.y)},Point.prototype.eq=function(t){return this.x===t.x&&this.y===t.y},Point.prototype.lt=function(t){return this.x<t.x&&this.y<t.y},Point.prototype.gt=function(t){return this.x>t.x&&this.y>t.y},Point.prototype.ge=function(t){return this.x>=t.x&&this.y>=t.y},Point.prototype.le=function(t){return this.x<=t.x&&this.y<=t.y},Point.prototype.max=function(t){return new Point(Math.max(this.x,t.x),Math.max(this.y,t.y))},Point.prototype.min=function(t){return new Point(Math.min(this.x,t.x),Math.min(this.y,t.y))},Point.prototype.round=function(){return new Point(Math.round(this.x),Math.round(this.y))},Point.prototype.abs=function(){return new Point(Math.abs(this.x),Math.abs(this.y))},Point.prototype.neg=function(){return new Point(-this.x,-this.y)},Point.prototype.mirror=function(){return new Point(this.y,this.x)},Point.prototype.floor=function(){return new Point(Math.max(Math.floor(this.x),0),Math.max(Math.floor(this.y),0))},Point.prototype.ceil=function(){return new Point(Math.ceil(this.x),Math.ceil(this.y))},Point.prototype.add=function(t){return t instanceof Point?new Point(this.x+t.x,this.y+t.y):new Point(this.x+t,this.y+t)},Point.prototype.subtract=function(t){return t instanceof Point?new Point(this.x-t.x,this.y-t.y):new Point(this.x-t,this.y-t)},Point.prototype.multiplyBy=function(t){return t instanceof Point?new Point(this.x*t.x,this.y*t.y):new Point(this.x*t,this.y*t)},Point.prototype.divideBy=function(t){return t instanceof Point?new Point(this.x/t.x,this.y/t.y):new Point(this.x/t,this.y/t)},Point.prototype.floorDivideBy=function(t){return t instanceof Point?new Point(Math.floor(this.x/t.x),Math.floor(this.y/t.y)):new Point(Math.floor(this.x/t),Math.floor(this.y/t))},Point.prototype.r=function(){var t=this.multiplyBy(this);return Math.sqrt(t.x+t.y)},Point.prototype.degrees=function(){var t,e;return 0===this.x?this.y>=0?90:270:(t=this.y/this.x,e=Math.atan(t),this.x>=0?this.y>=0?degrees(e):360+degrees(e):180+degrees(e))},Point.prototype.theta=function(){var t,e;return 0===this.x?radians(this.y>=0?90:270):(t=this.y/this.x,e=Math.atan(t),this.x>=0?this.y>=0?e:radians(360)+e:radians(180)+e)},Point.prototype.crossProduct=function(t){return this.multiplyBy(t.mirror())},Point.prototype.distanceTo=function(t){return t.subtract(this).r()},Point.prototype.rotate=function(t,e){var o=this.subtract(e);return"right"===t?new Point(-o.y,o.y).add(e):"left"===t?new Point(o.y,-o.y).add(e):e.subtract(o)},Point.prototype.flip=function(t,e){return"vertical"===t?new Point(this.x,2*e.y-this.y):new Point(2*e.x-this.x,this.y)},Point.prototype.distanceAngle=function(t,e){var o,i,r=e;return r>270?r-=360:r<-270&&(r+=360),-90<=r&&r<=90?(o=Math.sin(radians(r))*t,i=Math.sqrt(t*t-o*o),new Point(o+this.x,this.y-i)):(o=Math.sin(radians(180-r))*t,i=Math.sqrt(t*t-o*o),new Point(o+this.x,this.y+i))},Point.prototype.scaleBy=function(t){return this.multiplyBy(t)},Point.prototype.translateBy=function(t){return this.add(t)},Point.prototype.rotateBy=function(t,e){var o=e||new Point(0,0),i=this.subtract(o),r=i.r(),n=t-i.theta();return new Point(o.x+r*Math.cos(n),o.y-r*Math.sin(n))},Point.prototype.asArray=function(){return[this.x,this.y]},Rectangle.prototype.init=function(t,e){this.origin=t,this.corner=e},Rectangle.prototype.toString=function(){return"["+this.origin.toString()+" | "+this.extent().toString()+"]"},Rectangle.prototype.copy=function(){return new Rectangle(this.left(),this.top(),this.right(),this.bottom())},Point.prototype.corner=function(t){return new Rectangle(this.x,this.y,t.x,t.y)},Point.prototype.rectangle=function(t){var e,o;return e=this.min(t),o=this.max(t),new Rectangle(e.x,e.y,o.x,o.y)},Point.prototype.extent=function(t){var e=this.add(t);return new Rectangle(this.x,this.y,e.x,e.y)},Rectangle.prototype.setTo=function(t,e,o,i){this.origin=new Point(t||(0===t?0:this.left()),e||(0===e?0:this.top())),this.corner=new Point(o||(0===o?0:this.right()),i||(0===i?0:this.bottom()))},Rectangle.prototype.area=function(){var t=this.width();return t<0?0:Math.max(t*this.height(),0)},Rectangle.prototype.bottom=function(){return this.corner.y},Rectangle.prototype.bottomCenter=function(){return new Point(this.center().x,this.bottom())},Rectangle.prototype.bottomLeft=function(){return new Point(this.origin.x,this.corner.y)},Rectangle.prototype.bottomRight=function(){return this.corner.copy()},Rectangle.prototype.boundingBox=function(){return this},Rectangle.prototype.center=function(){return this.origin.add(this.corner.subtract(this.origin).floorDivideBy(2))},Rectangle.prototype.corners=function(){return[this.origin,this.bottomLeft(),this.corner,this.topRight()]},Rectangle.prototype.extent=function(){return this.corner.subtract(this.origin)},Rectangle.prototype.height=function(){return this.corner.y-this.origin.y},Rectangle.prototype.left=function(){return this.origin.x},Rectangle.prototype.leftCenter=function(){return new Point(this.left(),this.center().y)},Rectangle.prototype.right=function(){return this.corner.x},Rectangle.prototype.rightCenter=function(){return new Point(this.right(),this.center().y)},Rectangle.prototype.top=function(){return this.origin.y},Rectangle.prototype.topCenter=function(){return new Point(this.center().x,this.top())},Rectangle.prototype.topLeft=function(){return this.origin},Rectangle.prototype.topRight=function(){return new Point(this.corner.x,this.origin.y)},Rectangle.prototype.width=function(){return this.corner.x-this.origin.x},Rectangle.prototype.position=function(){return this.origin},Rectangle.prototype.eq=function(t){return this.origin.eq(t.origin)&&this.corner.eq(t.corner)},Rectangle.prototype.abs=function(){var t,e;return t=this.origin.abs(),e=this.corner.max(t),t.corner(e)},Rectangle.prototype.insetBy=function(t){var e=new Rectangle;return e.origin=this.origin.add(t),e.corner=this.corner.subtract(t),e},Rectangle.prototype.expandBy=function(t){var e=new Rectangle;return e.origin=this.origin.subtract(t),e.corner=this.corner.add(t),e},Rectangle.prototype.growBy=function(t){var e=new Rectangle;return e.origin=this.origin.copy(),e.corner=this.corner.add(t),e},Rectangle.prototype.intersect=function(t){var e=new Rectangle;return e.origin=this.origin.max(t.origin),e.corner=this.corner.min(t.corner),e},Rectangle.prototype.merge=function(t){var e=new Rectangle;return e.origin=this.origin.min(t.origin),e.corner=this.corner.max(t.corner),e},Rectangle.prototype.mergeWith=function(t){this.origin=this.origin.min(t.origin),this.corner=this.corner.max(t.corner)},Rectangle.prototype.round=function(){return this.origin.round().corner(this.corner.round())},Rectangle.prototype.spread=function(){return this.origin.floor().corner(this.corner.ceil()).expandBy(1)},Rectangle.prototype.amountToTranslateWithin=function(t){var e=0,o=0;return this.right()>t.right()&&(e=t.right()-this.right()),this.bottom()>t.bottom()&&(o=t.bottom()-this.bottom()),this.left()+e<t.left()&&(e=t.left()-this.left()),this.top()+o<t.top()&&(o=t.top()-this.top()),new Point(e,o)},Rectangle.prototype.containsPoint=function(t){return this.origin.le(t)&&t.lt(this.corner)},Rectangle.prototype.containsRectangle=function(t){return t.origin.gt(this.origin)&&t.corner.lt(this.corner)},Rectangle.prototype.intersects=function(t){var e=t.origin,o=t.corner;return o.x>=this.origin.x&&o.y>=this.origin.y&&e.x<=this.corner.x&&e.y<=this.corner.y},Rectangle.prototype.isNearTo=function(t,e){var o=t.origin,i=t.corner,r=e||0;return i.x+r>=this.origin.x&&i.y+r>=this.origin.y&&o.x-r<=this.corner.x&&o.y-r<=this.corner.y},Rectangle.prototype.scaleBy=function(t){var e=this.origin.multiplyBy(t),o=this.corner.multiplyBy(t);return new Rectangle(e.x,e.y,o.x,o.y)},Rectangle.prototype.translateBy=function(t){var e=this.origin.add(t),o=this.corner.add(t);return new Rectangle(e.x,e.y,o.x,o.y)},Rectangle.prototype.asArray=function(){return[this.left(),this.top(),this.right(),this.bottom()]},Rectangle.prototype.asArray_xywh=function(){return[this.left(),this.top(),this.width(),this.height()]},Node.prototype.init=function(t,e){this.parent=t||null,this.children=e||[]},Node.prototype.toString=function(){return"a Node["+this.children.length.toString()+"]"},Node.prototype.addChild=function(t){this.children.push(t),t.parent=this},Node.prototype.addChildFirst=function(t){this.children.splice(0,null,t),t.parent=this},Node.prototype.removeChild=function(t){var e=this.children.indexOf(t);-1!==e&&this.children.splice(e,1)},Node.prototype.root=function(){return null===this.parent?this:this.parent.root()},Node.prototype.depth=function(){return null===this.parent?0:this.parent.depth()+1},Node.prototype.allChildren=function(){var t=[this];return this.children.forEach(function(e){t=t.concat(e.allChildren())}),t},Node.prototype.forAllChildren=function(t){this.children.length>0&&this.children.forEach(function(e){e.forAllChildren(t)}),t.call(null,this)},Node.prototype.anyChild=function(t){var e;if(t.call(null,this))return!0;for(e=0;e<this.children.length;e+=1)if(this.children[e].anyChild(t))return!0;return!1},Node.prototype.allLeafs=function(){var t=[];return this.allChildren().forEach(function(e){0===e.children.length&&t.push(e)}),t},Node.prototype.allParents=function(){var t=[this];return null!==this.parent&&(t=t.concat(this.parent.allParents())),t},Node.prototype.siblings=function(){var t=this;return null===this.parent?[]:this.parent.children.filter(function(e){return e!==t})},Node.prototype.parentThatIsA=function(t){return this instanceof t?this:this.parent?this.parent.parentThatIsA(t):null},Node.prototype.parentThatIsAnyOf=function(t){var e=!1,o=this;return t.forEach(function(t){o.constructor!==t||(e=!0)}),e?this:this.parent?this.parent.parentThatIsAnyOf(t):null};var Morph,WorldMorph,HandMorph,ShadowMorph,FrameMorph,MenuMorph,HandleMorph,StringFieldMorph,ColorPickerMorph,SliderMorph,ScrollFrameMorph,InspectorMorph,StringMorph,TextMorph;Morph.prototype=new Node,Morph.prototype.constructor=Morph,Morph.uber=Node.prototype,Morph.prototype.trackChanges=!0,Morph.prototype.shadowBlur=4,Morph.prototype.init=function(t){Morph.uber.init.call(this),this.isMorph=!0,this.image=null,this.bounds=new Rectangle(0,0,50,40),this.cachedFullImage=null,this.cachedFullBounds=null,this.color=new Color(80,80,80),this.texture=null,this.cachedTexture=null,this.alpha=1,this.isVisible=!0,this.isDraggable=!1,this.isTemplate=!1,this.acceptsDrops=!1,this.noticesTransparentClick=!1,t||this.drawNew(),this.fps=0,this.customContextMenu=null,this.lastTime=Date.now(),this.onNextStep=null},Morph.prototype.toString=function(){return"a "+(this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])+" "+this.children.length.toString()+" "+this.bounds},Morph.prototype.destroy=function(){null!==this.parent&&(this.fullChanged(),this.parent.removeChild(this))},Morph.prototype.stepFrame=function(){if(!this.step)return null;var t,e,o;e=(t=Date.now())-this.lastTime,(this.fps>0?1e3/this.fps-e:0)<1&&(this.lastTime=t,this.onNextStep&&(o=this.onNextStep,this.onNextStep=null,o.call(this)),this.step(),this.children.forEach(function(t){t.stepFrame()}))},Morph.prototype.nextSteps=function(t){var e=t||[],o=e.shift(),i=this;o&&(this.onNextStep=function(){o.call(i),i.nextSteps(e)})},Morph.prototype.step=nop,Morph.prototype.left=function(){return this.bounds.left()},Morph.prototype.right=function(){return this.bounds.right()},Morph.prototype.top=function(){return this.bounds.top()},Morph.prototype.bottom=function(){return this.bounds.bottom()},Morph.prototype.center=function(){return this.bounds.center()},Morph.prototype.bottomCenter=function(){return this.bounds.bottomCenter()},Morph.prototype.bottomLeft=function(){return this.bounds.bottomLeft()},Morph.prototype.bottomRight=function(){return this.bounds.bottomRight()},Morph.prototype.boundingBox=function(){return this.bounds},Morph.prototype.corners=function(){return this.bounds.corners()},Morph.prototype.leftCenter=function(){return this.bounds.leftCenter()},Morph.prototype.rightCenter=function(){return this.bounds.rightCenter()},Morph.prototype.topCenter=function(){return this.bounds.topCenter()},Morph.prototype.topLeft=function(){return this.bounds.topLeft()},Morph.prototype.topRight=function(){return this.bounds.topRight()},Morph.prototype.position=function(){return this.bounds.origin},Morph.prototype.extent=function(){return this.bounds.extent()},Morph.prototype.width=function(){return this.bounds.width()},Morph.prototype.height=function(){return this.bounds.height()},Morph.prototype.fullBounds=function(){var t;return t=this.bounds,this.children.forEach(function(e){e.isVisible&&(t=t.merge(e.fullBounds()))}),t},Morph.prototype.fullBoundsNoShadow=function(){var t;return t=this.bounds,this.children.forEach(function(e){e instanceof ShadowMorph||!e.isVisible||(t=t.merge(e.fullBounds()))}),t},Morph.prototype.visibleBounds=function(){var t=this.bounds;return this.allParents().filter(function(t){return t instanceof FrameMorph}).forEach(function(e){t=t.intersect(e.bounds)}),t},Morph.prototype.moveBy=function(t){this.fullChanged(),this.silentMoveBy(t),this.fullChanged()},Morph.prototype.silentMoveBy=function(t){var e=this.children,o=e.length;for(this.bounds=this.bounds.translateBy(t),this.cachedFullBounds&&(this.cachedFullBounds=this.cachedFullBounds.translateBy(t)),o;o>0;o-=1)e[o-1].silentMoveBy(t)},Morph.prototype.setPosition=function(t){var e=t.subtract(this.topLeft());0===e.x&&0===e.y||this.moveBy(e)},Morph.prototype.silentSetPosition=function(t){var e=t.subtract(this.topLeft());0===e.x&&0===e.y||this.silentMoveBy(e)},Morph.prototype.setLeft=function(t){this.setPosition(new Point(t,this.top()))},Morph.prototype.setRight=function(t){this.setPosition(new Point(t-this.width(),this.top()))},Morph.prototype.setTop=function(t){this.setPosition(new Point(this.left(),t))},Morph.prototype.setBottom=function(t){this.setPosition(new Point(this.left(),t-this.height()))},Morph.prototype.setCenter=function(t){this.setPosition(t.subtract(this.extent().floorDivideBy(2)))},Morph.prototype.setFullCenter=function(t){this.setPosition(t.subtract(this.fullBounds().extent().floorDivideBy(2)))},Morph.prototype.keepWithin=function(t){var e,o,i,r;(e=this.fullBounds().left()-t.left())<0&&this.moveBy(new Point(-e,0)),(o=this.fullBounds().right()-t.right())>0&&this.moveBy(new Point(-o,0)),(i=this.fullBounds().top()-t.top())<0&&this.moveBy(new Point(0,-i)),(r=this.fullBounds().bottom()-t.bottom())>0&&this.moveBy(new Point(0,-r))},Morph.prototype.scrollIntoView=function(){var t,e,o,i,r=this.parentThatIsA(ScrollFrameMorph);r&&((e=Math.min(this.fullBounds().right()-r.right(),r.contents.right()-r.right()))>0&&r.contents.moveBy(new Point(-e,0)),(t=this.fullBounds().left()-r.left())<0&&r.contents.moveBy(new Point(-t,0)),(o=this.fullBounds().top()-r.top())<0&&r.contents.moveBy(new Point(0,-o)),(i=this.fullBounds().bottom()-r.bottom())>0&&r.contents.moveBy(new Point(0,-i)),r.adjustScrollBars())},Morph.prototype.setExtent=function(t,e){e?this.silentSetExtent(t):t.eq(this.extent())||(this.changed(),this.silentSetExtent(t),this.changed(),this.drawNew())},Morph.prototype.silentSetExtent=function(t){var e,o,i;e=t.round(),o=Math.max(e.x,0),i=Math.max(e.y,0),this.bounds.corner=new Point(this.bounds.origin.x+o,this.bounds.origin.y+i)},Morph.prototype.setWidth=function(t){this.setExtent(new Point(t||0,this.height()))},Morph.prototype.silentSetWidth=function(t){var e=Math.max(Math.round(t||0),0);this.bounds.corner=new Point(this.bounds.origin.x+e,this.bounds.corner.y)},Morph.prototype.setHeight=function(t){this.setExtent(new Point(this.width(),t||0))},Morph.prototype.silentSetHeight=function(t){var e=Math.max(Math.round(t||0),0);this.bounds.corner=new Point(this.bounds.corner.x,this.bounds.origin.y+e)},Morph.prototype.setColor=function(t){t&&(this.color.eq(t)||(this.color=t,this.changed(),this.drawNew()))},Morph.prototype.drawNew=function(){this.image=newCanvas(this.extent());var t=this.image.getContext("2d");t.fillStyle=this.color.toString(),t.beginPath(),t.moveTo(0,0),t.lineTo(this.image.width,0),t.lineTo(this.image.width,this.image.height),t.lineTo(0,this.image.height+1e-4),t.closePath(),t.fill(),this.cachedTexture?this.drawCachedTexture():this.texture&&this.drawTexture(this.texture)},Morph.prototype.drawTexture=function(t){var e=this;this.cachedTexture=new Image,this.cachedTexture.onload=function(){e.drawCachedTexture()},this.cachedTexture.src=this.texture=t},Morph.prototype.drawCachedTexture=function(){var t,e,o=this.cachedTexture,i=Math.floor(this.image.width/o.width),r=Math.floor(this.image.height/o.height),n=this.image.getContext("2d");for(e=0;e<=r;e+=1)for(t=0;t<=i;t+=1)n.drawImage(o,t*o.width,e*o.height);this.changed()},Morph.prototype.drawOn=function(t,e){var o,i,r,n,s,a,h,l,p,c=this.cachedFullImage||this.image,d=this.cachedFullBounds||this.bounds;if(!this.isVisible)return null;if(o=e||d,(i=o.intersect(d)).extent().gt(new Point(0,0))){if(r=d.position().neg(),n=i.copy().translateBy(r),s=t.getContext("2d"),s.globalAlpha=this.alpha,l=n.left(),p=n.top(),a=Math.min(n.width(),c.width-l),h=Math.min(n.height(),c.height-p),a<1||h<1)return null;s.drawImage(c,l,p,a,h,i.left(),i.top(),a,h)}},Morph.prototype.fullDrawOn=function(t,e){var o;if(!this.isVisible)return null;o=e||this.cachedFullBounds||this.fullBounds(),this.drawOn(t,o),this.cachedFullImage||this.children.forEach(function(e){e.fullDrawOn(t,o)})},Morph.prototype.hide=function(){this.isVisible=!1,this.changed(),this.children.forEach(function(t){t.hide()})},Morph.prototype.show=function(){this.isVisible=!0,this.changed(),this.children.forEach(function(t){t.show()})},Morph.prototype.toggleVisibility=function(){this.isVisible=!this.isVisible,this.changed(),this.children.forEach(function(t){t.toggleVisibility()})},Morph.prototype.fullImageClassic=function(){var t=this.cachedFullBounds||this.fullBounds(),e=newCanvas(t.extent());return e.getContext("2d").translate(-t.origin.x,-t.origin.y),this.fullDrawOn(e,t),e.globalAlpha=this.alpha,e},Morph.prototype.fullImage=function(){var t,e,o;return t=newCanvas(this.fullBounds().extent()),e=t.getContext("2d"),o=this.fullBounds(),this.allChildren().forEach(function(t){t.isVisible&&(e.globalAlpha=t.alpha,t.image.width&&t.image.height&&e.drawImage(t.image,t.bounds.origin.x-o.origin.x,t.bounds.origin.y-o.origin.y))}),t},Morph.prototype.shadowImage=function(t,e){var o,i,r,n,s,a=t||new Point(7,7),h=e||new Color(0,0,0);return o=this.fullBounds().extent(),i=this.fullImage(),r=newCanvas(o),(s=r.getContext("2d")).drawImage(i,0,0),s.globalCompositeOperation="destination-out",s.drawImage(i,-a.x,-a.y),n=newCanvas(o),(s=n.getContext("2d")).drawImage(r,0,0),s.globalCompositeOperation="source-atop",s.fillStyle=h.toString(),s.fillRect(0,0,o.x,o.y),n},Morph.prototype.shadowImageBlurred=function(t,e){var o,i,r,n,s=t||new Point(7,7),a=this.shadowBlur,h=e||new Color(0,0,0);return o=this.fullBounds().extent().add(2*a),i=this.fullImage(),r=newCanvas(o),n=r.getContext("2d"),n.shadowOffsetX=s.x,n.shadowOffsetY=s.y,n.shadowBlur=a,n.shadowColor=h.toString(),n.drawImage(i,a-s.x,a-s.y),n.shadowOffsetX=0,n.shadowOffsetY=0,n.shadowBlur=0,n.globalCompositeOperation="destination-out",n.drawImage(i,a-s.x,a-s.y),r},Morph.prototype.shadow=function(t,e,o){var i=new ShadowMorph,r=t||new Point(7,7),n=e||(0===e?0:.2),s=this.fullBounds();return i.setExtent(s.extent().add(2*this.shadowBlur)),useBlurredShadows&&!MorphicPreferences.isFlat?(i.image=this.shadowImageBlurred(r,o),i.alpha=n,i.setPosition(s.origin.add(r).subtract(this.shadowBlur))):(i.image=this.shadowImage(r,o),i.alpha=n,i.setPosition(s.origin.add(r))),i},Morph.prototype.addShadow=function(t,e,o){var i,r=t||new Point(7,7),n=e||(0===e?0:.2);return i=this.shadow(r,n,o),this.addBack(i),this.fullChanged(),i},Morph.prototype.getShadow=function(){var t;return t=this.children.slice(0).reverse().filter(function(t){return t instanceof ShadowMorph}),0!==t.length?t[0]:null},Morph.prototype.removeShadow=function(){var t=this.getShadow();null!==t&&(this.fullChanged(),this.removeChild(t))},Morph.prototype.penTrails=function(){return this.image},Morph.prototype.changed=function(){if(this.trackChanges){var t=this.root();t instanceof WorldMorph&&t.broken.push(this.visibleBounds().spread())}this.parent&&this.parent.childChanged(this)},Morph.prototype.fullChanged=function(){if(this.trackChanges){var t=this.root();t instanceof WorldMorph&&t.broken.push((this.cachedFullBounds||this.fullBounds()).spread())}},Morph.prototype.childChanged=function(){this.parent&&this.parent.childChanged(this)},Morph.prototype.world=function(){var t=this.root();return t instanceof WorldMorph?t:t instanceof HandMorph?t.world:null},Morph.prototype.add=function(t){var e=t.parent;null!==e&&e.removeChild(t),this.addChild(t)},Morph.prototype.addBack=function(t){var e=t.parent;null!==e&&e.removeChild(t),this.addChildFirst(t)},Morph.prototype.topMorphAt=function(t){var e,o;if(!this.isVisible)return null;for(e=this.children.length-1;e>=0;e-=1)if(o=this.children[e].topMorphAt(t))return o;return!this.bounds.containsPoint(t)||!this.noticesTransparentClick&&this.isTransparentAt(t)?null:this},Morph.prototype.topMorphSuchThat=function(t){var e;return t.call(null,this)?(e=detect(this.children.slice(0).reverse(),t),e?e.topMorphSuchThat(t):this):null},Morph.prototype.overlappedMorphs=function(){var t=this.world(),e=this.fullBounds(),o=this,i=this.allParents(),r=this.allChildren();return t.allChildren().filter(function(n){return n.isVisible&&n!==o&&n!==t&&!contains(i,n)&&!contains(r,n)&&n.fullBounds().intersects(e)})},Morph.prototype.getPixelColor=function(t){var e,o,i;return e=t.subtract(this.bounds.origin),o=this.image.getContext("2d"),i=o.getImageData(e.x,e.y,1,1),new Color(i.data[0],i.data[1],i.data[2],i.data[3]/255)},Morph.prototype.isTransparentAt=function(t){var e,o;return!!this.bounds.containsPoint(t)&&(!this.texture&&(e=t.subtract(this.bounds.origin),o=this.image.getContext("2d"),0===o.getImageData(Math.floor(e.x),Math.floor(e.y),1,1).data[3]))},Morph.prototype.copy=function(){var t=copy(this);return t.parent=null,t.children=[],t.bounds=this.bounds.copy(),t},Morph.prototype.fullCopy=function(){var t,e=new Map;return(t=this.copyRecordingReferences(e)).forAllChildren(function(t){t.updateReferences(e)}),t},Morph.prototype.copyRecordingReferences=function(t){var e=this.copy();return t.set(this,e),this.children.forEach(function(o){e.add(o.copyRecordingReferences(t))}),e},Morph.prototype.updateReferences=function(t){var e,o,i,r,n=Object.keys(this),s=n.length;for(r=0;r<s;r+=1)(o=this[e=n[r]])&&o.isMorph&&(i=t.get(o))&&(this[e]=i)},Morph.prototype.rootForGrab=function(){return this instanceof ShadowMorph?this.parent.rootForGrab():this.parent instanceof ScrollFrameMorph?this.parent:null===this.parent||this.parent instanceof WorldMorph||this.parent instanceof FrameMorph||!0===this.isDraggable?this:this.parent.rootForGrab()},Morph.prototype.isCorrectingOutsideDrag=function(){return!0},Morph.prototype.wantsDropOf=function(t){return!(t instanceof HandleMorph||t instanceof MenuMorph||t instanceof InspectorMorph)&&this.acceptsDrops},Morph.prototype.pickUp=function(t){var e=t||this.world();this.setPosition(e.hand.position().subtract(this.extent().floorDivideBy(2))),e.hand.grab(this)},Morph.prototype.isPickedUp=function(){return null!==this.parentThatIsA(HandMorph)},Morph.prototype.situation=function(){return this.parent?{origin:this.parent,position:this.position().subtract(this.parent.position())}:null},Morph.prototype.slideBackTo=function(t,e,o,i){var r=t.origin.position().add(t.position),n=this;this.glideTo(r,e,null,function(){t.origin.add(n),o&&o(),n.justDropped&&n.justDropped(),t.origin.reactToDropOf&&t.origin.reactToDropOf(n),i&&i()})},Morph.prototype.glideTo=function(t,e,o,i){var r=this.world(),n=this;r.animations.push(new Animation(function(t){n.setLeft(t)},function(){return n.left()},-(this.left()-t.x),e||100,o,i)),r.animations.push(new Animation(function(t){n.setTop(t)},function(){return n.top()},-(this.top()-t.y),e||100,o))},Morph.prototype.fadeTo=function(t,e,o,i){var r=this.world(),n=this,s=this.alpha;this.children.forEach(function(i){i.fadeTo(t,e,o)}),r.animations.push(new Animation(function(t){n.alpha=t,n.changed()},function(){return n.alpha},t-this.alpha,e||200,o,function(){n.alpha=s,i&&i()}))},Morph.prototype.perish=function(t,e){var o=this;this.fadeTo(0,t||100,null,function(){o.destroy(),e&&e()})},Morph.prototype.nop=nop,Morph.prototype.resize=function(){this.world().activeHandle=new HandleMorph(this)},Morph.prototype.move=function(){this.world().activeHandle=new HandleMorph(this,null,null,null,null,"move")},Morph.prototype.moveCenter=function(){this.world().activeHandle=new HandleMorph(this,null,null,null,null,"moveCenter")},Morph.prototype.hint=function(t){var e,o;o=t,t?t.toString&&(o=t.toString()):o="NULL",(e=new MenuMorph(this,o)).isDraggable=!0,e.popUpCenteredAtHand(this.world())},Morph.prototype.inform=function(t){var e,o;o=t,t?t.toString&&(o=t.toString()):o="NULL",(e=new MenuMorph(this,o)).addItem("Ok"),e.isDraggable=!0,e.popUpCenteredAtHand(this.world())},Morph.prototype.prompt=function(t,e,o,i,r,n,s,a){var h,l,p,c;s&&(c=!0),h=new MenuMorph(e||null,t||"",o||null),l=new StringFieldMorph(i||"",r||100,MorphicPreferences.prompterFontSize,MorphicPreferences.prompterFontName,!1,!1,c),h.items.push(l),(s||MorphicPreferences.useSliderForInput)&&((p=new SliderMorph(n||0,s,parseFloat(i),Math.floor((s-n)/4),"horizontal")).alpha=1,p.color=new Color(225,225,225),p.button.color=h.borderColor,p.button.highlightColor=p.button.color.copy(),p.button.highlightColor.b+=100,p.button.pressColor=p.button.color.copy(),p.button.pressColor.b+=150,p.setHeight(MorphicPreferences.prompterSliderSize),p.action=a?function(t){l.changed(),l.text.text=Math.round(t).toString(),l.text.drawNew(),l.text.changed(),l.text.edit()}:function(t){l.changed(),l.text.text=t.toString(),l.text.drawNew(),l.text.changed()},h.items.push(p)),h.addLine(2),h.addItem("Ok",function(){return l.string()}),h.addItem("Cancel",function(){return null}),h.isDraggable=!0,h.popUpAtHand(this.world()),l.text.edit()},Morph.prototype.pickColor=function(t,e,o,i){var r,n;r=new MenuMorph(e||null,t||"",o||null),n=new ColorPickerMorph(i),r.items.push(n),r.addLine(2),r.addItem("Ok",function(){return n.getChoice()}),r.addItem("Cancel",function(){return null}),r.isDraggable=!0,r.popUpAtHand(this.world())},Morph.prototype.inspect=function(t){var e,o=this.world instanceof Function?this.world():this.root()||this.world,i=this;t&&(i=t),(e=new InspectorMorph(i)).setPosition(o.hand.position()),e.keepWithin(o),o.add(e),e.changed()},Morph.prototype.contextMenu=function(){var t;return this.customContextMenu?this.customContextMenu:(t=this.world instanceof Function?this.world():this.world,t&&t.isDevMode?this.parent===t?this.developersMenu():this.hierarchyMenu():this.userMenu()||this.parent&&this.parent.userMenu())},Morph.prototype.hierarchyMenu=function(){var t=this.allParents(),e=this.world instanceof Function?this.world():this.world,o=new MenuMorph(this,null);return t.forEach(function(t){t.developersMenu&&t!==e&&o.addMenu(t.toString().slice(0,50),t.developersMenu())}),o},Morph.prototype.developersMenu=function(){var t=this.world instanceof Function?this.world():this.world,e=this.userMenu()||this.parent&&this.parent.userMenu(),o=new MenuMorph(this,this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0]);return e&&(o.addMenu("user features",e),o.addLine()),o.addItem("color...",function(){this.pickColor(o.title+localize("\ncolor:"),this.setColor,this,this.color)},"choose another color \nfor this morph"),o.addItem("transparency...",function(){this.prompt(o.title+localize("\nalpha\nvalue:"),this.setAlphaScaled,this,(100*this.alpha).toString(),null,1,100,!0)},"set this morph's\nalpha value"),o.addItem("resize...","resize","show a handle\nwhich can be dragged\nto change this morph's extent"),o.addLine(),o.addItem("duplicate",function(){this.fullCopy().pickUp(this.world())},"make a copy\nand pick it up"),o.addItem("pick up","pickUp","detach and put \ninto the hand"),o.addItem("attach...","attach","stick this morph\nto another one"),o.addItem("move...","move","show a handle\nwhich can be dragged\nto move this morph"),o.addItem("inspect...","inspect","open a window\non all properties"),o.addItem("pic...",function(){window.open(this.fullImageClassic().toDataURL())},"open a new window\nwith a picture of this morph"),o.addLine(),this.isDraggable?o.addItem("lock","toggleIsDraggable","make this morph\nunmovable"):o.addItem("unlock","toggleIsDraggable","make this morph\nmovable"),o.addItem("hide","hide"),o.addItem("delete","destroy"),this instanceof WorldMorph||(o.addLine(),o.addItem("World...",function(){t.contextMenu().popUpAtHand(t)},"show the\nWorld's menu")),o},Morph.prototype.userMenu=function(){return null},Morph.prototype.setAlphaScaled=function(t){var e,o;"number"==typeof t?(o=t/100,this.alpha=Math.min(Math.max(o,.1),1)):(e=parseFloat(t),isNaN(e)||(o=e/100,this.alpha=Math.min(Math.max(o,.1),1))),this.changed()},Morph.prototype.attach=function(){var t=this.overlappedMorphs(),e=new MenuMorph(this,"choose new parent:"),o=this;t.forEach(function(t){e.addItem(t.toString().slice(0,50),function(){t.add(o),o.isDraggable=!1})}),t.length>0&&e.popUpAtHand(this.world())},Morph.prototype.toggleIsDraggable=function(){this.isDraggable=!this.isDraggable},Morph.prototype.colorSetters=function(){return["color"]},Morph.prototype.numericalSetters=function(){return["setLeft","setTop","setWidth","setHeight","setAlphaScaled"]},Morph.prototype.allEntryFields=function(){return this.allChildren().filter(function(t){return t.isEditable&&(t instanceof StringMorph||t instanceof TextMorph)})},Morph.prototype.nextEntryField=function(t){var e=this.allEntryFields(),o=e.indexOf(t);return-1!==o&&e.length>o+1?e[o+1]:e[0]},Morph.prototype.previousEntryField=function(t){var e=this.allEntryFields(),o=e.indexOf(t);return-1!==o?o>0?e[o-1]:e[e.length-1]:e[0]},Morph.prototype.tab=function(t){this.nextTab?this.nextTab(t):this.parent&&this.parent.tab(t)},Morph.prototype.backTab=function(t){this.previousTab?this.previousTab(t):this.parent&&this.parent.backTab(t)},Morph.prototype.escalateEvent=function(t,e){for(var o=this.parent;!o[t]&&null!==o.parent;)o=o.parent;o[t]&&o[t](e)},Morph.prototype.evaluateString=function(code){var result;try{result=eval(code),this.drawNew(),this.changed()}catch(t){this.inform(t)}return result},Morph.prototype.isTouching=function(t){var e,o=this.overlappingImage(t);return!(!o.width||!o.height)&&(e=o.getContext("2d").getImageData(1,1,o.width,o.height).data,null!==detect(e,function(t){return 0!==t}))},Morph.prototype.overlappingImage=function(t){var e=this.fullBounds(),o=t.fullBounds(),i=e.intersect(o),r=newCanvas(i.extent()),n=r.getContext("2d");return i.width()<1||i.height()<1?newCanvas(new Point(1,1)):(n.drawImage(this.fullImage(),i.origin.x-e.origin.x,i.origin.y-e.origin.y),n.globalCompositeOperation="source-in",n.drawImage(t.fullImage(),o.origin.x-i.origin.x,o.origin.y-i.origin.y),r)},ShadowMorph.prototype=new Morph,ShadowMorph.prototype.constructor=ShadowMorph,ShadowMorph.uber=Morph.prototype,ShadowMorph.prototype.topMorphAt=function(){return null},HandleMorph.prototype=new Morph,HandleMorph.prototype.constructor=HandleMorph,HandleMorph.uber=Morph.prototype,HandleMorph.prototype.init=function(t,e,o,i,r,n){var s=MorphicPreferences.handleSize;this.target=t||null,this.minExtent=new Point(e||0,o||0),this.inset=new Point(i||0,r||i||0),this.type=n||"resize",HandleMorph.uber.init.call(this),this.color=new Color(255,255,255),this.isDraggable=!1,this.noticesTransparentClick=!0,"movePivot"===this.type&&(s*=2),this.setExtent(new Point(s,s))},HandleMorph.prototype.drawNew=function(){this.normalImage=newCanvas(this.extent()),this.highlightImage=newCanvas(this.extent()),"movePivot"===this.type?(this.drawCrosshairsOnCanvas(this.normalImage,.6),this.drawCrosshairsOnCanvas(this.highlightImage,.5)):(this.drawOnCanvas(this.normalImage,this.color,new Color(100,100,100)),this.drawOnCanvas(this.highlightImage,new Color(100,100,255),new Color(255,255,255))),this.image=this.normalImage,this.target&&("moveCenter"===this.type?this.setCenter(this.target.center()):"movePivot"===this.type?this.setCenter(this.target.rotationCenter()):this.setPosition(this.target.bottomRight().subtract(this.extent().add(this.inset))),this.target.add(this),this.target.changed())},HandleMorph.prototype.drawCrosshairsOnCanvas=function(t,e){var o=t.getContext("2d"),i=t.width/2;o.fillStyle="rgba(255, 255, 255, 0.5)",o.arc(i,i,.9*i,radians(0),radians(360),!1),o.fill(),o.strokeStyle="black",o.lineWidth=1,o.beginPath(),o.arc(i,i,i*e,radians(0),radians(360),!1),o.stroke(),o.moveTo(0,i),o.lineTo(t.width,i),o.stroke(),o.moveTo(i,0),o.lineTo(i,t.height),o.stroke()},HandleMorph.prototype.drawOnCanvas=function(t,e,o){var i,r,n,s,a,h=t.getContext("2d"),l=0===this.type.indexOf("move");if(h.lineWidth=1,h.lineCap="round",h.strokeStyle=e.toString(),l)for(r=(i=this.bottomLeft().subtract(this.position())).copy(),s=(n=this.topRight().subtract(this.position())).copy(),a=0;a<=this.height();a+=6)r.y=i.y-a,s.y=n.y-a,h.beginPath(),h.moveTo(r.x,r.y),h.lineTo(s.x,s.y),h.closePath(),h.stroke();for(r=(i=this.bottomLeft().subtract(this.position())).copy(),s=(n=this.topRight().subtract(this.position())).copy(),a=0;a<=this.width();a+=6)r.x=i.x+a,s.x=n.x+a,h.beginPath(),h.moveTo(r.x,r.y),h.lineTo(s.x,s.y),h.closePath(),h.stroke();if(h.strokeStyle=o.toString(),l)for(r=(i=this.bottomLeft().subtract(this.position())).copy(),s=(n=this.topRight().subtract(this.position())).copy(),a=-2;a<=this.height();a+=6)r.y=i.y-a,s.y=n.y-a,h.beginPath(),h.moveTo(r.x,r.y),h.lineTo(s.x,s.y),h.closePath(),h.stroke();for(r=(i=this.bottomLeft().subtract(this.position())).copy(),s=(n=this.topRight().subtract(this.position())).copy(),a=2;a<=this.width();a+=6)r.x=i.x+a,s.x=n.x+a,h.beginPath(),h.moveTo(r.x,r.y),h.lineTo(s.x,s.y),h.closePath(),h.stroke()},HandleMorph.prototype.step=null,HandleMorph.prototype.mouseDownLeft=function(t){var e,o=this.root(),i=this;if(!this.target)return null;e=0===this.type.indexOf("move")?t.subtract(this.center()):t.subtract(this.bounds.origin),this.step=function(){var t,r;o.hand.mouseButton?(t=o.hand.bounds.origin.copy().subtract(e),"resize"===this.type?(r=(r=t.add(i.extent().add(i.inset)).subtract(i.target.bounds.origin)).max(i.minExtent),i.target.setExtent(r),i.setPosition(i.target.bottomRight().subtract(i.extent().add(i.inset)))):"moveCenter"===this.type?i.target.setCenter(t):"movePivot"===this.type?(i.target.setPivot(t),i.setCenter(this.target.rotationCenter())):i.target.setPosition(t.subtract(this.target.extent()).add(this.extent()))):this.step=null},this.target.step||(this.target.step=function(){nop()})},HandleMorph.prototype.rootForGrab=function(){return this},HandleMorph.prototype.mouseEnter=function(){this.image=this.highlightImage,this.changed()},HandleMorph.prototype.mouseLeave=function(){this.image=this.normalImage,this.changed()},HandleMorph.prototype.attach=function(){var t=this.overlappedMorphs(),e=new MenuMorph(this,"choose target:"),o=this;t.forEach(function(t){e.addItem(t.toString().slice(0,50),function(){o.isDraggable=!1,o.target=t,o.drawNew(),o.noticesTransparentClick=!0})}),t.length>0&&e.popUpAtHand(this.world())};var PenMorph;PenMorph.prototype=new Morph,PenMorph.prototype.constructor=PenMorph,PenMorph.uber=Morph.prototype,PenMorph.prototype.init=function(){var t=4*MorphicPreferences.handleSize;this.isWarped=!1,this.heading=0,this.isDown=!0,this.size=1,this.wantsRedraw=!1,this.penPoint="tip",this.penBounds=null,HandleMorph.uber.init.call(this),this.setExtent(new Point(t,t))},PenMorph.prototype.changed=function(){if(!1===this.isWarped){var t=this.root();t instanceof WorldMorph&&t.broken.push(this.visibleBounds().spread()),this.parent&&this.parent.childChanged(this)}},PenMorph.prototype.drawNew=function(t){var e,o,i,r,n,s,a=t||this.heading;this.isWarped?this.wantsRedraw=!0:(this.image=newCanvas(this.extent()),e=this.image.getContext("2d"),s=this.width()/2,o=this.center().subtract(this.bounds.origin),"tip"===this.penPoint?(i=o.distanceAngle(.75*s,a-180),r=o.distanceAngle(s,a+195),n=o.distanceAngle(s,a-195)):(i=o.distanceAngle(.75*s,a),r=o.distanceAngle(.33*s,a+230),n=o.distanceAngle(.33*s,a-230)),this.penBounds=new Rectangle(Math.min(o.x,i.x,r.x,n.x),Math.min(o.y,i.y,r.y,n.y),Math.max(o.x,i.x,r.x,n.x),Math.max(o.y,i.y,r.y,n.y)),e.fillStyle=this.color.toString(),e.beginPath(),e.moveTo(o.x,o.y),e.lineTo(r.x,r.y),e.lineTo(i.x,i.y),e.lineTo(n.x,n.y),e.closePath(),e.strokeStyle="white",e.lineWidth=3,e.stroke(),e.strokeStyle="black",e.lineWidth=1,e.stroke(),e.fill())},PenMorph.prototype.setHeading=function(t){this.heading=(+t%360+360)%360,this.drawNew(),this.changed()},PenMorph.prototype.drawLine=function(t,e){var o=this.parent.penTrails().getContext("2d"),i=t.subtract(this.parent.bounds.origin),r=e.subtract(this.parent.bounds.origin);this.isDown&&(o.lineWidth=this.size,o.strokeStyle=this.color.toString(),o.lineCap="round",o.lineJoin="round",o.beginPath(),o.moveTo(i.x,i.y),o.lineTo(r.x,r.y),o.stroke(),!1===this.isWarped&&this.world().broken.push(t.rectangle(e).expandBy(Math.max(this.size/2,1)).intersect(this.parent.visibleBounds()).spread()))},PenMorph.prototype.turn=function(t){this.setHeading(this.heading+parseFloat(t))},PenMorph.prototype.forward=function(t){var e,o=this.center(),i=parseFloat(t);e=i>=0?this.position().distanceAngle(i,this.heading):this.position().distanceAngle(Math.abs(i),this.heading-180),this.setPosition(e),this.drawLine(o,this.center())},PenMorph.prototype.down=function(){this.isDown=!0},PenMorph.prototype.up=function(){this.isDown=!1},PenMorph.prototype.clear=function(){this.parent.drawNew(),this.parent.changed()},PenMorph.prototype.startWarp=function(){this.wantsRedraw=!1,this.isWarped=!0},PenMorph.prototype.endWarp=function(){this.isWarped=!1,this.wantsRedraw&&(this.drawNew(),this.wantsRedraw=!1),this.parent.changed()},PenMorph.prototype.warp=function(t){this.startWarp(),t.call(this),this.endWarp()},PenMorph.prototype.warpOp=function(t,e){this.startWarp(),this[t].apply(this,e),this.endWarp()},PenMorph.prototype.warpSierpinski=function(t,e){this.warpOp("sierpinski",[t,e])},PenMorph.prototype.sierpinski=function(t,e){var o;if(t>e)for(o=0;o<3;o+=1)this.sierpinski(.5*t,e),this.turn(120),this.forward(t)},PenMorph.prototype.warpTree=function(t,e,o){this.warpOp("tree",[t,e,o])},PenMorph.prototype.tree=function(t,e,o){t>0&&(this.size=t,this.forward(e),this.turn(o),this.tree(t-1,.75*e,o),this.turn(-2*o),this.tree(t-1,.75*e,o),this.turn(o),this.forward(-e))};var ColorPaletteMorph;ColorPaletteMorph.prototype=new Morph,ColorPaletteMorph.prototype.constructor=ColorPaletteMorph,ColorPaletteMorph.uber=Morph.prototype,ColorPaletteMorph.prototype.init=function(t,e){ColorPaletteMorph.uber.init.call(this),this.target=t,this.targetSetter="color",this.silentSetExtent(e),this.choice=null,this.drawNew()},ColorPaletteMorph.prototype.drawNew=function(){var t,e,o,i,r,n;for(e=this.extent(),this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),this.choice=new Color,o=0;o<=e.x;o+=1)for(r=360*o/e.x,i=0;i<=e.y;i+=1)n=100-i/e.y*100,t.fillStyle="hsl("+r+",100%,"+n+"%)",t.fillRect(o,i,1,1)},ColorPaletteMorph.prototype.mouseMove=function(t){this.choice=this.getPixelColor(t),this.updateTarget()},ColorPaletteMorph.prototype.mouseDownLeft=function(t){this.choice=this.getPixelColor(t),this.updateTarget()},ColorPaletteMorph.prototype.updateTarget=function(){this.target instanceof Morph&&null!==this.choice&&(this.target[this.targetSetter]instanceof Function?this.target[this.targetSetter](this.choice):(this.target[this.targetSetter]=this.choice,this.target.drawNew(),this.target.changed()))},ColorPaletteMorph.prototype.developersMenu=function(){var t=ColorPaletteMorph.uber.developersMenu.call(this);return t.addLine(),t.addItem("set target","setTarget","choose another morph\nwhose color property\n will be controlled by this one"),t},ColorPaletteMorph.prototype.setTarget=function(){var t=this.overlappedMorphs(),e=new MenuMorph(this,"choose target:"),o=this;t.push(this.world()),t.forEach(function(t){e.addItem(t.toString().slice(0,50),function(){o.target=t,o.setTargetSetter()})}),1===t.length?(this.target=t[0],this.setTargetSetter()):t.length>0&&e.popUpAtHand(this.world())},ColorPaletteMorph.prototype.setTargetSetter=function(){var t=this.target.colorSetters(),e=new MenuMorph(this,"choose target property:"),o=this;t.forEach(function(t){e.addItem(t,function(){o.targetSetter=t})}),1===t.length?this.targetSetter=t[0]:t.length>0&&e.popUpAtHand(this.world())};var GrayPaletteMorph;GrayPaletteMorph.prototype=new ColorPaletteMorph,GrayPaletteMorph.prototype.constructor=GrayPaletteMorph,GrayPaletteMorph.uber=ColorPaletteMorph.prototype,GrayPaletteMorph.prototype.drawNew=function(){var t,e,o;e=this.extent(),this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),this.choice=new Color,(o=t.createLinearGradient(0,0,e.x,e.y)).addColorStop(0,"black"),o.addColorStop(1,"white"),t.fillStyle=o,t.fillRect(0,0,e.x,e.y)},ColorPickerMorph.prototype=new Morph,ColorPickerMorph.prototype.constructor=ColorPickerMorph,ColorPickerMorph.uber=Morph.prototype,ColorPickerMorph.prototype.init=function(t){this.choice=t,ColorPickerMorph.uber.init.call(this),this.color=new Color(255,255,255),this.silentSetExtent(new Point(80,80)),this.drawNew()},ColorPickerMorph.prototype.drawNew=function(){ColorPickerMorph.uber.drawNew.call(this),this.buildSubmorphs()},ColorPickerMorph.prototype.buildSubmorphs=function(){var t,e,o,i;this.children.forEach(function(t){t.destroy()}),this.children=[],this.feedback=new Morph,this.feedback.color=this.choice,this.feedback.setExtent(new Point(20,20)),t=new ColorPaletteMorph(this.feedback,new Point(this.width(),50)),e=new GrayPaletteMorph(this.feedback,new Point(this.width(),5)),t.setPosition(this.bounds.origin),this.add(t),e.setPosition(t.bottomLeft()),this.add(e),o=e.left()+Math.floor((e.width()-this.feedback.width())/2),i=e.bottom()+Math.floor((this.bottom()-e.bottom()-this.feedback.height())/2),this.feedback.setPosition(new Point(o,i)),this.add(this.feedback)},ColorPickerMorph.prototype.getChoice=function(){return this.feedback.color},ColorPickerMorph.prototype.rootForGrab=function(){return this};var BlinkerMorph;BlinkerMorph.prototype=new Morph,BlinkerMorph.prototype.constructor=BlinkerMorph,BlinkerMorph.uber=Morph.prototype,BlinkerMorph.prototype.init=function(t){BlinkerMorph.uber.init.call(this),this.color=new Color(0,0,0),this.fps=t||2,this.drawNew()},BlinkerMorph.prototype.step=function(){this.toggleVisibility()};var CursorMorph;CursorMorph.prototype=new BlinkerMorph,CursorMorph.prototype.constructor=CursorMorph,CursorMorph.uber=BlinkerMorph.prototype,CursorMorph.prototype.viewPadding=1,CursorMorph.prototype.init=function(t){var e;this.keyDownEventUsed=!1,this.target=t,this.originalContents=this.target.text,this.originalAlignment=this.target.alignment,this.slot=this.target.text.length,CursorMorph.uber.init.call(this),e=fontHeight(this.target.fontSize),this.setExtent(new Point(Math.max(Math.floor(e/20),1),e)),this.drawNew(),this.image.getContext("2d").font=this.target.font(),this.target instanceof TextMorph&&"left"!==this.target.alignment&&this.target.setAlignmentToLeft(),this.gotoSlot(this.slot),this.initializeClipboardHandler()},CursorMorph.prototype.initializeClipboardHandler=function(){var t=this,e=this.target.world();this.clipboardHandler=document.createElement("textarea"),this.clipboardHandler.style.position="absolute",this.clipboardHandler.style.top=window.outerHeight,this.clipboardHandler.style.right="101%",document.body.appendChild(this.clipboardHandler),this.clipboardHandler.value=this.target.selection(),this.clipboardHandler.focus(),this.clipboardHandler.select(),this.clipboardHandler.addEventListener("keypress",function(e){t.processKeyPress(e),this.value=t.target.selection(),this.select()},!1),this.clipboardHandler.addEventListener("keydown",function(o){t.processKeyDown(o),o.shiftKey&&(e.currentKey=16),this.value=t.target.selection(),this.select(),"U+0009"!==o.key&&"Tab"!==o.key||(t.processKeyPress(o),o.preventDefault())},!1),this.clipboardHandler.addEventListener("keyup",function(t){e.currentKey=null},!1),this.clipboardHandler.addEventListener("input",function(e){""===this.value&&(t.gotoSlot(t.target.selectionStartSlot()),t.target.deleteSelection())},!1)},CursorMorph.prototype.processKeyPress=function(t){return this.keyDownEventUsed?(this.keyDownEventUsed=!1,null):40===t.keyCode||40===t.charCode?(this.insert("("),null):37===t.keyCode||37===t.charCode?(this.insert("%"),null):(t.keyCode?t.ctrlKey&&!t.altKey?this.ctrl(t.keyCode,t.shiftKey):t.metaKey?this.cmd(t.keyCode,t.shiftKey):this.insert(String.fromCharCode(t.keyCode),t.shiftKey):t.charCode&&(t.ctrlKey&&!t.altKey?this.ctrl(t.charCode,t.shiftKey):t.metaKey?this.cmd(t.charCode,t.shiftKey):this.insert(String.fromCharCode(t.charCode),t.shiftKey)),void this.target.escalateEvent("reactToKeystroke",t))},CursorMorph.prototype.processKeyDown=function(t){var e=t.shiftKey,o=t.ctrlKey||t.altKey,i=this.target.selection().length>0;switch(this.keyDownEventUsed=!1,t.ctrlKey&&!t.altKey&&(this.ctrl(t.keyCode,t.shiftKey),this.target.escalateEvent("reactToKeystroke",t)),t.metaKey&&(this.cmd(t.keyCode,t.shiftKey),this.target.escalateEvent("reactToKeystroke",t)),t.keyCode){case 37:!i||e||o?this.goLeft(e,o?this.slot-this.target.previousWordFrom(this.slot):1):(this.gotoSlot(Math.min(this.target.startMark,this.target.endMark)),this.target.clearSelection()),this.keyDownEventUsed=!0;break;case 39:!i||e||o?this.goRight(e,o?this.target.nextWordFrom(this.slot)-this.slot:1):(this.gotoSlot(Math.max(this.target.startMark,this.target.endMark)),this.target.clearSelection()),this.keyDownEventUsed=!0;break;case 38:this.goUp(e),this.keyDownEventUsed=!0;break;case 40:this.goDown(e),this.keyDownEventUsed=!0;break;case 36:this.goHome(e),this.keyDownEventUsed=!0;break;case 35:this.goEnd(e),this.keyDownEventUsed=!0;break;case 46:this.deleteRight(),this.keyDownEventUsed=!0;break;case 8:this.deleteLeft(),this.keyDownEventUsed=!0;break;case 13:this.target instanceof StringMorph||e?this.accept():this.insert("\n"),this.keyDownEventUsed=!0;break;case 27:this.cancel(),this.keyDownEventUsed=!0;break;default:nop()}this.target.escalateEvent("reactToKeystroke",t)},CursorMorph.prototype.gotoSlot=function(t){var e,o,i=this.target.text.length,r=this.target.slotPosition(t);this.slot=t<0?0:t>i?i:t,this.parent&&this.target.isScrollable&&(e=this.parent.right()-this.viewPadding,o=this.parent.left()+this.viewPadding,r.x>e&&(this.target.setLeft(this.target.left()+e-r.x),r.x=e),r.x<o&&(o=Math.min(this.parent.left(),o),this.target.setLeft(this.target.left()+o-r.x),r.x=o),this.target.right()<e&&e-this.target.width()<o&&(r.x+=e-this.target.right(),this.target.setRight(e))),this.show(),this.setPosition(r),this.parent&&this.parent.parent instanceof ScrollFrameMorph&&this.target.isScrollable&&this.parent.parent.scrollCursorIntoView(this)},CursorMorph.prototype.goLeft=function(t,e){this.updateSelection(t),this.gotoSlot(this.slot-(e||1)),this.updateSelection(t)},CursorMorph.prototype.goRight=function(t,e){this.updateSelection(t),this.gotoSlot(this.slot+(e||1)),this.updateSelection(t)},CursorMorph.prototype.goUp=function(t){this.updateSelection(t),this.gotoSlot(this.target.upFrom(this.slot)),this.updateSelection(t)},CursorMorph.prototype.goDown=function(t){this.updateSelection(t),this.gotoSlot(this.target.downFrom(this.slot)),this.updateSelection(t)},CursorMorph.prototype.goHome=function(t){this.updateSelection(t),this.gotoSlot(this.target.startOfLine(this.slot)),this.updateSelection(t)},CursorMorph.prototype.goEnd=function(t){this.updateSelection(t),this.gotoSlot(this.target.endOfLine(this.slot)),this.updateSelection(t)},CursorMorph.prototype.gotoPos=function(t){this.gotoSlot(this.target.slotAt(t)),this.show()},CursorMorph.prototype.updateSelection=function(t){t?isNil(this.target.endMark)&&isNil(this.target.startMark)?(this.target.startMark=this.slot,this.target.endMark=this.slot):this.target.endMark!==this.slot&&(this.target.endMark=this.slot,this.target.drawNew(),this.target.changed()):this.target.clearSelection()},CursorMorph.prototype.accept=function(){var t=this.root();t&&t.stopEditing(),this.escalateEvent("accept",this)},CursorMorph.prototype.cancel=function(){var t=this.root();this.undo(),t&&t.stopEditing(),this.escalateEvent("cancel",this)},CursorMorph.prototype.undo=function(){this.target.text=this.originalContents,this.target.changed(),this.target.drawNew(),this.target.changed(),this.gotoSlot(0)},CursorMorph.prototype.insert=function(t,e){var o;if("\t"===t)return this.target.escalateEvent("reactToEdit",this.target),e?this.target.backTab(this.target):this.target.tab(this.target);this.target.isNumeric&&isNaN(parseFloat(t))&&!contains(["-","."],t)||(""!==this.target.selection()&&(this.gotoSlot(this.target.selectionStartSlot()),this.target.deleteSelection()),o=(o=this.target.text).slice(0,this.slot)+t+o.slice(this.slot),this.target.text=o,this.target.drawNew(),this.target.changed(),this.goRight(!1,t.length))},CursorMorph.prototype.ctrl=function(t,e){64===t||65===t&&e?this.insert("@"):65===t?this.target.selectAll():90===t?this.undo():123===t?this.insert("{"):125===t?this.insert("}"):91===t?this.insert("["):93===t?this.insert("]"):isNil(this.target.receiver)||(68===t?this.target.doIt():73===t?this.target.inspectIt():80===t&&this.target.showIt())},CursorMorph.prototype.cmd=function(t,e){64===t||65===t&&e?this.insert("@"):65===t?this.target.selectAll():90===t?this.undo():isNil(this.target.receiver)||(68===t?this.target.doIt():73===t?this.target.inspectIt():80===t&&this.target.showIt())},CursorMorph.prototype.deleteRight=function(){var t;""!==this.target.selection()?(this.gotoSlot(this.target.selectionStartSlot()),this.target.deleteSelection()):(t=this.target.text,this.target.changed(),t=t.slice(0,this.slot)+t.slice(this.slot+1),this.target.text=t,this.target.drawNew())},CursorMorph.prototype.deleteLeft=function(){var t;if(this.target.selection())return this.gotoSlot(this.target.selectionStartSlot()),this.target.deleteSelection();t=this.target.text,this.target.changed(),this.target.text=t.substring(0,this.slot-1)+t.substr(this.slot),this.target.drawNew(),this.goLeft()},CursorMorph.prototype.destroy=function(){this.target.alignment!==this.originalAlignment&&(this.target.alignment=this.originalAlignment,this.target.drawNew(),this.target.changed()),this.destroyClipboardHandler(),CursorMorph.uber.destroy.call(this)},CursorMorph.prototype.destroyClipboardHandler=function(){var t,e=document.body.children;if(this.clipboardHandler)for(t=0;t<e.length;t+=1)e[t]===this.clipboardHandler&&(document.body.removeChild(this.clipboardHandler),this.clipboardHandler=null)},CursorMorph.prototype.inspectKeyEvent=function(t){this.inform("Key pressed: "+String.fromCharCode(t.charCode)+"\n------------------------\ncharCode: "+t.charCode.toString()+"\nkeyCode: "+t.keyCode.toString()+"\nshiftKey: "+t.shiftKey.toString()+"\naltKey: "+t.altKey.toString()+"\nctrlKey: "+t.ctrlKey.toString()+"\ncmdKey: "+t.metaKey.toString())};var BoxMorph;BoxMorph.prototype=new Morph,BoxMorph.prototype.constructor=BoxMorph,BoxMorph.uber=Morph.prototype,BoxMorph.prototype.init=function(t,e,o){this.edge=t||4,this.border=e||(0===e?0:2),this.borderColor=o||new Color,BoxMorph.uber.init.call(this)},BoxMorph.prototype.drawNew=function(){var t;if(this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),0===this.edge&&0===this.border)return BoxMorph.uber.drawNew.call(this),null;t.fillStyle=this.color.toString(),t.beginPath(),this.outlinePath(t,Math.max(this.edge-this.border,0),this.border),t.closePath(),t.fill(),this.border>0&&(t.lineWidth=this.border,t.strokeStyle=this.borderColor.toString(),t.beginPath(),this.outlinePath(t,this.edge,this.border/2),t.closePath(),t.stroke())},BoxMorph.prototype.outlinePath=function(t,e,o){var i=e+o,r=this.width(),n=this.height();t.arc(i,i,e,radians(-180),radians(-90),!1),t.arc(r-i,i,e,radians(-90),radians(-0),!1),t.arc(r-i,n-i,e,radians(0),radians(90),!1),t.arc(i,n-i,e,radians(90),radians(180),!1)},BoxMorph.prototype.developersMenu=function(){var t=BoxMorph.uber.developersMenu.call(this);return t.addLine(),t.addItem("border width...",function(){this.prompt(t.title+"\nborder\nwidth:",this.setBorderWidth,this,this.border.toString(),null,0,100,!0)},"set the border's\nline size"),t.addItem("border color...",function(){this.pickColor(t.title+"\nborder color:",this.setBorderColor,this,this.borderColor)},"set the border's\nline color"),t.addItem("corner size...",function(){this.prompt(t.title+"\ncorner\nsize:",this.setCornerSize,this,this.edge.toString(),null,0,100,!0)},"set the corner's\nradius"),t},BoxMorph.prototype.setBorderWidth=function(t){var e;"number"==typeof t?this.border=Math.max(t,0):(e=parseFloat(t),isNaN(e)||(this.border=Math.max(e,0))),this.drawNew(),this.changed()},BoxMorph.prototype.setBorderColor=function(t){t&&(this.borderColor=t,this.drawNew(),this.changed())},BoxMorph.prototype.setCornerSize=function(t){var e;"number"==typeof t?this.edge=Math.max(t,0):(e=parseFloat(t),isNaN(e)||(this.edge=Math.max(e,0))),this.drawNew(),this.changed()},BoxMorph.prototype.colorSetters=function(){return["color","borderColor"]},BoxMorph.prototype.numericalSetters=function(){var t=BoxMorph.uber.numericalSetters.call(this);return t.push("setBorderWidth","setCornerSize"),t};var SpeechBubbleMorph;SpeechBubbleMorph.prototype=new BoxMorph,SpeechBubbleMorph.prototype.constructor=SpeechBubbleMorph,SpeechBubbleMorph.uber=BoxMorph.prototype,SpeechBubbleMorph.prototype.init=function(t,e,o,i,r,n,s){this.isPointingRight=!0,this.contents=t||"",this.padding=n||0,this.isThought=s||!1,this.isClickable=!1,SpeechBubbleMorph.uber.init.call(this,o||6,i||(0===i?0:1),r||new Color(140,140,140)),this.color=e||new Color(230,230,230),this.drawNew()},SpeechBubbleMorph.prototype.popUp=function(t,e,o){this.drawNew(),this.setPosition(e.subtract(new Point(0,this.height()))),this.addShadow(new Point(2,2),80),this.keepWithin(t),t.add(this),this.fullChanged(),t.hand.destroyTemporaries(),t.hand.temporaries.push(this),o?this.isClickable=!0:this.mouseEnter=function(){this.destroy()}},SpeechBubbleMorph.prototype.drawNew=function(){this.contentsMorph&&this.contentsMorph.destroy(),this.contents instanceof Morph?this.contentsMorph=this.contents:isString(this.contents)?this.contentsMorph=new TextMorph(this.contents,MorphicPreferences.bubbleHelpFontSize,null,!1,!0,"center"):this.contents instanceof HTMLCanvasElement?(this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(this.contents.width),this.contentsMorph.silentSetHeight(this.contents.height),this.contentsMorph.image=this.contents):this.contentsMorph=new TextMorph(this.contents.toString(),MorphicPreferences.bubbleHelpFontSize,null,!1,!0,"center"),this.add(this.contentsMorph),this.silentSetWidth(this.contentsMorph.width()+(this.padding?2*this.padding:2*this.edge)),this.silentSetHeight(this.contentsMorph.height()+this.edge+2*this.border+2*this.padding+2),SpeechBubbleMorph.uber.drawNew.call(this),this.contentsMorph.setPosition(this.position().add(new Point(this.padding||this.edge,this.border+this.padding+1)))},SpeechBubbleMorph.prototype.outlinePath=function(t,e,o){function i(e,o,i){t.moveTo(e+i,o),t.arc(e,o,i,radians(0),radians(360))}var r,n=e+o,s=this.width(),a=this.height();t.arc(n,n,e,radians(-180),radians(-90),!1),t.arc(s-n,n,e,radians(-90),radians(-0),!1),t.arc(s-n,a-n-e,e,radians(0),radians(90),!1),this.isThought||(this.isPointingRight?(t.lineTo(n+e,a-n),t.lineTo(e/2+o,a-o)):(t.lineTo(s-(e/2+o),a-o),t.lineTo(s-(n+e),a-n))),t.arc(n,a-n-e,e,radians(90),radians(180),!1),!0===this.isThought&&(t.lineTo(o,n),this.isPointingRight?(i((r=e/4)+o,a-r-o,r),i(2*(r=e/3.2)+o,a-r-2*o,r),i(3*(r=e/2.8)+2*o,a-r-4*o,r)):(i(s-((r=e/4)+o),a-r-o,r),i(s-(2*(r=e/3.2)+o),a-r-2*o,r),i(s-(3*(r=e/2.8)+2*o),a-r-4*o,r)))},SpeechBubbleMorph.prototype.shadowImage=function(t,e){var o,i,r,n,s,a=t||new Point(7,7),h=e||new Color(0,0,0);return o=this.extent(),i=this.image,r=newCanvas(o),(s=r.getContext("2d")).drawImage(i,0,0),s.globalCompositeOperation="destination-out",s.drawImage(i,-a.x,-a.y),n=newCanvas(o),(s=n.getContext("2d")).drawImage(r,0,0),s.globalCompositeOperation="source-atop",s.fillStyle=h.toString(),s.fillRect(0,0,o.x,o.y),n},SpeechBubbleMorph.prototype.shadowImageBlurred=function(t,e){var o,i,r,n,s=t||new Point(7,7),a=this.shadowBlur,h=e||new Color(0,0,0);return o=this.extent().add(2*a),i=this.image,r=newCanvas(o),n=r.getContext("2d"),n.shadowOffsetX=s.x,n.shadowOffsetY=s.y,n.shadowBlur=a,n.shadowColor=h.toString(),n.drawImage(i,a-s.x,a-s.y),n.shadowOffsetX=0,n.shadowOffsetY=0,n.shadowBlur=0,n.globalCompositeOperation="destination-out",n.drawImage(i,a-s.x,a-s.y),r},SpeechBubbleMorph.prototype.fixLayout=function(){this.removeShadow(),this.drawNew(),this.addShadow(new Point(2,2),80)};var CircleBoxMorph;CircleBoxMorph.prototype=new Morph,CircleBoxMorph.prototype.constructor=CircleBoxMorph,CircleBoxMorph.uber=Morph.prototype,CircleBoxMorph.prototype.init=function(t){CircleBoxMorph.uber.init.call(this),this.orientation=t,this.autoOrient=!0,this.setExtent(new Point(20,100))},CircleBoxMorph.prototype.autoOrientation=function(){this.height()>this.width()?this.orientation="vertical":this.orientation="horizontal"},CircleBoxMorph.prototype.drawNew=function(){var t,e,o,i,r,n,s,a,h=this;this.autoOrient&&this.autoOrientation(),this.image=newCanvas(this.extent()),s=this.image.getContext("2d"),"vertical"===this.orientation?(t=this.width()/2,e=new Point(r=this.center().x,this.top()+t),o=new Point(r,this.bottom()-t),i=this.bounds.origin.add(new Point(0,t)).corner(this.bounds.corner.subtract(new Point(0,t)))):(t=this.height()/2,n=this.center().y,e=new Point(this.left()+t,n),o=new Point(this.right()-t,n),i=this.bounds.origin.add(new Point(t,0)).corner(this.bounds.corner.subtract(new Point(t,0)))),[e.subtract(this.bounds.origin),o.subtract(this.bounds.origin)].forEach(function(e){s.fillStyle=h.color.toString(),s.beginPath(),s.arc(e.x,e.y,t,0,2*Math.PI,!1),s.closePath(),s.fill()}),(a=(i=i.translateBy(this.bounds.origin.neg())).extent()).x>0&&a.y>0&&s.fillRect(i.origin.x,i.origin.y,i.width(),i.height())},CircleBoxMorph.prototype.developersMenu=function(){var t=CircleBoxMorph.uber.developersMenu.call(this);return t.addLine(),"vertical"===this.orientation?t.addItem("horizontal...","toggleOrientation","toggle the\norientation"):t.addItem("vertical...","toggleOrientation","toggle the\norientation"),t},CircleBoxMorph.prototype.toggleOrientation=function(){var t=this.center();this.changed(),"vertical"===this.orientation?this.orientation="horizontal":this.orientation="vertical",this.silentSetExtent(new Point(this.height(),this.width())),this.setCenter(t),this.drawNew(),this.changed()};var SliderButtonMorph;SliderButtonMorph.prototype=new CircleBoxMorph,SliderButtonMorph.prototype.constructor=SliderButtonMorph,SliderButtonMorph.uber=CircleBoxMorph.prototype,SliderButtonMorph.prototype.init=function(t){this.color=new Color(80,80,80),this.highlightColor=new Color(90,90,140),this.pressColor=new Color(80,80,160),this.is3D=!1,this.hasMiddleDip=!0,SliderButtonMorph.uber.init.call(this,t)},SliderButtonMorph.prototype.autoOrientation=nop,SliderButtonMorph.prototype.drawNew=function(){var t=this.color.copy();SliderButtonMorph.uber.drawNew.call(this),!this.is3D&&MorphicPreferences.isFlat||this.drawEdges(),this.normalImage=this.image,this.color=this.highlightColor.copy(),SliderButtonMorph.uber.drawNew.call(this),!this.is3D&&MorphicPreferences.isFlat||this.drawEdges(),this.highlightImage=this.image,this.color=this.pressColor.copy(),SliderButtonMorph.uber.drawNew.call(this),!this.is3D&&MorphicPreferences.isFlat||this.drawEdges(),this.pressImage=this.image,this.color=t,this.image=this.normalImage},SliderButtonMorph.prototype.drawEdges=function(){var t,e,o=this.image.getContext("2d"),i=this.width(),r=this.height();o.lineJoin="round",o.lineCap="round","vertical"===this.orientation?(o.lineWidth=i/3,(t=o.createLinearGradient(0,0,o.lineWidth,0)).addColorStop(0,"white"),t.addColorStop(1,this.color.toString()),o.strokeStyle=t,o.beginPath(),o.moveTo(.5*o.lineWidth,i/2),o.lineTo(.5*o.lineWidth,r-i/2),o.stroke(),(t=o.createLinearGradient(i-o.lineWidth,0,i,0)).addColorStop(0,this.color.toString()),t.addColorStop(1,"black"),o.strokeStyle=t,o.beginPath(),o.moveTo(i-.5*o.lineWidth,i/2),o.lineTo(i-.5*o.lineWidth,r-i/2),o.stroke(),this.hasMiddleDip&&(e=i/4,(t=o.createLinearGradient(o.lineWidth,0,i-o.lineWidth,0)).addColorStop(0,"black"),t.addColorStop(.35,this.color.toString()),t.addColorStop(.65,this.color.toString()),t.addColorStop(1,"white"),o.fillStyle=t,o.beginPath(),o.arc(i/2,r/2,e,radians(0),radians(360),!1),o.closePath(),o.fill())):"horizontal"===this.orientation&&(o.lineWidth=r/3,(t=o.createLinearGradient(0,0,0,o.lineWidth)).addColorStop(0,"white"),t.addColorStop(1,this.color.toString()),o.strokeStyle=t,o.beginPath(),o.moveTo(r/2,.5*o.lineWidth),o.lineTo(i-r/2,.5*o.lineWidth),o.stroke(),(t=o.createLinearGradient(0,r-o.lineWidth,0,r)).addColorStop(0,this.color.toString()),t.addColorStop(1,"black"),o.strokeStyle=t,o.beginPath(),o.moveTo(r/2,r-.5*o.lineWidth),o.lineTo(i-r/2,r-.5*o.lineWidth),o.stroke(),this.hasMiddleDip&&(e=r/4,(t=o.createLinearGradient(0,o.lineWidth,0,r-o.lineWidth)).addColorStop(0,"black"),t.addColorStop(.35,this.color.toString()),t.addColorStop(.65,this.color.toString()),t.addColorStop(1,"white"),o.fillStyle=t,o.beginPath(),o.arc(this.width()/2,this.height()/2,e,radians(0),radians(360),!1),o.closePath(),o.fill()))},SliderButtonMorph.prototype.mouseEnter=function(){this.image=this.highlightImage,this.changed()},SliderButtonMorph.prototype.mouseLeave=function(){this.image=this.normalImage,this.changed()},SliderButtonMorph.prototype.mouseDownLeft=function(t){this.image=this.pressImage,this.changed(),this.escalateEvent("mouseDownLeft",t)},SliderButtonMorph.prototype.mouseClickLeft=function(){this.image=this.highlightImage,this.changed()},SliderButtonMorph.prototype.mouseMove=function(){nop()},SliderMorph.prototype=new CircleBoxMorph,SliderMorph.prototype.constructor=SliderMorph,SliderMorph.uber=CircleBoxMorph.prototype,SliderMorph.prototype.init=function(t,e,o,i,r,n){this.target=null,this.action=null,this.start=t,this.stop=e,this.value=o,this.size=i,this.offset=null,this.button=new SliderButtonMorph,this.button.isDraggable=!1,this.button.color=new Color(200,200,200),this.button.highlightColor=new Color(210,210,255),this.button.pressColor=new Color(180,180,255),SliderMorph.uber.init.call(this,r),this.add(this.button),this.alpha=.3,this.color=n||new Color(0,0,0),this.setExtent(new Point(20,100))},SliderMorph.prototype.autoOrientation=nop,SliderMorph.prototype.rangeSize=function(){return this.stop-this.start},SliderMorph.prototype.ratio=function(){return this.size/(this.rangeSize()+1)},SliderMorph.prototype.unitSize=function(){return"vertical"===this.orientation?(this.height()-this.button.height())/this.rangeSize():(this.width()-this.button.width())/this.rangeSize()},SliderMorph.prototype.drawNew=function(){var t,e,o,i;SliderMorph.uber.drawNew.call(this),this.button.orientation=this.orientation,"vertical"===this.orientation?(t=this.width()-2,e=Math.max(t,Math.round(this.height()*this.ratio())),this.button.silentSetExtent(new Point(t,e)),o=1,i=Math.min(Math.round((this.value-this.start)*this.unitSize()),this.height()-this.button.height())):(e=this.height()-2,t=Math.max(e,Math.round(this.width()*this.ratio())),this.button.silentSetExtent(new Point(t,e)),i=1,o=Math.min(Math.round((this.value-this.start)*this.unitSize()),this.width()-this.button.width())),this.button.setPosition(new Point(o,i).add(this.bounds.origin)),this.button.drawNew(),this.button.changed()},SliderMorph.prototype.updateValue=function(){var t;t="vertical"===this.orientation?this.button.top()-this.top():this.button.left()-this.left(),this.value=Math.round(t/this.unitSize()+this.start),this.updateTarget()},SliderMorph.prototype.updateTarget=function(){this.action&&("function"==typeof this.action?this.action.call(this.target,this.value):this.target[this.action](this.value))},SliderMorph.prototype.developersMenu=function(){var t=SliderMorph.uber.developersMenu.call(this);return t.addItem("show value...","showValue","display a dialog box\nshowing the selected number"),t.addItem("floor...",function(){this.prompt(t.title+"\nfloor:",this.setStart,this,this.start.toString(),null,0,this.stop-this.size,!0)},"set the minimum value\nwhich can be selected"),t.addItem("ceiling...",function(){this.prompt(t.title+"\nceiling:",this.setStop,this,this.stop.toString(),null,this.start+this.size,100*this.size,!0)},"set the maximum value\nwhich can be selected"),t.addItem("button size...",function(){this.prompt(t.title+"\nbutton size:",this.setSize,this,this.size.toString(),null,1,this.stop-this.start,!0)},"set the range\ncovered by\nthe slider button"),t.addLine(),t.addItem("set target","setTarget","select another morph\nwhose numerical property\nwill be controlled by this one"),t},SliderMorph.prototype.showValue=function(){this.inform(this.value)},SliderMorph.prototype.userSetStart=function(t){this.start=Math.max(t,this.stop)},SliderMorph.prototype.setStart=function(t,e){var o;"number"==typeof t?this.start=Math.min(t,this.stop-this.size):(o=parseFloat(t),isNaN(o)||(this.start=Math.min(o,this.stop-this.size))),this.value=Math.max(this.value,this.start),e||this.updateTarget(),this.drawNew(),this.changed()},SliderMorph.prototype.setStop=function(t,e){var o;"number"==typeof t?this.stop=Math.max(t,this.start+this.size):(o=parseFloat(t),isNaN(o)||(this.stop=Math.max(o,this.start+this.size))),this.value=Math.min(this.value,this.stop),e||this.updateTarget(),this.drawNew(),this.changed()},SliderMorph.prototype.setSize=function(t,e){var o;"number"==typeof t?this.size=Math.min(Math.max(t,1),this.stop-this.start):(o=parseFloat(t),isNaN(o)||(this.size=Math.min(Math.max(o,1),this.stop-this.start))),this.value=Math.min(this.value,this.stop-this.size),e||this.updateTarget(),this.drawNew(),this.changed()},SliderMorph.prototype.setTarget=function(){var t=this.overlappedMorphs(),e=new MenuMorph(this,"choose target:"),o=this;t.push(this.world()),t.forEach(function(t){e.addItem(t.toString().slice(0,50),function(){o.target=t,o.setTargetSetter()})}),1===t.length?(this.target=t[0],this.setTargetSetter()):t.length>0&&e.popUpAtHand(this.world())},SliderMorph.prototype.setTargetSetter=function(){var t=this.target.numericalSetters(),e=new MenuMorph(this,"choose target property:"),o=this;t.forEach(function(t){e.addItem(t,function(){o.action=t})}),1===t.length?this.action=t[0]:t.length>0&&e.popUpAtHand(this.world())},SliderMorph.prototype.numericalSetters=function(){var t=SliderMorph.uber.numericalSetters.call(this);return t.push("setStart","setStop","setSize"),t},SliderMorph.prototype.step=null,SliderMorph.prototype.mouseDownLeft=function(t){var e,o=this;this.button.bounds.containsPoint(t)?this.offset=t.subtract(this.button.bounds.origin):this.offset=new Point,e=this.root(),this.step=function(){var t,i,r;e.hand.mouseButton?(t=e.hand.bounds.origin,"vertical"===o.orientation?(i=o.button.bounds.origin.x,r=Math.max(Math.min(t.y-o.offset.y,o.bottom()-o.button.height()),o.top())):(r=o.button.bounds.origin.y,i=Math.max(Math.min(t.x-o.offset.x,o.right()-o.button.width()),o.left())),o.button.setPosition(new Point(i,r)),o.updateValue()):this.step=null}};var MouseSensorMorph;MouseSensorMorph.prototype=new BoxMorph,MouseSensorMorph.prototype.constructor=MouseSensorMorph,MouseSensorMorph.uber=BoxMorph.prototype,MouseSensorMorph.prototype.init=function(t,e,o){MouseSensorMorph.uber.init.call(this),this.edge=t||4,this.border=e||2,this.color=new Color(255,255,255),this.borderColor=o||new Color,this.isTouched=!1,this.upStep=.05,this.downStep=.02,this.noticesTransparentClick=!1,this.drawNew()},MouseSensorMorph.prototype.touch=function(){var t=this;this.isTouched||(this.isTouched=!0,this.alpha=.6,this.step=function(){t.isTouched?t.alpha<1&&(t.alpha=t.alpha+t.upStep):t.alpha>t.downStep?t.alpha=t.alpha-t.downStep:(t.alpha=0,t.step=null),t.changed()})},MouseSensorMorph.prototype.unTouch=function(){this.isTouched=!1},MouseSensorMorph.prototype.mouseEnter=function(){this.touch()},MouseSensorMorph.prototype.mouseLeave=function(){this.unTouch()},MouseSensorMorph.prototype.mouseDownLeft=function(){this.touch()},MouseSensorMorph.prototype.mouseClickLeft=function(){this.unTouch()};var ListMorph,TriggerMorph;InspectorMorph.prototype=new BoxMorph,InspectorMorph.prototype.constructor=InspectorMorph,InspectorMorph.uber=BoxMorph.prototype,InspectorMorph.prototype.init=function(t){this.target=t,this.currentProperty=null,this.showing="attributes",this.markOwnProperties=!1,this.hasUserEditedDetails=!1,InspectorMorph.uber.init.call(this),this.silentSetExtent(new Point(20*MorphicPreferences.handleSize,20*MorphicPreferences.handleSize*2/3)),this.isDraggable=!0,this.border=1,this.edge=MorphicPreferences.isFlat?1:5,this.color=new Color(60,60,60),this.borderColor=new Color(95,95,95),this.fps=25,this.drawNew(),this.label=null,this.list=null,this.detail=null,this.work=null,this.buttonInspect=null,this.buttonClose=null,this.buttonSubset=null,this.buttonEdit=null,this.resizer=null,this.target&&this.buildPanes()},InspectorMorph.prototype.setTarget=function(t){this.target=t,this.currentProperty=null,this.buildPanes()},InspectorMorph.prototype.updateCurrentSelection=function(){var t,e,o,i=this.list.selected,r=this.detail.contents.children[0],n=this.root();n&&n.keyboardReceiver instanceof CursorMorph&&n.keyboardReceiver.target===r?this.hasUserEditedDetails=!0:isNil(i)||this.hasUserEditedDetails||(t=this.target[i],this.currentProperty=t,e=isNil(t)?"NULL":isString(t)?t:t.toString(),r.text!==e&&((o=new TextMorph(e)).isEditable=!0,o.enableSelecting(),o.setReceiver(this.target),this.detail.setContents(o)))},InspectorMorph.prototype.buildPanes=function(){var t,e,o,i,r=[],n=this;this.children.forEach(function(t){t!==this.work&&t.destroy()}),this.children=[],this.label=new TextMorph(this.target.toString()),this.label.fontSize=MorphicPreferences.menuFontSize,this.label.isBold=!0,this.label.color=new Color(255,255,255),this.label.drawNew(),this.add(this.label);for(t in this.target)t&&r.push(t);"attributes"===this.showing?r=r.filter(function(t){return"function"!=typeof n.target[t]}):"methods"===this.showing&&(r=r.filter(function(t){return"function"==typeof n.target[t]})),i=function(){var t,e;isObject(n.currentProperty)&&(t=n.world(),(e=new InspectorMorph(n.currentProperty)).setPosition(t.hand.position()),e.keepWithin(t),t.add(e),e.changed())},this.list=new ListMorph(this.target instanceof Array?r:r.sort(),null,this.markOwnProperties?[[new Color(0,0,180),function(t){return Object.prototype.hasOwnProperty.call(n.target,t)}]]:null,i),this.list.action=function(){n.hasUserEditedDetails=!1,n.updateCurrentSelection()},this.list.hBar.alpha=.6,this.list.vBar.alpha=.6,this.list.contents.step=null,this.add(this.list),this.detail=new ScrollFrameMorph,this.detail.acceptsDrops=!1,this.detail.contents.acceptsDrops=!1,this.detail.isTextLineWrapping=!0,this.detail.color=new Color(255,255,255),this.detail.hBar.alpha=.6,this.detail.vBar.alpha=.6,(e=new TextMorph("")).isEditable=!0,e.enableSelecting(),e.setReceiver(this.target),this.detail.setContents(e),this.add(this.detail),null===this.work&&(this.work=new ScrollFrameMorph,this.work.acceptsDrops=!1,this.work.contents.acceptsDrops=!1,this.work.isTextLineWrapping=!0,this.work.color=new Color(255,255,255),this.work.hBar.alpha=.6,this.work.vBar.alpha=.6,(o=new TextMorph("")).isEditable=!0,o.enableSelecting(),o.setReceiver(this.target),this.work.setContents(o)),this.add(this.work),this.buttonSubset=new TriggerMorph,this.buttonSubset.labelString="show...",this.buttonSubset.action=function(){var t;(t=new MenuMorph).addItem("attributes",function(){n.showing="attributes",n.buildPanes()}),t.addItem("methods",function(){n.showing="methods",n.buildPanes()}),t.addItem("all",function(){n.showing="all",n.buildPanes()}),t.addLine(),t.addItem(n.markOwnProperties?"un-mark own":"mark own",function(){n.markOwnProperties=!n.markOwnProperties,n.buildPanes()},"highlight\n'own' properties"),t.popUpAtHand(n.world())},this.add(this.buttonSubset),this.buttonInspect=new TriggerMorph,this.buttonInspect.labelString="inspect...",this.buttonInspect.action=function(){var t,e,o;isObject(n.currentProperty)?((t=new MenuMorph).addItem("in new inspector...",function(){e=n.world(),(o=new InspectorMorph(n.currentProperty)).setPosition(e.hand.position()),o.keepWithin(e),e.add(o),o.changed()}),t.addItem("here...",function(){n.setTarget(n.currentProperty)}),t.popUpAtHand(n.world())):n.inform((null===n.currentProperty?"null":typeof n.currentProperty)+"\nis not inspectable")},this.add(this.buttonInspect),this.buttonEdit=new TriggerMorph,this.buttonEdit.labelString="edit...",this.buttonEdit.action=function(){var t;(t=new MenuMorph(n)).addItem("save","save","accept changes"),t.addLine(),t.addItem("add property...","addProperty"),t.addItem("rename...","renameProperty"),t.addItem("remove...","removeProperty"),t.popUpAtHand(n.world())},this.add(this.buttonEdit),this.buttonClose=new TriggerMorph,this.buttonClose.labelString="close",this.buttonClose.action=function(){n.destroy()},this.add(this.buttonClose),this.resizer=new HandleMorph(this,150,100,this.edge,this.edge),this.fixLayout()},InspectorMorph.prototype.fixLayout=function(){var t,e,o,i;Morph.prototype.trackChanges=!1,t=this.left()+this.edge,e=this.top()+this.edge,o=this.right()-this.edge-t,this.label.setPosition(new Point(t,e)),this.label.setWidth(o),this.label.height()>this.height()-50&&(this.silentSetHeight(this.label.height()+50),this.drawNew(),this.changed(),this.resizer.drawNew()),e=this.label.bottom()+2,o=Math.min(Math.floor(this.width()/3),this.list.listContents.width()),o-=this.edge,i=this.bottom()-2*this.edge-MorphicPreferences.handleSize-e,this.list.setPosition(new Point(t,e)),this.list.setExtent(new Point(o,i)),t=this.list.right()+this.edge,o=this.right()-this.edge-t,this.detail.setPosition(new Point(t,e)),this.detail.setExtent(new Point(o,2*i/3-this.edge)),e=this.detail.bottom()+this.edge,this.work.setPosition(new Point(t,e)),this.work.setExtent(new Point(o,i/3)),t=this.list.left(),e=this.list.bottom()+this.edge,o=this.list.width(),i=MorphicPreferences.handleSize,this.buttonSubset.setPosition(new Point(t,e)),this.buttonSubset.setExtent(new Point(o,i)),t=this.detail.left(),o=(o=this.detail.width()-this.edge-MorphicPreferences.handleSize)/3-this.edge/3,this.buttonInspect.setPosition(new Point(t,e)),this.buttonInspect.setExtent(new Point(o,i)),t=this.buttonInspect.right()+this.edge,this.buttonEdit.setPosition(new Point(t,e)),this.buttonEdit.setExtent(new Point(o,i)),t=this.buttonEdit.right()+this.edge,o=this.detail.right()-this.edge-MorphicPreferences.handleSize-t,this.buttonClose.setPosition(new Point(t,e)),this.buttonClose.setExtent(new Point(o,i)),Morph.prototype.trackChanges=!0,this.changed()},InspectorMorph.prototype.setExtent=function(t){InspectorMorph.uber.setExtent.call(this,t),this.fixLayout()},InspectorMorph.prototype.save=function(){var t=this.detail.contents.children[0].text.toString(),e=this.list.selected;try{this.target.evaluateString("this."+e+" = "+t),this.hasUserEditedDetails=!1,this.target.drawNew&&(this.target.changed(),this.target.drawNew(),this.target.changed())}catch(t){this.inform(t)}},InspectorMorph.prototype.addProperty=function(){var t=this;this.prompt("new property name:",function(e){e&&(t.target[e]=null,t.buildPanes(),t.target.drawNew&&(t.target.changed(),t.target.drawNew(),t.target.changed()))},this,"property")},InspectorMorph.prototype.renameProperty=function(){var t=this,e=this.list.selected;this.prompt("property name:",function(o){try{delete t.target[e],t.target[o]=t.currentProperty}catch(e){t.inform(e)}t.buildPanes(),t.target.drawNew&&(t.target.changed(),t.target.drawNew(),t.target.changed())},this,e)},InspectorMorph.prototype.removeProperty=function(){var t=this.list.selected;try{delete this.target[t],this.currentProperty=null,this.buildPanes(),this.target.drawNew&&(this.target.changed(),this.target.drawNew(),this.target.changed())}catch(t){this.inform(t)}},InspectorMorph.prototype.step=function(){this.updateCurrentSelection();var t=this.target.toString();this.label.text!==t&&(this.label.text=t,this.label.drawNew(),this.fixLayout())},InspectorMorph.prototype.updateReferences=function(t){var e=this.list.activeIndex();InspectorMorph.uber.updateReferences.call(this,t),this.buildPanes(),this.list.activateIndex(e)};var MenuItemMorph;MenuMorph.prototype=new BoxMorph,MenuMorph.prototype.constructor=MenuMorph,MenuMorph.uber=BoxMorph.prototype,MenuMorph.prototype.init=function(t,e,o,i){this.target=t,this.title=e||null,this.environment=o||null,this.fontSize=i||null,this.items=[],this.label=null,this.world=null,this.isListContents=!1,this.hasFocus=!1,this.selection=null,this.submenu=null,MenuMorph.uber.init.call(this),this.isDraggable=!1,this.border=null,this.edge=null},MenuMorph.prototype.addItem=function(t,e,o,i,r,n,s,a){this.items.push([localize(t||"close"),e||nop,o,i,r||!1,n||!1,s,a])},MenuMorph.prototype.addMenu=function(t,e,o){this.addPair(t,e,isNil(o)?"►":o)},MenuMorph.prototype.addPair=function(t,e,o,i){this.addItem(t,e,i,null,null,null,null,o)},MenuMorph.prototype.addLine=function(t){this.items.push([0,t||1])},MenuMorph.prototype.createLabel=function(){var t;null!==this.label&&this.label.destroy(),(t=new TextMorph(localize(this.title),this.fontSize||MorphicPreferences.menuFontSize,MorphicPreferences.menuFontName,!0,!1,"center")).alignment="center",t.color=new Color(255,255,255),t.backgroundColor=this.borderColor,t.drawNew(),this.label=new BoxMorph(3,0),MorphicPreferences.isFlat&&(this.label.edge=0),this.label.color=this.borderColor,this.label.borderColor=this.borderColor,this.label.setExtent(t.extent().add(4)),this.label.drawNew(),this.label.add(t),this.label.text=t},MenuMorph.prototype.drawNew=function(){var t,e,o,i,r=this,n=!1;this.children.forEach(function(t){t.destroy()}),this.children=[],this.isListContents||(this.edge=MorphicPreferences.isFlat?0:5,this.border=MorphicPreferences.isFlat?1:2),this.color=new Color(255,255,255),this.borderColor=new Color(60,60,60),this.silentSetExtent(new Point(0,0)),i=2,o=this.left()+4,this.isListContents||(this.title?(this.createLabel(),this.label.setPosition(this.bounds.origin.add(4)),this.add(this.label),i=this.label.bottom()):i=this.top()+4),i+=1,this.items.forEach(function(e){n=!1,e instanceof StringFieldMorph||e instanceof ColorPickerMorph||e instanceof SliderMorph?t=e:0===e[0]?(n=!0,(t=new Morph).color=r.borderColor,t.setHeight(e[1])):t=new MenuItemMorph(r.target,e[1],e[0],r.fontSize||MorphicPreferences.menuFontSize,MorphicPreferences.menuFontName,r.environment,e[2],e[3],e[4],e[5],e[6],e[7]),n&&(i+=1),t.setPosition(new Point(o,i)),r.add(t),i+=t.height(),n&&(i+=1)}),e=this.fullBounds(),this.silentSetExtent(e.extent().add(4)),this.adjustWidths(),MenuMorph.uber.drawNew.call(this)},MenuMorph.prototype.maxWidth=function(){var t=0;return this.parent instanceof FrameMorph&&this.parent.scrollFrame instanceof ScrollFrameMorph&&(t=this.parent.scrollFrame.width()),this.children.forEach(function(e){e instanceof MenuItemMorph?t=Math.max(t,e.label.width()+8+(e.shortcut?e.shortcut.width()+4:0)):(e instanceof StringFieldMorph||e instanceof ColorPickerMorph||e instanceof SliderMorph)&&(t=Math.max(t,e.width()))}),this.label&&(t=Math.max(t,this.label.width())),t},MenuMorph.prototype.adjustWidths=function(){var t,e=this.maxWidth(),o=this;this.children.forEach(function(i){i.silentSetWidth(e),i instanceof MenuItemMorph?(i.fixLayout(),t=i.image===i.pressImage,i.createBackgrounds(),t&&(i.image=i.pressImage)):(i.drawNew(),i===o.label&&i.text.setPosition(i.center().subtract(i.text.extent().floorDivideBy(2))))})},MenuMorph.prototype.unselectAllItems=function(){this.children.forEach(function(t){t instanceof MenuItemMorph&&(t.image=t.normalImage)}),this.changed()},MenuMorph.prototype.popup=function(t,e){this.drawNew(),this.setPosition(e),this.addShadow(new Point(2,2),80),this.keepWithin(t),t.activeMenu&&t.activeMenu.destroy(),this.items.length<1&&!this.title||(t.add(this),t.activeMenu=this,this.world=t,this.fullChanged())},MenuMorph.prototype.popUpAtHand=function(t){var e=t||this.world;this.popup(e,e.hand.position())},MenuMorph.prototype.popUpCenteredAtHand=function(t){var e=t||this.world;this.drawNew(),this.popup(e,e.hand.position().subtract(this.extent().floorDivideBy(2)))},MenuMorph.prototype.popUpCenteredInWorld=function(t){var e=t||this.world;this.drawNew(),this.popup(e,e.center().subtract(this.extent().floorDivideBy(2)))},MenuMorph.prototype.closeRootMenu=function(){this.parent instanceof MenuMorph?this.parent.closeRootMenu():this.destroy()},MenuMorph.prototype.closeSubmenu=function(){this.submenu&&(this.submenu.destroy(),this.submenu=null,this.unselectAllItems())},MenuMorph.prototype.getFocus=function(){this.world.keyboardReceiver=this,this.selection=null,this.selectFirst(),this.hasFocus=!0},MenuMorph.prototype.processKeyDown=function(t){switch(t.keyCode){case 13:case 32:return void(this.selection&&(this.selection.mouseClickLeft(),this.submenu&&this.submenu.getFocus()));case 27:return this.destroy();case 37:return this.leaveSubmenu();case 38:return this.selectUp();case 39:return this.enterSubmenu();case 40:return this.selectDown();default:nop()}},MenuMorph.prototype.processKeyUp=function(t){nop(t)},MenuMorph.prototype.processKeyPress=function(t){nop(t)},MenuMorph.prototype.selectFirst=function(){var t;for(t=0;t<this.children.length;t+=1)if(this.children[t]instanceof MenuItemMorph)return void this.select(this.children[t])},MenuMorph.prototype.selectUp=function(){var t,e;t=this.children.filter(function(t){return t instanceof MenuItemMorph}),this.selection?((e=t.indexOf(this.selection)-1)<0&&(e=t.length-1),this.select(t[e])):t.length&&this.select(t[0])},MenuMorph.prototype.selectDown=function(){var t,e;t=this.children.filter(function(t){return t instanceof MenuItemMorph}),this.selection?((e=t.indexOf(this.selection)+1)>=t.length&&(e=0),this.select(t[e])):t.length&&this.select(t[0])},MenuMorph.prototype.enterSubmenu=function(){this.selection&&this.selection.action instanceof MenuMorph&&(this.selection.popUpSubmenu(),this.submenu&&this.submenu.getFocus())},MenuMorph.prototype.leaveSubmenu=function(){var t=this.parent;this.parent instanceof MenuMorph&&(t.submenu=null,t.hasFocus=!0,this.destroy(),t.world.keyboardReceiver=t)},MenuMorph.prototype.select=function(t){this.unselectAllItems(),t.image=t.highlightImage,t.changed(),this.selection=t},MenuMorph.prototype.destroy=function(){this.hasFocus&&(this.world.keyboardReceiver=null),MenuMorph.uber.destroy.call(this)},StringMorph.prototype=new Morph,StringMorph.prototype.constructor=StringMorph,StringMorph.uber=Morph.prototype,StringMorph.prototype.init=function(t,e,o,i,r,n,s,a,h,l){this.text=t||(""===t?"":"StringMorph"),this.fontSize=e||12,this.fontName=l||MorphicPreferences.globalFontFamily,this.fontStyle=o||"sans-serif",this.isBold=i||!1,this.isItalic=r||!1,this.isEditable=!1,this.isNumeric=n||!1,this.isPassword=!1,this.shadowOffset=s||new Point(0,0),this.shadowColor=a||null,this.isShowingBlanks=!1,this.blanksColor=new Color(180,140,140),this.isScrollable=!0,this.currentlySelecting=!1,this.startMark=0,this.endMark=0,this.markedTextColor=new Color(255,255,255),this.markedBackgoundColor=new Color(60,60,120),StringMorph.uber.init.call(this,!0),this.color=h||new Color(0,0,0),this.noticesTransparentClick=!0,this.drawNew()},StringMorph.prototype.toString=function(){return"a "+(this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])+'("'+this.text.slice(0,30)+'...")'},StringMorph.prototype.password=function(t,e){var o,i="";for(o=0;o<e;o+=1)i+=t;return i},StringMorph.prototype.font=function(){var t="";return this.isBold&&(t+="bold "),this.isItalic&&(t+="italic "),t+this.fontSize+"px "+(this.fontName?this.fontName+", ":"")+this.fontStyle},StringMorph.prototype.drawNew=function(){var t,e,o,i,r,n,s,a,h,l=this.shadowOffset||new Point,p=this.isPassword?this.password("*",this.text.length):this.text;for(this.image=newCanvas(),(t=this.image.getContext("2d")).font=this.font(),e=Math.max(t.measureText(p).width+Math.abs(l.x),1),this.bounds.corner=this.bounds.origin.add(new Point(e,fontHeight(this.fontSize)+Math.abs(l.y))),this.image.width=e,this.image.height=this.height(),t.font=this.font(),t.textAlign="left",t.textBaseline="bottom",this.shadowColor&&(a=Math.max(l.x,0),h=Math.max(l.y,0),t.fillStyle=this.shadowColor.toString(),t.fillText(p,a,fontHeight(this.fontSize)+h)),a=Math.abs(Math.min(l.x,0)),h=Math.abs(Math.min(l.y,0)),t.fillStyle=this.color.toString(),this.isShowingBlanks?this.renderWithBlanks(t,a,fontHeight(this.fontSize)+h):t.fillText(p,a,fontHeight(this.fontSize)+h),o=Math.min(this.startMark,this.endMark),i=Math.max(this.startMark,this.endMark),r=o;r<i;r+=1)n=this.slotPosition(r).subtract(this.position()),s=p.charAt(r),t.fillStyle=this.markedBackgoundColor.toString(),t.fillRect(n.x,n.y,t.measureText(s).width+1+a,fontHeight(this.fontSize)+h),t.fillStyle=this.markedTextColor.toString(),t.fillText(s,n.x+a,fontHeight(this.fontSize)+h);this.parent&&this.parent.fixLayout&&this.parent.fixLayout()},StringMorph.prototype.renderWithBlanks=function(t,e,o){function i(){t.drawImage(n,h,0),h+=r}var r=t.measureText(" ").width,n=newCanvas(new Point(r,this.height())),s=n.getContext("2d"),a=this.text.split(" "),h=e||0,l=!0;s.fillStyle=this.blanksColor.toString(),s.arc(r/2,n.height/2,r/2,radians(0),radians(360)),s.fill(),a.forEach(function(e){l||i(),l=!1,""!==e&&(t.fillText(e,h,o),h+=t.measureText(e).width)})},StringMorph.prototype.slotPosition=function(t){var e,o,i,r,n=this.isPassword?this.password("*",this.text.length):this.text,s=Math.min(Math.max(t,0),n.length),a=this.image.getContext("2d");for(e=0,r=0;r<s;r+=1)e+=a.measureText(n[r]).width;return this.pos=s,o=this.left()+e,i=this.top(),new Point(o,i)},StringMorph.prototype.slotAt=function(t){for(var e=this.isPassword?this.password("*",this.text.length):this.text,o=0,i=0,r=this.image.getContext("2d");t.x-this.left()>i;)if(i+=r.measureText(e[o]).width,(o+=1)===e.length&&r.measureText(e).width-r.measureText(e[o-1]).width/2<t.x-this.left())return o;return t.x-this.left()>i-r.measureText(e[o-1]).width/2?o:o-1},StringMorph.prototype.upFrom=function(t){return t},StringMorph.prototype.downFrom=function(t){return t},StringMorph.prototype.startOfLine=function(){return 0},StringMorph.prototype.endOfLine=function(){return this.text.length},StringMorph.prototype.previousWordFrom=function(t){for(var e=t-1;e>0&&!isWordChar(this.text[e]);)e-=1;for(;e>0&&isWordChar(this.text[e-1]);)e-=1;return e},StringMorph.prototype.nextWordFrom=function(t){for(var e=t;e<this.endOfLine()&&!isWordChar(this.text[e]);)e+=1;for(;e<this.endOfLine()&&isWordChar(this.text[e]);)e+=1;return e},StringMorph.prototype.rawHeight=function(){return this.height()/1.2},StringMorph.prototype.developersMenu=function(){var t=StringMorph.uber.developersMenu.call(this);return t.addLine(),t.addItem("edit","edit"),t.addItem("font size...",function(){this.prompt(t.title+"\nfont\nsize:",this.setFontSize,this,this.fontSize.toString(),null,6,500,!0)},"set this String's\nfont point size"),"serif"!==this.fontStyle&&t.addItem("serif","setSerif"),"sans-serif"!==this.fontStyle&&t.addItem("sans-serif","setSansSerif"),this.isBold?t.addItem("normal weight","toggleWeight"):t.addItem("bold","toggleWeight"),this.isItalic?t.addItem("normal style","toggleItalic"):t.addItem("italic","toggleItalic"),this.isShowingBlanks?t.addItem("hide blanks","toggleShowBlanks"):t.addItem("show blanks","toggleShowBlanks"),this.isPassword?t.addItem("show characters","toggleIsPassword"):t.addItem("hide characters","toggleIsPassword"),t},StringMorph.prototype.toggleIsDraggable=function(){this.isDraggable=!this.isDraggable,this.isDraggable?this.disableSelecting():this.enableSelecting()},StringMorph.prototype.toggleShowBlanks=function(){this.isShowingBlanks=!this.isShowingBlanks,this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.toggleWeight=function(){this.isBold=!this.isBold,this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.toggleItalic=function(){this.isItalic=!this.isItalic,this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.toggleIsPassword=function(){this.isPassword=!this.isPassword,this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.setSerif=function(){this.fontStyle="serif",this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.setSansSerif=function(){this.fontStyle="sans-serif",this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.setFontSize=function(t){var e;"number"==typeof t?this.fontSize=Math.round(Math.min(Math.max(t,4),500)):(e=parseFloat(t),isNaN(e)||(this.fontSize=Math.round(Math.min(Math.max(e,4),500)))),this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.setText=function(t){this.text=Math.round(t).toString(),this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.numericalSetters=function(){return["setLeft","setTop","setAlphaScaled","setFontSize","setText"]},StringMorph.prototype.edit=function(){this.root().edit(this)},StringMorph.prototype.selection=function(){var t,e;return t=Math.min(this.startMark,this.endMark),e=Math.max(this.startMark,this.endMark),this.text.slice(t,e)},StringMorph.prototype.selectionStartSlot=function(){return Math.min(this.startMark,this.endMark)},StringMorph.prototype.clearSelection=function(){!this.currentlySelecting&&isNil(this.startMark)&&isNil(this.endMark)||(this.currentlySelecting=!1,this.startMark=null,this.endMark=null,this.drawNew(),this.changed())},StringMorph.prototype.deleteSelection=function(){var t,e,o;o=this.text,t=Math.min(this.startMark,this.endMark),e=Math.max(this.startMark,this.endMark),this.text=o.slice(0,t)+o.slice(e),this.changed(),this.clearSelection()},StringMorph.prototype.selectAll=function(){var t;this.isEditable&&(this.startMark=0,(t=this.root().cursor)&&t.gotoSlot(this.text.length),this.endMark=this.text.length,this.drawNew(),this.changed())},StringMorph.prototype.mouseDownLeft=function(t){16===this.world().currentKey?this.shiftClick(t):this.isEditable?this.clearSelection():this.escalateEvent("mouseDownLeft",t)},StringMorph.prototype.shiftClick=function(t){var e=this.root().cursor;e&&(this.startMark||(this.startMark=e.slot),e.gotoPos(t),this.endMark=e.slot,this.drawNew(),this.changed()),this.currentlySelecting=!1,this.escalateEvent("mouseDownLeft",t)},StringMorph.prototype.mouseClickLeft=function(t){var e;this.isEditable?(this.currentlySelecting||this.edit(),(e=this.root().cursor)&&e.gotoPos(t),this.currentlySelecting=!0):this.escalateEvent("mouseClickLeft",t)},StringMorph.prototype.mouseDoubleClick=function(t){var e=this.slotAt(t);this.isEditable?(this.edit(),e===this.text.length&&(e-=1),this.text[e]&&isWordChar(this.text[e])?this.selectWordAt(e):this.text[e]?this.selectBetweenWordsAt(e):this.selectAll()):this.escalateEvent("mouseDoubleClick",t)},StringMorph.prototype.selectWordAt=function(t){var e=this.root().cursor;0===t||isWordChar(this.text[t-1])?(e.gotoSlot(this.previousWordFrom(t)),this.startMark=e.slot,this.endMark=this.nextWordFrom(e.slot)):(e.gotoSlot(t),this.startMark=t,this.endMark=this.nextWordFrom(t)),this.drawNew(),this.changed()},StringMorph.prototype.selectBetweenWordsAt=function(t){var e=this.root().cursor;for(e.gotoSlot(this.nextWordFrom(this.previousWordFrom(t))),this.startMark=e.slot,this.endMark=e.slot;this.endMark<this.text.length&&!isWordChar(this.text[this.endMark]);)this.endMark+=1;this.drawNew(),this.changed()},StringMorph.prototype.enableSelecting=function(){this.mouseDownLeft=function(t){var e=this.root().cursor,o=!!e&&e.target===this;16===this.world().currentKey?this.shiftClick(t):(this.clearSelection(),this.isEditable&&!this.isDraggable&&(this.edit(),this.root().cursor.gotoPos(t),this.startMark=this.slotAt(t),this.endMark=this.startMark,this.currentlySelecting=!0,o||this.escalateEvent("mouseDownLeft",t)))},this.mouseMove=function(t){if(this.isEditable&&this.currentlySelecting&&!this.isDraggable){var e=this.slotAt(t);e!==this.endMark&&(this.endMark=e,this.drawNew(),this.changed())}}},StringMorph.prototype.disableSelecting=function(){this.mouseDownLeft=StringMorph.prototype.mouseDownLeft,delete this.mouseMove},TextMorph.prototype=new Morph,TextMorph.prototype.constructor=TextMorph,TextMorph.uber=Morph.prototype,TextMorph.prototype.init=function(t,e,o,i,r,n,s,a,h,l){this.text=t||(""===t?t:"TextMorph"),this.words=[],this.lines=[],this.lineSlots=[],this.fontSize=e||12,this.fontName=a||MorphicPreferences.globalFontFamily,this.fontStyle=o||"sans-serif",this.isBold=i||!1,this.isItalic=r||!1,this.alignment=n||"left",this.shadowOffset=h||new Point(0,0),this.shadowColor=l||null,this.maxWidth=s||0,this.maxLineWidth=0,this.backgroundColor=null,this.isEditable=!1,this.receiver=null,this.isScrollable=!0,this.currentlySelecting=!1,this.startMark=0,this.endMark=0,this.markedTextColor=new Color(255,255,255),this.markedBackgoundColor=new Color(60,60,120),TextMorph.uber.init.call(this),this.color=new Color(0,0,0),this.noticesTransparentClick=!0,this.drawNew()},TextMorph.prototype.toString=function(){return'a TextMorph("'+this.text.slice(0,30)+'...")'},TextMorph.prototype.font=StringMorph.prototype.font,TextMorph.prototype.parse=function(){var t,e,o=this,i=this.text.split("\n"),r=newCanvas().getContext("2d"),n="",s=0;r.font=this.font(),this.maxLineWidth=0,this.lines=[],this.lineSlots=[0],this.words=[],i.forEach(function(t){o.words=o.words.concat(t.split(" ")),o.words.push("\n")}),this.words.forEach(function(i){"\n"===i?(o.lines.push(n),o.lineSlots.push(s),o.maxLineWidth=Math.max(o.maxLineWidth,r.measureText(n).width),n=""):(o.maxWidth>0?(t=n+i+" ",(e=r.measureText(t).width)>o.maxWidth?(o.lines.push(n),o.lineSlots.push(s),o.maxLineWidth=Math.max(o.maxLineWidth,r.measureText(n).width),n=i+" "):n=t):n=n+i+" ",s+=i.length+1)})},TextMorph.prototype.drawNew=function(){var t,e,o,i,r,n,s,a,h,l,p,c,d,u,g;if(this.image=newCanvas(),t=this.image.getContext("2d"),t.font=this.font(),this.parse(),s=Math.abs(this.shadowOffset.x),n=Math.abs(this.shadowOffset.y),e=this.lines.length*(fontHeight(this.fontSize)+n),0===this.maxWidth?this.bounds=this.bounds.origin.extent(new Point(this.maxLineWidth+s,e)):this.bounds=this.bounds.origin.extent(new Point(this.maxWidth+s,e)),this.image.width=this.width(),this.image.height=this.height(),t=this.image.getContext("2d"),t.font=this.font(),t.textAlign="left",t.textBaseline="bottom",this.backgroundColor&&(t.fillStyle=this.backgroundColor.toString(),t.fillRect(0,0,this.width(),this.height())),this.shadowColor)for(a=Math.max(this.shadowOffset.x,0),h=Math.max(this.shadowOffset.y,0),t.fillStyle=this.shadowColor.toString(),o=0;o<this.lines.length;o+=1)i=this.lines[o],r=t.measureText(i).width+s,l="right"===this.alignment?this.width()-r:"center"===this.alignment?(this.width()-r)/2:0,p=(o+1)*(fontHeight(this.fontSize)+n)-n,t.fillText(i,l+a,p+h);for(a=Math.abs(Math.min(this.shadowOffset.x,0)),h=Math.abs(Math.min(this.shadowOffset.y,0)),t.fillStyle=this.color.toString(),o=0;o<this.lines.length;o+=1)i=this.lines[o],r=t.measureText(i).width+s,l="right"===this.alignment?this.width()-r:"center"===this.alignment?(this.width()-r)/2:0,p=(o+1)*(fontHeight(this.fontSize)+n)-n,t.fillText(i,l+a,p+h);for(c=Math.min(this.startMark,this.endMark),d=Math.max(this.startMark,this.endMark),o=c;o<d;o+=1)u=this.slotPosition(o).subtract(this.position()),g=this.text.charAt(o),t.fillStyle=this.markedBackgoundColor.toString(),t.fillRect(u.x,u.y,t.measureText(g).width+1,fontHeight(this.fontSize)),t.fillStyle=this.markedTextColor.toString(),t.fillText(g,u.x,u.y+fontHeight(this.fontSize));this.parent&&this.parent.layoutChanged&&this.parent.layoutChanged()},TextMorph.prototype.setExtent=function(t){this.maxWidth=Math.max(t.x,0),this.changed(),this.drawNew()},TextMorph.prototype.columnRow=function(t){var e,o,i=0;for(e=0;e<this.lines.length;e+=1)for(i=this.lineSlots[e],o=0;o<this.lines[e].length;o+=1){if(i===t)return new Point(o,e);i+=1}return new Point(this.lines[this.lines.length-1].length-1,this.lines.length-1)},TextMorph.prototype.slotPosition=function(t){var e,o,i,r,n=this.columnRow(t),s=this.image.getContext("2d"),a=Math.abs(this.shadowOffset.y),h=0;for(e=n.y*(fontHeight(this.fontSize)+a),r=0;r<n.x;r+=1)h+=s.measureText(this.lines[n.y][r]).width;return o=this.left()+h,i=this.top()+e,new Point(o,i)},TextMorph.prototype.slotAt=function(t){for(var e=0,o=0,i=0,r=Math.abs(this.shadowOffset.y),n=this.image.getContext("2d");t.y-this.top()>(fontHeight(this.fontSize)+r)*o;)o+=1;for(o=Math.max(o,1);t.x-this.left()>e;)e+=n.measureText(this.lines[o-1][i]).width,i+=1;return t.x-this.left()>e-n.measureText(this.lines[o-1][i]).width/2?this.lineSlots[Math.max(o-1,0)]+i:this.lineSlots[Math.max(o-1,0)]+i-1},TextMorph.prototype.upFrom=function(t){var e,o=this.columnRow(t);return o.y<1?t:(e=this.lines[o.y-1],e.length<o.x-1?this.lineSlots[o.y-1]+e.length:this.lineSlots[o.y-1]+o.x)},TextMorph.prototype.downFrom=function(t){var e,o=this.columnRow(t);return o.y>this.lines.length-2?t:(e=this.lines[o.y+1],e.length<o.x-1?this.lineSlots[o.y+1]+e.length:this.lineSlots[o.y+1]+o.x)},TextMorph.prototype.startOfLine=function(t){return this.lineSlots[this.columnRow(t).y]},TextMorph.prototype.endOfLine=function(t){return this.startOfLine(t)+this.lines[this.columnRow(t).y].length-1},TextMorph.prototype.previousWordFrom=StringMorph.prototype.previousWordFrom,TextMorph.prototype.nextWordFrom=StringMorph.prototype.nextWordFrom,TextMorph.prototype.edit=StringMorph.prototype.edit,TextMorph.prototype.selection=StringMorph.prototype.selection,TextMorph.prototype.selectionStartSlot=StringMorph.prototype.selectionStartSlot,TextMorph.prototype.clearSelection=StringMorph.prototype.clearSelection,TextMorph.prototype.deleteSelection=StringMorph.prototype.deleteSelection,TextMorph.prototype.selectAll=StringMorph.prototype.selectAll,TextMorph.prototype.mouseDownLeft=StringMorph.prototype.mouseDownLeft,TextMorph.prototype.shiftClick=StringMorph.prototype.shiftClick,TextMorph.prototype.mouseClickLeft=StringMorph.prototype.mouseClickLeft,TextMorph.prototype.mouseDoubleClick=StringMorph.prototype.mouseDoubleClick,TextMorph.prototype.selectWordAt=StringMorph.prototype.selectWordAt,TextMorph.prototype.selectBetweenWordsAt=StringMorph.prototype.selectBetweenWordsAt,TextMorph.prototype.enableSelecting=StringMorph.prototype.enableSelecting,TextMorph.prototype.disableSelecting=StringMorph.prototype.disableSelecting,TextMorph.prototype.selectAllAndEdit=function(){this.edit(),this.selectAll()},TextMorph.prototype.developersMenu=function(){var t=TextMorph.uber.developersMenu.call(this);return t.addLine(),t.addItem("edit","edit"),t.addItem("font size...",function(){this.prompt(t.title+"\nfont\nsize:",this.setFontSize,this,this.fontSize.toString(),null,6,100,!0)},"set this Text's\nfont point size"),"left"!==this.alignment&&t.addItem("align left","setAlignmentToLeft"),"right"!==this.alignment&&t.addItem("align right","setAlignmentToRight"),"center"!==this.alignment&&t.addItem("align center","setAlignmentToCenter"),t.addLine(),"serif"!==this.fontStyle&&t.addItem("serif","setSerif"),"sans-serif"!==this.fontStyle&&t.addItem("sans-serif","setSansSerif"),this.isBold?t.addItem("normal weight","toggleWeight"):t.addItem("bold","toggleWeight"),this.isItalic?t.addItem("normal style","toggleItalic"):t.addItem("italic","toggleItalic"),t},TextMorph.prototype.setAlignmentToLeft=function(){this.alignment="left",this.drawNew(),this.changed()},TextMorph.prototype.setAlignmentToRight=function(){this.alignment="right",this.drawNew(),this.changed()},TextMorph.prototype.setAlignmentToCenter=function(){this.alignment="center",this.drawNew(),this.changed()},TextMorph.prototype.toggleIsDraggable=StringMorph.prototype.toggleIsDraggable,TextMorph.prototype.toggleWeight=StringMorph.prototype.toggleWeight,TextMorph.prototype.toggleItalic=StringMorph.prototype.toggleItalic,TextMorph.prototype.setSerif=StringMorph.prototype.setSerif,TextMorph.prototype.setSansSerif=StringMorph.prototype.setSansSerif,TextMorph.prototype.setText=StringMorph.prototype.setText,TextMorph.prototype.setFontSize=StringMorph.prototype.setFontSize,TextMorph.prototype.numericalSetters=StringMorph.prototype.numericalSetters,TextMorph.prototype.evaluationMenu=function(){var t=new MenuMorph(this,null);return t.addItem("do it","doIt","evaluate the\nselected expression"),t.addItem("show it","showIt","evaluate the\nselected expression\nand show the result"),t.addItem("inspect it","inspectIt","evaluate the\nselected expression\nand inspect the result"),t.addLine(),t.addItem("select all","selectAllAndEdit"),t},TextMorph.prototype.setReceiver=function(t){this.receiver=t,this.customContextMenu=this.evaluationMenu()},TextMorph.prototype.doIt=function(){this.receiver.evaluateString(this.selection()),this.edit()},TextMorph.prototype.showIt=function(){var t=this.receiver.evaluateString(this.selection());null!==t&&this.inform(t)},TextMorph.prototype.inspectIt=function(){var t,e=this.receiver.evaluateString(this.selection()),o=this.world();isObject(e)&&((t=new InspectorMorph(e)).setPosition(o.hand.position()),t.keepWithin(o),o.add(t),t.changed())},TriggerMorph.prototype=new Morph,TriggerMorph.prototype.constructor=TriggerMorph,TriggerMorph.uber=Morph.prototype,TriggerMorph.prototype.init=function(t,e,o,i,r,n,s,a,h,l,p){this.target=t||null,this.action=e||null,this.doubleClickAction=p||null,this.environment=n||null,this.labelString=o||null,this.label=null,this.hint=s||null,this.schedule=null,this.fontSize=i||MorphicPreferences.menuFontSize,this.fontStyle=r||"sans-serif",this.highlightColor=new Color(192,192,192),this.pressColor=new Color(128,128,128),this.labelColor=a||new Color(0,0,0),this.labelBold=h||!1,this.labelItalic=l||!1,TriggerMorph.uber.init.call(this),this.color=new Color(255,255,255),this.drawNew()},TriggerMorph.prototype.drawNew=function(){this.createBackgrounds(),null!==this.labelString&&this.createLabel()},TriggerMorph.prototype.createBackgrounds=function(){var t,e=this.extent();this.normalImage=newCanvas(e),(t=this.normalImage.getContext("2d")).fillStyle=this.color.toString(),t.fillRect(0,0,e.x,e.y),this.highlightImage=newCanvas(e),(t=this.highlightImage.getContext("2d")).fillStyle=this.highlightColor.toString(),t.fillRect(0,0,e.x,e.y),this.pressImage=newCanvas(e),(t=this.pressImage.getContext("2d")).fillStyle=this.pressColor.toString(),t.fillRect(0,0,e.x,e.y),this.image=this.normalImage},TriggerMorph.prototype.createLabel=function(){null!==this.label&&this.label.destroy(),this.label=new StringMorph(this.labelString,this.fontSize,this.fontStyle,this.labelBold,this.labelItalic,!1,null,null,this.labelColor),this.label.setPosition(this.center().subtract(this.label.extent().floorDivideBy(2))),this.add(this.label)},TriggerMorph.prototype.trigger=function(){this.schedule&&(this.schedule.isActive=!1),"function"==typeof this.target?"function"==typeof this.action?this.target.call(this.environment,this.action.call(),this):this.target.call(this.environment,this.action,this):"function"==typeof this.action?this.action.call(this.target):this.target[this.action]()},TriggerMorph.prototype.triggerDoubleClick=function(){this.doubleClickAction&&(this.schedule&&(this.schedule.isActive=!1),"function"==typeof this.target?"function"==typeof this.doubleClickAction?this.target.call(this.environment,this.doubleClickAction.call(),this):this.target.call(this.environment,this.doubleClickAction,this):"function"==typeof this.doubleClickAction?this.doubleClickAction.call(this.target):this.target[this.doubleClickAction]())},TriggerMorph.prototype.mouseEnter=function(){var t=this.hint instanceof Function?this.hint():this.hint;this.image=this.highlightImage,this.changed(),t&&this.bubbleHelp(t)},TriggerMorph.prototype.mouseLeave=function(){this.image=this.normalImage,this.changed(),this.schedule&&(this.schedule.isActive=!1),this.hint&&this.world().hand.destroyTemporaries()},TriggerMorph.prototype.mouseDownLeft=function(){this.image=this.pressImage,this.changed()},TriggerMorph.prototype.mouseClickLeft=function(){this.image=this.highlightImage,this.changed(),this.trigger()},TriggerMorph.prototype.mouseDoubleClick=function(){this.triggerDoubleClick()},TriggerMorph.prototype.rootForGrab=function(){return this.isDraggable?TriggerMorph.uber.rootForGrab.call(this):null},TriggerMorph.prototype.bubbleHelp=function(t){var e=this.world(),o=this;this.schedule=new Animation(nop,nop,0,500,nop,function(){o.popUpbubbleHelp(t)}),e.animations.push(this.schedule)},TriggerMorph.prototype.popUpbubbleHelp=function(t){new SpeechBubbleMorph(localize(t),null,null,1).popUp(this.world(),this.rightCenter().add(new Point(-8,0)))};var MenuItemMorph;MenuItemMorph.prototype=new TriggerMorph,MenuItemMorph.prototype.constructor=MenuItemMorph,MenuItemMorph.uber=TriggerMorph.prototype,MenuItemMorph.prototype.createLabel=function(){var t,e;this.label&&this.label.destroy(),this.label=this.createLabelPart(this.labelString),this.add(this.label),t=this.label.width(),e=this.label.height(),this.shortcut&&this.shortcut.destroy(),this.shortcutString&&(this.shortcut=this.createLabelPart(this.shortcutString),t+=this.shortcut.width()+4,e=Math.max(e,this.shortcut.height()),this.add(this.shortcut)),this.silentSetExtent(new Point(t+8,e)),this.fixLayout()},MenuItemMorph.prototype.fixLayout=function(){var t=this.center();this.label.setCenter(t),this.label.setLeft(this.left()+4),this.shortcut&&(this.shortcut.setCenter(t),this.shortcut.setRight(this.right()-4))},MenuItemMorph.prototype.createLabelPart=function(t){var e,o,i;return isString(t)?this.createLabelString(t):t instanceof Array?(e=new Morph,e.alpha=0,o=this.createIcon(t[0]),e.add(o),i=this.createLabelString(t[1]),e.add(i),i.setCenter(o.center()),i.setLeft(o.right()+4),e.bounds=o.bounds.merge(i.bounds),e.drawNew(),e):this.createIcon(t)},MenuItemMorph.prototype.createIcon=function(t){var e,o=new Morph;return o.image=t instanceof Morph?t.fullImage():t,t instanceof Morph&&t.getShadow()&&(e=o.image,o.image=newCanvas(t.fullBounds().extent().subtract(this.shadowBlur*(useBlurredShadows?1:2))),o.image.getContext("2d").drawImage(e,0,0)),o.silentSetWidth(o.image.width),o.silentSetHeight(o.image.height),o},MenuItemMorph.prototype.createLabelString=function(t){var e=new TextMorph(t,this.fontSize,this.fontStyle,this.labelBold,this.labelItalic);return e.setColor(this.labelColor),e},MenuItemMorph.prototype.mouseEnter=function(){var t=this.parentThatIsA(MenuMorph);this.isShowingSubmenu()||(t&&t.closeSubmenu(),this.isListItem()||(this.image=this.highlightImage,this.changed()),this.action instanceof MenuMorph?this.delaySubmenu():this.hint&&this.bubbleHelp(this.hint))},MenuItemMorph.prototype.mouseLeave=function(){this.isListItem()||(this.isShowingSubmenu()?this.image=this.highlightImage:this.image=this.normalImage,this.changed()),this.schedule&&(this.schedule.isActive=!1),this.hint&&this.world().hand.destroyTemporaries()},MenuItemMorph.prototype.mouseDownLeft=function(t){this.isListItem()&&(this.parent.unselectAllItems(),this.escalateEvent("mouseDownLeft",t)),this.image=this.pressImage,this.changed()},MenuItemMorph.prototype.mouseMove=function(){this.isListItem()&&this.escalateEvent("mouseMove")},MenuItemMorph.prototype.mouseClickLeft=function(){this.action instanceof MenuMorph?this.popUpSubmenu():(this.isListItem()||(this.parent.closeRootMenu(),this.world().activeMenu=null),this.trigger())},MenuItemMorph.prototype.isListItem=function(){return!!this.parent&&this.parent.isListContents},MenuItemMorph.prototype.isSelectedListItem=function(){return!!this.isListItem()&&this.image===this.pressImage},MenuItemMorph.prototype.isShowingSubmenu=function(){var t=this.parentThatIsA(MenuMorph);return!!(t&&this.action instanceof MenuMorph)&&t.submenu===this.action},MenuItemMorph.prototype.delaySubmenu=function(){var t=this.world(),e=this;this.schedule=new Animation(nop,nop,0,500,nop,function(){e.popUpSubmenu()}),t.animations.push(this.schedule)},MenuItemMorph.prototype.popUpSubmenu=function(){var t=this.parentThatIsA(MenuMorph);this.action instanceof MenuMorph&&(this.action.drawNew(),this.action.setPosition(this.topRight().subtract(new Point(0,5))),this.action.addShadow(new Point(2,2),80),this.action.keepWithin(this.world()),this.action.items.length<1&&!this.action.title||(t.add(this.action),t.submenu=this.action,t.submenu.world=t.world,this.action.fullChanged()))},FrameMorph.prototype=new Morph,FrameMorph.prototype.constructor=FrameMorph,FrameMorph.uber=Morph.prototype,FrameMorph.prototype.init=function(t){this.scrollFrame=t||null,FrameMorph.uber.init.call(this),this.color=new Color(255,250,245),this.drawNew(),this.acceptsDrops=!0,this.scrollFrame&&(this.isDraggable=!1,this.noticesTransparentClick=!1,this.alpha=0)},FrameMorph.prototype.fullBounds=function(){var t=this.getShadow();return null!==t?this.bounds.merge(t.bounds):this.bounds},FrameMorph.prototype.fullImage=function(){return this.image},FrameMorph.prototype.fullDrawOn=function(t,e){var o,i;return this.isVisible?(o=e||this.fullBounds(),(i=this.bounds.intersect(o)).extent().gt(new Point(0,0))?(this.drawOn(t,i),void this.children.forEach(function(e){e instanceof ShadowMorph?e.fullDrawOn(t,o):e.fullDrawOn(t,i)})):null):null},FrameMorph.prototype.topMorphAt=function(t){var e,o;if(!this.isVisible||!this.bounds.containsPoint(t))return null;for(e=this.children.length-1;e>=0;e-=1)if(o=this.children[e].topMorphAt(t))return o;return this.noticesTransparentClick||!this.isTransparentAt(t)?this:null},FrameMorph.prototype.submorphBounds=function(){var t=null;return this.children.length>0&&(t=this.children[0].bounds,this.children.forEach(function(e){t=t.merge(e.fullBounds())})),t},FrameMorph.prototype.keepInScrollFrame=function(){if(null===this.scrollFrame)return null;this.left()>this.scrollFrame.left()&&this.moveBy(new Point(this.scrollFrame.left()-this.left(),0)),this.right()<this.scrollFrame.right()&&this.moveBy(new Point(this.scrollFrame.right()-this.right(),0)),this.top()>this.scrollFrame.top()&&this.moveBy(new Point(0,this.scrollFrame.top()-this.top())),this.bottom()<this.scrollFrame.bottom()&&this.moveBy(0,new Point(this.scrollFrame.bottom()-this.bottom(),0))},FrameMorph.prototype.adjustBounds=function(){var t,e,o=this;if(null===this.scrollFrame)return null;e=(t=this.submorphBounds())&&!this.scrollFrame.isTextLineWrapping?t.expandBy(this.scrollFrame.padding).growBy(this.scrollFrame.growth).merge(this.scrollFrame.bounds):this.scrollFrame.bounds.copy(),this.bounds.eq(e)||(this.bounds=e,this.drawNew(),this.keepInScrollFrame()),this.scrollFrame.isTextLineWrapping&&this.children.forEach(function(t){t instanceof TextMorph&&(t.setWidth(o.width()),o.setHeight(Math.max(t.height(),o.scrollFrame.height())))}),this.scrollFrame.adjustScrollBars()},FrameMorph.prototype.reactToDropOf=function(){this.adjustBounds()},FrameMorph.prototype.reactToGrabOf=function(){this.adjustBounds()},FrameMorph.prototype.developersMenu=function(){var t=FrameMorph.uber.developersMenu.call(this);return this.children.length>0&&(t.addLine(),t.addItem("move all inside...","keepAllSubmorphsWithin","keep all submorphs\nwithin and visible")),t},FrameMorph.prototype.keepAllSubmorphsWithin=function(){var t=this;this.children.forEach(function(e){e.keepWithin(t)})},ScrollFrameMorph.prototype=new FrameMorph,ScrollFrameMorph.prototype.constructor=ScrollFrameMorph,ScrollFrameMorph.uber=FrameMorph.prototype,ScrollFrameMorph.prototype.init=function(t,e,o){var i=this;ScrollFrameMorph.uber.init.call(this),this.scrollBarSize=e||MorphicPreferences.scrollBarSize,this.autoScrollTrigger=null,this.enableAutoScrolling=!0,this.isScrollingByDragging=!0,this.hasVelocity=!0,this.padding=0,this.growth=0,this.isTextLineWrapping=!1,this.contents=t||new FrameMorph(this),this.add(this.contents),this.hBar=new SliderMorph(null,null,null,null,"horizontal",o),this.hBar.setHeight(this.scrollBarSize),this.hBar.action=function(t){i.contents.setPosition(new Point(i.left()-t,i.contents.position().y))},this.hBar.isDraggable=!1,this.add(this.hBar),this.vBar=new SliderMorph(null,null,null,null,"vertical",o),this.vBar.setWidth(this.scrollBarSize),this.vBar.action=function(t){i.contents.setPosition(new Point(i.contents.position().x,i.top()-t))},this.vBar.isDraggable=!1,this.add(this.vBar),this.toolBar=null},ScrollFrameMorph.prototype.adjustScrollBars=function(){var t=this.width()-this.scrollBarSize,e=this.height()-this.scrollBarSize;this.changed(),this.contents.width()>this.width()+MorphicPreferences.scrollBarSize?(this.hBar.show(),this.hBar.width()!==t&&this.hBar.setWidth(t),this.hBar.setPosition(new Point(this.left(),this.bottom()-this.hBar.height())),this.hBar.start=0,this.hBar.stop=this.contents.width()-this.width(),this.hBar.size=this.width()/this.contents.width()*this.hBar.stop,this.hBar.value=this.left()-this.contents.left(),this.hBar.drawNew()):this.hBar.hide(),this.contents.height()>this.height()+this.scrollBarSize?(this.vBar.show(),this.vBar.height()!==e&&this.vBar.setHeight(e),this.vBar.setPosition(new Point(this.right()-this.vBar.width(),this.top())),this.vBar.start=0,this.vBar.stop=this.contents.height()-this.height(),this.vBar.size=this.height()/this.contents.height()*this.vBar.stop,this.vBar.value=this.top()-this.contents.top(),this.vBar.drawNew()):this.vBar.hide(),this.adjustToolBar()},ScrollFrameMorph.prototype.adjustToolBar=function(){this.toolBar&&(this.toolBar.setTop(this.top()+3),this.toolBar.setRight((this.vBar.isVisible?this.vBar.left():this.right())-3))},ScrollFrameMorph.prototype.addContents=function(t){this.contents.add(t),this.contents.adjustBounds()},ScrollFrameMorph.prototype.setContents=function(t){this.contents.children.forEach(function(t){t.destroy()}),this.contents.children=[],t.setPosition(this.position().add(this.padding+2)),this.addContents(t)},ScrollFrameMorph.prototype.setExtent=function(t){this.isTextLineWrapping&&this.contents.setPosition(this.position().copy()),ScrollFrameMorph.uber.setExtent.call(this,t),this.contents.adjustBounds()},ScrollFrameMorph.prototype.scrollX=function(t){var e,o=this.contents.left(),i=this.left(),r=this.contents.width(),n=this.right();(e=o+t)+r<n&&(e=n-r),e>i&&(e=i),e!==o&&this.contents.setLeft(e)},ScrollFrameMorph.prototype.scrollY=function(t){var e,o=this.contents.top(),i=this.top(),r=this.contents.height(),n=this.bottom();(e=o+t)+r<n&&(e=n-r),e>i&&(e=i),e!==o&&this.contents.setTop(e)},ScrollFrameMorph.prototype.step=nop,ScrollFrameMorph.prototype.mouseDownLeft=function(t){if(!this.isScrollingByDragging)return null;var e=this.root().hand,o=t,i=this,r=0,n=0;this.step=function(){var t;if(e.mouseButton&&0===e.children.length&&i.bounds.containsPoint(e.bounds.origin)){if(e.grabPosition&&e.grabPosition.distanceTo(e.position())<=MorphicPreferences.grabThreshold)return null;t=e.bounds.origin,0!==(r=t.x-o.x)&&i.scrollX(r),0!==(n=t.y-o.y)&&i.scrollY(n),o=t}else i.hasVelocity?Math.abs(r)<.5&&Math.abs(n)<.5?i.step=function(){nop()}:(r*=.8,i.scrollX(Math.round(r)),n*=.8,i.scrollY(Math.round(n))):i.step=function(){nop()};this.adjustScrollBars()}},ScrollFrameMorph.prototype.startAutoScrolling=function(){var t,e,o,i=this,r=3*MorphicPreferences.scrollBarSize,n=this.world();if(!n)return null;t=n.hand,this.autoScrollTrigger||(this.autoScrollTrigger=Date.now()),this.step=function(){o=t.bounds.origin,e=i.bounds.insetBy(r),i.bounds.containsPoint(o)&&!e.containsPoint(o)&&t.children.length>0?i.autoScroll(o):(i.step=function(){nop()},i.autoScrollTrigger=null)}},ScrollFrameMorph.prototype.autoScroll=function(t){var e;if(Date.now()-this.autoScrollTrigger<500)return null;e=3*MorphicPreferences.scrollBarSize,this.topLeft().extent(new Point(this.width(),e)).containsPoint(t)&&this.scrollY(e-(t.y-this.top())),this.topLeft().extent(new Point(e,this.height())).containsPoint(t)&&this.scrollX(e-(t.x-this.left())),new Point(this.right()-e,this.top()).extent(new Point(e,this.height())).containsPoint(t)&&this.scrollX(-(e-(this.right()-t.x))),new Point(this.left(),this.bottom()-e).extent(new Point(this.width(),e)).containsPoint(t)&&this.scrollY(-(e-(this.bottom()-t.y))),this.adjustScrollBars()},ScrollFrameMorph.prototype.scrollCursorIntoView=function(t){var e=t.target,o=e.position().subtract(this.contents.position()),i=this.top()+this.padding,r=this.bottom()-this.padding;this.contents.setExtent(e.extent().add(o).add(this.padding)),t.top()<i?(this.contents.setTop(this.contents.top()+i-t.top()),t.setTop(i)):t.bottom()>r&&(this.contents.setBottom(this.contents.bottom()+r-t.bottom()),t.setBottom(r)),this.adjustScrollBars()},ScrollFrameMorph.prototype.mouseScroll=function(t,e){t&&this.scrollY(t*MorphicPreferences.mouseScrollAmount),e&&this.scrollX(e*MorphicPreferences.mouseScrollAmount),this.adjustScrollBars()},ScrollFrameMorph.prototype.updateReferences=function(t){var e=this;ScrollFrameMorph.uber.updateReferences.call(this,t),this.hBar&&(this.hBar.action=function(t){e.contents.setPosition(new Point(e.left()-t,e.contents.position().y))}),this.vBar&&(this.vBar.action=function(t){e.contents.setPosition(new Point(e.contents.position().x,e.top()-t))})},ScrollFrameMorph.prototype.developersMenu=function(){var t=ScrollFrameMorph.uber.developersMenu.call(this);return this.isTextLineWrapping?t.addItem("auto line wrap off...","toggleTextLineWrapping","turn automatic\nline wrapping\noff"):t.addItem("auto line wrap on...","toggleTextLineWrapping","enable automatic\nline wrapping"),t},ScrollFrameMorph.prototype.toggleTextLineWrapping=function(){this.isTextLineWrapping=!this.isTextLineWrapping},ListMorph.prototype=new ScrollFrameMorph,ListMorph.prototype.constructor=ListMorph,ListMorph.uber=ScrollFrameMorph.prototype,ListMorph.prototype.init=function(t,e,o,i){ListMorph.uber.init.call(this),this.contents.acceptsDrops=!1,this.color=new Color(255,255,255),this.hBar.alpha=.6,this.vBar.alpha=.6,this.elements=t||[],this.labelGetter=e,this.format=o,this.listContents=null,this.selected=null,this.active=null,this.action=null,this.doubleClickAction=i||null,this.acceptsDrops=!1,this.buildListContents()},ListMorph.prototype.buildListContents=function(){var t=this;this.listContents&&this.listContents.destroy(),this.listContents=new MenuMorph(this.select,null,this),0===this.elements.length&&(this.elements=["(empty)"]),this.elements.forEach(function(e){var o=null,i=!1,r=!1;t.format.forEach(function(t){t[1].call(null,e)&&("bold"===t[0]?i=!0:"italic"===t[0]?r=!0:o=t[0])}),t.listContents.addItem(t.labelGetter(e),e,null,o,i,r,t.doubleClickAction)}),this.listContents.isListContents=!0,this.listContents.drawNew(),this.listContents.setPosition(this.contents.position()),this.addContents(this.listContents)},ListMorph.prototype.select=function(t,e){isNil(t)||(this.selected=t,this.active=e,this.action&&this.action.call(null,t))},ListMorph.prototype.setExtent=function(t){var e=this.listContents.bounds,o=this.bounds.origin.copy().corner(this.bounds.origin.add(t));o.right()>e.right()&&o.width()<=e.width()&&this.listContents.setRight(o.right()),o.bottom()>e.bottom()&&o.height()<=e.height()&&this.listContents.setBottom(o.bottom()),ListMorph.uber.setExtent.call(this,t)},ListMorph.prototype.activeIndex=function(){return this.listContents.children.indexOf(this.active)},ListMorph.prototype.activateIndex=function(t){var e=this.listContents.children[t];e&&(e.image=e.pressImage,e.changed(),e.trigger())},StringFieldMorph.prototype=new FrameMorph,StringFieldMorph.prototype.constructor=StringFieldMorph,StringFieldMorph.uber=FrameMorph.prototype,StringFieldMorph.prototype.init=function(t,e,o,i,r,n,s){this.defaultContents=t,this.minWidth=e,this.fontSize=o,this.fontStyle=i,this.isBold=r,this.isItalic=n,this.isNumeric=s||!1,this.text=null,StringFieldMorph.uber.init.call(this),this.color=new Color(255,255,255),this.isEditable=!0,this.acceptsDrops=!1,this.drawNew()},StringFieldMorph.prototype.drawNew=function(){var t;t=this.text?this.string():this.defaultContents,this.text=null,this.children.forEach(function(t){t.destroy()}),this.children=[],this.text=new StringMorph(t,this.fontSize,this.fontStyle,this.isBold,this.isItalic,this.isNumeric),this.text.isNumeric=this.isNumeric,this.text.setPosition(this.bounds.origin.copy()),this.text.isEditable=this.isEditable,this.text.isDraggable=!1,this.text.enableSelecting(),this.silentSetExtent(new Point(Math.max(this.width(),this.minWidth),this.text.height())),StringFieldMorph.uber.drawNew.call(this),this.add(this.text)},StringFieldMorph.prototype.string=function(){return this.text.text},StringFieldMorph.prototype.mouseClickLeft=function(t){this.isEditable?this.text.edit():this.escalateEvent("mouseClickLeft",t)};var BouncerMorph;BouncerMorph.prototype=new Morph,BouncerMorph.prototype.constructor=BouncerMorph,BouncerMorph.uber=Morph.prototype,BouncerMorph.prototype.init=function(t,e){BouncerMorph.uber.init.call(this),this.fps=50,this.isStopped=!1,this.type=t||"vertical","vertical"===this.type?this.direction="down":this.direction="right",this.speed=e||1},BouncerMorph.prototype.moveUp=function(){this.moveBy(new Point(0,-this.speed))},BouncerMorph.prototype.moveDown=function(){this.moveBy(new Point(0,this.speed))},BouncerMorph.prototype.moveRight=function(){this.moveBy(new Point(this.speed,0))},BouncerMorph.prototype.moveLeft=function(){this.moveBy(new Point(-this.speed,0))},BouncerMorph.prototype.step=function(){this.isStopped||("vertical"===this.type?("down"===this.direction?this.moveDown():this.moveUp(),this.fullBounds().top()<this.parent.top()&&"up"===this.direction&&(this.direction="down"),this.fullBounds().bottom()>this.parent.bottom()&&"down"===this.direction&&(this.direction="up")):"horizontal"===this.type&&("right"===this.direction?this.moveRight():this.moveLeft(),this.fullBounds().left()<this.parent.left()&&"left"===this.direction&&(this.direction="right"),this.fullBounds().right()>this.parent.right()&&"right"===this.direction&&(this.direction="left")))},HandMorph.prototype=new Morph,HandMorph.prototype.constructor=HandMorph,HandMorph.uber=Morph.prototype,HandMorph.prototype.init=function(t){HandMorph.uber.init.call(this,!0),this.bounds=new Rectangle,this.world=t,this.mouseButton=null,this.mouseOverList=[],this.morphToGrab=null,this.grabPosition=null,this.grabOrigin=null,this.temporaries=[],this.touchHoldTimeout=null,this.contextMenuEnabled=!1},HandMorph.prototype.changed=function(){var t;null!==this.world&&((t=this.fullBounds()).extent().eq(new Point)||this.world.broken.push(t.spread()))},HandMorph.prototype.fullChanged=HandMorph.prototype.changed,HandMorph.prototype.morphAtPointer=function(){return this.world.topMorphAt(this.bounds.origin)||this.world},HandMorph.prototype.allMorphsAtPointer=function(){var t=this;return this.world.allChildren().filter(function(e){return e.isVisible&&e.visibleBounds().containsPoint(t.bounds.origin)})},HandMorph.prototype.dropTargetFor=function(t){for(var e=this.morphAtPointer();!e.wantsDropOf(t);)e=e.parent;return e},HandMorph.prototype.grab=function(t){var e=t.parent;if(t instanceof WorldMorph)return null;0===this.children.length&&(this.world.stopEditing(),this.grabOrigin=t.situation(),t.addShadow(),t.prepareToBeGrabbed&&t.prepareToBeGrabbed(this),t.cachedFullImage=t.fullImageClassic(),t.cachedFullBounds=t.fullBounds(),this.add(t),this.changed(),e&&e.reactToGrabOf&&e.reactToGrabOf(t))},HandMorph.prototype.drop=function(){var t,e;0!==this.children.length&&(e=this.children[0],t=(t=this.dropTargetFor(e)).selectForEdit?t.selectForEdit():t,this.changed(),t.add(e),e.cachedFullImage=null,e.cachedFullBounds=null,e.changed(),e.removeShadow(),this.children=[],this.setExtent(new Point),e.justDropped&&e.justDropped(this),t.reactToDropOf&&t.reactToDropOf(e,this))},HandMorph.prototype.processMouseDown=function(t){var e,o;if(this.destroyTemporaries(),this.contextMenuEnabled=!0,this.morphToGrab=null,this.grabPosition=null,0!==this.children.length)this.drop(),this.mouseButton=null;else{for(e=this.morphAtPointer(),this.world.activeMenu&&(contains(e.allParents(),this.world.activeMenu)?clearInterval(this.touchHoldTimeout):this.world.activeMenu.destroy()),this.world.activeHandle&&e!==this.world.activeHandle&&this.world.activeHandle.destroy(),this.world.cursor&&e!==this.world.cursor.target&&this.world.stopEditing(),e.mouseMove||(this.morphToGrab=e.rootForGrab(),this.grabPosition=this.bounds.origin.copy()),2===t.button||t.ctrlKey?(this.mouseButton="right",o="mouseDownRight"):(this.mouseButton="left",o="mouseDownLeft");!e[o];)e=e.parent;e[o](this.bounds.origin)}},HandMorph.prototype.processTouchStart=function(t){var e=this;MorphicPreferences.isTouchDevice=!0,clearInterval(this.touchHoldTimeout),1===t.touches.length&&(this.touchHoldTimeout=setInterval(function(){e.processMouseDown({button:2}),e.processMouseUp({button:2}),t.preventDefault(),clearInterval(e.touchHoldTimeout)},400),this.processMouseMove(t.touches[0]),this.processMouseDown({button:0}),t.preventDefault())},HandMorph.prototype.processTouchMove=function(t){if(MorphicPreferences.isTouchDevice=!0,1===t.touches.length){var e=t.touches[0];this.processMouseMove(e),clearInterval(this.touchHoldTimeout)}},HandMorph.prototype.processTouchEnd=function(t){MorphicPreferences.isTouchDevice=!0,clearInterval(this.touchHoldTimeout),nop(t),this.processMouseUp({button:0})},HandMorph.prototype.processMouseUp=function(){var t,e,o,i=this.morphAtPointer();if(this.destroyTemporaries(),0!==this.children.length)this.drop();else{if("left"===this.mouseButton)o="mouseClickLeft";else if(o="mouseClickRight",this.mouseButton&&this.contextMenuEnabled){for(e=(t=i).contextMenu();!e&&t.parent;)e=(t=t.parent).contextMenu();e&&e.popUpAtHand(this.world)}for(;!i[o];)i=i.parent;i[o](this.bounds.origin)}this.mouseButton=null},HandMorph.prototype.processDoubleClick=function(){var t=this.morphAtPointer();if(this.destroyTemporaries(),0!==this.children.length)this.drop();else{for(;t&&!t.mouseDoubleClick;)t=t.parent;t&&t.mouseDoubleClick(this.bounds.origin)}this.mouseButton=null},HandMorph.prototype.processMouseMove=function(t){var e,o,i,r,n=getDocumentPositionOf(this.world.worldCanvas),s=this;e=new Point(t.pageX-n.x,t.pageY-n.y),this.setPosition(e),o=this.morphAtPointer().allParents(),!this.children.length&&this.mouseButton&&(i=(r=this.morphAtPointer()).rootForGrab(),r.mouseMove&&(r.mouseMove(e,this.mouseButton),"right"===this.mouseButton&&(this.contextMenuEnabled=!1)),"left"===this.mouseButton&&this.morphToGrab&&this.grabPosition.distanceTo(this.bounds.origin)>MorphicPreferences.grabThreshold&&(this.setPosition(this.grabPosition),this.morphToGrab.isDraggable?(i=this.morphToGrab.selectForEdit?this.morphToGrab.selectForEdit():this.morphToGrab,this.grab(i)):this.morphToGrab.isTemplate&&((i=this.morphToGrab.fullCopy()).isTemplate=!1,i.isDraggable=!0,i.reactToTemplateCopy&&i.reactToTemplateCopy(),this.grab(i),this.grabOrigin=this.morphToGrab.situation()),this.setPosition(e))),this.mouseOverList.forEach(function(t){contains(o,t)||(t.mouseLeave&&t.mouseLeave(),t.mouseLeaveDragging&&s.mouseButton&&t.mouseLeaveDragging())}),o.forEach(function(t){contains(s.mouseOverList,t)||(t.mouseEnter&&t.mouseEnter(),t.mouseEnterDragging&&s.mouseButton&&t.mouseEnterDragging()),s.children.length>0&&t instanceof ScrollFrameMorph&&t.enableAutoScrolling&&t.contents.allChildren().some(function(t){return t.wantsDropOf(s.children[0])})&&(t.bounds.insetBy(3*MorphicPreferences.scrollBarSize).containsPoint(s.bounds.origin)||t.startAutoScrolling())}),this.mouseOverList=o},HandMorph.prototype.processMouseScroll=function(t){for(var e=this.morphAtPointer();e&&!e.mouseScroll;)e=e.parent;e&&e.mouseScroll(t.detail/-3||(Object.prototype.hasOwnProperty.call(t,"wheelDeltaY")?t.wheelDeltaY/120:t.wheelDelta/120),t.wheelDeltaX/120||0)},HandMorph.prototype.processDrop=function(t){var e,o,i,r,n,s=t instanceof FileList?t:t.target.files||t.dataTransfer.files,a=t.dataTransfer?t.dataTransfer.getData("URL"):null,h=t.dataTransfer?t.dataTransfer.getData("Text/HTML"):null,l=this.morphAtPointer(),p=new Image;if(s.length>0)for(n=0;n<s.length;n+=1)-1===(e=s[n]).type.indexOf("svg")||MorphicPreferences.rasterizeSVGs?0===e.type.indexOf("image")?function(t){for(var e=new Image,o=new FileReader;!l.droppedImage;)l=l.parent;e.onload=function(){(r=newCanvas(new Point(e.width,e.height),!0)).getContext("2d").drawImage(e,0,0),l.droppedImage(r,t.name)},(o=new FileReader).onloadend=function(t){e.src=t.target.result},o.readAsDataURL(t)}(e):0===e.type.indexOf("audio")?function(t){for(var e=new Audio,o=new FileReader;!l.droppedAudio;)l=l.parent;o.onloadend=function(o){e.src=o.target.result,l.droppedAudio(e,t.name)},o.readAsDataURL(t)}(e):0===e.type.indexOf("text")?function(t){for(var e=new FileReader;!l.droppedText;)l=l.parent;e.onloadend=function(e){l.droppedText(e.target.result,t.name)},e.readAsText(t)}(e):function(t){for(var e=new FileReader;!l.droppedBinary;)l=l.parent;e.onloadend=function(e){l.droppedBinary(e.target.result,t.name)},e.readAsArrayBuffer(t)}(e):function(t){for(var e=new Image,o=new FileReader;!l.droppedSVG;)l=l.parent;e.onload=function(){l.droppedSVG(e,t.name)},(o=new FileReader).onloadend=function(t){e.src=t.target.result},o.readAsDataURL(t)}(e);else if(a){if(o=a.slice(a.lastIndexOf(".")+1).toLowerCase(),contains(["gif","png","jpg","jpeg","bmp"],o)){for(;!l.droppedImage;)l=l.parent;(p=new Image).onload=function(){(r=newCanvas(new Point(p.width,p.height),!0)).getContext("2d").drawImage(p,0,0),l.droppedImage(r)},p.src=a}else if("svg"===o&&!MorphicPreferences.rasterizeSVGs){for(;!l.droppedSVG;)l=l.parent;!function(t,e){var o=new XMLHttpRequest;o.open("GET",t),o.onreadystatechange=function(){if(4===o.readyState){if(!o.responseText)throw new Error("unable to retrieve "+t);e(o.responseText)}},o.send()}(a,function(t){var e=new Image;e.onload=function(){l.droppedSVG(e,a.slice(a.lastIndexOf("/")+1,a.lastIndexOf(".")))},e.src="data:image/svg+xml;utf8,"+encodeURIComponent(t)})}}else if(h){for(;!l.droppedImage;)l=l.parent;(p=new Image).onload=function(){(r=newCanvas(new Point(p.width,p.height),!0)).getContext("2d").drawImage(p,0,0),l.droppedImage(r)},(i=function(t){var e,o,i="",r=t.indexOf('<img src="');if(-1===r)return null;for(e=r+=10;e<t.length;e+=1){if('"'===(o=t[e]))return i;i=i.concat(o)}return null}(h))&&(p.src=i)}},HandMorph.prototype.destroyTemporaries=function(){var t=this;this.temporaries.forEach(function(e){e.isClickable&&e.bounds.containsPoint(t.position())||(e.destroy(),t.temporaries.splice(t.temporaries.indexOf(e),1))})},WorldMorph.prototype=new FrameMorph,WorldMorph.prototype.constructor=WorldMorph,WorldMorph.uber=FrameMorph.prototype,WorldMorph.prototype.init=function(t,e){for(WorldMorph.uber.init.call(this),this.color=new Color(205,205,205),this.alpha=1,this.bounds=new Rectangle(0,0,t.width,t.height),this.drawNew(),this.isVisible=!0,this.isDraggable=!1,this.currentKey=null,this.worldCanvas=t,this.noticesTransparentClick=!0,this.stamp=Date.now();this.stamp===Date.now();)nop();this.stamp=Date.now(),this.useFillPage=e,void 0===this.useFillPage&&(this.useFillPage=!0),this.isDevMode=!1,this.broken=[],this.animations=[],this.hand=new HandMorph(this),this.keyboardReceiver=null,this.cursor=null,this.lastEditedText=null,this.activeMenu=null,this.activeHandle=null,this.virtualKeyboard=null,this.initEventListeners()},WorldMorph.prototype.brokenFor=function(t){var e=t.fullBounds();return this.broken.filter(function(t){return t.intersects(e)})},WorldMorph.prototype.fullDrawOn=function(t,e){WorldMorph.uber.fullDrawOn.call(this,t,e),this.hand.fullDrawOn(t,e)},WorldMorph.prototype.updateBroken=function(){var t=this;this.condenseDamages(),this.broken.forEach(function(e){e.extent().gt(new Point(0,0))&&t.fullDrawOn(t.worldCanvas,e)}),this.broken=[]},WorldMorph.prototype.stepAnimations=function(){this.animations.forEach(function(t){t.step()}),this.animations=this.animations.filter(function(t){return t.isActive})},WorldMorph.prototype.condenseDamages=function(){for(var t=!0,e=this.broken.length;t;)this.broken=function(t){var e,o=[];return t.forEach(function(t){(e=detect(o,function(e){return e.isNearTo(t,20)}))?e.mergeWith(t):o.push(t)}),o}(this.broken),t=this.broken.length<e,e=this.broken.length},WorldMorph.prototype.doOneCycle=function(){this.stepFrame(),this.stepAnimations(),this.updateBroken()},WorldMorph.prototype.fillPage=function(){var t=window.innerHeight,e=window.innerWidth,o=this;this.worldCanvas.style.position="absolute",this.worldCanvas.style.left="0px",this.worldCanvas.style.right="0px",this.worldCanvas.style.width="100%",this.worldCanvas.style.height="100%",document.documentElement.scrollTop&&(t=document.documentElement.clientHeight),document.documentElement.scrollLeft&&(e=document.documentElement.clientWidth),this.worldCanvas.width!==e&&(this.worldCanvas.width=e,this.setWidth(e)),this.worldCanvas.height!==t&&(this.worldCanvas.height=t,this.setHeight(t)),this.children.forEach(function(t){t.reactToWorldResize&&t.reactToWorldResize(o.bounds.copy())})},WorldMorph.prototype.getGlobalPixelColor=function(t){return this.hand.morphAtPointer().getPixelColor(this.hand.position())},WorldMorph.prototype.initVirtualKeyboard=function(){var t=this;this.virtualKeyboard&&(document.body.removeChild(this.virtualKeyboard),this.virtualKeyboard=null),MorphicPreferences.isTouchDevice&&MorphicPreferences.useVirtualKeyboard&&(this.virtualKeyboard=document.createElement("input"),this.virtualKeyboard.type="text",this.virtualKeyboard.style.color="transparent",this.virtualKeyboard.style.backgroundColor="transparent",this.virtualKeyboard.style.border="none",this.virtualKeyboard.style.outline="none",this.virtualKeyboard.style.position="absolute",this.virtualKeyboard.style.top="0px",this.virtualKeyboard.style.left="0px",this.virtualKeyboard.style.width="0px",this.virtualKeyboard.style.height="0px",this.virtualKeyboard.autocapitalize="none",document.body.appendChild(this.virtualKeyboard),this.virtualKeyboard.addEventListener("keydown",function(e){t.currentKey=e.keyCode,t.keyboardReceiver&&t.keyboardReceiver.processKeyDown(e),8===e.keyCode&&e.preventDefault(),9===e.keyCode&&(t.keyboardReceiver&&t.keyboardReceiver.processKeyPress(e),e.preventDefault())},!1),this.virtualKeyboard.addEventListener("keyup",function(e){t.currentKey=null,t.keyboardReceiver&&t.keyboardReceiver.processKeyUp&&t.keyboardReceiver.processKeyUp(e),e.preventDefault()},!1),this.virtualKeyboard.addEventListener("keypress",function(e){t.keyboardReceiver&&t.keyboardReceiver.processKeyPress(e),e.preventDefault()},!1))},WorldMorph.prototype.initEventListeners=function(){var t=this.worldCanvas,e=this;e.useFillPage?e.fillPage():this.changed(),t.addEventListener("mousedown",function(o){o.preventDefault(),t.focus(),e.hand.processMouseDown(o)},!1),t.addEventListener("touchstart",function(t){e.hand.processTouchStart(t)},!1),t.addEventListener("mouseup",function(t){t.preventDefault(),e.hand.processMouseUp(t)},!1),t.addEventListener("dblclick",function(t){t.preventDefault(),e.hand.processDoubleClick(t)},!1),t.addEventListener("touchend",function(t){e.hand.processTouchEnd(t)},!1),t.addEventListener("mousemove",function(t){e.hand.processMouseMove(t)},!1),t.addEventListener("touchmove",function(t){e.hand.processTouchMove(t)},!1),t.addEventListener("contextmenu",function(t){t.preventDefault()},!1),t.addEventListener("keydown",function(t){e.currentKey=t.keyCode,e.keyboardReceiver&&e.keyboardReceiver.processKeyDown(t),8===t.keyCode&&t.preventDefault(),9===t.keyCode&&(e.keyboardReceiver&&e.keyboardReceiver.processKeyPress(t),t.preventDefault()),(t.ctrlKey&&!t.altKey||t.metaKey)&&86!==t.keyCode&&t.preventDefault()},!1),t.addEventListener("keyup",function(t){e.currentKey=null,e.keyboardReceiver&&e.keyboardReceiver.processKeyUp&&e.keyboardReceiver.processKeyUp(t),t.preventDefault()},!1),t.addEventListener("keypress",function(t){e.keyboardReceiver&&e.keyboardReceiver.processKeyPress(t),t.preventDefault()},!1),t.addEventListener("mousewheel",function(t){e.hand.processMouseScroll(t),t.preventDefault()},!1),t.addEventListener("DOMMouseScroll",function(t){e.hand.processMouseScroll(t),t.preventDefault()},!1),document.body.addEventListener("paste",function(t){var o=t.clipboardData.getData("Text");o&&e.cursor&&e.cursor.insert(o)},!1),window.addEventListener("dragover",function(t){t.preventDefault()},!1),window.addEventListener("drop",function(t){e.hand.processDrop(t),t.preventDefault()},!1),window.addEventListener("resize",function(){e.useFillPage&&e.fillPage()},!1),window.onbeforeunload=function(t){var e=t||window.event,o="Are you sure you want to leave?";return e&&(e.returnValue=o),o}},WorldMorph.prototype.mouseDownLeft=nop,WorldMorph.prototype.mouseClickLeft=nop,WorldMorph.prototype.mouseDownRight=nop,WorldMorph.prototype.mouseClickRight=nop,WorldMorph.prototype.wantsDropOf=function(){return this.acceptsDrops},WorldMorph.prototype.droppedImage=function(){return null},WorldMorph.prototype.droppedSVG=function(){return null},WorldMorph.prototype.nextTab=function(t){var e=this.nextEntryField(t);e&&(t.clearSelection(),e.selectAll(),e.edit())},WorldMorph.prototype.previousTab=function(t){var e=this.previousEntryField(t);e&&(t.clearSelection(),e.selectAll(),e.edit())},WorldMorph.prototype.contextMenu=function(){var t;return t=this.isDevMode?new MenuMorph(this,this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0]):new MenuMorph(this,"Morphic"),this.isDevMode&&(t.addItem("demo...","userCreateMorph","sample morphs"),t.addLine(),t.addItem("hide all...","hideAll"),t.addItem("show all...","showAllHiddens"),t.addItem("move all inside...","keepAllSubmorphsWithin","keep all submorphs\nwithin and visible"),t.addItem("inspect...","inspect","open a window on\nall properties"),t.addItem("screenshot...",function(){window.open(this.fullImageClassic().toDataURL())},"open a new window\nwith a picture of this morph"),t.addLine(),t.addItem("restore display","changed","redraw the\nscreen once"),t.addItem("fill page...","fillPage","let the World automatically\nadjust to browser resizing"),useBlurredShadows?t.addItem("sharp shadows...","toggleBlurredShadows","sharp drop shadows\nuse for old browsers"):t.addItem("blurred shadows...","toggleBlurredShadows","blurry shades,\n use for new browsers"),t.addItem("color...",function(){this.pickColor(t.title+localize("\ncolor:"),this.setColor,this,this.color)},"choose the World's\nbackground color"),MorphicPreferences===standardSettings?t.addItem("touch screen settings","togglePreferences","bigger menu fonts\nand sliders"):t.addItem("standard settings","togglePreferences","smaller menu fonts\nand sliders"),t.addLine()),this.isDevMode?t.addItem("user mode...","toggleDevMode","disable developers'\ncontext menus"):t.addItem("development mode...","toggleDevMode"),t.addItem("about morphic.js...","about"),t},WorldMorph.prototype.userCreateMorph=function(){function t(t){t.isDraggable=!0,t.pickUp(i)}var e,o,i=this;(e=new MenuMorph(this,"make a morph")).addItem("rectangle",function(){t(new Morph)}),e.addItem("box",function(){t(new BoxMorph)}),e.addItem("circle box",function(){t(new CircleBoxMorph)}),e.addLine(),e.addItem("slider",function(){t(new SliderMorph)}),e.addItem("frame",function(){(o=new FrameMorph).setExtent(new Point(350,250)),t(o)}),e.addItem("scroll frame",function(){(o=new ScrollFrameMorph).contents.acceptsDrops=!0,o.contents.adjustBounds(),o.setExtent(new Point(350,250)),t(o)}),e.addItem("handle",function(){t(new HandleMorph)}),e.addLine(),e.addItem("string",function(){(o=new StringMorph("Hello, World!")).isEditable=!0,t(o)}),e.addItem("text",function(){(o=new TextMorph("Ich weiß nicht, was soll es bedeuten, dass ich so traurig bin, ein Märchen aus uralten Zeiten, das kommt mir nicht aus dem Sinn. Die Luft ist kühl und es dunkelt, und ruhig fließt der Rhein; der Gipfel des Berges funkelt im Abendsonnenschein. Die schönste Jungfrau sitzet dort oben wunderbar, ihr gold'nes Geschmeide blitzet, sie kämmt ihr goldenes Haar, sie kämmt es mit goldenem Kamme, und singt ein Lied dabei; das hat eine wundersame, gewalt'ge Melodei. Den Schiffer im kleinen Schiffe, ergreift es mit wildem Weh; er schaut nicht die Felsenriffe, er schaut nur hinauf in die Höh'. Ich glaube, die Wellen verschlingen am Ende Schiffer und Kahn, und das hat mit ihrem Singen, die Loreley getan.")).isEditable=!0,o.maxWidth=300,o.drawNew(),t(o)}),e.addItem("speech bubble",function(){t(o=new SpeechBubbleMorph("Hello, World!"))}),e.addLine(),e.addItem("gray scale palette",function(){t(new GrayPaletteMorph)}),e.addItem("color palette",function(){t(new ColorPaletteMorph)}),e.addItem("color picker",function(){t(new ColorPickerMorph)}),e.addLine(),e.addItem("sensor demo",function(){(o=new MouseSensorMorph).setColor(new Color(230,200,100)),o.edge=35,o.border=15,o.borderColor=new Color(200,100,50),o.alpha=.2,o.setExtent(new Point(100,100)),t(o)}),e.addItem("animation demo",function(){var e,o,i,r,n;(e=new BouncerMorph).setPosition(new Point(50,20)),e.setExtent(new Point(300,200)),e.alpha=.9,e.speed=3,(o=new BouncerMorph).setColor(new Color(50,50,50)),o.setPosition(new Point(80,80)),o.setExtent(new Point(80,250)),o.type="horizontal",o.direction="right",o.alpha=.9,o.speed=5,(i=new BouncerMorph).setColor(new Color(20,20,20)),i.setPosition(new Point(90,140)),i.setExtent(new Point(40,30)),i.type="horizontal",i.direction="right",i.speed=3,(r=new BouncerMorph).setColor(new Color(200,20,20)),r.setPosition(new Point(90,140)),r.setExtent(new Point(20,20)),r.type="vertical",r.direction="up",r.speed=8,(n=new BouncerMorph).setColor(new Color(20,200,20)),n.setPosition(new Point(120,140)),n.setExtent(new Point(20,20)),n.type="vertical",n.direction="down",n.speed=4,o.add(r),o.add(i),e.add(n),e.add(o),t(e)}),e.addItem("pen",function(){t(new PenMorph)}),i.customMorphs&&(e.addLine(),i.customMorphs().forEach(function(o){e.addItem(o.toString(),function(){t(o)})})),e.popUpAtHand(this)},WorldMorph.prototype.toggleDevMode=function(){this.isDevMode=!this.isDevMode},WorldMorph.prototype.hideAll=function(){this.children.forEach(function(t){t.hide()})},WorldMorph.prototype.showAllHiddens=function(){this.forAllChildren(function(t){t.isVisible||t.show()})},WorldMorph.prototype.about=function(){var t,e="";for(t in modules)Object.prototype.hasOwnProperty.call(modules,t)&&(e+="\n"+t+" ("+modules[t]+")");""!==e&&(e="\n\nmodules:\n\nmorphic ("+morphicVersion+")"+e),this.inform("morphic.js\n\na lively Web GUI\ninspired by Squeak\n"+morphicVersion+"\n\nwritten by Jens Mönig\njens@moenig.org"+e)},WorldMorph.prototype.edit=function(t){var e=getDocumentPositionOf(this.worldCanvas);if(!t.isEditable)return null;this.cursor&&this.cursor.destroy(),this.cursor=new CursorMorph(t),t.parent.add(this.cursor),this.keyboardReceiver=this.cursor,this.initVirtualKeyboard(),MorphicPreferences.isTouchDevice&&MorphicPreferences.useVirtualKeyboard&&(this.virtualKeyboard.style.top=this.cursor.top()+e.y+"px",this.virtualKeyboard.style.left=this.cursor.left()+e.x+"px",this.virtualKeyboard.focus()),MorphicPreferences.useSliderForInput&&(t.parentThatIsA(MenuMorph)||this.slide(t)),this.lastEditedText!==t&&t.escalateEvent("freshTextEdit",t),this.lastEditedText=t},WorldMorph.prototype.slide=function(t){var e,o,i=parseFloat(t.text);isNaN(i)&&(i=0),e=new MenuMorph,(o=new SliderMorph(i-25,i+25,i,10,"horizontal")).alpha=1,o.color=new Color(225,225,225),o.button.color=e.borderColor,o.button.highlightColor=o.button.color.copy(),o.button.highlightColor.b+=100,o.button.pressColor=o.button.color.copy(),o.button.pressColor.b+=150,o.silentSetHeight(MorphicPreferences.scrollBarSize),o.silentSetWidth(10*MorphicPreferences.menuFontSize),o.drawNew(),o.action=function(e){t.changed(),t.text=Math.round(e).toString(),t.drawNew(),t.changed(),t.escalateEvent("reactToSliderEdit",t)},e.items.push(o),e.popup(this,t.bottomLeft().add(new Point(0,5)))},WorldMorph.prototype.stopEditing=function(){this.cursor&&(this.cursor.target.escalateEvent("reactToEdit",this.cursor.target),this.cursor.target.clearSelection(),this.cursor.destroy(),this.cursor=null),this.keyboardReceiver&&this.keyboardReceiver.stopEditing&&this.keyboardReceiver.stopEditing(),this.keyboardReceiver=null,this.virtualKeyboard&&(this.virtualKeyboard.blur(),document.body.removeChild(this.virtualKeyboard),this.virtualKeyboard=null),this.lastEditedText=null,this.worldCanvas.focus()},WorldMorph.prototype.toggleBlurredShadows=function(){useBlurredShadows=!useBlurredShadows},WorldMorph.prototype.togglePreferences=function(){MorphicPreferences=MorphicPreferences===standardSettings?touchScreenSettings:standardSettings},modules.widgets="2017-September-25";var PushButtonMorph,ToggleButtonMorph,TabMorph,ToggleMorph,ToggleElementMorph,DialogBoxMorph,AlignmentMorph,InputFieldMorph,PianoMenuMorph,PianoKeyMorph;PushButtonMorph.prototype=new TriggerMorph,PushButtonMorph.prototype.constructor=PushButtonMorph,PushButtonMorph.uber=TriggerMorph.prototype,PushButtonMorph.prototype.fontSize=10,PushButtonMorph.prototype.fontStyle="sans-serif",PushButtonMorph.prototype.labelColor=new Color(0,0,0),PushButtonMorph.prototype.labelShadowColor=new Color(255,255,255),PushButtonMorph.prototype.labelShadowOffset=new Point(1,1),PushButtonMorph.prototype.color=new Color(220,220,220),PushButtonMorph.prototype.pressColor=new Color(115,180,240),PushButtonMorph.prototype.highlightColor=PushButtonMorph.prototype.pressColor.lighter(50),PushButtonMorph.prototype.outlineColor=new Color(30,30,30),PushButtonMorph.prototype.outlineGradient=!1,PushButtonMorph.prototype.contrast=60,PushButtonMorph.prototype.edge=2,PushButtonMorph.prototype.corner=5,PushButtonMorph.prototype.outline=1.00001,PushButtonMorph.prototype.padding=3,PushButtonMorph.prototype.init=function(t,e,o,i,r,n){this.is3D=!1,this.target=t||null,this.action=e||null,this.environment=i||null,this.labelString=o||null,this.label=null,this.labelMinExtent=new Point(0,0),this.hint=r||null,this.template=n||null,this.isDisabled=!1,TriggerMorph.uber.init.call(this),this.color=PushButtonMorph.prototype.color,this.drawNew(),this.fixLayout()},PushButtonMorph.prototype.fixLayout=function(){if(null!==this.label){var t=2*this.padding+2*this.outline+2*this.edge;this.setExtent(new Point(Math.max(this.label.width(),this.labelMinExtent.x)+t,Math.max(this.label instanceof StringMorph?this.label.rawHeight():this.label.height(),this.labelMinExtent.y)+t)),this.label.setCenter(this.center())}},PushButtonMorph.prototype.mouseDownLeft=function(){PushButtonMorph.uber.mouseDownLeft.call(this),this.label&&this.label.setCenter(this.center().add(1))},PushButtonMorph.prototype.mouseClickLeft=function(){this.isDisabled||(PushButtonMorph.uber.mouseClickLeft.call(this),this.label&&this.label.setCenter(this.center()))},PushButtonMorph.prototype.mouseLeave=function(){PushButtonMorph.uber.mouseLeave.call(this),this.label&&this.label.setCenter(this.center())},PushButtonMorph.prototype.outlinePath=BoxMorph.prototype.outlinePath,PushButtonMorph.prototype.drawOutline=function(t){var e,o=MorphicPreferences.isFlat&&!this.is3D;if(!this.outline||o)return null;this.outlineGradient?((e=t.createLinearGradient(0,0,0,this.height())).addColorStop(0,this.outlineColor.darker().toString()),e.addColorStop(1,"white")):e=this.outlineColor.toString(),t.fillStyle=e,t.beginPath(),this.outlinePath(t,o?0:this.corner,0),t.closePath(),t.fill()},PushButtonMorph.prototype.drawBackground=function(t,e){var o=MorphicPreferences.isFlat&&!this.is3D;t.fillStyle=e.toString(),t.beginPath(),this.outlinePath(t,o?0:Math.max(this.corner-this.outline,0),this.outline),t.closePath(),t.fill(),t.lineWidth=this.outline},PushButtonMorph.prototype.drawEdges=function(t,e,o,i){if(!MorphicPreferences.isFlat||this.is3D){var r,n=Math.max(this.corner,this.outline+this.edge),s=this.width(),a=this.height();(r=t.createLinearGradient(0,this.outline,0,this.outline+this.edge)).addColorStop(0,o.toString()),r.addColorStop(1,e.toString()),t.strokeStyle=r,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.moveTo(n,this.outline+this.edge/2),t.lineTo(s-n,this.outline+this.edge/2),t.stroke(),(r=t.createRadialGradient(this.corner,this.corner,Math.max(this.corner-this.outline-this.edge,0),this.corner,this.corner,Math.max(this.corner-this.outline,0))).addColorStop(0,e.toString()),r.addColorStop(1,o.toString()),t.strokeStyle=r,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.arc(this.corner,this.corner,Math.max(this.corner-this.outline-this.edge/2,0),radians(180),radians(270),!1),t.stroke(),(r=t.createLinearGradient(this.outline,0,this.outline+this.edge,0)).addColorStop(0,o.toString()),r.addColorStop(1,e.toString()),t.strokeStyle=r,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.moveTo(this.outline+this.edge/2,n),t.lineTo(this.outline+this.edge/2,a-n),t.stroke(),(r=t.createLinearGradient(0,a-this.outline,0,a-this.outline-this.edge)).addColorStop(0,i.toString()),r.addColorStop(1,e.toString()),t.strokeStyle=r,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.moveTo(n,a-this.outline-this.edge/2),t.lineTo(s-n,a-this.outline-this.edge/2),t.stroke(),(r=t.createRadialGradient(s-this.corner,a-this.corner,Math.max(this.corner-this.outline-this.edge,0),s-this.corner,a-this.corner,Math.max(this.corner-this.outline,0))).addColorStop(0,e.toString()),r.addColorStop(1,i.toString()),t.strokeStyle=r,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.arc(s-this.corner,a-this.corner,Math.max(this.corner-this.outline-this.edge/2,0),radians(0),radians(90),!1),t.stroke(),(r=t.createLinearGradient(s-this.outline,0,s-this.outline-this.edge,0)).addColorStop(0,i.toString()),r.addColorStop(1,e.toString()),t.strokeStyle=r,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.moveTo(s-this.outline-this.edge/2,n),t.lineTo(s-this.outline-this.edge/2,a-n),t.stroke()}},PushButtonMorph.prototype.createBackgrounds=function(){var t,e=this.extent();if(this.template)return this.image=this.template.image,this.normalImage=this.template.normalImage,this.highlightImage=this.template.highlightImage,this.pressImage=this.template.pressImage,null;this.normalImage=newCanvas(e),t=this.normalImage.getContext("2d"),this.drawOutline(t),this.drawBackground(t,this.color),this.drawEdges(t,this.color,this.color.lighter(this.contrast),this.color.darker(this.contrast)),this.highlightImage=newCanvas(e),t=this.highlightImage.getContext("2d"),this.drawOutline(t),this.drawBackground(t,this.highlightColor),this.drawEdges(t,this.highlightColor,this.highlightColor.lighter(this.contrast),this.highlightColor.darker(this.contrast)),this.pressImage=newCanvas(e),t=this.pressImage.getContext("2d"),this.drawOutline(t),this.drawBackground(t,this.pressColor),this.drawEdges(t,this.pressColor,this.pressColor.darker(this.contrast),this.pressColor.lighter(this.contrast)),this.image=this.normalImage},PushButtonMorph.prototype.createLabel=function(){var t=!MorphicPreferences.isFlat||this.is3D;null!==this.label&&this.label.destroy(),this.labelString instanceof SymbolMorph?(this.label=this.labelString.fullCopy(),t&&(this.label.shadowOffset=this.labelShadowOffset,this.label.shadowColor=this.labelShadowColor),this.label.color=this.labelColor,this.label.drawNew()):this.label=new StringMorph(localize(this.labelString),this.fontSize,this.fontStyle,!0,!1,!1,t?this.labelShadowOffset:null,this.labelShadowColor,this.labelColor),this.add(this.label)},PushButtonMorph.prototype.disable=function(){this.isDisabled=!0,this.forAllChildren(function(t){t.alpha=.3}),this.changed()},PushButtonMorph.prototype.enable=function(){this.isDisabled=!1,this.forAllChildren(function(t){t.alpha=1}),this.changed()},ToggleButtonMorph.prototype=new PushButtonMorph,ToggleButtonMorph.prototype.constructor=ToggleButtonMorph,ToggleButtonMorph.uber=PushButtonMorph.prototype,ToggleButtonMorph.prototype.contrast=30,ToggleButtonMorph.prototype.init=function(t,e,o,i,r,n,s,a,h,l,p){this.state=!1,this.query=r||function(){return!0},this.minWidth=h||null,this.hasPreview=l||!1,this.isPicture=p||!1,this.trueStateLabel=null,ToggleButtonMorph.uber.init.call(this,e,o,i,n,s,a),t&&(this.color=t[0],this.highlightColor=t[1],this.pressColor=t[2]),this.refresh(),this.drawNew()},ToggleButtonMorph.prototype.mouseEnter=function(){var t=this.hint instanceof Function?this.hint():this.hint;this.state||(this.image=this.highlightImage,this.changed()),t&&this.bubbleHelp(t)},ToggleButtonMorph.prototype.mouseLeave=function(){this.state||(this.image=this.normalImage,this.changed()),this.schedule&&(this.schedule.isActive=!1),this.hint&&this.world().hand.destroyTemporaries()},ToggleButtonMorph.prototype.mouseDownLeft=function(){this.state||(this.image=this.pressImage,this.changed())},ToggleButtonMorph.prototype.mouseClickLeft=function(){this.state||(this.image=this.highlightImage,this.changed()),this.trigger()},ToggleButtonMorph.prototype.trigger=function(){ToggleButtonMorph.uber.trigger.call(this),this.refresh()},ToggleButtonMorph.prototype.refresh=function(){"function"==typeof this.query?this.state=this.query.call(this.target):this.state=this.target[this.query](),this.state?(this.image=this.pressImage,this.trueStateLabel&&(this.label.hide(),this.trueStateLabel.show())):(this.image=this.normalImage,this.trueStateLabel&&(this.label.show(),this.trueStateLabel.hide())),this.changed()},ToggleButtonMorph.prototype.fixLayout=function(){if(null!==this.label){var t=Math.max(this.label.width(),this.labelMinExtent.x),e=2*this.padding+2*this.outline+2*this.edge;this.setExtent(new Point(this.minWidth?Math.max(this.minWidth,t)+e:t+e,Math.max(this.label instanceof StringMorph?this.label.rawHeight():this.label.height(),this.labelMinExtent.y)+e)),this.label.setCenter(this.center()),this.trueStateLabel&&this.trueStateLabel.setCenter(this.center()),this.minWidth&&this.label.setLeft(this.left()+this.outline+this.edge+this.corner+this.padding)}},ToggleButtonMorph.prototype.createBackgrounds=function(){var t,e=this.extent();if(this.template)return this.image=this.template.image,this.normalImage=this.template.normalImage,this.highlightImage=this.template.highlightImage,this.pressImage=this.template.pressImage,null;this.normalImage=newCanvas(e),t=this.normalImage.getContext("2d"),this.drawOutline(t),this.drawBackground(t,this.color),this.drawEdges(t,this.color,this.color.lighter(this.contrast),this.color.darker(this.contrast)),this.highlightImage=newCanvas(e),t=this.highlightImage.getContext("2d"),this.drawOutline(t),this.drawBackground(t,this.highlightColor),this.drawEdges(t,this.highlightColor,this.highlightColor.lighter(this.contrast),this.highlightColor.darker(this.contrast)),this.pressImage=newCanvas(e),t=this.pressImage.getContext("2d"),this.drawOutline(t),this.drawBackground(t,this.pressColor),this.drawEdges(t,this.pressColor,this.pressColor.lighter(40),this.pressColor.darker(40)),this.image=this.normalImage},ToggleButtonMorph.prototype.drawEdges=function(t,e,o,i){var r;if(ToggleButtonMorph.uber.drawEdges.call(this,t,e,o,i),this.hasPreview){if(MorphicPreferences.isFlat&&!this.is3D)return t.fillStyle=this.pressColor.toString(),void t.fillRect(this.outline,this.outline,this.corner,this.height()-2*this.outline);(r=t.createLinearGradient(0,0,this.corner,0)).addColorStop(0,this.pressColor.lighter(40).toString()),r.addColorStop(1,this.pressColor.darker(40).toString()),t.fillStyle=r,t.beginPath(),this.previewPath(t,Math.max(this.corner-this.outline,0),this.outline),t.closePath(),t.fill()}},ToggleButtonMorph.prototype.previewPath=function(t,e,o){var i=e+o,r=this.height();t.arc(i,i,e,radians(-180),radians(-90),!1),t.arc(i,r-i,e,radians(90),radians(180),!1)},ToggleButtonMorph.prototype.createLabel=function(){var t=!MorphicPreferences.isFlat||this.is3D,e=new Point;null!==this.label&&this.label.destroy(),null!==this.trueStateLabel&&this.trueStateLabel.destroy(),this.labelString instanceof Array&&2===this.labelString.length?this.labelString[0]instanceof SymbolMorph?(this.label=this.labelString[0].fullCopy(),this.trueStateLabel=this.labelString[1].fullCopy(),this.isPicture||(this.label.shadowOffset=t?this.labelShadowOffset:e,this.label.shadowColor=this.labelShadowColor,this.label.color=this.labelColor,this.label.drawNew(),this.trueStateLabel.shadowOffset=t?this.labelShadowOffset:e,this.trueStateLabel.shadowColor=this.labelShadowColor,this.trueStateLabel.color=this.labelColor,this.trueStateLabel.drawNew())):this.labelString[0]instanceof Morph?(this.label=this.labelString[0].fullCopy(),this.trueStateLabel=this.labelString[1].fullCopy()):(this.label=new StringMorph(localize(this.labelString[0]),this.fontSize,this.fontStyle,!0,!1,!1,t?this.labelShadowOffset:null,this.labelShadowColor,this.labelColor),this.trueStateLabel=new StringMorph(localize(this.labelString[1]),this.fontSize,this.fontStyle,!0,!1,!1,t?this.labelShadowOffset:null,this.labelShadowColor,this.labelColor)):this.labelString instanceof SymbolMorph?(this.label=this.labelString.fullCopy(),this.isPicture||(this.label.shadowOffset=t?this.labelShadowOffset:e,this.label.shadowColor=this.labelShadowColor,this.label.color=this.labelColor,this.label.drawNew())):this.labelString instanceof Morph?this.label=this.labelString.fullCopy():this.label=new StringMorph(localize(this.labelString),this.fontSize,this.fontStyle,!0,!1,!1,t?this.labelShadowOffset:e,this.labelShadowColor,this.labelColor),this.add(this.label),this.trueStateLabel&&this.add(this.trueStateLabel)},ToggleButtonMorph.prototype.hide=function(){this.isVisible=!1,this.changed()},ToggleButtonMorph.prototype.show=function(){this.isVisible=!0,this.changed()},TabMorph.prototype=new ToggleButtonMorph,TabMorph.prototype.constructor=TabMorph,TabMorph.uber=ToggleButtonMorph.prototype,TabMorph.prototype.fixLayout=function(){null!==this.label&&(this.setExtent(new Point(this.label.width()+2*this.padding+3*this.corner+2*this.edge,(this.label instanceof StringMorph?this.label.rawHeight():this.label.height())+2*this.padding+this.edge)),this.label.setCenter(this.center()))},TabMorph.prototype.refresh=function(){this.state&&this.parent&&this.parent.add(this),TabMorph.uber.refresh.call(this)},TabMorph.prototype.drawBackground=function(t,e){var o=this.width(),i=this.height(),r=this.corner;t.fillStyle=e.toString(),t.beginPath(),t.moveTo(0,i),t.bezierCurveTo(r,i,r,0,2*r,0),t.lineTo(o-2*r,0),t.bezierCurveTo(o-r,0,o-r,i,o,i),t.closePath(),t.fill()},TabMorph.prototype.drawOutline=function(){nop()},TabMorph.prototype.drawEdges=function(t,e,o,i){if(!MorphicPreferences.isFlat||this.is3D){var r,n=this.width(),s=this.height(),a=this.corner,h=this.edge,l=h/2;nop(e),(r=t.createLinearGradient(0,0,n,0)).addColorStop(0,o.toString()),r.addColorStop(1,i.toString()),t.strokeStyle=r,t.lineCap="round",t.lineWidth=h,t.beginPath(),t.moveTo(0,s+l),t.bezierCurveTo(a,s,a,0,2*a,l),t.lineTo(n-2*a,l),t.bezierCurveTo(n-a,0,n-a,s,n,s+l),t.stroke()}},ToggleMorph.prototype=new PushButtonMorph,ToggleMorph.prototype.constructor=ToggleMorph,ToggleMorph.uber=PushButtonMorph.prototype,ToggleMorph.prototype.init=function(t,e,o,i,r,n,s,a,h,l){this.padding=1,t=t||"checkbox",this.corner="checkbox"===t?0:fontHeight(this.fontSize)/2+this.outline+this.padding,this.state=!1,this.query=r||function(){return!0},this.tick=null,this.captionString=i||null,this.labelAlignment="right",this.element=h||null,this.builder=l||null,this.toggleElement=null,ToggleMorph.uber.init.call(this,e,o,"checkbox"===t?"✓":"●",n,s,a),this.refresh(),this.drawNew()},ToggleMorph.prototype.fixLayout=function(){var t,e=2*this.padding+2*this.outline;null!==this.tick&&(this.silentSetHeight(this.tick.rawHeight()+e),this.silentSetWidth(this.tick.width()+e),this.setExtent(new Point(Math.max(this.width(),this.height()),Math.max(this.width(),this.height()))),this.tick.setCenter(this.center())),this.state?this.tick.show():this.tick.hide(),this.toggleElement&&"right"===this.labelAlignment&&(t=this.top()+(this.height()-this.toggleElement.height())/2,this.toggleElement.setPosition(new Point(this.right()+e,t))),null!==this.label&&(t=this.top()+(this.height()-this.label.height())/2,"right"===this.labelAlignment?this.label.setPosition(new Point(this.toggleElement?this.toggleElement instanceof ToggleElementMorph?this.toggleElement.right():this.toggleElement.right()+e:this.right()+e,t)):this.label.setPosition(new Point(this.left()-this.label.width()-e,t)))},ToggleMorph.prototype.createLabel=function(){var t=!MorphicPreferences.isFlat||this.is3D;null===this.label&&this.captionString&&(this.label=new TextMorph(localize(this.captionString),this.fontSize,this.fontStyle,!0),this.add(this.label)),null===this.tick&&(this.tick=new StringMorph(localize(this.labelString),this.fontSize,this.fontStyle,!0,!1,!1,t?new Point(1,1):null,new Color(240,240,240)),this.add(this.tick)),null===this.toggleElement&&this.element&&(this.element instanceof Morph?this.toggleElement=new ToggleElementMorph(this.target,this.action,this.element,this.query,this.environment,this.hint,this.builder):this.element instanceof HTMLCanvasElement&&(this.toggleElement=new Morph,this.toggleElement.silentSetExtent(new Point(this.element.width,this.element.height)),this.toggleElement.image=this.element),this.add(this.toggleElement))},ToggleMorph.prototype.trigger=function(){ToggleMorph.uber.trigger.call(this),this.refresh()},ToggleMorph.prototype.refresh=function(){"function"==typeof this.query?this.state=this.query.call(this.target):this.state=this.target[this.query](),this.state?this.tick.show():this.tick.hide(),this.toggleElement&&this.toggleElement.refresh&&this.toggleElement.refresh()},ToggleMorph.prototype.mouseDownLeft=function(){PushButtonMorph.uber.mouseDownLeft.call(this),this.tick&&this.tick.setCenter(this.center().add(1))},ToggleMorph.prototype.mouseClickLeft=function(){PushButtonMorph.uber.mouseClickLeft.call(this),this.tick&&this.tick.setCenter(this.center())},ToggleMorph.prototype.mouseLeave=function(){PushButtonMorph.uber.mouseLeave.call(this),this.tick&&this.tick.setCenter(this.center())},ToggleMorph.prototype.hide=ToggleButtonMorph.prototype.hide,ToggleMorph.prototype.show=ToggleButtonMorph.prototype.show,ToggleElementMorph.prototype=new TriggerMorph,ToggleElementMorph.prototype.constructor=ToggleElementMorph,ToggleElementMorph.uber=TriggerMorph.prototype,ToggleElementMorph.prototype.contrast=50,ToggleElementMorph.prototype.shadowOffset=new Point(2,2),ToggleElementMorph.prototype.shadowAlpha=.6,ToggleElementMorph.prototype.fontSize=10,ToggleElementMorph.prototype.inactiveColor=new Color(180,180,180),ToggleElementMorph.prototype.init=function(t,e,o,i,r,n,s,a){this.target=t||null,this.action=e||null,this.element=o,this.query=i||function(){return!0},this.environment=r||null,this.hint=n||null,this.builder=s||"nop",this.captionString=a||null,this.labelAlignment="right",this.state=!1,TriggerMorph.uber.init.call(this),this.color=o.color,this.createLabel()},ToggleElementMorph.prototype.createBackgrounds=function(){var t=!MorphicPreferences.isFlat||this.is3D;this.color=this.element.color,this.element.removeShadow(),this.element[this.builder](),t&&this.element.addShadow(this.shadowOffset,this.shadowAlpha),this.silentSetExtent(this.element.fullBounds().extent()),this.pressImage=this.element.fullImage(),this.element.removeShadow(),this.element.setColor(this.inactiveColor),this.element[this.builder](this.contrast),t&&this.element.addShadow(this.shadowOffset,0),this.normalImage=this.element.fullImage(),this.element.removeShadow(),this.element.setColor(this.color.lighter(this.contrast)),this.element[this.builder](this.contrast),t&&this.element.addShadow(this.shadowOffset,this.shadowAlpha),this.highlightImage=this.element.fullImage(),this.element.removeShadow(),this.element.setColor(this.color),this.element[this.builder](),this.image=this.normalImage},ToggleElementMorph.prototype.setColor=function(t){this.element.setColor(t),this.createBackgrounds(),this.refresh()},ToggleElementMorph.prototype.createLabel=function(){var t;this.captionString&&(this.label=new StringMorph(this.captionString,this.fontSize,this.fontStyle,!0),this.add(this.label),t=this.top()+(this.height()-this.label.height())/2,"right"===this.labelAlignment?this.label.setPosition(new Point(this.right(),t)):this.label.setPosition(new Point(this.left()-this.label.width(),t)))},ToggleElementMorph.prototype.trigger=ToggleButtonMorph.prototype.trigger,ToggleElementMorph.prototype.refresh=ToggleButtonMorph.prototype.refresh,ToggleElementMorph.prototype.mouseEnter=ToggleButtonMorph.prototype.mouseEnter,ToggleElementMorph.prototype.mouseLeave=ToggleButtonMorph.prototype.mouseLeave,ToggleElementMorph.prototype.mouseDownLeft=ToggleButtonMorph.prototype.mouseDownLeft,ToggleElementMorph.prototype.mouseClickLeft=ToggleButtonMorph.prototype.mouseClickLeft,DialogBoxMorph.prototype=new Morph,DialogBoxMorph.prototype.constructor=DialogBoxMorph,DialogBoxMorph.uber=Morph.prototype,DialogBoxMorph.prototype.fontSize=12,DialogBoxMorph.prototype.titleFontSize=14,DialogBoxMorph.prototype.fontStyle="sans-serif",DialogBoxMorph.prototype.color=PushButtonMorph.prototype.color,DialogBoxMorph.prototype.titleTextColor=new Color(255,255,255),DialogBoxMorph.prototype.titleBarColor=PushButtonMorph.prototype.pressColor,DialogBoxMorph.prototype.contrast=40,DialogBoxMorph.prototype.corner=12,DialogBoxMorph.prototype.padding=14,DialogBoxMorph.prototype.titlePadding=6,DialogBoxMorph.prototype.buttonContrast=50,DialogBoxMorph.prototype.buttonFontSize=12,DialogBoxMorph.prototype.buttonCorner=12,DialogBoxMorph.prototype.buttonEdge=6,DialogBoxMorph.prototype.buttonPadding=0,DialogBoxMorph.prototype.buttonOutline=3,DialogBoxMorph.prototype.buttonOutlineColor=PushButtonMorph.prototype.color,DialogBoxMorph.prototype.buttonOutlineGradient=!0,DialogBoxMorph.prototype.instances={},DialogBoxMorph.prototype.init=function(t,e,o){this.is3D=!1,this.target=t||null,this.action=e||null,this.environment=o||null,this.key=null,this.labelString=null,this.label=null,this.head=null,this.body=null,this.buttons=null,DialogBoxMorph.uber.init.call(this),this.isDraggable=!0,this.color=PushButtonMorph.prototype.color,this.createLabel(),this.createButtons(),this.setExtent(new Point(300,150))},DialogBoxMorph.prototype.inform=function(t,e,o,i){var r=new TextMorph(e,this.fontSize,this.fontStyle,!0,!1,"center",null,null,MorphicPreferences.isFlat?null:new Point(1,1),new Color(255,255,255));this.key||(this.key="inform"+t+e),this.labelString=t,this.createLabel(),i&&this.setPicture(i),e&&this.addBody(r),this.addButton("ok","OK"),this.drawNew(),this.fixLayout(),this.popUp(o)},DialogBoxMorph.prototype.askYesNo=function(t,e,o,i){var r=new TextMorph(e,this.fontSize,this.fontStyle,!0,!1,"center",null,null,MorphicPreferences.isFlat?null:new Point(1,1),new Color(255,255,255));this.key||(this.key="decide"+t+e),this.labelString=t,this.createLabel(),i&&this.setPicture(i),this.addBody(r),this.addButton("ok","Yes"),this.addButton("cancel","No"),this.fixLayout(),this.drawNew(),this.fixLayout(),this.popUp(o)},DialogBoxMorph.prototype.prompt=function(t,e,o,i,r,n,s,a,h,l){var p,c,d=new InputFieldMorph(e,s||!1,r||null,!!r&&(n||!1));d.setWidth(250),s?(i&&(c=new AlignmentMorph("column",this.padding),i.setPosition(c.position()),c.add(i)),isNil(a)||isNil(h)||((p=new SliderMorph(100*a,100*h,100*parseFloat(e),(h-a)/10*100,"horizontal")).alpha=1,p.color=this.color.lighter(50),p.setHeight(.7*d.height()),p.setWidth(d.width()),p.action=function(t){l&&l(t/100),d.setContents(t/100),d.edit()},c||(c=new AlignmentMorph("column",this.padding)),c.add(p)),c&&(c.fixLayout(),this.setPicture(c),c.fixLayout())):i&&this.setPicture(i),this.reactToChoice=function(t){p&&(p.value=100*t,p.drawNew(),p.changed()),l&&l(t)},d.reactToKeystroke=function(){var t=d.getValue();p&&(t=Math.max(t,a),p.value=100*t,p.drawNew(),p.changed()),l&&l(t)},this.labelString=t,this.createLabel(),this.key||(this.key="prompt"+t+e),this.addBody(d),d.drawNew(),this.addButton("ok","OK"),this.addButton("cancel","Cancel"),this.fixLayout(),this.drawNew(),this.fixLayout(),this.popUp(o)},DialogBoxMorph.prototype.promptCode=function(t,e,o,i,r){var n=new ScrollFrameMorph,s=new TextMorph(e||""),a=new AlignmentMorph("column",this.padding),h=i?Math.max(i.width,400):400;this.getInput=function(){return s.text},n.padding=6,n.setWidth(h),n.acceptsDrops=!1,n.contents.acceptsDrops=!1,s.fontName="monospace",s.fontStyle="monospace",s.fontSize=11,s.setPosition(n.topLeft().add(n.padding)),s.enableSelecting(),s.isEditable=!0,n.setHeight(h/4),n.fixLayout=nop,n.edge=InputFieldMorph.prototype.edge,n.fontSize=InputFieldMorph.prototype.fontSize,n.typeInPadding=InputFieldMorph.prototype.typeInPadding,n.contrast=InputFieldMorph.prototype.contrast,n.drawNew=InputFieldMorph.prototype.drawNew,n.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,n.addContents(s),s.drawNew(),i&&this.setPicture(i),this.labelString=t,this.createLabel(),this.key||(this.key="promptCode"+t+e),a.setColor(this.color),a.add(n),r&&a.add(new TextMorph(localize(r),10,null,!1,null,null,null,null,MorphicPreferences.isFlat?null:new Point(1,1),new Color(255,255,255))),a.fixLayout(),this.addBody(a),n.drawNew(),a.drawNew(),this.addButton("ok","OK"),this.addButton("cancel","Cancel"),this.fixLayout(),this.drawNew(),this.fixLayout(),this.popUp(o),s.edit()},DialogBoxMorph.prototype.promptVector=function(t,e,o,i,r,n,s,a){function h(t){return new TextMorph(localize(t),10,null,!1,null,null,null,null,MorphicPreferences.isFlat?null:new Point(1,1),new Color(255,255,255))}var l=new AlignmentMorph("row",4),p=new InputFieldMorph(e.x.toString(),!0),c=new InputFieldMorph(e.y.toString(),!0),d=new AlignmentMorph("column",2),u=new AlignmentMorph("column",2),g=new AlignmentMorph("column",2),f=new AlignmentMorph("column",this.padding);g.alignment="left",g.setColor(this.color),f.setColor(this.color),d.alignment="left",d.setColor(this.color),u.alignment="left",u.setColor(this.color),d.add(h(i)),d.add(p),u.add(h(r)),u.add(c),l.add(d),l.add(u),g.add(l),a&&f.add(h(a)),f.add(g),l.fixLayout(),d.fixLayout(),u.fixLayout(),g.fixLayout(),f.fixLayout(),this.labelString=t,this.createLabel(),s&&this.setPicture(s),this.addBody(f),l.drawNew(),d.drawNew(),p.drawNew(),u.drawNew(),c.drawNew(),f.fixLayout(),this.addButton("ok","OK"),o instanceof Point&&this.addButton(function(){p.setContents(o.x.toString()),c.setContents(o.y.toString())},"Default"),this.addButton("cancel","Cancel"),this.fixLayout(),this.drawNew(),this.fixLayout(),this.edit=function(){p.edit()},this.getInput=function(){return new Point(p.getValue(),c.getValue())},this.key||(this.key="vector"+t),this.popUp(n)},DialogBoxMorph.prototype.promptCredentials=function(t,e,o,i,r,n,s,a,h,l){function p(t){return new TextMorph(localize(t),10,null,!1,null,null,null,null,MorphicPreferences.isFlat?null:new Point(1,1),new Color(255,255,255))}function c(t,e){var o=new PushButtonMorph(A,function(){window.open(e)},"  "+localize(t)+"  ");return o.fontSize=10,o.corner=A.buttonCorner,o.edge=A.buttonEdge,o.outline=A.buttonOutline,o.outlineColor=A.buttonOutlineColor,o.outlineGradient=A.buttonOutlineGradient,o.padding=A.buttonPadding,o.contrast=A.buttonContrast,o.drawNew(),o.fixLayout(),o}function d(){var t,e,o=(new Date).getFullYear()+(new Date).getMonth()/12,i=+f.getValue()||0,r=g.getValue();return r instanceof Array&&(r=r[0]),isNaN(i)&&(i=0),t=["January","February","March","April","May","June","July","August","September","October","November","December"].indexOf(r),isNaN(t)&&(t=0),e=i+t/12,o-e}function u(){function t(t,e){var o=new SpeechBubbleMorph(localize(e));o.isPointingRight=!1,o.drawNew(),o.popUp(a,t.leftCenter().subtract(new Point(o.width()+2,0))),t.edit&&t.edit()}var o,i,r=b.getValue();if("login"===e?o=[M,w]:"signup"===e?o=[M,g,f,b]:"changePassword"===e?o=[C,w,S]:"resetPassword"===e&&(o=[M]),i=detect(o,function(t){return!t.getValue()}))return t(i,"please fill out\nthis field"),!1;if("signup"===e){if(M.getValue().length<4)return t(M,"User name must be four\ncharacters or longer"),!1;if(r.indexOf(" ")>-1||-1===r.indexOf("@")||-1===r.indexOf("."))return t(b,"please provide a valid\nemail address"),!1}if("changePassword"===e){if(w.getValue().length<6)return t(w,"password must be six\ncharacters or longer"),!1;if(w.getValue()!==S.getValue())return t(S,"passwords do\nnot match"),!1}return!("signup"===e&&!v)||(t(y,"please agree to\nthe TOS"),!1)}var g,f,m,y,M=new InputFieldMorph,b=new InputFieldMorph,w=new InputFieldMorph,S=new InputFieldMorph,C=new InputFieldMorph,v=!1,x=new AlignmentMorph("row",4),k=new AlignmentMorph("column",2),B=new AlignmentMorph("column",2),P=new AlignmentMorph("column",2),T=new AlignmentMorph("row",4),I=new AlignmentMorph("column",this.padding),E={},L=(new Date).getFullYear(),D=L-20,A=this;for(g=new InputFieldMorph(null,!1,{January:["January"],February:["February"],March:["March"],April:["April"],May:["May"],June:["June"],July:["July"],August:["August"],September:["September"],October:["October"],November:["November"],December:["December"]},!0),L;L>D;L-=1)E[L.toString()+" "]=L;E[D+" "+localize("or before")]="< "+L,f=new InputFieldMorph(null,!1,E,!0),P.alignment="left",P.setColor(this.color),I.setColor(this.color),k.alignment="left",k.setColor(this.color),B.alignment="left",B.setColor(this.color),M.setWidth(200),g.setWidth(100),f.contents().minWidth=80,f.setWidth(80),b.setWidth(200),w.setWidth(200),S.setWidth(200),C.setWidth(200),w.contents().text.toggleIsPassword(),S.contents().text.toggleIsPassword(),C.contents().text.toggleIsPassword(),"login"===e&&(P.add(p("User name:")),P.add(M)),"signup"===e&&(P.add(p("User name:")),P.add(M),k.add(p("Birth date:")),k.add(g),B.add(p("year:")),B.add(f),x.add(k),x.add(B),P.add(x),m=p("foo"),P.add(m),P.add(b)),"login"===e&&(P.add(p("Password:")),P.add(w)),"changePassword"===e&&(P.add(p("Old password:")),P.add(C),P.add(p("New password:")),P.add(w),P.add(p("Repeat new password:")),P.add(S)),"resetPassword"===e&&(P.add(p("User name:")),P.add(M)),l&&I.add(p(l)),I.add(P),(o||r)&&I.add(T),o&&T.add(c(i,o)),r&&T.add(c(n,r)),s&&((y=new ToggleMorph("checkbox",this,function(){v=!v},s,function(){return v})).edge=this.buttonEdge/2,y.outline=this.buttonOutline/2,y.outlineColor=this.buttonOutlineColor,y.outlineGradient=this.buttonOutlineGradient,y.contrast=this.buttonContrast,y.drawNew(),y.fixLayout(),I.add(y)),x.fixLayout(),k.fixLayout(),B.fixLayout(),P.fixLayout(),T.fixLayout(),I.fixLayout(),this.labelString=t,this.createLabel(),h&&this.setPicture(h),this.addBody(I),M.drawNew(),x.drawNew(),k.drawNew(),g.drawNew(),B.drawNew(),f.drawNew(),w.drawNew(),S.drawNew(),C.drawNew(),b.drawNew(),I.fixLayout(),this.addButton("ok","OK"),this.addButton("cancel","Cancel"),this.fixLayout(),this.drawNew(),this.fixLayout(),this.accept=function(){u()&&DialogBoxMorph.prototype.accept.call(A)},this.edit=function(){"changePassword"===e?C.edit():M.edit()},this.getInput=function(){return{username:M.getValue(),email:b.getValue(),oldpassword:C.getValue(),password:w.getValue(),choice:v}},this.reactToChoice=function(){"signup"===e&&(m.changed(),m.text=d()<=13?"E-mail address of parent or guardian:":"E-mail address:",m.text=localize(m.text),m.drawNew(),m.changed())},this.reactToChoice(),this.key||(this.key="credentials"+t+e),this.popUp(a)},DialogBoxMorph.prototype.accept=function(){this.action&&("function"==typeof this.target?"function"==typeof this.action?this.target.call(this.environment,this.action.call()):this.target.call(this.environment,this.action):"function"==typeof this.action?this.action.call(this.target,this.getInput()):this.target[this.action](this.getInput())),this.destroy()},DialogBoxMorph.prototype.withKey=function(t){return this.key=t,this},DialogBoxMorph.prototype.popUp=function(t){t&&(this.key&&(this.instances[t.stamp]?(this.instances[t.stamp][this.key]&&this.instances[t.stamp][this.key].destroy(),this.instances[t.stamp][this.key]=this):(this.instances[t.stamp]={},this.instances[t.stamp][this.key]=this)),t.add(this),t.keyboardReceiver=this,this.setCenter(t.center()),this.edit())},DialogBoxMorph.prototype.destroy=function(){DialogBoxMorph.uber.destroy.call(this),this.key&&delete this.instances[this.key]},DialogBoxMorph.prototype.ok=function(){this.accept()},DialogBoxMorph.prototype.cancel=function(){this.destroy()},DialogBoxMorph.prototype.edit=function(){this.children.forEach(function(t){if(t.edit)return t.edit()})},DialogBoxMorph.prototype.getInput=function(){return this.body instanceof InputFieldMorph?this.body.getValue():null},DialogBoxMorph.prototype.justDropped=function(t){t.world.keyboardReceiver=this,this.edit()},DialogBoxMorph.prototype.destroy=function(){var t=this.world();t.keyboardReceiver=null,t.hand.destroyTemporaries(),DialogBoxMorph.uber.destroy.call(this)},DialogBoxMorph.prototype.normalizeSpaces=function(t){var e,o,i="",r=!1;for(e=0;e<t.length;e+=1)" "===(o=t[e])?r&&(i+=o,r=!1):(i+=o,r=!0);return i.trim()},DialogBoxMorph.prototype.createLabel=function(){var t=!MorphicPreferences.isFlat||this.is3D;this.label&&this.label.destroy(),this.labelString&&(this.label=new StringMorph(localize(this.labelString),this.titleFontSize,this.fontStyle,!0,!1,!1,t?new Point(2,1):null,this.titleBarColor.darker(this.contrast)),this.label.color=this.titleTextColor,this.label.drawNew(),this.add(this.label))},DialogBoxMorph.prototype.createButtons=function(){this.buttons&&this.buttons.destroy(),this.buttons=new AlignmentMorph("row",this.padding),this.add(this.buttons)},DialogBoxMorph.prototype.addButton=function(t,e){var o=new PushButtonMorph(this,t||"ok","  "+localize(e||"OK")+"  ");return o.fontSize=this.buttonFontSize,o.corner=this.buttonCorner,o.edge=this.buttonEdge,o.outline=this.buttonOutline,o.outlineColor=this.buttonOutlineColor,o.outlineGradient=this.buttonOutlineGradient,o.padding=this.buttonPadding,o.contrast=this.buttonContrast,o.drawNew(),o.fixLayout(),this.buttons.add(o),o},DialogBoxMorph.prototype.setPicture=function(t){var e;t instanceof Morph?e=t:((e=new Morph).image=t,e.silentSetWidth(t.width),e.silentSetHeight(t.height)),this.addHead(e)},DialogBoxMorph.prototype.addHead=function(t){this.head&&this.head.destroy(),this.head=t,this.add(this.head)},DialogBoxMorph.prototype.addBody=function(t){this.body&&this.body.destroy(),this.body=t,this.add(this.body)},DialogBoxMorph.prototype.addShadow=function(){nop()},DialogBoxMorph.prototype.removeShadow=function(){nop()},DialogBoxMorph.prototype.fixLayout=function(){var t,e=fontHeight(this.titleFontSize)+2*this.titlePadding;this.head&&(this.head.setPosition(this.position().add(new Point(this.padding,e+this.padding))),this.silentSetWidth(this.head.width()+2*this.padding),this.silentSetHeight(this.head.height()+2*this.padding+e)),this.body&&(this.head?(this.body.setPosition(this.head.bottomLeft().add(new Point(0,this.padding))),this.silentSetWidth(Math.max(this.width(),this.body.width()+2*this.padding)),this.silentSetHeight(this.height()+this.body.height()+this.padding),t=this.width(),this.head.setLeft(this.left()+Math.round((t-this.head.width())/2)),this.body.setLeft(this.left()+Math.round((t-this.body.width())/2))):(this.body.setPosition(this.position().add(new Point(this.padding,e+this.padding))),this.silentSetWidth(this.body.width()+2*this.padding),this.silentSetHeight(this.body.height()+2*this.padding+e))),this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(e-this.label.height())/2)),this.buttons&&this.buttons.children.length>0&&(this.buttons.fixLayout(),this.silentSetHeight(this.height()+this.buttons.height()+this.padding),this.silentSetWidth(Math.max(this.width(),this.buttons.width()+2*this.padding)),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding))},DialogBoxMorph.prototype.shadowImage=function(t,e){var o,i,r,n,s,a=t||new Point(7,7),h=e||new Color(0,0,0);return o=this.extent(),i=this.image,r=newCanvas(o),(s=r.getContext("2d")).drawImage(i,0,0),s.globalCompositeOperation="destination-out",s.drawImage(i,-a.x,-a.y),n=newCanvas(o),(s=n.getContext("2d")).drawImage(r,0,0),s.globalCompositeOperation="source-atop",s.fillStyle=h.toString(),s.fillRect(0,0,o.x,o.y),n},DialogBoxMorph.prototype.shadowImageBlurred=function(t,e){var o,i,r,n,s=t||new Point(7,7),a=this.shadowBlur,h=e||new Color(0,0,0);return o=this.extent().add(2*a),i=this.image,r=newCanvas(o),n=r.getContext("2d"),n.shadowOffsetX=s.x,n.shadowOffsetY=s.y,n.shadowBlur=a,n.shadowColor=h.toString(),n.drawImage(i,a-s.x,a-s.y),n.shadowOffsetX=0,n.shadowOffsetY=0,n.shadowBlur=0,n.globalCompositeOperation="destination-out",n.drawImage(i,a-s.x,a-s.y),r},DialogBoxMorph.prototype.processKeyPress=function(){nop()},DialogBoxMorph.prototype.processKeyDown=function(t){switch(t.keyCode){case 13:this.ok();break;case 27:this.cancel();break;default:nop()}},DialogBoxMorph.prototype.drawNew=function(){this.fullChanged(),Morph.prototype.trackChanges=!1,DialogBoxMorph.uber.removeShadow.call(this),this.fixLayout();var t,e,o,i,r=this.width(),n=this.height(),s=Math.floor(fontHeight(this.titleFontSize)+2*this.titlePadding),a=this.corner/2,h=MorphicPreferences.isFlat&&!this.is3D;if(this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),h?t.fillStyle=this.titleBarColor.toString():((e=t.createLinearGradient(0,0,0,s)).addColorStop(0,this.titleBarColor.lighter(this.contrast/2).toString()),e.addColorStop(1,this.titleBarColor.darker(this.contrast).toString()),t.fillStyle=e),t.beginPath(),this.outlinePathTitle(t,h?0:this.corner),t.closePath(),t.fill(),t.fillStyle=this.color.toString(),t.beginPath(),this.outlinePathBody(t,h?0:this.corner),t.closePath(),t.fill(),h)return DialogBoxMorph.uber.addShadow.call(this),Morph.prototype.trackChanges=!0,void this.fullChanged();(e=t.createLinearGradient(0,n-this.corner,0,n)).addColorStop(0,this.color.toString()),e.addColorStop(1,this.color.darker(this.contrast.toString())),t.lineWidth=this.corner,t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.moveTo(this.corner,n-a),t.lineTo(this.corner+1,n-a),t.stroke(),(e=t.createLinearGradient(0,n-this.corner,0,n)).addColorStop(0,this.color.toString()),e.addColorStop(1,this.color.darker(this.contrast.toString())),t.lineWidth=this.corner,t.lineCap="butt",t.strokeStyle=e,t.beginPath(),t.moveTo(this.corner,n-a),t.lineTo(r-this.corner,n-a),t.stroke(),(e=t.createLinearGradient(r-this.corner,0,r,0)).addColorStop(0,this.color.toString()),e.addColorStop(1,this.color.darker(this.contrast).toString()),t.lineWidth=this.corner,t.lineCap="butt",t.strokeStyle=e,t.beginPath(),t.moveTo(r-a,s),t.lineTo(r-a,n-this.corner),t.stroke(),o=r-this.corner,i=n-this.corner,(e=t.createRadialGradient(o,i,0,o,i,this.corner)).addColorStop(0,this.color.toString()),e.addColorStop(1,this.color.darker(this.contrast.toString())),t.lineCap="butt",t.strokeStyle=e,t.beginPath(),t.arc(o,i,a,radians(90),radians(0),!0),t.stroke(),(e=t.createLinearGradient(0,0,this.corner,0)).addColorStop(0,this.color.lighter(this.contrast).toString()),e.addColorStop(1,this.color.toString()),t.lineCap="butt",t.strokeStyle=e,t.beginPath(),t.moveTo(a,s),t.lineTo(a,n-2*this.corner),t.stroke(),(e=t.createLinearGradient(0,0,this.corner,0)).addColorStop(0,this.color.lighter(this.contrast).toString()),e.addColorStop(1,this.color.toString()),t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.moveTo(a,n-2*this.corner),t.lineTo(a,n-this.corner-a),t.stroke(),DialogBoxMorph.uber.addShadow.call(this),Morph.prototype.trackChanges=!0,this.fullChanged()},DialogBoxMorph.prototype.outlinePathTitle=function(t,e){var o=this.width(),i=Math.ceil(fontHeight(this.titleFontSize))+2*this.titlePadding;t.arc(e,e,e,radians(-180),radians(-90),!1),t.arc(o-e,e,e,radians(-90),radians(-0),!1),t.lineTo(o,i),t.lineTo(0,i)},DialogBoxMorph.prototype.outlinePathBody=function(t,e){var o=this.width(),i=this.height(),r=Math.floor(fontHeight(this.titleFontSize))+2*this.titlePadding;t.moveTo(0,r),t.lineTo(o,r),t.arc(o-e,i-e,e,radians(0),radians(90),!1),t.arc(e,i-e,e,radians(90),radians(180),!1)},AlignmentMorph.prototype=new Morph,AlignmentMorph.prototype.constructor=AlignmentMorph,AlignmentMorph.uber=Morph.prototype,AlignmentMorph.prototype.init=function(t,e){this.orientation=t||"row",this.alignment="center",this.padding=e||0,this.respectHiddens=!1,AlignmentMorph.uber.init.call(this)},AlignmentMorph.prototype.drawNew=function(){this.image=newCanvas(new Point(1,1)),this.fixLayout()},AlignmentMorph.prototype.fixLayout=function(){var t,e=this,o=null;if(0===this.children.length)return null;this.children.forEach(function(i){var r,n=i.fullBounds();(i.isVisible||e.respectHiddens)&&(o?(r=o.fullBounds(),"row"===e.orientation?i.setPosition(r.topRight().add(new Point(e.padding,(r.height()-n.height())/2))):i.setPosition(r.bottomLeft().add(new Point("center"===e.alignment?(r.width()-n.width())/2:0,e.padding))),n=i.fullBounds(),t=t.merge(n)):t=n,o=i)}),this.bounds=t},InputFieldMorph.prototype=new Morph,InputFieldMorph.prototype.constructor=InputFieldMorph,InputFieldMorph.uber=Morph.prototype,InputFieldMorph.prototype.edge=2,InputFieldMorph.prototype.fontSize=12,InputFieldMorph.prototype.typeInPadding=2,InputFieldMorph.prototype.contrast=65,InputFieldMorph.prototype.init=function(t,e,o,i){var r=new StringFieldMorph(t||""),n=new ArrowMorph("down",0,Math.max(Math.floor(this.fontSize/6),1));this.choices=o||null,this.isReadOnly=i||!1,this.isNumeric=e||!1,r.alpha=0,r.fontSize=this.fontSize,r.drawNew(),this.oldContentsExtent=r.extent(),this.isNumeric=e||!1,InputFieldMorph.uber.init.call(this),this.color=new Color(255,255,255),this.add(r),this.add(n),r.isDraggable=!1,this.drawNew()},InputFieldMorph.prototype.contents=function(){return detect(this.children,function(t){return t instanceof StringFieldMorph})},InputFieldMorph.prototype.arrow=function(){return detect(this.children,function(t){return t instanceof ArrowMorph})},InputFieldMorph.prototype.setChoice=function(t){this.setContents(t),this.escalateEvent("reactToChoice",t)},InputFieldMorph.prototype.setContents=function(t){var e=this.contents();if(e.text.text=t,void 0===t)return null;null===t?e.text.text="":t.toString&&(e.text.text=t.toString()),e.drawNew(),e.changed()},InputFieldMorph.prototype.edit=function(){var t=this.contents();t.text.edit(),t.text.selectAll()},InputFieldMorph.prototype.setIsNumeric=function(t){var e;this.isNumeric=t,this.contents().isNumeric=t,this.contents().text.isNumeric=t,e=this.getValue(),this.isNumeric&&(e=parseFloat(e),isNaN(e)&&(e=null)),this.setContents(e)},InputFieldMorph.prototype.dropDownMenu=function(){var t,e=this.choices,o=new MenuMorph(this.setChoice,null,this,this.fontSize);if(e instanceof Function?e=e.call(this):isString(e)&&(e=this[e]()),!e)return null;if(o.addItem(" ",null),e instanceof Array)e.forEach(function(t){o.addItem(t[0],t[1])});else for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&("~"===t[0]?o.addLine():o.addItem(t,e[t]));if(!(o.items.length>0))return null;o.popUpAtHand(this.world())},InputFieldMorph.prototype.fixLayout=function(){var t=this.contents(),e=this.arrow();if(!t)return null;t.isNumeric=this.isNumeric,t.isEditable=!this.isReadOnly,this.choices?(e.setSize(this.fontSize),e.show()):(e.setSize(0),e.hide()),this.silentSetHeight(t.height()+2*this.edge+2*this.typeInPadding),this.silentSetWidth(Math.max(t.minWidth+2*this.edge+2*this.typeInPadding,this.width())),t.setWidth(this.width()-this.edge-this.typeInPadding-(this.choices?e.width()+this.typeInPadding:0)),t.silentSetPosition(new Point(this.edge,this.edge).add(this.typeInPadding).add(this.position())),e.silentSetPosition(new Point(this.right()-e.width()-this.edge,t.top()))},InputFieldMorph.prototype.mouseClickLeft=function(t){this.arrow().bounds.containsPoint(t)?this.dropDownMenu():this.isReadOnly?this.dropDownMenu():this.escalateEvent("mouseClickLeft",t)},InputFieldMorph.prototype.getValue=function(){var t,e=this.contents();return this.isNumeric&&(t=parseFloat(e.text),!isNaN(t))?t:this.normalizeSpaces(e.string())},InputFieldMorph.prototype.normalizeSpaces=DialogBoxMorph.prototype.normalizeSpaces,InputFieldMorph.prototype.drawNew=function(){var t,e;this.fixLayout(),this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),this.parent?(this.parent.color.eq(new Color(255,255,255))?this.color=this.parent.color.darker(.1*this.contrast):this.color=this.parent.color.lighter(.75*this.contrast),e=this.parent.color):e=new Color(120,120,120),t.fillStyle=this.color.toString(),this.cachedClr=e.toString(),this.cachedClrBright=e.lighter(this.contrast).toString(),this.cachedClrDark=e.darker(this.contrast).toString(),t.fillRect(this.edge,this.edge,this.width()-2*this.edge,this.height()-2*this.edge),this.drawRectBorder(t)},InputFieldMorph.prototype.drawRectBorder=function(t){var e,o=.5*this.edge;MorphicPreferences.isFlat&&!this.is3D||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.shadowOffsetY=o,t.shadowBlur=4*this.edge,t.shadowColor=this.cachedClrDark,(e=t.createLinearGradient(0,0,0,this.edge)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(this.edge,o),t.lineTo(this.width()-this.edge-o,o),t.stroke(),t.shadowOffsetY=0,(e=t.createLinearGradient(0,0,this.edge,0)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(o,this.edge),t.lineTo(o,this.height()-this.edge-o),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,(e=t.createLinearGradient(0,this.height()-this.edge,0,this.height())).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(this.edge,this.height()-o),t.lineTo(this.width()-this.edge,this.height()-o),t.stroke(),(e=t.createLinearGradient(this.width()-this.edge,0,this.width(),0)).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(this.width()-o,this.edge),t.lineTo(this.width()-o,this.height()-this.edge),t.stroke())},PianoMenuMorph.prototype=new MenuMorph,PianoMenuMorph.prototype.constructor=PianoMenuMorph,PianoMenuMorph.uber=MenuMorph.prototype,PianoMenuMorph.prototype.init=function(t,e,o,i){var r,n;this.soundType=i,PianoMenuMorph.uber.init.call(this,t,null,e,o),r={"C (48)":48,"D (50)":50,"C# (49)":49,"E (52)":52,"Eb (51)":51,"F (53)":53,"G (55)":55,"F# (54)":54,"A (57)":57,"G# (56)":56,"B (59)":59,"Bb (58)":58,"C (60)":60,"D (62)":62,"C# (61)":61,"E (64)":64,"Eb (63)":63,"F (65)":65,"G (67)":67,"F# (66)":66,"A (69)":69,"G# (68)":68,"B (71)":71,"Bb (70)":70,"C (72)":72};for(n in r)Object.prototype.hasOwnProperty.call(r,n)&&this.addItem(n,r[n]);this.drawNew()},PianoMenuMorph.prototype.drawNew=function(){var t,e,o,i,r,n,s,a,h,l,p,c=this;this.children.forEach(function(t){t.destroy()}),this.children=[],this.isListContents||(this.edge=MorphicPreferences.isFlat?0:5,this.border=MorphicPreferences.isFlat?1:2),this.color=new Color(255,255,255),this.borderColor=new Color(60,60,60),this.silentSetExtent(new Point(0,0)),o=this.left()+1,i=this.top()+1.5*this.fontSize+2,r=new StringMorph("",this.fontSize),this.items.forEach(function(e){n=" "!==e[0][1],s=new BoxMorph(1,1),n?(a=new Color(0,0,0),h=c.fontSize,l=2.5*c.fontSize,p=new Point(o+2-2*c.fontSize,i)):(a=new Color(255,255,255),h=1.5*c.fontSize,l=4*c.fontSize,p=new Point(o+1,i),o+=h-1),s.setColor(a),s.setWidth(h),s.setHeight(l),(t=new PianoKeyMorph(c.target,e[1],[s,e[0]],c.fontSize||MorphicPreferences.menuFontSize,MorphicPreferences.menuFontName,c.environment,e[2],e[3],e[4],e[5],e[6],r)).setPosition(p),c.add(t)}),e=this.fullBounds(),r.setPosition(new Point(e.width()/2-this.fontSize,2)),this.add(r),e=this.fullBounds(),this.silentSetExtent(e.extent().add(2)),MenuMorph.uber.drawNew.call(this)},PianoMenuMorph.prototype.select=function(t){this.unselectAllItems(),t.mouseEnter(),this.selection=t,this.world.keyboardReceiver=this,this.hasFocus=!0},PianoMenuMorph.prototype.unselectAllItems=function(){this.children.forEach(function(t){t instanceof MenuItemMorph&&t.mouseLeave()}),this.changed()},PianoMenuMorph.prototype.selectKey=function(t){var e;isNil(t)||((e=detect(this.children,function(e){return e.action===t}))?this.select(e):this.selectKey(48))},PianoMenuMorph.prototype.processKeyDown=function(t){switch(t.keyCode){case 13:case 32:return void(this.selection&&this.selection.mouseClickLeft());case 27:return this.destroy();case 37:case 40:case 189:return this.selectDown();case 38:case 39:case 187:case 220:return this.selectUp();default:switch(t.key){case"C":return this.selectKey(48);case"c":return this.selectKey(60);case"D":return this.selectKey(50);case"d":return this.selectKey(62);case"E":return this.selectKey(52);case"e":return this.selectKey(64);case"F":return this.selectKey(53);case"f":return this.selectKey(65);case"G":return this.selectKey(55);case"g":return this.selectKey(67);case"A":return this.selectKey(57);case"a":return this.selectKey(69);case"B":case"H":return this.selectKey(59);case"b":case"h":return this.selectKey(71);default:nop()}}},PianoMenuMorph.prototype.selectUp=function(){var t=48;this.selection&&(t=this.selection.action+1)>72&&(t=48),this.selectKey(t)},PianoMenuMorph.prototype.selectDown=function(){var t=48;this.selection&&(t=this.selection.action-1)<48&&(t=72),this.selectKey(t)},PianoMenuMorph.prototype.destroy=function(){this.children.forEach(function(t){t.note&&t.note.stop()}),PianoMenuMorph.uber.destroy.call(this)},PianoKeyMorph.prototype=new MenuItemMorph,PianoKeyMorph.prototype.constructor=PianoKeyMorph,PianoKeyMorph.uber=MenuItemMorph.prototype,PianoKeyMorph.prototype.init=function(t,e,o,i,r,n,s,a,h,l,p,c){this.note=new Note(e),PianoKeyMorph.uber.init.call(this,t,e,o,i,r,n,s,a,h,l,p,c)},PianoKeyMorph.prototype.createLabel=function(){var t;null!==this.label&&this.label.destroy(),this.label=new Morph,t=this.createIcon(this.labelString[0]),this.label.add(t),this.label.drawNew(),this.silentSetExtent(t.extent()),this.label.bounds=this.position().extent(this.label.extent()),this.label.silentSetExtent(new Point(0,0)),this.add(this.label)},PianoKeyMorph.prototype.mouseEnter=function(){var t=this.parentThatIsA(PianoMenuMorph),e=t?t.soundType:1,o=this;t&&(t.unselectAllItems(),t.selection=this,t.world.keyboardReceiver=t,t.hasFocus=!0),this.label.children[0].hide(),this.image=this.highlightImage,this.changed(),this.feedback.text=this.labelString[1],this.feedback.changed(),this.feedback.drawNew(),this.feedback.changed(),this.note.play(e),setTimeout(function(){o.note.stop()},400)},PianoKeyMorph.prototype.mouseLeave=function(){this.note.stop(),this.label.children[0].show(),this.image=this.normalImage,this.changed()},modules.blocks="2017-November-16";var SyntaxElementMorph,BlockMorph,CommandBlockMorph,ReporterBlockMorph,ScriptsMorph,ArgMorph,CommandSlotMorph,CSlotMorph,InputSlotMorph,BooleanSlotMorph,ArrowMorph,ColorSlotMorph,HatBlockMorph,BlockHighlightMorph,MultiArgMorph,TemplateSlotMorph,FunctionSlotMorph,ReporterSlotMorph,RingMorph,RingCommandSlotMorph,RingReporterSlotMorph,CommentMorph,ArgLabelMorph,TextSlotMorph,ScriptFocusMorph;SyntaxElementMorph.prototype=new Morph,SyntaxElementMorph.prototype.constructor=SyntaxElementMorph,SyntaxElementMorph.uber=Morph.prototype,SyntaxElementMorph.prototype.setScale=function(t){var e=Math.min(Math.max(t,1),25);this.scale=e,this.corner=3*e,this.rounding=9*e,this.edge=1.000001*e,this.inset=6*e,this.hatHeight=12*e,this.hatWidth=70*e,this.rfBorder=3*e,this.minWidth=0,this.dent=8*e,this.bottomPadding=3*e,this.cSlotPadding=4*e,this.typeInPadding=e,this.labelPadding=4*e,this.labelFontName="Verdana",this.labelFontStyle="sans-serif",this.fontSize=10*e,this.embossing=new Point(-1*Math.max(e/2,1),-1*Math.max(e/2,1)),this.labelWidth=450*e,this.labelWordWrap=!0,this.dynamicInputLabels=!0,this.feedbackColor=new Color(255,255,255),this.feedbackMinHeight=5,this.minSnapDistance=20,this.reporterDropFeedbackPadding=10*e,this.contrast=65,this.labelContrast=25,this.activeHighlight=new Color(153,255,213),this.errorHighlight=new Color(173,15,0),this.activeBlur=20,this.activeBorder=4,this.rfColor=new Color(120,120,120)},SyntaxElementMorph.prototype.setScale(1),SyntaxElementMorph.prototype.isCachingInputs=!1,SyntaxElementMorph.prototype.init=function(t){this.cachedClr=null,this.cachedClrBright=null,this.cachedClrDark=null,this.cachedNormalColor=null,this.isStatic=!1,SyntaxElementMorph.uber.init.call(this,t),this.defaults=[],this.cachedInputs=null},SyntaxElementMorph.prototype.parts=function(){var t=null;return this.nextBlock&&(t=this.nextBlock()),this.children.filter(function(e){return!(e===t||e instanceof ShadowMorph||e instanceof BlockHighlightMorph)})},SyntaxElementMorph.prototype.inputs=function(){return!isNil(this.cachedInputs)&&this.isCachingInputs||(this.cachedInputs=this.parts().filter(function(t){return t instanceof SyntaxElementMorph})),this.cachedInputs},SyntaxElementMorph.prototype.debugCachedInputs=function(){var t,e;if(isNil(this.cachedInputs)||(t=this.parts().filter(function(t){return t instanceof SyntaxElementMorph})),this.cachedInputs.length!==t.length)throw new Error("cached inputs size do not match: "+this.constructor.name);for(e=0;e<t.length;e+=1)if(this.cachedInputs[e]!==t[e])throw new Error("cached input does not match: "+this.constructor.name+" #"+e+" "+this.cachedInputs[e].constructor.name+" != "+t[e].constructor.name)},SyntaxElementMorph.prototype.allInputs=function(){var t=this;return this.allChildren().slice(0).reverse().filter(function(e){return e instanceof ArgMorph||e instanceof ReporterBlockMorph&&e!==t})},SyntaxElementMorph.prototype.allEmptySlots=function(){var t=[];return this instanceof RingMorph||"reportJSFunction"===this.selector||this.children.forEach(function(e){e.isEmptySlot&&e.isEmptySlot()?t.push(e):e.allEmptySlots&&(t=t.concat(e.allEmptySlots()))}),t},SyntaxElementMorph.prototype.tagExitBlocks=function(t,e){"doReport"===this.selector?this.partOfCustomCommand=e:"doStopThis"===this.selector?this.exitTag=t:this instanceof RingMorph||this.children.forEach(function(o){o.tagExitBlocks&&o.tagExitBlocks(t,e)})},SyntaxElementMorph.prototype.replaceInput=function(t,e){var o=this.parentThatIsA(ScriptsMorph),i=e,r=this.children.indexOf(t),n=0;if(-1===r&&e instanceof MultiArgMorph&&this.children.forEach(function(e){e instanceof ArgLabelMorph&&e.argMorph()===t&&(r=n),n+=1}),-1===r||null===o)return null;t.cachedSlotSpec&&(t.cachedSlotSpec=null),e.cachedSlotSpec&&(e.cachedSlotSpec=null),this.startLayout(),e.parent&&e.parent.removeChild(e),t instanceof MultiArgMorph&&(t.inputs().forEach(function(e){t.replaceInput(e,new InputSlotMorph)}),this.dynamicInputLabels&&(i=new ArgLabelMorph(e))),i.parent=this,this.children[r]=i,t instanceof ReporterBlockMorph&&(t instanceof RingMorph&&!(t instanceof RingMorph&&t.contents())||(o.add(t),t.moveBy(i.extent()),t.fixBlockColor())),i instanceof MultiArgMorph||i instanceof ArgLabelMorph||i.constructor===CommandSlotMorph?(i.fixLayout(),this.fixLabelColor&&this.fixLabelColor()):(i.drawNew(),this.fixLayout()),this.cachedInputs=null,this.endLayout()},SyntaxElementMorph.prototype.silentReplaceInput=function(t,e){var o,i=this.children.indexOf(t);-1!==i&&(t.cachedSlotSpec&&(t.cachedSlotSpec=null),e.cachedSlotSpec&&(e.cachedSlotSpec=null),e.parent&&e.parent.removeChild(e),(o=t instanceof MultiArgMorph&&this.dynamicInputLabels?new ArgLabelMorph(e):e).parent=this,this.children[i]=o,o instanceof MultiArgMorph||o instanceof ArgLabelMorph||o.constructor===CommandSlotMorph?(o.fixLayout(),this.fixLabelColor&&this.fixLabelColor()):(o.drawNew(),this.fixLayout()),this.cachedInputs=null)},SyntaxElementMorph.prototype.revertToDefaultInput=function(t,e){var o,i=this.parts().indexOf(t),r=this.inputs().indexOf(t),n=new InputSlotMorph;-1!==i&&(this instanceof BlockMorph?(n=this.labelPart(this.parseSpec(this.blockSpec)[i]),this.isCustomBlock&&(o=this.isGlobal?this.definition:this.scriptTarget().getMethod(this.blockSpec),n instanceof InputSlotMorph&&n.setChoices.apply(n,o.inputOptionsOfIdx(r)),(n instanceof InputSlotMorph||n instanceof BooleanSlotMorph)&&n.setContents(o.defaultValueOfInputIdx(r)))):this instanceof MultiArgMorph?n=this.labelPart(this.slotSpec):this instanceof ReporterSlotMorph&&(n=this.emptySlot())),e||-1!==r&&(n instanceof MultiArgMorph?(n.setContents(this.defaults),n.defaults=this.defaults):isNil(this.defaults[r])||n.setContents(this.defaults[r])),this.silentReplaceInput(t,n),n instanceof MultiArgMorph?n.refresh():n instanceof RingMorph&&n.fixBlockColor(),this.cachedInputs=null},SyntaxElementMorph.prototype.isLocked=function(){return this.isStatic},SyntaxElementMorph.prototype.topBlock=function(){return this.parent&&this.parent.topBlock?this.parent.topBlock():this},SyntaxElementMorph.prototype.getVarNamesDict=function(){var t,e,o=this.parentThatIsA(BlockMorph),i=[];return o?(t=o.scriptTarget(),o.allParents().forEach(function(t){t instanceof PrototypeHatBlockMorph?(i.push.apply(i,t.variableNames()),i.push.apply(i,t.inputs()[0].inputFragmentNames())):t instanceof BlockMorph&&t.inputs().forEach(function(t){t instanceof TemplateSlotMorph?i.push(t.contents()):t instanceof MultiArgMorph&&t.children.forEach(function(t){t instanceof TemplateSlotMorph&&i.push(t.contents())})})}),t?(e=t.variables.allNamesDict(),i.forEach(function(t){e[t]=t}),e):{}):{}},SyntaxElementMorph.prototype.refactorVarInStack=function(t,e,o){if(!(this instanceof RingMorph&&contains(this.inputNames(),t)||!o&&this.definesScriptVariable(t))&&("reportGetVar"===this.selector&&this.blockSpec===t&&(this.setSpec(e),this.fullChanged(),this.fixLabelColor()),"getVarNamesDict"===this.choices&&this.contents().text===t&&this.setContents(e),this instanceof CustomCommandBlockMorph&&this.definition.body&&isNil(this.definition.declarations[t])&&!contains(this.definition.variableNames,t)&&this.definition.body.expression.refactorVarInStack(t,e),this.inputs().forEach(function(o){o.refactorVarInStack(t,e)}),this.nextBlock)){var i=this.nextBlock();i&&i.refactorVarInStack(t,e)}},SyntaxElementMorph.prototype.definesScriptVariable=function(t){return("doDeclareVariables"===this.selector||this.blockSpec&&this.blockSpec.match("%upvar"))&&detect(this.inputs()[0].allInputs(),function(e){return"reportGetVar"===e.selector&&e.blockSpec===t})},SyntaxElementMorph.prototype.selectForEdit=function(){var t,e=this.parentThatIsA(ScriptsMorph),o=this.parentThatIsA(IDE_Morph),i=o?o.currentSprite:null;return e&&i&&i.inheritsAttribute("scripts")?(this.selectionID=!0,i.shadowAttribute("scripts"),t=detect(i.scripts.allChildren(),function(t){return t.selectionID}),delete this.selectionID,delete t.selectionID,t):this},SyntaxElementMorph.prototype.reactToGrabOf=function(t){var e,o=this.topBlock();t instanceof CommandBlockMorph&&(e=this.parentThatIsA(CommandSlotMorph))&&(this.startLayout(),e.fixLayout(),this.endLayout()),o&&(o.allComments().forEach(function(t){t.align(o)}),o.getHighlight()&&o.addHighlight(o.removeHighlight()))},SyntaxElementMorph.prototype.bright=function(){return this.color.lighter(this.contrast).toString()},SyntaxElementMorph.prototype.dark=function(){return this.color.darker(this.contrast).toString()},SyntaxElementMorph.prototype.setColor=function(t,e){t&&(this.color.eq(t)||(this.color=t,e||this.drawNew(),this.children.forEach(function(t){e&&!(t instanceof TemplateSlotMorph)||t instanceof BlockHighlightMorph||(t.drawNew(),t.changed())}),this.changed()))},SyntaxElementMorph.prototype.setLabelColor=function(t,e,o){this.children.forEach(function(i){i instanceof StringMorph&&!i.isProtectedLabel?(i.shadowOffset=o||i.shadowOffset,i.shadowColor=e||i.shadowColor,i.setColor(t)):(i instanceof MultiArgMorph||i instanceof ArgLabelMorph||i instanceof SymbolMorph&&!i.isProtectedLabel||i instanceof InputSlotMorph&&i.isReadOnly)&&i.setLabelColor(t,e,o)})},SyntaxElementMorph.prototype.flash=function(){this.cachedNormalColor||(this.cachedNormalColor=this.color,this.setColor(this.activeHighlight))},SyntaxElementMorph.prototype.unflash=function(){if(this.cachedNormalColor){var t=this.cachedNormalColor;this.cachedNormalColor=null,this.setColor(t)}},SyntaxElementMorph.prototype.fixBlockColor=function(t,e){this.children.forEach(function(o){o instanceof SyntaxElementMorph&&o.fixBlockColor(t,e)})},SyntaxElementMorph.prototype.labelPart=function(t){var e,o;if("%"===t[0]&&t.length>1&&("reportGetVar"!==this.selector||"%turtleOutline"===t&&this.isObjInputFragment())){if(t.length>5&&"%mult"===t.slice(0,5))return(e=new MultiArgMorph(t.slice(5))).addInput(),e;switch(t){case"%imgsource":(e=new InputSlotMorph(null,!1,{"pen trails":["pen trails"],"stage image":["stage image"]},!0)).setContents(["pen trails"]);break;case"%inputs":(e=new MultiArgMorph("%s","with inputs")).isStatic=!1,e.canBeEmpty=!1;break;case"%scriptVars":(e=new MultiArgMorph("%t",null,1,t)).canBeEmpty=!1;break;case"%blockVars":(e=new MultiArgMorph("%t","block variables",0,t)).canBeEmpty=!1;break;case"%parms":(e=new MultiArgMorph("%t","Input Names:",0,t)).canBeEmpty=!1;break;case"%ringparms":e=new MultiArgMorph("%t","input names:",0,t);break;case"%cmdRing":(e=new RingMorph).color=SpriteMorph.prototype.blockColor.other,e.selector="reifyScript",e.setSpec("%rc %ringparms"),e.isDraggable=!0;break;case"%repRing":(e=new RingMorph).color=SpriteMorph.prototype.blockColor.other,e.selector="reifyReporter",e.setSpec("%rr %ringparms"),e.isDraggable=!0,e.isStatic=!0;break;case"%predRing":(e=new RingMorph(!0)).color=SpriteMorph.prototype.blockColor.other,e.selector="reifyPredicate",e.setSpec("%rp %ringparms"),e.isDraggable=!0,e.isStatic=!0;break;case"%words":(e=new MultiArgMorph("%s",null,0)).addInput(),e.addInput(),e.isStatic=!1;break;case"%exp":(e=new MultiArgMorph("%s",null,0)).addInput(),e.isStatic=!0,e.canBeEmpty=!1;break;case"%br":(e=new Morph).setExtent(new Point(0,0)),e.isBlockLabelBreak=!0,e.getSpec=function(){return"%br"};break;case"%inputName":(e=new ReporterBlockMorph).category="variables",e.color=SpriteMorph.prototype.blockColor.variables,e.setSpec(localize("Input name"));break;case"%s":e=new InputSlotMorph;break;case"%anyUE":(e=new InputSlotMorph).isUnevaluated=!0;break;case"%txt":(e=new InputSlotMorph).minWidth=1.7*e.height(),e.fixLayout();break;case"%mlt":(e=new TextSlotMorph).fixLayout();break;case"%code":(e=new TextSlotMorph).contents().fontName="monospace",e.contents().fontStyle="monospace",e.fixLayout();break;case"%obj":e=new ArgMorph("object");break;case"%n":e=new InputSlotMorph(null,!0);break;case"%dir":(e=new InputSlotMorph(null,!0,{"(90) right":90,"(-90) left":-90,"(0) up":"0","(180) down":180})).setContents(90);break;case"%note":e=new InputSlotMorph(null,!0,"pianoKeyboardMenu",!1);break;case"%inst":(e=new InputSlotMorph(null,!0,{"(1) sine":1,"(2) square":2,"(3) sawtooth":3,"(4) triangle":4})).setContents(1);break;case"%month":e=new InputSlotMorph(null,!1,{January:["January"],February:["February"],March:["March"],April:["April"],May:["May"],June:["June"],July:["July"],August:["August"],September:["September"],October:["October"],November:["November"],December:["December"]},!0);break;case"%interaction":(e=new InputSlotMorph(null,!1,{clicked:["clicked"],pressed:["pressed"],dropped:["dropped"],"mouse-entered":["mouse-entered"],"mouse-departed":["mouse-departed"]},!0)).isStatic=!0;break;case"%dates":(e=new InputSlotMorph(null,!1,{year:["year"],month:["month"],date:["date"],"day of week":["day of week"],hour:["hour"],minute:["minute"],second:["second"],"time in milliseconds":["time in milliseconds"]},!0)).setContents(["date"]);break;case"%delim":e=new InputSlotMorph(null,!1,{letter:["letter"],whitespace:["whitespace"],line:["line"],tab:["tab"],cr:["cr"],csv:["csv"]},!1);break;case"%ida":(e=new InputSlotMorph(null,!0,{1:1,last:["last"],"~":null,all:["all"]})).setContents(1);break;case"%idx":(e=new InputSlotMorph(null,!0,{1:1,last:["last"],any:["any"]})).setContents(1);break;case"%spr":e=new InputSlotMorph(null,!1,"objectsMenu",!0);break;case"%col":e=new InputSlotMorph(null,!1,"collidablesMenu",!0);break;case"%dst":e=new InputSlotMorph(null,!1,"distancesMenu",!0);break;case"%cln":e=new InputSlotMorph(null,!1,"clonablesMenu",!0);break;case"%get":(e=new InputSlotMorph(null,!1,"gettablesMenu",!0)).isStatic=!0;break;case"%cst":e=new InputSlotMorph(null,!1,"costumesMenu",!0);break;case"%eff":(e=new InputSlotMorph(null,!1,{color:["color"],fisheye:["fisheye"],whirl:["whirl"],pixelate:["pixelate"],mosaic:["mosaic"],duplicate:["duplicate"],negative:["negative"],comic:["comic"],confetti:["confetti"],saturation:["saturation"],brightness:["brightness"],ghost:["ghost"]},!0)).setContents(["ghost"]);break;case"%snd":e=new InputSlotMorph(null,!1,"soundsMenu",!0);break;case"%key":(e=new InputSlotMorph(null,!1,{"any key":["any key"],"up arrow":["up arrow"],"down arrow":["down arrow"],"right arrow":["right arrow"],"left arrow":["left arrow"],space:["space"],a:["a"],b:["b"],c:["c"],d:["d"],e:["e"],f:["f"],g:["g"],h:["h"],i:["i"],j:["j"],k:["k"],l:["l"],m:["m"],n:["n"],o:["o"],p:["p"],q:["q"],r:["r"],s:["s"],t:["t"],u:["u"],v:["v"],w:["w"],x:["x"],y:["y"],z:["z"],0:["0"],1:["1"],2:["2"],3:["3"],4:["4"],5:["5"],6:["6"],7:["7"],8:["8"],9:["9"]},!0)).setContents(["space"]);break;case"%keyHat":(e=this.labelPart("%key")).isStatic=!0;break;case"%msg":e=new InputSlotMorph(null,!1,"messagesMenu",!0);break;case"%msgHat":(e=new InputSlotMorph(null,!1,"messagesReceivedMenu",!0)).isStatic=!0;break;case"%att":e=new InputSlotMorph(null,!1,"attributesMenu",!0);break;case"%fun":(e=new InputSlotMorph(null,!1,{abs:["abs"],ceiling:["ceiling"],floor:["floor"],sqrt:["sqrt"],sin:["sin"],cos:["cos"],tan:["tan"],asin:["asin"],acos:["acos"],atan:["atan"],ln:["ln"],log:["log"],"e^":["e^"],"10^":["10^"]},!0)).setContents(["sqrt"]);break;case"%txtfun":(e=new InputSlotMorph(null,!1,{"encode URI":["encode URI"],"decode URI":["decode URI"],"encode URI component":["encode URI component"],"decode URI component":["decode URI component"],"XML escape":["XML escape"],"XML unescape":["XML unescape"],"hex sha512 hash":["hex sha512 hash"]},!0)).setContents(["encode URI"]);break;case"%stopChoices":(e=new InputSlotMorph(null,!1,{all:["all"],"this script":["this script"],"this block":["this block"],"all but this script":["all but this script"],"other scripts in sprite":["other scripts in sprite"]},!0)).setContents(["all"]),e.isStatic=!0;break;case"%typ":(e=new InputSlotMorph(null,!1,"typesMenu",!0)).setContents(["number"]);break;case"%mapValue":(e=new InputSlotMorph(null,!1,{String:["String"],Number:["Number"],true:["true"],false:["false"]},!0)).setContents(["String"]),e.isStatic=!0;break;case"%var":(e=new InputSlotMorph(null,!1,"getVarNamesDict",!0)).isStatic=!0;break;case"%shd":e=new InputSlotMorph(null,!1,"shadowedVariablesMenu",!0);break;case"%lst":e=new InputSlotMorph(null,!1,{list1:"list1",list2:"list2",list3:"list3"},!0);break;case"%codeKind":(e=new InputSlotMorph(null,!1,{code:["code"],header:["header"]},!0)).setContents(["code"]);break;case"%l":e=new ArgMorph("list");break;case"%b":e=new BooleanSlotMorph;break;case"%boolUE":(e=new BooleanSlotMorph).isUnevaluated=!0;break;case"%bool":(e=new BooleanSlotMorph(!0)).isStatic=!0;break;case"%cmd":e=new CommandSlotMorph;break;case"%rc":(e=new RingCommandSlotMorph).isStatic=!0;break;case"%rr":(e=new RingReporterSlotMorph).isStatic=!0;break;case"%rp":(e=new RingReporterSlotMorph(!0)).isStatic=!0;break;case"%c":(e=new CSlotMorph).isStatic=!0;break;case"%cs":e=new CSlotMorph;break;case"%cl":(e=new CSlotMorph).isStatic=!0,e.isLambda=!0;break;case"%clr":(e=new ColorSlotMorph).isStatic=!0;break;case"%t":e=new TemplateSlotMorph("a");break;case"%upvar":e=new TemplateSlotMorph("↑");break;case"%f":e=new FunctionSlotMorph;break;case"%r":e=new ReporterSlotMorph;break;case"%p":e=new ReporterSlotMorph(!0);break;case"%codeListPart":e=new InputSlotMorph(null,!1,{list:["list"],item:["item"],delimiter:["delimiter"]},!0);break;case"%codeListKind":e=new InputSlotMorph(null,!1,{collection:["collection"],variables:["variables"],parameters:["parameters"]},!0);break;case"%turtle":(e=new SymbolMorph("turtle")).size=1.2*this.fontSize,e.color=new Color(255,255,255),e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew();break;case"%turtleOutline":(e=new SymbolMorph("turtleOutline")).size=this.fontSize,e.color=new Color(255,255,255),e.isProtectedLabel=!0,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew();break;case"%clockwise":(e=new SymbolMorph("turnRight")).size=1.5*this.fontSize,e.color=new Color(255,255,255),e.isProtectedLabel=!1,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew();break;case"%counterclockwise":(e=new SymbolMorph("turnLeft")).size=1.5*this.fontSize,e.color=new Color(255,255,255),e.isProtectedLabel=!1,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew();break;case"%greenflag":(e=new SymbolMorph("flag")).size=1.5*this.fontSize,e.color=new Color(0,200,0),e.isProtectedLabel=!0,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew();break;case"%stop":(e=new SymbolMorph("octagon")).size=1.5*this.fontSize,e.color=new Color(200,0,0),e.isProtectedLabel=!0,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew();break;case"%pause":(e=new SymbolMorph("pause")).size=this.fontSize,e.color=new Color(255,220,0),e.isProtectedLabel=!0,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew();break;default:nop()}}else"$"===t[0]&&t.length>1&&"reportGetVar"!==this.selector?(o=t.slice(1).split("-"),contains(SymbolMorph.prototype.names,o[0])?(e=new SymbolMorph(o[0])).size=this.fontSize*(+o[1]||1.2):((e=new StringMorph(o[0])).fontName=this.labelFontName,e.fontStyle=this.labelFontStyle,e.fontSize=this.fontSize*(+o[1]||1)),e.color=new Color(0==+o[2]?0:+o[2]||255,0==+o[3]?0:+o[3]||255,0==+o[4]?0:+o[4]||255),e.isProtectedLabel=o.length>2,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew()):e=new StringMorph(t,this.fontSize,this.labelFontStyle,!0,!1,!1,MorphicPreferences.isFlat?new Point:this.embossing,this.color.darker(this.labelContrast),new Color(255,255,255),this.labelFontName);return e},SyntaxElementMorph.prototype.isObjInputFragment=function(){return"reportGetVar"===this.selector&&"%t"===this.getSlotSpec()&&"%obj"===this.parent.fragment.type},SyntaxElementMorph.prototype.fixLayout=function(t){var e,o,i,r,n,s=this.parts(),a=this,h=0,l=0,p=0,c=this.minWidth,d=[],u=[],g=this.isPrototype?1:Math.floor(fontHeight(this.fontSize)/3),f=this.isCustomBlock&&!this.isGlobal?this.methodIconExtent().x+g:0,m=this.extent();if(this instanceof MultiArgMorph&&"%c"!==this.slotSpec?c+=this.arrows().width():c+=this instanceof ReporterBlockMorph?2*this.rounding+2*this.edge:4*this.corner+2*this.edge+3*this.inset+this.dent,this.nextBlock&&(e=this.nextBlock()),s.forEach(function(t){t instanceof CSlotMorph||"%c"===t.slotSpec?d.length>0?(u.push(d),u.push([t]),d=[],h=0):u.push([t]):t instanceof BlockHighlightMorph?nop():(t.isVisible&&(h+=t.fullBounds().width()+g),(h>a.labelWidth||t.isBlockLabelBreak)&&d.length>0&&(u.push(d),d=[],h=t.fullBounds().width()+g),d.push(t),t.isBlockLabelBreak&&(h=0))}),d.length>0&&u.push(d),this instanceof CommandBlockMorph?(o=this.top()+this.corner+this.edge,this instanceof HatBlockMorph&&(o+=this.hatHeight)):this instanceof ReporterBlockMorph?o=this.top()+2*this.edge:(this instanceof MultiArgMorph||this instanceof ArgLabelMorph)&&(o=this.top()),u.forEach(function(t){h=a.left()+f+a.edge+a.labelPadding,a instanceof RingMorph?h=a.left()+g:a.isPredicate?h=a.left()+f+a.rounding:(a instanceof MultiArgMorph||a instanceof ArgLabelMorph)&&(h=a.left()),o+=l,l=0,t.forEach(function(t){t instanceof CSlotMorph?(h-=a.labelPadding,a.isPredicate&&(h=a.left()+f+a.rounding),t.setColor(a.color),t.setPosition(new Point(h,o)),l=t.height()):(t.setPosition(new Point(h,o)),t.isBlockLabelBreak||("%c"===t.slotSpec?h+=t.width():t.isVisible&&(h+=t.fullBounds().width()+g)),p=Math.max(p,h),l=Math.max(l,t instanceof StringMorph?t.rawHeight():t.height()))}),t.forEach(function(t){t.moveBy(new Point(0,Math.floor((l-t.height())/2)))})}),o+=l,this.children.some(function(t){return t instanceof CSlotMorph})&&(n=this.bottomPadding,this instanceof ReporterBlockMorph&&!this.isPredicate&&(n=Math.max(this.bottomPadding,this.rounding-this.bottomPadding)),o+=n),this instanceof CommandBlockMorph?i=o-this.top()+2*this.corner:this instanceof ReporterBlockMorph?i=o-this.top()+2*this.edge:(this instanceof MultiArgMorph||this instanceof ArgLabelMorph)&&(i=o-this.top()),this.isPredicate?c=Math.max(c,p-this.left()+this.rounding):this instanceof MultiArgMorph||this instanceof ArgLabelMorph?c=Math.max(c,p-this.left()-g):(c=Math.max(c,p-this.left()+this.labelPadding-this.edge),s[s.length-1]instanceof MultiArgMorph&&1===u.length&&(c-=g),this instanceof HatBlockMorph&&(c=Math.max(c,1.5*this.hatWidth))),this.silentSetExtent(new Point(c,i)),s.forEach(function(t){t instanceof CSlotMorph&&(a.isPredicate?t.setWidth(c-f-2*a.rounding):t.setWidth(c-a.edge-f))}),t||this.drawNew(),e&&e.setPosition(new Point(this.left(),this.bottom()-this.corner)),this instanceof CommandBlockMorph){if(this.height()!==m.y&&(r=this.parentThatIsA(CommandSlotMorph))&&r.fixLayout(),this.width()!==m.x&&(r=this.parentThatIsAnyOf([ReporterBlockMorph,CommandSlotMorph,RingCommandSlotMorph]))&&r.fixLayout(),r)return}else if(this instanceof ReporterBlockMorph&&this.parent&&this.parent.fixLayout)return this.parent.fixLayout();this.fixHighlight()},SyntaxElementMorph.prototype.fixHighlight=function(){var t=this.topBlock();t.getHighlight&&t.getHighlight()&&t.addHighlight(t.removeHighlight())},SyntaxElementMorph.prototype.methodIconExtent=function(){var t=1.2*this.fontSize;return this.isCustomBlock&&!this.isGlobal?new Point(.66*t,t):new Point(0,0)},SyntaxElementMorph.prototype.evaluate=function(){return null},SyntaxElementMorph.prototype.isEmptySlot=function(){return!1},SyntaxElementMorph.prototype.showBubble=function(t,e,o){var i,r,n,s,a=!1,h=this.parentThatIsA(IDE_Morph),l=this,p=this.rightCenter().add(new Point(2,0)),c=this.parentThatIsA(ScrollFrameMorph),d=this.world();if(void 0===t||!d)return null;t instanceof ListWatcherMorph?((s=t).update(!0),s.step=t.update,s.isDraggable=!1,s.expand(this.parentThatIsA(ScrollFrameMorph).extent()),a=!0):t instanceof TableFrameMorph?((s=t).isDraggable=!1,s.expand(this.parentThatIsA(ScrollFrameMorph).extent()),a=!0):t instanceof Morph?isSnapObject(t)?(n=t.thumbnail(new Point(40,40)),(s=new Morph).silentSetWidth(n.width),s.silentSetHeight(n.height),s.image=n,s.version=t.version,s.step=function(){this.version!==t.version&&(n=t.thumbnail(new Point(40,40)),this.image=n,this.version=t.version,this.changed())}):(n=t.fullImage(),(s=new Morph).silentSetWidth(n.width),s.silentSetHeight(n.height),s.image=n):t instanceof Costume?(n=t.thumbnail(new Point(40,40)),(s=new Morph).silentSetWidth(n.width),s.silentSetHeight(n.height),s.image=n):t instanceof Sound?s=new SymbolMorph("notes",30):t instanceof Context?(n=t.image(),(s=new Morph).silentSetWidth(n.width),s.silentSetHeight(n.height),s.image=n):"boolean"==typeof t?s=SpriteMorph.prototype.booleanMorph.call(null,t):isString(t)?(r=t.length>500?t.slice(0,500)+"...":t,s=new TextMorph(r,this.fontSize)):null===t?s=new TextMorph("",this.fontSize):0===t?s=new TextMorph("0",this.fontSize):t.toString&&(s=new TextMorph(t.toString(),this.fontSize)),h&&h.currentSprite!==o&&(o instanceof StageMorph?l=h.corral.stageIcon:(o.isTemporary&&(o=detect(o.allExemplars(),function(t){return!t.isTemporary})),l=detect(h.corral.frame.contents.children,function(t){return t.object===o})),p=l.center()),(i=new SpeechBubbleMorph(s,null,Math.max(this.rounding-2,6),0)).popUp(d,p,a),e&&this.exportPictureWithResult(i),l instanceof SpriteIconMorph?i.keepWithin(h.corral):c&&i.keepWithin(c)},SyntaxElementMorph.prototype.exportPictureWithResult=function(t){var e=this.parentThatIsA(IDE_Morph),o=this.fullImage(),i=t.fullImageClassic(),r=Math.max(0,i.height-o.height),n=newCanvas(new Point(o.width+i.width+2,o.height+r)),s=n.getContext("2d");s.drawImage(o,0,n.height-o.height),s.drawImage(i,o.width+2,0),e.saveCanvasAs(n,(e.projectName||localize("untitled"))+" "+localize("script pic"))},SyntaxElementMorph.prototype.mappedCode=function(t){var e=this.evaluate();return e instanceof BlockMorph?e.mappedCode(t):e},SyntaxElementMorph.prototype.startLayout=function(){this.topBlock().fullChanged(),Morph.prototype.trackChanges=!1},SyntaxElementMorph.prototype.endLayout=function(){Morph.prototype.trackChanges=!0,this.topBlock().fullChanged()},BlockMorph.prototype=new SyntaxElementMorph,BlockMorph.prototype.constructor=BlockMorph,BlockMorph.uber=SyntaxElementMorph.prototype,BlockMorph.prototype.isCachingInputs=!0,BlockMorph.prototype.zebraContrast=40,BlockMorph.prototype.snapSound=null,BlockMorph.prototype.toggleSnapSound=function(){null!==this.snapSound?this.snapSound=null:(BlockMorph.prototype.snapSound=document.createElement("audio"),BlockMorph.prototype.snapSound.src="click.wav"),CommentMorph.prototype.snapSound=BlockMorph.prototype.snapSound},BlockMorph.prototype.init=function(t){this.selector=null,this.blockSpec="",this.comment=null,this.instantiationSpec=null,this.category=null,this.isCorpse=!1,BlockMorph.uber.init.call(this,t),this.color=new Color(0,17,173),this.cachedInputs=null},BlockMorph.prototype.scriptTarget=function(){var t,e=this.parentThatIsA(ScriptsMorph);if(e)return e.scriptTarget();if(t=this.parentThatIsA(IDE_Morph))return t.currentSprite;throw new Error("script target cannot be found for orphaned block")},BlockMorph.prototype.toString=function(){return"a "+(this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])+' ("'+this.blockSpec.slice(0,30)+'...")'},BlockMorph.prototype.parseSpec=function(t){function e(t){"%"===t[0]&&t.length>1?(""!==r&&(i.push(r),r=""),i.push(t)):""!==r?r+=" "+t:r=t}var o,i=[],r="";return 0===(o=isString(t)?t.split(" "):[]).length&&(o=[t]),this.labelWordWrap?o:(o.forEach(function(t){e(t)}),""!==r&&i.push(r),i)},BlockMorph.prototype.setSpec=function(t,e,o){var i,r=this,n=-1;t&&(this.parts().forEach(function(t){t.destroy()}),this.isPrototype&&this.add(this.placeHolder()),this.parseSpec(t).forEach(function(t){"%"===t[0]&&(n+=1),isNil(i=r.labelPart(t))||(r.add(i),i instanceof CommandSlotMorph||i instanceof StringMorph||i.drawNew(),i instanceof RingMorph&&i.fixBlockColor(),(i instanceof MultiArgMorph||i.constructor===CommandSlotMorph||i.constructor===RingCommandSlotMorph)&&i.fixLayout(),r.isPrototype&&r.add(r.placeHolder()),i instanceof InputSlotMorph&&r.isCustomBlock&&i.setChoices.apply(i,(o||r.definition).inputOptionsOfIdx(n)))}),this.blockSpec=t,this.fixLayout(e),this.cachedInputs=null)},BlockMorph.prototype.userSetSpec=function(t){var e=this.topBlock();e.fullChanged(),this.setSpec(t),e.fullChanged()},BlockMorph.prototype.buildSpec=function(){var t=this;this.blockSpec="",this.parts().forEach(function(e){e instanceof StringMorph?t.blockSpec+=e.text:e instanceof ArgMorph?t.blockSpec+=e.getSpec():e.isBlockLabelBreak?t.blockSpec+=e.getSpec():t.blockSpec+="[undefined]",t.blockSpec+=" "}),this.blockSpec=this.blockSpec.trim()},BlockMorph.prototype.rebuild=function(t){this.setSpec(this.blockSpec),t&&this.inputs().forEach(function(e){e instanceof ReporterBlockMorph&&(e.setColor(e.color.lighter(t)),e.setSpec(e.blockSpec))})},BlockMorph.prototype.userMenu=function(){function t(t,e,o,i,r){n.addItem((o?"☑ ":"☐ ")+localize(t),e,o?i:r)}var e,o,i,r,n=new MenuMorph(this),s=this.world(),a=this,h=16===s.currentKey,l=this.activeProcess(),p=l&&l.context&&l.context.outerContext?l.context.outerContext.variables.names():[];return n.addItem("help...","showHelp"),h&&(r=this.topBlock())instanceof ReporterBlockMorph&&n.addItem("script pic with result...",function(){r.exportResultPic()},"open a new window\nwith a picture of both\nthis script and its result",new Color(100,0,0)),this.isTemplate?(this.parent instanceof SyntaxElementMorph?"reportGetVar"===this.selector&&(n.addLine(),n.addItem("rename...",function(){a.refactorThisVar(!0)},"rename only\nthis reporter"),n.addItem("rename all...","refactorThisVar","rename all blocks that\naccess this variable")):("reportGetVar"===this.selector?(i=this.scriptTarget(),this.isInheritedVariable(!1)?t("inherited",function(){i.toggleInheritedVariable(a.blockSpec)},!0,"uncheck to\ndisinherit",null):(this.isInheritedVariable(!0)&&t("inherited",function(){i.toggleInheritedVariable(a.blockSpec)},!1,null,localize("check to inherit\nfrom")+" "+i.exemplar.name),t("transient","toggleTransientVariable",a.isTransientVariable(),"uncheck to save contents\nin the project","check to prevent contents\nfrom being saved"),n.addLine(),n.addItem("rename...",function(){a.refactorThisVar(!0)},"rename only\nthis reporter"),n.addItem("rename all...","refactorThisVar","rename all blocks that\naccess this variable"))):"evaluateCustomBlock"!==this.selector&&n.addItem("hide","hidePrimitive"),StageMorph.prototype.enableInheritance&&(i=this.scriptTarget(),(o={xPosition:"x position",yPosition:"y position",direction:"direction",getScale:"size",getCostumeIdx:"costume #"}[this.selector])&&i&&i.exemplar&&(n.addLine(),t("inherited",function(){i.toggleInheritanceForAttribute(o)},i.inheritsAttribute(o),"uncheck to\ndisinherit",localize("check to inherit\nfrom")+" "+i.exemplar.name))),StageMorph.prototype.enableCodeMapping&&(n.addLine(),n.addItem("header mapping...","mapToHeader"),n.addItem("code mapping...","mapToCode"))),n):(n.addLine(),"reportGetVar"===this.selector?n.addItem("rename...",function(){var t=a.fullCopy();t.addShadow(),new DialogBoxMorph(a,a.userSetSpec,a).prompt("Variable name",a.blockSpec,s,t.fullImage(),InputSlotMorph.prototype.getVarNamesDict.call(a))},"rename only\nthis reporter"):SpriteMorph.prototype.blockAlternatives[this.selector]?n.addItem("relabel...",function(){a.relabel(SpriteMorph.prototype.blockAlternatives[a.selector])}):this.isCustomBlock&&this.alternatives&&(e=this.alternatives()).length>0&&n.addItem("relabel...",function(){a.relabel(e)}),n.addItem("duplicate",function(){var t=a.fullCopy(),e=a.parentThatIsA(IDE_Morph),o=a.parentThatIsA(BlockEditorMorph);t.pickUp(s),!e&&o&&(e=o.target.parentThatIsA(IDE_Morph)),e&&(s.hand.grabOrigin={origin:e.palette,position:e.palette.center()})},"make a copy\nand pick it up"),this instanceof CommandBlockMorph&&this.nextBlock()&&n.addItem((l?this.fullCopy():this).thumbnail(.5,60),function(){var t=a.fullCopy(),e=t.nextBlock(),o=a.parentThatIsA(IDE_Morph),i=a.parentThatIsA(BlockEditorMorph);e&&e.destroy(),t.pickUp(s),!o&&i&&(o=i.target.parentThatIsA(IDE_Morph)),o&&(s.hand.grabOrigin={origin:o.palette,position:o.palette.center()})},"only duplicate this block"),n.addItem("delete","userDestroy"),n.addItem("script pic...",function(){var t=a.parentThatIsA(IDE_Morph)||a.parentThatIsA(BlockEditorMorph).target.parentThatIsA(IDE_Morph);t.saveCanvasAs(a.topBlock().scriptPic(),(t.projectName||localize("untitled"))+" "+localize("script pic"))},"open a new window\nwith a picture of this script"),h&&n.addItem("download script",function(){var t=a.parentThatIsA(IDE_Morph),e=a.parentThatIsA(BlockEditorMorph);!t&&e&&(t=e.target.parentThatIsA(IDE_Morph)),t&&t.saveXMLAs(t.serializer.serialize(a),a.selector+" script",!1)},"download this script\nas an XML file",new Color(100,0,0)),l?(p.length&&(n.addLine(),p.forEach(function(t){n.addItem(t+"...",function(){l.doShowVar(t)})})),l.homeContext.variables.names().forEach(function(t){contains(p,t)||n.addItem(t+"...",function(){l.doShowVar(t)})}),n):this.parent.parentThatIsA(RingMorph)?(n.addLine(),n.addItem("unringify","unringify"),r=this.topBlock(),!(this instanceof ReporterBlockMorph)&&r instanceof HatBlockMorph||n.addItem("ringify","ringify"),n):this.parent instanceof ReporterSlotMorph||this.parent instanceof CommandSlotMorph||this instanceof HatBlockMorph||this instanceof CommandBlockMorph&&this.topBlock()instanceof HatBlockMorph?n:(n.addLine(),n.addItem("ringify","ringify"),StageMorph.prototype.enableCodeMapping&&(n.addLine(),n.addItem("header mapping...","mapToHeader"),n.addItem("code mapping...","mapToCode")),n))},BlockMorph.prototype.developersMenu=function(){var t=BlockMorph.uber.developersMenu.call(this);return t.addLine(),t.addItem("delete block","deleteBlock"),t.addItem("spec...",function(){new DialogBoxMorph(this,this.userSetSpec,this).prompt(t.title+"\nspec",this.blockSpec,this.world())}),t},BlockMorph.prototype.hidePrimitive=function(){var t,e=this.parentThatIsA(IDE_Morph);e&&(StageMorph.prototype.hiddenPrimitives[this.selector]=!0,"lists"===(t={doWarp:"control",reifyScript:"operators",reifyReporter:"operators",reifyPredicate:"operators",doDeclareVariables:"variables"}[this.selector]||this.category)&&(t="variables"),e.flushBlocksCache(t),e.refreshPalette())},BlockMorph.prototype.isInheritedVariable=function(t){return!!(this.isTemplate&&"reportGetVar"===this.selector&&this.parent instanceof FrameMorph)&&contains(this.scriptTarget().inheritedVariableNames(t),this.blockSpec)},BlockMorph.prototype.isTransientVariable=function(){var t=this.scriptTarget().variables.silentFind(this.blockSpec);return!!t&&t.vars[this.blockSpec].isTransient},BlockMorph.prototype.toggleTransientVariable=function(){var t=this.scriptTarget().variables.silentFind(this.blockSpec);t&&(t.vars[this.blockSpec].isTransient=!t.vars[this.blockSpec].isTransient)},BlockMorph.prototype.deleteBlock=function(){var t,e,o=this.parentThatIsA(ScriptsMorph),i=this.nextBlock?this.nextBlock():null;o&&(i&&o.add(i),this.inputs().forEach(function(t){t instanceof BlockMorph&&o.add(t)})),this instanceof ReporterBlockMorph&&(this.parent instanceof BlockMorph||this.parent instanceof MultiArgMorph||this.parent instanceof ReporterSlotMorph)?this.parent.revertToDefaultInput(this):this.parent&&this.parent.fixLayout?t=this.parentThatIsA(ArgMorph):e=!0,this.destroy(),e&&(this.isCorpse=!0),t&&t.fixLayout()},BlockMorph.prototype.ringify=function(){var t,e,o,i=this.selectForEdit();if(i!==this)return this.ringify.call(i);if(t=new RingMorph,e=this.topBlock(),o=e.fullBounds().center(),null===this.parent)return null;if(e.fullChanged(),this.parent instanceof SyntaxElementMorph){if(this instanceof ReporterBlockMorph)this.parent.silentReplaceInput(this,t),t.embed(this);else if(e){if(e instanceof HatBlockMorph)return;e.parent.add(t),t.embed(e),t.setCenter(o)}}else this.parent.add(t),t.embed(this),t.setCenter(o);this.fixBlockColor(null,!0),e.fullChanged()},BlockMorph.prototype.unringify=function(){var t,e,o,i,r,n=this.selectForEdit();return n!==this?this.unringify.call(n):(t=this.parent.parentThatIsA(RingMorph),e=this.topBlock(),i=this.parentThatIsA(ScriptsMorph),null===t?null:(r=t.contents(),o=t.center(),e.fullChanged(),t.parent instanceof SyntaxElementMorph?r instanceof ReporterBlockMorph?t.parent.silentReplaceInput(t,r):i&&(i.add(r),r.setFullCenter(o),r.moveBy(20),t.parent.revertToDefaultInput(t)):(t.parent.add(r),r.setFullCenter(o),t.destroy()),this.fixBlockColor(null,!0),void e.fullChanged()))},BlockMorph.prototype.relabel=function(t){var e,o,i,r=this.selectForEdit();if(r!==this)return this.relabel.call(r,t);e=new MenuMorph(this),o=this.inputs(),i=this,t.forEach(function(t){var r=SpriteMorph.prototype.blockForSelector(t);r.restoreInputs(o),r.fixBlockColor(null,!0),r.addShadow(new Point(3,3)),e.addItem(r,function(){i.setSelector(t)})}),e.popup(this.world(),this.bottomLeft().subtract(new Point(8,this instanceof CommandBlockMorph?this.corner:0)))},BlockMorph.prototype.setSelector=function(t){var e,o,i=this.inputs(),r=this.parentThatIsA(ScriptsMorph);o=SpriteMorph.prototype.blocks[t],this.setCategory(o.category),this.selector=t,this.setSpec(localize(o.spec)),e=this.restoreInputs(i),this.fixLabelColor(),r&&e.length&&e.forEach(function(t){t.moveBy(10),r.add(t)})},BlockMorph.prototype.restoreInputs=function(t){var e,o,i=0,r=[],n=this;for(this.inputs().forEach(function(r){(e=t[i])instanceof ReporterBlockMorph?n.silentReplaceInput(r,e.fullCopy()):e&&r instanceof InputSlotMorph?e.contents&&r.setContents(e.contents().text):e instanceof CSlotMorph&&r instanceof CSlotMorph&&(o=e.nestedBlock())&&r.nestedBlock(o.fullCopy()),i+=1}),i;i<t.length;i+=1)(e=t[i])instanceof ReporterBlockMorph?r.push(e):e instanceof CommandSlotMorph&&(o=e.nestedBlock())&&r.push(o);return this.cachedInputs=null,r},BlockMorph.prototype.showHelp=function(){var t,e,o,i,r,n=this,s=this.parentThatIsA(IDE_Morph),a=new Image,h=this.isCustomBlock?this.definition.helpSpec():this.selector;s||(t=this.parentThatIsA(BlockEditorMorph))&&(s=t.target.parentThatIsA(IDE_Morph)),a.onload=function(){e=newCanvas(new Point(a.width,a.height),!0),(r=e.getContext("2d")).drawImage(a,0,0),(new DialogBoxMorph).inform("Help",null,n.world(),e)},this.isCustomBlock&&this.definition.comment?((i=this.fullCopy()).addShadow(),(o=this.definition.comment.fullCopy()).contents.parse(),e="",o.contents.lines.forEach(function(t){e=e+"\n"+t}),(new DialogBoxMorph).inform("Help",e.substr(1),n.world(),i.fullImage())):a.src=s.resourceURL("help",h+".png")},BlockMorph.prototype.mapToHeader=function(){var t,e,o="reify"===this.selector.substr(0,5)?"reify":this.selector,i=this.codeDefinitionHeader(),r=this;i.addShadow(new Point(3,3)),e=i.fullImageClassic(),t=this.isCustomBlock?"Enter code that corresponds to the block's definition. Use the formal parameter\nnames as shown and <body> to reference the definition body's generated text code.":"Enter code that corresponds to the block's definition. Choose your own\nformal parameter names (ignoring the ones shown).",new DialogBoxMorph(this,function(t){"evaluateCustomBlock"===o?r.definition.codeHeader=t:StageMorph.prototype.codeHeaders[o]=t},this).promptCode("Header mapping","evaluateCustomBlock"===o?this.definition.codeHeader||"":StageMorph.prototype.codeHeaders[o]||"",this.world(),e,t)},BlockMorph.prototype.mapToCode=function(){var t,e="reify"===this.selector.substr(0,5)?"reify":this.selector,o=this.codeMappingHeader(),i=this;o.addShadow(new Point(3,3)),t=o.fullImageClassic(),new DialogBoxMorph(this,function(t){"evaluateCustomBlock"===e?i.definition.codeMapping=t:StageMorph.prototype.codeMappings[e]=t},this).promptCode("Code mapping","evaluateCustomBlock"===e?this.definition.codeMapping||"":StageMorph.prototype.codeMappings[e]||"",this.world(),t,"Enter code that corresponds to the block's operation (usually a single\nfunction invocation). Use <#n> to reference actual arguments as shown.")},BlockMorph.prototype.mapHeader=function(t,e){var o=e||"reify"===this.selector.substr(0,5)?"reify":this.selector;t&&(this.isCustomBlock?this.definition.codeHeader=t:StageMorph.prototype.codeHeaders[o]=t)},BlockMorph.prototype.mapCode=function(t,e){var o=e||"reify"===this.selector.substr(0,5)?"reify":this.selector;t&&(this.isCustomBlock?this.definition.codeMapping=t:StageMorph.prototype.codeMappings[o]=t)},BlockMorph.prototype.mappedCode=function(t){var e,o,i,r,n,s,a,h="reify"===this.selector.substr(0,5)?"reify":this.selector,l=1,p=this.isCustomBlock?this.definition.spec:h,c=t||{},d=[];return e="reportGetVar"===h?this.blockSpec:this.isCustomBlock?this.definition.codeMapping||"":StageMorph.prototype.codeMappings[h]||"","reportGetVar"===h||c.hasOwnProperty(p)||(c[p]=null,this.isCustomBlock?(-1!==(i=this.definition.codeHeader||"").indexOf("<body")&&(s="",this.definition.body&&(s=this.definition.body.expression.mappedCode(c)),a=s.split("\n"),(n=i.split("\n")).forEach(function(t,e){var o,i="";0===t.trimLeft().indexOf("<body")&&(o=t.indexOf("<body"),i=t.slice(0,o)),n[e]=t.replace(new RegExp("<body>"),a.join("\n"+i)),n[e]=n[e].replace(new RegExp("<body>","g"),a.join("\n"))}),i=n.join("\n")),c[p]=i):c[p]=StageMorph.prototype.codeHeaders[p]),o=e.split("\n"),this.inputs().forEach(function(t){d.push(t.mappedCode(c).toString())}),d.forEach(function(t){var e=t.split("\n"),i="<#"+l+">",r=new RegExp(i,"g");o.forEach(function(t,n){var s,a="";0===t.trimLeft().indexOf(i)&&(s=t.indexOf(i),a=t.slice(0,s)),o[n]=t.replace(new RegExp(i),e.join("\n"+a)),o[n]=o[n].replace(r,e.join("\n"))}),l+=1}),e=o.join("\n"),this.nextBlock&&this.nextBlock()&&(e+="\n"+this.nextBlock().mappedCode(c)),!t&&(r=[],Object.keys(c).forEach(function(t){c[t]&&r.push(c[t])}),r.length)?r.join("\n\n")+"\n\n"+e:e},BlockMorph.prototype.codeDefinitionHeader=function(){var t=this.isCustomBlock?new PrototypeHatBlockMorph(this.definition):SpriteMorph.prototype.blockForSelector(this.selector),e=new HatBlockMorph,o=1;return this.isCustomBlock?t:(t.inputs().forEach(function(e){var i=new TemplateSlotMorph("#"+o);t.silentReplaceInput(e,i),o+=1}),t.isPrototype=!0,e.setCategory("control"),e.setSpec("%s"),e.silentReplaceInput(e.inputs()[0],t),"control"===this.category&&e.alternateBlockColor(),e)},BlockMorph.prototype.codeMappingHeader=function(){var t=this.isCustomBlock?this.definition.blockInstance():SpriteMorph.prototype.blockForSelector(this.selector),e=new HatBlockMorph,o=1;return t.inputs().forEach(function(e){var i=new TemplateSlotMorph("<#"+o+">");t.silentReplaceInput(e,i),o+=1}),t.isPrototype=!0,e.setCategory("control"),e.setSpec("%s"),e.silentReplaceInput(e.inputs()[0],t),"control"===this.category&&e.alternateBlockColor(),e},BlockMorph.prototype.refactorThisVar=function(t){var e=this.scriptTarget(),o=this.instantiationSpec||this.blockSpec,i=this.fullCopy();i.addShadow(),new DialogBoxMorph(this,function(i){this.parent instanceof SyntaxElementMorph?this.parentThatIsA(BlockEditorMorph)?this.doRefactorBlockParameter(o,i,t):this.parentThatIsA(RingMorph)?this.doRefactorRingParameter(o,i,t):this.doRefactorScriptVar(o,i,t):e.hasSpriteVariable(o)?this.doRefactorSpriteVar(o,i,t):this.doRefactorGlobalVar(o,i,t)},this).prompt("Variable name",o,this.world(),i.fullImage(),InputSlotMorph.prototype.getVarNamesDict.call(this))},BlockMorph.prototype.varExistsError=function(t,e){t.inform("Variable exists","A variable with this name already exists "+(e||"in this context")+".")},BlockMorph.prototype.doRefactorBlockParameter=function(t,e,o){var i=this.parentThatIsA(BlockInputFragmentMorph),r=i.fragment.copy(),n=i.parent,s=this.parentThatIsA(BlockEditorMorph),a=s.body.contents;n.anyChild(function(t){return t.blockSpec===e})?this.varExistsError(s.target.parentThatIsA(IDE_Morph)):(r.labelString=e,i.updateBlockLabel(r),o||a.children.forEach(function(o){o.refactorVarInStack(t,e)}))},BlockMorph.prototype.doRefactorRingParameter=function(t,e,o){var i=this.parentThatIsA(RingMorph),r=i.contents(),n=this.topBlock();contains(i.inputNames(),e)?this.varExistsError(this.parentThatIsA(IDE_Morph)):(n.fullChanged(),this.setSpec(e),o?n.fullChanged():(r&&r.refactorVarInStack(t,e),n.fullChanged()))},BlockMorph.prototype.doRefactorScriptVar=function(t,e,o){var i,r,n=this.parentThatIsA(CommandBlockMorph);if(n.definesScriptVariable(e))return i=this.scriptTarget(),r=i.parentThatIsA(IDE_Morph),void this.varExistsError(r);this.userSetSpec(e),o||n.refactorVarInStack(t,e,!0)},BlockMorph.prototype.doRefactorSpriteVar=function(t,e,o){var i,r=this.scriptTarget(),n=r.parentThatIsA(IDE_Morph),s=r.findVariableWatcher(t);r.hasSpriteVariable(e)?this.varExistsError(n):isNil(n.globalVariables.vars[e])?(i=r.variables.getVar(t),r.deleteVariable(t),r.addVariable(e,!1),r.variables.setVar(e,i),s&&s.isVisible&&r.toggleVariableWatcher(e,!1).setPosition(s.position()),o||(r.refactorVariableInstances(t,e,!1),r.customBlocks.forEach(function(o){o.body.expression.refactorVarInStack(t,e)})),n.flushBlocksCache("variables"),n.refreshPalette()):this.varExistsError(n,"as a global variable")},BlockMorph.prototype.doRefactorGlobalVar=function(t,e,o){var i,r=this.scriptTarget(),n=r.parentThatIsA(IDE_Morph),s=n?n.stage:null,a=r.findVariableWatcher(t);isNil(n.globalVariables.vars[e])?detect(s.children,function(t){return t instanceof SpriteMorph&&t.hasSpriteVariable(e)})?this.varExistsError(n,"as a sprite local variable"):(i=n.globalVariables.getVar(t),s.deleteVariable(t),s.addVariable(e,!0),n.globalVariables.setVar(e,i),a&&a.isVisible&&r.toggleVariableWatcher(e,!0).setPosition(a.position()),o||(s.refactorVariableInstances(t,e,!0),s.globalBlocks.forEach(function(o){o.body.expression.refactorVarInStack(t,e)}),s.forAllChildren(function(o){o instanceof SpriteMorph&&(o.refactorVariableInstances(t,e,!0),o.customBlocks.forEach(function(o){o.body.expression.refactorVarInStack(t,e)}))})),n.flushBlocksCache("variables"),n.refreshPalette()):this.varExistsError(n)},BlockMorph.prototype.eraseHoles=function(t){var e,o,i=this,r=this instanceof RingMorph,n=.5*this.edge,s=this.parts().filter(function(t){return t.isHole});this.isPredicate&&s.length>0&&(o=this.width()-this.rounding,t.clearRect(o,0,this.width(),this.height()),(e=t.createLinearGradient(o-this.edge,0,this.width(),0)).addColorStop(0,this.color.toString()),e.addColorStop(1,this.dark()),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.moveTo(o-n,this.edge+n),t.lineTo(o-n,this.height()-this.edge-n),t.stroke()),s.forEach(function(e){var o=e.width(),n=Math.floor(e.height())-2;t.clearRect(e.bounds.origin.x-i.bounds.origin.x+1,e.bounds.origin.y-i.bounds.origin.y+1,r?o-2:o+1,n)})},BlockMorph.prototype.addHighlight=function(t){var e,o=!this.isVisible;return o&&this.show(),e=this.highlight(t?t.color:this.activeHighlight,this.activeBlur,this.activeBorder),this.addBack(e),this.fullChanged(),o&&this.hide(),e},BlockMorph.prototype.addErrorHighlight=function(){var t,e=!this.isVisible;return e&&this.show(),this.removeHighlight(),t=this.highlight(this.errorHighlight,this.activeBlur,this.activeBorder),this.addBack(t),this.fullChanged(),e&&this.hide(),t},BlockMorph.prototype.removeHighlight=function(){var t=this.getHighlight();return null!==t&&(this.fullChanged(),this.removeChild(t)),t},BlockMorph.prototype.toggleHighlight=function(){this.getHighlight()?this.removeHighlight():this.addHighlight()},BlockMorph.prototype.highlight=function(t,e,o){var i=new BlockHighlightMorph,r=this.fullBounds(),n=useBlurredShadows&&!MorphicPreferences.isFlat?e:o;return i.setExtent(r.extent().add(2*n)),i.color=t,i.image=useBlurredShadows&&!MorphicPreferences.isFlat?this.highlightImageBlurred(t,e):this.highlightImage(t,o),i.setPosition(r.origin.subtract(new Point(n,n))),i},BlockMorph.prototype.highlightImage=function(t,e){var o,i,r,n,s;return o=this.fullBounds().extent(),i=this.fullImage(),r=newCanvas(o.add(2*e)),(n=r.getContext("2d")).drawImage(i,0,0),n.drawImage(i,e,0),n.drawImage(i,2*e,0),n.drawImage(i,2*e,e),n.drawImage(i,2*e,2*e),n.drawImage(i,e,2*e),n.drawImage(i,0,2*e),n.drawImage(i,0,e),n.globalCompositeOperation="destination-out",n.drawImage(i,e,e),s=newCanvas(o.add(2*e)),(n=s.getContext("2d")).drawImage(r,0,0),n.globalCompositeOperation="source-atop",n.fillStyle=t.toString(),n.fillRect(0,0,s.width,s.height),s},BlockMorph.prototype.highlightImageBlurred=function(t,e){var o,i,r,n;return o=this.fullBounds().extent(),i=this.fullImage(),r=newCanvas(o.add(2*e)),n=r.getContext("2d"),n.shadowBlur=e,n.shadowColor=t.toString(),n.drawImage(i,e,e),n.shadowBlur=0,n.globalCompositeOperation="destination-out",n.drawImage(i,e,e),r},BlockMorph.prototype.getHighlight=function(){var t;return t=this.children.slice(0).reverse().filter(function(t){return t instanceof BlockHighlightMorph}),0!==t.length?t[0]:null},BlockMorph.prototype.outline=function(t,e){var o=new BlockHighlightMorph,i=this.fullBounds(),r=e;return o.setExtent(i.extent().add(2*r)),o.color=t,o.image=this.highlightImage(t,e),o.setPosition(i.origin.subtract(new Point(r,r))),o},BlockMorph.prototype.fixBlockColor=function(t,e){var o,i,r=t;if(this.zebraContrast||e){if(!this.zebraContrast&&e)return this.forceNormalColoring(!0);r||this.parent&&(this.isPrototype?r=null:this instanceof ReporterBlockMorph?r=this.parent.parentThatIsA(BlockMorph):(i=this.parentThatIsA(CommandSlotMorph))&&(r=i.parentThatIsA(BlockMorph))),r?r.category===this.category?r.color.eq(this.color)&&this.alternateBlockColor():this.category&&!this.color.eq(SpriteMorph.prototype.blockColor[this.category])&&this.alternateBlockColor():(o=SpriteMorph.prototype.blockColor[this.category],this.color.eq(o)||this.alternateBlockColor()),e&&this.fixChildrensBlockColor(!0)}},BlockMorph.prototype.forceNormalColoring=function(t){var e=SpriteMorph.prototype.blockColor[this.category];this.setColor(e,t),this.setLabelColor(new Color(255,255,255),e.darker(this.labelContrast),new Point(-1,-1)),this.fixChildrensBlockColor(!0)},BlockMorph.prototype.alternateBlockColor=function(){var t=SpriteMorph.prototype.blockColor[this.category];this.color.eq(t)?this.setColor(this.zebraContrast<0?t.darker(Math.abs(this.zebraContrast)):t.lighter(this.zebraContrast),this.hasLabels()):this.setColor(t,this.hasLabels()),this.fixLabelColor(),this.fixChildrensBlockColor(!0)},BlockMorph.prototype.ghost=function(){this.setColor(SpriteMorph.prototype.blockColor[this.category].lighter(35))},BlockMorph.prototype.fixLabelColor=function(){if(this.zebraContrast>0&&this.category){var t=SpriteMorph.prototype.blockColor[this.category];this.color.eq(t)?this.setLabelColor(new Color(255,255,255),t.darker(this.labelContrast),MorphicPreferences.isFlat?null:new Point(-1,-1)):this.setLabelColor(new Color(0,0,0),t.lighter(this.zebraContrast).lighter(2*this.labelContrast),MorphicPreferences.isFlat?null:new Point(1,1))}},BlockMorph.prototype.fixChildrensBlockColor=function(t){var e=this;this.children.forEach(function(o){o instanceof CommandBlockMorph?o.fixBlockColor(null,t):o instanceof SyntaxElementMorph&&(o.fixBlockColor(e,t),o instanceof BooleanSlotMorph&&o.drawNew())})},BlockMorph.prototype.setCategory=function(t){this.category=t,this.startLayout(),this.fixBlockColor(),this.endLayout()},BlockMorph.prototype.hasLabels=function(){return this.children.some(function(t){return t instanceof StringMorph})},BlockMorph.prototype.fullCopy=function(){var t=BlockMorph.uber.fullCopy.call(this);return t.removeHighlight(),t.isDraggable=!0,this.instantiationSpec&&t.setSpec(this.instantiationSpec),t.allChildren().filter(function(t){return t instanceof SyntaxElementMorph&&(t.cachedInputs=null,t.isCustomBlock&&t.initializeVariables()),!isNil(t.comment)}).forEach(function(t){var e=t.comment.fullCopy();t.comment=e,e.block=t}),t.cachedInputs=null,t},BlockMorph.prototype.reactToTemplateCopy=function(){this.forceNormalColoring()},BlockMorph.prototype.hasBlockVars=function(){return this.anyChild(function(t){return t.isCustomBlock&&t.isGlobal&&t.definition.variableNames.length})},BlockMorph.prototype.mouseClickLeft=function(){var t,e=this.topBlock(),o=e.scriptTarget();return 16!==this.world().currentKey||this.isTemplate?e instanceof PrototypeHatBlockMorph?e.mouseClickLeft():void(o&&(t=o.parentThatIsA(StageMorph))&&t.threads.toggleProcess(e,o)):this.selectForEdit().focus()},BlockMorph.prototype.focus=function(){var t,e=this.parentThatIsA(ScriptsMorph),o=this.world();e&&ScriptsMorph.prototype.enableKeyboard&&(e.focus&&e.focus.stopEditing(),o.stopEditing(),t=new ScriptFocusMorph(e,this),e.focus=t,t.getFocus(o),this instanceof HatBlockMorph&&t.nextCommand())},BlockMorph.prototype.activeProcess=function(){var t,e=this.topBlock(),o=e.scriptTarget();return e instanceof PrototypeHatBlockMorph?null:o&&(t=o.parentThatIsA(StageMorph))?t.threads.findProcess(e,o):null},BlockMorph.prototype.thumbnail=function(t,e){var o,i,r,n,s=this.nextBlock();return s&&(s.isVisible=!1),o=this.fullBounds().extent(),i=newCanvas(new Point(e?Math.min(o.x*t,e):o.x*t,o.y*t)),(r=i.getContext("2d")).scale(t,t),r.drawImage(this.fullImage(),0,0),e&&o.x*t>e&&((n=r.createLinearGradient(i.width/t-12,0,i.width/t,0)).addColorStop(0,"transparent"),n.addColorStop(1,"black"),r.globalCompositeOperation="destination-out",r.fillStyle=n,r.fillRect(i.width/t-12,0,i.width/t,i.height/t)),s&&(s.isVisible=!0),i},BlockMorph.prototype.scriptPic=function(){var t=this.fullImage(),e=this.stackFullBounds(),o=newCanvas(e.extent()),i=o.getContext("2d");return this.allComments().forEach(function(t){i.drawImage(t.fullImageClassic(),t.fullBounds().left()-e.left(),t.top()-e.top())}),i.drawImage(t,0,0),o},BlockMorph.prototype.drawMethodIcon=function(t){var e=this.methodIconExtent(),o=e.x,i=e.y,r=o/2,n=this.edge+this.labelPadding,s=this.edge,a=this.color===SpriteMorph.prototype.blockColor[this.category];this.isPredicate&&(n=this.rounding),this instanceof CommandBlockMorph&&(s+=this.corner),t.fillStyle=a?this.cachedClrBright:this.cachedClrDark,t.beginPath(),t.arc(n+r,s+r,r,radians(-210),radians(30),!1),t.lineTo(n+r,s+i),t.closePath(),t.fill(),t.fillStyle=this.cachedClr,t.beginPath(),t.arc(n+r,s+r,.4*r,radians(0),radians(360),!1),t.closePath(),t.fill()},BlockMorph.prototype.rootForGrab=function(){return this},BlockMorph.prototype.wantsDropOf=function(t){return(t instanceof ArgMorph||t instanceof StringMorph||t instanceof TextMorph)&&!this.isTemplate},BlockMorph.prototype.reactToDropOf=function(t){t.isDraggable=!1,t instanceof InputSlotMorph?t.drawNew():t instanceof MultiArgMorph&&t.fixLayout(),this.fixLayout(),this.buildSpec()},BlockMorph.prototype.situation=function(){if(!(this.parent instanceof TemplateSlotMorph)){var t=this.parentThatIsA(ScriptsMorph);if(t)return{origin:t,position:this.position().subtract(t.position())}}return BlockMorph.uber.situation.call(this)},BlockMorph.prototype.prepareToBeGrabbed=function(t){var e=this;this.allComments().forEach(function(o){o.startFollowing(e,t.world)})},BlockMorph.prototype.justDropped=function(){this.alpha=1,this.allComments().forEach(function(t){t.stopFollowing()})},BlockMorph.prototype.allComments=function(){return this.allChildren().filter(function(t){return!isNil(t.comment)}).map(function(t){return t.comment})},BlockMorph.prototype.destroy=function(t){t?isNil(this.comment)||this.comment.destroy():this.allComments().forEach(function(t){t.destroy()}),BlockMorph.uber.destroy.call(this)},BlockMorph.prototype.stackHeight=function(){var t=this.fullBounds(),e=Math.max(this.allComments().map(function(t){return t.bottom()}))||this.bottom();return Math.max(t.bottom(),e)-t.top()},BlockMorph.prototype.stackFullBounds=function(){var t=this.fullBounds();return this.allComments().forEach(function(e){t.mergeWith(e.bounds)}),t},BlockMorph.prototype.stackWidth=function(){var t=this.fullBounds(),e=Math.max(this.allComments().map(function(t){return t.right()}))||this.right();return Math.max(t.right(),e)-t.left()},BlockMorph.prototype.snap=function(){var t,e,o,i=this.topBlock();i.allComments().forEach(function(t){t.align(i)}),this.getHighlight()&&this!==i&&this.removeHighlight(),i.getHighlight()&&i.addHighlight(i.removeHighlight()),"receiveCondition"===this.selector&&(t=i.scriptTarget())&&(e=t.parentThatIsA(StageMorph))&&(e.enableCustomHatBlocks=!0,e.threads.pauseCustomHatBlocks=!1,(o=e.parentThatIsA(IDE_Morph))&&o.controlBar.stopButton.refresh())},CommandBlockMorph.prototype=new BlockMorph,CommandBlockMorph.prototype.constructor=CommandBlockMorph,CommandBlockMorph.uber=BlockMorph.prototype,CommandBlockMorph.prototype.init=function(t){CommandBlockMorph.uber.init.call(this,t),this.setExtent(new Point(200,100),t),this.partOfCustomCommand=!1,this.exitTag=null},CommandBlockMorph.prototype.blockSequence=function(){var t=this.nextBlock(),e=[this];return t&&(e=e.concat(t.blockSequence())),e},CommandBlockMorph.prototype.bottomBlock=function(){return this.nextBlock()?this.nextBlock().bottomBlock():this},CommandBlockMorph.prototype.nextBlock=function(t){if(!t)return detect(this.children,function(t){return t instanceof CommandBlockMorph&&!t.isPrototype});var e=this.nextBlock(),o=this.parentThatIsA(CommandSlotMorph);this.add(t),e&&t.bottomBlock().nextBlock(e),t.setPosition(new Point(this.left(),this.bottom()-this.corner)),o&&o.fixLayout()},CommandBlockMorph.prototype.topAttachPoint=function(){return new Point(this.dentCenter(),this.top())},CommandBlockMorph.prototype.bottomAttachPoint=function(){return new Point(this.dentCenter(),this.bottom())},CommandBlockMorph.prototype.wrapAttachPoint=function(){var t=detect(this.inputs(),function(t){return t instanceof CSlotMorph});return t&&!t.nestedBlock()?new Point(t.left()+2*t.inset+t.corner,t.top()+2*t.corner):null},CommandBlockMorph.prototype.dentLeft=function(){return this.left()+this.corner+this.inset},CommandBlockMorph.prototype.dentCenter=function(){return this.dentLeft()+this.corner+.5*this.dent},CommandBlockMorph.prototype.attachTargets=function(){var t,e=[];return this instanceof HatBlockMorph||(t=this.topAttachPoint(),this.parent instanceof SyntaxElementMorph||e.push({point:t,element:this,loc:"top",type:"block"}),!ScriptsMorph.prototype.enableNestedAutoWrapping&&this.parentThatIsA(CommandSlotMorph)||e.push({point:t,element:this,loc:"wrap",type:"block"})),this.isStop()||e.push({point:this.bottomAttachPoint(),element:this,loc:"bottom",type:"block"}),e},CommandBlockMorph.prototype.allAttachTargets=function(t){var e=this,o=t||this.parent,i=[];return this instanceof HatBlockMorph&&t.rejectsHats?i:(o.children.filter(function(t){return t!==e&&t instanceof SyntaxElementMorph&&!t.isTemplate}).forEach(function(t){t.forAllChildren(function(t){t.attachTargets&&t.attachTargets().forEach(function(t){i.push(t)})})}),i)},CommandBlockMorph.prototype.closestAttachTarget=function(t){var e,o,i=t||this.parent,r=this.bottomBlock(),n=null,s=Math.max(2*this.corner+this.dent,this.minSnapDistance),a=[],h=1e3;return this instanceof HatBlockMorph||(a.push({point:this.topAttachPoint(),loc:"top"}),(o=this.wrapAttachPoint())&&a.push({point:o,loc:"wrap"})),r.isStop()||a.push({point:r.bottomAttachPoint(),loc:"bottom"}),this.allAttachTargets(i).forEach(function(t){a.forEach(function(o){("wrap"===o.loc&&"wrap"===t.loc||o.loc!==t.loc&&"wrap"!==o.loc&&"wrap"!==t.loc)&&(e=o.point.distanceTo(t.point))<s&&e<h&&(h=e,n=t)})}),n},CommandBlockMorph.prototype.snap=function(t){var e,o,i,r,n,s=this.closestAttachTarget(),a=this.parentThatIsA(ScriptsMorph);if(a.clearDropInfo(),a.lastDroppedBlock=this,null===s)return this.startLayout(),this.fixBlockColor(),this.endLayout(),CommandBlockMorph.uber.snap.call(this),void(t&&a.recordDrop(t.grabOrigin));a.lastDropTarget=s,this.startLayout(),"bottom"===s.loc?("slot"===s.type?(this.removeHighlight(),a.lastNextBlock=s.element.nestedBlock(),s.element.nestedBlock(this)):(a.lastNextBlock=s.element.nextBlock(),s.element.nextBlock(this)),this.isStop()&&(o=this.nextBlock())&&(a.add(o),o.moveBy(this.extent().floorDivideBy(2)),(n=this.parentThatIsA(CommandSlotMorph))&&n.fixLayout())):"top"===s.loc?(s.element.removeHighlight(),i=this.bottomBlock().bottom()-this.bottom(),this.setBottom(s.element.top()+this.corner-i),this.setLeft(s.element.left()),this.bottomBlock().nextBlock(s.element)):"wrap"===s.loc&&(r=detect(this.inputs(),function(t){return t instanceof CSlotMorph}),e=s.element.parent,a.lastWrapParent=e,this.moveBy(s.point.subtract(r.slotAttachPoint())),r.nestedBlock(s.element),e instanceof CommandBlockMorph?e.nextBlock(this):e instanceof CommandSlotMorph&&e.nestedBlock(this),s.element.blockSequence().forEach(function(t){t.fixBlockColor()})),this.fixBlockColor(),this.endLayout(),CommandBlockMorph.uber.snap.call(this),t&&a.recordDrop(t.grabOrigin),this.snapSound&&this.snapSound.play()},CommandBlockMorph.prototype.isStop=function(){return["doStopThis","doStop","doStopBlock","doStopAll","doForever","doReport","removeClone"].indexOf(this.selector)>-1},CommandBlockMorph.prototype.userDestroy=function(){var t=this.selectForEdit();if(t!==this)return this.userDestroy.call(t);if(this.nextBlock())this.userDestroyJustThis();else{var e=this.parentThatIsA(ScriptsMorph),o=this.parentThatIsA(IDE_Morph),i=this.parentThatIsA(SyntaxElementMorph),r=this.parentThatIsA(CSlotMorph);e&&(e.clearDropInfo(),e.lastDroppedBlock=this,e.recordDrop(this.situation()),e.dropRecord.action="delete"),o?o.removeBlock(this):this.destroy(),r&&r.fixLayout(),i&&i.reactToGrabOf(this)}},CommandBlockMorph.prototype.userDestroyJustThis=function(){var t,e,o=this.parentThatIsA(ScriptsMorph),i=this.parentThatIsA(IDE_Morph),r=this.parentThatIsA(CommandSlotMorph),n=this.nextBlock(),s=this.parentThatIsA(SyntaxElementMorph),a=this.parentThatIsA(CSlotMorph);o&&(o.clearDropInfo(),o.lastDroppedBlock=this,o.recordDrop(this.situation()),o.dropRecord.lastNextBlock=n,o.dropRecord.action="delete"),this.topBlock().fullChanged(),this.parent&&(t=this.parent.parentThatIsA(CommandBlockMorph)),t&&t.nextBlock()===this?e=t:r&&r.nestedBlock()===this&&(e=r),i?i.removeBlock(this,!0):this.destroy(!0),n?e instanceof CommandSlotMorph?e.nestedBlock(n):e instanceof CommandBlockMorph?e.nextBlock(n):o.add(n):a&&a.fixLayout(),s&&s.reactToGrabOf(this)},CommandBlockMorph.prototype.drawNew=function(){var t;this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),(t=this.image.getContext("2d")).fillStyle=this.cachedClr,this.drawTop(t),this.drawBody(t),this.drawBottom(t),MorphicPreferences.isFlat?nop():(this.drawTopDentEdge(t,0,0),this.drawBottomDentEdge(t,0,this.height()-this.corner),this.drawLeftEdge(t),this.drawRightEdge(t),this.drawTopLeftEdge(t),this.drawBottomRightEdge(t)),this.isCustomBlock&&!this.isGlobal&&this.drawMethodIcon(t),this.eraseHoles(t)},CommandBlockMorph.prototype.drawBody=function(t){t.fillRect(0,Math.floor(this.corner),this.width(),this.height()-Math.floor(3*this.corner)+1)},CommandBlockMorph.prototype.drawTop=function(t){t.beginPath(),t.arc(this.corner,this.corner,this.corner,radians(-180),radians(-90),!1),this.drawDent(t,0,0),t.arc(this.width()-this.corner,this.corner,this.corner,radians(-90),radians(-0),!1),t.closePath(),t.fill()},CommandBlockMorph.prototype.drawBottom=function(t){var e=this.height()-2*this.corner;t.beginPath(),t.arc(this.corner,e,this.corner,radians(180),radians(90),!0),this.isStop()||this.drawDent(t,0,this.height()-this.corner),t.arc(this.width()-this.corner,e,this.corner,radians(90),radians(0),!0),t.closePath(),t.fill()},CommandBlockMorph.prototype.drawDent=function(t,e,o){var i=e+2*this.corner+this.inset;t.lineTo(e+this.corner+this.inset,o),t.lineTo(i,o+this.corner),t.lineTo(i+this.dent,o+this.corner),t.lineTo(e+3*this.corner+this.inset+this.dent,o),t.lineTo(this.width()-this.corner,o)},CommandBlockMorph.prototype.drawTopDentEdge=function(t,e,o){var i,r,n,s,a=.5*this.edge,h=e+2*this.corner+this.inset;t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",(i=t.createLinearGradient(0,o,0,o+this.edge)).addColorStop(0,this.cachedClrBright),i.addColorStop(1,this.cachedClr),t.strokeStyle=i,t.beginPath(),t.moveTo(this.corner,o+a),t.lineTo(e+this.corner+this.inset,o+a),t.stroke(),t.strokeStyle=i,t.beginPath(),t.moveTo(e+3*this.corner+this.inset+this.dent+a,o+a),t.lineTo(this.width()-this.corner,o+a),t.stroke(),s=e+this.corner+this.inset,(n=t.createLinearGradient(s-this.edge,o+this.edge,s,o)).addColorStop(0,this.cachedClr),n.addColorStop(1,this.cachedClrBright),t.strokeStyle=n,t.beginPath(),t.moveTo(e+this.corner+this.inset,o+a),t.lineTo(h,o+this.corner+a),t.stroke(),(r=t.createLinearGradient(0,o+this.corner,0,o+this.corner+this.edge)).addColorStop(0,this.cachedClrBright),r.addColorStop(1,this.cachedClr),t.strokeStyle=r,t.beginPath(),t.moveTo(h,o+this.corner+a),t.lineTo(h+this.dent,o+this.corner+a),t.stroke()},CommandBlockMorph.prototype.drawBottomDentEdge=function(t,e,o){var i,r,n,s=.5*this.edge,a=e+2*this.corner+this.inset;if(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",(i=t.createLinearGradient(0,o-this.edge,0,o)).addColorStop(0,this.cachedClr),i.addColorStop(1,this.cachedClrDark),t.strokeStyle=i,t.beginPath(),t.moveTo(this.corner,o-s),this.isStop()?t.lineTo(this.width()-this.corner,o-s):t.lineTo(e+this.corner+this.inset-s,o-s),t.stroke(),this.isStop())return null;(r=t.createLinearGradient(0,o+this.corner-this.edge,0,o+this.corner)).addColorStop(0,this.cachedClr),r.addColorStop(1,this.cachedClrDark),t.strokeStyle=r,t.beginPath(),t.moveTo(a+s,o+this.corner-s),t.lineTo(a+this.dent,o+this.corner-s),t.stroke(),(n=t.createLinearGradient(e+a+this.dent-this.edge,o+this.corner-this.edge,e+a+this.dent,o+this.corner)).addColorStop(0,this.cachedClr),n.addColorStop(1,this.cachedClrDark),t.strokeStyle=n,t.beginPath(),t.moveTo(e+a+this.dent,o+this.corner-s),t.lineTo(e+3*this.corner+this.inset+this.dent,o-s),t.stroke(),t.strokeStyle=i,t.beginPath(),t.moveTo(e+3*this.corner+this.inset+this.dent,o-s),t.lineTo(this.width()-this.corner,o-s),t.stroke()},CommandBlockMorph.prototype.drawFlatBottomDentEdge=function(t){this.isStop()||(t.fillStyle=this.color.darker(this.contrast/2).toString(),t.beginPath(),this.drawDent(t,0,this.height()-this.corner),t.closePath(),t.fill())},CommandBlockMorph.prototype.drawLeftEdge=function(t){var e=.5*this.edge,o=t.createLinearGradient(0,0,this.edge,0);o.addColorStop(0,this.cachedClrBright),o.addColorStop(1,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=o,t.beginPath(),t.moveTo(e,this.corner),t.lineTo(e,this.height()-2*this.corner-e),t.stroke()},CommandBlockMorph.prototype.drawRightEdge=function(t){var e,o=.5*this.edge,i=this.width();(e=t.createLinearGradient(i-this.edge,0,i,0)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.moveTo(i-o,this.corner+o),t.lineTo(i-o,this.height()-2*this.corner),t.stroke()},CommandBlockMorph.prototype.drawTopLeftEdge=function(t){var e,o=.5*this.edge;(e=t.createRadialGradient(this.corner,this.corner,this.corner,this.corner,this.corner,this.corner-this.edge)).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.arc(this.corner,this.corner,this.corner-o,radians(-180),radians(-90),!1),t.stroke()},CommandBlockMorph.prototype.drawBottomRightEdge=function(t){var e,o=.5*this.edge,i=this.width()-this.corner,r=this.height()-2*this.corner;(e=t.createRadialGradient(i,r,this.corner,i,r,this.corner-this.edge)).addColorStop(0,this.cachedClrDark),e.addColorStop(1,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.arc(i,r,this.corner-o,radians(90),radians(0),!0),t.stroke()},HatBlockMorph.prototype=new CommandBlockMorph,HatBlockMorph.prototype.constructor=HatBlockMorph,HatBlockMorph.uber=CommandBlockMorph.prototype,HatBlockMorph.prototype.init=function(){HatBlockMorph.uber.init.call(this,!0),this.setExtent(new Point(300,150))},HatBlockMorph.prototype.blockSequence=function(){var t=HatBlockMorph.uber.blockSequence.call(this);return t.shift(),t},HatBlockMorph.prototype.drawTop=function(t){var e=this.hatWidth,o=this.hatHeight,i=(4*o*o+e*e)/(8*o),r=degrees(4*Math.atan(2*o/e))/2,n=Math.min(1.7*e,this.width()-this.corner);t.beginPath(),t.moveTo(0,o+this.corner),t.arc(e/2,i,i,radians(-r-90),radians(-90),!1),t.bezierCurveTo(e,0,e,o,n,o),t.arc(this.width()-this.corner,o+this.corner,this.corner,radians(-90),radians(-0),!1),t.closePath(),t.fill()},HatBlockMorph.prototype.drawBody=function(t){t.fillRect(0,this.hatHeight+Math.floor(this.corner)-1,this.width(),this.height()-Math.floor(3*this.corner)-this.hatHeight+2)},HatBlockMorph.prototype.drawLeftEdge=function(t){var e=.5*this.edge,o=t.createLinearGradient(0,0,this.edge,0);o.addColorStop(0,this.cachedClrBright),o.addColorStop(1,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=o,t.beginPath(),t.moveTo(e,this.hatHeight+e),t.lineTo(e,this.height()-2*this.corner-e),t.stroke()},HatBlockMorph.prototype.drawRightEdge=function(t){var e,o=.5*this.edge,i=this.width();(e=t.createLinearGradient(i-this.edge,0,i,0)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.moveTo(i-o,this.corner+this.hatHeight+o),t.lineTo(i-o,this.height()-2*this.corner),t.stroke()},HatBlockMorph.prototype.drawTopDentEdge=function(){return null},HatBlockMorph.prototype.drawTopLeftEdge=function(t){var e,o=.5*this.edge,i=this.hatWidth,r=this.hatHeight,n=(4*r*r+i*i)/(8*r),s=degrees(4*Math.atan(2*r/i))/2,a=Math.min(1.7*i,this.width()-this.corner);(e=t.createRadialGradient(i/2,n,n-this.edge,i/2,n,n)).addColorStop(1,this.cachedClrBright),e.addColorStop(0,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.arc(Math.round(i/2),n,n-o,radians(-s-90),radians(-90),!1),t.moveTo(i/2,o),t.bezierCurveTo(i,o,i,r+o,a,r+o),t.lineTo(this.width()-this.corner,r+o),t.stroke()},ReporterBlockMorph.prototype=new BlockMorph,ReporterBlockMorph.prototype.constructor=ReporterBlockMorph,ReporterBlockMorph.uber=BlockMorph.prototype,ReporterBlockMorph.prototype.init=function(t,e){ReporterBlockMorph.uber.init.call(this,e),this.isPredicate=t||!1,this.setExtent(new Point(200,80),e),this.cachedSlotSpec=null},ReporterBlockMorph.prototype.snap=function(t){var e,o,i=this.parent;if(this.cachedSlotSpec=null,!(i instanceof ScriptsMorph))return null;i.clearDropInfo(),i.lastDroppedBlock=this,null!==(o=i.closestInput(this,t))&&(i.lastReplacedInput=o,i.lastDropTarget=o.parent,o instanceof MultiArgMorph?(i.lastPreservedBlocks=o.inputs(),i.lastReplacedInput=o.fullCopy()):o instanceof CommandSlotMorph&&(i.lastReplacedInput=o,(e=o.nestedBlock())&&(e=e.fullCopy(),i.add(e),e.moveBy(e.extent()),e.fixBlockColor(),i.lastPreservedBlocks=[e])),o.parent.replaceInput(o,this),this.snapSound&&this.snapSound.play()),this.startLayout(),this.fixBlockColor(),this.endLayout(),ReporterBlockMorph.uber.snap.call(this),t&&i.recordDrop(t.grabOrigin)},ReporterBlockMorph.prototype.prepareToBeGrabbed=function(t){var e=this.position();nop(t),(this.parent instanceof BlockMorph||this.parent instanceof MultiArgMorph||this.parent instanceof ReporterSlotMorph)&&(this.parent.revertToDefaultInput(this),this.setPosition(e)),ReporterBlockMorph.uber.prepareToBeGrabbed.call(this,t),this.alpha=.85,this.cachedSlotSpec=null},ReporterBlockMorph.prototype.blockSequence=function(){return this},ReporterBlockMorph.prototype.isUnevaluated=function(){var t=this.getSlotSpec();return"%anyUE"===t||"%boolUE"===t||"%f"===t},ReporterBlockMorph.prototype.isLocked=function(){return this.isStatic||"%t"===this.getSlotSpec()},ReporterBlockMorph.prototype.getSlotSpec=function(){return this.cachedSlotSpec||(this.cachedSlotSpec=this.determineSlotSpec()),this.cachedSlotSpec},ReporterBlockMorph.prototype.determineSlotSpec=function(){var t,e;return this.parent instanceof BlockMorph&&(t=this.parent.parts().filter(function(t){return!(t instanceof BlockHighlightMorph)}),-1!==(e=t.indexOf(this))&&this.parent.blockSpec)?this.parseSpec(this.parent.blockSpec)[e]:this.parent instanceof MultiArgMorph?this.parent.slotSpec:this.parent instanceof TemplateSlotMorph?this.parent.getSpec():null},ReporterBlockMorph.prototype.mouseClickLeft=function(t){var e;if(this.parent instanceof BlockInputFragmentMorph)return this.parent.mouseClickLeft();this.parent instanceof TemplateSlotMorph?(e=this.parent.parent&&this.parent.parent.parent&&this.parent.parent.parent instanceof RingMorph?"Input name":"%blockVars"===this.parent.parent.elementSpec?"Block variable name":"Script variable name",new DialogBoxMorph(this,this.userSetSpec,this).prompt(e,this.blockSpec,this.world())):ReporterBlockMorph.uber.mouseClickLeft.call(this,t)},ReporterBlockMorph.prototype.exportResultPic=function(){var t,e=this.topBlock(),o=e.scriptTarget();e===this&&o&&(t=o.parentThatIsA(StageMorph))&&(t.threads.stopProcess(e),t.threads.startProcess(e,o,!1,!0))},ReporterBlockMorph.prototype.userDestroy=function(){var t=this.selectForEdit();if(t!==this)return this.userDestroy.call(t);var e=this.parentThatIsA(ScriptsMorph);e&&(e.clearDropInfo(),e.lastDroppedBlock=this,e.recordDrop(this.situation()),e.dropRecord.action="delete"),this.topBlock().fullChanged(),this.prepareToBeGrabbed(this.world().hand),this.destroy()},ReporterBlockMorph.prototype.drawNew=function(){var t;this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),(t=this.image.getContext("2d")).fillStyle=this.cachedClr,this.isPredicate?this.drawDiamond(t):this.drawRounded(t),this.isCustomBlock&&!this.isGlobal&&this.drawMethodIcon(t),this.eraseHoles(t)},ReporterBlockMorph.prototype.drawRounded=function(t){var e,o=this.height(),i=Math.min(this.rounding,o/2),r=this.width(),n=this.edge/2;t.fillStyle=this.cachedClr,t.beginPath(),t.arc(i,i,i,radians(-180),radians(-90),!1),t.arc(r-i,i,i,radians(-90),radians(-0),!1),t.arc(r-i,o-i,i,radians(0),radians(90),!1),t.arc(i,o-i,i,radians(90),radians(180),!1),t.closePath(),t.fill(),MorphicPreferences.isFlat||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",(e=t.createRadialGradient(i,o-i,i-this.edge,i,o-i,i+this.edge)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.arc(i,o-i,i-n,radians(90),radians(180),!1),t.stroke(),(e=t.createRadialGradient(r-i,i,i-this.edge,r-i,i,i+this.edge)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.arc(r-i,i,i-n,radians(-90),radians(0),!1),t.stroke(),(e=t.createLinearGradient(0,0,0,this.edge)).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(i-n,n),t.lineTo(r-i+n,n),t.stroke(),(e=t.createRadialGradient(i,i,i-this.edge,i,i,i)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.arc(i,i,i-n,radians(180),radians(270),!1),t.stroke(),(e=t.createRadialGradient(r-i,o-i,i-this.edge,r-i,o-i,i)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.arc(r-i,o-i,i-n,radians(0),radians(90),!1),t.stroke(),(e=t.createLinearGradient(0,o-this.edge,0,o)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(i-n,o-n),t.lineTo(r-i+n,o-n),t.stroke(),(e=t.createLinearGradient(0,0,this.edge,0)).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(n,i),t.lineTo(n,o-i),t.stroke(),(e=t.createLinearGradient(r-this.edge,0,r,0)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(r-n,i+n),t.lineTo(r-n,o-i),t.stroke())},ReporterBlockMorph.prototype.drawDiamond=function(t){var e,o=this.width(),i=this.height(),r=Math.floor(i/2),n=this.rounding,s=this.edge/2;t.fillStyle=this.cachedClr,t.beginPath(),t.moveTo(0,r),t.lineTo(n,0),t.lineTo(o-n,0),t.lineTo(o,r),t.lineTo(o-n,i),t.lineTo(n,i),t.closePath(),t.fill(),MorphicPreferences.isFlat||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",(e=t.createLinearGradient(-n,0,n,0)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(s,r),t.lineTo(n,i-s),t.closePath(),t.stroke(),(e=t.createLinearGradient(o-n,0,o+n,0)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(o-s,r),t.lineTo(o-n,s),t.closePath(),t.stroke(),(e=t.createLinearGradient(0,0,n,0)).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(s,r),t.lineTo(n,s),t.closePath(),t.stroke(),(e=t.createLinearGradient(0,0,0,this.edge)).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(n,s),t.lineTo(o-n,s),t.closePath(),t.stroke(),(e=t.createLinearGradient(o-n,0,o,0)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(o-n,i-s),t.lineTo(o-s,r),t.closePath(),t.stroke(),(e=t.createLinearGradient(0,i-this.edge,0,i)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(n+s,i-s),t.lineTo(o-n-s,i-s),t.closePath(),t.stroke())},RingMorph.prototype=new ReporterBlockMorph,RingMorph.prototype.constructor=RingMorph,RingMorph.uber=ReporterBlockMorph.prototype,RingMorph.prototype.isCachingInputs=!1,RingMorph.prototype.init=function(){RingMorph.uber.init.call(this),this.category="other",this.alpha=RingMorph.prototype.alpha,this.contrast=RingMorph.prototype.contrast,this.setExtent(new Point(200,80))},RingMorph.prototype.rootForGrab=function(){return this.isDraggable?this:BlockMorph.uber.rootForGrab.call(this)},RingMorph.prototype.embed=function(t,e){var o;this.color=SpriteMorph.prototype.blockColor.other,this.isDraggable=!0,t instanceof CommandBlockMorph?(this.isStatic=!1,this.setSpec("%rc %ringparms"),this.selector="reifyScript",(o=this.parts()[0]).nestedBlock(t)):t.isPredicate?(this.isStatic=!0,this.setSpec("%rp %ringparms"),this.selector="reifyPredicate",(o=this.parts()[0]).silentReplaceInput(o.contents(),t)):t instanceof BooleanSlotMorph?(this.isStatic=!1,this.setSpec("%rp %ringparms"),this.selector="reifyPredicate",(o=this.parts()[0]).silentReplaceInput(o.contents(),t)):(this.isStatic=!1,this.setSpec("%rr %ringparms"),this.selector="reifyReporter",(o=this.parts()[0]).silentReplaceInput(o.contents(),t)),o=this.parts()[1],e&&e.forEach(function(t){o.addInput(t)}),this.fixBlockColor(null,!0)},RingMorph.prototype.vanishForSimilar=function(){var t=this.parts()[0].nestedBlock();return t&&this.parent instanceof SyntaxElementMorph?this.parent instanceof RingReporterSlotMorph||this.parent instanceof RingCommandSlotMorph?null:void(("reportGetVar"===t.selector||"reportJSFunction"===t.selector||t instanceof RingMorph)&&this.parent.silentReplaceInput(this,t)):null},RingMorph.prototype.contents=function(){return this.parts()[0].nestedBlock()},RingMorph.prototype.inputNames=function(){return this.parts()[1].evaluate()},RingMorph.prototype.dataType=function(){switch(this.selector){case"reifyScript":return"command";case"reifyPredicate":return"predicate";default:return"reporter"}},RingMorph.prototype.fixBlockColor=function(t,e){var o=this.parts()[0];RingMorph.uber.fixBlockColor.call(this,t,e),o.fixLayout()},ScriptsMorph.prototype=new FrameMorph,ScriptsMorph.prototype.constructor=ScriptsMorph,ScriptsMorph.uber=FrameMorph.prototype,ScriptsMorph.prototype.cleanUpMargin=20,ScriptsMorph.prototype.cleanUpSpacing=15,ScriptsMorph.prototype.isPreferringEmptySlots=!0,ScriptsMorph.prototype.enableKeyboard=!0,ScriptsMorph.prototype.enableNestedAutoWrapping=!0,ScriptsMorph.prototype.init=function(){this.feedbackColor=SyntaxElementMorph.prototype.feedbackColor,this.feedbackMorph=new BoxMorph,this.rejectsHats=!1,this.lastDroppedBlock=null,this.lastReplacedInput=null,this.lastDropTarget=null,this.lastPreservedBlocks=null,this.lastNextBlock=null,this.lastWrapParent=null,this.focus=null,ScriptsMorph.uber.init.call(this),this.setColor(new Color(70,70,70)),this.noticesTransparentClick=!0,this.isAnimating=!1,this.dropRecord=null,this.recordDrop()},ScriptsMorph.prototype.fullCopy=function(){var t,e=new ScriptsMorph,o=this.position();return this.focus&&this.focus.stopEditing(),this.children.forEach(function(i){i.block||(t=i.fullCopy(),e.add(t),t.setPosition(i.position().subtract(o)),t instanceof BlockMorph&&t.allComments().forEach(function(e){e.align(t)}))}),e.adjustBounds(),e},ScriptsMorph.prototype.step=function(){var t,e=this.world(),o=e.hand;return this.feedbackMorph.parent&&(this.feedbackMorph.destroy(),this.feedbackMorph.parent=null),this.focus&&(!e.keyboardReceiver||e.keyboardReceiver instanceof StageMorph)&&this.focus.getFocus(e),0===o.children.length?null:this.bounds.containsPoint(o.bounds.origin)&&((t=o.children[0])instanceof BlockMorph||t instanceof CommentMorph)&&contains(o.morphAtPointer().allParents(),this)?void(t instanceof CommentMorph?this.showCommentDropFeedback(t,o):t instanceof ReporterBlockMorph?this.showReporterDropFeedback(t,o):this.showCommandDropFeedback(t)):null},ScriptsMorph.prototype.showReporterDropFeedback=function(t,e){var o=this.closestInput(t,e);if(null===o)return null;this.feedbackMorph.bounds=o.fullBounds().expandBy(Math.max(2*t.edge,t.reporterDropFeedbackPadding)),this.feedbackMorph.edge=SyntaxElementMorph.prototype.rounding,this.feedbackMorph.border=Math.max(SyntaxElementMorph.prototype.edge,3),this.add(this.feedbackMorph),o instanceof MultiArgMorph?(this.feedbackMorph.color=SpriteMorph.prototype.blockColor.lists.copy(),this.feedbackMorph.borderColor=SpriteMorph.prototype.blockColor.lists):(this.feedbackMorph.color=this.feedbackColor.copy(),this.feedbackMorph.borderColor=this.feedbackColor),this.feedbackMorph.color.a=.5,this.feedbackMorph.drawNew(),this.feedbackMorph.changed()},ScriptsMorph.prototype.showCommandDropFeedback=function(t){var e,o;if(!(o=t.closestAttachTarget(this)))return null;"wrap"!==o.loc?(this.add(this.feedbackMorph),this.feedbackMorph.border=0,this.feedbackMorph.edge=0,this.feedbackMorph.alpha=1,this.feedbackMorph.setExtent(new Point(o.element.width(),Math.max(SyntaxElementMorph.prototype.corner,SyntaxElementMorph.prototype.feedbackMinHeight))),this.feedbackMorph.color=this.feedbackColor,this.feedbackMorph.drawNew(),this.feedbackMorph.changed(),e=o.point.y,"bottom"===o.loc&&("block"===o.type?o.element.nextBlock()&&(e-=SyntaxElementMorph.prototype.corner):"slot"===o.type&&o.element.nestedBlock()&&(e-=SyntaxElementMorph.prototype.corner)),this.feedbackMorph.setPosition(new Point(o.element.left(),e))):this.showCSlotWrapFeedback(t,o.element)},ScriptsMorph.prototype.showCommentDropFeedback=function(t,e){var o=this.closestBlock(t,e);if(!o)return null;this.feedbackMorph.bounds=o.bounds.expandBy(Math.max(2*BlockMorph.prototype.edge,BlockMorph.prototype.reporterDropFeedbackPadding)),this.feedbackMorph.edge=SyntaxElementMorph.prototype.rounding,this.feedbackMorph.border=Math.max(SyntaxElementMorph.prototype.edge,3),this.add(this.feedbackMorph),this.feedbackMorph.color=t.color.copy(),this.feedbackMorph.color.a=.25,this.feedbackMorph.borderColor=t.titleBar.color,this.feedbackMorph.drawNew(),this.feedbackMorph.changed()},ScriptsMorph.prototype.showCSlotWrapFeedback=function(t,e){var o;this.feedbackMorph.bounds=e.fullBounds().expandBy(BlockMorph.prototype.corner),this.feedbackMorph.edge=SyntaxElementMorph.prototype.corner,this.feedbackMorph.border=Math.max(SyntaxElementMorph.prototype.edge,3),this.add(this.feedbackMorph),o=t.color.lighter(40),this.feedbackMorph.color=o.copy(),this.feedbackMorph.color.a=.1,this.feedbackMorph.borderColor=o,this.feedbackMorph.drawNew(),this.feedbackMorph.changed()},ScriptsMorph.prototype.closestInput=function(t,e){function o(t,e){return!(t instanceof MultiArgMorph)||(e?t.arrows().bounds.containsPoint(e):t.arrows().bounds.intersects(s))}var i,r,n,s=t.fullBoundsNoShadow(),a=this.children.filter(function(t){return t instanceof BlockMorph&&t.fullBounds().intersects(s)}),h=t.allInputs();if(n=[],a.forEach(function(t){n=n.concat(t.allInputs())}),0===n.length)return null;if(this.isPreferringEmptySlots){if(e&&(i=e.position(),r=detect(n,function(t){return(t instanceof InputSlotMorph||t instanceof ArgMorph&&!(t instanceof CommandSlotMorph)&&!(t instanceof MultiArgMorph)||t instanceof RingMorph&&!t.contents()||t.isEmptySlot())&&!t.isLocked()&&t.bounds.containsPoint(i)&&!contains(h,t)})))return r;if(r=detect(n,function(t){return(t instanceof InputSlotMorph||t instanceof ArgMorph||t instanceof RingMorph&&!t.contents()||t.isEmptySlot())&&!t.isLocked()&&t.bounds.intersects(s)&&!contains(h,t)&&o(t)}))return r}return e&&(i=e.position(),r=detect(n,function(e){return e!==t&&!e.isLocked()&&e.bounds.containsPoint(i)&&!(e.parent instanceof PrototypeHatBlockMorph)&&!contains(h,e)}))?r:detect(n,function(e){return e!==t&&!e.isLocked()&&e.fullBounds().intersects(s)&&!(e.parent instanceof PrototypeHatBlockMorph)&&!contains(h,e)})},ScriptsMorph.prototype.closestBlock=function(t,e){var o,i,r,n=t.bounds,s=this.children.filter(function(t){return t instanceof BlockMorph&&t.fullBounds().intersects(n)});return r=[],s.forEach(function(t){r=r.concat(t.allChildren().slice(0).reverse().filter(function(t){return t instanceof BlockMorph&&!t.isTemplate}))}),0===r.length?null:e&&(o=e.position(),i=detect(r,function(t){return!t.comment&&!t.isPrototype&&t.bounds.containsPoint(o)}))?i:detect(r,function(t){return!t.comment&&!t.isPrototype&&t.bounds.intersects(n)})},ScriptsMorph.prototype.userMenu=function(){var t,e,o=new MenuMorph(this),i=this.parentThatIsA(IDE_Morph),r=16===this.world().currentKey,n=this,s=this.scriptTarget(),a=s.parentThatIsA(StageMorph);return i||(t=this.parentThatIsA(BlockEditorMorph))&&(i=t.target.parentThatIsA(IDE_Morph)),this.dropRecord&&(this.dropRecord.lastRecord&&(e=!0,o.addPair([new SymbolMorph("turnBack",MorphicPreferences.menuFontSize),localize("undrop")],"undrop","^Z","undo the last\nblock drop\nin this pane")),this.dropRecord.nextRecord&&(e=!0,o.addPair([new SymbolMorph("turnForward",MorphicPreferences.menuFontSize),localize("redrop")],"redrop","^Y","redo the last undone\nblock drop\nin this pane")),e&&(r&&o.addItem("clear undrop queue",function(){n.dropRecord=null,n.clearDropInfo(),n.recordDrop()},"forget recorded block drops\non this pane",new Color(100,0,0)),o.addLine())),o.addItem("clean up","cleanUp","arrange scripts\nvertically"),o.addItem("add comment","addComment"),o.addItem("scripts pic...","exportScriptsPicture","open a new window\nwith a picture of all scripts"),i&&(o.addLine(),!t&&s.exemplar&&function(t,e,i,r,n){o.addItem((i?"☑ ":"☐ ")+localize(t),e,i?r:n)}("inherited",function(){s.toggleInheritanceForAttribute("scripts")},s.inheritsAttribute("scripts"),"uncheck to\ndisinherit",localize("check to inherit\nfrom")+" "+s.exemplar.name),o.addItem("make a block...",function(){new BlockDialogMorph(null,function(t){""!==t.spec&&(t.isGlobal?a.globalBlocks.push(t):s.customBlocks.push(t),i.flushPaletteCache(),i.refreshPalette(),new BlockEditorMorph(t,s).popUp())},n).prompt("Make a block",null,n.world())})),o},ScriptsMorph.prototype.cleanUp=function(){var t=this.selectForEdit(),e=t.topLeft(),o=t.cleanUpMargin;t.children.sort(function(t,e){return t instanceof PrototypeHatBlockMorph?0:t.top()-e.top()}).forEach(function(i){i instanceof CommentMorph&&i.block||(i.setPosition(e.add(new Point(t.cleanUpMargin,o))),i instanceof BlockMorph&&i.allComments().forEach(function(t){t.align(i,!0)}),o+=i.stackHeight()+t.cleanUpSpacing)}),t.parent&&t.setPosition(t.parent.topLeft()),t.adjustBounds()},ScriptsMorph.prototype.exportScriptsPicture=function(){var t=this.scriptsPicture(),e=this.world().children[0];t&&e.saveCanvasAs(t,(e.projectName||localize("untitled"))+" "+localize("script pic"))},ScriptsMorph.prototype.scriptsPicture=function(){var t,e,o;if(0!==this.children.length)return t=this.children[0].fullBounds(),this.children.forEach(function(e){e.isVisible&&(t=t.merge(e.fullBounds()))}),e=newCanvas(t.extent()),o=e.getContext("2d"),this.children.forEach(function(e){var i=e.fullBounds().origin;e.isVisible&&o.drawImage(e.fullImageClassic(),i.x-t.origin.x,i.y-t.origin.y)}),e},ScriptsMorph.prototype.addComment=function(){var t=this.parentThatIsA(IDE_Morph),e=this.parentThatIsA(BlockEditorMorph),o=this.world();(new CommentMorph).pickUp(o),!t&&e&&(t=e.target.parentThatIsA(IDE_Morph)),t&&(o.hand.grabOrigin={origin:t.palette,position:t.palette.center()})},ScriptsMorph.prototype.undrop=function(){var t=this;this.isAnimating||this.dropRecord&&this.dropRecord.lastRecord&&(this.dropRecord.situation||(this.dropRecord.situation=this.dropRecord.lastDroppedBlock.situation()),this.isAnimating=!0,this.dropRecord.lastDroppedBlock.slideBackTo(this.dropRecord.lastOrigin,null,this.recoverLastDrop(),function(){t.updateToolbar(),t.isAnimating=!1}),this.dropRecord=this.dropRecord.lastRecord)},ScriptsMorph.prototype.redrop=function(){var t=this;this.isAnimating||this.dropRecord&&this.dropRecord.nextRecord&&(this.dropRecord=this.dropRecord.nextRecord,"delete"===this.dropRecord.action?(this.recoverLastDrop(!0),this.dropRecord.lastDroppedBlock.destroy(),this.updateToolbar()):(this.isAnimating=!0,this.dropRecord.lastDroppedBlock.slideBackTo(this.dropRecord.situation,null,this.recoverLastDrop(!0),function(){t.updateToolbar(),t.isAnimating=!1})))},ScriptsMorph.prototype.recoverLastDrop=function(t){var e,o,i,r=this.dropRecord;if(!r||!r.lastDroppedBlock)throw new Error("nothing to undrop");if(e=r.lastDroppedBlock,i=e.parent,e instanceof CommandBlockMorph){if(r.lastNextBlock&&("delete"===r.action?t&&this.add(r.lastNextBlock):this.add(r.lastNextBlock)),r.lastDropTarget)if("bottom"===r.lastDropTarget.loc)"slot"===r.lastDropTarget.type?r.lastNextBlock&&r.lastDropTarget.element.nestedBlock(r.lastNextBlock):r.lastNextBlock&&r.lastDropTarget.element.nextBlock(r.lastNextBlock);else if("top"===r.lastDropTarget.loc)this.add(r.lastDropTarget.element);else if("wrap"===r.lastDropTarget.loc){var n=detect(r.lastDroppedBlock.inputs(),function(t){return t instanceof CSlotMorph});r.lastWrapParent instanceof CommandBlockMorph?t?o=function(){n.nestedBlock(r.lastDropTarget.element)}:r.lastWrapParent.nextBlock(r.lastDropTarget.element):r.lastWrapParent instanceof CommandSlotMorph?t?o=function(){n.nestedBlock(r.lastDropTarget.element)}:r.lastWrapParent.nestedBlock(r.lastDropTarget.element):this.add(r.lastDropTarget.element),r.lastDropTarget.element.blockSequence().forEach(function(t){t.fixBlockColor()}),n.fixLayout()}}else if(e instanceof ReporterBlockMorph)r.lastDropTarget&&(r.lastDropTarget.replaceInput(r.lastDroppedBlock,r.lastReplacedInput),r.lastDropTarget.fixBlockColor(null,!0),r.lastPreservedBlocks&&r.lastPreservedBlocks.forEach(function(t){t.destroy()}));else{if(!(e instanceof CommentMorph))throw new Error("unsupported action for "+e);t&&r.lastDropTarget&&(o=function(){r.lastDropTarget.element.comment=e,e.block=r.lastDropTarget.element,e.align()})}return this.clearDropInfo(),e.prepareToBeGrabbed(this.world().hand),e instanceof CommentMorph&&e.removeShadow(),this.add(e),i.reactToGrabOf(e),e instanceof ReporterBlockMorph&&i instanceof BlockMorph&&i.changed(),"delete"===r.action&&(t&&r.lastNextBlock&&(i instanceof CommandBlockMorph?i.nextBlock(r.lastNextBlock):i instanceof CommandSlotMorph&&i.nestedBlock(r.lastNextBlock)),t||e.moveBy(new Point(-100,-20))),o},ScriptsMorph.prototype.clearDropInfo=function(){this.lastDroppedBlock=null,this.lastReplacedInput=null,this.lastDropTarget=null,this.lastPreservedBlocks=null,this.lastNextBlock=null,this.lastWrapParent=null},ScriptsMorph.prototype.recordDrop=function(t){var e={lastDroppedBlock:this.lastDroppedBlock,lastReplacedInput:this.lastReplacedInput,lastDropTarget:this.lastDropTarget,lastPreservedBlocks:this.lastPreservedBlocks,lastNextBlock:this.lastNextBlock,lastWrapParent:this.lastWrapParent,lastOrigin:t,action:null,situation:null,lastRecord:this.dropRecord,nextRecord:null};this.dropRecord&&(this.dropRecord.nextRecord=e),this.dropRecord=e,this.updateToolbar()},ScriptsMorph.prototype.addToolbar=function(){var t=new AlignmentMorph,e=this,o=new Color(140,140,140);return t.respectHiddens=!0,t.undoButton=new PushButtonMorph(this,"undrop",new SymbolMorph("turnBack",12)),t.undoButton.alpha=.2,t.undoButton.padding=2,t.undoButton.labelShadowColor=o,t.undoButton.drawNew(),t.undoButton.fixLayout(),t.add(t.undoButton),t.redoButton=new PushButtonMorph(this,"redrop",new SymbolMorph("turnForward",12)),t.redoButton.alpha=.2,t.redoButton.padding=2,t.redoButton.labelShadowColor=o,t.redoButton.drawNew(),t.redoButton.fixLayout(),t.add(t.redoButton),t.keyboardButton=new ToggleButtonMorph(null,this,"toggleKeyboardEntry",[new SymbolMorph("keyboard",12),new SymbolMorph("keyboardFilled",12)],function(){return!isNil(e.focus)}),t.keyboardButton.alpha=.2,t.keyboardButton.padding=2,t.keyboardButton.hint="use the keyboard\nto enter blocks",t.keyboardButton.labelShadowColor=o,t.keyboardButton.drawNew(),t.keyboardButton.fixLayout(),t.add(t.keyboardButton),t},ScriptsMorph.prototype.updateToolbar=function(){var t=this.parentThatIsA(ScrollFrameMorph);t&&(t.toolBar||(t.toolBar=this.addToolbar(),t.add(t.toolBar)),this.enableKeyboard?(t.toolBar.keyboardButton.show(),t.toolBar.keyboardButton.refresh()):t.toolBar.keyboardButton.hide(),this.dropRecord&&(this.dropRecord.lastRecord?t.toolBar.undoButton.isVisible||t.toolBar.undoButton.show():t.toolBar.undoButton.isVisible&&t.toolBar.undoButton.hide(),this.dropRecord.nextRecord?t.toolBar.redoButton.isVisible||(t.toolBar.redoButton.show(),t.toolBar.undoButton.mouseLeave()):t.toolBar.redoButton.isVisible&&t.toolBar.redoButton.hide()),detect(t.toolBar.children,function(t){return t.isVisible})&&(t.toolBar.fixLayout(),t.adjustToolBar()))},ScriptsMorph.prototype.sortedElements=function(){var t=this.children.filter(function(t){return!(t instanceof CommentMorph)||!t.block});return t.sort(function(t,e){return t instanceof PrototypeHatBlockMorph?0:t.top()-e.top()}),t},ScriptsMorph.prototype.fixMultiArgs=function(){var t=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,this.forAllChildren(function(t){t instanceof MultiArgMorph&&t.fixLayout()}),Morph.prototype.trackChanges=t},ScriptsMorph.prototype.wantsDropOf=function(t){return t instanceof HatBlockMorph?!this.rejectsHats:t instanceof SyntaxElementMorph||t instanceof CommentMorph},ScriptsMorph.prototype.reactToDropOf=function(t,e){(t instanceof BlockMorph||t instanceof CommentMorph)&&t.snap(e),this.adjustBounds()},ScriptsMorph.prototype.mouseClickLeft=function(t){if(16===this.world().currentKey)return this.edit(t);this.focus&&this.focus.stopEditing()},ScriptsMorph.prototype.selectForEdit=function(){var t=this.parentThatIsA(IDE_Morph),e=t?t.currentSprite:null;return e&&e.inheritsAttribute("scripts")?(this.feedbackMorph.destroy(),e.shadowAttribute("scripts"),e.scripts):this},ScriptsMorph.prototype.edit=function(t){var e,o=this.world();this.focus&&this.focus.stopEditing(),o.stopEditing(),ScriptsMorph.prototype.enableKeyboard&&((e=this.selectForEdit()).focus=new ScriptFocusMorph(e,e,t),e.focus.getFocus(o))},ScriptsMorph.prototype.toggleKeyboardEntry=function(){var t,e,o=this.world();this.focus?this.focus.stopEditing():(o.stopEditing(),ScriptsMorph.prototype.enableKeyboard&&((t=this.selectForEdit()).focus=new ScriptFocusMorph(t,t,t.position()),t.focus.getFocus(o),(e=t.focus.sortedScripts()).length?(t.focus.element=e[0],t.focus.element instanceof HatBlockMorph&&t.focus.nextCommand()):t.focus.moveBy(new Point(50,50)),t.focus.fixLayout()))},ScriptsMorph.prototype.scriptTarget=function(){var t=this.parentThatIsA(IDE_Morph);if(t)return t.currentSprite;if(t=this.parentThatIsA(BlockEditorMorph))return t.target;throw new Error("script target bannot be found for orphaned scripts")},ArgMorph.prototype=new SyntaxElementMorph,ArgMorph.prototype.constructor=ArgMorph,ArgMorph.uber=SyntaxElementMorph.prototype,ArgMorph.prototype.init=function(t,e){this.type=t||null,this.isHole=!1,ArgMorph.uber.init.call(this,e),this.color=new Color(0,17,173),this.setExtent(new Point(50,50),e)},ArgMorph.prototype.executeOnSliderEdit=!1,ArgMorph.prototype.reactToSliderEdit=function(){var t,e,o,i;if(this.executeOnSliderEdit&&(t=this.parentThatIsA(BlockMorph))){if(e=t.topBlock(),o=e.scriptTarget(),e instanceof PrototypeHatBlockMorph)return;o&&((i=o.parentThatIsA(StageMorph))&&(i.isThreadSafe||Process.prototype.enableSingleStepping)?i.threads.startProcess(e,o,i.isThreadSafe):e.mouseClickLeft())}},ArgMorph.prototype.justDropped=function(){this instanceof CommandSlotMorph||(this.drawNew(),this.changed())},ArgMorph.prototype.getSpec=function(){return"%s"},ArgMorph.prototype.drawNew=function(){"list"===this.type?(this.image=this.listIcon(),this.silentSetExtent(new Point(this.image.width,this.image.height))):"object"===this.type?(this.image=this.objectIcon(),this.silentSetExtent(new Point(this.image.width,this.image.height))):ArgMorph.uber.drawNew.call(this)},ArgMorph.prototype.listIcon=function(){var t,e,o,i,r=new Morph,n=new CellMorph,s=new CellMorph;return r.color=new Color(255,255,255),s.setPosition(n.bottomLeft().add(new Point(0,this.fontSize/3))),n.add(s),n.setPosition(r.position().add(this.fontSize)),r.add(n),r.bounds.corner=s.bounds.corner.add(this.fontSize),r.drawNew(),t=r.fullImage(),i=(this.fontSize+this.edge)/t.height,e=newCanvas(new Point(Math.ceil(t.width*i)+1,Math.ceil(t.height*i)+1)),o=e.getContext("2d"),o.fillStyle="black",o.fillRect(0,0,e.width,e.height),o.scale(i,i),o.drawImage(t,1/i,1/i),e},ArgMorph.prototype.objectIcon=function(){return this.labelPart("%turtle").image},ArgMorph.prototype.isEmptySlot=function(){return null!==this.type},CommandSlotMorph.prototype=new ArgMorph,CommandSlotMorph.prototype.constructor=CommandSlotMorph,CommandSlotMorph.uber=ArgMorph.prototype,CommandSlotMorph.prototype.init=function(t){CommandSlotMorph.uber.init.call(this,null,!0),this.color=new Color(0,17,173),this.setExtent(new Point(230,4*this.corner+this.cSlotPadding),t)},CommandSlotMorph.prototype.getSpec=function(){return"%cmd"},CommandSlotMorph.prototype.topBlock=function(){return this.parent.topBlock?this.parent.topBlock():this.nestedBlock()},CommandSlotMorph.prototype.nestedBlock=function(t){if(!t)return detect(this.children,function(t){return t instanceof CommandBlockMorph});var e=this.nestedBlock();this.add(t),e&&t.bottomBlock().nextBlock(e),this.fixLayout()},CommandSlotMorph.prototype.slotAttachPoint=function(){return new Point(this.dentCenter(),this.top()+2*this.corner)},CommandSlotMorph.prototype.dentLeft=function(){return this.left()+this.corner+2*this.inset},CommandSlotMorph.prototype.dentCenter=function(){return this.dentLeft()+this.corner+.5*this.dent},CommandSlotMorph.prototype.attachTargets=function(){var t=[];return t.push({point:this.slotAttachPoint(),element:this,loc:"bottom",type:"slot"}),t},CommandSlotMorph.prototype.fixLayout=function(){var t=this.nestedBlock();this.parent&&(this.color.eq(this.parent.color)||this.setColor(this.parent.color)),t?(t.setPosition(new Point(this.left()+this.edge+this.rfBorder,this.top()+this.edge+this.rfBorder)),this.setWidth(t.fullBounds().width()+2*(this.edge+this.rfBorder)),this.setHeight(t.fullBounds().height()+this.edge+2*this.rfBorder-(this.corner-this.edge))):(this.setHeight(4*this.corner),this.setWidth(4*this.corner+this.inset+this.dent)),this.parent.fixLayout&&this.parent.fixLayout()},CommandSlotMorph.prototype.evaluate=function(){return this.nestedBlock()},CommandSlotMorph.prototype.isEmptySlot=function(){return!this.isStatic&&null===this.nestedBlock()},CommandSlotMorph.prototype.attach=function(){var t=this.overlappedMorphs(),e=new MenuMorph(this,"choose new parent:"),o=this;t.forEach(function(t){e.addItem(t.toString().slice(0,50),function(){t.add(o),o.isDraggable=!1,t.fixLayout&&t.fixLayout()})}),t.length>0&&e.popUpAtHand(this.world())},CommandSlotMorph.prototype.drawNew=function(){var t;this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),(t=this.image.getContext("2d")).fillStyle=this.cachedClr,t.fillRect(0,0,this.width(),this.height()),t.fillStyle=this.rfColor.toString(),this.drawFlat(t),MorphicPreferences.isFlat||this.drawEdges(t)},CommandSlotMorph.prototype.drawFlat=function(t){var e=null!==this.nestedBlock(),o=e?this.inset:this.inset/2,i=e?this.dent:this.dent/2,r=2*this.corner+o,n=this.edge,s=e?this.rfBorder:0,a=this.height()-this.corner-n;t.beginPath(),t.arc(this.corner+n,this.corner+n,this.corner,radians(-180),radians(-90),!1),t.lineTo(this.corner+o+n+2*s,n),t.lineTo(r+n+2*s,this.corner+n),t.lineTo(r+n+2*s+(i-2*s),this.corner+n),t.lineTo(r+n+2*s+(i-2*s)+this.corner,n),t.lineTo(this.width()-this.corner-n,n),t.arc(this.width()-this.corner-n,this.corner+n,this.corner,radians(-90),radians(-0),!1),t.arc(this.width()-this.corner-n,a,this.corner,radians(0),radians(90),!1),t.arc(this.corner+n,a,this.corner,radians(90),radians(180),!1),t.closePath(),t.fill()},CommandSlotMorph.prototype.drawEdges=function(t){var e,o,i,r,n=null!==this.nestedBlock(),s=n?this.inset:this.inset/2,a=n?this.dent:this.dent/2,h=2*this.corner+s,l=this.edge,p=n?this.rfBorder:0,c=.5*this.edge;t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",(e=t.createLinearGradient(0,this.height(),0,this.height()-this.edge)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(this.corner+l,this.height()-c),t.lineTo(this.width()-this.corner-l,this.height()-c),t.stroke(),(e=t.createRadialGradient(this.width()-(this.corner+l),this.height()-(this.corner+l),this.corner,this.width()-(this.corner+l),this.height()-(this.corner+l),this.corner+l)).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.arc(this.width()-(this.corner+l),this.height()-(this.corner+l),this.corner+c,radians(0),radians(90),!1),t.stroke(),(e=t.createLinearGradient(this.width(),0,this.width()-this.edge,0)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(this.width()-c,this.height()-this.corner-this.edge),t.lineTo(this.width()-c,l+this.corner),t.stroke(),t.shadowOffsetY=c,t.shadowBlur=this.edge,t.shadowColor=this.rfColor.darker(80).toString(),(e=t.createLinearGradient(0,0,l,0)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(c,l+this.corner),t.lineTo(c,this.height()-l-this.corner),t.stroke(),(e=t.createRadialGradient(this.corner+l,this.corner+l,this.corner,this.corner+l,this.corner+l,this.corner+l)).addColorStop(0,this.cachedClrDark),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.arc(this.corner+l,this.corner+l,this.corner+c,radians(-180),radians(-90),!1),t.stroke(),(o=t.createLinearGradient(0,0,0,this.edge)).addColorStop(0,this.cachedClr),o.addColorStop(1,this.cachedClrDark),t.strokeStyle=o,t.beginPath(),t.moveTo(this.corner+l,c),t.lineTo(this.corner+s+l+2*p-c,c),t.stroke(),(i=t.createLinearGradient(0,this.corner,0,this.corner+l)).addColorStop(0,this.cachedClr),i.addColorStop(1,this.cachedClrDark),t.strokeStyle=i,t.beginPath(),t.moveTo(h+l+2*p+c,this.corner+c),t.lineTo(h+l+2*p+(a-2*p),this.corner+c),t.stroke(),(r=t.createLinearGradient(h+l+2*p+(a-2*p)-c,this.corner,h+l+2*p+(a-2*p)+.7*c,this.corner+c+.7*c)).addColorStop(0,this.cachedClr),r.addColorStop(1,this.cachedClrDark),t.strokeStyle=r,t.beginPath(),t.moveTo(h+l+2*p+(a-2*p),this.corner+c),t.lineTo(h+l+2*p+(a-2*p)+this.corner,c),t.stroke(),t.strokeStyle=o,t.beginPath(),t.moveTo(h+l+2*p+(a-2*p)+this.corner,c),t.lineTo(this.width()-this.corner-l,c),t.stroke()},RingCommandSlotMorph.prototype=new CommandSlotMorph,RingCommandSlotMorph.prototype.constructor=RingCommandSlotMorph,RingCommandSlotMorph.uber=CommandSlotMorph.prototype,RingCommandSlotMorph.prototype.rfBorder=0,RingCommandSlotMorph.prototype.edge=RingMorph.prototype.edge,RingCommandSlotMorph.prototype.init=function(t){RingCommandSlotMorph.uber.init.call(this,t),this.isHole=!0,this.noticesTransparentClick=!0,this.color=new Color(0,17,173),this.alpha=RingMorph.prototype.alpha,this.contrast=RingMorph.prototype.contrast},RingCommandSlotMorph.prototype.getSpec=function(){return"%rc"},RingCommandSlotMorph.prototype.drawNew=function(){var t;this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),(t=this.image.getContext("2d")).fillStyle=this.cachedClr,this.drawFlat(t),MorphicPreferences.isFlat||this.drawEdges(t)},RingCommandSlotMorph.prototype.drawFlat=function(t){var e=null!==this.nestedBlock(),o=e?this.inset:this.inset/2,i=e?this.dent:this.dent/2,r=2*this.corner+o,n=this.edge,s=this.width(),a=this.height(),h=e?this.rfBorder:0,l=a-this.corner-n;t.beginPath(),t.moveTo(0,a/2),t.lineTo(n,a/2),t.arc(this.corner+n,this.corner+n,this.corner,radians(-180),radians(-90),!1),t.lineTo(this.corner+o+n+2*h,n),t.lineTo(r+n+2*h,this.corner+n),t.lineTo(r+n+2*h+(i-2*h),this.corner+n),t.lineTo(r+n+2*h+(i-2*h)+this.corner,n),t.lineTo(this.width()-this.corner-n,n),t.arc(s-this.corner-n,this.corner+n,this.corner,radians(-90),radians(-0),!1),t.lineTo(s-this.edge,a/2),t.lineTo(s,a/2),t.lineTo(s,0),t.lineTo(0,0),t.closePath(),t.fill(),t.beginPath(),t.moveTo(s,a/2),t.lineTo(s-n,a/2),t.arc(this.width()-this.corner-n,l,this.corner,radians(0),radians(90),!1),t.arc(this.corner+n,l,this.corner,radians(90),radians(180),!1),t.lineTo(n,a/2),t.lineTo(0,a/2),t.lineTo(0,a),t.lineTo(s,a),t.closePath(),t.fill()},CSlotMorph.prototype=new CommandSlotMorph,CSlotMorph.prototype.constructor=CSlotMorph,CSlotMorph.uber=CommandSlotMorph.prototype,CSlotMorph.prototype.init=function(t){CommandSlotMorph.uber.init.call(this,null,!0),this.isHole=!0,this.isLambda=!1,this.color=new Color(0,17,173),this.setExtent(new Point(230,4*this.corner+this.cSlotPadding),t)},CSlotMorph.prototype.getSpec=function(){return"%c"},CSlotMorph.prototype.mappedCode=function(t){var e=(StageMorph.prototype.codeMappings.reify||"<#1>").split("\n"),o=this.nestedBlock(),i=(o?o.mappedCode(t):"").toString().split("\n"),r=new RegExp("<#1>","g");return e.forEach(function(t,o){var n,s="";0===t.trimLeft().indexOf("<#1>")&&(n=t.indexOf("<#1>"),s=t.slice(0,n)),e[o]=t.replace(new RegExp("<#1>"),i.join("\n"+s)),e[o]=e[o].replace(r,i.join("\n"))}),e.join("\n")},CSlotMorph.prototype.fixLayout=function(){var t=this.nestedBlock();t?(t.setPosition(new Point(this.left()+this.inset,this.top()+this.corner)),this.setHeight(t.fullBounds().height()+this.corner),this.setWidth(t.fullBounds().width()+2*this.cSlotPadding)):(this.setHeight(4*this.corner+this.cSlotPadding),this.setWidth(4*this.corner+2*this.inset+this.dent+2*this.cSlotPadding)),this.parent.fixLayout&&this.parent.fixLayout()},CSlotMorph.prototype.drawNew=function(){var t;this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),(t=this.image.getContext("2d")).fillStyle=this.cachedClr,this.drawFlat(t),MorphicPreferences.isFlat||(this.drawTopRightEdge(t),this.drawTopEdge(t,this.inset,this.corner),this.drawTopLeftEdge(t),this.drawBottomEdge(t),this.drawRightEdge(t))},CSlotMorph.prototype.drawFlat=function(t){t.beginPath(),t.moveTo(0,0),t.lineTo(this.width(),0),t.arc(this.width()-this.corner,0,this.corner,radians(90),radians(0),!0),t.lineTo(this.width()-this.corner,this.corner),t.lineTo(2*this.inset+3*this.corner+this.dent,this.corner),t.lineTo(2*this.inset+2*this.corner+this.dent,2*this.corner),t.lineTo(2*this.inset+2*this.corner,2*this.corner),t.lineTo(2*this.inset+this.corner,this.corner),t.lineTo(this.inset+this.corner,this.corner),t.arc(this.inset+this.corner,2*this.corner,this.corner,radians(270),radians(180),!0),t.lineTo(this.inset,this.height()-2*this.corner),t.arc(this.inset+this.corner,this.height()-2*this.corner,this.corner,radians(180),radians(90),!0),t.lineTo(this.width()-this.corner,this.height()-this.corner),t.arc(this.width()-this.corner,this.height(),this.corner,radians(-90),radians(-0),!1),t.lineTo(0,this.height()),t.closePath(),t.fill()},CSlotMorph.prototype.drawTopRightEdge=function(t){var e,o=.5*this.edge,i=this.width()-this.corner;(e=t.createRadialGradient(i,0,this.corner,i,0,this.corner-this.edge)).addColorStop(0,this.cachedClrDark),e.addColorStop(1,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.arc(i,0,this.corner-o,radians(90),radians(0),!0),t.stroke()},CSlotMorph.prototype.drawTopEdge=function(t,e,o){var i,r,n,s=.5*this.edge,a=e+2*this.corner+this.inset;t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",(i=t.createLinearGradient(0,o-this.edge,0,o)).addColorStop(0,this.cachedClr),i.addColorStop(1,this.cachedClrDark),t.strokeStyle=i,t.beginPath(),t.moveTo(e+this.corner,o-s),t.lineTo(e+this.corner+this.inset-s,o-s),t.stroke(),(r=t.createLinearGradient(0,o+this.corner-this.edge,0,o+this.corner)).addColorStop(0,this.cachedClr),r.addColorStop(1,this.cachedClrDark),t.strokeStyle=r,t.beginPath(),t.moveTo(a+s,o+this.corner-s),t.lineTo(a+this.dent,o+this.corner-s),t.stroke(),(n=t.createLinearGradient(e+this.inset+2*this.corner+this.dent-s,o+this.corner-s-s,e+this.inset+2*this.corner+this.dent+.7*s,o+this.corner-s+.7*s)).addColorStop(0,this.cachedClr),n.addColorStop(1,this.cachedClrDark),t.strokeStyle=n,t.beginPath(),t.moveTo(e+this.inset+2*this.corner+this.dent,o+this.corner-s),t.lineTo(e+3*this.corner+this.inset+this.dent,o-s),t.stroke(),t.strokeStyle=i,t.beginPath(),t.moveTo(e+3*this.corner+this.inset+this.dent,o-s),t.lineTo(this.width()-this.corner,o-s),t.stroke()},CSlotMorph.prototype.drawTopLeftEdge=function(t){var e,o=.5*this.edge;(e=t.createRadialGradient(this.corner+this.inset,2*this.corner,this.corner,this.corner+this.inset,2*this.corner,this.corner+this.edge)).addColorStop(0,this.cachedClrDark),e.addColorStop(1,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.arc(this.corner+this.inset,2*this.corner,this.corner+o,radians(-180),radians(-90),!1),t.stroke()},CSlotMorph.prototype.drawRightEdge=function(t){var e,o=.5*this.edge,i=this.inset;(e=t.createLinearGradient(i-this.edge,0,i,0)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.moveTo(i-o,2*this.corner),t.lineTo(i-o,this.height()-2*this.corner),t.stroke()},CSlotMorph.prototype.drawBottomEdge=function(t){var e,o,i=.5*this.edge;t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",(o=t.createRadialGradient(this.corner+this.inset,this.height()-2*this.corner,this.corner,this.corner+this.inset,this.height()-2*this.corner,this.corner+this.edge)).addColorStop(0,this.cachedClrBright),o.addColorStop(1,this.cachedClr),t.strokeStyle=o,t.beginPath(),t.arc(this.corner+this.inset,this.height()-2*this.corner,this.corner+i,radians(180),radians(90),!0),t.stroke(),(e=t.createLinearGradient(0,this.height()-this.corner,0,this.height()-this.corner+this.edge)).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(this.inset+this.corner,this.height()-this.corner+i),t.lineTo(this.width()-this.corner,this.height()-this.corner+i),t.stroke()},InputSlotMorph.prototype=new ArgMorph,InputSlotMorph.prototype.constructor=InputSlotMorph,InputSlotMorph.uber=ArgMorph.prototype,InputSlotMorph.prototype.init=function(t,e,o,i){var r=new StringMorph(""),n=new ArrowMorph("down",0,Math.max(Math.floor(this.fontSize/6),1));r.fontSize=this.fontSize,r.isShowingBlanks=!0,r.drawNew(),this.isUnevaluated=!1,this.choices=o||null,this.oldContentsExtent=r.extent(),this.isNumeric=e||!1,this.isReadOnly=i||!1,this.minWidth=0,this.constant=null,InputSlotMorph.uber.init.call(this,null,!0),this.color=new Color(255,255,255),this.add(r),this.add(n),r.isEditable=!0,r.isDraggable=!1,r.enableSelecting(),this.setContents(t)},InputSlotMorph.prototype.getSpec=function(){return this.isNumeric?"%n":"%s"},InputSlotMorph.prototype.contents=function(){return detect(this.children,function(t){return t instanceof StringMorph})},InputSlotMorph.prototype.arrow=function(){return detect(this.children,function(t){return t instanceof ArrowMorph})},InputSlotMorph.prototype.setContents=function(t){var e=this.contents(),o=t,i=o instanceof Array;if(i)o=localize(o[0]),e.isItalic=!this.isReadOnly;else if(e.isItalic=!1,!isNil(this.choices)&&this.choices[o]instanceof Array)return this.setContents(this.choices[o]);e.text=o,isNil(o)?e.text="":o.toString&&(e.text=o.toString()),e.drawNew(),this.isReadOnly&&this.parent instanceof BlockMorph&&this.parent.fixLabelColor(),this.constant=i?t:null},InputSlotMorph.prototype.userSetContents=function(t){this.selectForEdit().setContents(t)},InputSlotMorph.prototype.dropDownMenu=function(t){var e=this.menuFromDict(this.choices,null,t);e&&e.items.length>0&&(t?(e.popup(this.world(),this.bottomLeft()),e.getFocus()):e.popUpAtHand(this.world()))},InputSlotMorph.prototype.menuFromDict=function(t,e,o){var i,r=new MenuMorph(this.userSetContents,null,this,this.fontSize);if(t instanceof Function)t=t.call(this);else if(isString(t)&&!(t=this[t](o)))return;e||r.addItem(" ",null);for(i in t)Object.prototype.hasOwnProperty.call(t,i)&&("~"===i[0]?r.addLine():t[i]instanceof Object&&!(t[i]instanceof Array)&&"function"!=typeof t[i]?r.addMenu(i,this.menuFromDict(t[i],!0)):r.addItem(i,t[i]));return r},InputSlotMorph.prototype.messagesMenu=function(){var t={},e=this.parentThatIsA(BlockMorph).scriptTarget().parentThatIsA(StageMorph),o=this,i=[];return e.children.concat(e).forEach(function(t){isSnapObject(t)&&(i=i.concat(t.allMessageNames()))}),i.forEach(function(e){t[e]=e}),i.length>0&&(t["~"]=null),t["new..."]=function(){new DialogBoxMorph(o,o.setContents,o).prompt("Message name",null,o.world())},t},InputSlotMorph.prototype.messagesReceivedMenu=function(){var t={"any message":["any message"]},e=this.parentThatIsA(BlockMorph).scriptTarget().parentThatIsA(StageMorph),o=this,i=[];return e.children.concat(e).forEach(function(t){isSnapObject(t)&&(i=i.concat(t.allMessageNames()))}),i.forEach(function(e){t[e]=e}),t["~"]=null,t["new..."]=function(){new DialogBoxMorph(o,o.setContents,o).prompt("Message name",null,o.world())},t},InputSlotMorph.prototype.collidablesMenu=function(){var t={"mouse-pointer":["mouse-pointer"],edge:["edge"],"pen trails":["pen trails"]},e=this.parentThatIsA(BlockMorph).scriptTarget(),o=[];return e.parentThatIsA(StageMorph).children.forEach(function(t){t instanceof SpriteMorph&&!t.isTemporary&&t.name!==e.name&&(o=o.concat(t.name))}),o.length>0&&(t["~"]=null,o.forEach(function(e){t[e]=e})),t},InputSlotMorph.prototype.distancesMenu=function(){var t={"mouse-pointer":["mouse-pointer"]},e=this.parentThatIsA(BlockMorph).scriptTarget(),o=[];return e.parentThatIsA(StageMorph).children.forEach(function(t){t instanceof SpriteMorph&&!t.isTemporary&&t.name!==e.name&&(o=o.concat(t.name))}),o.length>0&&(t["~"]=null,o.forEach(function(e){t[e]=e})),t},InputSlotMorph.prototype.clonablesMenu=function(){var t={},e=this.parentThatIsA(BlockMorph).scriptTarget(),o=e.parentThatIsA(StageMorph),i=[];return e instanceof SpriteMorph&&(t.myself=["myself"]),o.children.forEach(function(t){t instanceof SpriteMorph&&!t.isTemporary&&(i=i.concat(t.name))}),i.length>0&&(t["~"]=null,i.forEach(function(e){t[e]=e})),t},InputSlotMorph.prototype.objectsMenu=function(){var t=this.parentThatIsA(BlockMorph).scriptTarget().parentThatIsA(StageMorph),e={},o=[];return e[t.name]=t.name,t.children.forEach(function(t){t instanceof SpriteMorph&&!t.isTemporary&&o.push(t.name)}),o.length>0&&(e["~"]=null,o.forEach(function(t){e[t]=t})),e},InputSlotMorph.prototype.typesMenu=function(){var t={number:["number"],text:["text"],Boolean:["Boolean"],list:["list"]};return SpriteMorph.prototype.enableFirstClass&&(t.sprite=["sprite"]),t.costume=["costume"],t.sound=["sound"],t.command=["command"],t.reporter=["reporter"],t.predicate=["predicate"],t},InputSlotMorph.prototype.gettablesMenu=function(){var t={neighbors:["neighbors"],self:["self"],"other sprites":["other sprites"],clones:["clones"],"other clones":["other clones"]};return SpriteMorph.prototype.enableNesting&&(t.parts=["parts"],t.anchor=["anchor"]),t.stage=["stage"],StageMorph.prototype.enableInheritance&&(t.children=["children"],t.parent=["parent"],this.world().isDevMode&&(t["temporary?"]=["temporary?"])),t.name=["name"],t.costumes=["costumes"],t.sounds=["sounds"],t["dangling?"]=["dangling?"],t["rotation x"]=["rotation x"],t["rotation y"]=["rotation y"],t["center x"]=["center x"],t["center y"]=["center y"],t},InputSlotMorph.prototype.attributesMenu=function(){var t,e=this.parentThatIsA(BlockMorph),o=e.inputs()[1].evaluate(),i=e.scriptTarget().parentThatIsA(StageMorph),r={},n=[];return(t=o===i.name?i:detect(i.children,function(t){return t.name===o}))?(r=t instanceof SpriteMorph?{"x position":["x position"],"y position":["y position"],direction:["direction"],"costume #":["costume #"],"costume name":["costume name"],size:["size"]}:{"costume #":["costume #"],"costume name":["costume name"]},(n=t.variables.names()).length>0&&(r["~"]=null,n.forEach(function(t){r[t]=t})),r):r},InputSlotMorph.prototype.costumesMenu=function(){var t,e=this.parentThatIsA(BlockMorph).scriptTarget(),o=[];return t=e instanceof SpriteMorph?{Turtle:["Turtle"]}:{Empty:["Empty"]},e.costumes.asArray().forEach(function(t){o=o.concat(t.name)}),o.length>0&&(t["~"]=null,o.forEach(function(e){t[e]=e})),t},InputSlotMorph.prototype.soundsMenu=function(){var t=[],e={};return this.parentThatIsA(BlockMorph).scriptTarget().sounds.asArray().forEach(function(e){t=t.concat(e.name)}),t.length>0&&t.forEach(function(t){e[t]=t}),e},InputSlotMorph.prototype.shadowedVariablesMenu=function(){var t,e=this.parentThatIsA(BlockMorph),o={};return e?(t=e.scriptTarget(),this.parentThatIsA(RingMorph)?(t.variables.names().forEach(function(t){o[t]=t}),t.attributes.forEach(function(t){o[t]=[t]})):t&&t.exemplar&&(t.inheritedVariableNames(!0).forEach(function(t){o[t]=t}),t.shadowedAttributes().forEach(function(t){o[t]=[t]})),o):o},InputSlotMorph.prototype.pianoKeyboardMenu=function(){var t,e,o;(e=this.parentThatIsA(BlockMorph))&&(o=e.scriptTarget().instrument),(t=new PianoMenuMorph(this.setContents,this,this.fontSize,o)).popup(this.world(),new Point(this.right()-t.width()/2,this.bottom())),t.selectKey(this.evaluate())},InputSlotMorph.prototype.setChoices=function(t,e){var o=this.contents();this.choices=t,this.isReadOnly=e||!1,this.parent instanceof BlockMorph&&(this.parent.fixLabelColor(),e||(o.shadowOffset=new Point,o.shadowColor=null,o.setColor(new Color(0,0,0)))),this.fixLayout()},InputSlotMorph.prototype.fixLayout=function(){var t,e,o,i=this.contents(),r=this.arrow();i.isNumeric=this.isNumeric,i.isEditable=!this.isReadOnly,this.isReadOnly?(i.disableSelecting(),i.color=new Color(254,254,254)):(i.enableSelecting(),i.color=new Color(0,0,0)),this.choices?(r.setSize(this.fontSize),r.show()):r.hide(),o=r.isVisible?r.width():0,e=i.height()+2*this.edge,t=this.isNumeric?i.width()+Math.floor(.5*o)+e+2*this.typeInPadding:Math.max(i.width()+o+2*this.edge+2*this.typeInPadding,i.rawHeight?i.rawHeight()+o:fontHeight(i.fontSize)/1.3+o,this.minWidth),this.setExtent(new Point(t,e)),this.isNumeric?i.setPosition(new Point(Math.floor(e/2),this.edge).add(new Point(this.typeInPadding,0)).add(this.position())):i.setPosition(new Point(this.edge,this.edge).add(new Point(this.typeInPadding,0)).add(this.position())),r.isVisible&&r.setPosition(new Point(this.right()-o-this.edge,i.top())),this.parent&&this.parent.fixLayout&&(this.world()?(this.startLayout(),this.parent.fixLayout(),this.endLayout()):this.parent.fixLayout())},InputSlotMorph.prototype.mouseDownLeft=function(t){var e;this.isReadOnly||this.arrow().bounds.containsPoint(t)?this.escalateEvent("mouseDownLeft",t):((e=this.world())&&e.stopEditing(),this.selectForEdit().contents().edit())},InputSlotMorph.prototype.mouseClickLeft=function(t){this.arrow().bounds.containsPoint(t)?this.dropDownMenu():this.isReadOnly?this.dropDownMenu():this.contents().edit()},InputSlotMorph.prototype.reactToKeystroke=function(){var t;this.constant&&(t=this.contents(),this.constant=null,t.isItalic=!1,t.drawNew())},InputSlotMorph.prototype.reactToEdit=function(){this.contents().clearSelection()},InputSlotMorph.prototype.freshTextEdit=function(t){this.onNextStep=function(){t.selectAll()}},InputSlotMorph.prototype.userMenu=function(){var t=new MenuMorph(this);return StageMorph.prototype.enableCodeMapping?(this.isNumeric?t.addItem("code number mapping...","mapNumberToCode"):t.addItem("code string mapping...","mapStringToCode"),t):this.parent.userMenu()},InputSlotMorph.prototype.mapStringToCode=function(){new DialogBoxMorph(this,function(t){StageMorph.prototype.codeMappings.string=t},this).promptCode("Code mapping - String <#1>",StageMorph.prototype.codeMappings.string||"",this.world())},InputSlotMorph.prototype.mapNumberToCode=function(){new DialogBoxMorph(this,function(t){StageMorph.prototype.codeMappings.number=t},this).promptCode("Code mapping - Number <#1>",StageMorph.prototype.codeMappings.number||"",this.world())},InputSlotMorph.prototype.mappedCode=function(){var t=this.parentThatIsA(BlockMorph),e=this.evaluate();return this.isNumeric?(StageMorph.prototype.codeMappings.number||"<#1>").replace(/<#1>/g,e):isNaN(parseFloat(e))&&isString(e)?t&&contains(["doSetVar","doChangeVar","doShowVar","doHideVar"],t.selector)?e:(StageMorph.prototype.codeMappings.string||"<#1>").replace(/<#1>/g,e):e},InputSlotMorph.prototype.evaluate=function(){var t,e=this.contents();return this.constant?this.constant:this.isNumeric&&(t=parseFloat(e.text||"0"),!isNaN(t))?t:e.text},InputSlotMorph.prototype.isEmptySlot=function(){return""===this.contents().text},InputSlotMorph.prototype.flash=function(){this.cachedNormalColor||(this.cachedNormalColor=this.color,this.color=this.activeHighlight,this.drawNew(),this.changed())},InputSlotMorph.prototype.unflash=function(){if(this.cachedNormalColor){var t=this.cachedNormalColor;this.cachedNormalColor=null,this.color=t,this.drawNew(),this.changed()}},InputSlotMorph.prototype.drawNew=function(){var t,e,o;this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),e=this.cachedNormalColor?this.color:this.parent?this.parent.color:new Color(120,120,120),t.fillStyle=this.color.toString(),this.isReadOnly&&!this.cachedNormalColor&&(t.fillStyle=e.darker().toString()),this.cachedClr=e.toString(),this.cachedClrBright=e.lighter(this.contrast).toString(),this.cachedClrDark=e.darker(this.contrast).toString(),this.isNumeric?(o=(this.height()-2*this.edge)/2,t.beginPath(),t.arc(o+this.edge,o+this.edge,o,radians(90),radians(-90),!1),t.arc(this.width()-o-this.edge,o+this.edge,o,radians(-90),radians(90),!1),t.closePath(),t.fill(),MorphicPreferences.isFlat||this.drawRoundBorder(t)):(t.fillRect(this.edge,this.edge,this.width()-2*this.edge,this.height()-2*this.edge),MorphicPreferences.isFlat||this.drawRectBorder(t))},InputSlotMorph.prototype.drawRectBorder=function(t){var e,o=.5*this.edge;t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.shadowOffsetY=o,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString(),(e=t.createLinearGradient(0,0,0,this.edge)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(this.edge,o),t.lineTo(this.width()-this.edge-o,o),t.stroke(),t.shadowOffsetY=0,(e=t.createLinearGradient(0,0,this.edge,0)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(o,this.edge),t.lineTo(o,this.height()-this.edge-o),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,(e=t.createLinearGradient(0,this.height()-this.edge,0,this.height())).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(this.edge,this.height()-o),t.lineTo(this.width()-this.edge,this.height()-o),t.stroke(),(e=t.createLinearGradient(this.width()-this.edge,0,this.width(),0)).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(this.width()-o,this.edge),t.lineTo(this.width()-o,this.height()-this.edge),t.stroke()},InputSlotMorph.prototype.drawRoundBorder=function(t){var e,o,i,r=.5*this.edge,n=(this.height()-2*this.edge)/2;t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",e=n+this.edge,(o=this.width()-n-this.edge)>e&&(t.shadowOffsetX=r,t.shadowOffsetY=r,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString(),(i=t.createLinearGradient(0,0,0,this.edge)).addColorStop(0,this.cachedClr),i.addColorStop(1,this.cachedClrDark),t.strokeStyle=i,t.beginPath(),t.moveTo(e,r),t.lineTo(o,r),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0),(i=t.createLinearGradient(0,this.height()-this.edge,0,this.height())).addColorStop(0,this.cachedClrBright),i.addColorStop(1,this.cachedClr),t.strokeStyle=i,t.beginPath(),t.moveTo(n+this.edge,this.height()-r),t.lineTo(this.width()-n-this.edge,this.height()-r),t.stroke(),n=this.height()/2,t.shadowOffsetX=r,t.shadowOffsetY=r,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString(),(i=t.createRadialGradient(n,n,n-this.edge,n,n,n)).addColorStop(1,this.cachedClr),i.addColorStop(0,this.cachedClrDark),t.strokeStyle=i,t.beginPath(),t.arc(n,n,n-r,radians(180),radians(270),!1),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,(i=t.createRadialGradient(this.width()-n,n,n-this.edge,this.width()-n,n,n)).addColorStop(1,this.cachedClr),i.addColorStop(0,this.cachedClrBright),t.strokeStyle=i,t.beginPath(),t.arc(this.width()-n,n,n-r,radians(0),radians(90),!1),t.stroke()},TemplateSlotMorph.prototype=new ArgMorph,TemplateSlotMorph.prototype.constructor=TemplateSlotMorph,TemplateSlotMorph.uber=ArgMorph.prototype,TemplateSlotMorph.prototype.init=function(t){var e=new ReporterBlockMorph;this.labelString=t||"",e.isDraggable=!1,e.isTemplate=!0,void 0!==modules.objects?(e.color=SpriteMorph.prototype.blockColor.variables,e.category="variables"):(e.color=new Color(243,118,29),e.category=null),e.setSpec(this.labelString),e.selector="reportGetVar",TemplateSlotMorph.uber.init.call(this),this.add(e),this.fixLayout(),this.isDraggable=!1,this.isStatic=!0},TemplateSlotMorph.prototype.getSpec=function(){return"%t"},TemplateSlotMorph.prototype.template=function(){return this.children[0]},TemplateSlotMorph.prototype.contents=function(){return this.template().blockSpec},TemplateSlotMorph.prototype.setContents=function(t){var e=this.template();e.setSpec(t),e.fixBlockColor(),e.fixLabelColor()},TemplateSlotMorph.prototype.evaluate=function(){return this.contents()},TemplateSlotMorph.prototype.fixLayout=function(){var t=this.template();this.setExtent(t.extent().add(2*this.edge+2)),t.setPosition(this.position().add(this.edge+1)),this.parent&&this.parent.fixLayout&&this.parent.fixLayout()},TemplateSlotMorph.prototype.wantsDropOf=function(t){return"reportGetVar"===t.selector},TemplateSlotMorph.prototype.reactToDropOf=function(t){"reportGetVar"===t.selector&&t.destroy()},TemplateSlotMorph.prototype.drawNew=function(){var t;this.parent instanceof Morph&&(this.color=this.parent.color.copy()),this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),(t=this.image.getContext("2d")).fillStyle=this.cachedClr,this.drawRounded(t)},TemplateSlotMorph.prototype.drawRounded=ReporterBlockMorph.prototype.drawRounded,TemplateSlotMorph.prototype.flash=function(){this.template().flash()},TemplateSlotMorph.prototype.unflash=function(){this.template().unflash()},BooleanSlotMorph.prototype=new ArgMorph,BooleanSlotMorph.prototype.constructor=BooleanSlotMorph,BooleanSlotMorph.uber=ArgMorph.prototype,BooleanSlotMorph.prototype.isTernary=!0,BooleanSlotMorph.prototype.init=function(t){this.value="boolean"==typeof t?t:null,this.isUnevaluated=!1,BooleanSlotMorph.uber.init.call(this)},BooleanSlotMorph.prototype.getSpec=function(){return this.isUnevaluated?"%boolUE":"%b"},BooleanSlotMorph.prototype.evaluate=function(){return this.value},BooleanSlotMorph.prototype.isEmptySlot=function(){return null===this.value},BooleanSlotMorph.prototype.isBinary=function(){return!this.isTernary&&isNil(this.parentThatIsA(RingMorph))&&!isNil(this.parentThatIsA(ScriptsMorph))},BooleanSlotMorph.prototype.setContents=function(t,e){this.value="boolean"==typeof t?t:null,e||(this.drawNew(),this.changed())},BooleanSlotMorph.prototype.toggleValue=function(){var t,e=this.selectForEdit();if(e!==this)return this.toggleValue.call(e);if(t=this.parentThatIsA(IDE_Morph),this.isStatic||this.isBinary())this.setContents(!this.value,!0);else switch(this.value){case!0:this.value=!1;break;case!1:this.value=null;break;default:this.value=!0}if(t&&!t.isAnimating)return this.drawNew(),void this.changed();this.drawNew(3),this.changed(),this.nextSteps([function(){this.drawNew(2),this.changed()},function(){this.drawNew(1),this.changed()},function(){this.drawNew(),this.changed()}])},BooleanSlotMorph.prototype.mouseClickLeft=function(){this.toggleValue(),isNil(this.value)||this.reactToSliderEdit()},BooleanSlotMorph.prototype.mouseEnter=function(){if(!this.isStatic){if(!1===this.value&&!this.isBinary()){var t=this.value;return this.value=null,this.drawNew(3),this.changed(),void(this.value=t)}this.drawNew(1),this.changed()}},BooleanSlotMorph.prototype.mouseLeave=function(){this.isStatic||(this.drawNew(),this.changed())},BooleanSlotMorph.prototype.userMenu=function(){var t=new MenuMorph(this);return StageMorph.prototype.enableCodeMapping?(!0===this.evaluate()?t.addItem("code true mapping...","mapTrueToCode"):t.addItem("code false mapping...","mapFalseToCode"),t):this.parent.userMenu()},BooleanSlotMorph.prototype.mapTrueToCode=function(){new DialogBoxMorph(this,function(t){StageMorph.prototype.codeMappings.true=t},this).promptCode("Code mapping - true",StageMorph.prototype.codeMappings.true||"true",this.world())},BooleanSlotMorph.prototype.mapFalseToCode=function(){new DialogBoxMorph(this,function(t){StageMorph.prototype.codeMappings.false=t},this).promptCode("Code mapping - false",StageMorph.prototype.codeMappings.false||"false",this.world())},BooleanSlotMorph.prototype.mappedCode=function(){return!0===this.evaluate()?StageMorph.prototype.codeMappings.boolTrue||"true":StageMorph.prototype.codeMappings.boolFalse||"false"},BooleanSlotMorph.prototype.drawNew=function(t){var e,o,i=this.isStatic?this.textLabel():null;i?(o=i.height+3*this.edge,this.silentSetExtent(new Point(i.width+1.5*o+2*this.edge,o))):this.silentSetExtent(new Point(2*(this.fontSize+2*this.edge),this.fontSize+2*this.edge)),this.cachedNormalColor||(this.color=this.parent?this.parent.color:new Color(200,200,200)),this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),e=this.image.getContext("2d"),this.drawDiamond(e,t),this.drawLabel(e,i),this.drawKnob(e,t)},BooleanSlotMorph.prototype.drawDiamond=function(t,e){var o,i=this.width(),r=this.height(),n=r/2,s=i/2,a=this.edge/2;if(this.cachedNormalColor)t.fillStyle=this.color.toString();else switch(this.value){case!0:t.fillStyle="rgb(0, 200, 0)";break;case!1:t.fillStyle="rgb(200, 0, 0)";break;default:t.fillStyle=this.color.darker(25).toString()}e&&!this.isEmptySlot()?(t.fillStyle="rgb(0, 200, 0)",t.beginPath(),t.moveTo(0,n),t.lineTo(n,0),t.lineTo(s,0),t.lineTo(s,r),t.lineTo(n,r),t.closePath(),t.fill(),t.fillStyle="rgb(200, 0, 0)",t.beginPath(),t.moveTo(s,0),t.lineTo(i-n,0),t.lineTo(i,n),t.lineTo(i-n,r),t.lineTo(s,r),t.closePath(),t.fill()):(t.beginPath(),t.moveTo(0,n),t.lineTo(n,0),t.lineTo(i-n,0),t.lineTo(i,n),t.lineTo(i-n,r),t.lineTo(n,r),t.closePath(),t.fill()),MorphicPreferences.isFlat||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.shadowOffsetX=a,t.shadowBlur=a,t.shadowColor="black",(o=t.createLinearGradient(0,n,.6*this.edge,n+.6*this.edge)).addColorStop(1,this.cachedClrDark),o.addColorStop(0,this.cachedClr),t.strokeStyle=o,t.beginPath(),t.moveTo(a,n),t.lineTo(n,a),t.closePath(),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=a,t.shadowBlur=this.edge,(o=t.createLinearGradient(0,0,0,this.edge)).addColorStop(1,this.cachedClrDark),o.addColorStop(0,this.cachedClr),t.strokeStyle=o,t.beginPath(),t.moveTo(n,a),t.lineTo(i-n,a),t.closePath(),t.stroke(),t.shadowOffsetY=0,t.shadowBlur=0,(o=t.createLinearGradient(i-n-.6*this.edge,r-.6*this.edge,i-n,r)).addColorStop(1,this.cachedClr),o.addColorStop(0,this.cachedClrBright),t.strokeStyle=o,t.beginPath(),t.moveTo(i-n,r-a),t.lineTo(i-a,n),t.closePath(),t.stroke(),(o=t.createLinearGradient(0,r-this.edge,0,r)).addColorStop(1,this.cachedClr),o.addColorStop(0,this.cachedClrBright),t.strokeStyle=o,t.beginPath(),t.moveTo(n,r-a),t.lineTo(i-n-a,r-a),t.closePath(),t.stroke())},BooleanSlotMorph.prototype.drawLabel=function(t,e){var o,i=this.width(),r=this.height()/2-this.edge,n=r/2,s=this.edge/2,a=this.height()/2;if(!this.isEmptySlot()){if(e)return a=(this.height()-e.height)/2,o=this.value?this.height()/2:this.width()-this.height()/2-e.width,MorphicPreferences.isFlat||(t.shadowOffsetX=-s,t.shadowOffsetY=-s,t.shadowBlur=s,t.shadowColor=this.value?"rgb(0, 100, 0)":"rgb(100, 0, 0)"),void t.drawImage(e,o,a);o=r+2*this.edge+s,MorphicPreferences.isFlat||(t.shadowOffsetX=-s,t.shadowOffsetY=-s,t.shadowBlur=s,t.shadowColor="rgb(0, 100, 0)"),t.strokeStyle="white",t.lineWidth=this.edge+s,t.lineCap="round",t.lineJoin="miter",t.beginPath(),t.moveTo(o-n,a),t.lineTo(o,a+n),t.lineTo(o+n,n+this.edge),t.stroke(),o=i-a-2*this.edge,MorphicPreferences.isFlat||(t.shadowOffsetX=-s,t.shadowOffsetY=-s,t.shadowBlur=s,t.shadowColor="rgb(100, 0, 0)"),t.strokeStyle="white",t.lineWidth=this.edge,t.lineCap="butt",t.beginPath(),t.moveTo(o-n,a-n),t.lineTo(o+n,a+n),t.moveTo(o-n,a+n),t.lineTo(o+n,a-n),t.stroke()}},BooleanSlotMorph.prototype.drawKnob=function(t,e){var o,i,r=this.width(),n=this.height()/2,s=this.edge/2,a=(this.width()-this.height())/4*(e||0),h=n,l=PushButtonMorph.prototype.outline/2,p=PushButtonMorph.prototype.outlineColor,c=PushButtonMorph.prototype.color,d=PushButtonMorph.prototype.contrast,u=c.lighter(d),g=c.darker(d);switch(this.value){case!1:i=n+a,MorphicPreferences.isFlat||(t.shadowOffsetX=s,t.shadowOffsetY=0,t.shadowBlur=s,t.shadowColor="black");break;case!0:i=r-n-a,MorphicPreferences.isFlat||(t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0);break;default:if(!e)return;i=n,MorphicPreferences.isFlat||(t.shadowOffsetX=s,t.shadowOffsetY=0,t.shadowBlur=s,t.shadowColor="black"),t.globalAlpha=.2*((e||0)+1)}t.fillStyle=c.toString(),t.beginPath(),t.arc(i,h,n,radians(0),radians(360)),t.closePath(),t.fill(),MorphicPreferences.isFlat||(t.shadowOffsetX=0,t.shadowBlur=0,t.shadowColor="black",t.lineWidth=l,t.strokeStyle=p.toString(),t.beginPath(),t.arc(i,h,n-l/2,radians(0),radians(360)),t.stroke(),(o=t.createRadialGradient(i,h,n-l-this.edge,i,h,n-l)).addColorStop(1,u.toString()),o.addColorStop(0,c.toString()),t.strokeStyle=o,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.arc(i,h,n-l-this.edge/2,radians(180),radians(270),!1),t.stroke(),(o=t.createRadialGradient(i,h,n-l-this.edge,i,h,n-l)).addColorStop(1,g.toString()),o.addColorStop(0,c.toString()),t.strokeStyle=o,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.arc(i,h,n-l-this.edge/2,radians(0),radians(90),!1),t.stroke())},BooleanSlotMorph.prototype.textLabel=function(){if(this.isEmptySlot())return null;var t,e,o,i,r,n;return t=new StringMorph(localize("true"),this.fontSize,null,!0,null,null,null,null,new Color(255,255,255)).image,e=new StringMorph(localize("false"),this.fontSize,null,!0,null,null,null,null,new Color(255,255,255)).image,o=newCanvas(new Point(Math.max(t.width,e.width),Math.max(t.height,e.height))),i=this.value?t:e,r=(o.width-i.width)/2,n=(o.height-i.height)/2,o.getContext("2d").drawImage(i,r,n),o},ArrowMorph.prototype=new Morph,ArrowMorph.prototype.constructor=ArrowMorph,ArrowMorph.uber=Morph.prototype,ArrowMorph.prototype.init=function(t,e,o,i){this.direction=t||"down",this.size=e||(0===e?0:50),this.padding=o||0,ArrowMorph.uber.init.call(this,!0),this.color=i||new Color(0,0,0),this.setExtent(new Point(this.size,this.size))},ArrowMorph.prototype.setSize=function(t){var e=Math.max(t,1);this.size=t,this.setExtent(new Point(e,e))},ArrowMorph.prototype.drawNew=function(){this.image=newCanvas(this.extent());var t=this.image.getContext("2d"),e=this.padding,o=this.height(),i=Math.floor(o/2),r=this.width(),n=Math.floor(r/2);t.fillStyle=this.color.toString(),t.beginPath(),"down"===this.direction?(t.moveTo(e,i),t.lineTo(r-e,i),t.lineTo(n,o-e)):"up"===this.direction?(t.moveTo(e,i),t.lineTo(r-e,i),t.lineTo(n,e)):"left"===this.direction?(t.moveTo(e,i),t.lineTo(n,e),t.lineTo(n,o-e)):(t.moveTo(n,e),t.lineTo(r-e,i),t.lineTo(n,o-e)),t.closePath(),t.fill()},TextSlotMorph.prototype=new InputSlotMorph,TextSlotMorph.prototype.constructor=TextSlotMorph,TextSlotMorph.uber=InputSlotMorph.prototype,TextSlotMorph.prototype.init=function(t,e,o,i){var r=new TextMorph(""),n=new ArrowMorph("down",0,Math.max(Math.floor(this.fontSize/6),1));r.fontSize=this.fontSize,r.drawNew(),this.isUnevaluated=!1,this.choices=o||null,this.oldContentsExtent=r.extent(),this.isNumeric=e||!1,this.isReadOnly=i||!1,this.minWidth=0,this.constant=null,InputSlotMorph.uber.init.call(this,null,null,null,null,!0),this.color=new Color(255,255,255),this.add(r),this.add(n),r.isEditable=!0,r.isDraggable=!1,r.enableSelecting(),this.setContents(t)},TextSlotMorph.prototype.getSpec=function(){return this.isNumeric?"%mln":"%mlt"},TextSlotMorph.prototype.contents=function(){return detect(this.children,function(t){return t instanceof TextMorph})},TextSlotMorph.prototype.layoutChanged=function(){this.fixLayout()},ColorSlotMorph.prototype=new ArgMorph,ColorSlotMorph.prototype.constructor=ColorSlotMorph,ColorSlotMorph.uber=ArgMorph.prototype,ColorSlotMorph.prototype.init=function(t){ColorSlotMorph.uber.init.call(this,null,!0),this.setColor(t||new Color(145,26,68))},ColorSlotMorph.prototype.getSpec=function(){return"%clr"},ColorSlotMorph.prototype.getUserColor=function(){var t=this,e=this.world(),o=e.hand,i=getDocumentPositionOf(e.worldCanvas),r=o.processMouseMove,n=o.processMouseDown,s=o.processMouseUp,a=new ColorPaletteMorph(null,new Point(16*this.fontSize,10*this.fontSize));e.add(a),a.setPosition(this.bottomLeft().add(new Point(0,this.edge))),o.processMouseMove=function(r){var n=e.getGlobalPixelColor(o.position());o.setPosition(new Point(r.pageX-i.x,r.pageY-i.y)),n.a&&t.setColor(n)},o.processMouseDown=nop,o.processMouseUp=function(){a.destroy(),o.processMouseMove=r,o.processMouseDown=n,o.processMouseUp=s}},ColorSlotMorph.prototype.mouseClickLeft=function(){this.selectForEdit().getUserColor()},ColorSlotMorph.prototype.evaluate=function(){return this.color},ColorSlotMorph.prototype.drawNew=function(){var t,e,o;o=this.fontSize+2*this.edge+2*this.typeInPadding,this.silentSetExtent(new Point(o,o)),this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),e=this.parent?this.parent.color:new Color(120,120,120),t.fillStyle=this.color.toString(),this.cachedClr=e.toString(),this.cachedClrBright=e.lighter(this.contrast).toString(),this.cachedClrDark=e.darker(this.contrast).toString(),t.fillRect(this.edge,this.edge,this.width()-2*this.edge,this.height()-2*this.edge),MorphicPreferences.isFlat||this.drawRectBorder(t)},ColorSlotMorph.prototype.drawRectBorder=InputSlotMorph.prototype.drawRectBorder,BlockHighlightMorph.prototype=new Morph,BlockHighlightMorph.prototype.constructor=BlockHighlightMorph,BlockHighlightMorph.uber=Morph.prototype,BlockHighlightMorph.prototype.readout=function(){return this.children.length?this.children[0]:null},BlockHighlightMorph.prototype.updateReadout=function(){var t=this.readout(),e=useBlurredShadows&&!MorphicPreferences.isFlat?.4*SyntaxElementMorph.prototype.activeBlur:-2*SyntaxElementMorph.prototype.activeBorder;this.threadCount<2?t&&t.destroy():(t?(t.contents=this.threadCount.toString(),t.fullChanged(),t.drawNew(),t.fullChanged()):(t=new SpeechBubbleMorph(this.threadCount.toString(),this.color,null,null,this.color.darker(),null,1),this.add(t)),t.setPosition(this.position().add(e)))},MultiArgMorph.prototype=new ArgMorph,MultiArgMorph.prototype.constructor=MultiArgMorph,MultiArgMorph.uber=ArgMorph.prototype,MultiArgMorph.prototype.init=function(t,e,o,i,r,n,s,a,h){var l,p,c,d,u=new FrameMorph;for(this.slotSpec=t||"%s",this.labelText=localize(e||""),this.minInputs=o||0,this.elementSpec=i||null,this.labelColor=n||null,this.shadowColor=s||null,this.shadowOffset=a||null,this.canBeEmpty=!0,MultiArgMorph.uber.init.call(this,null,!0),this.alpha=!1===h?1:0,u.alpha=!1===h?1:0,u.noticesTransparentClick=!0,this.noticesTransparentclick=!0,l=this.labelPart(this.labelText),this.add(l),l.hide(),p=new ArrowMorph("left",this.fontSize,Math.max(Math.floor(this.fontSize/6),1),r),c=new ArrowMorph("right",this.fontSize,Math.max(Math.floor(this.fontSize/6),1),r),u.add(p),u.add(c),u.drawNew(),u.acceptsDrops=!1,this.add(u),d=0;d<this.minInputs;d+=1)this.addInput()},MultiArgMorph.prototype.label=function(){return this.children[0]},MultiArgMorph.prototype.arrows=function(){return this.children[this.children.length-1]},MultiArgMorph.prototype.getSpec=function(){return"%mult"+this.slotSpec},MultiArgMorph.prototype.setContents=function(t){var e,o=this.inputs();for(e=0;e<t.length;e+=1)null!==t[e]&&o[e]&&o[e].setContents(t[e])},MultiArgMorph.prototype.hide=function(){this.isVisible=!1,this.changed()},MultiArgMorph.prototype.show=function(){this.isVisible=!0,this.changed()},MultiArgMorph.prototype.setLabelColor=function(t,e,o){this.textColor=t,this.shadowColor=e,this.shadowOffset=o,MultiArgMorph.uber.setLabelColor.call(this,t,e,o)},MultiArgMorph.prototype.fixLayout=function(){if("%t"===this.slotSpec&&(this.isStatic=!0),this.parent){var t,e,o=this.label();this.color=this.parent.color,t=this.shadowColor||this.parent.color.darker(this.labelContrast),e=this.shadowOffset||o.shadowOffset,this.arrows().color=this.color,""!==this.labelText&&(o.shadowColor.eq(t)||(o.shadowColor=t,o.shadowOffset=e,o.drawNew()))}this.fixArrowsLayout(),MultiArgMorph.uber.fixLayout.call(this),this.parent&&this.parent.fixLayout()},MultiArgMorph.prototype.fixArrowsLayout=function(){var t=this.label(),e=this.arrows(),o=e.children[0],i=e.children[1],r=new Point(i.width()/2,i.height());this.inputs().length<this.minInputs+1?(t.hide(),o.hide(),i.setPosition(e.position().subtract(new Point(r.x,0))),e.setExtent(r)):(""!==this.labelText&&t.show(),o.show(),i.setPosition(o.topCenter()),e.bounds.corner=i.bottomRight().copy()),e.drawNew()},MultiArgMorph.prototype.refresh=function(){this.inputs().forEach(function(t){t.drawNew()})},MultiArgMorph.prototype.drawNew=function(){MultiArgMorph.uber.drawNew.call(this),this.refresh()},MultiArgMorph.prototype.addInput=function(t){var e,o,i=this.labelPart(this.slotSpec),r=this.children.length-1;if(t)i.setContents(t);else if("%scriptVars"===this.elementSpec||"%blockVars"===this.elementSpec){for(o="",e=r;e>0;)o=String.fromCharCode(97+(e-1)%26)+o,e=Math.floor((e-1)/26);i.setContents(o)}else contains(["%parms","%ringparms"],this.elementSpec)&&i.setContents("#"+r);i.parent=this,this.children.splice(r,0,i),i.drawNew(),this.fixLayout()},MultiArgMorph.prototype.removeInput=function(){var t,e;this.children.length>1&&(t=this.children[this.children.length-2],this.removeChild(t),t instanceof BlockMorph&&(e=this.parentThatIsA(ScriptsMorph))&&e.add(t)),this.fixLayout()},MultiArgMorph.prototype.mouseClickLeft=function(t){if(this.parentThatIsA(ScriptsMorph)){var e,o=this.selectForEdit(),i=o.arrows(),r=i.children[0],n=i.children[1],s=16===o.world().currentKey?3:1;if(o.startLayout(),n.bounds.containsPoint(t))for(e=0;e<s;e+=1)n.isVisible&&o.addInput();else if(r.bounds.containsPoint(t))for(e=0;e<s;e+=1)r.isVisible&&o.removeInput();else o.escalateEvent("mouseClickLeft",t);o.endLayout()}else this.escalateEvent("mouseClickLeft",t)},MultiArgMorph.prototype.userMenu=function(){var t=new MenuMorph(this),e=this.parentThatIsA(BlockMorph),o="",i=this;return StageMorph.prototype.enableCodeMapping?(e&&(e instanceof RingMorph?o="parms_":"doDeclareVariables"===e.selector&&(o="tempvars_")),t.addItem("code list mapping...",function(){i.mapCodeList(o)}),t.addItem("code item mapping...",function(){i.mapCodeItem(o)}),t.addItem("code delimiter mapping...",function(){i.mapCodeDelimiter(o)}),t):this.parent.userMenu()},MultiArgMorph.prototype.mapCodeDelimiter=function(t){this.mapToCode(t+"delim","list item delimiter")},MultiArgMorph.prototype.mapCodeList=function(t){this.mapToCode(t+"list","list contents <#1>")},MultiArgMorph.prototype.mapCodeItem=function(t){this.mapToCode(t+"item","list item <#1>")},MultiArgMorph.prototype.mapToCode=function(t,e){new DialogBoxMorph(this,function(e){StageMorph.prototype.codeMappings[t]=e},this).promptCode("Code mapping - "+e,StageMorph.prototype.codeMappings[t]||"",this.world())},MultiArgMorph.prototype.mappedCode=function(t){var e,o,i,r=this.parentThatIsA(BlockMorph),n="",s="",a=0,h=[];return r&&(r instanceof RingMorph?n="parms_":"doDeclareVariables"===r.selector&&(n="tempvars_")),e=StageMorph.prototype.codeMappings[n+"list"]||"<#1>",o=StageMorph.prototype.codeMappings[n+"item"]||"<#1>",i=StageMorph.prototype.codeMappings[n+"delim"]||" ",this.inputs().forEach(function(e){h.push(o.replace(/<#1>/g,e.mappedCode(t)))}),h.forEach(function(t){a&&(s+=i),s+=t,a+=1}),e=e.replace(/<#1>/g,s)},MultiArgMorph.prototype.evaluate=function(){var t=[];return this.inputs().forEach(function(e){t.push(e.evaluate())}),t},MultiArgMorph.prototype.isEmptySlot=function(){return!!this.canBeEmpty&&0===this.inputs().length},ArgLabelMorph.prototype=new ArgMorph,ArgLabelMorph.prototype.constructor=ArgLabelMorph,ArgLabelMorph.uber=ArgMorph.prototype,ArgLabelMorph.prototype.init=function(t,e){var o;this.labelText=localize(e||"input list:"),ArgLabelMorph.uber.init.call(this,null,!0),this.isStatic=!0,this.alpha=0,this.noticesTransparentclick=!0,o=this.labelPart(this.labelText),this.add(o),this.add(t)},ArgLabelMorph.prototype.label=function(){return this.children[0]},ArgLabelMorph.prototype.argMorph=function(){return this.children[1]},ArgLabelMorph.prototype.fixLayout=function(){var t,e,o=this.label();this.parent&&(this.color=this.parent.color,t=(e=o.shadowOffset||new Point).x<0?this.parent.color.darker(this.labelContrast):this.parent.color.lighter(this.labelContrast),""!==this.labelText&&(o.shadowColor.eq(t)||(o.shadowColor=t,o.shadowOffset=e,o.drawNew()))),ArgLabelMorph.uber.fixLayout.call(this),this.parent&&this.parent.fixLayout()},ArgLabelMorph.prototype.refresh=function(){this.inputs().forEach(function(t){t.drawNew()})},ArgLabelMorph.prototype.drawNew=function(){ArgLabelMorph.uber.drawNew.call(this),this.refresh()},ArgLabelMorph.prototype.setLabelColor=function(t,e,o){if(""!==this.labelText){var i=this.label();i.color=t,i.shadowColor=e,i.shadowOffset=o,i.drawNew()}},ArgLabelMorph.prototype.reactToGrabOf=function(){this.parent instanceof SyntaxElementMorph&&this.parent.revertToDefaultInput(this)},ArgLabelMorph.prototype.evaluate=function(){return this.argMorph().evaluate()},ArgLabelMorph.prototype.isEmptySlot=function(){return!1},FunctionSlotMorph.prototype=new ArgMorph,FunctionSlotMorph.prototype.constructor=FunctionSlotMorph,FunctionSlotMorph.uber=ArgMorph.prototype,FunctionSlotMorph.prototype.init=function(t,e){FunctionSlotMorph.uber.init.call(this,null,!0),this.isPredicate=t||!1,this.color=this.rfColor,this.setExtent(new Point(2*(this.fontSize+2*this.edge),this.fontSize+2*this.edge),e)},FunctionSlotMorph.prototype.getSpec=function(){return"%f"},FunctionSlotMorph.prototype.drawNew=function(){var t,e;this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),e=this.parent?this.parent.color:new Color(120,120,120),this.cachedClr=e.toString(),this.cachedClrBright=e.lighter(this.contrast).toString(),this.cachedClrDark=e.darker(this.contrast).toString(),this.isPredicate?this.drawDiamond(t):this.drawRounded(t)},FunctionSlotMorph.prototype.drawRounded=function(t){var e,o=this.height(),i=Math.min(this.rounding,o/2),r=this.width(),n=this.edge/2;t.fillStyle=this.color.toString(),t.beginPath(),t.arc(i,i,i,radians(-180),radians(-90),!1),t.arc(r-i,i,i,radians(-90),radians(-0),!1),t.arc(r-i,o-i,i,radians(0),radians(90),!1),t.arc(i,o-i,i,radians(90),radians(180),!1),t.closePath(),t.fill(),MorphicPreferences.isFlat||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=this.cachedClr,t.beginPath(),t.arc(i,o-i,i-n,radians(90),radians(180),!1),t.stroke(),t.strokeStyle=this.cachedClr,t.beginPath(),t.arc(r-i,i,i-n,radians(-90),radians(0),!1),t.stroke(),t.shadowOffsetX=n,t.shadowOffsetY=n,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString(),(e=t.createLinearGradient(0,0,0,this.edge)).addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(i-n,n),t.lineTo(r-i+n,n),t.stroke(),(e=t.createRadialGradient(i,i,i-this.edge,i,i,i)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.arc(i,i,i-n,radians(180),radians(270),!1),t.stroke(),(e=t.createLinearGradient(0,0,this.edge,0)).addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(n,i),t.lineTo(n,o-i),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,(e=t.createRadialGradient(r-i,o-i,i-this.edge,r-i,o-i,i)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.arc(r-i,o-i,i-n,radians(0),radians(90),!1),t.stroke(),(e=t.createLinearGradient(0,o-this.edge,0,o)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(i-n,o-n),t.lineTo(r-i+n,o-n),t.stroke(),(e=t.createLinearGradient(r-this.edge,0,r,0)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(r-n,i+n),t.lineTo(r-n,o-i),t.stroke())},FunctionSlotMorph.prototype.drawDiamond=function(t){var e,o=this.width(),i=this.height(),r=Math.floor(i/2),n=Math.min(this.rounding,r),s=this.edge/2;t.fillStyle=this.color.toString(),t.beginPath(),t.moveTo(0,r),t.lineTo(n,0),t.lineTo(o-n,0),t.lineTo(o,r),t.lineTo(o-n,i),t.lineTo(n,i),t.closePath(),t.fill(),MorphicPreferences.isFlat||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=this.cachedClr,t.beginPath(),t.moveTo(s,r),t.lineTo(n,i-s),t.stroke(),t.strokeStyle=this.cachedClr,t.beginPath(),t.moveTo(o-s,r),t.lineTo(o-n,s),t.stroke(),t.shadowOffsetX=s,t.shadowOffsetY=s,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString(),(e=t.createLinearGradient(0,0,n,0)).addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(s,r),t.lineTo(n,s),t.stroke(),(e=t.createLinearGradient(0,0,0,this.edge)).addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(n,s),t.lineTo(o-n,s),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,(e=t.createLinearGradient(o-n,0,o,0)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(o-n,i-s),t.lineTo(o-s,r),t.stroke(),(e=t.createLinearGradient(0,i-this.edge,0,i)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(n+s,i-s),t.lineTo(o-n-s,i-s),t.stroke())},ReporterSlotMorph.prototype=new FunctionSlotMorph,ReporterSlotMorph.prototype.constructor=ReporterSlotMorph,ReporterSlotMorph.uber=FunctionSlotMorph.prototype,ReporterSlotMorph.prototype.init=function(t){ReporterSlotMorph.uber.init.call(this,t,!0),this.add(this.emptySlot()),this.fixLayout()},ReporterSlotMorph.prototype.emptySlot=function(){var t=new ArgMorph,e=2*this.rfBorder+2*this.edge;return t.color=this.rfColor,t.alpha=0,t.setExtent(new Point(2*(this.fontSize+2*this.edge)-e,this.fontSize+2*this.edge-e)),t},ReporterSlotMorph.prototype.getSpec=function(){return"%r"},ReporterSlotMorph.prototype.contents=function(){return this.children[0]},ReporterSlotMorph.prototype.nestedBlock=function(){var t=this.contents();return t instanceof ReporterBlockMorph?t:null},ReporterSlotMorph.prototype.evaluate=function(){return this.nestedBlock()},ReporterSlotMorph.prototype.isEmptySlot=function(){return null===this.nestedBlock()},ReporterSlotMorph.prototype.fixLayout=function(){var t=this.contents();this.setExtent(t.extent().add(2*this.edge+2*this.rfBorder)),t.setCenter(this.center()),this.parent&&this.parent.fixLayout&&this.parent.fixLayout()},RingReporterSlotMorph.prototype=new ReporterSlotMorph,RingReporterSlotMorph.prototype.constructor=RingReporterSlotMorph,RingReporterSlotMorph.uber=ReporterSlotMorph.prototype,RingReporterSlotMorph.prototype.rfBorder=RingCommandSlotMorph.prototype.rfBorder,RingReporterSlotMorph.prototype.edge=RingCommandSlotMorph.prototype.edge,RingReporterSlotMorph.prototype.init=function(t){RingReporterSlotMorph.uber.init.call(this,t,!0),this.alpha=RingMorph.prototype.alpha,this.contrast=RingMorph.prototype.contrast,this.isHole=!0},RingReporterSlotMorph.prototype.getSpec=function(){return"%rr"},RingReporterSlotMorph.prototype.replaceInput=function(t,e){RingReporterSlotMorph.uber.replaceInput.call(this,t,e),this.parent instanceof RingMorph&&this.parent.vanishForSimilar()},RingReporterSlotMorph.prototype.drawRounded=function(t){var e,o=this.height(),i=Math.min(this.rounding,o/2),r=this.width(),n=this.edge/2;t.fillStyle=this.cachedClr,t.beginPath(),t.moveTo(0,o/2),t.arc(i,i,i,radians(-180),radians(-90),!1),t.arc(r-i,i,i,radians(-90),radians(-0),!1),t.lineTo(r,o/2),t.lineTo(r,0),t.lineTo(0,0),t.closePath(),t.fill(),t.beginPath(),t.moveTo(r,o/2),t.arc(r-i,o-i,i,radians(0),radians(90),!1),t.arc(i,o-i,i,radians(90),radians(180),!1),t.lineTo(0,o/2),t.lineTo(0,o),t.lineTo(r,o),t.closePath(),t.fill(),MorphicPreferences.isFlat||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=this.cachedClr,t.beginPath(),t.arc(i,o-i,i-n,radians(90),radians(180),!1),t.stroke(),t.strokeStyle=this.cachedClr,t.beginPath(),t.arc(r-i,i,i-n,radians(-90),radians(0),!1),t.stroke(),t.shadowOffsetX=n,t.shadowOffsetY=n,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString(),(e=t.createLinearGradient(0,0,0,this.edge)).addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(i-n,n),t.lineTo(r-i+n,n),t.stroke(),(e=t.createRadialGradient(i,i,i-this.edge,i,i,i)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.arc(i,i,i-n,radians(180),radians(270),!1),t.stroke(),(e=t.createLinearGradient(0,0,this.edge,0)).addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(n,i),t.lineTo(n,o-i),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,(e=t.createRadialGradient(r-i,o-i,i-this.edge,r-i,o-i,i)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.arc(r-i,o-i,i-n,radians(0),radians(90),!1),t.stroke(),(e=t.createLinearGradient(0,o-this.edge,0,o)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(i-n,o-n),t.lineTo(r-i+n,o-n),t.stroke(),(e=t.createLinearGradient(r-this.edge,0,r,0)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(r-n,i+n),t.lineTo(r-n,o-i),t.stroke())},RingReporterSlotMorph.prototype.drawDiamond=function(t){var e,o=this.width(),i=this.height(),r=Math.floor(i/2),n=Math.min(this.rounding,r),s=this.edge/2;t.fillStyle=this.cachedClr,t.beginPath(),t.moveTo(0,0),t.lineTo(0,r),t.lineTo(n,0),t.lineTo(o-n,0),t.lineTo(o,r),t.lineTo(o,0),t.closePath(),t.fill(),t.moveTo(o,r),t.lineTo(o-n,i),t.lineTo(n,i),t.lineTo(0,r),t.lineTo(0,i),t.lineTo(o,i),t.closePath(),t.fill(),MorphicPreferences.isFlat||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=this.cachedClr,t.beginPath(),t.moveTo(s,r),t.lineTo(n,i-s),t.stroke(),t.strokeStyle=this.cachedClr,t.beginPath(),t.moveTo(o-s,r),t.lineTo(o-n,s),t.stroke(),t.shadowOffsetX=s,t.shadowOffsetY=s,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString(),(e=t.createLinearGradient(0,0,n,0)).addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(s,r),t.lineTo(n,s),t.stroke(),(e=t.createLinearGradient(0,0,0,this.edge)).addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(n,s),t.lineTo(o-n,s),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,(e=t.createLinearGradient(o-n,0,o,0)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(o-n,i-s),t.lineTo(o-s,r),t.stroke(),(e=t.createLinearGradient(0,i-this.edge,0,i)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(n+s,i-s),t.lineTo(o-n-s,i-s),t.stroke())},CommentMorph.prototype=new BoxMorph,CommentMorph.prototype.constructor=CommentMorph,CommentMorph.uber=BoxMorph.prototype,CommentMorph.prototype.refreshScale=function(){CommentMorph.prototype.fontSize=SyntaxElementMorph.prototype.fontSize,CommentMorph.prototype.padding=5*SyntaxElementMorph.prototype.scale,CommentMorph.prototype.rounding=8*SyntaxElementMorph.prototype.scale},CommentMorph.prototype.refreshScale(),CommentMorph.prototype.init=function(t){var e=this,o=SyntaxElementMorph.prototype.scale;this.block=null,this.stickyOffset=null,this.isCollapsed=!1,this.titleBar=new BoxMorph(this.rounding,1.000001*o,new Color(255,255,180)),this.titleBar.color=new Color(255,255,180),this.titleBar.setHeight(fontHeight(this.fontSize)+this.padding),this.title=null,this.arrow=new ArrowMorph("down",this.fontSize),this.arrow.noticesTransparentClick=!0,this.arrow.mouseClickLeft=function(){e.toggleExpand()},this.contents=new TextMorph(t||localize("add comment here..."),this.fontSize),this.contents.isEditable=!0,this.contents.enableSelecting(),this.contents.maxWidth=90*o,this.contents.drawNew(),this.handle=new HandleMorph(this.contents,80,2*this.fontSize,-2,-2),this.handle.setExtent(new Point(11*o,11*o)),this.anchor=null,CommentMorph.uber.init.call(this,this.rounding,1.000001*o,new Color(255,255,180)),this.color=new Color(255,255,220),this.isDraggable=!0,this.add(this.titleBar),this.add(this.arrow),this.add(this.contents),this.add(this.handle),this.fixLayout()},CommentMorph.prototype.fullCopy=function(){var t=new CommentMorph(this.contents.text);return t.isCollapsed=this.isCollapsed,t.setTextWidth(this.textWidth()),this.selectionID&&(t.selectionID=!0),t},CommentMorph.prototype.setTextWidth=function(t){this.contents.maxWidth=t,this.contents.drawNew(),this.fixLayout()},CommentMorph.prototype.textWidth=function(){return this.contents.maxWidth},CommentMorph.prototype.text=function(){return this.contents.text},CommentMorph.prototype.toggleExpand=function(){this.isCollapsed=!this.isCollapsed,this.fixLayout(),this.align()},CommentMorph.prototype.layoutChanged=function(){this.fixLayout(),this.align()},CommentMorph.prototype.fixLayout=function(){var t,e=this.contents.width()+2*this.padding,o=this,i=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,this.title&&(this.title.destroy(),this.title=null),this.isCollapsed?(this.contents.hide(),this.title=new FrameMorph,this.title.alpha=0,this.title.acceptsDrops=!1,(t=new StringMorph(this.contents.text,this.fontSize,null,!0)).rootForGrab=function(){return o},this.title.add(t),this.title.setHeight(t.height()),this.title.setWidth(e-this.arrow.width()-2*this.padding-this.rounding),this.add(this.title)):this.contents.show(),this.titleBar.setWidth(e),this.contents.setLeft(this.titleBar.left()+this.padding),this.contents.setTop(this.titleBar.bottom()+this.padding),this.arrow.direction=this.isCollapsed?"right":"down",this.arrow.drawNew(),this.arrow.setCenter(this.titleBar.center()),this.arrow.setLeft(this.titleBar.left()+this.padding),this.title&&this.title.setPosition(this.arrow.topRight().add(new Point(this.padding,0))),Morph.prototype.trackChanges=i,this.changed(),this.silentSetHeight(this.titleBar.height()+(this.isCollapsed?0:this.padding+this.contents.height()+this.padding)),this.silentSetWidth(this.titleBar.width()),this.drawNew(),this.handle.drawNew(),this.changed()},CommentMorph.prototype.userMenu=function(){var t=new MenuMorph(this),e=this;return t.addItem("duplicate",function(){e.fullCopy().pickUp(e.world())},"make a copy\nand pick it up"),t.addItem("delete","userDestroy"),t.addItem("comment pic...",function(){var t=e.parentThatIsA(IDE_Morph);t.saveCanvasAs(e.fullImageClassic(),(t.projectName||localize("untitled"))+" "+localize("comment pic"))},"open a new window\nwith a picture of this comment"),t},CommentMorph.prototype.userDestroy=function(){this.selectForEdit().destroy()},CommentMorph.prototype.hide=function(){this.isVisible=!1,this.changed()},CommentMorph.prototype.show=function(){this.isVisible=!0,this.changed()},CommentMorph.prototype.prepareToBeGrabbed=function(t){this.block&&(this.block.comment=null,this.block=null),this.anchor&&(this.anchor.destroy(),this.anchor=null,this.removeShadow(),this.addShadow())},CommentMorph.prototype.selectForEdit=SyntaxElementMorph.prototype.selectForEdit,CommentMorph.prototype.snap=function(t){var e,o=this.parent;if(!(o instanceof ScriptsMorph))return null;o.clearDropInfo(),null!==(e=o.closestBlock(this,t))&&(e.comment=this,this.block=e,this.snapSound&&this.snapSound.play(),o.lastDropTarget={element:e}),this.align(),o.lastDroppedBlock=this,t&&o.recordDrop(t.grabOrigin)},CommentMorph.prototype.align=function(t,e){if(this.block){var o,i,r,n,s=t||this.block.topBlock(),a=s.parentThatIsA(ScriptsMorph);this.setTop(this.block.top()+this.block.corner),i=this.top(),r=this.bottom(),o=s.allChildren().filter(function(t){return t instanceof BlockMorph&&t.bottom()>i&&t.top()<r}),n=Math.max.apply(null,o.map(function(t){return t.right()})),this.setLeft(n+5),!e&&a&&a.addBack(this),this.anchor||(this.anchor=new Morph,this.anchor.color=this.titleBar.color),this.anchor.silentSetPosition(new Point(this.block.right(),this.top()+this.edge)),this.anchor.bounds.corner=new Point(this.left(),this.top()+this.edge+1),this.anchor.drawNew(),this.addBack(this.anchor),this.anchor.changed()}},CommentMorph.prototype.startFollowing=function(t,e){this.align(t),e.add(this),this.addShadow(),this.stickyOffset=this.position().subtract(this.block.position()),this.step=function(){this.block?this.setPosition(this.block.position().add(this.stickyOffset)):this.stopFollowing()}},CommentMorph.prototype.stopFollowing=function(){this.removeShadow(),delete this.step},CommentMorph.prototype.destroy=function(){this.block&&(this.block.comment=null),CommentMorph.uber.destroy.call(this)},CommentMorph.prototype.stackHeight=function(){return this.height()},ScriptFocusMorph.prototype=new BoxMorph,ScriptFocusMorph.prototype.constructor=ScriptFocusMorph,ScriptFocusMorph.uber=BoxMorph.prototype,ScriptFocusMorph.prototype.init=function(t,e,o){this.editor=t,this.element=e,this.atEnd=!1,ScriptFocusMorph.uber.init.call(this),this.element instanceof ScriptsMorph&&this.setPosition(o)},ScriptFocusMorph.prototype.getFocus=function(t){t||(t=this.world()),t&&t.keyboardReceiver!==this&&t.stopEditing(),t.keyboardReceiver=this,this.fixLayout(),this.editor.updateToolbar()},ScriptFocusMorph.prototype.fixLayout=function(){this.changed(),this.element instanceof CommandBlockMorph||this.element instanceof CommandSlotMorph||this.element instanceof ScriptsMorph?this.manifestStatement():this.manifestExpression(),this.editor.add(this),this.scrollIntoView(),this.changed()},ScriptFocusMorph.prototype.manifestStatement=function(){var t=this.element instanceof ScriptsMorph,e=this.element.top();this.border=0,this.edge=0,this.alpha=1,this.color=this.editor.feedbackColor,this.setExtent(new Point(t?SyntaxElementMorph.prototype.hatWidth:this.element.width(),Math.max(SyntaxElementMorph.prototype.corner,SyntaxElementMorph.prototype.feedbackMinHeight))),this.element instanceof CommandSlotMorph?e+=SyntaxElementMorph.prototype.corner:this.atEnd&&(e=this.element.bottom()),t||this.setPosition(new Point(this.element.left(),e)),this.fps=2,this.show(),this.step=function(){this.toggleVisibility()}},ScriptFocusMorph.prototype.manifestExpression=function(){this.edge=SyntaxElementMorph.prototype.rounding,this.border=Math.max(SyntaxElementMorph.prototype.edge,3),this.color=this.editor.feedbackColor.copy(),this.color.a=.5,this.borderColor=this.editor.feedbackColor,this.bounds=this.element.fullBounds().expandBy(Math.max(2*SyntaxElementMorph.prototype.edge,SyntaxElementMorph.prototype.reporterDropFeedbackPadding)),this.drawNew(),delete this.fps,delete this.step,this.show()},ScriptFocusMorph.prototype.trigger=function(){var t=this.element;t instanceof MultiArgMorph?t.arrows().children[1].isVisible&&(t.addInput(),this.fixLayout()):t.parent instanceof TemplateSlotMorph?t.mouseClickLeft():t instanceof BooleanSlotMorph?t.toggleValue():t instanceof InputSlotMorph&&(t.isReadOnly?t.choices&&(t.dropDownMenu(!0),delete this.fps,delete this.step,this.hide()):(delete this.fps,delete this.step,this.hide(),this.world().onNextStep=function(){t.contents().edit(),t.contents().selectAll()}))},ScriptFocusMorph.prototype.menu=function(){var t=this.element;t instanceof InputSlotMorph&&t.choices?(t.dropDownMenu(!0),delete this.fps,delete this.step,this.hide()):this.insertVariableGetter()},ScriptFocusMorph.prototype.deleteLastElement=function(){var t=this.element;t.parent instanceof ScriptsMorph?(this.atEnd||t instanceof ReporterBlockMorph)&&(t.destroy(),this.element=this.editor,this.atEnd=!1):t instanceof MultiArgMorph?t.arrows().children[0].isVisible&&t.removeInput():t instanceof BooleanSlotMorph?t.isStatic||t.setContents(null):t instanceof ReporterBlockMorph?t.isTemplate||(this.lastElement(),t.prepareToBeGrabbed(),t.destroy()):t instanceof CommandBlockMorph&&(this.atEnd?(this.element=t.parent,t.userDestroy()):t.parent instanceof CommandBlockMorph&&t.parent.userDestroy()),this.editor.adjustBounds(),this.fixLayout()},ScriptFocusMorph.prototype.insertBlock=function(t){var e,o,i,r;t.isTemplate=!1,t.isDraggable=!0,t.snapSound&&t.snapSound.play(),this.element instanceof ScriptsMorph?(this.editor.add(t),this.element=t,t instanceof CommandBlockMorph?(t.setLeft(this.left()),t.isStop()?t.setTop(this.top()):(t.setBottom(this.top()),this.atEnd=!0)):(t.setCenter(this.center()),t.setLeft(this.left()))):this.element instanceof CommandBlockMorph?this.atEnd?(this.element.nextBlock(t),this.element=t,this.fixLayout()):(e=this.element.parent)instanceof ScriptsMorph?(t.setLeft(this.element.left()),t.setBottom(this.element.top()+this.element.corner),this.editor.add(t),t.nextBlock(this.element),this.fixLayout()):e instanceof CommandSlotMorph?e.nestedBlock(t):e instanceof CommandBlockMorph&&e.nextBlock(t):this.element instanceof CommandSlotMorph?(this.element.nestedBlock(t),this.element=t,this.atEnd=!0):((e=this.element.parent)instanceof ScriptsMorph?(this.editor.add(t),t.setPosition(this.element.position()),this.element.destroy()):e.replaceInput(this.element,t),this.element=t),t.fixBlockColor(),this.editor.adjustBounds(),this.fixLayout(),"receiveCondition"===t.selector&&(r=this.editor.scriptTarget())&&(o=r.parentThatIsA(StageMorph))&&(o.enableCustomHatBlocks=!0,o.threads.pauseCustomHatBlocks=!1,(i=o.parentThatIsA(IDE_Morph))&&i.controlBar.stopButton.refresh()),t.inputs&&t.inputs().length&&(this.element=t,this.atEnd=!1,this.nextElement())},ScriptFocusMorph.prototype.insertVariableGetter=function(){var t,e=this.blockTypes(),o=this,i=new MenuMorph;e&&contains(e,"reporter")&&(t=InputSlotMorph.prototype.getVarNamesDict.call(this.element),Object.keys(t).forEach(function(t){var e=SpriteMorph.prototype.variableBlock(t);e.addShadow(new Point(3,3)),i.addItem(e,function(){e.removeShadow(),o.insertBlock(e)})}),i.items.length>0&&(i.popup(this.world(),this.element.bottomLeft()),i.getFocus()))},ScriptFocusMorph.prototype.stopEditing=function(){this.editor.focus=null,this.editor.updateToolbar(),this.world().keyboardReceiver=null,this.destroy()},ScriptFocusMorph.prototype.lastElement=function(){var t,e=this.items();e.length?(this.atEnd?(this.element=e[e.length-1],this.atEnd=!1):((t=e.indexOf(this.element)-1)<0&&(t=e.length-1),this.element=e[t]),this.element instanceof CommandSlotMorph&&this.element.nestedBlock()?this.lastElement():this.element instanceof HatBlockMorph&&(e.length>1?this.lastElement():this.atEnd=!0),this.fixLayout()):this.shiftScript(new Point(-50,0))},ScriptFocusMorph.prototype.nextElement=function(){var t,e,o=this.items();o.length?((t=o.indexOf(this.element)+1)>=o.length&&(t=0),this.atEnd=!1,this.element=o[t],this.element instanceof CommandSlotMorph?(e=this.element.nestedBlock())&&(this.element=e):this.element instanceof HatBlockMorph&&(1===o.length?this.atEnd=!0:this.nextElement()),this.fixLayout()):this.shiftScript(new Point(50,0))},ScriptFocusMorph.prototype.lastCommand=function(){var t,e=this.element.parentThatIsA(CommandBlockMorph);e?(this.element instanceof CommandBlockMorph?this.atEnd?this.atEnd=!1:(t=e.parent.parentThatIsA(CommandBlockMorph))?this.element=t:(t=e.topBlock().bottomBlock())&&(this.element=t,this.atEnd=!0):(this.element=e,this.atEnd=!1),this.element instanceof HatBlockMorph&&!this.atEnd&&this.lastCommand(),this.fixLayout()):this.element instanceof ScriptsMorph&&this.shiftScript(new Point(0,-50))},ScriptFocusMorph.prototype.nextCommand=function(){var t,e,o,i=this.element;if(i instanceof ScriptsMorph)this.shiftScript(new Point(0,50));else{for(;!(i instanceof CommandBlockMorph);)if((i=i.parent)instanceof ScriptsMorph)return;this.atEnd?(o=i.parentThatIsA(CommandSlotMorph))?(this.element=o.parentThatIsA(CommandBlockMorph),this.atEnd=!1,this.nextCommand()):(t=i.topBlock().parentThatIsA(CommandBlockMorph))&&(this.element=t,this.atEnd=!1,this.element instanceof HatBlockMorph&&this.nextCommand()):(e=i.nextBlock())?this.element=e:(this.element=i,this.atEnd=!0),this.fixLayout()}},ScriptFocusMorph.prototype.nextScript=function(){var t,e=this.sortedScripts();if(!(e.length<1)){if(this.element instanceof ScriptsMorph&&(this.element=e[0]),(t=e.indexOf(this.element.topBlock())+1)>=e.length&&(t=0),this.element=e[t],this.element.scrollIntoView(),this.atEnd=!1,this.element instanceof HatBlockMorph)return this.nextElement();this.fixLayout()}},ScriptFocusMorph.prototype.lastScript=function(){var t,e=this.sortedScripts();if(!(e.length<1)){if(this.element instanceof ScriptsMorph&&(this.element=e[0]),(t=e.indexOf(this.element.topBlock())-1)<0&&(t=e.length-1),this.element=e[t],this.element.scrollIntoView(),this.atEnd=!1,this.element instanceof HatBlockMorph)return this.nextElement();this.fixLayout()}},ScriptFocusMorph.prototype.shiftScript=function(t){var e;this.element instanceof ScriptsMorph?this.moveBy(t):!(e=this.element.topBlock())||e instanceof PrototypeHatBlockMorph||e.moveBy(t),this.editor.adjustBounds(),this.fixLayout()},ScriptFocusMorph.prototype.newScript=function(){var t=this.position();this.element instanceof ScriptsMorph||(t=this.element.topBlock().fullBounds().bottomLeft().add(new Point(0,50))),this.setPosition(t),this.element=this.editor,this.editor.adjustBounds(),this.fixLayout()},ScriptFocusMorph.prototype.runScript=function(){this.element instanceof ScriptsMorph||this.element.topBlock().mouseClickLeft()},ScriptFocusMorph.prototype.items=function(){return this.element instanceof ScriptsMorph?[]:this.element.topBlock().allChildren().filter(function(t){return t instanceof SyntaxElementMorph&&!(t instanceof TemplateSlotMorph)&&(!t.isStatic||t.choices||t instanceof BooleanSlotMorph||t instanceof RingMorph||t instanceof MultiArgMorph||t instanceof CommandSlotMorph)})},ScriptFocusMorph.prototype.sortedScripts=function(){var t=this.editor.children.filter(function(t){return t instanceof BlockMorph});return t.sort(function(t,e){return t instanceof PrototypeHatBlockMorph?0:t.top()-e.top()}),t},ScriptFocusMorph.prototype.undrop=function(){this.editor.undrop()},ScriptFocusMorph.prototype.redrop=function(){this.editor.redrop()},ScriptFocusMorph.prototype.blockTypes=function(){return this.element.isTemplate?null:this.element instanceof ScriptsMorph?["hat","command","reporter","predicate","ring"]:this.element instanceof HatBlockMorph||this.element instanceof CommandSlotMorph?["command"]:this.element instanceof CommandBlockMorph?this.atEnd&&this.element.isStop()?null:this.element.parent instanceof ScriptsMorph?["hat","command"]:["command"]:this.element instanceof ReporterBlockMorph?"%n"===this.element.getSlotSpec()?["reporter"]:["reporter","predicate","ring"]:"%n"===this.element.getSpec()?["reporter"]:this.element.isStatic?null:["reporter","predicate","ring"]},ScriptFocusMorph.prototype.processKeyDown=function(t){this.processKeyEvent(t,this.reactToKeyEvent)},ScriptFocusMorph.prototype.processKeyUp=function(t){nop(t)},ScriptFocusMorph.prototype.processKeyPress=function(t){nop(t)},ScriptFocusMorph.prototype.processKeyEvent=function(t,e){var o;switch(this.world().hand.destroyTemporaries(),t.keyCode){case 8:o="backspace";break;case 9:o="tab";break;case 13:o="enter";break;case 16:case 17:case 18:return;case 27:o="esc";break;case 32:o="space";break;case 37:o="left arrow";break;case 39:o="right arrow";break;case 38:o="up arrow";break;case 40:o="down arrow";break;default:o=String.fromCharCode(t.keyCode||t.charCode)}o=(t.ctrlKey||t.metaKey?"ctrl ":"")+(t.shiftKey?"shift ":"")+o,e.call(this,o)},ScriptFocusMorph.prototype.reactToKeyEvent=function(t){var e,o;switch(t.toLowerCase()){case"esc":return this.stopEditing();case"enter":return this.trigger();case"shift enter":return this.newScript();case"ctrl shift enter":return this.runScript();case"space":return this.menu();case"left arrow":return this.lastElement();case"shift left arrow":return this.shiftScript(new Point(-50,0));case"right arrow":return this.nextElement();case"shift right arrow":return this.shiftScript(new Point(50,0));case"up arrow":return this.lastCommand();case"shift up arrow":return this.shiftScript(new Point(0,-50));case"down arrow":return this.nextCommand();case"shift down arrow":return this.shiftScript(new Point(0,50));case"tab":return this.nextScript();case"shift tab":return this.lastScript();case"backspace":return this.deleteLastElement();case"ctrl z":return this.undrop();case"ctrl y":case"ctrl shift z":return this.redrop();case"ctrl [":return;default:e=this.blockTypes(),this.element instanceof ScriptsMorph||!e||!contains(e,"reporter")||(o=Object.keys(this.element.getVarNamesDict())),e&&(delete this.fps,delete this.step,this.show(),this.editor.scriptTarget().searchBlocks(t,e,o,this))}},modules.threads="2017-December-01";var ThreadManager,Process,Context,VariableFrame;ThreadManager.prototype.pauseCustomHatBlocks=!1;var compteurGo=0;ThreadManager.prototype.toggleProcess=function(t,e){var o=this.findProcess(t,e);if(!o)return this.startProcess(t,e,null,null,null,!0);o.stop()},ThreadManager.prototype.startProcess=function(t,e,o,i,r,n,s){compteur();var a,h,l=t.topBlock(),p=this.findProcess(l,e);if(p){if(o)return p;p.stop(),this.removeTerminatedProcesses()}return h=new Process(l,e,r,n),h.exportResult=i,h.isClicked=n||!1,a=l.getHighlight(),a?(a.threadCount=this.processesForBlock(l).length+1,a.updateReadout()):l.addHighlight(),this.processes.push(h),s&&h.runStep(),h},ThreadManager.prototype.stopAll=function(t){this.processes.forEach(function(e){e!==t&&e.stop()})},ThreadManager.prototype.stopAllForReceiver=function(t,e){this.processes.forEach(function(o){o.homeContext.receiver===t&&o!==e&&(o.stop(),t.isTemporary&&(o.isDead=!0))})},ThreadManager.prototype.stopAllForBlock=function(t){this.processesForBlock(t,!0).forEach(function(t){t.stop()})},ThreadManager.prototype.stopProcess=function(t,e){var o=this.findProcess(t,e);o&&o.stop()},ThreadManager.prototype.pauseAll=function(t){this.processes.forEach(function(t){t.pause()}),t&&t.pauseAllActiveSounds()},ThreadManager.prototype.isPaused=function(){return null!==detect(this.processes,function(t){return t.isPaused})},ThreadManager.prototype.resumeAll=function(t){this.processes.forEach(function(t){t.resume()}),t&&t.resumeAllActiveSounds()},ThreadManager.prototype.step=function(){var t;Process.prototype.enableSingleStepping&&(this.processes.forEach(function(e){e.isInterrupted?(e.runStep(),t=!0):e.lastYield=Date.now()}),this.wantsToPause=Process.prototype.flashTime>.5,t)?this.wantsToPause&&this.pauseAll():(this.processes.forEach(function(t){t.homeContext.receiver.isPickedUp()||t.isDead||t.runStep()}),this.removeTerminatedProcesses())},ThreadManager.prototype.removeTerminatedProcesses=function(){var t,e=[],o=this;this.processes.forEach(function(i){var r,n;!i.isRunning()&&!i.errorFlag||i.isDead?(i.topBlock instanceof BlockMorph&&(i.unflash(),(t=o.processesForBlock(i.topBlock).length)?((n=i.topBlock.getHighlight()||i.topBlock.addHighlight()).threadCount=t,n.updateReadout()):i.topBlock.removeHighlight()),i.prompter&&(i.prompter.destroy(),i.homeContext.receiver.stopTalking&&i.homeContext.receiver.stopTalking()),(i.topBlock instanceof ReporterBlockMorph||i.isShowingResult)&&(r=i.homeContext.inputs[0],i.onComplete instanceof Function?i.onComplete(r):r instanceof List?i.topBlock.showBubble(r.isTable()?new TableFrameMorph(new TableMorph(r,10)):new ListWatcherMorph(r),i.exportResult,i.receiver):i.topBlock.showBubble(r,i.exportResult,i.receiver))):e.push(i)}),this.processes=e},ThreadManager.prototype.findProcess=function(t,e){var o=t.topBlock();return detect(this.processes,function(t){return t.topBlock===o&&t.receiver===e})},ThreadManager.prototype.processesForBlock=function(t,e){var o=e?t:t.topBlock();return this.processes.filter(function(t){return t.topBlock===o&&t.isRunning()&&!t.isDead})},ThreadManager.prototype.doWhen=function(t,e,o){if(!this.pauseCustomHatBlocks&&t&&!this.findProcess(t,e)){var i,r=t.inputs()[0];if(t.removeHighlight()&&(i=t.world())&&i.hand.destroyTemporaries(),!o)try{!0===invoke(r,null,e,50,"the predicate takes\ntoo long for a\ncustom hat block",!0)&&this.startProcess(t,e,null,null,null,null,!0)}catch(e){t.addErrorHighlight(),t.showBubble(e.name+"\n"+e.message)}}},ThreadManager.prototype.toggleSingleStepping=function(){Process.prototype.enableSingleStepping=!Process.prototype.enableSingleStepping,Process.prototype.enableSingleStepping||this.processes.forEach(function(t){t.isPaused||t.unflash()})},Process.prototype={},Process.prototype.constructor=Process,Process.prototype.timeout=500,Process.prototype.isCatchingErrors=!0,Process.prototype.enableLiveCoding=!1,Process.prototype.enableSingleStepping=!1,Process.prototype.flashTime=0,Process.prototype.isRunning=function(){return null!==this.context&&!this.readyToTerminate},Process.prototype.runStep=function(t){if(this.isPaused)return this.pauseStep();for(this.readyToYield=!1,this.isInterrupted=!1;!this.readyToYield&&!this.isInterrupted&&this.context&&Date.now()-this.lastYield<this.timeout;){if(this.isPaused)return this.pauseStep();if(t&&Date.now()>t)return void(this.isAtomic&&this.homeContext.receiver&&this.homeContext.receiver.endWarp&&this.homeContext.receiver.endWarp());this.evaluateContext()}if(this.lastYield=Date.now(),this.isFirstStep=!1,this.isAtomic&&this.homeContext.receiver&&this.homeContext.receiver.endWarp&&(this.homeContext.receiver.endWarp(),this.homeContext.receiver.startWarp()),this.readyToTerminate){for(;this.context;)this.popContext();this.homeContext.receiver&&this.homeContext.receiver.endWarp&&this.homeContext.receiver.endWarp()}},Process.prototype.stop=function(){this.readyToYield=!0,this.readyToTerminate=!0,this.errorFlag=!1,this.context&&this.context.stopMusic()},Process.prototype.pause=function(){this.readyToTerminate||(this.isPaused=!0,this.flashPausedContext(),this.context&&this.context.startTime&&(this.pauseOffset=Date.now()-this.context.startTime))},Process.prototype.resume=function(){this.enableSingleStepping||this.unflash(),this.isPaused=!1,this.pauseOffset=null},Process.prototype.pauseStep=function(){this.lastYield=Date.now(),this.context&&this.context.startTime&&(this.context.startTime=this.lastYield-this.pauseOffset)},Process.prototype.evaluateContext=function(){var t=this.context.expression;return this.frameCount+=1,"exit"===this.context.tag&&this.expectReport(),t instanceof Array?this.evaluateSequence(t):t instanceof MultiArgMorph?this.evaluateMultiSlot(t,t.inputs().length):t instanceof ArgLabelMorph?this.evaluateArgLabel(t):t instanceof ArgMorph||t.bindingID?this.evaluateInput(t):t instanceof BlockMorph?this.evaluateBlock(t,t.inputs().length):isString(t)?this[t].apply(this,this.context.inputs):void this.popContext()},Process.prototype.evaluateBlock=function(t,e){var o=t.selector;if("reportOr"===o||"reportAnd"===o||"doReport"===o)return this[o](t);var i=this.context.receiver||this.receiver,r=this.context.inputs;if(e>r.length)this.evaluateNextInput(t);else{if(this.flashContext())return;if(this[o]&&(i=this),this.isCatchingErrors)try{this.returnValueToParentContext(i[o].apply(i,r)),this.popContext()}catch(e){this.handleError(e,t)}else this.returnValueToParentContext(i[o].apply(i,r)),this.popContext()}},Process.prototype.reportOr=function(t){var e=this.context.inputs;if(e.length<1)this.evaluateNextInput(t);else if(e[0]){if(this.flashContext())return;this.returnValueToParentContext(!0),this.popContext()}else if(e.length<2)this.evaluateNextInput(t);else{if(this.flashContext())return;this.returnValueToParentContext(!0===e[1]),this.popContext()}},Process.prototype.reportAnd=function(t){var e=this.context.inputs;if(e.length<1)this.evaluateNextInput(t);else if(e[0])if(e.length<2)this.evaluateNextInput(t);else{if(this.flashContext())return;this.returnValueToParentContext(!0===e[1]),this.popContext()}else{if(this.flashContext())return;this.returnValueToParentContext(!1),this.popContext()}},Process.prototype.doReport=function(t){var e=this.context.outerContext;if(!this.flashContext()){if(this.isClicked&&t.topBlock()===this.topBlock&&(this.isShowingResult=!0),this.context.expression.partOfCustomCommand)this.doStopCustomBlock(),this.popContext();else{for(;this.context&&"exit"!==this.context.tag;)"doStopWarping"===this.context.expression?this.doStopWarping():this.popContext();this.context&&("expectReport"===this.context.expression?this.popContext():this.context.tag=null)}this.pushContext(t.inputs()[0],e)}},Process.prototype.evaluateMultiSlot=function(t,e){var o,i=this.context.inputs;if(t.bindingID){if(this.isCatchingErrors)try{o=this.context.variables.getVar(t.bindingID)}catch(e){this.handleError(e,t)}else o=this.context.variables.getVar(t.bindingID);this.returnValueToParentContext(o),this.popContext()}else e>i.length?this.evaluateNextInput(t):(this.returnValueToParentContext(new List(i)),this.popContext())},Process.prototype.evaluateArgLabel=function(t){var e=this.context.inputs;e.length<1?this.evaluateNextInput(t):(this.returnValueToParentContext(e[0]),this.popContext())},Process.prototype.evaluateInput=function(t){var e;if(!this.flashContext()){if(t.bindingID)if(this.isCatchingErrors)try{e=this.context.variables.getVar(t.bindingID)}catch(e){this.handleError(e,t)}else e=this.context.variables.getVar(t.bindingID);else(e=t.evaluate())&&(t.constructor===CommandSlotMorph||t.constructor===ReporterSlotMorph||t instanceof CSlotMorph&&(!t.isStatic||t.isLambda))&&(e=this.reify(e,new List));this.returnValueToParentContext(e),this.popContext()}},Process.prototype.evaluateSequence=function(t){var e=this.context.pc,o=this.context.outerContext,i=this.context.isCustomBlock;e===t.length-1?(this.context=new Context(this.context.parentContext,t[e],this.context.outerContext,this.context.receiver),this.context.isCustomBlock=i):e>=t.length?this.popContext():(this.context.pc+=1,this.pushContext(t[e],o))},Process.prototype.evaluateNextInput=function(t){var e=this.context.inputs.length,o=t.inputs()[e],i=this.context.expression.selector,r=this.context.outerContext;o.isUnevaluated&&(!0===o.isUnevaluated||o.isUnevaluated())?"reify"===i||"reportScript"===i?this.context.addInput(o):this.context.addInput(this.reify(o,new List)):this.pushContext(o,r)},Process.prototype.doYield=function(){this.popContext(),this.isAtomic||(this.readyToYield=!0)},Process.prototype.expectReport=function(){this.handleError(new Error("reporter didn't report"))},Process.prototype.handleError=function(t,e){var o=e;this.stop(),this.errorFlag=!0,this.topBlock.addErrorHighlight(),(isNil(o)||isNil(o.world()))&&(o=this.topBlock),o.showBubble((o===e?"":"Inside: ")+t.name+"\n"+t.message,this.exportResult,this.receiver)},Process.prototype.errorObsolete=function(){throw new Error("a custom block definition is missing")},Process.prototype.reify=function(t,e,o){var i=new Context(null,null,this.context?this.context.outerContext:null),r=0;return t?(i.expression=this.enableLiveCoding||this.enableSingleStepping?t:t.fullCopy(),i.expression.show(),o||e.length()||(i.expression.allEmptySlots().forEach(function(t){r+=1,t.bindingID=t instanceof MultiArgMorph?["arguments"]:r}),i.emptySlots=r)):i.expression=this.enableLiveCoding||this.enableSingleStepping?[this.context.expression]:[this.context.expression.fullCopy()],i.inputs=e.asArray(),i.receiver=this.context?this.context.receiver:this.receiver,i.origin=i.receiver,i},Process.prototype.reportScript=function(t,e){return this.reify(e,t)},Process.prototype.reifyScript=function(t,e){return this.reify(t,e)},Process.prototype.reifyReporter=function(t,e){return this.reify(t,e)},Process.prototype.reifyPredicate=function(t,e){return this.reify(t,e)},Process.prototype.reportJSFunction=function(t,e){return Function.apply(null,t.asArray().concat([e]))},Process.prototype.doRun=function(t,e){return this.evaluate(t,e,!0)},Process.prototype.evaluate=function(t,e,o){if(!t)return null;if(t instanceof Function)return t.apply(this.blockReceiver(),e.asArray().concat([this]));if(t.isContinuation)return this.runContinuation(t,e);if(!(t instanceof Context))throw new Error("expecting a ring but getting "+t);var i,r,n,s,a=new Context(null,null,t.outerContext),h=this.context.parentContext,l=e.asArray();if(a.receiver||(a.receiver=t.receiver),r=new Context(this.context.parentContext,t.expression,a,t.receiver),this.context.parentContext=r,t.expression instanceof ReporterBlockMorph&&(this.readyToYield=Date.now()-this.lastYield>this.timeout),l.length>0){for(n=0;n<t.inputs.length;n+=1)s=0,isNil(l[n])||(s=l[n]),a.variables.addVar(t.inputs[n],s);if(0===t.inputs.length)if(a.variables.addVar(["arguments"],e),1===l.length)for(n=1;n<=t.emptySlots;n+=1)a.variables.addVar(n,l[0]);else if(l.length===t.emptySlots)for(n=1;n<=l.length;n+=1)a.variables.addVar(n,l[n-1]);else if(1!==t.emptySlots)throw new Error(localize("expecting")+" "+t.emptySlots+" "+localize("input(s), but getting")+" "+l.length)}r.expression instanceof CommandBlockMorph&&(r.expression=r.expression.blockSequence(),o||(h?h.tag="exit":((i=new Context(r.parentContext,"expectReport",a,a.receiver)).tag="exit",r.parentContext=i)))},Process.prototype.fork=function(t,e){var o=new Process,i=this.homeContext.receiver.parentThatIsA(StageMorph);o.instrument=this.instrument,o.receiver=this.receiver,o.initializeFor(t,e,this.enableSingleStepping),i.threads.processes.push(o)},Process.prototype.initializeFor=function(t,e,o){if(t.isContinuation)throw new Error("continuations cannot be forked");if(!(t instanceof Context))throw new Error("expecting a ring but getting "+t);var i,r,n,s=new Context(null,null,t.outerContext),a=new Context(null,t.expression,s),h=e.asArray();if(this.context=t.receiver,h.length>0){for(i=0;i<t.inputs.length;i+=1)r=0,isNil(h[i])||(r=h[i]),s.variables.addVar(t.inputs[i],r);if(0===t.inputs.length)if(s.variables.addVar(["arguments"],e),1===h.length)for(i=1;i<=t.emptySlots;i+=1)s.variables.addVar(i,h[0]);else if(h.length===t.emptySlots)for(i=1;i<=h.length;i+=1)s.variables.addVar(i,h[i-1]);else if(1!==t.emptySlots)throw new Error(localize("expecting")+" "+t.emptySlots+" "+localize("input(s), but getting")+" "+h.length)}a.expression instanceof CommandBlockMorph&&(a.expression=a.expression.blockSequence(),o||((n=new Context(a.parentContext,"expectReport",s,s.receiver)).tag="exit",a.parentContext=n)),this.homeContext=new Context,this.homeContext.receiver=t.outerContext.receiver,this.topBlock=t.expression,this.context=a},Process.prototype.doStopBlock=function(){var t=this.context.expression.exitTag;if(isNil(t))return this.doStopCustomBlock();for(;this.context&&(isNil(this.context.tag)||this.context.tag>t);)"doStopWarping"===this.context.expression?this.doStopWarping():this.popContext();this.pushContext()},Process.prototype.doStopCustomBlock=function(){for(;this.context&&!this.context.isCustomBlock;)"doStopWarping"===this.context.expression?this.doStopWarping():this.popContext()},Process.prototype.doCallCC=function(t,e){this.evaluate(t,new List([this.context.continuation()]),!e)},Process.prototype.reportCallCC=function(t){this.doCallCC(t,!0)},Process.prototype.runContinuation=function(t,e){var o=e.asArray();if("expectReport"===t.expression&&o.length)return this.stop(),void(this.homeContext.inputs[0]=o[0]);this.context.parentContext=t.copyForContinuationCall(),1===o.length&&this.context.parentContext.outerContext.variables.addVar(1,o[0])},Process.prototype.evaluateCustomBlock=function(){var t,e,o,i,r,n=this.context.parentContext,s=this.context.expression,a=s.isGlobal?s.definition:this.blockReceiver().getMethod(s.semanticSpec),h=a.body,l=a.declarations,p=new List(this.context.inputs).asArray();if(!h)return null;if(this.procedureCount+=1,r=new Context,r.receiver=this.context.receiver,r.variables.parentFrame=s.variables,a.variableNames.length?s.variables.parentFrame=r.receiver?r.receiver.variables:null:r.variables.parentFrame=r.receiver?r.receiver.variables:null,t=new Context(this.context.parentContext,h.expression,r,r.receiver),t.isCustomBlock=!0,this.context.parentContext=t,p.length>0)for(o=0;o<h.inputs.length;o+=1)i=0,isNil(p[o])||(i=p[o]),r.variables.addVar(h.inputs[o],i),"%upvar"===l[h.inputs[o]][0]&&(this.context.outerContext.variables.vars[i]=r.variables.vars[h.inputs[o]]);"command"!==a.type?(n?n.tag="exit":((e=new Context(t.parentContext,"expectReport",r,r.receiver)).tag="exit",t.parentContext=e),this.readyToYield=Date.now()-this.lastYield>this.timeout):(t.expression.tagExitBlocks(this.procedureCount,!0),n&&!n.tag&&(n.tag=this.procedureCount),!this.isAtomic&&a.isDirectlyRecursive()&&(this.readyToYield=!0)),t.expression=t.expression.blockSequence()},Process.prototype.doDeclareVariables=function(t){var e=this.context.outerContext.variables;t.asArray().forEach(function(t){e.addVar(t)})},Process.prototype.doSetVar=function(t,e){var o,i=this.context.variables,r=t;if(r instanceof Context)return o=this.blockReceiver(),"reportGetVar"===r.expression.selector?void r.variables.setVar(r.expression.blockSpec,e,o):void this.doSet(r,e);i.setVar(r,e,this.blockReceiver())},Process.prototype.doChangeVar=function(t,e){var o=this.context.variables,i=t;i instanceof Context&&"reportGetVar"===i.expression.selector?i.variables.changeVar(i.expression.blockSpec,e,this.blockReceiver()):o.changeVar(i,e,this.blockReceiver())},Process.prototype.reportGetVar=function(){return this.context.variables.getVar(this.context.expression.blockSpec)},Process.prototype.doShowVar=function(t){var e,o,i,r,n,s=this.context.variables,a=t;if(a instanceof Context){if("reportGetVar"!==a.expression.selector)return void this.doChangePrimitiveVisibility(a.expression,!1);a=a.expression.blockSpec}if(this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(StageMorph))){if(!(i=s.silentFind(a)))return;if(null!==(o=detect(e.children,function(t){return t instanceof WatcherMorph&&t.target===i&&t.getter===a})))return o.show(),void o.fixLayout();r=contains(this.homeContext.receiver.globalVariables().names(),t)||i.owner?a:a+" "+localize("(temporary)"),(o=new WatcherMorph(r,SpriteMorph.prototype.blockColor.variables,i,a)).setPosition(e.position().add(10)),(n=e.watchers(o.left())).length>0&&o.setTop(n[n.length-1].bottom()),e.add(o),o.fixLayout()}},Process.prototype.doHideVar=function(t){var e,o,i,r=this.context.variables,n=t;if(n instanceof Context){if("reportGetVar"!==n.expression.selector)return void this.doChangePrimitiveVisibility(n.expression,!0);n=n.expression.blockSpec}n?this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(StageMorph))&&(i=r.find(n),null!==(o=detect(e.children,function(t){return t instanceof WatcherMorph&&t.target===i&&t.getter===n}))&&(o.isTemporary()?o.destroy():o.hide())):this.doRemoveTemporaries()},Process.prototype.doRemoveTemporaries=function(){var t;this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(StageMorph))&&t.watchers().forEach(function(t){t.isTemporary()&&t.destroy()})},Process.prototype.doChangePrimitiveVisibility=function(t,e){var o,i=this.homeContext.receiver.parentThatIsA(IDE_Morph);i&&"evaluateCustomBlock"!==t.selector&&(e?StageMorph.prototype.hiddenPrimitives[t.selector]=!0:delete StageMorph.prototype.hiddenPrimitives[t.selector],"lists"===(o={doWarp:"control",reifyScript:"operators",reifyReporter:"operators",reifyPredicate:"operators",doDeclareVariables:"variables"}[this.selector]||this.category)&&(o="variables"),i.flushBlocksCache(o),i.refreshPalette())},Process.prototype.doDeleteAttr=function(t){var e=t,o=this.blockReceiver();if(e instanceof Context){if("reportGetVar"!==e.expression.selector)return e={xPosition:"x position",yPosition:"y position",direction:"direction",getCostumeIdx:"costume #",size:"size"}[e.expression.selector],void(isNil(e)||o.inheritAttribute(e));e=e.expression.blockSpec}if(e instanceof Array)return o.inheritAttribute(this.inputOption(e));contains(o.inheritedVariableNames(!0),e)&&o.deleteVariable(e)},Process.prototype.doTellTo=function(t,e,o){this.doRun(this.reportAttributeOf(e,t),o)},Process.prototype.reportAskFor=function(t,e,o){this.evaluate(this.reportAttributeOf(e,t),o)},Process.prototype.reportNewList=function(t){return t},Process.prototype.reportCONS=function(t,e){return this.assertType(e,"list"),(new List).cons(t,e)},Process.prototype.reportCDR=function(t){return this.assertType(t,"list"),t.cdr()},Process.prototype.doAddToList=function(t,e){this.assertType(e,"list"),e.type&&this.assertType(t,e.type),e.add(t)},Process.prototype.doDeleteFromList=function(t,e){var o=t;if(this.assertType(e,"list"),"all"===this.inputOption(t))return e.clear();if(""===t)return null;if("last"===this.inputOption(t))o=e.length();else if(isNaN(+this.inputOption(t)))return null;e.remove(o)},Process.prototype.doInsertInList=function(t,e,o){var i=e;if(this.assertType(o,"list"),o.type&&this.assertType(t,o.type),""===e)return null;"any"===this.inputOption(e)&&(i=this.reportRandom(1,o.length()+1)),"last"===this.inputOption(e)&&(i=o.length()+1),o.add(t,i)},Process.prototype.doReplaceInList=function(t,e,o){var i=t;if(this.assertType(e,"list"),e.type&&this.assertType(o,e.type),""===t)return null;"any"===this.inputOption(t)&&(i=this.reportRandom(1,e.length())),"last"===this.inputOption(t)&&(i=e.length()),e.put(o,i)},Process.prototype.reportListItem=function(t,e){var o=t;return this.assertType(e,"list"),""===t?"":("any"===this.inputOption(t)&&(o=this.reportRandom(1,e.length())),"last"===this.inputOption(t)&&(o=e.length()),e.at(o))},Process.prototype.reportListLength=function(t){return this.assertType(t,"list"),t.length()},Process.prototype.reportListContainsItem=function(t,e){return this.assertType(t,"list"),t.contains(e)},Process.prototype.doShowTable=function(t){this.assertType(t,"list"),new TableDialogMorph(t).popUp(this.blockReceiver().world())},Process.prototype.doIf=function(){var t=this.context.inputs,e=this.context.outerContext,o=this.context.isCustomBlock;this.popContext(),t[0]&&t[1]&&(this.pushContext(t[1].blockSequence(),e),this.context.isCustomBlock=o),this.pushContext()},Process.prototype.doIfElse=function(){var t=this.context.inputs,e=this.context.outerContext,o=this.context.isCustomBlock;this.popContext(),t[0]?t[1]&&this.pushContext(t[1].blockSequence(),e):t[2]?this.pushContext(t[2].blockSequence(),e):this.pushContext("doYield"),this.context&&(this.context.isCustomBlock=o),this.pushContext()},Process.prototype.doStop=function(){this.stop()},Process.prototype.doStopAll=function(){var t,e;this.homeContext.receiver&&((t=this.homeContext.receiver.parentThatIsA(StageMorph))&&(t.threads.resumeAll(t),t.keysPressed={},t.threads.stopAll(),t.stopAllActiveSounds(),t.children.forEach(function(t){t.stopTalking&&t.stopTalking()}),t.removeAllClones()),(e=t.parentThatIsA(IDE_Morph))&&e.controlBar.pauseButton.refresh())},Process.prototype.doStopThis=function(t){switch(this.inputOption(t)){case"all":this.doStopAll();break;case"this script":this.doStop();break;case"this block":this.doStopBlock();break;default:this.doStopOthers(t)}},Process.prototype.doStopOthers=function(t){var e;if(this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(StageMorph)))switch(this.inputOption(t)){case"all but this script":e.threads.stopAll(this);break;case"other scripts in sprite":e.threads.stopAllForReceiver(this.homeContext.receiver,this);break;default:nop()}},Process.prototype.doWarp=function(t){var e,o=this.context.outerContext,i=this.context.isCustomBlock;this.popContext(),t&&(this.homeContext.receiver&&(this.homeContext.receiver.startWarp&&this.homeContext.receiver.startWarp(),(e=this.homeContext.receiver.parentThatIsA(StageMorph))&&(e.fps=0)),this.pushContext("doYield"),this.context.isCustomBlock=i,this.isAtomic||this.pushContext("doStopWarping"),this.pushContext(t.blockSequence(),o),this.isAtomic=!0),this.pushContext()},Process.prototype.doStopWarping=function(){var t;this.popContext(),this.isAtomic=!1,this.homeContext.receiver&&(this.homeContext.receiver.endWarp&&this.homeContext.receiver.endWarp(),(t=this.homeContext.receiver.parentThatIsA(StageMorph))&&(t.fps=t.frameRate))},Process.prototype.reportIsFastTracking=function(){var t;return!(!this.homeContext.receiver||!(t=this.homeContext.receiver.parentThatIsA(IDE_Morph)))&&t.stage.isFastTracked},Process.prototype.doSetFastTracking=function(t){var e;this.reportIsA(t,"Boolean")&&this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(IDE_Morph))&&(t?e.startFastTracking():e.stopFastTracking())},Process.prototype.doPauseAll=function(){var t,e;this.homeContext.receiver&&((t=this.homeContext.receiver.parentThatIsA(StageMorph))&&t.threads.pauseAll(t),(e=t.parentThatIsA(IDE_Morph))&&e.controlBar.pauseButton.refresh())},Process.prototype.doForever=function(t){this.context.inputs=[],this.pushContext("doYield"),t&&this.pushContext(t.blockSequence()),this.pushContext()},Process.prototype.doRepeat=function(t,e){var o=this.context.expression,i=this.context.outerContext,r=this.context.isCustomBlock;if(t<1)return null;this.popContext(),this.pushContext(o,i),this.context.isCustomBlock=r,this.context.addInput(t-1),this.pushContext("doYield"),e&&this.pushContext(e.blockSequence()),this.pushContext()},Process.prototype.doUntil=function(t,e){if(t)return this.popContext(),this.pushContext("doYield"),null;this.context.inputs=[],this.pushContext("doYield"),e&&this.pushContext(e.blockSequence()),this.pushContext()},Process.prototype.doWaitUntil=function(t){if(t)return this.popContext(),this.pushContext("doYield"),null;this.context.inputs=[],this.pushContext("doYield"),this.pushContext()},Process.prototype.reportMap=function(t,e){var o;if(e.isLinked){if(this.context.inputs.length<3&&(this.context.addInput(new List),this.context.inputs[2].isLinked=!0,this.context.addInput(this.context.inputs[2]),this.context.addInput(e)),0===this.context.inputs[4].length())return this.context.inputs[3].rest=e.cons(this.context.inputs[5]),void this.returnValueToParentContext(this.context.inputs[2].cdr());this.context.inputs.length>5&&(this.context.inputs[3].rest=e.cons(this.context.inputs[5]),this.context.inputs[3]=this.context.inputs[3].rest,this.context.inputs.splice(5)),o=this.context.inputs[4].at(1),this.context.inputs[4]=this.context.inputs[4].cdr(),this.pushContext(),this.evaluate(t,new List([o]))}else{if(this.context.inputs.length-2===e.length())return void this.returnValueToParentContext(new List(this.context.inputs.slice(2)));o=e.at(this.context.inputs.length-1),this.pushContext(),this.evaluate(t,new List([o]))}},Process.prototype.doForEach=function(t,e,o){isNil(this.context.inputs[3])&&(this.context.inputs[3]=1);var i=this.context.inputs[3];this.context.outerContext.variables.addVar(t),this.context.outerContext.variables.setVar(t,e.at(i)),i>e.length()||(this.context.inputs[3]+=1,this.pushContext("doYield"),this.pushContext(),this.evaluate(o,new List,!0))},Process.prototype.doWait=function(t){if(this.context.startTime||(this.context.startTime=Date.now()),Date.now()-this.context.startTime>=1e3*t)return this.isAtomic||0!==t||(this.readyToYield=!0),null;this.pushContext("doYield"),this.pushContext()},Process.prototype.doGlide=function(t,e,o){if(this.context.startTime||(this.context.startTime=Date.now(),this.context.startValue=new Point(this.blockReceiver().xPosition(),this.blockReceiver().yPosition())),Date.now()-this.context.startTime>=1e3*t)return this.blockReceiver().gotoXY(e,o),null;this.blockReceiver().glide(1e3*t,e,o,Date.now()-this.context.startTime,this.context.startValue),this.pushContext("doYield"),this.pushContext()},Process.prototype.doSayFor=function(t,e){if(this.context.startTime||(this.context.startTime=Date.now(),this.blockReceiver().bubble(t)),Date.now()-this.context.startTime>=1e3*e)return this.blockReceiver().stopTalking(),null;this.pushContext("doYield"),this.pushContext()},Process.prototype.doThinkFor=function(t,e){if(this.context.startTime||(this.context.startTime=Date.now(),this.blockReceiver().doThink(t)),Date.now()-this.context.startTime>=1e3*e)return this.blockReceiver().stopTalking(),null;this.pushContext("doYield"),this.pushContext()},Process.prototype.blockReceiver=function(){return this.context?this.context.receiver||this.homeContext.receiver:this.homeContext.receiver||this.receiver},Process.prototype.doPlaySoundUntilDone=function(t){var e=this.blockReceiver();if(null===this.context.activeAudio&&(this.context.activeAudio=e.playSound(t)),this.context.activeAudio.ended||this.context.activeAudio.terminated)return null;this.pushContext("doYield"),this.pushContext()},Process.prototype.doStopAllSounds=function(){var t=this.homeContext.receiver.parentThatIsA(StageMorph);t&&(t.threads.processes.forEach(function(t){t.context&&(t.context.stopMusic(),t.context.activeAudio&&t.popContext())}),t.stopAllActiveSounds())},Process.prototype.doAsk=function(t){var e=this.homeContext.receiver.parentThatIsA(StageMorph),o=this.blockReceiver(),i=o instanceof StageMorph,r=o instanceof SpriteMorph&&!o.isVisible;if(e.keysPressed={},this.prompter){if(this.prompter.isDone)return e.lastAnswer=this.prompter.inputField.getValue(),this.prompter.destroy(),this.prompter=null,i||o.stopTalking(),null}else detect(e.children,function(t){return t instanceof StagePrompterMorph})||(i||r||o.bubble(t,!1,!0),this.prompter=new StagePrompterMorph(i||r?t:null),e.scale<1?this.prompter.setWidth(e.width()-10):this.prompter.setWidth(e.dimensions.x-20),this.prompter.fixLayout(),this.prompter.setCenter(e.center()),this.prompter.setBottom(e.bottom()-this.prompter.border),e.add(this.prompter),this.prompter.inputField.edit(),e.changed());this.pushContext("doYield"),this.pushContext()},Process.prototype.reportLastAnswer=function(){return this.homeContext.receiver.parentThatIsA(StageMorph).lastAnswer},Process.prototype.reportURL=function(t){var e;if(this.httpRequest){if(4===this.httpRequest.readyState)return e=this.httpRequest.responseText,this.httpRequest=null,e}else(t.indexOf("//")<0||t.indexOf("//")>8)&&(t="file:"===location.protocol?"https://"+t:location.protocol+"//"+t),this.httpRequest=new XMLHttpRequest,this.httpRequest.open("GET",t,!0),this.httpRequest.send(null);this.pushContext("doYield"),this.pushContext()},Process.prototype.doBroadcast=function(t){var e,o,i,r=this.homeContext.receiver.parentThatIsA(StageMorph),n=t,s=this,a=[];if(t instanceof List&&2===t.length())if(e=this.blockReceiver(),n=t.at(1),o=t.at(2),isSnapObject(o))i=[o];else if(isString(o))i=o===r.name?[r]:[this.getOtherObject(o,e,r)];else{if(!(o instanceof List))return;i=o.itemsArray().map(function(t){return s.getOtherObject(t,e,r)})}else i=r.children.concat(r);return""!==n&&(r.lastMessage=t,i.forEach(function(t){isSnapObject(t)&&t.allHatBlocksFor(n).forEach(function(e){a.push(r.threads.startProcess(e,t,r.isThreadSafe))})})),a},Process.prototype.doBroadcastAndWait=function(t){if(this.context.activeSends||(this.context.activeSends=this.doBroadcast(t)),this.context.activeSends=this.context.activeSends.filter(function(t){return t.isRunning()}),0===this.context.activeSends.length)return null;this.pushContext("doYield"),this.pushContext()},Process.prototype.getLastMessage=function(){var t;return this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(StageMorph))?t.getLastMessage():""},Process.prototype.reportIsA=function(t,e){return this.reportTypeOf(t)===this.inputOption(e)},Process.prototype.assertType=function(t,e){var o=this.reportTypeOf(t);if(o===e)return!0;if(e instanceof Array&&contains(e,o))return!0;throw new Error("expecting "+e+" but getting "+o)},Process.prototype.assertAlive=function(t){if(t&&t.isCorpse)throw new Error("cannot operate on a deleted sprite")},Process.prototype.reportTypeOf=function(t){var e;return null===t||void 0===t?"nothing":!0===t||!1===t?"Boolean":isNaN(+t)?isString(t)?"text":t instanceof List?"list":t instanceof SpriteMorph?"sprite":t instanceof StageMorph?"stage":t instanceof Costume?"costume":t instanceof Sound?"sound":t instanceof Context?t.expression instanceof RingMorph?t.expression.dataType():t.expression instanceof ReporterBlockMorph?t.expression.isPredicate?"predicate":"reporter":t.expression instanceof Array?(e=t.expression[t.pc||0],e.isPredicate?"predicate":e instanceof RingMorph?e.dataType():e instanceof ReporterBlockMorph?"reporter":e instanceof CommandBlockMorph?"command":"reporter"):t.expression instanceof CommandBlockMorph?"command":"reporter":"undefined":"number"},Process.prototype.reportSum=function(t,e){return+t+ +e},Process.prototype.reportDifference=function(t,e){return+t-+e},Process.prototype.reportProduct=function(t,e){return+t*+e},Process.prototype.reportQuotient=function(t,e){return+t/+e},Process.prototype.reportModulus=function(t,e){var o=+e;return(+t%o+o)%o},Process.prototype.reportRandom=function(t,e){var o=+t,i=+e;return o%1!=0||i%1!=0?Math.random()*(i-o)+o:Math.floor(Math.random()*(i-o+1))+o},Process.prototype.reportLessThan=function(t,e){var o=+t,i=+e;return(isNaN(o)||isNaN(i))&&(o=t,i=e),o<i},Process.prototype.reportNot=function(t){return!t},Process.prototype.reportGreaterThan=function(t,e){var o=+t,i=+e;return(isNaN(o)||isNaN(i))&&(o=t,i=e),o>i},Process.prototype.reportEquals=function(t,e){return snapEquals(t,e)},Process.prototype.reportIsIdentical=function(t,e){function o(){Object.prototype.hasOwnProperty.call(t,i)&&delete t[i],Object.prototype.hasOwnProperty.call(e,i)&&delete e[i]}var i="idTag";return this.isImmutable(t)||this.isImmutable(e)?snapEquals(t,e):(o(),t[i]=Date.now(),e[i]===t[i]?(o(),!0):(o(),!1))},Process.prototype.isImmutable=function(t){var e=this.reportTypeOf(t);return"nothing"===e||"Boolean"===e||"text"===e||"number"===e||"undefined"===e},Process.prototype.reportBoolean=function(t){return t},Process.prototype.reportRound=function(t){return Math.round(+t)},Process.prototype.reportMonadic=function(t,e){var o=+e,i=0;switch(this.inputOption(t)){case"abs":i=Math.abs(o);break;case"ceiling":i=Math.ceil(o);break;case"floor":i=Math.floor(o);break;case"sqrt":i=Math.sqrt(o);break;case"sin":i=Math.sin(radians(o));break;case"cos":i=Math.cos(radians(o));break;case"tan":i=Math.tan(radians(o));break;case"asin":i=degrees(Math.asin(o));break;case"acos":i=degrees(Math.acos(o));break;case"atan":i=degrees(Math.atan(o));break;case"ln":i=Math.log(o);break;case"log":i=Math.log(o)/Math.LN10;break;case"e^":i=Math.exp(o);break;case"10^":i=Math.pow(10,o);break;default:nop()}return i},Process.prototype.reportTextFunction=function(t,e){var o=(isNil(e)?"":e).toString(),i="";switch(this.inputOption(t)){case"encode URI":i=encodeURI(o);break;case"decode URI":i=decodeURI(o);break;case"encode URI component":i=encodeURIComponent(o);break;case"decode URI component":i=decodeURIComponent(o);break;case"XML escape":i=(new XML_Element).escape(o);break;case"XML unescape":i=(new XML_Element).unescape(o);break;case"hex sha512 hash":i=hex_sha512(o);break;default:nop()}return i},Process.prototype.reportJoin=function(t,e){var o=(isNil(t)?"":t).toString(),i=(isNil(e)?"":e).toString();return o.concat(i)},Process.prototype.reportJoinWords=function(t){return t instanceof List?t.asText():(t||"").toString()},Process.prototype.reportLetter=function(t,e){if(e instanceof List)return"";var o=+(t||0);return(isNil(e)?"":e.toString())[o-1]||""},Process.prototype.reportStringSize=function(t){return t instanceof List?t.length():isNil(t)?0:t.toString().length},Process.prototype.reportUnicode=function(t){var e=(t||"").toString()[0];return e?e.charCodeAt(0):0},Process.prototype.reportUnicodeAsLetter=function(t){var e=+(t||0);return String.fromCharCode(e)},Process.prototype.reportTextSplit=function(t,e){var o,i,r=["text","number"],n=this.reportTypeOf(t),s=this.reportTypeOf(this.inputOption(e));if(!contains(r,n))throw new Error("expecting text instead of a "+n);if(!contains(r,s))throw new Error("expecting a text delimiter instead of a "+s);switch(o=isNil(t)?"":t.toString(),this.inputOption(e)){case"line":i=/\r\n|[\n\v\f\r\x85\u2028\u2029]/;break;case"tab":i="\t";break;case"cr":i="\r";break;case"whitespace":o=o.trim(),i=/\s+/;break;case"letter":i="";break;case"csv":return this.parseCSV(t);default:i=isNil(e)?"":e.toString()}return new List(o.split(i))},Process.prototype.parseCSV=function(t){var e=/(?!\s*$)\s*(?:'([^'\\]*(?:\\[\S\s][^'\\]*)*)'|"([^"\\]*(?:\\[\S\s][^"\\]*)*)"|([^,'"\s\\]*(?:\s+[^,'"\s\\]+)*))\s*(?:,|$)/g,o=[];return/^\s*(?:'[^'\\]*(?:\\[\S\s][^'\\]*)*'|"[^"\\]*(?:\\[\S\s][^"\\]*)*"|[^,'"\s\\]*(?:\s+[^,'"\s\\]+)*)\s*(?:,\s*(?:'[^'\\]*(?:\\[\S\s][^'\\]*)*'|"[^"\\]*(?:\\[\S\s][^"\\]*)*"|[^,'"\s\\]*(?:\s+[^,'"\s\\]+)*)\s*)*$/.test(t)?(t.replace(e,function(t,e,i,r){return void 0!==e?o.push(e.replace(/\\'/g,"'")):void 0!==i?o.push(i.replace(/\\"/g,'"')):void 0!==r&&o.push(r),""}),/,\s*$/.test(t)&&o.push(""),new List(o)):new List},Process.prototype.alert=function(t){this.homeContext.receiver&&this.homeContext.receiver.world().isDevMode&&alert("Snap! "+t.asArray())},Process.prototype.log=function(t){this.homeContext.receiver&&this.homeContext.receiver.world().isDevMode},Process.prototype.getOtherObject=function(t,e,o){if(isSnapObject(t))return t;var i=isNil(o)?e.parentThatIsA(StageMorph):o,r=null;return i&&((r=detect(i.children,function(e){return e.name===t}))||(r=detect(i.world().hand.children,function(e){return e instanceof SpriteMorph&&e.name===t}))),r},Process.prototype.getObjectsNamed=function(t,e,o){function i(e){return e instanceof SpriteMorph&&e.isTemporary?e.cloneOriginName===t:e.name===t}var r=isNil(o)?e.parentThatIsA(StageMorph):o,n=[];return r&&((n=r.children.filter(i)).length||(n=r.world().hand.children.filter(i))),n},Process.prototype.doFaceTowards=function(t){var e,o=this.blockReceiver();if(o)if("mouse-pointer"===this.inputOption(t))o.faceToXY(this.reportMouseX(),this.reportMouseY());else{if(t instanceof List)return void o.faceToXY(t.at(1),t.at(2));(e=this.getOtherObject(t,this.homeContext.receiver))&&o.faceToXY(e.xPosition(),e.yPosition())}},Process.prototype.doGotoObject=function(t){var e,o=this.blockReceiver();if(o)if("mouse-pointer"===this.inputOption(t))o.gotoXY(this.reportMouseX(),this.reportMouseY());else{if(t instanceof List)return void o.gotoXY(t.at(1),t.at(2));(e=this.getOtherObject(t,this.homeContext.receiver))&&o.gotoXY(e.xPosition(),e.yPosition())}},Process.prototype.createClone=function(t){var e,o=this.blockReceiver();t&&o&&("myself"===this.inputOption(t)?o.createClone(!this.isFirstStep):(e=this.getOtherObject(t,o))&&e.createClone(!this.isFirstStep))},Process.prototype.newClone=function(t){var e,o=this.blockReceiver();if(t&&o){if("myself"===this.inputOption(t))return o.newClone(!this.isFirstStep);if(e=this.getOtherObject(t,o))return e.newClone(!this.isFirstStep)}},Process.prototype.reportTouchingObject=function(t){var e=this.blockReceiver();return!!e&&this.objectTouchingObject(e,t)},Process.prototype.objectTouchingObject=function(t,e){var o,i,r,n=this;if("mouse-pointer"===this.inputOption(e)){if(r=t.world().hand.position(),t.bounds.containsPoint(r)&&!t.isTransparentAt(r))return!0}else if(o=t.parentThatIsA(StageMorph)){if("edge"===this.inputOption(e)&&(i=t.bounds,!t.costume&&t.penBounds&&(i=t.penBounds.translateBy(t.position())),!o.bounds.containsRectangle(i)))return!0;if("pen trails"===this.inputOption(e)&&t.isTouching(o.penTrailsMorph()))return!0;if(isSnapObject(e))return t.isTouching(e);if((e instanceof List?e.itemsArray():this.getObjectsNamed(e,t,o)).some(function(e){return t.isTouching(e)}))return!0}return t.parts.some(function(t){return n.objectTouchingObject(t,e)})},Process.prototype.reportTouchingColor=function(t){var e,o=this.blockReceiver();return!(!o||!(e=o.parentThatIsA(StageMorph)))&&(!!o.isTouching(e.colorFiltered(t,o))||o.parts.some(function(o){return o.isTouching(e.colorFiltered(t,o))}))},Process.prototype.reportColorIsTouchingColor=function(t,e){var o,i=this.blockReceiver();return!(!i||!(o=i.parentThatIsA(StageMorph)))&&(!!i.colorFiltered(t).isTouching(o.colorFiltered(e,i))||i.parts.some(function(i){return i.colorFiltered(t).isTouching(o.colorFiltered(e,i))}))},Process.prototype.reportDistanceTo=function(t){var e,o,i,r,n=this.blockReceiver();if(n){if(i=n.rotationCenter(),r=i,"mouse-pointer"===this.inputOption(t))r=n.world().hand.position();else if(t instanceof List)return new Point(n.xPosition(),n.yPosition()).distanceTo(new Point(t.at(1),t.at(2)));return o=n.parentThatIsA(StageMorph),(e=this.getOtherObject(t,n,o))&&(r=e.rotationCenter()),i.distanceTo(r)/o.scale}return 0},Process.prototype.reportAttributeOf=function(t,e){var o,i,r=this.blockReceiver();if(r&&(this.assertAlive(r),i=r.parentThatIsA(StageMorph),o=i.name===e?i:this.getOtherObject(e,r,i))){if(this.assertAlive(o),t instanceof Context)return this.reportContextFor(t,o);if(isString(t))return o.variables.getVar(t);switch(this.inputOption(t)){case"x position":return o.xPosition?o.xPosition():"";case"y position":return o.yPosition?o.yPosition():"";case"direction":return o.direction?o.direction():"";case"costume #":return o.getCostumeIdx();case"costume name":return o.costume?o.costume.name:localize(o instanceof SpriteMorph?"Turtle":"Empty");case"size":return o.getScale?o.getScale():""}}return""},Process.prototype.reportGet=function(t){var e,o,i,r=this.blockReceiver();if(r)switch(this.inputOption(t)){case"self":return r;case"other sprites":return o=r.parentThatIsA(StageMorph),new List(o.children.filter(function(t){return t instanceof SpriteMorph&&t!==r}));case"parts":return new List(r.parts||[]);case"anchor":return r.anchor||"";case"parent":return r.exemplar||"";case"children":return new List(r.specimens?r.specimens():[]);case"temporary?":return r.isTemporary||!1;case"clones":return o=r.parentThatIsA(StageMorph),i=r.name||r.cloneOriginName,new List(o.children.filter(function(t){return t.isTemporary&&t!==r&&t.cloneOriginName===i}));case"other clones":return r.isTemporary?this.reportGet(["clones"]):new List;case"neighbors":return o=r.parentThatIsA(StageMorph),e=r.bounds.expandBy(new Point(r.width(),r.height())),new List(o.children.filter(function(t){return t instanceof SpriteMorph&&t!==r&&t.bounds.intersects(e)}));case"dangling?":return!r.rotatesWithAnchor;case"rotation x":return r.xPosition();case"rotation y":return r.yPosition();case"center x":return r.xCenter();case"center y":return r.yCenter();case"name":return r.name;case"stage":return r.parentThatIsA(StageMorph);case"costumes":return r.reportCostumes();case"sounds":return r.sounds}return""},Process.prototype.doSet=function(t,e){var o,i;if(t instanceof Context){if(i=this.blockReceiver(),this.assertAlive(i),!(t instanceof Context)||"reportGet"!==t.expression.selector)throw new Error(localize("unsupported attribute"));switch((o=t.expression.inputs()[0].evaluate())instanceof Array&&(o=o[0]),o){case"anchor":if(this.assertType(i,"sprite"),e instanceof SpriteMorph){if(!i.enableNesting||contains(i.allParts(),e))throw new Error(localize("unable to nest\n(disabled or circular?)"));e.attachPart(i)}else i.detachFromAnchor();break;case"parent":this.assertType(i,"sprite"),e=e instanceof SpriteMorph?e:null,i.setExemplar(e);break;case"temporary?":this.assertType(i,"sprite"),this.assertType(e,"Boolean"),i.world().isDevMode&&(e?i.release():i.perpetuate());break;case"dangling?":this.assertType(i,"sprite"),this.assertType(e,"Boolean"),i.rotatesWithAnchor=!e,i.version=Date.now();break;case"rotation x":this.assertType(i,"sprite"),this.assertType(e,"number"),i.setRotationX(e);break;case"rotation y":this.assertType(i,"sprite"),this.assertType(e,"number"),i.setRotationY(e);break;default:throw new Error('"'+localize(o)+'" '+localize("is read-only"))}}},Process.prototype.reportContextFor=function(t,e){var o=copy(t);return o.receiver=e,o.outerContext&&(o.outerContext=copy(o.outerContext),o.outerContext.variables=copy(o.outerContext.variables),o.outerContext.receiver=e,o.outerContext.variables.parentFrame=e.variables),o},Process.prototype.reportMouseX=function(){var t,e;return this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(StageMorph))&&(e=t.world())?(e.hand.position().x-t.center().x)/t.scale:0},Process.prototype.reportMouseY=function(){var t,e;return this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(StageMorph))&&(e=t.world())?(t.center().y-e.hand.position().y)/t.scale:0},Process.prototype.reportMouseDown=function(){var t;return!(!this.homeContext.receiver||!(t=this.homeContext.receiver.world()))&&"left"===t.hand.mouseButton},Process.prototype.reportKeyPressed=function(t){var e;return!(!this.homeContext.receiver||!(e=this.homeContext.receiver.parentThatIsA(StageMorph)))&&("any key"===this.inputOption(t)?Object.keys(e.keysPressed).length>0:void 0!==e.keysPressed[t])},Process.prototype.doResetTimer=function(){var t;this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(StageMorph))&&t.resetTimer()},Process.prototype.reportTimer=function(){var t;return this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(StageMorph))?t.getTimer():0},Process.prototype.reportDate=function(t){var e,o,i,r=this.inputOption(t),n={year:"getFullYear",month:"getMonth",date:"getDate","day of week":"getDay",hour:"getHours",minute:"getMinutes",second:"getSeconds","time in milliseconds":"getTime"};return n[r]?(e=new Date,o=n[r],i=e[o](),"month"!==r&&"day of week"!==r||(i+=1),i):""},Process.prototype.doMapCodeOrHeader=function(t,e,o){if("code"===this.inputOption(e))return this.doMapCode(t,o);if("header"===this.inputOption(e))return this.doMapHeader(t,o);throw new Error(" '"+e+"'\nis not a valid option")},Process.prototype.doMapHeader=function(t,e){if(t instanceof Context&&t.expression instanceof SyntaxElementMorph)return t.expression.mapHeader(e||"")},Process.prototype.doMapCode=function(t,e){if(t instanceof Context&&t.expression instanceof SyntaxElementMorph)return t.expression.mapCode(e||"")},Process.prototype.doMapValueCode=function(t,e){var o=this.inputOption(t);switch(o){case"String":StageMorph.prototype.codeMappings.string=e||"<#1>";break;case"Number":StageMorph.prototype.codeMappings.number=e||"<#1>";break;case"true":StageMorph.prototype.codeMappings.boolTrue=e||"true";break;case"false":StageMorph.prototype.codeMappings.boolFalse=e||"true";break;default:throw new Error(localize("unsupported data type")+" "+o)}},Process.prototype.doMapListCode=function(t,e,o){var i="",r="delim";"parameters"===this.inputOption(e)?i="parms_":"variables"===this.inputOption(e)&&(i="tempvars_"),"list"===this.inputOption(t)?r="list":"item"===this.inputOption(t)&&(r="item"),StageMorph.prototype.codeMappings[i+r]=o||""},Process.prototype.reportMappedCode=function(t){return t instanceof Context&&t.expression instanceof SyntaxElementMorph?t.expression.mappedCode():""},Process.prototype.doRest=function(t){var e=this.reportTempo();this.doWait(60/e*t)},Process.prototype.reportTempo=function(){var t;return this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(StageMorph))?t.getTempo():0},Process.prototype.doChangeTempo=function(t){var e;this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(StageMorph))&&e.changeTempo(t)},Process.prototype.doSetTempo=function(t){var e;this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(StageMorph))&&e.setTempo(t)},Process.prototype.doPlayNote=function(t,e){var o=this.reportTempo();this.doPlayNoteForSecs(parseFloat(t||"0"),60/o*parseFloat(e||"0"))},Process.prototype.doPlayNoteForSecs=function(t,e){if(this.context.startTime||(this.context.startTime=Date.now(),this.context.activeNote=new Note(t),this.context.activeNote.play(this.instrument)),Date.now()-this.context.startTime>=1e3*e)return this.context.activeNote&&(this.context.activeNote.stop(),this.context.activeNote=null),null;this.pushContext("doYield"),this.pushContext()},Process.prototype.doSetInstrument=function(t){this.instrument=+t,this.receiver.instrument=+t},Process.prototype.inputOption=function(t){return t instanceof Array?t[0]:t},Process.prototype.pushContext=function(t,e){this.context=new Context(this.context,t,e||(this.context?this.context.outerContext:null),this.context?this.context.receiver:this.homeContext.receiver)},Process.prototype.popContext=function(){this.context&&this.context.stopMusic(),this.context=this.context?this.context.parentContext:null},Process.prototype.returnValueToParentContext=function(t){void 0!==t&&(this.context?this.context.parentContext||this.homeContext:this.homeContext).addInput(t)},Process.prototype.reportStackSize=function(){return this.context?this.context.stackSize():0},Process.prototype.reportFrameCount=function(){return this.frameCount},Process.prototype.flashContext=function(){var t=this.context.expression;return!(!(this.enableSingleStepping&&!this.isAtomic&&t instanceof SyntaxElementMorph)||t instanceof CommandSlotMorph||this.context.isFlashing||!t.world()||t instanceof ColorSlotMorph)&&(this.unflash(),t.flash(),this.context.isFlashing=!0,this.flashingContext=this.context,this.flashTime>0&&this.flashTime<=.5?(this.pushContext("doIdle"),this.context.addInput(this.flashTime)):this.pushContext("doInterrupt"),!0)},Process.prototype.flashPausedContext=function(){var t=this.context?this.context.lastFlashable():null;t&&(this.unflash(),t.expression.flash(),t.isFlashing=!0,this.flashingContext=t)},Process.prototype.doInterrupt=function(){this.popContext(),this.isAtomic||(this.isInterrupted=!0)},Process.prototype.doIdle=function(t){this.context.startTime||(this.context.startTime=Date.now()),Date.now()-this.context.startTime<1e3*t?this.pushContext("doInterrupt"):this.popContext()},Process.prototype.unflash=function(){this.flashingContext&&(this.flashingContext.expression.unflash(),this.flashingContext.isFlashing=!1,this.flashingContext=null)},Context.prototype.toString=function(){var t=this.expression;return t instanceof Array&&t.length>0&&(t="["+t[0]+"]"),"Context >> "+t+" "+this.variables},Context.prototype.image=function(){var t,e,o=new RingMorph;return this.expression instanceof Morph?(t=this.expression.fullCopy(),this.isContinuation&&(e=detect(t.allInputs(),function(t){return 1===t.bindingID}))&&t.revertToDefaultInput(e,!0),o.embed(t,this.inputs),o.fullImage()):this.expression instanceof Array?(t=this.expression[this.pc].fullCopy())instanceof RingMorph&&!t.contents()?t.fullImage():(o.embed(t,this.isContinuation?[]:this.inputs),o.fullImage()):(o.color=SpriteMorph.prototype.blockColor.other,o.setSpec("%rc %ringparms"),this.isContinuation||this.inputs.forEach(function(t){o.parts()[1].addInput(t)}),o.fullImage())},Context.prototype.continuation=function(){var t;if(this.expression instanceof Array)t=this;else{if(!this.parentContext)return t=new Context(null,"expectReport"),t.isContinuation=!0,t;t=this.parentContext}return t=t.copyForContinuation(),t.tag=null,t.isContinuation=!0,t},Context.prototype.copyForContinuation=function(){var t=copy(this),e=t;if(!(this.expression instanceof Array||isString(this.expression)))for(e.prepareContinuationForBinding();e.parentContext;)e.parentContext=copy(e.parentContext),(e=e.parentContext).inputs=[];return t},Context.prototype.copyForContinuationCall=function(){var t=copy(this),e=t;if(!(this.expression instanceof Array||isString(this.expression)))for(this.expression=this.expression.fullCopy(),this.inputs=[];e.parentContext;)e.parentContext=copy(e.parentContext),(e=e.parentContext).inputs=[];return t},Context.prototype.prepareContinuationForBinding=function(){var t,e=this.inputs.length;this.expression=this.expression.fullCopy(),(t=this.expression.inputs()[e])&&(this.inputs=[],t.bindingID=1,this.emptySlots=1)},Context.prototype.addInput=function(t){this.inputs.push(t)},Context.prototype.stopMusic=function(){this.activeNote&&(this.activeNote.stop(),this.activeNote=null)},Context.prototype.lastFlashable=function(){return this.expression instanceof SyntaxElementMorph&&!(this.expression instanceof CommandSlotMorph)?this:this.parentContext?this.parentContext.lastFlashable():null},Context.prototype.stackSize=function(){return this.parentContext?1+this.parentContext.stackSize():1},Variable.prototype.toString=function(){return"a "+(this.isTransient?"transient ":"")+"Variable ["+this.value+"]"},Variable.prototype.copy=function(){return new Variable(this.value,this.isTransient)},VariableFrame.prototype.toString=function(){return"a VariableFrame {"+this.names()+"}"},VariableFrame.prototype.copy=function(){var t=new VariableFrame(this.parentFrame),e=this;return this.names().forEach(function(o){t.addVar(o,e.getVar(o))}),t},VariableFrame.prototype.deepCopy=function(){var t;return t=new VariableFrame(this.parentFrame?this.parentFrame.deepCopy():this.parentFrame),t.vars=copy(this.vars),t},VariableFrame.prototype.find=function(t){var e=this.silentFind(t);if(e)return e;throw new Error(localize("a variable of name '")+t+localize("'\ndoes not exist in this context"))},VariableFrame.prototype.silentFind=function(t){return void 0!==this.vars[t]?this:this.parentFrame?this.parentFrame.silentFind(t):null},VariableFrame.prototype.setVar=function(t,e,o){var i=this.find(t);i&&(o instanceof SpriteMorph&&i.owner instanceof SpriteMorph&&o!==i.owner?o.shadowVar(t,e):i.vars[t].value=e)},VariableFrame.prototype.changeVar=function(t,e,o){var i,r,n=this.find(t);n&&(i=parseFloat(n.vars[t].value),r=isNaN(i)?e:i+parseFloat(e),o instanceof SpriteMorph&&n.owner instanceof SpriteMorph&&o!==n.owner?o.shadowVar(t,r):n.vars[t].value=r)},VariableFrame.prototype.getVar=function(t){var e,o=this.silentFind(t);if(o)return e=o.vars[t].value,0===e?0:!1!==e&&(""===e?"":e||0);if("number"==typeof t)return"";throw new Error(localize("a variable of name '")+t+localize("'\ndoes not exist in this context"))},VariableFrame.prototype.addVar=function(t,e){this.vars[t]=new Variable(0===e?0:!1!==e&&(""===e?"":e||0))},VariableFrame.prototype.deleteVar=function(t){var e=this.find(t);e&&delete e.vars[t]},VariableFrame.prototype.names=function(){var t,e=[];for(t in this.vars)Object.prototype.hasOwnProperty.call(this.vars,t)&&e.push(t);return e},VariableFrame.prototype.allNamesDict=function(){for(var t={},e=this;e;)!function(t,e){var o;for(o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=o)}(e.vars,t),e=e.parentFrame;return t},VariableFrame.prototype.allNames=function(){var t,e=[],o=this.allNamesDict();for(t in o)Object.prototype.hasOwnProperty.call(o,t)&&e.push(t);return e},modules.objects="2017-December-12";var SpriteMorph,StageMorph,SpriteBubbleMorph,Costume,SVG_Costume,CostumeEditorMorph,Sound,Note,CellMorph,WatcherMorph,StagePrompterMorph,Note,SpriteHighlightMorph;SpriteMorph.prototype=new PenMorph,SpriteMorph.prototype.constructor=SpriteMorph,SpriteMorph.uber=PenMorph.prototype,SpriteMorph.prototype.attributes=["x position","y position","direction","size","costumes","costume #","sounds","scripts"],SpriteMorph.prototype.categories=["motion","control","looks","sensing","sound","operators","pen","variables","lists","other"],SpriteMorph.prototype.blockColor={motion:new Color(74,108,212),looks:new Color(143,86,227),sound:new Color(207,74,217),pen:new Color(0,161,120),control:new Color(230,168,34),sensing:new Color(4,148,220),operators:new Color(98,194,19),variables:new Color(243,118,29),lists:new Color(217,77,17),other:new Color(150,150,150)},SpriteMorph.prototype.paletteColor=new Color(55,55,55),SpriteMorph.prototype.paletteTextColor=new Color(230,230,230),SpriteMorph.prototype.sliderColor=SpriteMorph.prototype.paletteColor.lighter(30),SpriteMorph.prototype.isCachingPrimitives=!0,SpriteMorph.prototype.enableNesting=!0,SpriteMorph.prototype.enableFirstClass=!0,SpriteMorph.prototype.useFlatLineEnds=!1,SpriteMorph.prototype.highlightColor=new Color(250,200,130),SpriteMorph.prototype.highlightBorder=8,SpriteMorph.prototype.bubbleColor=new Color(255,255,255),SpriteMorph.prototype.bubbleFontSize=14,SpriteMorph.prototype.bubbleFontIsBold=!0,SpriteMorph.prototype.bubbleCorner=10,SpriteMorph.prototype.bubbleBorder=3,SpriteMorph.prototype.bubbleBorderColor=new Color(190,190,190),SpriteMorph.prototype.bubbleMaxTextWidth=130,SpriteMorph.prototype.initBlocks=function(){SpriteMorph.prototype.blocks={forward:{only:SpriteMorph,type:"command",category:"motion",spec:"move %n steps",defaults:[10]},turn:{only:SpriteMorph,type:"command",category:"motion",spec:"turn %clockwise %n degrees",defaults:[15]},turnLeft:{only:SpriteMorph,type:"command",category:"motion",spec:"turn %counterclockwise %n degrees",defaults:[15]},setHeading:{only:SpriteMorph,type:"command",category:"motion",spec:"point in direction %dir"},doFaceTowards:{only:SpriteMorph,type:"command",category:"motion",spec:"point towards %dst"},gotoXY:{only:SpriteMorph,type:"command",category:"motion",spec:"go to x: %n y: %n",defaults:[0,0]},doGotoObject:{only:SpriteMorph,type:"command",category:"motion",spec:"go to %dst"},doGlide:{only:SpriteMorph,type:"command",category:"motion",spec:"glide %n secs to x: %n y: %n",defaults:[1,0,0]},changeXPosition:{only:SpriteMorph,type:"command",category:"motion",spec:"change x by %n",defaults:[10]},setXPosition:{only:SpriteMorph,type:"command",category:"motion",spec:"set x to %n",defaults:[0]},changeYPosition:{only:SpriteMorph,type:"command",category:"motion",spec:"change y by %n",defaults:[10]},setYPosition:{only:SpriteMorph,type:"command",category:"motion",spec:"set y to %n",defaults:[0]},bounceOffEdge:{only:SpriteMorph,type:"command",category:"motion",spec:"if on edge, bounce"},xPosition:{only:SpriteMorph,type:"reporter",category:"motion",spec:"x position"},yPosition:{only:SpriteMorph,type:"reporter",category:"motion",spec:"y position"},direction:{only:SpriteMorph,type:"reporter",category:"motion",spec:"direction"},doSwitchToCostume:{type:"command",category:"looks",spec:"switch to costume %cst"},doWearNextCostume:{type:"command",category:"looks",spec:"next costume"},getCostumeIdx:{type:"reporter",category:"looks",spec:"costume #"},doSayFor:{only:SpriteMorph,type:"command",category:"looks",spec:"say %s for %n secs",defaults:[localize("Hello!"),2]},bubble:{only:SpriteMorph,type:"command",category:"looks",spec:"say %s",defaults:[localize("Hello!")]},doThinkFor:{only:SpriteMorph,type:"command",category:"looks",spec:"think %s for %n secs",defaults:[localize("Hmm..."),2]},doThink:{only:SpriteMorph,type:"command",category:"looks",spec:"think %s",defaults:[localize("Hmm...")]},changeEffect:{type:"command",category:"looks",spec:"change %eff effect by %n",defaults:[null,25]},setEffect:{type:"command",category:"looks",spec:"set %eff effect to %n",defaults:[null,0]},clearEffects:{type:"command",category:"looks",spec:"clear graphic effects"},changeScale:{only:SpriteMorph,type:"command",category:"looks",spec:"change size by %n",defaults:[10]},setScale:{only:SpriteMorph,type:"command",category:"looks",spec:"set size to %n %",defaults:[100]},getScale:{only:SpriteMorph,type:"reporter",category:"looks",spec:"size"},show:{only:SpriteMorph,type:"command",category:"looks",spec:"show"},hide:{only:SpriteMorph,type:"command",category:"looks",spec:"hide"},comeToFront:{only:SpriteMorph,type:"command",category:"looks",spec:"go to front"},goBack:{only:SpriteMorph,type:"command",category:"looks",spec:"go back %n layers",defaults:[1]},doScreenshot:{type:"command",category:"looks",spec:"save %imgsource as costume named %s",defaults:[["pen trails"],localize("screenshot")]},reportCostumes:{dev:!0,type:"reporter",category:"looks",spec:"wardrobe"},alert:{dev:!0,type:"command",category:"looks",spec:"alert %mult%s"},log:{dev:!0,type:"command",category:"looks",spec:"console log %mult%s"},playSound:{type:"command",category:"sound",spec:"play sound %snd"},doPlaySoundUntilDone:{type:"command",category:"sound",spec:"play sound %snd until done"},doStopAllSounds:{type:"command",category:"sound",spec:"stop all sounds"},doRest:{type:"command",category:"sound",spec:"rest for %n beats",defaults:[.2]},doPlayNote:{type:"command",category:"sound",spec:"play note %note for %n beats",defaults:[60,.5]},doSetInstrument:{type:"command",category:"sound",spec:"set instrument to %inst",defaults:[1]},doChangeTempo:{type:"command",category:"sound",spec:"change tempo by %n",defaults:[20]},doSetTempo:{type:"command",category:"sound",spec:"set tempo to %n bpm",defaults:[60]},getTempo:{type:"reporter",category:"sound",spec:"tempo"},reportSounds:{dev:!0,type:"reporter",category:"sound",spec:"jukebox"},clear:{type:"command",category:"pen",spec:"clear"},down:{only:SpriteMorph,type:"command",category:"pen",spec:"pen down"},up:{only:SpriteMorph,type:"command",category:"pen",spec:"pen up"},setColor:{only:SpriteMorph,type:"command",category:"pen",spec:"set pen color to %clr"},changeHue:{only:SpriteMorph,type:"command",category:"pen",spec:"change pen color by %n",defaults:[10]},setHue:{only:SpriteMorph,type:"command",category:"pen",spec:"set pen color to %n",defaults:[0]},changeBrightness:{only:SpriteMorph,type:"command",category:"pen",spec:"change pen shade by %n",defaults:[10]},setBrightness:{only:SpriteMorph,type:"command",category:"pen",spec:"set pen shade to %n",defaults:[100]},changeSize:{only:SpriteMorph,type:"command",category:"pen",spec:"change pen size by %n",defaults:[1]},setSize:{only:SpriteMorph,type:"command",category:"pen",spec:"set pen size to %n",defaults:[1]},doStamp:{only:SpriteMorph,type:"command",category:"pen",spec:"stamp"},floodFill:{only:SpriteMorph,type:"command",category:"pen",spec:"fill"},reportPenTrailsAsCostume:{type:"reporter",category:"pen",spec:"pen trails"},receiveGo:{type:"hat",category:"control",spec:"when %greenflag clicked"},receiveKey:{type:"hat",category:"control",spec:"when %keyHat key pressed"},receiveInteraction:{type:"hat",category:"control",spec:"when I am %interaction",defaults:["clicked"]},receiveMessage:{type:"hat",category:"control",spec:"when I receive %msgHat"},receiveCondition:{type:"hat",category:"control",spec:"when %b"},doBroadcast:{type:"command",category:"control",spec:"broadcast %msg"},doBroadcastAndWait:{type:"command",category:"control",spec:"broadcast %msg and wait"},getLastMessage:{type:"reporter",category:"control",spec:"message"},doWait:{type:"command",category:"control",spec:"wait %n secs",defaults:[1]},doWaitUntil:{type:"command",category:"control",spec:"wait until %b"},doForever:{type:"command",category:"control",spec:"forever %c"},doRepeat:{type:"command",category:"control",spec:"repeat %n %c",defaults:[10]},doUntil:{type:"command",category:"control",spec:"repeat until %b %c"},doIf:{type:"command",category:"control",spec:"if %b %c"},doIfElse:{type:"command",category:"control",spec:"if %b %c else %c"},doStopThis:{type:"command",category:"control",spec:"stop %stopChoices"},doRun:{type:"command",category:"control",spec:"run %cmdRing %inputs"},fork:{type:"command",category:"control",spec:"launch %cmdRing %inputs"},evaluate:{type:"reporter",category:"control",spec:"call %repRing %inputs"},doReport:{type:"command",category:"control",spec:"report %s"},doCallCC:{type:"command",category:"control",spec:"run %cmdRing w/continuation"},reportCallCC:{type:"reporter",category:"control",spec:"call %cmdRing w/continuation"},doWarp:{type:"command",category:"other",spec:"warp %c"},doTellTo:{dev:!0,type:"command",category:"control",spec:"tell %spr to %cmdRing %inputs"},reportAskFor:{dev:!0,type:"reporter",category:"control",spec:"ask %spr for %repRing %inputs"},receiveOnClone:{type:"hat",category:"control",spec:"when I start as a clone"},createClone:{type:"command",category:"control",spec:"create a clone of %cln"},newClone:{type:"reporter",category:"control",spec:"a new clone of %cln",defaults:[["myself"]]},removeClone:{type:"command",category:"control",spec:"delete this clone"},doPauseAll:{type:"command",category:"control",spec:"pause all %pause"},reportTouchingObject:{only:SpriteMorph,type:"predicate",category:"sensing",spec:"touching %col ?"},reportTouchingColor:{only:SpriteMorph,type:"predicate",category:"sensing",spec:"touching %clr ?"},reportColorIsTouchingColor:{only:SpriteMorph,type:"predicate",category:"sensing",spec:"color %clr is touching %clr ?"},colorFiltered:{dev:!0,type:"reporter",category:"sensing",spec:"filtered for %clr"},reportStackSize:{dev:!0,type:"reporter",category:"sensing",spec:"stack size"},reportFrameCount:{dev:!0,type:"reporter",category:"sensing",spec:"frames"},reportThreadCount:{dev:!0,type:"reporter",category:"sensing",spec:"processes"},doAsk:{type:"command",category:"sensing",spec:"ask %s and wait",defaults:[localize("what's your name?")]},reportLastAnswer:{dev:!0,type:"reporter",category:"sensing",spec:"answer"},getLastAnswer:{type:"reporter",category:"sensing",spec:"answer"},reportMouseX:{type:"reporter",category:"sensing",spec:"mouse x"},reportMouseY:{type:"reporter",category:"sensing",spec:"mouse y"},reportMouseDown:{type:"predicate",category:"sensing",spec:"mouse down?"},reportKeyPressed:{type:"predicate",category:"sensing",spec:"key %key pressed?"},reportDistanceTo:{type:"reporter",category:"sensing",spec:"distance to %dst"},doResetTimer:{type:"command",category:"sensing",spec:"reset timer"},reportTimer:{dev:!0,type:"reporter",category:"sensing",spec:"timer"},getTimer:{type:"reporter",category:"sensing",spec:"timer"},reportAttributeOf:{type:"reporter",category:"sensing",spec:"%att of %spr",defaults:[["costume #"]]},reportURL:{type:"reporter",category:"sensing",spec:"url %s",defaults:["snap.berkeley.edu"]},reportIsFastTracking:{type:"predicate",category:"sensing",spec:"turbo mode?"},doSetFastTracking:{type:"command",category:"sensing",spec:"set turbo mode to %b"},reportDate:{type:"reporter",category:"sensing",spec:"current %dates"},reportGet:{type:"reporter",category:"sensing",spec:"my %get",defaults:[["neighbors"]]},reifyScript:{type:"ring",category:"other",spec:"%rc %ringparms",alias:"command ring lambda"},reifyReporter:{type:"ring",category:"other",spec:"%rr %ringparms",alias:"reporter ring lambda"},reifyPredicate:{type:"ring",category:"other",spec:"%rp %ringparms",alias:"predicate ring lambda"},reportSum:{type:"reporter",category:"operators",spec:"%n + %n"},reportDifference:{type:"reporter",category:"operators",spec:"%n − %n",alias:"-"},reportProduct:{type:"reporter",category:"operators",spec:"%n × %n",alias:"*"},reportQuotient:{type:"reporter",category:"operators",spec:"%n / %n"},reportRound:{type:"reporter",category:"operators",spec:"round %n"},reportMonadic:{type:"reporter",category:"operators",spec:"%fun of %n",defaults:[null,10]},reportModulus:{type:"reporter",category:"operators",spec:"%n mod %n"},reportRandom:{type:"reporter",category:"operators",spec:"pick random %n to %n",defaults:[1,10]},reportLessThan:{type:"predicate",category:"operators",spec:"%s < %s"},reportEquals:{type:"predicate",category:"operators",spec:"%s = %s"},reportGreaterThan:{type:"predicate",category:"operators",spec:"%s > %s"},reportAnd:{type:"predicate",category:"operators",spec:"%b and %b"},reportOr:{type:"predicate",category:"operators",spec:"%b or %b"},reportNot:{type:"predicate",category:"operators",spec:"not %b"},reportBoolean:{type:"predicate",category:"operators",spec:"%bool",alias:"true boolean"},reportFalse:{type:"predicate",category:"operators",spec:"%bool",defaults:[!1],alias:"false boolean"},reportJoinWords:{type:"reporter",category:"operators",spec:"join %words",defaults:[localize("hello")+" ",localize("world")]},reportLetter:{type:"reporter",category:"operators",spec:"letter %n of %s",defaults:[1,localize("world")]},reportStringSize:{type:"reporter",category:"operators",spec:"length of %s",defaults:[localize("world")]},reportUnicode:{type:"reporter",category:"operators",spec:"unicode of %s",defaults:["a"]},reportUnicodeAsLetter:{type:"reporter",category:"operators",spec:"unicode %n as letter",defaults:[65]},reportIsA:{type:"predicate",category:"operators",spec:"is %s a %typ ?",defaults:[5]},reportIsIdentical:{type:"predicate",category:"operators",spec:"is %s identical to %s ?"},reportTextSplit:{type:"reporter",category:"operators",spec:"split %s by %delim",defaults:[localize("hello")+" "+localize("world")," "]},reportJSFunction:{type:"reporter",category:"operators",spec:"JavaScript function ( %mult%s ) { %code }"},reportTypeOf:{dev:!0,type:"reporter",category:"operators",spec:"type of %s",defaults:[5]},reportTextFunction:{dev:!0,type:"reporter",category:"operators",spec:"%txtfun of %s",defaults:[null,"Abelson & Sussman"]},doSetVar:{type:"command",category:"variables",spec:"set %var to %s",defaults:[null,0]},doChangeVar:{type:"command",category:"variables",spec:"change %var by %n",defaults:[null,1]},doShowVar:{type:"command",category:"variables",spec:"show variable %var"},doHideVar:{type:"command",category:"variables",spec:"hide variable %var"},doDeclareVariables:{type:"command",category:"other",spec:"script variables %scriptVars"},doDeleteAttr:{type:"command",category:"variables",spec:"inherit %shd"},reportNewList:{type:"reporter",category:"lists",spec:"list %exp"},reportCONS:{type:"reporter",category:"lists",spec:"%s in front of %l"},reportListItem:{type:"reporter",category:"lists",spec:"item %idx of %l",defaults:[1]},reportCDR:{type:"reporter",category:"lists",spec:"all but first of %l"},reportListLength:{type:"reporter",category:"lists",spec:"length of %l"},reportListContainsItem:{type:"predicate",category:"lists",spec:"%l contains %s",defaults:[null,localize("thing")]},doAddToList:{type:"command",category:"lists",spec:"add %s to %l",defaults:[localize("thing")]},doDeleteFromList:{type:"command",category:"lists",spec:"delete %ida of %l",defaults:[1]},doInsertInList:{type:"command",category:"lists",spec:"insert %s at %idx of %l",defaults:[localize("thing"),1]},doReplaceInList:{type:"command",category:"lists",spec:"replace item %idx of %l with %s",defaults:[1,null,localize("thing")]},reportMap:{dev:!0,type:"reporter",category:"lists",spec:"map %repRing over %l"},doForEach:{dev:!0,type:"command",category:"lists",spec:"for %upvar in %l %cl",defaults:[localize("each item")]},doShowTable:{dev:!0,type:"command",category:"lists",spec:"show table %l"},doMapCodeOrHeader:{type:"command",category:"other",spec:"map %cmdRing to %codeKind %code"},doMapValueCode:{type:"command",category:"other",spec:"map %mapValue to code %code",defaults:[["String"],"<#1>"]},doMapListCode:{type:"command",category:"other",spec:"map %codeListPart of %codeListKind to code %code"},reportMappedCode:{type:"reporter",category:"other",spec:"code of %cmdRing"}}},SpriteMorph.prototype.initBlocks(),SpriteMorph.prototype.initBlockMigrations=function(){SpriteMorph.prototype.blockMigrations={doStopAll:{selector:"doStopThis",inputs:[["all"]]},doStop:{selector:"doStopThis",inputs:[["this script"]]},doStopBlock:{selector:"doStopThis",inputs:[["this block"]]},doStopOthers:{selector:"doStopThis",inputs:[["all"]],offset:0},receiveClick:{selector:"receiveInteraction",inputs:[["clicked"]]},reportTrue:{selector:"reportBoolean",inputs:[!0]},reportFalse:{selector:"reportBoolean",inputs:[!1]},reportCostumes:{selector:"reportGet",inputs:[["costumes"]]},reportSounds:{selector:"reportGet",inputs:[["sounds"]]},doMapStringCode:{selector:"doMapValueCode",inputs:[["String"],"<#1>"],offset:1}}},SpriteMorph.prototype.initBlockMigrations(),SpriteMorph.prototype.blockAlternatives={turn:["turnLeft"],turnLeft:["turn"],changeXPosition:["changeYPosition","setXPosition","setYPosition"],setXPosition:["setYPosition","changeXPosition","changeYPosition"],changeYPosition:["changeXPosition","setYPosition","setXPosition"],setYPosition:["setXPosition","changeYPosition","changeXPosition"],xPosition:["yPosition"],yPosition:["xPosition"],doSayFor:["doThinkFor","bubble","doThink","doAsk"],doThinkFor:["doSayFor","doThink","bubble","doAsk"],bubble:["doThink","doAsk","doSayFor","doThinkFor"],doThink:["bubble","doAsk","doSayFor","doThinkFor"],show:["hide"],hide:["show"],changeEffect:["setEffect"],setEffect:["changeEffect"],changeScale:["setScale"],setScale:["changeScale"],playSound:["doPlaySoundUntilDone"],doPlaySoundUntilDone:["playSound"],doChangeTempo:["doSetTempo"],doSetTempo:["doChangeTempo"],clear:["down","up","doStamp"],down:["up","clear","doStamp"],up:["down","clear","doStamp"],doStamp:["clear","down","up"],changeHue:["setHue","changeBrightness","setBrightness"],setHue:["changeHue","changeBrightness","setBrightness"],changeBrightness:["setBrightness","setHue","changeHue"],setBrightness:["changeBrightness","setHue","changeHue"],changeSize:["setSize"],setSize:["changeSize"],doBroadcast:["doBroadcastAndWait"],doBroadcastAndWait:["doBroadcast"],doIf:["doIfElse","doUntil"],doIfElse:["doIf","doUntil"],doRepeat:["doUntil"],doUntil:["doRepeat","doIf"],doAsk:["bubble","doThink","doSayFor","doThinkFor"],getLastAnswer:["getTimer"],getTimer:["getLastAnswer"],reportMouseX:["reportMouseY"],reportMouseY:["reportMouseX"],reportSum:["reportDifference","reportProduct","reportQuotient"],reportDifference:["reportSum","reportProduct","reportQuotient"],reportProduct:["reportDifference","reportSum","reportQuotient"],reportQuotient:["reportDifference","reportProduct","reportSum"],reportLessThan:["reportEquals","reportGreaterThan"],reportEquals:["reportLessThan","reportGreaterThan"],reportGreaterThan:["reportEquals","reportLessThan"],reportAnd:["reportOr"],reportOr:["reportAnd"],doSetVar:["doChangeVar"],doChangeVar:["doSetVar"],doShowVar:["doHideVar"],doHideVar:["doShowVar"]},SpriteMorph.prototype.init=function(t){this.name=localize("Sprite"),this.instrument=null,this.variables=new VariableFrame(t||null,this),this.scripts=new ScriptsMorph,this.customBlocks=[],this.costumes=new List,this.costumes.type="costume",this.costume=null,this.sounds=new List,this.sounds.type="sound",this.normalExtent=new Point(60,60),this.scale=1,this.rotationStyle=1,this.version=Date.now(),this.isTemporary=!1,this.isCorpse=!1,this.cloneOriginName="",this.inheritedMethodsCache=[],this.parts=[],this.anchor=null,this.nestingScale=1,this.rotatesWithAnchor=!0,this.layers=null,this.blocksCache={},this.paletteCache={},this.rotationOffset=new Point,this.idx=0,this.wasWarped=!1,this.graphicsValues={color:0,fisheye:0,whirl:0,pixelate:0,mosaic:0,duplicate:0,negative:0,comic:0,confetti:0,saturation:0,brightness:0},this.exemplar=null,this.instances=[],this.cachedPropagation=!1,this.inheritedAttributes=[],SpriteMorph.uber.init.call(this),this.isDraggable=!0,this.isDown=!1,this.heading=90,this.changed(),this.drawNew(),this.changed()},SpriteMorph.prototype.fullCopy=function(t){var e,o,i=SpriteMorph.uber.fullCopy.call(this),r=this,n=[];i.instances=[],i.stopTalking(),i.color=this.color.copy(),i.blocksCache={},i.paletteCache={},n=[],this.inheritedAttributes.forEach(function(t){n.push(t)}),i.inheritedAttributes=n,t?(i.exemplar=this,i.customBlocks=[],i.variables=new VariableFrame(null,i),i.variables.parentFrame=this.variables,i.inheritedVariableNames().forEach(function(t){i.shadowVar(t,i.variables.getVar(t))}),this.addSpecimen(i),this.cachedPropagation=!1,["scripts","costumes","sounds"].forEach(function(t){contains(i.inheritedAttributes,t)||i.inheritedAttributes.push(t)})):(i.variables=this.variables.copy(),i.variables.owner=i,i.scripts=this.scripts.fullCopy(),i.customBlocks=[],this.customBlocks.forEach(function(t){e=t.copyAndBindTo(i),i.customBlocks.push(e),i.allBlockInstances(t).forEach(function(t){t.definition=e})}),n=[],this.costumes.asArray().forEach(function(e){var o=t?e:e.copy();n.push(o),e===r.costume&&(i.costume=o)}),i.costumes=new List(n),n=[],this.sounds.asArray().forEach(function(e){var o=t?e:e.copy();n.push(o)}),i.sounds=new List(n),n=[]),i.nestingScale=1,i.rotatesWithAnchor=!0,i.anchor=null,i.parts=[],this.parts.forEach(function(e){var o=e.fullCopy(t);o.nestingScale=e.nestingScale,o.rotatesWithAnchor=e.rotatesWithAnchor,i.attachPart(o)}),i.graphicsValues={};for(o in this.graphicsValues)this.graphicsValues.hasOwnProperty(o)&&(i.graphicsValues[o]=this.graphicsValues[o]);return i},SpriteMorph.prototype.appearIn=function(t){this.isTemporary||(this.name=t.newSpriteName(this.name),t.corral.addSprite(this),t.sprites.add(this)),t.stage.add(this),this.parts.forEach(function(e){e.appearIn(t)})},SpriteMorph.prototype.setName=function(t){this.name=t||this.name,this.version=Date.now()},SpriteMorph.prototype.drawNew=function(){var t,e,o,i,r,n,s,a,h,l,p,c,d,u,g=this,f=[];if(this.isWarped)this.wantsRedraw=!0;else{if(t=this.center(),i=this.costume&&"function"==typeof this.costume.loaded,s=this.parent instanceof StageMorph?this.parent.scale:1,e=this.rotationStyle?this.heading:90,2===this.rotationStyle&&(e=90,(this.heading>180&&this.heading<360||this.heading<0&&this.heading>-180)&&(o=!0)),this.costume&&!i)f=(n=o?this.costume.flipped():this.costume).bounds().corners().map(function(t){return t.rotateBy(radians(e-90),g.costume.center())}),h=f[0],p=f[0],f.forEach(function(t){h=h.min(t),p=p.max(t)}),c=h.corner(p).extent().multiplyBy(this.scale*s),l=new Point(0,0).rotateBy(radians(-(e-90)),n.center()).subtract(h),this.image=newCanvas(c,!0),this.silentSetExtent(c),(d=this.image.getContext("2d")).scale(this.scale*s,this.scale*s),d.translate(l.x,l.y),d.rotate(radians(e-90)),d.drawImage(n.contents,0,0),this.image=this.applyGraphicsEffects(this.image),this.setCenter(t,!0),this.rotationOffset=l.translateBy(n.rotationCenter).rotateBy(radians(-(e-90)),l).scaleBy(this.scale*s);else if(e=o?-90:e,a=Math.min(Math.max(this.normalExtent.x*this.scale*s,5),1e3),this.silentSetExtent(new Point(a,a)),this.image=newCanvas(this.extent(),!0),this.setCenter(t,!0),SpriteMorph.uber.drawNew.call(this,e),this.rotationOffset=this.extent().divideBy(2),this.image=this.applyGraphicsEffects(this.image),i)return r=this.costume,u=setInterval(function(){g.wearCostume(r),clearInterval(u)},100),g.wearCostume(null);this.version=Date.now()}},SpriteMorph.prototype.endWarp=function(){if(this.isWarped=!1,this.wantsRedraw){var t=this.xPosition(),e=this.yPosition();this.drawNew(),this.silentGotoXY(t,e,!0),this.wantsRedraw=!1}this.parent.changed()},SpriteMorph.prototype.rotationCenter=function(){return this.position().add(this.rotationOffset)},SpriteMorph.prototype.colorFiltered=function(t){var e,o,i,r,n=new Morph,s=this.extent();for(o=normalizeCanvas(this.image,!0).getContext("2d").getImageData(0,0,s.x,s.y),n.image=newCanvas(s,!0),n.bounds=this.bounds.copy(),r=(e=n.image.getContext("2d")).createImageData(s.x,s.y),i=0;i<s.x*s.y*4;i+=4)new Color(o.data[i],o.data[i+1],o.data[i+2]).eq(t)&&(r.data[i]=o.data[i],r.data[i+1]=o.data[i+1],r.data[i+2]=o.data[i+2],r.data[i+3]=255);return e.putImageData(r,0,0),n},SpriteMorph.prototype.blockForSelector=function(t,e){var o,i,r,n,s,a;if(o=this.blockMigrations[t],!(i=this.blocks[o?o.selector:t]))return null;if(r="command"===i.type?new CommandBlockMorph:"hat"===i.type?new HatBlockMorph:"ring"===i.type?new RingMorph:new ReporterBlockMorph("predicate"===i.type),r.color=this.blockColor[i.category],r.category=i.category,r.selector=o?o.selector:t,contains(["reifyReporter","reifyPredicate"],r.selector)&&(r.isStatic=!0),r.setSpec(localize(i.spec)),e&&i.defaults||o&&o.inputs)if(n=o?o.inputs:i.defaults,r.defaults=n,(s=r.inputs())[0]instanceof MultiArgMorph)s[0].setContents(n),s[0].defaults=n;else for(a=0;a<n.length;a+=1)null!==n[a]&&s[a].setContents(n[a]);return r},SpriteMorph.prototype.variableBlock=function(t){var e=new ReporterBlockMorph(!1);return e.selector="reportGetVar",e.color=this.blockColor.variables,e.category="variables",e.setSpec(t),e.isDraggable=!0,e},SpriteMorph.prototype.blockTemplates=function(t){function e(t,e){if(StageMorph.prototype.hiddenPrimitives[t])return null;var o=SpriteMorph.prototype.blockForSelector(t,!0);return o.isTemplate=!0,e&&o.ghost(),o}function o(t){var e=SpriteMorph.prototype.variableBlock(t);return e.isDraggable=!1,e.isTemplate=!0,contains(u,t)&&e.ghost(),e}function i(t){if(StageMorph.prototype.hiddenPrimitives[t])return null;var e=SpriteMorph.prototype.blocks[t];return new ToggleMorph("checkbox",this,function(){c.toggleWatcher(t,localize(e.spec),c.blockColor[e.category])},null,function(){return c.showingWatcher(t)},null)}function r(t){return new ToggleMorph("checkbox",this,function(){c.toggleVariableWatcher(t)},null,function(){return c.showingVariableWatcher(t)},null)}function n(){var t=new MenuMorph(this);return t.addItem("help...","showHelp"),t}function s(t){var e;t&&(c.isVariableNameInUse(t[0],t[1])?c.inform("that name is already in use"):(e=c.parentThatIsA(IDE_Morph),c.addVariable(t[0],t[1]),c.showingVariableWatcher(t[0])||c.toggleVariableWatcher(t[0],t[1]),e.flushBlocksCache("variables"),e.refreshPalette()))}var a,h,l,p=[],c=this,d=t||"motion",u=this.inheritedVariableNames();return"motion"===d?(p.push(e("forward")),p.push(e("turn")),p.push(e("turnLeft")),p.push("-"),p.push(e("setHeading")),p.push(e("doFaceTowards")),p.push("-"),p.push(e("gotoXY")),p.push(e("doGotoObject")),p.push(e("doGlide")),p.push("-"),p.push(e("changeXPosition")),p.push(e("setXPosition")),p.push(e("changeYPosition")),p.push(e("setYPosition")),p.push("-"),p.push(e("bounceOffEdge")),p.push("-"),p.push(i("xPosition")),p.push(e("xPosition",this.inheritsAttribute("x position"))),p.push(i("yPosition")),p.push(e("yPosition",this.inheritsAttribute("y position"))),p.push(i("direction")),p.push(e("direction",this.inheritsAttribute("direction"))),p.push("="),p.push(this.makeBlockButton(d))):"looks"===d?(p.push(e("doSwitchToCostume")),p.push(e("doWearNextCostume")),p.push(i("getCostumeIdx")),p.push(e("getCostumeIdx",this.inheritsAttribute("costume #"))),p.push("-"),p.push(e("doSayFor")),p.push(e("bubble")),p.push(e("doThinkFor")),p.push(e("doThink")),p.push("-"),p.push(e("changeEffect")),p.push(e("setEffect")),p.push(e("clearEffects")),p.push("-"),p.push(e("changeScale")),p.push(e("setScale")),p.push(i("getScale")),p.push(e("getScale",this.inheritsAttribute("size"))),p.push("-"),p.push(e("show")),p.push(e("hide")),p.push("-"),p.push(e("comeToFront")),p.push(e("goBack")),this.world().isDevMode&&(p.push("-"),(l=new TextMorph(localize("development mode \ndebugging primitives:"))).fontSize=9,l.setColor(this.paletteTextColor),p.push(l),p.push("-"),p.push(e("log")),p.push(e("alert")),p.push("-"),p.push(e("doScreenshot"))),p.push("="),p.push(this.makeBlockButton(d))):"sound"===d?(p.push(e("playSound")),p.push(e("doPlaySoundUntilDone")),p.push(e("doStopAllSounds")),p.push("-"),p.push(e("doRest")),p.push(e("doPlayNote")),p.push(e("doSetInstrument")),p.push("-"),p.push(e("doChangeTempo")),p.push(e("doSetTempo")),p.push(i("getTempo")),p.push(e("getTempo")),p.push("="),p.push(this.makeBlockButton(d))):"pen"===d?(p.push(e("clear")),p.push("-"),p.push(e("down")),p.push(e("up")),p.push("-"),p.push(e("setColor")),p.push(e("changeHue")),p.push(e("setHue")),p.push("-"),p.push(e("changeBrightness")),p.push(e("setBrightness")),p.push("-"),p.push(e("changeSize")),p.push(e("setSize")),p.push("-"),p.push(e("doStamp")),p.push(e("floodFill")),p.push("-"),p.push(e("reportPenTrailsAsCostume")),p.push("="),p.push(this.makeBlockButton(d))):"control"===d?(p.push(e("receiveGo")),p.push(e("receiveKey")),p.push(e("receiveInteraction")),p.push(e("receiveCondition")),p.push(e("receiveMessage")),p.push("-"),p.push(e("doBroadcast")),p.push(e("doBroadcastAndWait")),p.push(i("getLastMessage")),p.push(e("getLastMessage")),p.push("-"),p.push(e("doWarp")),p.push("-"),p.push(e("doWait")),p.push(e("doWaitUntil")),p.push("-"),p.push(e("doForever")),p.push(e("doRepeat")),p.push(e("doUntil")),p.push("-"),p.push(e("doIf")),p.push(e("doIfElse")),p.push("-"),p.push(e("doReport")),p.push(e("doStopThis")),p.push("-"),p.push(e("doRun")),p.push(e("fork")),p.push(e("evaluate")),p.push("-"),p.push(e("doTellTo")),p.push(e("reportAskFor")),p.push("-"),p.push(e("doCallCC")),p.push(e("reportCallCC")),p.push("-"),p.push(e("receiveOnClone")),p.push(e("createClone")),p.push(e("newClone")),p.push(e("removeClone")),p.push("-"),p.push(e("doPauseAll")),p.push("="),p.push(this.makeBlockButton(d))):"sensing"===d?(p.push(e("reportTouchingObject")),p.push(e("reportTouchingColor")),p.push(e("reportColorIsTouchingColor")),p.push("-"),p.push(e("doAsk")),p.push(i("getLastAnswer")),p.push(e("getLastAnswer")),p.push("-"),p.push(i("reportMouseX")),p.push(e("reportMouseX")),p.push(i("reportMouseY")),p.push(e("reportMouseY")),p.push(e("reportMouseDown")),p.push("-"),p.push(e("reportKeyPressed")),p.push("-"),p.push(e("reportDistanceTo")),p.push("-"),p.push(e("doResetTimer")),p.push(i("getTimer")),p.push(e("getTimer")),p.push("-"),p.push(e("reportAttributeOf")),SpriteMorph.prototype.enableFirstClass&&p.push(e("reportGet")),p.push("-"),p.push(e("reportURL")),p.push("-"),p.push(e("reportIsFastTracking")),p.push(e("doSetFastTracking")),p.push("-"),p.push(e("reportDate")),this.world().isDevMode&&(p.push("-"),(l=new TextMorph(localize("development mode \ndebugging primitives:"))).fontSize=9,l.setColor(this.paletteTextColor),p.push(l),p.push("-"),p.push(i("reportThreadCount")),p.push(e("reportThreadCount")),p.push(e("colorFiltered")),p.push(e("reportStackSize")),p.push(e("reportFrameCount"))),p.push("="),p.push(this.makeBlockButton(d))):"operators"===d?(p.push(e("reifyScript")),p.push(e("reifyReporter")),p.push(e("reifyPredicate")),p.push("#"),p.push("-"),p.push(e("reportSum")),p.push(e("reportDifference")),p.push(e("reportProduct")),p.push(e("reportQuotient")),p.push("-"),p.push(e("reportModulus")),p.push(e("reportRound")),p.push(e("reportMonadic")),p.push(e("reportRandom")),p.push("-"),p.push(e("reportLessThan")),p.push(e("reportEquals")),p.push(e("reportGreaterThan")),p.push("-"),p.push(e("reportAnd")),p.push(e("reportOr")),p.push(e("reportNot")),p.push(e("reportBoolean")),p.push("-"),p.push(e("reportJoinWords")),p.push(e("reportTextSplit")),p.push(e("reportLetter")),p.push(e("reportStringSize")),p.push("-"),p.push(e("reportUnicode")),p.push(e("reportUnicodeAsLetter")),p.push("-"),p.push(e("reportIsA")),p.push(e("reportIsIdentical")),p.push("-"),p.push(e("reportJSFunction")),this.world().isDevMode&&(p.push("-"),(l=new TextMorph(localize("development mode \ndebugging primitives:"))).fontSize=9,l.setColor(this.paletteTextColor),p.push(l),p.push("-"),p.push(e("reportTypeOf")),p.push(e("reportTextFunction"))),p.push("="),p.push(this.makeBlockButton(d))):"variables"===d&&((h=new PushButtonMorph(null,function(){new VariableDialogMorph(null,s,c).prompt("Variable name",null,c.world())},"Make a variable")).userMenu=n,h.selector="addVariable",h.showHelp=BlockMorph.prototype.showHelp,p.push(h),this.deletableVariableNames().length>0&&((h=new PushButtonMorph(null,function(){var t=new MenuMorph(c.deleteVariable,null,c);c.deletableVariableNames().forEach(function(e){t.addItem(e,e)}),t.popUpAtHand(c.world())},"Delete a variable")).userMenu=n,h.selector="deleteVariable",h.showHelp=BlockMorph.prototype.showHelp,p.push(h)),p.push("-"),(a=this.variables.allNames()).length>0&&(a.forEach(function(t){p.push(r(t)),p.push(o(t))}),p.push("-")),p.push(e("doSetVar")),p.push(e("doChangeVar")),p.push(e("doShowVar")),p.push(e("doHideVar")),p.push(e("doDeclareVariables")),StageMorph.prototype.enableInheritance&&(p.push("-"),p.push(e("doDeleteAttr"))),p.push("="),p.push(e("reportNewList")),p.push("-"),p.push(e("reportCONS")),p.push(e("reportListItem")),p.push(e("reportCDR")),p.push("-"),p.push(e("reportListLength")),p.push(e("reportListContainsItem")),p.push("-"),p.push(e("doAddToList")),p.push(e("doDeleteFromList")),p.push(e("doInsertInList")),p.push(e("doReplaceInList")),this.world().isDevMode&&(p.push("-"),(l=new TextMorph(localize("development mode \ndebugging primitives:"))).fontSize=9,l.setColor(this.paletteTextColor),p.push(l),p.push("-"),p.push(e("reportMap")),p.push("-"),p.push(e("doForEach")),p.push(e("doShowTable"))),p.push("="),StageMorph.prototype.enableCodeMapping&&(p.push(e("doMapCodeOrHeader")),p.push(e("doMapValueCode")),p.push(e("doMapListCode")),p.push("-"),p.push(e("reportMappedCode")),p.push("=")),p.push(this.makeBlockButton())),p},SpriteMorph.prototype.makeBlockButton=function(t){var e=new PushButtonMorph(this,"makeBlock","Make a block");return e.userMenu=function(){var t=new MenuMorph(this);return t.addItem("help...","showHelp"),t},e.selector="addCustomBlock",e.showHelp=BlockMorph.prototype.showHelp,e},SpriteMorph.prototype.makeBlock=function(){var t,e=this.parentThatIsA(IDE_Morph),o=this.parentThatIsA(StageMorph),i=e.currentCategory,r=SpriteMorph.prototype.blockColor[i],n=this;t=new BlockDialogMorph(null,function(t){""!==t.spec&&(t.isGlobal?o.globalBlocks.push(t):n.customBlocks.push(t),e.flushPaletteCache(),e.refreshPalette(),new BlockEditorMorph(t,n).popUp())},n),"variables"!==i&&(t.category=i,t.categories.children.forEach(function(t){t.refresh()}),t.types.children.forEach(function(t){t.setColor(r),t.refresh()})),t.prompt("Make a block",null,n.world())},SpriteMorph.prototype.palette=function(t){return this.paletteCache[t]||(this.paletteCache[t]=this.freshPalette(t)),this.paletteCache[t]},SpriteMorph.prototype.freshPalette=function(t){var e,o,i,r=new ScrollFrameMorph(null,null,this.sliderColor),n=SyntaxElementMorph.prototype.fontSize,s=0,a=5,h=0,l=!1,p=this,c=this.parentThatIsA(StageMorph),d=Morph.prototype.trackChanges,u=new Color(140,140,140);return Morph.prototype.trackChanges=!1,r.owner=this,r.padding=n/2,r.color=this.paletteColor,r.growth=new Point(0,MorphicPreferences.scrollBarSize),r.toolBar=new AlignmentMorph("column"),o=new PushButtonMorph(this,"searchBlocks",new SymbolMorph("magnifierOutline",16)),o.alpha=.2,o.padding=1,o.hint=localize("find blocks")+"...",o.labelShadowColor=u,o.drawNew(),o.fixLayout(),r.toolBar.add(o),i=new PushButtonMorph(this,"makeBlock",new SymbolMorph("cross",16)),i.alpha=.2,i.padding=1,i.hint=localize("Make a block")+"...",i.labelShadowColor=u,i.drawNew(),i.fixLayout(),r.toolBar.add(i),r.toolBar.fixLayout(),r.add(r.toolBar),r.userMenu=function(){var e=new MenuMorph,o=this.parentThatIsA(IDE_Morph),i={operators:["reifyScript","reifyReporter","reifyPredicate"],control:["doWarp"],variables:["doDeclareVariables","reportNewList","reportCONS","reportListItem","reportCDR","reportListLength","reportListContainsItem","doAddToList","doDeleteFromList","doInsertInList","doReplaceInList"]};return e.addPair([new SymbolMorph("magnifyingGlass",MorphicPreferences.menuFontSize),localize("find blocks")+"..."],function(){p.searchBlocks()},"^F"),r.contents.children.some(function(t){return contains(Object.keys(SpriteMorph.prototype.blocks),t.selector)})&&e.addItem("hide primitives",function(){var e=SpriteMorph.prototype.blocks;Object.keys(e).forEach(function(o){e[o].category===t&&(StageMorph.prototype.hiddenPrimitives[o]=!0)}),(i[t]||[]).forEach(function(t){StageMorph.prototype.hiddenPrimitives[t]=!0}),o.flushBlocksCache(t),o.refreshPalette()}),function(){var e=SpriteMorph.prototype.blocks,o=StageMorph.prototype.hiddenPrimitives;return Object.keys(o).some(function(o){return!isNil(e[o])&&(e[o].category===t||contains(i[t]||[],o))})}()&&e.addItem("show primitives",function(){var e=StageMorph.prototype.hiddenPrimitives,r=SpriteMorph.prototype.blocks;Object.keys(e).forEach(function(e){r[e]&&r[e].category===t&&delete StageMorph.prototype.hiddenPrimitives[e]}),(i[t]||[]).forEach(function(t){delete StageMorph.prototype.hiddenPrimitives[t]}),o.flushBlocksCache(t),o.refreshPalette()}),e},(e=this.blocksCache[t])||(e=this.blockTemplates(t),this.isCachingPrimitives&&(this.blocksCache[t]=e)),e.forEach(function(t){if(null!==t)if("-"===t){if(l)return;a+=.8*n,l=!0}else if("="===t){if(l)return;a+=1.6*n,l=!0}else"#"===t?(s=0,a=h):(l=!1,0===s&&(a+=.3*n),t.setPosition(new Point(s,a)),r.addContents(t),t instanceof ToggleMorph||t instanceof RingMorph?(s=t.right()+n/2,h=t.bottom()):(s=0,a+=t.height()))}),c&&(a+=1.6*n,c.globalBlocks.forEach(function(e){var o;(e.category===t||"variables"===t&&contains(["lists","other"],e.category))&&(o=e.templateInstance(),a+=.3*n,o.setPosition(new Point(s,a)),r.addContents(o),s=0,a+=o.height())})),a+=1.6*n,this.customBlocks.forEach(function(e){var o;(e.category===t||"variables"===t&&contains(["lists","other"],e.category))&&(o=e.templateInstance(),a+=.3*n,o.setPosition(new Point(s,a)),r.addContents(o),s=0,a+=o.height())}),this.exemplar&&this.inheritedBlocks(!0).forEach(function(e){var o;(e.category===t||"variables"===t&&contains(["lists","other"],e.category))&&(o=e.templateInstance(),a+=.3*n,o.setPosition(new Point(s,a)),r.addContents(o),o.ghost(),s=0,a+=o.height())}),r.scrollX(r.padding),r.scrollY(r.padding),Morph.prototype.trackChanges=d,r},SpriteMorph.prototype.blocksMatching=function(t,e,o,i){function r(t){return BlockMorph.prototype.parseSpec(t).filter(function(t){return 0!==t.indexOf("%")}).join(" ")}function n(t,e,o){for(var i=String(t);i.length<e;)i=o+i;return i}function s(t,o){var i,r=" "+t,s=r.indexOf(o);return-1===s?-1:(i=" "===r.charAt(s-1),e&&!i?-1:(i?"1":"2")+n(s,4,"0"))}function a(t){var e=SpriteMorph.prototype.blockForSelector(t,!0);return e.isTemplate=!0,e}var h,l,p=[],c=this,d=t.toLowerCase(),u=this.parentThatIsA(StageMorph);return o&&o.length||(o=["hat","command","reporter","predicate","ring"]),i||(i=[]),i.forEach(function(t){var e=s(r(t.toLowerCase()),d);-1!==e&&p.push([c.variableBlock(t),e+"1"])}),[this.customBlocks,u.globalBlocks].forEach(function(t){t.forEach(function(t){if(contains(o,t.type)){var e=s(r(localize(t.blockSpec()).toLowerCase()),d);-1!==e&&p.push([t.templateInstance(),e+"2"])}})}),h=SpriteMorph.prototype.blocks,Object.keys(h).forEach(function(t){if(!StageMorph.prototype.hiddenPrimitives[t]&&contains(o,h[t].type)){var e=h[t],i=s(r(localize(e.alias||e.spec).toLowerCase()),d);-1===i||e.dev||e.only&&e.only!==c.constructor||p.push([a(t),i+"3"])}}),contains(o,"reporter")&&(l=this.reporterize(t))&&p.push([l,""]),p.sort(function(t,e){return t[1]<e[1]?-1:1}),p.map(function(t){return t[0]})},SpriteMorph.prototype.searchBlocks=function(t,e,o,i){function r(){a&&a.destroy(),s&&i&&(a=s.outline(MorphicPreferences.isFlat?new Color(150,200,255):new Color(255,255,255),2),u.contents.add(a),a.scrollIntoView())}function n(t){var e=Morph.prototype.trackChanges,o=u.contents.left()+5,n=d.bottom()+l;g=t,s=null,t.length&&i&&(s=t[0]),Morph.prototype.trackChanges=!1,u.contents.children=[u.contents.children[0]],t.forEach(function(t){t.setPosition(new Point(o,n)),u.addContents(t),n+=t.height(),n+=.3*l}),Morph.prototype.trackChanges=e,r(),u.changed()}var s,a,h=this,l=SyntaxElementMorph.prototype.fontSize,p=this.parentThatIsA(IDE_Morph),c="",d=new InputFieldMorph(t||""),u=p.createPalette("forSearch"),g=[];u.owner=this,u.color=h.paletteColor,u.contents.color=h.paletteColor,u.addContents(d),d.drawNew(),d.setWidth(p.logo.width()-30),d.contrast=90,d.setPosition(u.contents.topLeft().add(new Point(10,10))),d.drawNew(),u.accept=function(){var t;i?(d.cancel(),s&&i.insertBlock(s)):(t=d.getValue()).length>0&&n(h.blocksMatching(t))},u.reactToKeystroke=function(t){var a,l;switch(t?t.keyCode:0){case 38:if(!i||!s)return;return(l=g.indexOf(s)-1)<0&&(l=g.length-1),s=g[l],void r();case 40:if(!i||!s)return;return(l=g.indexOf(s)+1)>=g.length&&(l=0),s=g[l],void r();default:(a=d.getValue())!==c&&(c=a,n(h.blocksMatching(a,a.length<2,e,o)))}},d.cancel=function(){p.refreshPalette(),p.palette.adjustScrollBars()},p.fixLayout("refreshPalette"),d.edit(),t&&u.reactToKeystroke()},SpriteMorph.prototype.reporterize=function(t){function e(t,o,i){function r(t){return t instanceof Array||isNaN(+t)?t:+t}function n(){for(var e=1,o="";h<t.length;){switch(s=t[h],h+=1,s){case"(":e+=1;break;case")":if(!(e-=1))return o}o+=s}}for(var s,a=["",""],h=0;h<t.length;)switch(s=t[h],h+=1,s){case" ":break;case"(":a[o?1:0].length?a[o?1:0]=[a[o?1:0],e(n())]:a[o?1:0]=e(n());break;case"-":case"+":case"*":case"/":case"%":case"=":case"<":case">":case"&":case"|":if(o||a[0].length)if(o){if(a[1].length)return e(t.slice(h),s,[o,i,r(a[1])]);a[1]=s}else o=s,i=r(a[0]);else a[0]=s;break;default:a[o?1:0]+=s}return o?[o,i,r(a[1])]:r(a[0])}function o(t){var e,i,r,n,s,a,h,l,p=1,c={};for(i={"+":"reportSum","-":"reportDifference","*":"reportProduct","/":"reportQuotient","%":"reportModulus","=":"reportEquals","<":"reportLessThan",">":"reportGreaterThan","&":"reportAnd","|":"reportOr",round:"reportRound",not:"reportNot"},n={ceil:"ceiling","!":"not"},(r=["abs","ceiling","floor","sqrt","sin","cos","tan","asin","acos","atan","ln","log","round","not"]).concat(["true","false"]).forEach(function(t){c[localize(t).toLowerCase()]=t}),contains(r,s=n[t[0]]||c[t[0].toLowerCase()]||t[0])?(a=i[s])?l=(e=SpriteMorph.prototype.blockForSelector(a)).inputs():((l=(e=SpriteMorph.prototype.blockForSelector("reportMonadic")).inputs())[0].setContents([s]),p=0):l=(e=SpriteMorph.prototype.blockForSelector(i[s])).inputs(),h=1;h<t.length;h+=1)t[h]instanceof Array?e.silentReplaceInput(l[h-p],o(t[h])):isString(t[h])?contains(["true","false"],c[t[h]]||t[h])?e.silentReplaceInput(l[h-p],SpriteMorph.prototype.blockForSelector("true"===(c[t[h]]||t[h])?"reportTrue":"reportFalse")):"_"!==t[h]&&e.silentReplaceInput(l[h-p],SpriteMorph.prototype.variableBlock(t[h])):l[h-p].setContents(t[h]);return e.isDraggable=!0,e.fixLayout(),e.fixBlockColor(null,!0),e}var i;if(t.length>100)return null;try{return i=e(t),i instanceof Array?o(i):null}catch(t){return null}},SpriteMorph.prototype.addVariable=function(t,e){var o=this.parentThatIsA(IDE_Morph);e?(this.globalVariables().addVar(t),o&&o.flushBlocksCache("variables")):(this.variables.addVar(t),this.blocksCache.variables=null)},SpriteMorph.prototype.deleteVariable=function(t){var e=this.parentThatIsA(IDE_Morph);contains(this.inheritedVariableNames(!0),t)||this.deleteVariableWatcher(t),this.variables.deleteVar(t),e&&(e.flushBlocksCache("variables"),e.refreshPalette())},SpriteMorph.prototype.addCostume=function(t){t.name||(t.name="costume"+(this.costumes.length()+1)),this.shadowAttribute("costumes"),this.costumes.add(t)},SpriteMorph.prototype.wearCostume=function(t,e){var o=this.xPosition?this.xPosition():null,i=this.yPosition?this.yPosition():null,r=isNil(t)?null:this.costumes.asArray().indexOf(t),n=this.isWarped;n&&this.endWarp(),this.changed(),this.costume=t,this.drawNew(),this.changed(),n&&this.startWarp(),null!==o&&this.silentGotoXY(o,i,!0),this.positionTalkBubble&&this.positionTalkBubble(),this.version=Date.now(),e||this.shadowAttribute("costume #"),this.specimens().forEach(function(e){e.cachedPropagation&&e.inheritsAttribute("costume #")&&(null===r?e.wearCostume(null,!0):-1===r?e.wearCostume(t,!0):e.doSwitchToCostume(r+1,!0))})},SpriteMorph.prototype.getCostumeIdx=function(){return this.inheritsAttribute("costume #")?this.exemplar.getCostumeIdx():this.costumes.asArray().indexOf(this.costume)+1},SpriteMorph.prototype.doWearNextCostume=function(){var t,e=this.costumes.asArray();e.length>1&&(t=e.indexOf(this.costume))>-1&&((t+=1)>e.length-1&&(t=0),this.wearCostume(e[t]))},SpriteMorph.prototype.doWearPreviousCostume=function(){var t,e=this.costumes.asArray();e.length>1&&(t=e.indexOf(this.costume))>-1&&((t-=1)<0&&(t=e.length-1),this.wearCostume(e[t]))},SpriteMorph.prototype.doSwitchToCostume=function(t,e){if(t instanceof Costume)this.wearCostume(t,e);else{var o,i,r=this.costumes.asArray();if(contains([localize("Turtle"),localize("Empty")],t instanceof Array?t[0]:null))i=null;else{if(-1===t)return void this.doWearPreviousCostume();null===(i=detect(r,function(e){return e.name===t}))&&(i=0===(o=parseFloat(t))?null:r[o-1]||null)}this.wearCostume(i,e)}},SpriteMorph.prototype.reportCostumes=function(){return this.costumes},SpriteMorph.prototype.addSound=function(t,e){this.shadowAttribute("sounds"),this.sounds.add(new Sound(t,e))},SpriteMorph.prototype.playSound=function(t){var e,o=this.parentThatIsA(StageMorph),i=t instanceof Sound?t:detect(this.sounds.asArray(),function(e){return e.name===t});if(i)return e=i.play(),o&&(o.activeSounds.push(e),o.activeSounds=o.activeSounds.filter(function(t){return!t.ended&&!t.terminated})),e},SpriteMorph.prototype.reportSounds=function(){return this.sounds},SpriteMorph.prototype.userMenu=function(){var t=this.parentThatIsA(IDE_Morph),e=new MenuMorph(this);return t&&t.isAppMode?e:(this.isTemporary||(e.addItem("duplicate","duplicate"),StageMorph.prototype.enableInheritance&&(e.addItem("clone","instantiate"),e.addLine())),e.addItem("delete","remove"),e.addItem("move","moveCenter"),this.costume&&e.addItem("pivot","moveRotationCenter","edit the costume's\nrotation center"),this.isTemporary?StageMorph.prototype.enableInheritance&&e.addItem("edit","perpetuateAndEdit","make permanent and\nshow in the sprite corral"):e.addItem("edit","edit"),e.addLine(),this.anchor&&e.addItem(localize("detach from")+" "+this.anchor.name,"detachFromAnchor"),this.parts.length&&e.addItem("detach all parts","detachAllParts"),e.addItem("export...","exportSprite"),e)},SpriteMorph.prototype.exportSprite=function(){if(!this.isTemporary){var t=this.parentThatIsA(IDE_Morph);t&&t.exportSprite(this)}},SpriteMorph.prototype.edit=function(){var t=this.parentThatIsA(IDE_Morph);t&&!t.isAppMode&&t.selectSprite(this)},SpriteMorph.prototype.showOnStage=function(){var t=this.parentThatIsA(StageMorph);t&&(this.keepWithin(t),t.add(this)),this.show()},SpriteMorph.prototype.duplicate=function(){var t=this.parentThatIsA(IDE_Morph);t&&t.duplicateSprite(this)},SpriteMorph.prototype.instantiate=function(){var t=this.parentThatIsA(IDE_Morph);t&&t.instantiateSprite(this)},SpriteMorph.prototype.remove=function(){var t=this.parentThatIsA(IDE_Morph);t&&t.removeSprite(this)},SpriteMorph.prototype.createClone=function(t){var e,o=this.parentThatIsA(StageMorph);return o&&o.cloneCount<=5e3&&(e=this.fullCopy(!0)).clonify(o,t),e},SpriteMorph.prototype.newClone=function(t){var e=this.createClone(t);if(isNil(e))throw new Error("exceeding maximum number of clones");return e},SpriteMorph.prototype.clonify=function(t,e){var o=this;this.parts.forEach(function(e){e.clonify(t)}),t.cloneCount+=1,this.cloneOriginName=this.isTemporary?this.cloneOriginName:this.name,this.isTemporary=!0,this.name="",t.add(this),this.allHatBlocksFor("__clone__init__").forEach(function(i){t.threads.startProcess(i,o,t.isThreadSafe,null,null,null,e)}),this.endWarp()},SpriteMorph.prototype.initClone=function(t){var e=this.parentThatIsA(StageMorph),o=this;e&&(t.forEach(function(t){e.threads.startProcess(t,o,e.isThreadSafe)}),this.endWarp())},SpriteMorph.prototype.removeClone=function(){var t=this.exemplar;this.isTemporary&&(this.parent.threads.stopAllForReceiver(this),this.corpsify(),this.instances.forEach(function(e){e.isTemporary&&e.setExemplar(t)}),this.destroy(),this.parent.cloneCount-=1)},SpriteMorph.prototype.perpetuate=function(){var t=this.parentThatIsA(StageMorph),e=this.parentThatIsA(IDE_Morph);this.exemplar&&this.exemplar.perpetuate(),this.isTemporary&&t&&e&&(this.isTemporary=!1,this.name=e.newSpriteName(this.cloneOriginName),this.cloneOriginName="",t.cloneCount-=1,e.corral.addSprite(this),e.sprites.add(this),this.parts.forEach(function(t){t.perpetuate()}))},SpriteMorph.prototype.perpetuateAndEdit=function(){var t=this.parentThatIsA(IDE_Morph);t&&(this.perpetuate(),t.selectSprite(this))},SpriteMorph.prototype.release=function(){var t,e=this.parentThatIsA(StageMorph),o=this.parentThatIsA(IDE_Morph);!this.isTemporary&&this.exemplar&&e&&o&&(this.parts.forEach(function(t){t.release()}),this.instances.forEach(function(t){t.release()}),this.isTemporary=!0,this.name="",this.cloneOriginName=this.exemplar.name,e.cloneCount+=1,t=o.sprites.asArray().indexOf(this)+1,e.watchers().forEach(function(t){t.object()===this&&t.destroy()}),t>0&&o.sprites.remove(t),o.createCorral(),o.fixLayout(),o.currentSprite===this&&(o.currentSprite=detect(e.children,function(t){return t instanceof SpriteMorph&&!t.isTemporary})||this.stage),o.selectSprite(o.currentSprite))},SpriteMorph.prototype.corpsify=function(){this.isCorpse=!0,this.version=Date.now()},SpriteMorph.prototype.hide=function(){SpriteMorph.uber.hide.call(this),this.parts.forEach(function(t){t.hide()})},SpriteMorph.prototype.show=function(){SpriteMorph.uber.show.call(this),this.parts.forEach(function(t){t.show()})},SpriteMorph.prototype.setColor=function(t){var e=this.xPosition(),o=this.yPosition();this.color.eq(t)||(this.color=t.copy(),this.costume||(this.drawNew(),this.silentGotoXY(e,o)))},SpriteMorph.prototype.getHue=function(){return 100*this.color.hsv()[0]},SpriteMorph.prototype.setHue=function(t){var e=this.color.hsv(),o=this.xPosition(),i=this.yPosition();e[0]=Math.max(Math.min(+t||0,100),0)/100,e[1]=1,this.color.set_hsv.apply(this.color,e),this.costume||(this.drawNew(),this.changed()),this.gotoXY(o,i)},SpriteMorph.prototype.changeHue=function(t){this.setHue(this.getHue()+(+t||0))},SpriteMorph.prototype.getBrightness=function(){return 100*this.color.hsv()[2]},SpriteMorph.prototype.setBrightness=function(t){var e=this.color.hsv(),o=this.xPosition(),i=this.yPosition();e[1]=1,e[2]=Math.max(Math.min(+t||0,100),0)/100,this.color.set_hsv.apply(this.color,e),this.costume||(this.drawNew(),this.changed()),this.gotoXY(o,i)},SpriteMorph.prototype.changeBrightness=function(t){this.setBrightness(this.getBrightness()+(+t||0))},SpriteMorph.prototype.comeToFront=function(){this.parent&&(this.parent.add(this),this.changed())},SpriteMorph.prototype.goBack=function(t){var e,o,i=+t;if(!this.parent)return null;e=this.parent.children.indexOf(this),this.parent.removeChild(this),o=Math.max(e-i,0),this.parent.children.splice(o,null,this),this.parent.changed()},SpriteMorph.prototype.overlappingImage=function(t){var e=this.bounds.intersect(t.bounds),o=newCanvas(e.extent(),!0),i=o.getContext("2d");return e.width()<1||e.height()<1?newCanvas(new Point(1,1),!0):(i.drawImage(this.image,this.left()-e.left(),this.top()-e.top()),i.globalCompositeOperation="source-in",i.drawImage(t.image,t.left()-e.left(),t.top()-e.top()),o)},SpriteMorph.prototype.doStamp=function(){var t=this.parent,e=t.penTrails().getContext("2d"),o=this.isWarped,i=e.globalAlpha;o&&this.endWarp(),e.save(),e.scale(1/t.scale,1/t.scale),e.globalAlpha=this.alpha,e.drawImage(this.image,this.left()-t.left(),this.top()-t.top()),e.globalAlpha=i,e.restore(),this.changed(),o&&this.startWarp()},SpriteMorph.prototype.clear=function(){this.parent.clearPenTrails()},SpriteMorph.prototype.setSize=function(t){isNaN(t)||(this.size=Math.min(Math.max(+t,1e-4),1e3))},SpriteMorph.prototype.changeSize=function(t){this.setSize(this.size+(+t||0))},SpriteMorph.prototype.getScale=function(){return this.inheritsAttribute("size")?this.exemplar.getScale():100*this.scale},SpriteMorph.prototype.setScale=function(t,e){var o,i,r=this.xPosition(),n=this.yPosition(),s=this.isWarped;s&&this.endWarp(),i=(o=(+t||0)/100)/this.nestingScale,this.nestingScale=o,this.scale=Math.max(o,.01),this.changed(),this.drawNew(),this.changed(),s&&this.startWarp(),this.silentGotoXY(r,n,!0),this.positionTalkBubble(),this.parts.forEach(function(t){var e=t.xPosition()-r,o=t.yPosition()-n;t.setScale(100*t.scale*i),t.silentGotoXY(r+e*i,n+o*i)}),e||this.shadowAttribute("size"),this.instances.forEach(function(e){e.cachedPropagation&&e.inheritsAttribute("size")&&e.setScale(t,!0)})},SpriteMorph.prototype.changeScale=function(t){this.setScale(this.getScale()+(+t||0))},SpriteMorph.prototype.graphicsChanged=function(){var t=this;return Object.keys(this.graphicsValues).some(function(e){return t.graphicsValues[e]<0||t.graphicsValues[e]>0})},SpriteMorph.prototype.applyGraphicsEffects=function(t){var e,o;return this.graphicsChanged()&&(o=(e=t.getContext("2d")).getImageData(0,0,t.width,t.height),this.graphicsValues.fisheye&&(o=function(t,o){var i,r,n,s,a,h,l,p,c,d,u,g,f,m,y,M,b;for(h=t.width,l=t.height,i=t.data,n=(r=e.createImageData(h,l)).data,s=h/2,a=l/2,o=Math.max(0,(o+100)/100),c=0;c<l;c++)for(p=0;p<h;p++)d=(p-s)/s,u=(c-a)/a,(g=Math.pow(Math.sqrt(d*d+u*u),o))<=1?(f=Math.atan2(u,d),m=Math.floor(s+g*Math.cos(f)*s),y=Math.floor(a+g*Math.sin(f)*a)):(m=p,y=c),b=4*(y*h+m),n[M=4*(c*h+p)]=i[b],n[M+1]=i[b+1],n[M+2]=i[b+2],n[M+3]=i[b+3];return r}(o,this.graphicsValues.fisheye)),this.graphicsValues.whirl&&(o=function(t,o){var i,r,n,s,a,h,l,p,c,d,u,g,f,m,y,M,b,w,S,C,v,x,k,B,P;for(s=t.width,a=t.height,i=t.data,n=(r=e.createImageData(s,a)).data,h=s/2,l=a/2,d=Math.min(h,l),s<a?(u=a/s,g=1):(u=1,g=s/a),f=-radians(o),m=d*d,c=0;c<a;c++)for(p=0;p<s;p++)(b=(y=u*(p-h))*y+(M=g*(c-l))*M)<m?(S=f*((w=1-Math.sqrt(b)/d)*w),B=Math.sin(S),P=Math.cos(S),C=Math.floor((P*y-B*M)/u+h),v=Math.floor((B*y+P*M)/g+l)):(C=p,v=c),k=4*(v*s+C),n[x=4*(c*s+p)]=i[k],n[x+1]=i[k+1],n[x+2]=i[k+2],n[x+3]=i[k+3];return r}(o,this.graphicsValues.whirl)),this.graphicsValues.pixelate&&(o=function(t,o){var i,r,n,s,a,h,l,p,c,d;for(s=t.width,a=t.height,i=t.data,n=(r=e.createImageData(s,a)).data,o=Math.floor(Math.abs(o/10)+1),l=0;l<a;l++)for(h=0;h<s;h++)p=Math.floor(h/o)*o,d=4*(Math.floor(l/o)*o*s+p),n[c=4*(l*s+h)]=i[d],n[c+1]=i[d+1],n[c+2]=i[d+2],n[c+3]=i[d+3];return r}(o,this.graphicsValues.pixelate)),this.graphicsValues.mosaic&&(o=function(t,o){var i,r,n,s,a,h;for(i=t.data,a=(s=e.createImageData(t.width,t.height)).data,o=Math.round((Math.abs(o)+10)/10),o=Math.max(0,Math.min(o,Math.min(t.width,t.height))),r=0,n=i.length;r<n;r+=4)h=r*o%n,a[r]=i[h],a[r+1]=i[h+1],a[r+2]=i[h+2],a[r+3]=i[h+3];return s}(o,this.graphicsValues.mosaic)),this.graphicsValues.duplicate&&(o=function(t,e){var o,i;for(o=t.data,i=0;i<o.length;i+=4)o[i]=o[i*e],o[i+1]=o[i*e+1],o[i+2]=o[i*e+2],o[i+3]=o[i*e+3];return t}(o,this.graphicsValues.duplicate)),(this.graphicsValues.color||this.graphicsValues.saturation||this.graphicsValues.brightness)&&(o=function(t,e,o,i){var r,n,s,a,h,l,p,c,d,u,g,f,m,y,M,b,w,S,C,v;for(n=0,s=(r=t.data).length;n<s;n+=4)a=r[n],h=r[n+1],l=r[n+2],0==(d=(p=Math.max(a,h,l))-(c=Math.min(a,h,l)))?u=g=0:(p===a?u=60*(h-l)/d:p===h?u=120+60*(l-a)/d:p===l&&(u=240+60*(a-h)/d),g=(p-c)/p),u<0&&(u+=360),f=p/255,u=(u+360*e/200)%360,g=Math.max(0,Math.min(g+o/100,1)),M=(f=Math.max(0,Math.min(f+i/100,1)))*(1-g),b=f*(1-g*(y=u/60-(m=Math.floor(u/60)))),w=f*(1-g*(1-y)),0===m||6===m?(S=f,C=w,v=M):1===m?(S=b,C=f,v=M):2===m?(S=M,C=f,v=w):3===m?(S=M,C=b,v=f):4===m?(S=w,C=M,v=f):5===m&&(S=f,C=M,v=b),r[n]=255*S,r[n+1]=255*C,r[n+2]=255*v;return t}(o,this.graphicsValues.color,this.graphicsValues.saturation,this.graphicsValues.brightness)),this.graphicsValues.negative&&(o=function(t,e){var o,i,r,n,s,a;for(i=0,r=(o=t.data).length;i<r;i+=4)n=255-o[i],s=255-o[i+1],a=255-o[i+2],o[i]<n?o[i]+=e:o[i]>n&&(o[i]-=e),o[i+1]<s?o[i+1]+=e:o[i+1]>s&&(o[i+1]-=e),o[i+2]<a?o[i+2]+=e:o[i+2]>a&&(o[i+2]-=e);return t}(o,this.graphicsValues.negative)),this.graphicsValues.comic&&(o=function(t,e){var o,i,r;for(i=0,r=(o=t.data).length;i<r;i+=4)o[i]+=127*Math.sin(i*e)+128,o[i+1]+=127*Math.sin(i*e)+128,o[i+2]+=127*Math.sin(i*e)+128;return t}(o,this.graphicsValues.comic)),this.graphicsValues.confetti&&(o=function(t,e){var o,i,r;for(i=0,r=(o=t.data).length;i<r;i+=1)o[i]=127*Math.sin(e*o[i])+o[i];return t}(o,this.graphicsValues.confetti)),e.putImageData(o,0,0)),t},SpriteMorph.prototype.setEffect=function(t,e){var o=t instanceof Array?t[0]:null;"ghost"===o?this.alpha=1-Math.min(Math.max(+e||0,0),100)/100:this.graphicsValues[o]=+e,this.drawNew(),this.changed()},SpriteMorph.prototype.getGhostEffect=function(){return 100*(1-this.alpha)},SpriteMorph.prototype.changeEffect=function(t,e){var o=t instanceof Array?t[0]:null;"ghost"===o?this.setEffect(t,this.getGhostEffect()+(+e||0)):this.setEffect(t,+this.graphicsValues[o]+ +e)},SpriteMorph.prototype.clearEffects=function(){var t;for(t in this.graphicsValues)this.graphicsValues.hasOwnProperty(t)&&this.setEffect([t],0);this.setEffect(["ghost"],0)},SpriteMorph.prototype.stopTalking=function(){var t=this.talkBubble();t&&t.destroy()},SpriteMorph.prototype.doThink=function(t){this.bubble(t,!0)},SpriteMorph.prototype.bubble=function(t,e,o){var i,r=this.parentThatIsA(StageMorph);this.stopTalking(),""===t||isNil(t)||(i=new SpriteBubbleMorph(t,r,e,o),this.add(i),this.positionTalkBubble())},SpriteMorph.prototype.talkBubble=function(){return detect(this.children,function(t){return t instanceof SpeechBubbleMorph})},SpriteMorph.prototype.positionTalkBubble=function(){var t=this.parentThatIsA(StageMorph),e=t?t.scale:1,o=this.talkBubble(),i=this.center().y;if(!o)return null;for(o.show(),o.isPointingRight||(o.isPointingRight=!0,o.drawNew(),o.changed()),o.setLeft(this.right()),o.setBottom(this.top());!this.isTouching(o)&&o.bottom()<i;)o.silentMoveBy(new Point(-1,1).scaleBy(e));if(!t)return null;o.right()>t.right()&&(o.isPointingRight=!1,o.drawNew(),o.setRight(this.center().x)),o.keepWithin(t),o.changed()},SpriteMorph.prototype.prepareToBeGrabbed=function(t){this.removeShadow(),this.recordLayers(),this.shadowAttribute("x position"),this.shadowAttribute("y position"),!this.bounds.containsPoint(t.position())&&this.isCorrectingOutsideDrag()&&this.setCenter(t.position()),this.addShadow()},SpriteMorph.prototype.isCorrectingOutsideDrag=function(){return!this.parts.length},SpriteMorph.prototype.justDropped=function(){var t=this.parentThatIsA(StageMorph),e=this;t&&(t.enableCustomHatBlocks=!0),this.exemplar&&this.inheritedAttributes.forEach(function(t){contains(["direction","size","costume #"],t)&&e.refreshInheritedAttribute(t)}),this.restoreLayers(),this.positionTalkBubble(),this.receiveUserInteraction("dropped")},SpriteMorph.prototype.drawLine=function(t,e){var o=this.parent.bounds.origin,i=this.parent.scale,r=this.parent.penTrails().getContext("2d"),n=t.subtract(o).divideBy(i),s=e.subtract(o).divideBy(i),a=n.multiplyBy(i).add(o),h=s.multiplyBy(i).add(o),l=a.rectangle(h).expandBy(Math.max(this.size*i/2,1)).intersect(this.parent.visibleBounds()).spread();this.isDown&&(r.lineWidth=this.size,r.strokeStyle=this.color.toString(),this.useFlatLineEnds?(r.lineCap="butt",r.lineJoin="miter"):(r.lineCap="round",r.lineJoin="round"),r.beginPath(),r.moveTo(n.x,n.y),r.lineTo(s.x,s.y),r.stroke(),!1===this.isWarped&&this.world().broken.push(l))},SpriteMorph.prototype.floodFill=function(){function t(t){var e=4*t;return[h[e],h[e+1],h[e+2],h[e+3]]}if(this.parent.bounds.containsPoint(this.rotationCenter())){this.color.a>1&&(this.color.a=this.color.a/255);var e,o,i=normalizeCanvas(this.parent.penTrails()),r=i.width,n=i.height,s=i.getContext("2d"),a=s.getImageData(0,0,r,n),h=a.data,l=[Math.round(n/2-this.yPosition())*r+Math.round(this.xPosition()+r/2)];if((o=t(l[0]))[0]!==Math.round(this.color.r)||o[1]!==Math.round(this.color.g)||o[2]!==Math.round(this.color.b)||o[3]!==Math.round(255*this.color.a)){for(;l.length>0;)(function(t){return t[0]===o[0]&&t[1]===o[1]&&t[2]===o[2]&&t[3]===o[3]})(t(e=l.pop()))&&(e%r>1&&(l.push(e+1),l.push(e-1)),e>0&&e<n*r&&(l.push(e+r),l.push(e-r))),h[4*e]=Math.round(this.color.r),h[4*e+1]=Math.round(this.color.g),h[4*e+2]=Math.round(this.color.b),h[4*e+3]=Math.round(255*this.color.a);s.putImageData(a,0,0),this.parent.changed()}}},SpriteMorph.prototype.reportPenTrailsAsCostume=function(){var t=new Costume(this.parentThatIsA(StageMorph).trailsCanvas,this.newCostumeName(localize("Costume")));return t.shrinkWrap(),t},SpriteMorph.prototype.moveBy=function(t,e){var o=this.isDown&&!e&&this.parent?this.rotationCenter():null;SpriteMorph.uber.moveBy.call(this,t),o&&this.drawLine(o,this.rotationCenter()),e||(this.parts.forEach(function(e){e.moveBy(t)}),this.instances.forEach(function(e){if(e.cachedPropagation){var o=e.inheritsAttribute("x position"),i=e.inheritsAttribute("y position");o&&i?e.moveBy(t):o?e.moveBy(new Point(t.x,0)):i&&e.moveBy(new Point(0,t.y))}}))},SpriteMorph.prototype.silentMoveBy=function(t,e){SpriteMorph.uber.silentMoveBy.call(this,t),!e&&this.parent instanceof HandMorph&&(this.parts.forEach(function(e){e.moveBy(t)}),this.instances.forEach(function(e){if(e.cachedPropagation){var o=e.inheritsAttribute("x position"),i=e.inheritsAttribute("y position");o&&i?e.moveBy(t):o?e.moveBy(new Point(t.x,0)):i&&e.moveBy(new Point(0,t.y))}}))},SpriteMorph.prototype.rootForGrab=function(){return this.anchor?this.anchor.rootForGrab():SpriteMorph.uber.rootForGrab.call(this)},SpriteMorph.prototype.setCenter=function(t,e){var o=t.subtract(this.center());this.moveBy(o,e)},SpriteMorph.prototype.nestingBounds=function(){var t=this.bounds;return!this.costume&&this.penBounds&&(t=this.penBounds.translateBy(this.position())),this.parts.forEach(function(e){e.isVisible&&(t=t.merge(e.nestingBounds()))}),t},SpriteMorph.prototype.setPosition=function(t,e){var o=t.subtract(this.topLeft());0===o.x&&0===o.y||this.moveBy(o,e)},SpriteMorph.prototype.forward=function(t){var e,o=t*this.parent.scale||0;e=o>=0?this.position().distanceAngle(o,this.heading):this.position().distanceAngle(Math.abs(o),this.heading-180),this.shadowAttribute("x position"),this.shadowAttribute("y position"),this.setPosition(e),this.positionTalkBubble()},SpriteMorph.prototype.setHeading=function(t,e){var o=this.xPosition(),i=this.yPosition(),r=isFinite(t)?+t:0,n=r-this.heading;this.rotationStyle?(this.changed(),SpriteMorph.uber.setHeading.call(this,r),this.silentGotoXY(o,i,!0),this.positionTalkBubble()):this.heading=(+t%360+360)%360,this.parts.forEach(function(t){var e=new Point(t.xPosition(),t.yPosition()).rotateBy(radians(n),new Point(o,i));t.rotatesWithAnchor&&t.turn(n),t.gotoXY(e.x,e.y)}),e||this.shadowAttribute("direction"),this.instances.forEach(function(e){e.cachedPropagation&&e.inheritsAttribute("direction")&&e.setHeading(t,!0)})},SpriteMorph.prototype.faceToXY=function(t,e){var o=(t-this.xPosition())*this.parent.scale,i=(e-this.yPosition())*this.parent.scale,r=Math.abs(o)<.001?i<0?90:270:Math.round((o>=0?0:180)-57.2957795131*Math.atan(i/o));this.setHeading(r+90)},SpriteMorph.prototype.turn=function(t){this.setHeading(this.heading+(+t||0))},SpriteMorph.prototype.turnLeft=function(t){this.setHeading(this.heading-(+t||0))},SpriteMorph.prototype.xPosition=function(){if(this.inheritsAttribute("x position"))return this.exemplar.xPosition();var t=this.parentThatIsA(StageMorph);return!t&&this.parent.grabOrigin&&(t=this.parent.grabOrigin.origin),t?(this.rotationCenter().x-t.center().x)/t.scale:this.rotationCenter().x},SpriteMorph.prototype.yPosition=function(){if(this.inheritsAttribute("y position"))return this.exemplar.yPosition();var t=this.parentThatIsA(StageMorph);return!t&&this.parent.grabOrigin&&(t=this.parent.grabOrigin.origin),t?(t.center().y-this.rotationCenter().y)/t.scale:this.rotationCenter().y},SpriteMorph.prototype.direction=function(){return this.inheritsAttribute("direction")?this.exemplar.direction():this.heading},SpriteMorph.prototype.penSize=function(){return this.size},SpriteMorph.prototype.gotoXY=function(t,e,o,i){var r,n,s,a=this.parentThatIsA(StageMorph);a&&(i||(this.shadowAttribute("x position"),this.shadowAttribute("y position")),t=isFinite(+t)?+t:0,e=isFinite(+e)?+e:0,r=a.center().x+t*a.scale,n=a.center().y-e*a.scale,s=this.costume?new Point(r,n).subtract(this.rotationOffset):new Point(r,n).subtract(this.extent().divideBy(2)),this.setPosition(s,o),this.positionTalkBubble())},SpriteMorph.prototype.silentGotoXY=function(t,e,o){var i=this.isDown;this.isDown=!1,this.gotoXY(t,e,o,!0),this.isDown=i},SpriteMorph.prototype.setXPosition=function(t){this.shadowAttribute("x position"),this.gotoXY(+t||0,this.yPosition(),!1,!0)},SpriteMorph.prototype.changeXPosition=function(t){this.setXPosition(this.xPosition()+(+t||0))},SpriteMorph.prototype.setYPosition=function(t){this.shadowAttribute("y position"),this.gotoXY(this.xPosition(),+t||0,!1,!0)},SpriteMorph.prototype.changeYPosition=function(t){this.setYPosition(this.yPosition()+(+t||0))},SpriteMorph.prototype.glide=function(t,e,o,i,r){var n,s,a;s=new Point(e,o),n=Math.max(Math.min(i/t,1),0),a=r.add(s.subtract(r).multiplyBy(n)),this.gotoXY(a.x,a.y)},SpriteMorph.prototype.bounceOffEdge=function(){var t,e,o=this.parentThatIsA(StageMorph),i=this.nestingBounds();return o?o.bounds.containsRectangle(i)?null:(t=Math.cos(radians(this.heading-90)),e=-Math.sin(radians(this.heading-90)),i.left()<o.left()&&(t=Math.abs(t)),i.right()>o.right()&&(t=-Math.abs(t)),i.top()<o.top()&&(e=-Math.abs(e)),i.bottom()>o.bottom()&&(e=Math.abs(e)),this.shadowAttribute("x position"),this.shadowAttribute("y position"),this.shadowAttribute("direction"),this.setHeading(degrees(Math.atan2(-e,t))+90),this.setPosition(this.position().add(i.amountToTranslateWithin(o.bounds))),void this.positionTalkBubble()):null},SpriteMorph.prototype.setRotationX=function(t){this.setRotationCenter(new Point(t,this.yPosition()))},SpriteMorph.prototype.setRotationY=function(t){this.setRotationCenter(new Point(this.xPosition(),t))},SpriteMorph.prototype.setRotationCenter=function(t){var e,o;if(!this.costume)throw new Error("setting the rotation center requires a costume");e=t.subtract(new Point(this.xPosition(),this.yPosition())).divideBy(this.scale).rotateBy(radians(90-this.heading)),o=this.costume.rotationCenter.add(new Point(e.x,-e.y)),this.costume.rotationCenter=o,this.drawNew()},SpriteMorph.prototype.moveRotationCenter=function(){this.world().activeHandle=new HandleMorph(this,null,null,null,null,"movePivot")},SpriteMorph.prototype.setPivot=function(t){var e,o=this.parentThatIsA(StageMorph);o&&(e=o.center(),this.setRotationCenter(new Point((t.x-e.x)/o.scale,(e.y-t.y)/o.scale)))},SpriteMorph.prototype.xCenter=function(){var t=this.parentThatIsA(StageMorph);return!t&&this.parent.grabOrigin&&(t=this.parent.grabOrigin.origin),t?(this.center().x-t.center().x)/t.scale:this.center().x},SpriteMorph.prototype.yCenter=function(){var t=this.parentThatIsA(StageMorph);return!t&&this.parent.grabOrigin&&(t=this.parent.grabOrigin.origin),t?(t.center().y-this.center().y)/t.scale:this.center().y},SpriteMorph.prototype.allMessageNames=function(){var t=[],e=this.scripts.children.slice();return this.customBlocks.forEach(function(t){t.body&&e.push(t.body.expression),t.scripts.forEach(function(t){e.push(t)})}),this.globalBlocks&&this.globalBlocks.forEach(function(t){t.body&&e.push(t.body.expression),t.scripts.forEach(function(t){e.push(t)})}),e.forEach(function(e){e.allChildren().forEach(function(e){var o;e.selector&&contains(["receiveMessage","doBroadcast","doBroadcastAndWait"],e.selector)&&isString(o=e.inputs()[0].evaluate())&&""!==o&&(contains(t,o)||t.push(o))})}),t},SpriteMorph.prototype.allHatBlocksFor=function(t){return"number"==typeof t&&(t=t.toString()),this.scripts.children.filter(function(e){var o;if(e.selector){if("receiveMessage"===e.selector)return(o=e.inputs()[0].evaluate())===t||o instanceof Array&&"__shout__go__"!==t&&"__clone__init__"!==t;if("receiveGo"===e.selector)return"__shout__go__"===t;if("receiveOnClone"===e.selector)return"__clone__init__"===t}return!1})},SpriteMorph.prototype.allHatBlocksForKey=function(t){return this.scripts.children.filter(function(e){if(e.selector&&"receiveKey"===e.selector){var o=e.inputs()[0].evaluate()[0];return o===t||"any key"===o}return!1})},SpriteMorph.prototype.allHatBlocksForInteraction=function(t){return this.scripts.children.filter(function(e){return!(!e.selector||"receiveInteraction"!==e.selector)&&e.inputs()[0].evaluate()[0]===t})},SpriteMorph.prototype.allGenericHatBlocks=function(){return this.scripts.children.filter(function(t){return!!t.selector&&"receiveCondition"===t.selector})},SpriteMorph.prototype.mouseClickLeft=function(){return this.receiveUserInteraction("clicked")},SpriteMorph.prototype.mouseEnter=function(){return this.receiveUserInteraction("mouse-entered")},SpriteMorph.prototype.mouseDownLeft=function(){return this.receiveUserInteraction("pressed")},SpriteMorph.prototype.receiveUserInteraction=function(t){var e=this.parentThatIsA(StageMorph),o=[],i=this;if(e)return this.allHatBlocksForInteraction(t).forEach(function(t){o.push(e.threads.startProcess(t,i,e.isThreadSafe))}),o},SpriteMorph.prototype.mouseDoubleClick=function(){this.isTemporary||this.edit()},SpriteMorph.prototype.getTimer=function(){var t=this.parentThatIsA(StageMorph);return t?t.getTimer():0},SpriteMorph.prototype.getTempo=function(){var t=this.parentThatIsA(StageMorph);return t?t.getTempo():0},SpriteMorph.prototype.getLastMessage=function(){var t=this.parentThatIsA(StageMorph);return t?t.getLastMessage():""},SpriteMorph.prototype.getLastAnswer=function(){return this.parentThatIsA(StageMorph).lastAnswer},SpriteMorph.prototype.reportMouseX=function(){var t=this.parentThatIsA(StageMorph);return t?t.reportMouseX():0},SpriteMorph.prototype.reportMouseY=function(){var t=this.parentThatIsA(StageMorph);return t?t.reportMouseY():0},SpriteMorph.prototype.reportThreadCount=function(){var t=this.parentThatIsA(StageMorph);return t?t.threads.processes.length:0},SpriteMorph.prototype.refactorVariableInstances=function(t,e,o){o&&this.hasSpriteVariable(t)||this.scripts.children.forEach(function(o){o instanceof BlockMorph&&o.refactorVarInStack(t,e)})},SpriteMorph.prototype.findVariableWatcher=function(t){var e=this.parentThatIsA(StageMorph),o=this.globalVariables(),i=this;return null===e?null:detect(e.children,function(e){return e instanceof WatcherMorph&&(e.target===i.variables||e.target===o)&&e.getter===t})},SpriteMorph.prototype.toggleVariableWatcher=function(t,e){var o,i,r=this.parentThatIsA(StageMorph),n=this.globalVariables();return null===r?null:null===(o=this.findVariableWatcher(t))?(isNil(e)&&(e=contains(n.names(),t)),(o=new WatcherMorph(t,this.blockColor.variables,e?n:this.variables,t)).setPosition(r.position().add(10)),(i=r.watchers(o.left())).length>0&&o.setTop(i[i.length-1].bottom()),r.add(o),o.fixLayout(),o.keepWithin(r),o):void(o.isVisible?o.hide():(o.show(),o.fixLayout(),o.keepWithin(r)))},SpriteMorph.prototype.showingVariableWatcher=function(t){var e;return null!==this.parentThatIsA(StageMorph)&&(!!(e=this.findVariableWatcher(t))&&e.isVisible)},SpriteMorph.prototype.deleteVariableWatcher=function(t){var e;if(null===this.parentThatIsA(StageMorph))return null;null!==(e=this.findVariableWatcher(t))&&e.destroy()},SpriteMorph.prototype.toggleWatcher=function(t,e,o){var i,r,n=this.parentThatIsA(StageMorph);n&&((i=this.watcherFor(n,t))?i.isVisible?i.hide():(i.show(),i.fixLayout(),i.keepWithin(n)):((i=new WatcherMorph(e,o,WatcherMorph.prototype.isGlobal(t)?n:this,t)).setPosition(n.position().add(10)),(r=n.watchers(i.left())).length>0&&i.setTop(r[r.length-1].bottom()),n.add(i),i.fixLayout(),i.keepWithin(n)))},SpriteMorph.prototype.showingWatcher=function(t){var e,o=this.parentThatIsA(StageMorph);return null!==o&&(!!(e=this.watcherFor(o,t))&&e.isVisible)},SpriteMorph.prototype.watcherFor=function(t,e){var o=this;return detect(t.children,function(i){return i instanceof WatcherMorph&&i.getter===e&&i.target===(i.isGlobal(e)?t:o)})},SpriteMorph.prototype.deleteAllBlockInstances=function(t){var e;(t.isGlobal?this.allBlockInstances(t):this.allIndependentInvocationsOf(t.blockSpec())).forEach(function(t){t.deleteBlock()}),t.isGlobal?(e=this.parentThatIsA(StageMorph))&&(e.globalBlocks.forEach(function(t){t.purgeCorpses()}),e.children.concat(e).forEach(function(t){t.isSnapObject&&t.customBlocks.forEach(function(t){t.purgeCorpses()})})):this.allSpecimens().concat(this).forEach(function(t){t.customBlocks.forEach(function(t){t.purgeCorpses()})})},SpriteMorph.prototype.allBlockInstances=function(t){var e,o,i,r=[];return t.isGlobal?(e=this.parentThatIsA(StageMorph),(o=e.children.filter(function(t){return t instanceof SpriteMorph})).push(e),o.forEach(function(e){r=r.concat(e.allLocalBlockInstances(t))}),i=[],e.globalBlocks.forEach(function(e){e.scripts.forEach(function(e){e.allChildren().forEach(function(e){e.isCustomBlock&&e.definition===t&&i.push(e)})}),e.body&&e.body.expression.allChildren().forEach(function(e){e.isCustomBlock&&e.definition===t&&i.push(e)})}),r.concat(i)):this.allLocalBlockInstances(t)},SpriteMorph.prototype.allIndependentInvocationsOf=function(t){var e;return this.exemplar&&this.exemplar.getMethod(t)?[]:(e=this.allInvocationsOf(t),this.instances.forEach(function(o){o.addAllInvocationsOf(t,e)}),e)},SpriteMorph.prototype.allDependentInvocationsOf=function(t){var e;return e=this.allInvocationsOf(t),this.instances.forEach(function(o){o.addAllInvocationsOf(t,e)}),e},SpriteMorph.prototype.allInvocationsOf=function(t){var e,o,i;return e=this.scripts.allChildren().filter(function(e){return e.isCustomBlock&&!e.isGlobal&&e.blockSpec===t}),o=[],this.customBlocks.forEach(function(e){e.scripts.forEach(function(e){e.allChildren().forEach(function(e){e.isCustomBlock&&!e.isGlobal&&e.blockSpec===t&&o.push(e)})}),e.body&&e.body.expression.allChildren().forEach(function(e){e.isCustomBlock&&!e.isGlobal&&e.blockSpec===t&&o.push(e)})}),i=this.allEditorBlockInstances(null,t),e.concat(o).concat(i)},SpriteMorph.prototype.addAllInvocationsOf=function(t,e){this.getLocalMethod(t)||(this.allInvocationsOf(t).forEach(function(t){e.push(t)}),this.instances.forEach(function(o){o.addAllInvocationsOf(t,e)}))},SpriteMorph.prototype.allLocalBlockInstances=function(t){var e,o,i,r,n;return e=this.scripts.allChildren().filter(function(e){return e.isCustomBlock&&e.definition===t}),o=[],this.customBlocks.forEach(function(e){e.body&&e.body.expression.allChildren().forEach(function(e){e.isCustomBlock&&e.definition===t&&o.push(e)})}),i=this.allEditorBlockInstances(t),r=this.paletteBlockInstance(t),n=e.concat(o).concat(i),r&&n.push(r),n},SpriteMorph.prototype.allEditorBlockInstances=function(t,e){var o=[];return this.world()?(this.world().children.forEach(function(i){i instanceof BlockEditorMorph&&i.body.contents.allChildren().forEach(function(i){t?i.isPrototype||i instanceof PrototypeHatBlockMorph||i.definition!==t||o.push(i):!i.isCustomBlock||i.isGlobal||i.isPrototype||i instanceof PrototypeHatBlockMorph||i.blockSpec!==e||o.push(i)})}),o):[]},SpriteMorph.prototype.paletteBlockInstance=function(t){var e=this.parentThatIsA(IDE_Morph);return e?detect(e.palette.contents.children,function(e){return e.isCustomBlock&&e.definition===t}):null},SpriteMorph.prototype.usesBlockInstance=function(t,e,o,i){var r;return!!detect(this.scripts.allChildren(),function(e){return e.isCustomBlock&&e.definition===t})||(!!(t.isGlobal&&!o&&(r=[],this.parentThatIsA(StageMorph).globalBlocks.forEach(function(o){e&&t===o||i&&contains(i,o)||o.body&&o.body.expression.allChildren().forEach(function(e){e.isCustomBlock&&e.definition===t&&r.push(e)})}),r.length>0))||(r=[],this.customBlocks.forEach(function(e){e.body&&e.body.expression.allChildren().forEach(function(e){e.isCustomBlock&&e.definition===t&&r.push(e)})}),r.length>0))},SpriteMorph.prototype.doubleDefinitionsFor=function(t){var e,o,i,r=t.blockSpec();if(t.isGlobal){if(!(i=this.parentThatIsA(StageMorph)))return[];e=i.globalBlocks}else e=this.customBlocks;return o=e.indexOf(t),-1===o?[]:e.filter(function(t,e){return t.blockSpec()===r&&e!==o})},SpriteMorph.prototype.replaceDoubleDefinitionsFor=function(t){var e,o,i=this.doubleDefinitionsFor(t),r=this;i.forEach(function(e){r.allBlockInstances(e).forEach(function(e){e.definition=t,e.refresh()})}),t.isGlobal?(e=this.parentThatIsA(StageMorph)).globalBlocks=e.globalBlocks.filter(function(t){return!contains(i,t)}):this.customBlocks=this.customBlocks.filter(function(t){return!contains(i,t)}),(o=this.parentThatIsA(IDE_Morph))&&(o.flushPaletteCache(),o.refreshPalette())},SpriteMorph.prototype.chooseExemplar=function(){var t,e=this,o=this.parentThatIsA(StageMorph).children.filter(function(t){return t instanceof SpriteMorph&&!t.isTemporary&&!contains(t.allExemplars(),e)});t=new MenuMorph(function(t){e.setExemplar(t)},localize("current parent")+":\n"+(this.exemplar?this.exemplar.name:localize("none"))),o.forEach(function(e){t.addItem(e.name,e)}),t.addLine(),t.addItem(localize("none"),null),t.popUpAtHand(this.world())},SpriteMorph.prototype.setExemplar=function(t){var e;this.emancipate(),this.exemplar=t,t?(this.variables.parentFrame=t.variables,t.addSpecimen(this)):this.variables.parentFrame=this.globalVariables(),this.isTemporary||(e=this.parentThatIsA(IDE_Morph))&&(e.flushBlocksCache("variables"),e.refreshPalette())},SpriteMorph.prototype.prune=function(){this.instances.forEach(function(t){t.shadowAllAttributes(),t.shadowAllMethods(),t.shadowAllVars(),t.exemplar=null}),this.instances=[]},SpriteMorph.prototype.emancipate=function(){this.exemplar&&(this.isTemporary||(this.shadowAllAttributes(),this.shadowAllMethods(),this.shadowAllVars()),this.exemplar.removeSpecimen(this),this.exemplar=null)},SpriteMorph.prototype.allExemplars=function(){for(var t=[],e=this;!isNil(e);)t.push(e),e=e.exemplar;return t},SpriteMorph.prototype.specimens=function(){return this.instances},SpriteMorph.prototype.allSpecimens=function(){var t=this.instances.slice();return this.instances.forEach(function(e){t.push.apply(t,e.allSpecimens())}),t},SpriteMorph.prototype.addSpecimen=function(t){this.instances.push(t)},SpriteMorph.prototype.removeSpecimen=function(t){var e=this.instances.indexOf(t);-1!==e&&this.instances.splice(e,1)},SpriteMorph.prototype.inheritsAttribute=function(t){return!isNil(this.exemplar)&&contains(this.inheritedAttributes,t)},SpriteMorph.prototype.updatePropagationCache=function(){var t=this;this.cachedPropagation=!isNil(this.exemplar)&&detect(["x position","y position","direction","size","costume #"],function(e){return contains(t.inheritedAttributes,e)})},SpriteMorph.prototype.shadowedAttributes=function(){var t=this.inheritedAttributes;return this.attributes.filter(function(e){return!contains(t,e)})},SpriteMorph.prototype.shadowAllAttributes=function(){var t=this;this.attributes.forEach(function(e){t.shadowAttribute(e)})},SpriteMorph.prototype.shadowAttribute=function(t){var e,o,i,r,n=this;this.inheritsAttribute(t)&&(e=this.parentThatIsA(IDE_Morph),this.inheritedAttributes=this.inheritedAttributes.filter(function(e){return e!==t}),"costumes"===t?(o=new List,this.costumes.asArray().forEach(function(t){var e=t.copy();o.add(e),t===n.costume&&n.wearCostume(e)}),this.costumes=o,this.instances.forEach(function(t){t.inheritsAttribute("costumes")&&t.refreshInheritedAttribute("costumes")})):"sounds"===t?(i=new List,this.sounds.asArray().forEach(function(t){i.add(t.copy())}),this.sounds=i,this.instances.forEach(function(t){t.inheritsAttribute("sounds")&&t.refreshInheritedAttribute("sounds")})):"scripts"===t?(e.stage.threads.stopAllForReceiver(this),r=this.scripts.position(),this.scripts=this.exemplar.scripts.fullCopy(),e&&contains(e.currentSprite.allExemplars(),this)&&(e.createSpriteEditor(),e.fixLayout("selectSprite"),this.scripts.fixMultiArgs(),this.scripts.setPosition(r),e.spriteEditor.adjustScrollBars()),this.instances.forEach(function(t){t.inheritsAttribute("scripts")&&t.refreshInheritedAttribute("scripts")})):(this.updatePropagationCache(),e&&!this.isTemporary&&(e.flushBlocksCache(),e.refreshPalette())))},SpriteMorph.prototype.inheritAttribute=function(t){var e=this.parentThatIsA(IDE_Morph);this.exemplar&&contains(this.attributes,t)&&(this.inheritsAttribute(t)||(this.inheritedAttributes.push(t),this.refreshInheritedAttribute(t),e&&(e.flushBlocksCache(),e.refreshPalette())))},SpriteMorph.prototype.refreshInheritedAttribute=function(t){var e,o;switch(t){case"x position":case"y position":this.cachedPropagation=!0,this.gotoXY(this.xPosition(),this.yPosition(),!1,!0);break;case"direction":this.cachedPropagation=!0,this.setHeading(this.direction(),!0);break;case"size":this.cachedPropagation=!0,this.setScale(this.getScale(),!0);break;case"costume #":this.cachedPropagation=!0,this.doSwitchToCostume(this.getCostumeIdx(),!0);break;case"costumes":o=this.getCostumeIdx(),this.costumes=this.exemplar.costumes,this.doSwitchToCostume(o,!0),this.instances.forEach(function(t){t.inheritsAttribute("costumes")&&t.refreshInheritedAttribute("costumes")});break;case"sounds":this.sounds=this.exemplar.sounds,this.instances.forEach(function(t){t.inheritsAttribute("sounds")&&t.refreshInheritedAttribute("sounds")});break;case"scripts":this.scripts=this.exemplar.scripts,(e=this.parentThatIsA(IDE_Morph))&&(e.stage.threads.stopAllForReceiver(this),contains(e.currentSprite.allExemplars(),this)&&(e.createSpriteEditor(),e.fixLayout("selectSprite"))),this.instances.forEach(function(t){t.inheritsAttribute("scripts")&&t.refreshInheritedAttribute("scripts")});break;default:nop()}},SpriteMorph.prototype.toggleInheritanceForAttribute=function(t){this.inheritsAttribute(t)?this.shadowAttribute(t):this.inheritAttribute(t)},SpriteMorph.prototype.isVariableNameInUse=function(t,e){return e?contains(this.variables.allNames(),t):!!contains(this.variables.names(),t)||contains(this.globalVariables().names(),t)},SpriteMorph.prototype.globalVariables=function(){for(var t=this.variables.parentFrame;t.owner;)t=t.parentFrame;return t},SpriteMorph.prototype.shadowAllVars=function(){var t=this;this.inheritedVariableNames().forEach(function(e){t.shadowVar(e,t.variables.getVar(e))})},SpriteMorph.prototype.shadowVar=function(t,e){var o;this.variables.addVar(t,e),this.isTemporary||(o=this.parentThatIsA(IDE_Morph))&&(o.flushBlocksCache("variables"),o.refreshPalette())},SpriteMorph.prototype.toggleInheritedVariable=function(t){contains(this.inheritedVariableNames(!0),t)?this.deleteVariable(t):contains(this.inheritedVariableNames(),t)&&this.shadowVar(t,this.variables.getVar(t))},SpriteMorph.prototype.inheritedVariableNames=function(t){for(var e=[],o=this.variables.names(),i=this.variables.parentFrame;i.owner instanceof SpriteMorph;)e.push.apply(e,i.names().filter(function(e){return t?contains(o,e):!contains(o,e)})),i=i.parentFrame;return e},SpriteMorph.prototype.deletableVariableNames=function(){var t=this.variables.names(),e=this.inheritedVariableNames();return t.concat(this.globalVariables().names().filter(function(o){return!contains(t,o)&&!contains(e,o)}))},SpriteMorph.prototype.hasSpriteVariable=function(t){return contains(this.variables.names(),t)},SpriteMorph.prototype.getMethod=function(t){return this.allBlocks()[t]},SpriteMorph.prototype.getLocalMethod=function(t){return this.ownBlocks()[t]},SpriteMorph.prototype.ownBlocks=function(){var t={};return this.customBlocks.forEach(function(e){t[e.blockSpec()]=e}),t},SpriteMorph.prototype.allBlocks=function(t){var e={};return this.allExemplars().reverse().forEach(function(t){t.customBlocks.forEach(function(t){e[t.blockSpec()]=t})}),t?Object.keys(e).map(function(t){return e[t]}):e},SpriteMorph.prototype.inheritedBlocks=function(t){var e={},o=Object.keys(this.ownBlocks()),i=this.allExemplars().reverse();return i.pop(),i.forEach(function(t){t.customBlocks.forEach(function(t){var i=t.blockSpec();contains(o,i)||(e[i]=t)})}),t?Object.keys(e).map(function(t){return e[t]}):e},SpriteMorph.prototype.shadowAllMethods=function(){var t,e=this;this.inheritedMethods().forEach(function(t){e.customBlocks.push(t)}),this.isTemporary||(t=this.parentThatIsA(IDE_Morph))&&(t.flushPaletteCache(),t.refreshPalette())},SpriteMorph.prototype.inheritedMethods=function(){var t=this;return this.inheritedBlocks(!0).map(function(e){return e.copyAndBindTo(t,!0)})},SpriteMorph.prototype.thumbnail=function(t){function e(e,o,i){var r=Math.min(t.x,t.y)/10;a.strokeStyle=e,a.globalAlpha=o,a.compositeOperation="lighter",a.lineWidth=i||1,a.moveTo(r,r),a.lineTo(s.width-r,s.height-r),a.moveTo(r,s.height-r),a.lineTo(s.width-r,r),a.stroke()}var o=this.image,i=Math.min(t.x/o.width,t.y/o.height),r=(t.x-o.width*i)/2,n=(t.y-o.height*i)/2,s=newCanvas(t),a=s.getContext("2d");return a.save(),this.isCorpse&&(a.globalAlpha=.3),o.width&&o.height&&(a.scale(i,i),a.drawImage(o,Math.floor(r/i),Math.floor(n/i))),this.isCorpse&&(a.restore(),e("white",.8,6),e("black",.8,1)),s},SpriteMorph.prototype.fullThumbnail=function(t){var e=this.thumbnail(t),o=e.getContext("2d"),i=t.divideBy(3),r=0;for(o.restore(),this.anchor&&o.drawImage(this.anchor.thumbnail(i),0,0),r=0;r<3;r+=1)this.parts[r]&&o.drawImage(this.parts[r].thumbnail(i),r*i.x,t.y-i.y);return e},SpriteMorph.prototype.booleanMorph=function(t){var e=new BooleanSlotMorph(t);return e.isStatic=!0,e.drawNew(),e},SpriteMorph.prototype.attachPart=function(t){var e=Date.now();t.anchor&&t.anchor.detachPart(t),this.parts.push(t),this.version=e,t.anchor=this,this.allParts().forEach(function(t){t.nestingScale=t.scale}),t.version=e},SpriteMorph.prototype.detachPart=function(t){var e,o=this.parts.indexOf(t);-1!==o&&(e=Date.now(),this.parts.splice(o,1),this.version=e,t.anchor=null,t.version=e)},SpriteMorph.prototype.detachAllParts=function(){var t=Date.now();this.parts.forEach(function(e){e.anchor=null,e.version=t}),this.parts=[],this.version=t},SpriteMorph.prototype.detachFromAnchor=function(){this.anchor&&this.anchor.detachPart(this)},SpriteMorph.prototype.allParts=function(){var t=[this];return this.parts.forEach(function(e){t=t.concat(e.allParts())}),t},SpriteMorph.prototype.allAnchors=function(){var t=[this];return null!==this.anchor&&(t=t.concat(this.anchor.allAnchors())),t},SpriteMorph.prototype.recordLayers=function(){var t=this.parentThatIsA(StageMorph);t?(this.layers=this.allParts(),this.layers.forEach(function(t){var e=t.talkBubble();e&&e.hide()}),this.layers.sort(function(e,o){return t.children.indexOf(e)<t.children.indexOf(o)?-1:1})):this.layerCache=null},SpriteMorph.prototype.restoreLayers=function(){this.layers&&this.layers.length>1&&this.layers.forEach(function(t){t.comeToFront(),t.positionTalkBubble()}),this.layers=null},SpriteMorph.prototype.destroy=function(){this.anchor&&this.anchor.detachPart(this),this.emancipate(),this.isTemporary||this.prune(),SpriteMorph.uber.destroy.call(this)},SpriteMorph.prototype.flash=function(){var t=this.world(),e=this;this.addHighlight(),t.animations.push(new Animation(nop,nop,0,800,nop,function(){e.removeHighlight()}))},SpriteMorph.prototype.addHighlight=function(t){var e,o=!this.isVisible;return o&&this.show(),e=this.highlight(t?t.color:this.highlightColor,this.highlightBorder),this.addBack(e),this.fullChanged(),o&&this.hide(),e},SpriteMorph.prototype.removeHighlight=function(){var t=this.getHighlight();return null!==t&&(this.fullChanged(),this.removeChild(t)),t},SpriteMorph.prototype.toggleHighlight=function(){this.getHighlight()?this.removeHighlight():this.addHighlight()},SpriteMorph.prototype.highlight=function(t,e){var o,i=new SpriteHighlightMorph,r=this.bounds,n=e;return i.setExtent(r.extent().add(2*n)),i.color=t,i.image=this.highlightImage(t,e),(o=i.image.getContext("2d")).drawImage(this.highlightImage(new Color(255,255,255),4),e-4,e-4),o.drawImage(this.highlightImage(new Color(50,50,50),2),e-2,e-2),o.drawImage(this.highlightImage(new Color(255,255,255),1),e-1,e-1),i.setPosition(r.origin.subtract(new Point(n,n))),i},SpriteMorph.prototype.highlightImage=function(t,e){var o,i,r,n,s;return o=this.extent(),i=this.image,r=newCanvas(o.add(2*e)),(n=r.getContext("2d")).drawImage(i,0,0),n.drawImage(i,e,0),n.drawImage(i,2*e,0),n.drawImage(i,2*e,e),n.drawImage(i,2*e,2*e),n.drawImage(i,e,2*e),n.drawImage(i,0,2*e),n.drawImage(i,0,e),n.globalCompositeOperation="destination-out",n.drawImage(i,e,e),s=newCanvas(o.add(2*e)),(n=s.getContext("2d")).drawImage(r,0,0),n.globalCompositeOperation="source-atop",n.fillStyle=t.toString(),n.fillRect(0,0,s.width,s.height),s},SpriteMorph.prototype.getHighlight=function(){var t;return t=this.children.slice(0).reverse().filter(function(t){return t instanceof SpriteHighlightMorph}),0!==t.length?t[0]:null},SpriteMorph.prototype.mouseEnterDragging=function(){var t;this.enableNesting&&(t=this.world().hand.children[0],this.wantsDropOf(t)&&this.addHighlight())},SpriteMorph.prototype.mouseLeave=function(){this.receiveUserInteraction("mouse-departed"),this.enableNesting&&this.removeHighlight()},SpriteMorph.prototype.wantsDropOf=function(t){return this.enableNesting&&t instanceof SpriteIconMorph&&!contains(t.object.allParts(),this)},SpriteMorph.prototype.reactToDropOf=function(t,e){this.removeHighlight(),this.attachPart(t.object),this.world().add(t),t.slideBackTo(e.grabOrigin)},SpriteMorph.prototype.newCostumeName=function(t,e){for(var o=t.indexOf("("),i=o<0?t:t.substring(0,o),r=1,n=i,s=this.costumes.asArray().filter(function(t){return t!==e}).map(function(t){return t.name});contains(s,n);)n=i+"("+(r+=1)+")";return n},SpriteMorph.prototype.doScreenshot=function(t,e){var o,i,r=this.parentThatIsA(StageMorph);e=this.newCostumeName(e),void 0!==t[0]&&("pen trails"===t[0]?(o=r.trailsCanvas,i=new Costume(o,e).copy()):"stage image"===t[0]&&(o=r.fullImageClassic(),i=new Costume(o,e)),this.addCostume(i))},SpriteHighlightMorph.prototype=new Morph,SpriteHighlightMorph.prototype.constructor=SpriteHighlightMorph,SpriteHighlightMorph.uber=Morph.prototype,StageMorph.prototype=new FrameMorph,StageMorph.prototype.constructor=StageMorph,StageMorph.uber=FrameMorph.prototype,StageMorph.prototype.dimensions=new Point(480,360),StageMorph.prototype.frameRate=0,StageMorph.prototype.isCachingPrimitives=SpriteMorph.prototype.isCachingPrimitives,StageMorph.prototype.sliderColor=SpriteMorph.prototype.sliderColor,StageMorph.prototype.paletteTextColor=SpriteMorph.prototype.paletteTextColor,StageMorph.prototype.hiddenPrimitives={},StageMorph.prototype.codeMappings={},StageMorph.prototype.codeHeaders={},StageMorph.prototype.enableCodeMapping=!1,StageMorph.prototype.enableInheritance=!0,StageMorph.prototype.enableSublistIDs=!1,StageMorph.prototype.init=function(t){this.name=localize("Stage"),this.instrument=null,this.threads=new ThreadManager,this.variables=new VariableFrame(t||null,this),this.scripts=new ScriptsMorph,this.customBlocks=[],this.globalBlocks=[],this.costumes=new List,this.costume=null,this.sounds=new List,this.version=Date.now(),this.isFastTracked=!1,this.enableCustomHatBlocks=!0,this.cloneCount=0,this.timerStart=Date.now(),this.tempo=60,this.lastMessage="",this.watcherUpdateFrequency=2,this.lastWatcherUpdate=Date.now(),this.scale=1,this.keysPressed={},this.blocksCache={},this.paletteCache={},this.lastAnswer="",this.activeSounds=[],this.trailsCanvas=null,this.isThreadSafe=!1,this.graphicsValues={color:0,fisheye:0,whirl:0,pixelate:0,mosaic:0,duplicate:0,negative:0,comic:0,confetti:0,saturation:0,brightness:0},StageMorph.uber.init.call(this),this.acceptsDrops=!1,this.setColor(new Color(255,255,255)),this.fps=this.frameRate},StageMorph.prototype.setScale=function(t){var e,o,i=t/this.scale,r=this.position(),n=Morph.prototype.trackChanges,s=this;1!==i&&(Morph.prototype.trackChanges=!1,this.scale=t,this.setExtent(this.dimensions.multiplyBy(t)),this.children.forEach(function(n){e=n.position().subtract(r),n.drawNew(),n.setPosition(e.multiplyBy(i).add(r),!0),n instanceof SpriteMorph?(o=n.talkBubble())&&(o.setScale(t),n.positionTalkBubble()):n instanceof StagePrompterMorph&&(s.scale<1?n.setWidth(s.width()-10):n.setWidth(s.dimensions.x-20),n.fixLayout(),n.setCenter(s.center()),n.setBottom(s.bottom()))}),Morph.prototype.trackChanges=n,this.changed())},StageMorph.prototype.drawNew=function(){var t;StageMorph.uber.drawNew.call(this),this.costume&&((t=this.image.getContext("2d")).scale(this.scale,this.scale),t.drawImage(this.costume.contents,(this.width()/this.scale-this.costume.width())/2,(this.height()/this.scale-this.costume.height())/2),this.image=this.applyGraphicsEffects(this.image)),this.version=Date.now()},StageMorph.prototype.drawOn=function(t,e){var o,i,r,n,s,a,h,l,p,c,d;if(!this.isVisible)return null;if(o=e||this.bounds,(i=o.intersect(this.bounds)).extent().gt(new Point(0,0))){if(r=this.position().neg(),n=i.copy().translateBy(r),s=t.getContext("2d"),s.globalAlpha=this.alpha,l=n.left(),p=n.top(),a=Math.min(n.width(),this.image.width-l),h=Math.min(n.height(),this.image.height-p),a<1||h<1)return null;s.drawImage(this.image,l,p,a,h,i.left(),i.top(),a,h),c=a/this.scale,d=h/this.scale,s.save(),s.scale(this.scale,this.scale);try{s.drawImage(this.penTrails(),l/this.scale,p/this.scale,c,d,i.left()/this.scale,i.top()/this.scale,c,d)}catch(t){s.restore(),s.drawImage(this.penTrails(),0,0,this.dimensions.x,this.dimensions.y,this.left(),this.top(),this.dimensions.x*this.scale,this.dimensions.y*this.scale)}s.restore()}},StageMorph.prototype.clearPenTrails=function(){this.trailsCanvas=newCanvas(this.dimensions),this.changed()},StageMorph.prototype.penTrails=function(){return this.trailsCanvas||(this.trailsCanvas=newCanvas(this.dimensions)),this.trailsCanvas},StageMorph.prototype.penTrailsMorph=function(){var t=new Morph,e=this.penTrails();return t.bounds=this.bounds.copy(),t.image=newCanvas(this.extent()),t.image.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,this.image.width,this.image.height),t},StageMorph.prototype.colorFiltered=function(t,e){var o,i,r,n,s=new Morph,a=this.extent();for(i=normalizeCanvas(this.thumbnail(a,e),!0).getContext("2d").getImageData(0,0,a.x,a.y),s.bounds=this.bounds.copy(),s.image=newCanvas(a,!0),n=(o=s.image.getContext("2d")).createImageData(a.x,a.y),r=0;r<a.x*a.y*4;r+=4)new Color(i.data[r],i.data[r+1],i.data[r+2]).eq(t)&&(n.data[r]=i.data[r],n.data[r+1]=i.data[r+1],n.data[r+2]=i.data[r+2],n.data[r+3]=255);return o.putImageData(n,0,0),s},StageMorph.prototype.getPixelColor=function(t){var e,o,i;if(this.trailsCanvas)return e=t.subtract(this.bounds.origin),o=this.trailsCanvas.getContext("2d"),i=o.getImageData(e.x,e.y,1,1),0===i.data[3]?StageMorph.uber.getPixelColor.call(this,t):new Color(i.data[0],i.data[1],i.data[2],i.data[3]/255)},StageMorph.prototype.watchers=function(t){return this.children.filter(function(e){return e instanceof WatcherMorph&&(t?e.left()===t:e.isVisible)})},StageMorph.prototype.resetTimer=function(){this.timerStart=Date.now()},StageMorph.prototype.getTimer=function(){return Math.floor((Date.now()-this.timerStart)/100)/10},StageMorph.prototype.setTempo=function(t){this.tempo=Math.max(20,+t||0)},StageMorph.prototype.changeTempo=function(t){this.setTempo(this.getTempo()+(+t||0))},StageMorph.prototype.getTempo=function(){return+this.tempo},StageMorph.prototype.getLastMessage=function(){return this.lastMessage||""},StageMorph.prototype.reportMouseX=function(){var t=this.world();return t?(t.hand.position().x-this.center().x)/this.scale:0},StageMorph.prototype.reportMouseY=function(){var t=this.world();return t?(this.center().y-t.hand.position().y)/this.scale:0},StageMorph.prototype.wantsDropOf=function(t){return t instanceof SpriteMorph||t instanceof WatcherMorph||t instanceof ListWatcherMorph||t instanceof SpriteIconMorph},StageMorph.prototype.reactToDropOf=function(t,e){t instanceof SpriteIconMorph&&(t.object.anchor&&t.object.anchor.detachPart(t.object),this.world().add(t),t.slideBackTo(e.grabOrigin))},StageMorph.prototype.step=function(){var t,e,o=this.world();if(null===o.keyboardReceiver&&(o.keyboardReceiver=this),null===o.currentKey&&(this.keyPressed=null),this.enableCustomHatBlocks&&this.stepGenericConditions(),this.isFastTracked&&this.threads.processes.length){for(this.children.forEach(function(t){t instanceof SpriteMorph&&(t.wasWarped=t.isWarped,t.isWarped||t.startWarp())});Date.now()-this.lastTime<17;)this.threads.step();this.children.forEach(function(t){t instanceof SpriteMorph&&(t.wasWarped||t.endWarp())}),this.changed()}else this.threads.step(),this.threads.wantsToPause&&(e=this.parentThatIsA(IDE_Morph))&&e.controlBar.pauseButton.refresh();t=Date.now()-this.lastWatcherUpdate,1e3/this.watcherUpdateFrequency-t<1&&(this.watchers().forEach(function(t){t.update()}),this.lastWatcherUpdate=Date.now())},StageMorph.prototype.stepGenericConditions=function(t){var e,o=0,i=this;this.children.concat(this).forEach(function(e){isSnapObject(e)&&e.allGenericHatBlocks().forEach(function(r){o+=1,i.threads.doWhen(r,e,t)})}),o||(this.enableCustomHatBlocks=!1,(e=this.parentThatIsA(IDE_Morph))&&e.controlBar.stopButton.refresh())},StageMorph.prototype.developersMenu=function(){var t=this,e=StageMorph.uber.developersMenu.call(this);return e.addItem("stop",function(){t.threads.stopAll()},"terminate all running threads"),e},StageMorph.prototype.processKeyDown=function(t){this.processKeyEvent(t,this.fireKeyEvent)},StageMorph.prototype.processKeyUp=function(t){this.processKeyEvent(t,this.removePressedKey)},StageMorph.prototype.processKeyEvent=function(t,e){var o;switch(t.keyCode){case 13:o="enter",t.ctrlKey||t.metaKey?o="ctrl enter":t.shiftKey&&(o="shift enter");break;case 27:o="esc";break;case 32:o="space";break;case 37:o="left arrow";break;case 39:o="right arrow";break;case 38:o="up arrow";break;case 40:o="down arrow";break;default:o=String.fromCharCode(t.keyCode||t.charCode),(t.ctrlKey||t.metaKey)&&(o="ctrl "+(t.shiftKey?"shift ":"")+o)}e.call(this,o)},StageMorph.prototype.fireKeyEvent=function(t){var e=t.toLowerCase(),o=[],i=this.parentThatIsA(IDE_Morph),r=this;if(this.keysPressed[e]=!0,"ctrl enter"===e)return this.fireGreenFlagEvent();if("shift enter"===e)return this.editScripts();if("ctrl f"!==e)if("ctrl z"!==e)if("ctrl shift z"!==e&&"ctrl y"!==e)if("ctrl n"!==e)if("ctrl o"!==e)if("ctrl s"!==e){if("ctrl shift s"!==e)return"esc"===e?this.fireStopAllEvent():(this.children.concat(this).forEach(function(t){isSnapObject(t)&&t.allHatBlocksForKey(e).forEach(function(e){o.push(r.threads.startProcess(e,t,r.isThreadSafe))})}),o);if(!i.isAppMode)return i.saveProjectsBrowser()}else i.isAppMode||i.save();else i.isAppMode||i.openProjectsBrowser();else i.isAppMode||i.createNewProject();else i.isAppMode||i.currentSprite.scripts.redrop();else i.isAppMode||i.currentSprite.scripts.undrop();else i.isAppMode||i.currentSprite.searchBlocks()},StageMorph.prototype.removePressedKey=function(t){delete this.keysPressed[t.toLowerCase()]},StageMorph.prototype.processKeyPress=function(t){nop(t)},StageMorph.prototype.inspectKeyEvent=CursorMorph.prototype.inspectKeyEvent,StageMorph.prototype.fireGreenFlagEvent=function(){var t=[],e=this.parentThatIsA(IDE_Morph),o=this;return this.children.concat(this).forEach(function(e){isSnapObject(e)&&e.allHatBlocksFor("__shout__go__").forEach(function(i){t.push(o.threads.startProcess(i,e,o.isThreadSafe))})}),e&&e.controlBar.pauseButton.refresh(),t},StageMorph.prototype.fireStopAllEvent=function(){var t=this.parentThatIsA(IDE_Morph);this.threads.resumeAll(this.stage),this.keysPressed={},this.threads.stopAll(),this.stopAllActiveSounds(),this.children.forEach(function(t){t.stopTalking&&t.stopTalking()}),this.removeAllClones(),t&&t.nextSteps([nop,function(){t.controlBar.pauseButton.refresh()}])},StageMorph.prototype.removeAllClones=function(){var t=this;this.children.filter(function(t){return t instanceof SpriteMorph&&t.isTemporary}).forEach(function(e){t.threads.stopAllForReceiver(e),e.detachFromAnchor(),e.corpsify(),e.destroy()}),this.cloneCount=0},StageMorph.prototype.editScripts=function(){var t,e;!this.parentThatIsA(IDE_Morph).isAppMode&&ScriptsMorph.prototype.enableKeyboard&&((t=this.parentThatIsA(IDE_Morph).currentSprite.scripts.selectForEdit()).edit(t.position()),(e=t.focus.sortedScripts()).length?(t.focus.element=e[0],t.focus.element instanceof HatBlockMorph&&t.focus.nextCommand()):t.focus.moveBy(new Point(50,50)),t.focus.fixLayout())},StageMorph.prototype.blockTemplates=function(t){function e(t){if(p.hiddenPrimitives[t])return null;var e=SpriteMorph.prototype.blockForSelector(t,!0);return e.isTemplate=!0,e}function o(t){var e=SpriteMorph.prototype.variableBlock(t);return e.isDraggable=!1,e.isTemplate=!0,e}function i(t){if(p.hiddenPrimitives[t])return null;var e=SpriteMorph.prototype.blocks[t];return new ToggleMorph("checkbox",this,function(){p.toggleWatcher(t,localize(e.spec),p.blockColor[e.category])},null,function(){return p.showingWatcher(t)},null)}function r(t){return new ToggleMorph("checkbox",this,function(){p.toggleVariableWatcher(t)},null,function(){return p.showingVariableWatcher(t)},null)}function n(t){t&&(p.isVariableNameInUse(t[0])?p.inform("that name is already in use"):(p.addVariable(t[0],t[1]),p.toggleVariableWatcher(t[0],t[1]),p.blocksCache[c]=null,p.paletteCache[c]=null,p.parentThatIsA(IDE_Morph).refreshPalette()))}var s,a,h,l=[],p=this,c=t||"motion";return"motion"===c?((h=new TextMorph(localize("Stage selected:\nno motion primitives"))).fontSize=9,h.setColor(this.paletteTextColor),l.push(h),l.push("="),l.push(this.makeBlockButton(c))):"looks"===c?(l.push(e("doSwitchToCostume")),l.push(e("doWearNextCostume")),l.push(i("getCostumeIdx")),l.push(e("getCostumeIdx")),l.push("-"),l.push(e("changeEffect")),l.push(e("setEffect")),l.push(e("clearEffects")),l.push("-"),l.push(e("show")),l.push(e("hide")),this.world().isDevMode&&(l.push("-"),(h=new TextMorph(localize("development mode \ndebugging primitives:"))).fontSize=9,h.setColor(this.paletteTextColor),l.push(h),l.push("-"),l.push(e("log")),l.push(e("alert")),l.push("-"),l.push(e("doScreenshot"))),l.push("="),l.push(this.makeBlockButton(c))):"sound"===c?(l.push(e("playSound")),l.push(e("doPlaySoundUntilDone")),l.push(e("doStopAllSounds")),l.push("-"),l.push(e("doRest")),l.push(e("doPlayNote")),l.push(e("doSetInstrument")),l.push("-"),l.push(e("doChangeTempo")),l.push(e("doSetTempo")),l.push(i("getTempo")),l.push(e("getTempo")),l.push("="),l.push(this.makeBlockButton(c))):"pen"===c?(l.push(e("clear")),l.push(e("reportPenTrailsAsCostume")),l.push("="),l.push(this.makeBlockButton(c))):"control"===c?(l.push(e("receiveGo")),l.push(e("receiveKey")),l.push(e("receiveInteraction")),l.push(e("receiveCondition")),l.push(e("receiveMessage")),l.push("-"),l.push(e("doBroadcast")),l.push(e("doBroadcastAndWait")),l.push(i("getLastMessage")),l.push(e("getLastMessage")),l.push("-"),l.push(e("doWarp")),l.push("-"),l.push(e("doWait")),l.push(e("doWaitUntil")),l.push("-"),l.push(e("doForever")),l.push(e("doRepeat")),l.push(e("doUntil")),l.push("-"),l.push(e("doIf")),l.push(e("doIfElse")),l.push("-"),l.push(e("doReport")),l.push(e("doStopThis")),l.push(e("doStopOthers")),l.push("-"),l.push(e("doRun")),l.push(e("fork")),l.push(e("evaluate")),l.push("-"),l.push(e("doTellTo")),l.push(e("reportAskFor")),l.push("-"),l.push(e("doCallCC")),l.push(e("reportCallCC")),l.push("-"),l.push(e("createClone")),l.push(e("newClone")),l.push("-"),l.push(e("doPauseAll")),l.push("="),l.push(this.makeBlockButton(c))):"sensing"===c?(l.push(e("doAsk")),l.push(i("getLastAnswer")),l.push(e("getLastAnswer")),l.push("-"),l.push(i("reportMouseX")),l.push(e("reportMouseX")),l.push(i("reportMouseY")),l.push(e("reportMouseY")),l.push(e("reportMouseDown")),l.push("-"),l.push(e("reportKeyPressed")),l.push("-"),l.push(e("doResetTimer")),l.push(i("getTimer")),l.push(e("getTimer")),l.push("-"),l.push(e("reportAttributeOf")),SpriteMorph.prototype.enableFirstClass&&l.push(e("reportGet")),l.push("-"),l.push(e("reportURL")),l.push("-"),l.push(e("reportIsFastTracking")),l.push(e("doSetFastTracking")),l.push("-"),l.push(e("reportDate")),this.world().isDevMode&&(l.push("-"),(h=new TextMorph(localize("development mode \ndebugging primitives:"))).fontSize=9,h.setColor(this.paletteTextColor),l.push(h),l.push("-"),l.push(i("reportThreadCount")),l.push(e("reportThreadCount")),l.push(e("colorFiltered")),l.push(e("reportStackSize")),l.push(e("reportFrameCount"))),l.push("="),l.push(this.makeBlockButton(c))):"operators"===c?(l.push(e("reifyScript")),l.push(e("reifyReporter")),l.push(e("reifyPredicate")),l.push("#"),l.push("-"),l.push(e("reportSum")),l.push(e("reportDifference")),l.push(e("reportProduct")),l.push(e("reportQuotient")),l.push("-"),l.push(e("reportModulus")),l.push(e("reportRound")),l.push(e("reportMonadic")),l.push(e("reportRandom")),l.push("-"),l.push(e("reportLessThan")),l.push(e("reportEquals")),l.push(e("reportGreaterThan")),l.push("-"),l.push(e("reportAnd")),l.push(e("reportOr")),l.push(e("reportNot")),l.push(e("reportBoolean")),l.push("-"),l.push(e("reportJoinWords")),l.push(e("reportTextSplit")),l.push(e("reportLetter")),l.push(e("reportStringSize")),l.push("-"),l.push(e("reportUnicode")),l.push(e("reportUnicodeAsLetter")),l.push("-"),l.push(e("reportIsA")),l.push(e("reportIsIdentical")),l.push("-"),l.push(e("reportJSFunction")),this.world().isDevMode&&(l.push("-"),(h=new TextMorph("development mode \ndebugging primitives:")).fontSize=9,h.setColor(this.paletteTextColor),l.push(h),l.push("-"),l.push(e("reportTypeOf")),l.push(e("reportTextFunction"))),l.push("="),l.push(this.makeBlockButton(c))):"variables"===c&&(a=new PushButtonMorph(null,function(){new VariableDialogMorph(null,n,p).prompt("Variable name",null,p.world())},"Make a variable"),l.push(a),this.variables.allNames().length>0&&(a=new PushButtonMorph(null,function(){var t=new MenuMorph(p.deleteVariable,null,p);p.variables.allNames().forEach(function(e){t.addItem(e,e)}),t.popUpAtHand(p.world())},"Delete a variable"),l.push(a)),l.push("-"),(s=this.variables.allNames()).length>0&&(s.forEach(function(t){l.push(r(t)),l.push(o(t))}),l.push("-")),l.push(e("doSetVar")),l.push(e("doChangeVar")),l.push(e("doShowVar")),l.push(e("doHideVar")),l.push(e("doDeclareVariables")),l.push("="),l.push(e("reportNewList")),l.push("-"),l.push(e("reportCONS")),l.push(e("reportListItem")),l.push(e("reportCDR")),l.push("-"),l.push(e("reportListLength")),l.push(e("reportListContainsItem")),l.push("-"),l.push(e("doAddToList")),l.push(e("doDeleteFromList")),l.push(e("doInsertInList")),l.push(e("doReplaceInList")),this.world().isDevMode&&(l.push("-"),(h=new TextMorph(localize("development mode \ndebugging primitives:"))).fontSize=9,h.setColor(this.paletteTextColor),l.push(h),l.push("-"),l.push(e("reportMap")),l.push("-"),l.push(e("doForEach")),l.push(e("doShowTable"))),l.push("="),StageMorph.prototype.enableCodeMapping&&(l.push(e("doMapCodeOrHeader")),l.push(e("doMapValueCode")),l.push(e("doMapListCode")),l.push("-"),l.push(e("reportMappedCode")),l.push("=")),l.push(this.makeBlockButton())),l},StageMorph.prototype.clear=function(){this.clearPenTrails()},StageMorph.prototype.userMenu=function(){var t=this.parentThatIsA(IDE_Morph),e=new MenuMorph(this),o=this;return t&&t.isAppMode?e:(e.addItem("edit","edit"),e.addItem("show all","showAll"),e.addItem("pic...",function(){t.saveCanvasAs(o.fullImageClassic(),o.name)},"open a new window\nwith a picture of the stage"),e.addLine(),e.addItem("pen trails",function(){var e=t.currentSprite.reportPenTrailsAsCostume().copy();t.currentSprite.addCostume(e),t.currentSprite.wearCostume(e),t.hasChangedMedia=!0,t.spriteBar.tabBar.tabTo("costumes")},t.currentSprite instanceof SpriteMorph?"turn all pen trails and stamps\ninto a new costume for the\ncurrently selected sprite":"turn all pen trails and stamps\ninto a new background for the stage"),e)},StageMorph.prototype.showAll=function(){var t=this;this.children.forEach(function(e){e instanceof SpriteMorph?e.anchor||(e.show(),e.keepWithin(t)):(e.show(),e.keepWithin(t),e.fixLayout&&e.fixLayout())})},StageMorph.prototype.edit=SpriteMorph.prototype.edit,StageMorph.prototype.thumbnail=function(t,e){var o,i,r=this,n=this.image,s=Math.min(t.x/n.width,t.y/n.height),a=newCanvas(t),h=a.getContext("2d");return h.scale(s,s),h.drawImage(n,0,0),h.drawImage(this.penTrails(),0,0,this.dimensions.x*this.scale,this.dimensions.y*this.scale),this.children.forEach(function(t){t.isVisible&&t!==e&&(o=t.fullBounds(),(i=t.fullImage()).width&&i.height&&h.drawImage(t.fullImage(),o.origin.x-r.bounds.origin.x,o.origin.y-r.bounds.origin.y))}),a},StageMorph.prototype.hide=function(){this.isVisible=!1,this.changed()},StageMorph.prototype.show=function(){this.isVisible=!0,this.changed()},StageMorph.prototype.createClone=nop,StageMorph.prototype.newClone=nop,StageMorph.prototype.categories=SpriteMorph.prototype.categories,StageMorph.prototype.blockColor=SpriteMorph.prototype.blockColor,StageMorph.prototype.paletteColor=SpriteMorph.prototype.paletteColor,StageMorph.prototype.setName=SpriteMorph.prototype.setName,StageMorph.prototype.makeBlockButton=SpriteMorph.prototype.makeBlockButton,StageMorph.prototype.makeBlock=SpriteMorph.prototype.makeBlock,StageMorph.prototype.palette=SpriteMorph.prototype.palette,StageMorph.prototype.freshPalette=SpriteMorph.prototype.freshPalette,StageMorph.prototype.blocksMatching=SpriteMorph.prototype.blocksMatching,StageMorph.prototype.searchBlocks=SpriteMorph.prototype.searchBlocks,StageMorph.prototype.reporterize=SpriteMorph.prototype.reporterize,StageMorph.prototype.showingWatcher=SpriteMorph.prototype.showingWatcher,StageMorph.prototype.addVariable=SpriteMorph.prototype.addVariable,StageMorph.prototype.deleteVariable=SpriteMorph.prototype.deleteVariable,StageMorph.prototype.doScreenshot=SpriteMorph.prototype.doScreenshot,StageMorph.prototype.newCostumeName=SpriteMorph.prototype.newCostumeName,StageMorph.prototype.blockForSelector=SpriteMorph.prototype.blockForSelector,StageMorph.prototype.findVariableWatcher=SpriteMorph.prototype.findVariableWatcher,StageMorph.prototype.toggleVariableWatcher=SpriteMorph.prototype.toggleVariableWatcher,StageMorph.prototype.showingVariableWatcher=SpriteMorph.prototype.showingVariableWatcher,StageMorph.prototype.deleteVariableWatcher=SpriteMorph.prototype.deleteVariableWatcher,StageMorph.prototype.addCostume=SpriteMorph.prototype.addCostume,StageMorph.prototype.wearCostume=SpriteMorph.prototype.wearCostume,StageMorph.prototype.getCostumeIdx=SpriteMorph.prototype.getCostumeIdx,StageMorph.prototype.doWearNextCostume=SpriteMorph.prototype.doWearNextCostume,StageMorph.prototype.doWearPreviousCostume=SpriteMorph.prototype.doWearPreviousCostume,StageMorph.prototype.doSwitchToCostume=SpriteMorph.prototype.doSwitchToCostume,StageMorph.prototype.reportCostumes=SpriteMorph.prototype.reportCostumes,StageMorph.prototype.graphicsChanged=SpriteMorph.prototype.graphicsChanged,StageMorph.prototype.applyGraphicsEffects=SpriteMorph.prototype.applyGraphicsEffects,StageMorph.prototype.setEffect=SpriteMorph.prototype.setEffect,StageMorph.prototype.getGhostEffect=SpriteMorph.prototype.getGhostEffect,StageMorph.prototype.changeEffect=SpriteMorph.prototype.changeEffect,StageMorph.prototype.clearEffects=SpriteMorph.prototype.clearEffects,StageMorph.prototype.addSound=SpriteMorph.prototype.addSound,StageMorph.prototype.playSound=SpriteMorph.prototype.playSound,StageMorph.prototype.stopAllActiveSounds=function(){this.activeSounds.forEach(function(t){t.pause()}),this.activeSounds=[]},StageMorph.prototype.pauseAllActiveSounds=function(){this.activeSounds.forEach(function(t){t.pause()})},StageMorph.prototype.resumeAllActiveSounds=function(){this.activeSounds.forEach(function(t){t.play()})},StageMorph.prototype.reportSounds=SpriteMorph.prototype.reportSounds,StageMorph.prototype.toggleWatcher=SpriteMorph.prototype.toggleWatcher,StageMorph.prototype.showingWatcher=SpriteMorph.prototype.showingWatcher,StageMorph.prototype.watcherFor=SpriteMorph.prototype.watcherFor,StageMorph.prototype.getLastAnswer=SpriteMorph.prototype.getLastAnswer,StageMorph.prototype.reportThreadCount=SpriteMorph.prototype.reportThreadCount,StageMorph.prototype.allMessageNames=SpriteMorph.prototype.allMessageNames,StageMorph.prototype.allHatBlocksFor=SpriteMorph.prototype.allHatBlocksFor,StageMorph.prototype.allHatBlocksForKey=SpriteMorph.prototype.allHatBlocksForKey,StageMorph.prototype.allHatBlocksForInteraction=SpriteMorph.prototype.allHatBlocksForInteraction,StageMorph.prototype.allGenericHatBlocks=SpriteMorph.prototype.allGenericHatBlocks,StageMorph.prototype.mouseClickLeft=SpriteMorph.prototype.mouseClickLeft,StageMorph.prototype.mouseEnter=SpriteMorph.prototype.mouseEnter,StageMorph.prototype.mouseLeave=function(){this.receiveUserInteraction("mouse-departed")},StageMorph.prototype.mouseDownLeft=SpriteMorph.prototype.mouseDownLeft,StageMorph.prototype.receiveUserInteraction=SpriteMorph.prototype.receiveUserInteraction,StageMorph.prototype.deleteAllBlockInstances=SpriteMorph.prototype.deleteAllBlockInstances,StageMorph.prototype.allBlockInstances=SpriteMorph.prototype.allBlockInstances,StageMorph.prototype.allLocalBlockInstances=SpriteMorph.prototype.allLocalBlockInstances,StageMorph.prototype.allEditorBlockInstances=SpriteMorph.prototype.allEditorBlockInstances,StageMorph.prototype.paletteBlockInstance=SpriteMorph.prototype.paletteBlockInstance,StageMorph.prototype.usesBlockInstance=SpriteMorph.prototype.usesBlockInstance,StageMorph.prototype.doubleDefinitionsFor=SpriteMorph.prototype.doubleDefinitionsFor,StageMorph.prototype.replaceDoubleDefinitionsFor=SpriteMorph.prototype.replaceDoubleDefinitionsFor,StageMorph.prototype.allInvocationsOf=SpriteMorph.prototype.allInvocationsOf,StageMorph.prototype.allIndependentInvocationsOf=SpriteMorph.prototype.allInvocationsOf,StageMorph.prototype.allDependentInvocationsOf=SpriteMorph.prototype.allInvocationsOf,StageMorph.prototype.specimens=function(){return[]},StageMorph.prototype.allSpecimens=function(){return[]},StageMorph.prototype.shadowAttribute=nop,StageMorph.prototype.inheritsAttribute=function(){return!1},StageMorph.prototype.isVariableNameInUse=SpriteMorph.prototype.isVariableNameInUse,StageMorph.prototype.globalVariables=SpriteMorph.prototype.globalVariables,StageMorph.prototype.inheritedVariableNames=function(){return[]},StageMorph.prototype.getMethod=SpriteMorph.prototype.getMethod,StageMorph.prototype.getLocalMethod=SpriteMorph.prototype.getLocalMethod,StageMorph.prototype.ownBlocks=SpriteMorph.prototype.ownBlocks,StageMorph.prototype.allBlocks=function(t){var e=this.ownBlocks();return t?Object.keys(e).map(function(t){return e[t]}):e},StageMorph.prototype.inheritedBlocks=function(){return[]},StageMorph.prototype.hasSpriteVariable=SpriteMorph.prototype.hasSpriteVariable,StageMorph.prototype.refactorVariableInstances=SpriteMorph.prototype.refactorVariableInstances,StageMorph.prototype.reportPenTrailsAsCostume=function(){return new Costume(this.trailsCanvas,this.newCostumeName(localize("Background")))},SpriteBubbleMorph.prototype=new SpeechBubbleMorph,SpriteBubbleMorph.prototype.constructor=SpriteBubbleMorph,SpriteBubbleMorph.uber=SpeechBubbleMorph.prototype,SpriteBubbleMorph.prototype.init=function(t,e,o,i){var r=SpriteMorph.prototype;this.stage=e,this.scale=e?e.scale:1,this.data=t,this.isQuestion=i,SpriteBubbleMorph.uber.init.call(this,this.dataAsMorph(t),r.bubbleColor,null,null,i?r.blockColor.sensing:r.bubbleBorderColor,null,o)},SpriteBubbleMorph.prototype.dataAsMorph=function(t,e){var o,i,r,n,s,a=SpriteMorph.prototype;return t instanceof Morph?isSnapObject(t)?(r=t.thumbnail(new Point(40,40)),(o=new Morph).silentSetWidth(r.width),o.silentSetHeight(r.height),o.image=r,o.version=t.version,o.step=function(){this.version!==t.version&&(r=t.thumbnail(new Point(40,40)),this.image=r,this.version=t.version,this.changed())}):o=t:isString(t)?(i=!0,o=new TextMorph(t,a.bubbleFontSize*this.scale,null,a.bubbleFontIsBold,!1,"center")):"boolean"==typeof t?(r=a.booleanMorph(t).fullImage(),(o=new Morph).silentSetWidth(r.width),o.silentSetHeight(r.height),o.image=r):t instanceof Costume?(r=t.thumbnail(new Point(40,40)),(o=new Morph).silentSetWidth(r.width),o.silentSetHeight(r.height),o.image=r):t instanceof Sound?o=new SymbolMorph("notes",30):t instanceof HTMLCanvasElement?((o=new Morph).silentSetWidth(t.width),o.silentSetHeight(t.height),o.image=t):t instanceof List?((e&&this.contentsMorph?this.contentsMorph instanceof ListWatcherMorph:t.isTable())?(o=new TableFrameMorph(new TableMorph(t,10)),this.stage&&o.expand(this.stage.extent().translateBy(-2*(this.edge+this.border+this.padding)))):((o=new ListWatcherMorph(t)).update(!0),o.step=o.update,this.stage&&o.expand(this.stage.extent().translateBy(-2*(this.edge+this.border+this.padding)))),o.isDraggable=!1):t instanceof Context?(r=t.image(),(o=new Morph).silentSetWidth(r.width),o.silentSetHeight(r.height),o.image=r):o=new TextMorph(t.toString(),a.bubbleFontSize*this.scale,null,a.bubbleFontIsBold,!1,"center"),o instanceof TextMorph?(s=Math.max(o.width(),2*a.bubbleCorner*this.scale),i&&(s=Math.min(s,a.bubbleMaxTextWidth*this.scale)),o.setWidth(s)):t instanceof List||((n=newCanvas(o.extent().multiplyBy(this.scale))).getContext("2d").drawImage(o.image,0,0,n.width,n.height),o.image=n,o.bounds=o.bounds.scaleBy(this.scale)),o},SpriteBubbleMorph.prototype.setScale=function(t){this.scale=t,this.changed(),this.drawNew(),this.changed()},SpriteBubbleMorph.prototype.drawNew=function(t){var e=SpriteMorph.prototype;this.edge=e.bubbleCorner*this.scale,this.border=e.bubbleBorder*this.scale,this.padding=e.bubbleCorner/2*this.scale,this.contentsMorph&&this.contentsMorph.destroy(),this.contentsMorph=this.dataAsMorph(this.data,t),this.add(this.contentsMorph),this.silentSetWidth(this.contentsMorph.width()+(this.padding?2*this.padding:2*this.edge)),this.silentSetHeight(this.contentsMorph.height()+this.edge+2*this.border+2*this.padding+2),SpeechBubbleMorph.uber.drawNew.call(this),this.contentsMorph.setPosition(this.position().add(new Point(this.padding||this.edge,this.border+this.padding+1)))},SpriteBubbleMorph.prototype.fixLayout=function(){var t=SpriteMorph.prototype;this.changed(),this.edge=t.bubbleCorner*this.scale,this.border=t.bubbleBorder*this.scale,this.padding=t.bubbleCorner/2*this.scale,this.silentSetWidth(this.contentsMorph.width()+(this.padding?2*this.padding:2*this.edge)),this.silentSetHeight(this.contentsMorph.height()+this.edge+2*this.border+2*this.padding+2),SpeechBubbleMorph.uber.drawNew.call(this),this.contentsMorph.setPosition(this.position().add(new Point(this.padding||this.edge,this.border+this.padding+1))),this.changed()},Costume.prototype.maxExtent=function(){return StageMorph.prototype.dimensions},Costume.prototype.toString=function(){return"a Costume("+this.name+")"},Costume.prototype.extent=function(){return new Point(this.contents.width,this.contents.height)},Costume.prototype.center=function(){return this.extent().divideBy(2)},Costume.prototype.width=function(){return this.contents.width},Costume.prototype.height=function(){return this.contents.height},Costume.prototype.bounds=function(){return new Rectangle(0,0,this.width(),this.height())},Costume.prototype.shrinkWrap=function(){var t=this.boundingBox(),e=t.extent(),o=newCanvas(e,!0);o.getContext("2d").drawImage(this.contents,t.origin.x,t.origin.y,e.x,e.y,0,0,e.x,e.y),this.rotationCenter=this.rotationCenter.subtract(t.origin),this.contents=o,this.version=Date.now()},Costume.prototype.canvasBoundingBox=function(t){function e(t,e){return s.data[e*r*4+4*t+3]}var o,i,r=t.width,n=t.height,s=t.getContext("2d").getImageData(0,0,r,n);return new Rectangle(function(){for(i=0;i<=r;i+=1)for(o=0;o<=n;o+=1)if(e(i,o))return i;return 0}(),function(){for(o=0;o<=n;o+=1)for(i=0;i<=r;i+=1)if(e(i,o))return o;return 0}(),function(){for(i=r;i>=0;i-=1)for(o=n;o>=0;o-=1)if(e(i,o))return Math.min(i+1,r);return r}(),function(){for(o=n;o>=0;o-=1)for(i=r;i>=0;i-=1)if(e(i,o))return Math.min(o+1,n);return n}())},Costume.prototype.boundingBox=function(){return this.canvasBoundingBox(this.contents)},Costume.prototype.copy=function(){var t,e=newCanvas(this.extent(),!0);return e.getContext("2d").drawImage(this.contents,0,0),t=new Costume(e,this.name?copy(this.name):null),t.rotationCenter=this.rotationCenter.copy(),t},Costume.prototype.flipped=function(){var t=newCanvas(this.extent(),!0),e=t.getContext("2d");return e.translate(this.width(),0),e.scale(-1,1),e.drawImage(this.contents,0,0),new Costume(t,this.name,new Point(this.width()-this.rotationCenter.x,this.rotationCenter.y))},Costume.prototype.edit=function(t,e,o,i,r){var n=this,s=new PaintEditorMorph;s.oncancel=i||nop,s.openIn(t,o?newCanvas(StageMorph.prototype.dimensions,!0):this.contents,o?null:this.rotationCenter,function(o,i){n.contents=o,n.rotationCenter=i,n.version=Date.now(),t.changed(),e&&(e.currentSprite instanceof SpriteMorph&&n.shrinkWrap(),e.currentSprite.wearCostume(n,!0),e.hasChangedMedia=!0),(r||nop)()})},Costume.prototype.editRotationPointOnly=function(t){var e,o,i=new CostumeEditorMorph(this);e=new DialogBoxMorph(this,function(){i.accept()}),o=new TextMorph(localize("click or drag crosshairs to move the rotation center"),e.fontSize,e.fontStyle,!0,!1,"center",null,null,new Point(1,1),new Color(255,255,255)),e.labelString="Costume Editor",e.createLabel(),e.setPicture(i),e.addBody(o),e.addButton("ok","Ok"),e.addButton("cancel","Cancel"),e.fixLayout(),e.drawNew(),e.fixLayout(),e.popUp(t)},Costume.prototype.shrinkToFit=function(t){(t.x<this.width()||t.y<this.height())&&(this.contents=this.thumbnail(t))},Costume.prototype.thumbnail=function(t){var e=this.contents,o=Math.min(t.x/e.width,t.y/e.height),i=(t.x-e.width*o)/2,r=(t.y-e.height*o)/2,n=newCanvas(t),s=n.getContext("2d");return e&&e.width+e.height!==0?(s.scale(o,o),s.drawImage(e,Math.floor(i/o),Math.floor(r/o)),n):n},Costume.prototype.isTainted=function(){try{this.contents.getContext("2d").getImageData(0,0,this.contents.width,this.contents.height)}catch(t){return!0}return!1},SVG_Costume.prototype=new Costume,SVG_Costume.prototype.constructor=SVG_Costume,SVG_Costume.uber=Costume.prototype,SVG_Costume.prototype.toString=function(){return"an SVG_Costume("+this.name+")"},SVG_Costume.prototype.copy=function(){var t,e=new Image;return e.src=this.contents.src,t=new SVG_Costume(e,this.name?copy(this.name):null),t.rotationCenter=this.rotationCenter.copy(),t},SVG_Costume.prototype.shrinkToFit=function(t){nop(t)},CostumeEditorMorph.prototype=new Morph,CostumeEditorMorph.prototype.constructor=CostumeEditorMorph,CostumeEditorMorph.uber=Morph.prototype,CostumeEditorMorph.prototype.size=Costume.prototype.maxExtent(),CostumeEditorMorph.prototype.init=function(t){this.costume=t||new Costume,this.rotationCenter=this.costume.rotationCenter.copy(),this.margin=new Point(0,0),CostumeEditorMorph.uber.init.call(this),this.noticesTransparentClick=!0},CostumeEditorMorph.prototype.accept=function(){this.costume.rotationCenter=this.rotationCenter.copy(),this.costume.version=Date.now()},CostumeEditorMorph.prototype.drawNew=function(){var t,e;this.margin=this.size.subtract(this.costume.extent()).divideBy(2),t=this.rotationCenter.add(this.margin),this.silentSetExtent(this.size),this.image=newCanvas(this.extent()),this.cachedTexture||(this.cachedTexture=this.createTexture()),this.drawCachedTexture(),(e=this.image.getContext("2d")).drawImage(this.costume.contents,this.margin.x,this.margin.y),e.globalAlpha=.5,e.fillStyle="white",e.beginPath(),e.arc(t.x,t.y,20,radians(0),radians(360),!1),e.closePath(),e.fill(),e.stroke(),e.beginPath(),e.arc(t.x,t.y,10,radians(0),radians(360),!1),e.stroke(),e.beginPath(),e.moveTo(0,t.y),e.lineTo(this.costume.width()+2*this.margin.x,t.y),e.stroke(),e.beginPath(),e.moveTo(t.x,0),e.lineTo(t.x,this.costume.height()+2*this.margin.y),e.stroke()},CostumeEditorMorph.prototype.createTexture=function(){var t=newCanvas(new Point(10,10)),e=t.getContext("2d"),o=new Color(230,230,230);return e.fillStyle="white",e.fillRect(0,0,10,10),e.fillStyle=o.toString(),e.fillRect(0,0,5,5),e.fillRect(5,5,5,5),t},CostumeEditorMorph.prototype.mouseDownLeft=function(t){this.rotationCenter=t.subtract(this.position().add(this.margin)),this.drawNew(),this.changed()},CostumeEditorMorph.prototype.mouseMove=CostumeEditorMorph.prototype.mouseDownLeft,Sound.prototype.play=function(){var t=document.createElement("audio");return t.src=this.audio.src,t.play(),t},Sound.prototype.copy=function(){var t=document.createElement("audio");return t.src=this.audio.src,new Sound(t,this.name?copy(this.name):null)},Sound.prototype.toDataURL=function(){return this.audio.src},Note.prototype.audioContext=null,Note.prototype.gainNode=null,Note.prototype.setupContext=function(){if(!this.audioContext){var t=function(){var t=window.AudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext||window.webkitAudioContext;return t.prototype.createGain||(t.prototype.createGain=t.prototype.createGainNode),t}();if(!t)throw new Error("Web Audio API is not supported\nin this browser");Note.prototype.audioContext=new t,Note.prototype.gainNode=Note.prototype.audioContext.createGain(),Note.prototype.gainNode.gain.value=.25}},Note.prototype.play=function(t){this.oscillator=this.audioContext.createOscillator(),this.oscillator.start||(this.oscillator.start=this.oscillator.noteOn),this.oscillator.stop||(this.oscillator.stop=this.oscillator.noteOff),this.oscillator.type=["sine","square","sawtooth","triangle"][(t||1)-1],this.oscillator.frequency.value=440*Math.pow(2,(this.pitch-69)/12),this.oscillator.connect(this.gainNode),this.gainNode.connect(this.audioContext.destination),this.oscillator.start(0)},Note.prototype.stop=function(){this.oscillator&&(this.oscillator.stop(0),this.oscillator=null)},CellMorph.prototype=new BoxMorph,CellMorph.prototype.constructor=CellMorph,CellMorph.uber=BoxMorph.prototype,CellMorph.prototype.init=function(t,e,o,i){this.contents=0===t?0:!1!==t&&(t||""),this.isEditable=!isNil(o),this.idx=o||null,this.parentCell=i||null,CellMorph.uber.init.call(this,SyntaxElementMorph.prototype.corner,1.000001,new Color(255,255,255)),this.color=e||new Color(255,140,0),this.isBig=!1,this.version=null,this.drawNew()},CellMorph.prototype.big=function(){this.isBig=!0,this.changed(),this.drawNew(),this.changed()},CellMorph.prototype.normal=function(){this.isBig=!1,this.changed(),this.drawNew(),this.changed()},CellMorph.prototype.isCircular=function(t){return!!this.parentCell&&(t instanceof List?this.contents===t||this.parentCell.isCircular(t):this.parentCell.isCircular(this.contents))},CellMorph.prototype.fixLayout=function(){var t;this.changed(),this.drawNew(),this.changed(),this.parent&&this.parent.fixLayout?this.parent.fixLayout():(t=this.parentThatIsA(ListWatcherMorph))&&t.fixLayout()},CellMorph.prototype.update=function(){isSnapObject(this.contents)&&this.version!==this.contents.version&&this.drawNew()},CellMorph.prototype.drawNew=function(t,e){var o,i,r,n=SyntaxElementMorph.prototype.fontSize,s=this.contentsMorph instanceof ListWatcherMorph&&this.contentsMorph.list===this.contents,a=this.contentsMorph instanceof TableFrameMorph&&this.contentsMorph.tableMorph.table===this.contents;if(this.isBig&&(n*=1.5),(t||this.contentsMorph&&!s&&!a)&&(this.contentsMorph.destroy(),this.version=null),(t||!s&&!a)&&(this.contents instanceof Morph?isSnapObject(this.contents)?(r=this.contents.thumbnail(new Point(40,40)),this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(r.width),this.contentsMorph.silentSetHeight(r.height),this.contentsMorph.image=r,this.version=this.contents.version):this.contentsMorph=this.contents:isString(this.contents)?(i=this.contents.length>500?this.contents.slice(0,500)+"...":this.contents,this.contentsMorph=new TextMorph(i,n,null,!0,!1,"left"),this.isEditable&&(this.contentsMorph.isEditable=!0,this.contentsMorph.enableSelecting()),this.contentsMorph.setColor(new Color(255,255,255))):"boolean"==typeof this.contents?(r=SpriteMorph.prototype.booleanMorph.call(null,this.contents).fullImage(),this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(r.width),this.contentsMorph.silentSetHeight(r.height),this.contentsMorph.image=r):this.contents instanceof HTMLCanvasElement?(this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(this.contents.width),this.contentsMorph.silentSetHeight(this.contents.height),this.contentsMorph.image=this.contents):this.contents instanceof Context?(r=this.contents.image(),this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(r.width),this.contentsMorph.silentSetHeight(r.height),this.contentsMorph.image=r):this.contents instanceof Costume?(r=this.contents.thumbnail(new Point(40,40)),this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(r.width),this.contentsMorph.silentSetHeight(r.height),this.contentsMorph.image=r):this.contents instanceof Sound?this.contentsMorph=new SymbolMorph("notes",30):this.contents instanceof List?("table"===e||!t&&this.contents.isTable()?(this.contentsMorph=new TableFrameMorph(new TableMorph(this.contents,10)),this.contentsMorph.expand(new Point(200,150))):this.isCircular()?(this.contentsMorph=new TextMorph("(...)",n,null,!1,!0,"center"),this.contentsMorph.setColor(new Color(255,255,255))):this.contentsMorph=new ListWatcherMorph(this.contents,this),this.contentsMorph.isDraggable=!1):(this.contentsMorph=new TextMorph(isNil(this.contents)?"":this.contents.toString(),n,null,!0,!1,"center"),this.isEditable&&(this.contentsMorph.isEditable=!0,this.contentsMorph.enableSelecting()),this.contentsMorph.setColor(new Color(255,255,255))),this.add(this.contentsMorph)),this.silentSetHeight(this.contentsMorph.height()+this.edge+2*this.border),this.silentSetWidth(Math.max(this.contentsMorph.width()+2*this.edge,this.contents instanceof Context||this.contents instanceof List?0:3.5*SyntaxElementMorph.prototype.fontSize)),this.image=newCanvas(this.extent()),o=this.image.getContext("2d"),0===this.edge&&0===this.border)return BoxMorph.uber.drawNew.call(this),null;o.fillStyle=this.color.toString(),o.beginPath(),this.outlinePath(o,Math.max(this.edge-this.border,0),this.border),o.closePath(),o.fill(),this.border>0&&!MorphicPreferences.isFlat&&(o.lineWidth=this.border,o.strokeStyle=this.borderColor.toString(),o.beginPath(),this.outlinePath(o,this.edge,this.border/2),o.closePath(),o.stroke(),o.shadowOffsetX=this.border,o.shadowOffsetY=this.border,o.shadowBlur=this.border,o.shadowColor=this.color.darker(80).toString(),this.drawShadow(o,this.edge,this.border/2)),(t||!s&&!a)&&this.contentsMorph.setCenter(this.center())},CellMorph.prototype.drawShadow=function(t,e,o){var i=e+o,r=this.width(),n=this.height();t.beginPath(),t.moveTo(0,n-i),t.lineTo(0,i),t.stroke(),t.beginPath(),t.arc(i,i,e,radians(-180),radians(-90),!1),t.stroke(),t.beginPath(),t.moveTo(i,0),t.lineTo(r-i,0),t.stroke()},CellMorph.prototype.layoutChanged=function(){var t,e=SyntaxElementMorph.prototype.fontSize,o=this.parentThatIsA(ListWatcherMorph);if(this.isBig&&(e*=1.5),this.silentSetHeight(this.contentsMorph.height()+this.edge+2*this.border),this.silentSetWidth(Math.max(this.contentsMorph.width()+2*this.edge,this.contents instanceof Context||this.contents instanceof List?0:2*this.height())),this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),0===this.edge&&0===this.border)return BoxMorph.uber.drawNew.call(this),null;t.fillStyle=this.color.toString(),t.beginPath(),this.outlinePath(t,Math.max(this.edge-this.border,0),this.border),t.closePath(),t.fill(),this.border>0&&!MorphicPreferences.isFlat&&(t.lineWidth=this.border,t.strokeStyle=this.borderColor.toString(),t.beginPath(),this.outlinePath(t,this.edge,this.border/2),t.closePath(),t.stroke(),t.shadowOffsetX=this.border,t.shadowOffsetY=this.border,t.shadowBlur=this.border,t.shadowColor=this.color.darker(80).toString(),this.drawShadow(t,this.edge,this.border/2)),this.contentsMorph.setCenter(this.center()),o&&o.fixLayout()},CellMorph.prototype.reactToEdit=function(t){var e;isNil(this.idx)||(e=this.parentThatIsA(ListWatcherMorph))&&e.list.put(t.text,this.idx)},CellMorph.prototype.mouseClickLeft=function(t){this.isEditable&&this.contentsMorph instanceof TextMorph?this.contentsMorph.selectAllAndEdit():this.escalateEvent("mouseClickLeft",t)},CellMorph.prototype.mouseDoubleClick=function(t){List.prototype.enableTables&&this.currentValue instanceof List?new TableDialogMorph(this.contents).popUp(this.world()):this.escalateEvent("mouseDoubleClick",t)},WatcherMorph.prototype=new BoxMorph,WatcherMorph.prototype.constructor=WatcherMorph,WatcherMorph.uber=BoxMorph.prototype,WatcherMorph.prototype.init=function(t,e,o,i,r){this.labelText=t||"",this.version=null,this.objName="",WatcherMorph.uber.init.call(this,SyntaxElementMorph.prototype.rounding,1.000001,new Color(120,120,120)),this.color=new Color(220,220,220),this.readoutColor=e,this.style="normal",this.target=o||null,this.getter=i||null,this.currentValue=null,this.labelMorph=null,this.sliderMorph=null,this.cellMorph=null,this.isDraggable=!0,this.fixLayout(),this.update(),r&&this.hide()},WatcherMorph.prototype.isTemporary=function(){var t=this.parentThatIsA(StageMorph);return this.target instanceof VariableFrame&&((!t||this.target!==t.variables.parentFrame)&&null===this.target.owner)},WatcherMorph.prototype.object=function(){return this.target instanceof VariableFrame?this.target.owner:this.target},WatcherMorph.prototype.isGlobal=function(t){return contains(["getLastAnswer","getLastMessage","getTempo","getTimer","reportMouseX","reportMouseY","reportThreadCount"],t)},WatcherMorph.prototype.setSliderMin=function(t,e){this.target instanceof VariableFrame&&(this.sliderMorph.setSize(1,e),this.sliderMorph.setStart(t,e),this.sliderMorph.setSize(this.sliderMorph.rangeSize()/5,e))},WatcherMorph.prototype.setSliderMax=function(t,e){this.target instanceof VariableFrame&&(this.sliderMorph.setSize(1,e),this.sliderMorph.setStop(t,e),this.sliderMorph.setSize(this.sliderMorph.rangeSize()/5,e))},WatcherMorph.prototype.update=function(){var t,e,o,i,r=!1;if(this.target&&this.getter){if(this.updateLabel(),this.target instanceof VariableFrame)if(void 0===(t=this.target.vars[this.getter]?this.target.vars[this.getter].value:void 0)&&this.target.owner){if(e=this.target.owner,!contains(e.inheritedVariableNames(),this.getter))return void this.destroy();t=this.target.getVar(this.getter),this.cellMorph.setColor(SpriteMorph.prototype.blockColor.variables.lighter(35))}else this.cellMorph.setColor(SpriteMorph.prototype.blockColor.variables);else t=this.target[this.getter](),r=!!(i={xPosition:"x position",yPosition:"y position",direction:"direction",getCostumeIdx:"costume #",getScale:"size"}[this.getter])&&this.target.inheritsAttribute(i);""===t||isNil(t)||(o=+t,"boolean"==typeof t||isNaN(o)||(t=Math.round(1e9*t)/1e9)),t!==this.currentValue&&(this.changed(),this.cellMorph.contents=t,isSnapObject(this.target)&&(r?this.cellMorph.setColor(this.readoutColor.lighter(35)):this.cellMorph.setColor(this.readoutColor)),this.cellMorph.drawNew(),isNaN(t)||(this.sliderMorph.value=t,this.sliderMorph.drawNew()),this.fixLayout(),this.currentValue=t)}this.cellMorph.contentsMorph instanceof ListWatcherMorph?this.cellMorph.contentsMorph.update():isSnapObject(this.cellMorph.contents)&&this.cellMorph.update()},WatcherMorph.prototype.updateLabel=function(){var t=this.object();t&&!this.isGlobal(this.getter)&&t.version!==this.version&&(this.objName=t.name?t.name+" ":" ",this.labelMorph&&(this.labelMorph.destroy(),this.labelMorph=null,this.fixLayout()))},WatcherMorph.prototype.fixLayout=function(){var t,e=SyntaxElementMorph.prototype.fontSize,o=this;if(this.changed(),null===this.labelMorph&&(this.labelMorph=new StringMorph(this.objName+this.labelText,e,null,!0,!1,!1,MorphicPreferences.isFlat?new Point:new Point(1,1),new Color(255,255,255)),this.add(this.labelMorph)),null===this.cellMorph&&(this.cellMorph=new CellMorph("",this.readoutColor),this.add(this.cellMorph)),null===this.sliderMorph&&(this.sliderMorph=new SliderMorph(0,100,0,20,"horizontal"),this.sliderMorph.alpha=1,this.sliderMorph.button.color=this.color.darker(),this.sliderMorph.color=this.color.lighter(60),this.sliderMorph.button.highlightColor=this.color.darker(),this.sliderMorph.button.highlightColor.b+=50,this.sliderMorph.button.pressColor=this.color.darker(),this.sliderMorph.button.pressColor.b+=100,this.sliderMorph.setHeight(e),this.sliderMorph.action=function(t){o.target.setVar(o.getter,Math.round(t),o.target.owner)},this.add(this.sliderMorph)),(t=this.cellMorph.contents instanceof List)&&(this.style="normal"),"large"===this.style)return this.labelMorph.hide(),this.sliderMorph.hide(),this.cellMorph.big(),this.cellMorph.setPosition(this.position()),void this.setExtent(this.cellMorph.extent().subtract(1));this.labelMorph.show(),this.sliderMorph.show(),this.cellMorph.normal(),this.labelMorph.setPosition(this.position().add(new Point(this.edge,this.border+SyntaxElementMorph.prototype.typeInPadding))),t?this.cellMorph.setPosition(this.labelMorph.bottomLeft().add(new Point(0,SyntaxElementMorph.prototype.typeInPadding))):(this.cellMorph.setPosition(this.labelMorph.topRight().add(new Point(e/3,0))),this.labelMorph.setTop(this.cellMorph.top()+(this.cellMorph.height()-this.labelMorph.height())/2)),"slider"===this.style?(this.sliderMorph.silentSetPosition(new Point(this.labelMorph.left(),this.cellMorph.bottom()+SyntaxElementMorph.prototype.typeInPadding)),this.sliderMorph.setWidth(this.cellMorph.right()-this.labelMorph.left()),this.silentSetHeight(this.cellMorph.height()+this.sliderMorph.height()+2*this.border+3*SyntaxElementMorph.prototype.typeInPadding)):(this.sliderMorph.hide(),this.bounds.corner.y=this.cellMorph.bottom()+this.border+SyntaxElementMorph.prototype.typeInPadding),this.bounds.corner.x=Math.max(this.cellMorph.right(),this.labelMorph.right())+this.edge+SyntaxElementMorph.prototype.typeInPadding,this.drawNew(),this.changed()},WatcherMorph.prototype.mouseDoubleClick=function(t){List.prototype.enableTables&&this.currentValue instanceof List?new TableDialogMorph(this.currentValue).popUp(this.world()):this.escalateEvent("mouseDoubleClick",t)},WatcherMorph.prototype.rootForGrab=function(){var t=this.parentThatIsA(IDE_Morph);return t&&t.isAppMode?t:this},WatcherMorph.prototype.userMenu=function(){function t(t){var e=o.parentThatIsA(StageMorph),i=o.currentValue.outerContext.variables;r.addItem(t+"...",function(){var o,r=detect(e.children,function(e){return e instanceof WatcherMorph&&e.target===i&&e.getter===t});if(null!==r)return r.show(),void r.fixLayout();(r=new WatcherMorph(t+" "+localize("(temporary)"),SpriteMorph.prototype.blockColor.variables,i,t)).setPosition(e.position().add(10)),(o=e.watchers(r.left())).length>0&&r.setTop(o[o.length-1].bottom()),e.add(r),r.fixLayout()})}var e,o=this,i=this.parentThatIsA(IDE_Morph),r=new MenuMorph(this);if(!i||!i.isAppMode)return r.addItem(("normal"===this.style?"●":"○")+" "+localize("normal"),"styleNormal"),r.addItem(("large"===this.style?"●":"○")+" "+localize("large"),"styleLarge"),this.target instanceof VariableFrame&&(r.addItem(("slider"===this.style?"●":"○")+" "+localize("slider"),"styleSlider"),r.addLine(),r.addItem("slider min...","userSetSliderMin"),r.addItem("slider max...","userSetSliderMax"),r.addLine(),r.addItem("import...",function(){var t=document.createElement("input"),e=o.parentThatIsA(IDE_Morph);e.filePicker&&(document.body.removeChild(e.filePicker),e.filePicker=null),t.type="file",t.style.color="transparent",t.style.backgroundColor="transparent",t.style.border="none",t.style.outline="none",t.style.position="absolute",t.style.top="0px",t.style.left="0px",t.style.width="0px",t.style.height="0px",t.style.display="none",t.addEventListener("change",function(){function i(t){e.inform("Unable to import",'Snap! can only import "text" files.\nYou selected a file of type "'+t+'".')}document.body.removeChild(t),e.filePicker=null,t.files.length>0&&function(t){var e=new FileReader;e.onloadend=function(t){o.target.setVar(o.getter,t.target.result)},0===t.type.indexOf("text")?e.readAsText(t):i(t.type)}(t.files[t.files.length-1])},!1),document.body.appendChild(t),e.filePicker=t,t.click()}),isString(this.currentValue)||!isNaN(+this.currentValue)?r.addItem("export...",function(){o.parentThatIsA(IDE_Morph).saveFileAs(o.currentValue.toString(),"text/plain;charset=utf-8",o.getter)}):this.currentValue instanceof Context&&(e=this.currentValue.outerContext.variables.names()).length&&(r.addLine(),e.forEach(function(e){t(e)}))),r},WatcherMorph.prototype.setStyle=function(t){this.style=t,this.fixLayout()},WatcherMorph.prototype.styleNormal=function(){this.setStyle("normal")},WatcherMorph.prototype.styleLarge=function(){this.setStyle("large")},WatcherMorph.prototype.styleSlider=function(){this.setStyle("slider")},WatcherMorph.prototype.userSetSliderMin=function(){new DialogBoxMorph(this,this.setSliderMin,this).prompt("Slider minimum value",this.sliderMorph.start.toString(),this.world(),null,null,null,!0)},WatcherMorph.prototype.userSetSliderMax=function(){new DialogBoxMorph(this,this.setSliderMax,this).prompt("Slider maximum value",this.sliderMorph.stop.toString(),this.world(),null,null,null,!0)},WatcherMorph.prototype.drawNew=function(){var t,e;this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),MorphicPreferences.isFlat||0===this.edge&&0===this.border?BoxMorph.uber.drawNew.call(this):((e=t.createLinearGradient(0,0,0,this.height())).addColorStop(0,this.color.lighter().toString()),e.addColorStop(1,this.color.darker().toString()),t.fillStyle=e,t.beginPath(),this.outlinePath(t,Math.max(this.edge-this.border,0),this.border),t.closePath(),t.fill(),this.border>0&&((e=t.createLinearGradient(0,0,0,this.height())).addColorStop(0,this.borderColor.lighter().toString()),e.addColorStop(1,this.borderColor.darker().toString()),t.lineWidth=this.border,t.strokeStyle=e,t.beginPath(),this.outlinePath(t,this.edge,this.border/2),t.closePath(),t.stroke()))},StagePrompterMorph.prototype=new BoxMorph,StagePrompterMorph.prototype.constructor=StagePrompterMorph,StagePrompterMorph.uber=BoxMorph.prototype,StagePrompterMorph.prototype.init=function(t){var e=this;this.isDone=!1,this.label=t?new StringMorph(t,SpriteMorph.prototype.bubbleFontSize,null,SpriteMorph.prototype.bubbleFontIsBold,!1,"left"):null,this.inputField=new InputFieldMorph,this.button=new PushButtonMorph(null,function(){e.accept()},"✓"),StagePrompterMorph.uber.init.call(this,SyntaxElementMorph.prototype.rounding,SpriteMorph.prototype.bubbleBorder,SpriteMorph.prototype.blockColor.sensing),this.color=new Color(255,255,255),this.label&&this.add(this.label),this.add(this.inputField),this.add(this.button),this.setWidth(StageMorph.prototype.dimensions.x-20),this.fixLayout()},StagePrompterMorph.prototype.fixLayout=function(){var t=0;this.label&&(this.label.setPosition(new Point(this.left()+this.edge,this.top()+this.edge)),t=this.label.bottom()-this.top()),this.inputField.setPosition(new Point(this.left()+this.edge,this.top()+t+this.edge)),this.inputField.setWidth(this.width()-2*this.edge-this.button.width()-this.border),this.button.setCenter(this.inputField.center()),this.button.setLeft(this.inputField.right()+this.border),this.setHeight(this.inputField.bottom()-this.top()+this.edge)},StagePrompterMorph.prototype.mouseClickLeft=function(){this.inputField.edit()},StagePrompterMorph.prototype.accept=function(){this.isDone=!0},modules.gui="2017-December-01";var IDE_Morph,ProjectDialogMorph,LibraryImportDialogMorph,SpriteIconMorph,CostumeIconMorph,TurtleIconMorph,WardrobeMorph,SoundIconMorph,JukeboxMorph,StageHandleMorph,PaletteHandleMorph,CamSnapshotDialogMorph;IDE_Morph.prototype=new Morph,IDE_Morph.prototype.constructor=IDE_Morph,IDE_Morph.uber=Morph.prototype,IDE_Morph.prototype.setDefaultDesign=function(){MorphicPreferences.isFlat=!1,SpriteMorph.prototype.paletteColor=new Color(55,55,55),SpriteMorph.prototype.paletteTextColor=new Color(230,230,230),StageMorph.prototype.paletteTextColor=SpriteMorph.prototype.paletteTextColor,StageMorph.prototype.paletteColor=SpriteMorph.prototype.paletteColor,SpriteMorph.prototype.sliderColor=SpriteMorph.prototype.paletteColor.lighter(30),IDE_Morph.prototype.buttonContrast=30,IDE_Morph.prototype.backgroundColor=new Color(40,40,40),IDE_Morph.prototype.frameColor=SpriteMorph.prototype.paletteColor,IDE_Morph.prototype.groupColor=SpriteMorph.prototype.paletteColor.lighter(8),IDE_Morph.prototype.sliderColor=SpriteMorph.prototype.sliderColor,IDE_Morph.prototype.buttonLabelColor=new Color(255,255,255),IDE_Morph.prototype.tabColors=[IDE_Morph.prototype.groupColor.darker(40),IDE_Morph.prototype.groupColor.darker(60),IDE_Morph.prototype.groupColor],IDE_Morph.prototype.rotationStyleColors=IDE_Morph.prototype.tabColors,IDE_Morph.prototype.appModeColor=new Color,IDE_Morph.prototype.scriptsPaneTexture=this.scriptsTexture(),IDE_Morph.prototype.padding=5,SpriteIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor,CostumeIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor,SoundIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor,TurtleIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor},IDE_Morph.prototype.setFlatDesign=function(){MorphicPreferences.isFlat=!0,SpriteMorph.prototype.paletteColor=new Color(255,255,255),SpriteMorph.prototype.paletteTextColor=new Color(70,70,70),StageMorph.prototype.paletteTextColor=SpriteMorph.prototype.paletteTextColor,StageMorph.prototype.paletteColor=SpriteMorph.prototype.paletteColor,SpriteMorph.prototype.sliderColor=SpriteMorph.prototype.paletteColor,IDE_Morph.prototype.buttonContrast=30,IDE_Morph.prototype.backgroundColor=new Color(200,200,200),IDE_Morph.prototype.frameColor=new Color(255,255,255),IDE_Morph.prototype.groupColor=new Color(230,230,230),IDE_Morph.prototype.sliderColor=SpriteMorph.prototype.sliderColor,IDE_Morph.prototype.buttonLabelColor=new Color(70,70,70),IDE_Morph.prototype.tabColors=[IDE_Morph.prototype.groupColor.lighter(60),IDE_Morph.prototype.groupColor.darker(10),IDE_Morph.prototype.groupColor],IDE_Morph.prototype.rotationStyleColors=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.groupColor.darker(10),IDE_Morph.prototype.groupColor.darker(30)],IDE_Morph.prototype.appModeColor=IDE_Morph.prototype.frameColor,IDE_Morph.prototype.scriptsPaneTexture=null,IDE_Morph.prototype.padding=1,SpriteIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor,CostumeIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor,SoundIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor,TurtleIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor},IDE_Morph.prototype.scriptsTexture=function(){var t,e=newCanvas(new Point(100,100)),o=e.getContext("2d");for(t=0;t<100;t+=4)o.fillStyle=this.frameColor.toString(),o.fillRect(t,0,1,100),o.fillStyle=this.groupColor.lighter(6).toString(),o.fillRect(t+1,0,1,100),o.fillRect(t+3,0,1,100),o.fillStyle=this.groupColor.toString(),o.fillRect(t+2,0,1,100);return e},IDE_Morph.prototype.setDefaultDesign(),IDE_Morph.prototype.init=function(t){MorphicPreferences.globalFontFamily="Helvetica, Arial",this.userLanguage=null,this.projectsInURLs=!1,this.applySavedSettings(),this.cloudMsg=null,this.source="local",this.serializer=new SnapSerializer,this.globalVariables=new VariableFrame,this.currentSprite=new SpriteMorph(this.globalVariables),this.sprites=new List([this.currentSprite]),this.currentCategory="motion",this.currentTab="scripts",this.projectName="Education nationale",this.projectNotes="",this.logoURL="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAYCAYAAACBbx+6AAAEJGlDQ1BJQ0MgUHJvZmlsZQAAOBGFVd9v21QUPolvUqQWPyBYR4eKxa9VU1u5GxqtxgZJk6XtShal6dgqJOQ6N4mpGwfb6baqT3uBNwb8AUDZAw9IPCENBmJ72fbAtElThyqqSUh76MQPISbtBVXhu3ZiJ1PEXPX6yznfOec7517bRD1fabWaGVWIlquunc8klZOnFpSeTYrSs9RLA9Sr6U4tkcvNEi7BFffO6+EdigjL7ZHu/k72I796i9zRiSJPwG4VHX0Z+AxRzNRrtksUvwf7+Gm3BtzzHPDTNgQCqwKXfZwSeNHHJz1OIT8JjtAq6xWtCLwGPLzYZi+3YV8DGMiT4VVuG7oiZpGzrZJhcs/hL49xtzH/Dy6bdfTsXYNY+5yluWO4D4neK/ZUvok/17X0HPBLsF+vuUlhfwX4j/rSfAJ4H1H0qZJ9dN7nR19frRTeBt4Fe9FwpwtN+2p1MXscGLHR9SXrmMgjONd1ZxKzpBeA71b4tNhj6JGoyFNp4GHgwUp9qplfmnFW5oTdy7NamcwCI49kv6fN5IAHgD+0rbyoBc3SOjczohbyS1drbq6pQdqumllRC/0ymTtej8gpbbuVwpQfyw66dqEZyxZKxtHpJn+tZnpnEdrYBbueF9qQn93S7HQGGHnYP7w6L+YGHNtd1FJitqPAR+hERCNOFi1i1alKO6RQnjKUxL1GNjwlMsiEhcPLYTEiT9ISbN15OY/jx4SMshe9LaJRpTvHr3C/ybFYP1PZAfwfYrPsMBtnE6SwN9ib7AhLwTrBDgUKcm06FSrTfSj187xPdVQWOk5Q8vxAfSiIUc7Z7xr6zY/+hpqwSyv0I0/QMTRb7RMgBxNodTfSPqdraz/sDjzKBrv4zu2+a2t0/HHzjd2Lbcc2sG7GtsL42K+xLfxtUgI7YHqKlqHK8HbCCXgjHT1cAdMlDetv4FnQ2lLasaOl6vmB0CMmwT/IPszSueHQqv6i/qluqF+oF9TfO2qEGTumJH0qfSv9KH0nfS/9TIp0Wboi/SRdlb6RLgU5u++9nyXYe69fYRPdil1o1WufNSdTTsp75BfllPy8/LI8G7AUuV8ek6fkvfDsCfbNDP0dvRh0CrNqTbV7LfEEGDQPJQadBtfGVMWEq3QWWdufk6ZSNsjG2PQjp3ZcnOWWing6noonSInvi0/Ex+IzAreevPhe+CawpgP1/pMTMDo64G0sTCXIM+KdOnFWRfQKdJvQzV1+Bt8OokmrdtY2yhVX2a+qrykJfMq4Ml3VR4cVzTQVz+UoNne4vcKLoyS+gyKO6EHe+75Fdt0Mbe5bRIf/wjvrVmhbqBN97RD1vxrahvBOfOYzoosH9bq94uejSOQGkVM6sN/7HelL4t10t9F4gPdVzydEOx83Gv+uNxo7XyL/FtFl8z9ZAHF4bBsrEwAAAAlwSFlzAAALEgAACxIB0t1+/AAAAwBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDUuMS4yIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpZUmVzb2x1dGlvbj4zNTk5LzUwPC90aWZmOllSZXNvbHV0aW9uPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICAgICA8dGlmZjpYUmVzb2x1dGlvbj4zNTk5LzUwPC90aWZmOlhSZXNvbHV0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIj4KICAgICAgICAgPHhtcDpDcmVhdGVEYXRlPjIwMTMtMDItMTRUMDA6Mjk6NTE8L3htcDpDcmVhdGVEYXRlPgogICAgICAgICA8eG1wOkNyZWF0b3JUb29sPkFkb2JlIEZpcmV3b3JrcyBDUzYgKE1hY2ludG9zaCk8L3htcDpDcmVhdG9yVG9vbD4KICAgICAgICAgPHhtcDpNb2RpZnlEYXRlPjIwMTMtMDItMTRUMDA6MzM6MjE8L3htcDpNb2RpZnlEYXRlPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KLdsGnQAACsBJREFUWAmdV2lwVUUWPt333rdkJYGXEFmMEIIChZJkkCVoMsgoS9XIJC9Y4wyLjCCWOhQzf2Z9iU6V5TJa45QOoiQgKENeWATcdfIYQtiSuADB0ZCENSSEJJCXvO3e7vn6PYK4QtlVd+s+fc7Xp79zTl8mpaRrtjLGyUMQjAkfXz00zbDTRCmtieicwTi7XWOUwRiRZVGTJPYmMfmfUNg4mL3sTKfS7ytjegGRII8U17T3AwLsWoC9Xqa53dJSOk6vSxtjEj3AJBUbOmXpQNkfEhFirBtY+7EehveUeDtLUkvrD8vPhWDlhrStHb70VFcUh4/pVCCh5se1y4DhGy/xqAo3PMlwqZUALF0G21KevpBz+VRaMh/a0SPhNbYTcjUaWc2WxS5GuBWycRuTlkgC+DGSiVlAf29qEk/ovCSOcUaekYs7vFEbSq9ql3VH36/zBmcpeN/Bi6vAtpa7VqYm8ue7/ErU8UQonFF+80P7Wq9lo/kVV7ams4WQ+22CkyX4A7SJdPanG399riU6FzbUCtxuUAWaf0gfKyPuPuplUQ83ljFbwsj04cSZk/oDZ0eu6OmmKG+laF7rmuuwsV3hiHaMmGNJ5pKWA99SDMP13bk8N7te+nYTFXyDq6c3pmVZEbkKvlmBuRdAnCeIzr+cuVgGv6XrOzqw/8CpYggalHNb17lWou/JWJdsFsSfvGlJ+8b2DUPjQ6ZVLsjQ4xPaFrnc0s/y2uLcY4/fEpDc1hfU+0PkaKvdNvH8gMLL9pivrEwruNMH9NVX+HriteFTpWX9Bd6cDcuHwZ81klm7MsOjz1BbvaUCUoFTOr6hjwpLDg01SXEOIyfXpy+UJGaRZE6bzooipjxl13hewGq/JOSo/FGR5t20TEZmuQ8sCZO2MiJYPHRGcGVA/Z5wmJbU7cjtzFteb9TfkBsNUCrF8kuJVVMZYsNHBZ6rgK8dPVdwczkncxIAd5Ow7Q1HhqzOXt7waUmJVxs/vlGWIi0V+Hy8urrALFzic4R6k14H2Nxvcbi1In0FiPKiILHopsWdG9RqVbvnvgM/90f0f8IFOzQmqiySGhf8JgCOGIm9m6srCq5re2PaYveO9Wx0v4jPGpbQ126Mp0YaJ8NXjw+8T/9F3QTQdS8RT9K/CjhsBj5My9xpaNoqzthtmADAsf7eiD4P7+21VTmPDCgaeBYWkj6tpCGLh+LbjdS2SNCfMIVZzEVcNtVW5X2s5Cbfe2iETeNZ8Zo5OCJIVve4DssP5RcYOg4L6TS20z5jfP1g0PEnyO9xjBuHa6puParmco2GCEk2kuJ1XXUAE2t6IcuW9SiFHMlxF8y+UBuodGN07HL0gvFt8Pyv8osaFtRsydkcG4vdgykNY7iQb0i973ioN9HPJeXC86kk+eDpRQ1/Zzb2oqGxZ6Djjl7L6OFMpswY1DXkpwu6PBozt+UX6a9izGYROwNQo4EnGa4bNK2o/pnaLblPCKEJCcLDox/Gci+IfLqrKcq9cHefCzzJBgNTrwalMbkO38e4Effv6cX12/OL6+bMmdNkVzLSYeuC/GC8zsTcg1zqRbBwF77fw+gfZMSaivr2HBzr5ia7SwrjVkvyDSGLrwyYxmTUGy4lzxLE1pI0ZlrMnAnQH+l6/OPKDnagH/w9gzp6NApYVbMCT6z6cMNYmp7C02HM3rYpaQietGbNcmNPVV6zya0iy+wvB7i5TIt7q8d5aVd+Sd3Y/W9MaMcmdSPy39m7JfelPVtv/WLf1pxjJLgH0wNMaoNqt+Ud3Lclb2/Nm5PO7t06sQOxXgk9ffBVOipVB+Te2leVs1ON7a+6/UvJHUsts68TFFkKoGmgQa0pZbMOQ0xWKlhEp9an3QG3LzjXLQ+hNzkQsGeiuzOX6hWTscjJLfheOqX4wD/IDPxG0xyPChFUoOfBS50QcWD8SpMGaqDF/OByNCCnF3+8CgzLQZrWoDAbIOJAhQugTxB2k1lZGZcej1CZorbS3YWd3A/5LMG1EORfmTNhcjcHWB4rkYwLQY9DQQfc/jRSXDrj/BZlXRWE0lJi00r2OQsLfTo88Bk8+ZglgvPhpWHS4g8oOfAMsQrzlxsXFigjw0II17SihtXg50rk/5OSeCVq5rsYC8AxIfUEsLiC1kU2NbWRxmvqCc/jtMJkrXfSR7Xe22pVn04lKItAeXLdkKVxDnZnX1D8kmtyn2lxg5OcApkNVCgtDyx5aGpATRpotVW52xFUB6FzBNBq0PO11CalDeAtFHQ2B8sYJwW/v3brpN1q/p33HqozdTYH3BUAj4uHqysyo/OPVI4Lz5hXk8LszjxUxbdVWuOkaXr3xaPRtHb6tSHDMLG0PyiPZS45v6nRy2zx/iFn0TfzvJcluKT0z7+/JvdsIC7ZsNjnQSnCNkfYzizbfdjW8TDnBehlQBf+WoWSIhH7p/ingtLOSdxSOP+TT03G0oSuPYy+bAS/nRi34I/sKcUNE/dX5Xx2R1F9hnA4X8K8AAl5BHTYLZg4Q660adG0ZgltVWIc3XCxX3jU6se5ZfhEuasmOd540O+nueja3G9qRTYuHxZcttgltlDYHFCUhqB5RVhmlabrCvw5NX+gMXAV3AZH5WZQJQfyz4SliSBi7ZBRJbsZYJ2SMXBYjtCleCq/uP4SvkdhzMUFLQf/TWQcA4s74POO79PVGRcfD/X20xGkH3V4ijYY2CHJelBQ6p9bXmW+9yvlsz8rOdCEyYMxBl3SH5baof9W5h1UE6YV1z2GatQbmx27pyWKhkjEXJRl7ziGntcaA0M/ECgoNoOOpmo9R3plXErY1EI9prMAGPbZtMi/NNKGSU67E/Sgb/vGGY3Pr/I6d57MnBrkGc1wDg4+Fa7KyI6hEkfIv6nvupfJUM+WikwH+rbItzNkS0Xae3IPpaj+671KS0uRW69PPr/o0AfTiureupY8whCnfyEPnL1gHUfobVF+2dWGEznyshtHvxOvDv39ifaIPcnJ57Z+MfyI9b8xW3Ewb+FkQTyh6ctTbt9sj+eSOoqWUTX3+YiqqwtRsAgHLylaym8ea0p+j8b6nCR1BL3OkDFQa6HBStQTHfXhnsjsw92Rpx1JupV47OW7F6Q43x95MZhjM7Q+k2u9xAQzLwQnvJnz8LtNav3IrUgRAw05OerC6FN1Stm2ZlhcWDfvZswqQDoaAf4hQNgECAY4v+gesSh4vOmdMfasg03q9Eb1GaTlLlP8lPLEetfv4JA/gpN7kXEEsoQOziLww8KkJN2pn6DuUOF7s7avzsm0h+TGeQub7Pon+cHwKMRkV0RKwwaMYV0L/HX4Qv9nsA0PX90G0KsnQJeVMu7xyH6IbFOXOuiP88hw67q028C5DdJKykX/8azZX4ZodkwROq78ZMI7BQC7KXNxxyNq4d1mhKfomqAbnGTvTmYC2bfDdqPIsPemRNRxgQ3qQV543u9MYK5AUHKnBRlN1iR0htxR9QhhHDy5dxyx7/1NAT2QyaU6XMcgxe4nKtKfQ/RPxg6/gB32Y4HOKFM4fMjIj6CcgVnFGvGS4YvPHb567o96v7z7X6fE92mCsBcV0dVIbPjkLE15tNubmnzRr1fYDZofjsQogC0DXHWqYjbskSoYK0biz6V+DTPUVkSPVN+w4T3vliWNlfAbeD8OlHR9VSmviBbAFaCY+v4/AzCl6siiSKoAAAAASUVORK5CYII=",this.logo=null,this.controlBar=null,this.categories=null,this.palette=null,this.paletteHandle=null,this.spriteBar=null,this.spriteEditor=null,this.stage=null,this.stageHandle=null,this.corralBar=null,this.corral=null,this.isAutoFill=void 0===t||t,this.isAppMode=!1,this.isSmallStage=!1,this.filePicker=null,this.hasChangedMedia=!1,this.isAnimating=!0,this.paletteWidth=200,this.stageRatio=1,this.wasSingleStepping=!1,this.loadNewProject=!1,this.shield=null,this.savingPreferences=!0,IDE_Morph.uber.init.call(this),this.color=this.backgroundColor},IDE_Morph.prototype.openIn=function(t){function e(t){try{var e=new XMLHttpRequest;if(e.open("GET",t,!1),e.send(),200===e.status)return e.responseText;throw new Error("unable to retrieve "+t)}catch(t){return s.showMessage("unable to retrieve project"),""}}function o(t){t.editMode?s.toggleAppMode(!1):s.toggleAppMode(!0),t.noRun||s.runScripts(),t.hideControls&&(s.controlBar.hide(),window.onbeforeunload=nop),t.noExitWarning&&(window.onbeforeunload=nop)}function i(){var t,i;"#open:"===location.hash.substr(0,6)?(("%"===(r=location.hash.substr(6)).charAt(0)||r.search(/\%(?:[0-9a-f]{2})/i)>-1)&&(r=decodeURIComponent(r)),contains(["project","blocks","sprites","snapdata"].map(function(t){return r.substr(0,8).indexOf(t)}),1)?this.droppedText(r):this.droppedText(e(r))):"#run:"===location.hash.substr(0,5)?((i=(r=location.hash.substr(5)).indexOf("&"))>0&&(r=r.slice(0,i)),("%"===r.charAt(0)||r.search(/\%(?:[0-9a-f]{2})/i)>-1)&&(r=decodeURIComponent(r)),"<project>"===r.substr(0,8)?this.rawOpenProjectString(r):this.rawOpenProjectString(e(r)),o(SnapCloud.parseDict(location.hash.substr(5)))):"#present:"===location.hash.substr(0,9)?(this.shield=new Morph,this.shield.color=this.color,this.shield.setExtent(this.parent.extent()),this.parent.add(this.shield),s.showMessage("Fetching project\nfrom the cloud..."),(t=SnapCloud.parseDict(location.hash.substr(9))).Username=t.Username.toLowerCase(),SnapCloud.getPublicProject(SnapCloud.encodeDict(t),function(e){var i;s.nextSteps([function(){i=s.showMessage("Opening project...")},function(){nop()},function(){0===e.indexOf("<snapdata")?s.rawOpenCloudDataString(e):0===e.indexOf("<project")&&s.rawOpenProjectString(e),s.hasChangedMedia=!0},function(){s.shield.destroy(),s.shield=null,i.destroy(),o(t)}])},this.cloudError())):"#cloud:"===location.hash.substr(0,7)?(this.shield=new Morph,this.shield.alpha=0,this.shield.setExtent(this.parent.extent()),this.parent.add(this.shield),s.showMessage("Fetching project\nfrom the cloud..."),(t=SnapCloud.parseDict(location.hash.substr(7))).Username=t.Username.toLowerCase(),SnapCloud.getPublicProject(SnapCloud.encodeDict(t),function(t){var e;s.nextSteps([function(){e=s.showMessage("Opening project...")},function(){nop()},function(){0===t.indexOf("<snapdata")?s.rawOpenCloudDataString(t):0===t.indexOf("<project")&&s.rawOpenProjectString(t),s.hasChangedMedia=!0},function(){s.shield.destroy(),s.shield=null,e.destroy(),s.toggleAppMode(!1)}])},this.cloudError())):"#dl:"===location.hash.substr(0,4)?(s.showMessage("Fetching project\nfrom the cloud..."),(t=SnapCloud.parseDict(location.hash.substr(4))).Username=t.Username.toLowerCase(),SnapCloud.getPublicProject(SnapCloud.encodeDict(t),function(e){s.saveXMLAs(e,t.ProjectName),s.showMessage("Saved project\n"+t.ProjectName,2)},this.cloudError())):"#lang:"===location.hash.substr(0,6)?(a=location.hash.substr(6),this.setLanguage(a),this.loadNewProject=!0):"#signup"===location.hash.substr(0,7)&&this.createCloudAccount(),this.loadNewProject=!1}var r,n,s=this,a=null;this.hasLocalStorage()&&(n=localStorage["-snap-user"])&&(n=SnapCloud.parseResponse(n)[0])&&(SnapCloud.username=n.username||null,SnapCloud.password=n.password||null,SnapCloud.username&&(this.source="cloud")),this.buildPanes(),t.add(this),t.userMenu=this.userMenu,SnapCloud.message=function(e){var o,i=new MenuMorph(null,e);i.popUpCenteredInWorld(t),o=setInterval(function(){i.destroy(),clearInterval(o)},2e3)},t.reactToDropOf=function(e){e instanceof DialogBoxMorph||(t.hand.grabOrigin?e.slideBackTo(t.hand.grabOrigin):t.hand.grab(e))},this.reactToWorldResize(t.bounds),this.userLanguage?(this.loadNewProject=!0,this.setLanguage(this.userLanguage,i)):i.call(this)},IDE_Morph.prototype.buildPanes=function(){this.createLogo(),this.createControlBar(),this.createCategories(),this.createPalette(),this.createStage(),this.createSpriteBar(),this.createSpriteEditor(),this.createCorralBar(),this.createCorral()},IDE_Morph.prototype.createLogo=function(){var t=this;this.logo&&this.logo.destroy(),this.logo=new Morph,this.logo.texture=this.logoURL,this.logo.drawNew=function(){this.image=newCanvas(this.extent());var e=this.image.getContext("2d"),o=e.createLinearGradient(0,0,this.width(),0);o.addColorStop(0,"black"),o.addColorStop(.5,t.frameColor.toString()),e.fillStyle=MorphicPreferences.isFlat?t.frameColor.toString():o,e.fillRect(0,0,this.width(),this.height()),this.texture&&this.drawTexture(this.texture)},this.logo.drawCachedTexture=function(){this.image.getContext("2d").drawImage(this.cachedTexture,5,Math.round((this.height()-this.cachedTexture.height)/2)),this.changed()},this.logo.mouseClickLeft=function(){t.snapMenu()},this.logo.color=new Color,this.logo.setExtent(new Point(200,28)),this.add(this.logo)},IDE_Morph.prototype.createControlBar=function(){var t,e,o,i,r,n,s,a,h,l,p,c,d=[this.groupColor,this.frameColor.darker(50),this.frameColor.darker(50)],u=this;this.controlBar&&this.controlBar.destroy(),this.controlBar=new Morph,this.controlBar.color=this.frameColor,this.controlBar.setHeight(this.logo.height()),this.controlBar.mouseClickLeft=function(){this.world().fillPage()},this.add(this.controlBar),(t=new ToggleButtonMorph(null,u,"toggleStageSize",[new SymbolMorph("smallStage",14),new SymbolMorph("normalStage",14)],function(){return u.isSmallStage})).corner=12,t.color=d[0],t.highlightColor=d[1],t.pressColor=d[2],t.labelMinExtent=new Point(36,18),t.padding=0,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=d[1],t.labelColor=this.buttonLabelColor,t.contrast=this.buttonContrast,t.drawNew(),t.fixLayout(),t.refresh(),a=t,this.controlBar.add(a),this.controlBar.stageSizeButton=t,(t=new ToggleButtonMorph(null,u,"toggleAppMode",[new SymbolMorph("fullScreen",14),new SymbolMorph("normalScreen",14)],function(){return u.isAppMode})).corner=12,t.color=d[0],t.highlightColor=d[1],t.pressColor=d[2],t.labelMinExtent=new Point(36,18),t.padding=0,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=d[1],t.labelColor=this.buttonLabelColor,t.contrast=this.buttonContrast,t.drawNew(),t.fixLayout(),t.refresh(),h=t,this.controlBar.add(h),this.controlBar.appModeButton=h,(t=new ToggleButtonMorph(null,u,"toggleSingleStepping",[new SymbolMorph("footprints",16),new SymbolMorph("footprints",16)],function(){return Process.prototype.enableSingleStepping})).corner=12,t.color=d[0],t.highlightColor=d[1],t.pressColor=new Color(153,255,213),t.labelMinExtent=new Point(36,18),t.padding=0,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=d[1],t.labelColor=this.buttonLabelColor,t.contrast=this.buttonContrast,t.drawNew(),t.hint="Visible stepping",t.fixLayout(),t.refresh(),l=t,this.controlBar.add(l),this.controlBar.steppingButton=l,(t=new ToggleButtonMorph(null,this,"stopAllScripts",[new SymbolMorph("octagon",14),new SymbolMorph("square",14)],function(){return!u.stage||u.stage.enableCustomHatBlocks&&u.stage.threads.pauseCustomHatBlocks})).corner=12,t.color=d[0],t.highlightColor=d[1],t.pressColor=d[2],t.labelMinExtent=new Point(36,18),t.padding=0,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=d[1],t.labelColor=new Color(200,0,0),t.contrast=this.buttonContrast,t.drawNew(),t.fixLayout(),t.refresh(),o=t,this.controlBar.add(o),this.controlBar.stopButton=o,(t=new ToggleButtonMorph(null,this,"togglePauseResume",[new SymbolMorph("pause",12),new SymbolMorph("pointRight",14)],function(){return u.isPaused()})).corner=12,t.color=d[0],t.highlightColor=d[1],t.pressColor=d[2],t.labelMinExtent=new Point(36,18),t.padding=0,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=d[1],t.labelColor=new Color(255,220,0),t.contrast=this.buttonContrast,t.drawNew(),t.fixLayout(),t.refresh(),i=t,this.controlBar.add(i),this.controlBar.pauseButton=i,(t=new PushButtonMorph(this,"pressStart",new SymbolMorph("flag",14))).corner=12,t.color=d[0],t.highlightColor=d[1],t.pressColor=d[2],t.labelMinExtent=new Point(36,18),t.padding=0,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=d[1],t.labelColor=new Color(0,200,0),t.contrast=this.buttonContrast,t.drawNew(),t.fixLayout(),r=t,this.controlBar.add(r),this.controlBar.startButton=r,(e=new SliderMorph(61,1,100*Process.prototype.flashTime+1,6,"horizontal")).action=function(t){Process.prototype.flashTime=(t-1)/100,u.controlBar.refreshResumeSymbol()},e.color=new Color(153,255,213),e.alpha=.3,e.setExtent(new Point(50,14)),this.controlBar.add(e),this.controlBar.steppingSlider=e,(t=new PushButtonMorph(this,"projectMenu",new SymbolMorph("file",14))).corner=12,t.color=d[0],t.highlightColor=d[1],t.pressColor=d[2],t.labelMinExtent=new Point(36,18),t.padding=0,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=d[1],t.labelColor=this.buttonLabelColor,t.contrast=this.buttonContrast,t.drawNew(),t.fixLayout(),n=t,this.controlBar.projectButton=n,(t=new PushButtonMorph(this,"settingsMenu",new SymbolMorph("gears",14))).corner=12,t.color=d[0],t.highlightColor=d[1],t.pressColor=d[2],t.labelMinExtent=new Point(36,18),t.padding=0,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=d[1],t.labelColor=this.buttonLabelColor,t.contrast=this.buttonContrast,t.drawNew(),t.fixLayout(),s=t,this.controlBar.settingsButton=s,(t=new PushButtonMorph(this,"cloudMenu",new SymbolMorph("cloud",11))).corner=12,t.color=d[0],t.highlightColor=d[1],t.pressColor=d[2],t.labelMinExtent=new Point(36,18),t.padding=0,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=d[1],t.labelColor=this.buttonLabelColor,t.contrast=this.buttonContrast,t.drawNew(),t.fixLayout(),p=t,this.controlBar.cloudButton=p,this.controlBar.fixLayout=function(){c=this.right()-5,[o,i,r].forEach(function(t){t.setCenter(u.controlBar.center()),t.setRight(c),c-=t.width(),c-=5}),c=Math.min(r.left()-(15+2*a.width()),u.right()-StageMorph.prototype.dimensions.x*(u.isSmallStage?u.stageRatio:1)),[a,h].forEach(function(t){c+=5,t.setCenter(u.controlBar.center()),t.setLeft(c),c+=t.width()}),e.setCenter(u.controlBar.center()),e.setRight(a.left()-5),l.setCenter(u.controlBar.center()),l.setRight(e.left()-5),s.setCenter(u.controlBar.center()),s.setLeft(this.left()),p.setCenter(u.controlBar.center()),p.setRight(s.left()-5),n.setCenter(u.controlBar.center()),n.setRight(p.left()-5),this.refreshSlider(),this.updateLabel()},this.controlBar.refreshSlider=function(){Process.prototype.enableSingleStepping&&!u.isAppMode?(e.drawNew(),e.show()):e.hide(),this.refreshResumeSymbol()},this.controlBar.refreshResumeSymbol=function(){var t;Process.prototype.enableSingleStepping&&Process.prototype.flashTime>.5?(u.stage.threads.pauseAll(u.stage),t=[new SymbolMorph("pause",12),new SymbolMorph("stepForward",14)]):t=[new SymbolMorph("pause",12),new SymbolMorph("pointRight",14)],i.labelString=t,i.createLabel(),i.fixLayout(),i.refresh()},this.controlBar.updateLabel=function(){var t=u.world().isDevMode?" - "+localize("development mode"):"";this.label&&this.label.destroy(),u.isAppMode||(this.label=new StringMorph((u.projectName||localize("untitled"))+t,14,"sans-serif",!0,!1,!1,MorphicPreferences.isFlat?null:new Point(2,1),u.frameColor.darker(u.buttonContrast)),this.label.color=u.buttonLabelColor,this.label.drawNew(),this.add(this.label),this.label.setCenter(this.center()),this.label.setLeft(this.settingsButton.right()+5))}},IDE_Morph.prototype.createCategories=function(){function t(t){var o,i=[e.frameColor,e.frameColor.darker(50),SpriteMorph.prototype.blockColor[t]];return o=new ToggleButtonMorph(i,e,function(){e.currentCategory=t,e.categories.children.forEach(function(t){t.refresh()}),e.refreshPalette(!0)},t[0].toUpperCase().concat(t.slice(1)),function(){return e.currentCategory===t},null,null,null,75,!0),o.corner=8,o.padding=0,o.labelShadowOffset=new Point(-1,-1),o.labelShadowColor=i[1],o.labelColor=e.buttonLabelColor,o.fixLayout(),o.refresh(),e.categories.add(o),o}var e=this;this.categories&&this.categories.destroy(),this.categories=new Morph,this.categories.color=this.groupColor,this.categories.silentSetWidth(this.paletteWidth),SpriteMorph.prototype.categories.forEach(function(e){contains(["lists","other"],e)||t(e)}),function(){var t,o,i=e.categories.children[0].width(),r=e.categories.children[0].height(),n=Math.ceil(e.categories.children.length/2),s=(197-2*i)/3,a=e.categories.left(),h=e.categories.top(),l=0;e.categories.children.forEach(function(e){l+=1,t=Math.ceil(l/2),o=2-l%2,e.setPosition(new Point(a+(o*s+(o-1)*i),h+(2*t+(t-1)*r+3)))}),e.categories.setHeight(2*(n+1)+n*r+6)}(),this.add(this.categories)},IDE_Morph.prototype.createPalette=function(t){var e=this;return this.palette&&this.palette.destroy(),this.palette=t?new ScrollFrameMorph(null,null,this.currentSprite.sliderColor):this.currentSprite.palette(this.currentCategory),this.palette.isDraggable=!1,this.palette.acceptsDrops=!0,this.palette.enableAutoScrolling=!1,this.palette.contents.acceptsDrops=!1,this.palette.reactToDropOf=function(t,o){t instanceof DialogBoxMorph?e.world().add(t):t instanceof SpriteMorph?e.removeSprite(t):t instanceof SpriteIconMorph?(t.destroy(),e.removeSprite(t.object)):t instanceof CostumeIconMorph?(e.currentSprite.wearCostume(null),t.perish()):t instanceof BlockMorph?(e.stage.threads.stopAllForBlock(t),o&&o.grabOrigin.origin instanceof ScriptsMorph&&(o.grabOrigin.origin.clearDropInfo(),o.grabOrigin.origin.lastDroppedBlock=t,o.grabOrigin.origin.recordDrop(o.grabOrigin)),t.perish()):t.perish()},this.palette.contents.reactToDropOf=function(t){t instanceof BlockMorph&&t.destroy()},this.palette.setWidth(this.logo.width()),this.add(this.palette),this.palette},IDE_Morph.prototype.createPaletteHandle=function(){this.paletteHandle&&this.paletteHandle.destroy(),this.paletteHandle=new PaletteHandleMorph(this.categories),panel_Left=this,this.add(this.paletteHandle)},IDE_Morph.prototype.createStage=function(){this.stage&&this.stage.destroy(),StageMorph.prototype.frameRate=0,this.stage=new StageMorph(this.globalVariables),this.stage.setExtent(this.stage.dimensions),this.currentSprite instanceof SpriteMorph&&(this.currentSprite.setPosition(this.stage.center().subtract(this.currentSprite.extent().divideBy(2))),this.stage.add(this.currentSprite)),this.add(this.stage)},IDE_Morph.prototype.createStageHandle=function(){this.stageHandle&&this.stageHandle.destroy(),this.stageHandle=new StageHandleMorph(this.stage),this.add(this.stageHandle)},IDE_Morph.prototype.createSpriteBar=function(){function t(t){var e,o=c.rotationStyleColors;return e=new ToggleButtonMorph(o,c,function(){c.currentSprite instanceof SpriteMorph&&(c.currentSprite.rotationStyle=t,c.currentSprite.changed(),c.currentSprite.drawNew(),c.currentSprite.changed()),n.forEach(function(t){t.refresh()})},l[t],function(){return c.currentSprite instanceof SpriteMorph&&c.currentSprite.rotationStyle===t},null,localize(p[t])),e.corner=8,e.labelMinExtent=new Point(11,11),e.padding=0,e.labelShadowOffset=new Point(-1,-1),e.labelShadowColor=o[1],e.labelColor=c.buttonLabelColor,e.fixLayout(),e.refresh(),n.push(e),e.setPosition(c.spriteBar.position().add(2)),e.setTop(e.top()+(n.length-1)*(e.height()+2)),c.spriteBar.add(e),c.currentSprite instanceof StageMorph&&e.hide(),e}var e,o,i,r,n=[],s=new Point(45,45),a=this.tabColors,h=new AlignmentMorph("row",-30),l=["→","↻","↔"],p=["don't rotate","can rotate","only face left/right"],c=this;this.spriteBar&&this.spriteBar.destroy(),this.spriteBar=new Morph,this.spriteBar.color=this.frameColor,this.add(this.spriteBar),t(1),t(2),t(0),this.rotationStyleButtons=n,(i=new Morph).setExtent(s),i.image=this.currentSprite.thumbnail(s),i.setPosition(n[0].topRight().add(new Point(5,3))),this.spriteBar.add(i),i.fps=3,i.step=function(){i.version!==c.currentSprite.version&&(i.image=c.currentSprite.thumbnail(s),i.changed(),i.version=c.currentSprite.version)},(e=new InputFieldMorph(this.currentSprite.name)).setWidth(100),e.contrast=90,e.setPosition(i.topRight().add(new Point(10,3))),this.spriteBar.add(e),e.drawNew(),e.accept=function(){var t=e.getValue();c.currentSprite.setName(c.newSpriteName(t,c.currentSprite)),e.setContents(c.currentSprite.name)},this.spriteBar.reactToEdit=e.accept,(o=new ToggleMorph("checkbox",null,function(){c.currentSprite.isDraggable=!c.currentSprite.isDraggable},localize("draggable"),function(){return c.currentSprite.isDraggable})).label.isBold=!1,o.label.setColor(this.buttonLabelColor),o.color=a[2],o.highlightColor=a[0],o.pressColor=a[1],o.tick.shadowOffset=MorphicPreferences.isFlat?new Point:new Point(-1,-1),o.tick.shadowColor=new Color,o.tick.color=this.buttonLabelColor,o.tick.isBold=!1,o.tick.drawNew(),o.setPosition(e.bottomLeft().add(2)),o.drawNew(),this.spriteBar.add(o),this.currentSprite instanceof StageMorph&&o.hide(),h.tabTo=function(t){var e;c.currentTab=t,this.children.forEach(function(t){t.refresh(),t.state&&(e=t)}),e.refresh(),c.createSpriteEditor(),c.fixLayout("tabEditor")},(r=new TabMorph(a,null,function(){h.tabTo("scripts")},localize("Scripts"),function(){return"scripts"===c.currentTab})).padding=3,r.corner=15,r.edge=1,r.labelShadowOffset=new Point(-1,-1),r.labelShadowColor=a[1],r.labelColor=this.buttonLabelColor,r.drawNew(),r.fixLayout(),h.add(r),(r=new TabMorph(a,null,function(){h.tabTo("costumes")},localize(this.currentSprite instanceof SpriteMorph?"Costumes":"Backgrounds"),function(){return"costumes"===c.currentTab})).padding=3,r.corner=15,r.edge=1,r.labelShadowOffset=new Point(-1,-1),r.labelShadowColor=a[1],r.labelColor=this.buttonLabelColor,r.drawNew(),r.fixLayout(),h.add(r),(r=new TabMorph(a,null,function(){h.tabTo("sounds")},localize("Sounds"),function(){return"sounds"===c.currentTab})).padding=3,r.corner=15,r.edge=1,r.labelShadowOffset=new Point(-1,-1),r.labelShadowColor=a[1],r.labelColor=this.buttonLabelColor,r.drawNew(),r.fixLayout(),h.add(r),h.fixLayout(),h.children.forEach(function(t){t.refresh()}),this.spriteBar.tabBar=h,this.spriteBar.add(this.spriteBar.tabBar),this.spriteBar.fixLayout=function(){this.tabBar.setLeft(this.left()),this.tabBar.setBottom(this.bottom())}},IDE_Morph.prototype.createSpriteEditor=function(){var t=this.currentSprite.scripts,e=this;this.spriteEditor&&this.spriteEditor.destroy(),"scripts"===this.currentTab?(t.isDraggable=!1,t.color=this.groupColor,t.cachedTexture=this.scriptsPaneTexture,this.spriteEditor=new ScrollFrameMorph(t,null,this.sliderColor),this.spriteEditor.padding=10,this.spriteEditor.growth=50,this.spriteEditor.isDraggable=!1,this.spriteEditor.acceptsDrops=!1,this.spriteEditor.contents.acceptsDrops=!0,t.scrollFrame=this.spriteEditor,t.updateToolbar(),this.add(this.spriteEditor),this.spriteEditor.scrollX(this.spriteEditor.padding),this.spriteEditor.scrollY(this.spriteEditor.padding)):"costumes"===this.currentTab?(this.spriteEditor=new WardrobeMorph(this.currentSprite,this.sliderColor),this.spriteEditor.color=this.groupColor,this.add(this.spriteEditor),this.spriteEditor.updateSelection(),this.spriteEditor.acceptsDrops=!1,this.spriteEditor.contents.acceptsDrops=!1):"sounds"===this.currentTab?(this.spriteEditor=new JukeboxMorph(this.currentSprite,this.sliderColor),this.spriteEditor.color=this.groupColor,this.add(this.spriteEditor),this.spriteEditor.updateSelection(),this.spriteEditor.acceptDrops=!1,this.spriteEditor.contents.acceptsDrops=!1):(this.spriteEditor=new Morph,this.spriteEditor.color=this.groupColor,this.spriteEditor.acceptsDrops=!0,this.spriteEditor.reactToDropOf=function(t){t instanceof DialogBoxMorph?e.world().add(t):t instanceof SpriteMorph?e.removeSprite(t):t.destroy()},this.add(this.spriteEditor))},IDE_Morph.prototype.createCorralBar=function(){var t,e,o,i=[this.groupColor,this.frameColor.darker(50),this.frameColor.darker(50)];this.corralBar&&this.corralBar.destroy(),this.corralBar=new Morph,this.corralBar.color=this.frameColor,this.corralBar.setHeight(this.logo.height()),this.add(this.corralBar),(t=new PushButtonMorph(this,"addNewSprite",new SymbolMorph("turtle",14))).corner=12,t.color=i[0],t.highlightColor=i[1],t.pressColor=i[2],t.labelMinExtent=new Point(36,18),t.padding=0,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=i[1],t.labelColor=this.buttonLabelColor,t.contrast=this.buttonContrast,t.drawNew(),t.hint="add a new Turtle sprite",t.fixLayout(),t.setCenter(this.corralBar.center()),t.setLeft(this.corralBar.left()+5),this.corralBar.add(t),(e=new PushButtonMorph(this,"paintNewSprite",new SymbolMorph("brush",15))).corner=12,e.color=i[0],e.highlightColor=i[1],e.pressColor=i[2],e.labelMinExtent=new Point(36,18),e.padding=0,e.labelShadowOffset=new Point(-1,-1),e.labelShadowColor=i[1],e.labelColor=this.buttonLabelColor,e.contrast=this.buttonContrast,e.drawNew(),e.hint="paint a new sprite",e.fixLayout(),e.setCenter(this.corralBar.center()),e.setLeft(this.corralBar.left()+5+t.width()+5),this.corralBar.add(e),CamSnapshotDialogMorph.prototype.enableCamera&&((o=new PushButtonMorph(this,"newCamSprite",new SymbolMorph("camera",15))).corner=12,o.color=i[0],o.highlightColor=i[1],o.pressColor=i[2],o.labelMinExtent=new Point(36,18),o.padding=0,o.labelShadowOffset=new Point(-1,-1),o.labelShadowColor=i[1],o.labelColor=this.buttonLabelColor,o.contrast=this.buttonContrast,o.drawNew(),o.hint="take a camera snapshot and\nimport it as a new sprite",o.fixLayout(),o.setCenter(this.corralBar.center()),o.setLeft(this.corralBar.left()+5+t.width()+5+e.width()+5),this.corralBar.add(o),document.addEventListener("cameraDisabled",function(t){o.disable(),o.hint=CamSnapshotDialogMorph.prototype.notSupportedMessage}))},IDE_Morph.prototype.createCorral=function(){var t,e,o=this;this.createStageHandle(),this.createPaletteHandle(),this.corral&&this.corral.destroy(),this.corral=new Morph,this.corral.color=this.groupColor,this.add(this.corral),this.corral.stageIcon=new SpriteIconMorph(this.stage),this.corral.stageIcon.isDraggable=!1,this.corral.add(this.corral.stageIcon),(t=new ScrollFrameMorph(null,null,this.sliderColor)).acceptsDrops=!1,t.contents.acceptsDrops=!1,t.contents.wantsDropOf=function(t){return t instanceof SpriteIconMorph},t.contents.reactToDropOf=function(t){o.corral.reactToDropOf(t)},t.alpha=0,this.sprites.asArray().forEach(function(o){o.isTemporary||(e=new SpriteIconMorph(o,e),t.contents.add(e))}),this.corral.frame=t,this.corral.add(t),this.corral.fixLayout=function(){this.stageIcon.setCenter(this.center()),this.stageIcon.setLeft(this.left()+5),this.frame.setLeft(this.stageIcon.right()+5),this.frame.setExtent(new Point(this.right()-this.frame.left(),this.height())),this.arrangeIcons(),this.refresh()},this.corral.arrangeIcons=function(){var t=this.frame.left(),e=this.frame.top(),o=this.frame.right(),i=this.frame.left();this.frame.contents.children.forEach(function(r){var n=r.width();t+n>o&&(t=i,e+=r.height()),r.setPosition(new Point(t,e)),t+=n}),this.frame.contents.adjustBounds()},this.corral.addSprite=function(t){this.frame.contents.add(new SpriteIconMorph(t)),this.fixLayout()},this.corral.refresh=function(){this.stageIcon.refresh(),this.frame.contents.children.forEach(function(t){t.refresh()})},this.corral.wantsDropOf=function(t){return t instanceof SpriteIconMorph},this.corral.reactToDropOf=function(t){var e=1,i=t.position();t.destroy(),this.frame.contents.children.forEach(function(t){(i.gt(t.position())||i.y>t.bottom())&&(e+=1)}),o.sprites.add(t.object,e),o.createCorral(),o.fixLayout()}},IDE_Morph.prototype.fixLayout=function(t){var e,o=this.padding;Morph.prototype.trackChanges=!1,"refreshPalette"!==t&&(this.controlBar.setPosition(this.logo.topRight()),this.controlBar.setWidth(this.right()-this.controlBar.left()),this.controlBar.fixLayout(),this.categories.setLeft(this.logo.left()),this.categories.setTop(this.logo.bottom()),this.categories.setWidth(this.paletteWidth)),this.palette.setLeft(this.logo.left()),this.palette.setTop(this.categories.bottom()),this.palette.setHeight(this.bottom()-this.palette.top()),this.palette.setWidth(this.paletteWidth),"refreshPalette"!==t&&(this.isAppMode?(this.stage.setScale(Math.floor(10*Math.min((this.width()-2*o)/this.stage.dimensions.x,(this.height()-2*this.controlBar.height()-2*o)/this.stage.dimensions.y))/10),this.stage.setCenter(this.center())):(this.stage.setScale(this.isSmallStage?this.stageRatio:1),this.stage.setTop(this.logo.bottom()+o),this.stage.setRight(this.right()),e=Math.max(200,this.width()-this.stage.width()-this.spriteBar.tabBar.width()-2*this.padding),this.paletteWidth>e&&(this.paletteWidth=e,this.fixLayout()),this.stageHandle.fixLayout(),this.paletteHandle.fixLayout()),this.spriteBar.setLeft(this.paletteWidth+o),this.spriteBar.setTop(this.logo.bottom()+o),this.spriteBar.setExtent(new Point(Math.max(0,this.stage.left()-o-this.spriteBar.left()),this.categories.bottom()-this.spriteBar.top()-o)),this.spriteBar.fixLayout(),this.spriteEditor.isVisible&&(this.spriteEditor.setPosition(this.spriteBar.bottomLeft()),this.spriteEditor.setExtent(new Point(this.spriteBar.width(),this.bottom()-this.spriteEditor.top()))),this.corralBar.setLeft(this.stage.left()),this.corralBar.setTop(this.stage.bottom()+o),this.corralBar.setWidth(this.stage.width()),contains(["selectSprite","tabEditor"],t)||(this.corral.setPosition(this.corralBar.bottomLeft()),this.corral.setWidth(this.stage.width()),this.corral.setHeight(this.bottom()-this.corral.top()),this.corral.fixLayout())),Morph.prototype.trackChanges=!0,this.changed()},IDE_Morph.prototype.setProjectName=function(t){this.projectName=t.replace(/['"]/g,""),this.hasChangedMedia=!0,this.controlBar.updateLabel()},IDE_Morph.prototype.setExtent=function(t){var e,o,i,r,n,s,a,h=new Point(430,110);e=this.isAppMode?StageMorph.prototype.dimensions.add(this.controlBar.height()+10):this.stageRatio>1?h.add(StageMorph.prototype.dimensions):h.add(StageMorph.prototype.dimensions.multiplyBy(this.stageRatio)),i=(o=t.max(e)).x-(200+this.spriteBar.tabBar.width()+2*this.padding),r=3*SpriteIconMorph.prototype.thumbSize.x,n=o.y-3.5*SpriteIconMorph.prototype.thumbSize.y,s=r/this.stage.dimensions.x,a=Math.min(i/this.stage.dimensions.x,n/this.stage.dimensions.y),this.stageRatio=Math.min(a,Math.max(s,this.stageRatio)),IDE_Morph.uber.setExtent.call(this,o),this.fixLayout()},IDE_Morph.prototype.reactToWorldResize=function(t){this.isAutoFill&&(this.setPosition(t.origin),this.setExtent(t.extent())),this.filePicker&&(document.body.removeChild(this.filePicker),this.filePicker=null)},IDE_Morph.prototype.droppedImage=function(t,e){var o=new Costume(t,this.currentSprite.newCostumeName(e?e.split(".")[0]:""));o.isTainted()?this.inform("Unable to import this image","The picture you wish to import has been\ntainted by a restrictive cross-origin policy\nmaking it unusable for costumes in Snap!. \n\nTry downloading this picture first to your\ncomputer, and import it from there."):(this.currentSprite.addCostume(o),this.currentSprite.wearCostume(o),this.spriteBar.tabBar.tabTo("costumes"),this.hasChangedMedia=!0)},IDE_Morph.prototype.droppedSVG=function(t,e){var o=new SVG_Costume(t,e.split(".")[0]);this.currentSprite.addCostume(o),this.currentSprite.wearCostume(o),this.spriteBar.tabBar.tabTo("costumes"),this.hasChangedMedia=!0},IDE_Morph.prototype.droppedAudio=function(t,e){this.currentSprite.addSound(t,e.split(".")[0]),this.spriteBar.tabBar.tabTo("sounds"),this.hasChangedMedia=!0},IDE_Morph.prototype.droppedText=function(t,e){var o=e?e.split(".")[0]:"";return 0===t.indexOf("<project")?(location.hash="",this.openProjectString(t)):0===t.indexOf("<snapdata")?(location.hash="",this.openCloudDataString(t)):0===t.indexOf("<blocks")?this.openBlocksString(t,o,!0):0===t.indexOf("<sprites")?this.openSpritesString(t):0===t.indexOf("<media")?this.openMediaString(t):0===t.indexOf("<script")?this.openScriptString(t):void 0},IDE_Morph.prototype.droppedBinary=function(t,e){function o(t,e){var o=new sb.Reader,i=e.split(".")[0];o.onload=function(t){r.droppedText((new sb.XMLWriter).write(i,t))},o.readYPR(new Uint8Array(t))}var i=document.getElementById("ypr"),r=this;"ypr"===e.substring(e.length-3).toLowerCase()&&(i?o(t,e):((i=document.createElement("script")).id="ypr",i.onload=function(){o(t,e)},document.head.appendChild(i),i.src="ypr.js"))},IDE_Morph.prototype.refreshPalette=function(t){var e=this.palette.contents.top();this.createPalette(),this.fixLayout("refreshPalette"),t||this.palette.contents.setTop(e)},IDE_Morph.prototype.pressStart=function(){16===this.world().currentKey?this.toggleFastTracking():(this.stage.threads.pauseCustomHatBlocks=!1,this.controlBar.stopButton.refresh(),this.runScripts())},IDE_Morph.prototype.toggleFastTracking=function(){this.stage.isFastTracked?this.stopFastTracking():this.startFastTracking()},IDE_Morph.prototype.toggleVariableFrameRate=function(){StageMorph.prototype.frameRate?(StageMorph.prototype.frameRate=0,this.stage.fps=0):(StageMorph.prototype.frameRate=30,this.stage.fps=30)},IDE_Morph.prototype.toggleSingleStepping=function(){this.stage.threads.toggleSingleStepping(),this.controlBar.steppingButton.refresh(),this.controlBar.refreshSlider()},IDE_Morph.prototype.toggleCameraSupport=function(){CamSnapshotDialogMorph.prototype.enableCamera=!CamSnapshotDialogMorph.prototype.enableCamera,this.spriteBar.tabBar.tabTo(this.currentTab),this.createCorralBar(),this.fixLayout()},IDE_Morph.prototype.startFastTracking=function(){this.stage.isFastTracked=!0,this.stage.fps=0,this.controlBar.startButton.labelString=new SymbolMorph("flash",14),this.controlBar.startButton.drawNew(),this.controlBar.startButton.fixLayout()},IDE_Morph.prototype.stopFastTracking=function(){this.stage.isFastTracked=!1,this.stage.fps=this.stage.frameRate,this.controlBar.startButton.labelString=new SymbolMorph("flag",14),this.controlBar.startButton.drawNew(),this.controlBar.startButton.fixLayout()},IDE_Morph.prototype.runScripts=function(){this.stage.fireGreenFlagEvent()},IDE_Morph.prototype.togglePauseResume=function(){this.stage.threads.isPaused()?this.stage.threads.resumeAll(this.stage):this.stage.threads.pauseAll(this.stage),this.controlBar.pauseButton.refresh()},IDE_Morph.prototype.isPaused=function(){return!!this.stage&&this.stage.threads.isPaused()},IDE_Morph.prototype.stopAllScripts=function(){this.stage.enableCustomHatBlocks?this.stage.threads.pauseCustomHatBlocks=!this.stage.threads.pauseCustomHatBlocks:this.stage.threads.pauseCustomHatBlocks=!1,this.controlBar.stopButton.refresh(),this.stage.fireStopAllEvent()},IDE_Morph.prototype.selectSprite=function(t){this.currentSprite&&this.currentSprite.scripts.focus&&this.currentSprite.scripts.focus.stopEditing(),this.currentSprite=t,this.createPalette(),this.createSpriteBar(),this.createSpriteEditor(),this.corral.refresh(),this.fixLayout("selectSprite"),this.currentSprite.scripts.fixMultiArgs()},IDE_Morph.prototype.toggleRetina=function(){isRetinaEnabled()?disableRetinaSupport():enableRetinaSupport(),this.world().fillPage(),IDE_Morph.prototype.scriptsPaneTexture=this.scriptsTexture(),this.stage.clearPenTrails(),this.drawNew(),this.refreshIDE()},IDE_Morph.prototype.defaultDesign=function(){this.setDefaultDesign(),this.refreshIDE(),this.removeSetting("design")},IDE_Morph.prototype.flatDesign=function(){this.setFlatDesign(),this.refreshIDE(),this.saveSetting("design","flat")},IDE_Morph.prototype.refreshIDE=function(){var t;if(Process.prototype.isCatchingErrors)try{t=this.serializer.serialize(this.stage)}catch(t){this.showMessage("Serialization failed: "+t)}else t=this.serializer.serialize(this.stage);SpriteMorph.prototype.initBlocks(),this.buildPanes(),this.fixLayout(),this.loadNewProject?this.newProject():this.openProjectString(t)},IDE_Morph.prototype.applySavedSettings=function(){var t=this.getSetting("design"),e=this.getSetting("zoom"),o=this.getSetting("click"),i=this.getSetting("longform"),r=this.getSetting("longurls"),n=this.getSetting("plainprototype"),s=this.getSetting("keyboard"),a=this.getSetting("tables"),h=this.getSetting("tableLines"),l=this.getSetting("autowrapping");"flat"===t?this.setFlatDesign():this.setDefaultDesign(),e&&(SyntaxElementMorph.prototype.setScale(Math.min(e,12)),CommentMorph.prototype.refreshScale(),SpriteMorph.prototype.initBlocks()),this.userLanguage="fr",o&&!BlockMorph.prototype.snapSound&&BlockMorph.prototype.toggleSnapSound(),i&&(InputSlotDialogMorph.prototype.isLaunchingExpanded=!0),this.projectsInURLs=!!r,ScriptsMorph.prototype.enableKeyboard="false"!==s,List.prototype.enableTables="false"!==a,TableMorph.prototype.highContrast=!!h,ScriptsMorph.prototype.enableNestedAutoWrapping="false"!==l,n&&(BlockLabelPlaceHolderMorph.prototype.plainLabel=!0)},IDE_Morph.prototype.saveSetting=function(t,e){this.savingPreferences&&this.hasLocalStorage()&&(localStorage["-snap-setting-"+t]=e)},IDE_Morph.prototype.getSetting=function(t){return this.hasLocalStorage()?localStorage["-snap-setting-"+t]:null},IDE_Morph.prototype.removeSetting=function(t){this.hasLocalStorage()&&delete localStorage["-snap-setting-"+t]},IDE_Morph.prototype.hasLocalStorage=function(){try{return!isNil(localStorage)}catch(t){return!1}},IDE_Morph.prototype.addNewSprite=function(){var t=new SpriteMorph(this.globalVariables),e=Process.prototype.reportRandom;t.name=this.newSpriteName(t.name),t.setCenter(this.stage.center()),this.stage.add(t),t.setHue(e.call(this,0,100)),t.setBrightness(e.call(this,50,100)),t.turn(e.call(this,1,360)),t.setXPosition(e.call(this,-220,220)),t.setYPosition(e.call(this,-160,160)),this.sprites.add(t),this.corral.addSprite(t),this.selectSprite(t)},IDE_Morph.prototype.paintNewSprite=function(){var t=new SpriteMorph(this.globalVariables),e=new Costume,o=this;t.name=this.newSpriteName(t.name),t.setCenter(this.stage.center()),this.stage.add(t),this.sprites.add(t),this.corral.addSprite(t),this.selectSprite(t),e.edit(this.world(),this,!0,function(){o.removeSprite(t)},function(){t.addCostume(e),t.wearCostume(e)})},IDE_Morph.prototype.newCamSprite=function(){var t=new SpriteMorph(this.globalVariables),e=this;t.name=this.newSpriteName(t.name),t.setCenter(this.stage.center()),this.stage.add(t),this.sprites.add(t),this.corral.addSprite(t),this.selectSprite(t),new CamSnapshotDialogMorph(this,t,function(){e.removeSprite(t)},function(e){t.addCostume(e),t.wearCostume(e),this.close()}).popUp(this.world())},IDE_Morph.prototype.duplicateSprite=function(t){var e=t.fullCopy();e.setPosition(this.world().hand.position()),e.appearIn(this),e.keepWithin(this.stage),this.selectSprite(e)},IDE_Morph.prototype.instantiateSprite=function(t){var e=t.fullCopy(!0),o=e.allHatBlocksFor("__clone__init__");e.appearIn(this),o.length?e.initClone(o):(e.setPosition(this.world().hand.position()),e.keepWithin(this.stage)),this.selectSprite(e)},IDE_Morph.prototype.removeSprite=function(t){var e,o=this;t.parts.forEach(function(t){o.removeSprite(t)}),e=this.sprites.asArray().indexOf(t)+1,this.stage.threads.stopAllForReceiver(t),t.corpsify(),t.destroy(),this.stage.watchers().forEach(function(e){e.object()===t&&e.destroy()}),e>0&&this.sprites.remove(e),this.createCorral(),this.fixLayout(),this.currentSprite=detect(this.stage.children,function(t){return t instanceof SpriteMorph&&!t.isTemporary})||this.stage,this.selectSprite(this.currentSprite)},IDE_Morph.prototype.newSpriteName=function(t,e){for(var o=t.indexOf("("),i=o<0?t:t.substring(0,o),r=1,n=i,s=this.sprites.asArray().concat(this.stage).filter(function(t){return t!==e}).map(function(t){return t.name});contains(s,n);)n=i+"("+(r+=1)+")";return n},IDE_Morph.prototype.removeBlock=function(t,e){this.stage.threads.stopAllForBlock(t),t.destroy(e)},IDE_Morph.prototype.userMenu=function(){return new MenuMorph(this)},IDE_Morph.prototype.snapMenu=function(){var t,e=this,o=this.world();(t=new MenuMorph(this)).addItem("About...","aboutSnap"),t.addLine(),t.addItem("Reference manual",function(){var t=e.resourceURL("help","SnapManual.pdf");window.open(t,"SnapReferenceManual")}),t.addItem("Snap! website",function(){window.open("http://snap.berkeley.edu/","SnapWebsite")}),t.addItem("Download source",function(){window.open("http://snap.berkeley.edu/snapsource/snap.zip","SnapSource")}),o.isDevMode?(t.addLine(),t.addItem("Switch back to user mode","switchToUserMode","disable deep-Morphic\ncontext menus\nand show user-friendly ones",new Color(0,100,0))):16===o.currentKey&&(t.addLine(),t.addItem("Switch to dev mode","switchToDevMode","enable Morphic\ncontext menus\nand inspectors,\nnot user-friendly!",new Color(100,0,0))),t.popup(o,this.logo.bottomLeft())},IDE_Morph.prototype.cloudMenu=function(){var t,e=this,o=this.world(),i=this.controlBar.cloudButton.bottomLeft(),r=16===o.currentKey;t=new MenuMorph(this),r&&(t.addItem("url...","setCloudURL",null,new Color(100,0,0)),t.addLine()),SnapCloud.username?(t.addItem(localize("Logout")+" "+SnapCloud.username,"logout"),t.addItem("Change Password...","changeCloudPassword")):(t.addItem("Login...","initializeCloud"),t.addItem("Signup...","createCloudAccount"),t.addItem("Reset Password...","resetCloudPassword")),r&&(t.addLine(),t.addItem("export project media only...",function(){e.projectName?e.exportProjectMedia(e.projectName):e.prompt("Export Project As...",function(t){e.exportProjectMedia(t)},null,"exportProject")},null,this.hasChangedMedia?new Color(100,0,0):new Color(0,100,0)),t.addItem("export project without media...",function(){e.projectName?e.exportProjectNoMedia(e.projectName):e.prompt("Export Project As...",function(t){e.exportProjectNoMedia(t)},null,"exportProject")},null,new Color(100,0,0)),t.addItem("export project as cloud data...",function(){e.projectName?e.exportProjectAsCloudData(e.projectName):e.prompt("Export Project As...",function(t){e.exportProjectAsCloudData(t)},null,"exportProject")},null,new Color(100,0,0)),t.addLine(),t.addItem("open shared project from cloud...",function(){e.prompt("Author name…",function(t){e.prompt("Project name...",function(o){var i="Username="+encodeURIComponent(t.toLowerCase())+"&ProjectName="+encodeURIComponent(o);e.showMessage("Fetching project\nfrom the cloud..."),SnapCloud.getPublicProject(i,function(t){var o;Process.prototype.isCatchingErrors||window.open("data:text/xml,"+t),e.nextSteps([function(){o=e.showMessage("Opening project...")},function(){nop()},function(){e.rawOpenCloudDataString(t)},function(){o.destroy()}])},e.cloudError())},null,"project")},null,"project")},null,new Color(100,0,0))),t.popup(o,i)},IDE_Morph.prototype.settingsMenu=function(){function t(t,o,i,r,n,a){a&&!s||e.addItem((i?"☑ ":"☐ ")+localize(t),o,i?r:n,a?new Color(100,0,0):null)}var e,o=this.stage,i=this.world(),r=this,n=this.controlBar.settingsButton.bottomLeft(),s=16===i.currentKey;(e=new MenuMorph(this)).addItem("Language...","languageMenu"),e.addItem("Zoom blocks...","userSetBlocksScale"),e.addItem("Stage size...","userSetStageSize"),s&&e.addItem("Dragging threshold...","userSetDragThreshold","specify the distance the hand has to move\nbefore it picks up an object",new Color(100,0,0)),e.addLine(),isRetinaSupported()&&t("Retina display support","toggleRetina",isRetinaEnabled(),"uncheck for lower resolution,\nsaves computing resources","check for higher resolution,\nuses more computing resources"),t("Input sliders","toggleInputSliders",MorphicPreferences.useSliderForInput,"uncheck to disable\ninput sliders for\nentry fields","check to enable\ninput sliders for\nentry fields"),MorphicPreferences.useSliderForInput&&t("Execute on slider change","toggleSliderExecute",ArgMorph.prototype.executeOnSliderEdit,"uncheck to suppress\nrunning scripts\nwhen moving the slider","check to run\nthe edited script\nwhen moving the slider"),t("Turbo mode","toggleFastTracking",this.stage.isFastTracked,"uncheck to run scripts\nat normal speed","check to prioritize\nscript execution"),t("Visible stepping","toggleSingleStepping",Process.prototype.enableSingleStepping,"uncheck to turn off\nvisible stepping","check to turn on\n visible stepping (slow)",!1),t("Ternary Boolean slots",function(){BooleanSlotMorph.prototype.isTernary=!BooleanSlotMorph.prototype.isTernary},BooleanSlotMorph.prototype.isTernary,"uncheck to limit\nBoolean slots to true / false","check to allow\nempty Boolean slots",!0),t("Camera support","toggleCameraSupport",CamSnapshotDialogMorph.prototype.enableCamera,"uncheck to disable\ncamera support","check to enable\ncamera support",!0),e.addLine(),t("Blurred shadows","toggleBlurredShadows",useBlurredShadows,"uncheck to use solid drop\nshadows and highlights","check to use blurred drop\nshadows and highlights",!0),t("Zebra coloring","toggleZebraColoring",BlockMorph.prototype.zebraContrast,"uncheck to disable alternating\ncolors for nested block","check to enable alternating\ncolors for nested blocks",!0),t("Dynamic input labels","toggleDynamicInputLabels",SyntaxElementMorph.prototype.dynamicInputLabels,"uncheck to disable dynamic\nlabels for variadic inputs","check to enable dynamic\nlabels for variadic inputs",!0),t("Prefer empty slot drops","togglePreferEmptySlotDrops",ScriptsMorph.prototype.isPreferringEmptySlots,"uncheck to allow dropped\nreporters to kick out others","settings menu prefer empty slots hint",!0),t("Long form input dialog","toggleLongFormInputDialog",InputSlotDialogMorph.prototype.isLaunchingExpanded,"uncheck to use the input\ndialog in short form","check to always show slot\ntypes in the input dialog"),t("Plain prototype labels","togglePlainPrototypeLabels",BlockLabelPlaceHolderMorph.prototype.plainLabel,"uncheck to always show (+) symbols\nin block prototype labels","check to hide (+) symbols\nin block prototype labels"),t("Virtual keyboard","toggleVirtualKeyboard",MorphicPreferences.useVirtualKeyboard,"uncheck to disable\nvirtual keyboard support\nfor mobile devices","check to enable\nvirtual keyboard support\nfor mobile devices",!0),t("Clicking sound",function(){BlockMorph.prototype.toggleSnapSound(),BlockMorph.prototype.snapSound?r.saveSetting("click",!0):r.removeSetting("click")},BlockMorph.prototype.snapSound,"uncheck to turn\nblock clicking\nsound off","check to turn\nblock clicking\nsound on"),t("Animations",function(){r.isAnimating=!r.isAnimating},r.isAnimating,"uncheck to disable\nIDE animations","check to enable\nIDE animations",!0),t("Cache Inputs",function(){BlockMorph.prototype.isCachingInputs=!BlockMorph.prototype.isCachingInputs},BlockMorph.prototype.isCachingInputs,"uncheck to stop caching\ninputs (for debugging the evaluator)","check to cache inputs\nboosts recursion",!0),t("Rasterize SVGs",function(){MorphicPreferences.rasterizeSVGs=!MorphicPreferences.rasterizeSVGs},MorphicPreferences.rasterizeSVGs,"uncheck for smooth\nscaling of vector costumes","check to rasterize\nSVGs on import",!0),t("Flat design",function(){if(MorphicPreferences.isFlat)return r.defaultDesign();r.flatDesign()},MorphicPreferences.isFlat,"uncheck for default\nGUI design","check for alternative\nGUI design",!1),t("Nested auto-wrapping",function(){ScriptsMorph.prototype.enableNestedAutoWrapping=!ScriptsMorph.prototype.enableNestedAutoWrapping,ScriptsMorph.prototype.enableNestedAutoWrapping?r.removeSetting("autowrapping"):r.saveSetting("autowrapping",!1)},ScriptsMorph.prototype.enableNestedAutoWrapping,"uncheck to confine auto-wrapping\nto top-level block stacks","check to enable auto-wrapping\ninside nested block stacks",!0),t("Project URLs",function(){r.projectsInURLs=!r.projectsInURLs,r.projectsInURLs?r.saveSetting("longurls",!0):r.removeSetting("longurls")},r.projectsInURLs,"uncheck to disable\nproject data in URLs","check to enable\nproject data in URLs",!0),t("Sprite Nesting",function(){SpriteMorph.prototype.enableNesting=!SpriteMorph.prototype.enableNesting},SpriteMorph.prototype.enableNesting,"uncheck to disable\nsprite composition","check to enable\nsprite composition",!0),t("First-Class Sprites",function(){SpriteMorph.prototype.enableFirstClass=!SpriteMorph.prototype.enableFirstClass,r.currentSprite.blocksCache.sensing=null,r.currentSprite.paletteCache.sensing=null,r.refreshPalette()},SpriteMorph.prototype.enableFirstClass,"uncheck to disable support\nfor first-class sprites","check to enable support\n for first-class sprite",!0),t("Keyboard Editing",function(){ScriptsMorph.prototype.enableKeyboard=!ScriptsMorph.prototype.enableKeyboard,r.currentSprite.scripts.updateToolbar(),ScriptsMorph.prototype.enableKeyboard?r.removeSetting("keyboard"):r.saveSetting("keyboard",!1)},ScriptsMorph.prototype.enableKeyboard,"uncheck to disable\nkeyboard editing support","check to enable\nkeyboard editing support",!0),t("Table support",function(){List.prototype.enableTables=!List.prototype.enableTables,List.prototype.enableTables?r.removeSetting("tables"):r.saveSetting("tables",!1)},List.prototype.enableTables,"uncheck to disable\nmulti-column list views","check for multi-column\nlist view support",!0),List.prototype.enableTables&&t("Table lines",function(){TableMorph.prototype.highContrast=!TableMorph.prototype.highContrast,TableMorph.prototype.highContrast?r.saveSetting("tableLines",!0):r.removeSetting("tableLines")},TableMorph.prototype.highContrast,"uncheck for less contrast\nmulti-column list views","check for higher contrast\ntable views",!0),t("Live coding support",function(){Process.prototype.enableLiveCoding=!Process.prototype.enableLiveCoding},Process.prototype.enableLiveCoding,"EXPERIMENTAL! uncheck to disable live\ncustom control structures","EXPERIMENTAL! check to enable\n live custom control structures",!0),e.addLine(),t("Thread safe scripts",function(){o.isThreadSafe=!o.isThreadSafe},this.stage.isThreadSafe,"uncheck to allow\nscript reentrance","check to disallow\nscript reentrance"),t("Prefer smooth animations","toggleVariableFrameRate",StageMorph.prototype.frameRate,"uncheck for greater speed\nat variable frame rates","check for smooth, predictable\nanimations across computers",!0),t("Flat line ends",function(){SpriteMorph.prototype.useFlatLineEnds=!SpriteMorph.prototype.useFlatLineEnds},SpriteMorph.prototype.useFlatLineEnds,"uncheck for round ends of lines","check for flat ends of lines"),t("Codification support",function(){StageMorph.prototype.enableCodeMapping=!StageMorph.prototype.enableCodeMapping,r.currentSprite.blocksCache.variables=null,r.currentSprite.paletteCache.variables=null,r.refreshPalette()},StageMorph.prototype.enableCodeMapping,"uncheck to disable\nblock to text mapping features","check for block\nto text mapping features",!1),t("Inheritance support",function(){StageMorph.prototype.enableInheritance=!StageMorph.prototype.enableInheritance,r.currentSprite.blocksCache.variables=null,r.currentSprite.paletteCache.variables=null,r.refreshPalette()},StageMorph.prototype.enableInheritance,"uncheck to disable\nsprite inheritance features","check for sprite\ninheritance features",!1),t("Persist linked sublist IDs",function(){StageMorph.prototype.enableSublistIDs=!StageMorph.prototype.enableSublistIDs},StageMorph.prototype.enableSublistIDs,"uncheck to disable\nsaving linked sublist identities","check to enable\nsaving linked sublist identities",!0),e.popup(i,n)},IDE_Morph.prototype.projectMenu=function(){var t,e=this,o=this.world(),i=this.controlBar.projectButton.bottomLeft(),r=this.currentSprite instanceof SpriteMorph?"Costumes":"Backgrounds",n=16===o.currentKey;(t=new MenuMorph(this)).addItem("Project notes...","editProjectNotes"),t.addLine(),t.addPair("New","createNewProject","^N"),t.addPair("Open...","openProjectsBrowser","^O"),t.addPair("Save","save","^S"),t.addItem("Save As...","saveProjectsBrowser"),t.addLine(),t.addItem("Import...",function(){var t=document.createElement("input");e.filePicker&&(document.body.removeChild(e.filePicker),e.filePicker=null),t.type="file",t.style.color="transparent",t.style.backgroundColor="transparent",t.style.border="none",t.style.outline="none",t.style.position="absolute",t.style.top="0px",t.style.left="0px",t.style.width="0px",t.style.height="0px",t.style.display="none",t.addEventListener("change",function(){document.body.removeChild(t),e.filePicker=null,o.hand.processDrop(t.files)},!1),document.body.appendChild(t),e.filePicker=t,t.click()},"file menu import hint"),n&&t.addItem(localize("Export project...")+" "+localize("(in a new window)"),function(){e.projectName?e.exportProject(e.projectName,n):e.prompt("Export Project As...",function(t){e.exportProject(t,!1)},null,"exportProject")},"show project data as XML\nin a new browser window",new Color(100,0,0)),t.addItem(n?"Export project as plain text...":"Export project...",function(){e.projectName?e.exportProject(e.projectName,n):e.prompt("Export Project As...",function(t){e.exportProject(t,n)},null,"exportProject")},"save project data as XML\nto your downloads folder",n?new Color(100,0,0):null),this.stage.globalBlocks.length&&(t.addItem("Export blocks...",function(){e.exportGlobalBlocks()},"show global custom block definitions as XML\nin a new browser window"),t.addItem("Unused blocks...",function(){e.removeUnusedBlocks()},"find unused global custom blocks\nand remove their definitions")),t.addItem("Export summary...",function(){e.exportProjectSummary()},"open a new browser browser window\n with a summary of this project"),n&&(t.addItem("Export summary with drop-shadows...",function(){e.exportProjectSummary(!0)},"open a new browser browser window\nwith a summary of this project\nwith drop-shadows on all pictures.\nnot supported by all browsers",new Color(100,0,0)),t.addItem("Export all scripts as pic...",function(){e.exportScriptsPicture()},"show a picture of all scripts\nand block definitions",new Color(100,0,0))),t.addLine(),t.addItem("Import tools",function(){e.getURL(e.resourceURL("tools.xml"),function(t){e.droppedText(t,"tools")})},"load the official library of\npowerful blocks"),t.addItem("Libraries...",function(){e.getURL(e.resourceURL("libraries","LIBRARIES"),function(t){var o=e.parseResourceFile(t);new LibraryImportDialogMorph(e,o).popUp()})},"Select categories of additional blocks to add to this project."),t.addItem(localize(r)+"...",function(){e.importMedia(r)},"Select a costume from the media library"),t.addItem(localize("Sounds")+"...",function(){e.importMedia("Sounds")},"Select a sound from the media library"),t.popup(o,i)},IDE_Morph.prototype.resourceURL=function(){return Array.prototype.slice.call(arguments,0).join("/")},IDE_Morph.prototype.getMediaList=function(t,e){function o(t,e){return t.name.toLowerCase()<e.name.toLowerCase()?-1:1}var i,r=this.resourceURL(t,t.toUpperCase()),n=this;if(!(e instanceof Function))return(i=this.parseResourceFile(this.getURL(r))).sort(o),i;this.getURL(r,function(t){var i=n.parseResourceFile(t);i.sort(o),e.call(this,i)})},IDE_Morph.prototype.parseResourceFile=function(t){var e,o=[];return t.split("\n").map(function(t){return t.trim()}).filter(function(t){return t.length>0}).forEach(function(t){(e=t.split("\t").map(function(t){return t.trim()})).length<2||o.push({fileName:e[0],name:e[1],description:e.length>2?e[2]:""})}),o},IDE_Morph.prototype.importMedia=function(t){var e=this,o=this.showMessage("Opening "+t+"...");this.getMediaList(t,function(i){o.destroy(),e.popupMediaImportDialog(t,i)})},IDE_Morph.prototype.popupMediaImportDialog=function(t,e){var o=(new DialogBoxMorph).withKey("import"+t),i=new ScrollFrameMorph,r=null,n=new SymbolMorph("turtle",60),s=this,a=this.world();i.acceptsDrops=!1,i.contents.acceptsDrops=!1,i.color=s.groupColor,i.fixLayout=nop,o.labelString=t,o.createLabel(),o.addBody(i),o.addButton("ok","Import"),o.addButton("cancel","Cancel"),o.ok=function(){r&&(r.object instanceof Sound?s.droppedAudio(r.object.copy().audio,r.labelString):r.object instanceof SVG_Costume?s.droppedSVG(r.object.contents,r.labelString):s.droppedImage(r.object.contents,r.labelString))},o.fixLayout=function(){var t,e,o=fontHeight(this.titleFontSize)+2*this.titlePadding,r=0,n=0;this.buttons.fixLayout(),this.body.setPosition(this.position().add(new Point(this.padding,o+this.padding))),this.body.setExtent(new Point(this.width()-2*this.padding,this.height()-3*this.padding-o-this.buttons.height())),t=this.body.position(),e=this.body.width(),i.contents.children.forEach(function(o){o.setPosition(t.add(new Point(r,n))),(r+=o.width())+o.width()>e&&(r=0,n+=o.height())}),i.contents.adjustBounds(),this.label.setCenter(this.center()),this.label.setTop(this.top()+(o-this.label.height())/2),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding)},e.forEach(function(e){var a,h,l,p=s.resourceURL(t,e.fileName),c=new Image,d=p.slice(p.lastIndexOf(".")+1).toLowerCase(),u="svg"===d&&!MorphicPreferences.rasterizeSVGs,g=contains(["wav","mp3"],d);g?h=l=new SoundIconMorph(new Sound(new Audio,e.name),h):a=l=new CostumeIconMorph(new Costume(n.image,e.name),a),l.isDraggable=!1,l.userMenu=nop,l.action=function(){if(r!==l){var t=r;r=l,t&&t.refresh()}},l.doubleClickAction=o.ok,l.query=function(){return l===r},i.addContents(l),g?(l.object.audio.onloadeddata=function(){l.createThumbnail(),l.fixLayout(),l.refresh()},l.object.audio.src=p,l.object.audio.load()):u?(c.onload=function(){l.object=new SVG_Costume(c,e.name),l.refresh()},s.getURL(p,function(t){c.src="data:image/svg+xml;base64,"+window.btoa(t)})):(c.onload=function(){var t=newCanvas(new Point(c.width,c.height),!0);t.getContext("2d").drawImage(c,0,0),l.object=new Costume(t,e.name),l.refresh()},c.src=p)}),o.popUp(a),o.setExtent(new Point(400,300)),o.setCenter(a.center()),o.drawNew(),new HandleMorph(o,300,280,o.corner,o.corner)},IDE_Morph.prototype.aboutSnap=function(){var t,e,o,i,r,n,s,a,h,l,p,c,d="",u=this.world();e="Snap! 4.1.1 - dev -\nBuild Your Own Blocks\n\nCopyright Ⓒ 2017 Jens Mönig and Brian Harvey\njens@moenig.org, bh@cs.berkeley.edu\n\nSnap! is developed by the University of California, Berkeley\n          with support from the National Science Foundation (NSF), MioSoft,          \nthe Communications Design Group (CDG) at SAP Labs, and the\nHuman Advancement Research Community (HARC) at YC Research.\nThe design of Snap! is influenced and inspired by Scratch,\nfrom the Lifelong Kindergarten group at the MIT Media Lab\n\nfor more information see http://snap.berkeley.edu\nand http://scratch.mit.edu",o=localize("License")+"\n\nSnap! is free software: you can redistribute it and/or modify\nit under the terms of the GNU Affero General Public License as\npublished by the Free Software Foundation, either version 3 of\nthe License, or (at your option) any later version.\n\nThis program is distributed in the hope that it will be useful,\nbut WITHOUT ANY WARRANTY; without even the implied warranty of\nMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\nGNU Affero General Public License for more details.\n\nYou should have received a copy of the\nGNU Affero General Public License along with this program.\nIf not, see http://www.gnu.org/licenses/\n\nWant to use Snap! but scared by the open-source license?\nGet in touch with us, we'll make it work.",i=localize("Contributors")+'\n\nNathan Dinsmore: Saving/Loading, Snap-Logo Design, \ncountless bugfixes and optimizations\nKartik Chandra: Paint Editor\nMichael Ball: Time/Date UI, Library Import Dialog,\ncountless bugfixes and optimizations\nBartosz Leper: Retina Display Support\nBernat Romagosa: Countless contributions\n"Ava" Yuan Yuan, Dylan Servilla: Graphic Effects\nKyle Hotchkiss: Block search design\nBrian Broll: Many bugfixes and optimizations\nIan Reynolds: UI Design, Event Bindings, Sound primitives\nIvan Motyashov: Initial Squeak Porting\nLucas Karahadian: Piano Keyboard Design\nDavide Della Casa: Morphic Optimizations\nAchal Dave: Web Audio\nJoe Otto: Morphic Testing and Debugging';for(n in modules)Object.prototype.hasOwnProperty.call(modules,n)&&(d+="\n"+n+" ("+modules[n]+")");""!==d&&(d=localize("current module versions:")+" \n\nmorphic ("+morphicVersion+")"+d),r=localize("Translations")+"\n"+SnapTranslator.credits(),(t=new DialogBoxMorph).inform("About Snap",e,u),s=t.buttons.children[0],c=t.addButton(function(){t.body.text=r,t.body.drawNew(),s.show(),a.show(),h.hide(),l.hide(),p.hide(),c.hide(),t.fixLayout(),t.drawNew(),t.setCenter(u.center())},"Translators..."),(a=t.addButton(function(){t.body.text=e,t.body.drawNew(),s.show(),a.hide(),h.show(),l.show(),p.show(),c.hide(),t.fixLayout(),t.drawNew(),t.setCenter(u.center())},"Back...")).hide(),p=t.addButton(function(){t.body.text=o,t.body.drawNew(),s.show(),a.show(),h.hide(),l.hide(),p.hide(),c.hide(),t.fixLayout(),t.drawNew(),t.setCenter(u.center())},"License..."),h=t.addButton(function(){t.body.text=d,t.body.drawNew(),s.show(),a.show(),h.hide(),l.hide(),p.hide(),c.hide(),t.fixLayout(),t.drawNew(),t.setCenter(u.center())},"Modules..."),l=t.addButton(function(){t.body.text=i,t.body.drawNew(),s.show(),a.show(),c.show(),h.hide(),l.hide(),p.hide(),t.fixLayout(),t.drawNew(),t.setCenter(u.center())},"Credits..."),c.hide(),t.fixLayout(),t.drawNew()},IDE_Morph.prototype.editProjectNotes=function(){var t=(new DialogBoxMorph).withKey("projectNotes"),e=new ScrollFrameMorph,o=new TextMorph(this.projectNotes||""),i=t.ok,r=this,n=this.world();e.padding=6,e.setWidth(250),e.acceptsDrops=!1,e.contents.acceptsDrops=!1,o.setWidth(250-2*e.padding),o.setPosition(e.topLeft().add(e.padding)),o.enableSelecting(),o.isEditable=!0,e.setHeight(250),e.fixLayout=nop,e.edge=InputFieldMorph.prototype.edge,e.fontSize=InputFieldMorph.prototype.fontSize,e.typeInPadding=InputFieldMorph.prototype.typeInPadding,e.contrast=InputFieldMorph.prototype.contrast,e.drawNew=InputFieldMorph.prototype.drawNew,e.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,e.addContents(o),o.drawNew(),t.ok=function(){r.projectNotes=o.text,i.call(this)},t.justDropped=function(){o.edit()},t.labelString="Project Notes",t.createLabel(),t.addBody(e),e.drawNew(),t.addButton("ok","OK"),t.addButton("cancel","Cancel"),t.fixLayout(),t.drawNew(),t.popUp(n),t.setCenter(n.center()),o.edit()},IDE_Morph.prototype.newProject=function(){this.source=SnapCloud.username?"cloud":"local",this.stage&&this.stage.destroy(),"#lang:"!==location.hash.substr(0,6)&&(location.hash=""),this.globalVariables=new VariableFrame,this.currentSprite=new SpriteMorph(this.globalVariables),this.sprites=new List([this.currentSprite]),StageMorph.prototype.dimensions=new Point(480,360),StageMorph.prototype.hiddenPrimitives={},StageMorph.prototype.codeMappings={},StageMorph.prototype.codeHeaders={},StageMorph.prototype.enableCodeMapping=!1,StageMorph.prototype.enableInheritance=!0,StageMorph.prototype.enableSublistIDs=!1,SpriteMorph.prototype.useFlatLineEnds=!1,Process.prototype.enableLiveCoding=!1,this.setProjectName(""),this.projectNotes="",this.createStage(),this.add(this.stage),this.createCorral(),this.selectSprite(this.stage.children[0]),this.fixLayout()},IDE_Morph.prototype.save=function(){"examples"===this.source&&(this.source="local"),this.projectName?"local"===this.source?this.saveProject(this.projectName):this.saveProjectToCloud(this.projectName):this.saveProjectsBrowser()},IDE_Morph.prototype.saveProject=function(t){var e=this;this.nextSteps([function(){e.showMessage("Saving...")},function(){e.rawSaveProject(t)}])},IDE_Morph.prototype.rawSaveProject=function(t){var e;if(t)if(this.setProjectName(t),Process.prototype.isCatchingErrors)try{localStorage["-snap-project-"+t]=e=this.serializer.serialize(this.stage),this.setURL("#open:"+e),this.showMessage("Saved!",1)}catch(t){this.showMessage("Save failed: "+t)}else localStorage["-snap-project-"+t]=e=this.serializer.serialize(this.stage),this.setURL("#open:"+e),this.showMessage("Saved!",1)},IDE_Morph.prototype.exportProject=function(t,e){var o,i,r;if(t){this.setProjectName(t),r="plain,";try{o=this.showMessage("Exporting"),i=this.serializer.serialize(this.stage),this.setURL("#open:"+r+encodeURIComponent(i)),this.saveXMLAs(i,t),o.destroy(),this.showMessage("Exported!",1)}catch(t){if(!Process.prototype.isCatchingErrors)throw t;this.showMessage("Export failed: "+t)}}},IDE_Morph.prototype.exportGlobalBlocks=function(){this.stage.globalBlocks.length>0?new BlockExportDialogMorph(this.serializer,this.stage.globalBlocks).popUp(this.world()):this.inform("Export blocks","this project doesn't have any\ncustom global blocks yet")},IDE_Morph.prototype.removeUnusedBlocks=function(){for(var t,e=this.sprites.asArray().concat([this.stage]),o=this.stage.globalBlocks,i=[],r=!1;!r;)(t=o.filter(function(t){return!contains(i,t)&&e.every(function(e,o){return!e.usesBlockInstance(t,!0,o,i)})})).length?i=i.concat(t):r=!0;i.length>0?new BlockRemovalDialogMorph(i,this.stage).popUp(this.world()):this.inform("Remove unused blocks","there are currently no unused\nglobal custom blocks in this project")},IDE_Morph.prototype.exportSprite=function(t){var e=this.serializer.serialize(t.allParts());e='<sprites app="'+this.serializer.app+'" version="'+this.serializer.version+'">'+e+"</sprites>",this.saveXMLAs(e,t.name)},IDE_Morph.prototype.exportScriptsPicture=function(){var t,e,o=[],i=0,r=0,n=0;this.sprites.asArray().forEach(function(t){o.push(t.image),o.push(t.scripts.scriptsPicture()),t.customBlocks.forEach(function(t){o.push(t.scriptsPicture())})}),o.push(this.stage.image),o.push(this.stage.scripts.scriptsPicture()),this.stage.customBlocks.forEach(function(t){o.push(t.scriptsPicture())}),this.stage.globalBlocks.forEach(function(t){o.push(t.scriptsPicture())}),(o=o.filter(function(t){return!isNil(t)})).forEach(function(t){i=Math.max(i,t.width),r+=t.height,r+=20}),t=newCanvas(new Point(i,r-=20)),e=t.getContext("2d"),o.forEach(function(t){e.drawImage(t,0,n),n+=20,n+=t.height}),this.saveCanvasAs(t,this.projectName||localize("Untitled"))},IDE_Morph.prototype.exportProjectSummary=function(t){function e(t,e,o){return e||(e=h),new XML_Element(t,o,e)}function o(t,e,o){return e||(e="p"),o||(o=h),new XML_Element(e,t,o)}function i(t,o,i){o||(o=h);var r=e("img",(i?null:e("p",o))||o);return r.attributes.src=t.toDataURL(),r}function r(t){var r,n=t.names().sort(),s=!0;n.length&&(o(localize("Variables"),"h3"),n.forEach(function(o){var n,a,h;s&&(r=e("ul"),s=!1),h=e("li",r),(a=(n=new WatcherMorph(o,SpriteMorph.prototype.blockColor.variables,t,o)).cellMorph.contentsMorph)instanceof ListWatcherMorph&&a.expand(),i(n.fullImageClassic(),h).attributes.class="script"}))}function n(t){t.length&&(o(localize("Blocks"),"h3"),SpriteMorph.prototype.categories.forEach(function(r){var n,s=!0;t.forEach(function(t){var a;t.category===r&&(s&&(o(localize(r[0].toUpperCase().concat(r.slice(1))),"h4"),n=e("ul"),s=!1),a=e("li",n),i(t.templateInstance().scriptPic(),a).attributes.class="script",t.sortedElements().forEach(function(t){i(t instanceof BlockMorph?t.scriptPic():t.fullImageClassic(),a).attributes.class="script"}))})}))}var s,a,h,l,p,c,d=this.stage;l=this.projectName||localize("untitled"),(s=new XML_Element("html")).attributes.lang=SnapTranslator.language,e("meta",a=e("head",s)).attributes.charset="UTF-8",e("style",a,t?"img {vertical-align: top;filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));-webkit-filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));-ms-filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));}.toc {vertical-align: middle;padding: 2px 1em 2px 1em;}":"img {vertical-align: top;}.toc {vertical-align: middle;padding: 2px 1em 2px 1em;}.sprite {border: 1px solid lightgray;}"),o(l,"title",a),h=e("body",s),o(l,"h1"),0===location.hash.indexOf("#present:")?(o(location.toString(),"a",h).attributes.href=location.toString(),i(d.thumbnail(d.dimensions)).attributes.class="sprite",o(this.serializer.app,"h4")):(o(this.serializer.app,"h4"),i(d.thumbnail(d.dimensions)).attributes.class="sprite"),Process.prototype.reportTextSplit(this.projectNotes,"line").asArray().forEach(function(t){o(t)}),o(localize("Contents"),"h4"),p=e("ul"),this.sprites.asArray().concat([d]).forEach(function(t){var s,a=e("li",p),h=t.scripts.sortedElements(),l=t.costumes.length();e("hr"),i(t.thumbnail(new Point(40,40)),a,!0).attributes.class="toc",o(t.name,"a",a).attributes.href="#"+t.name,o(t.name,"h2").attributes.id=t.name,i(t.thumbnail(t.extent().divideBy(d.scale))).attributes.class="sprite",t instanceof SpriteMorph&&(t.exemplar&&(i(t.exemplar.thumbnail(new Point(40,40)),o(localize("Kind of")+" "+t.exemplar.name),!0).attributes.class="toc"),t.anchor&&(i(t.anchor.thumbnail(new Point(40,40)),o(localize("Part of")+" "+t.anchor.name),!0).attributes.class="toc"),t.parts.length&&(o(localize("Parts"),"h3"),s=e("ul"),t.parts.forEach(function(t){var o=e("li",s,t.name);i(t.thumbnail(new Point(40,40)),o,!0).attributes.class="toc"}))),(l>1||t.getCostumeIdx()!==l)&&(o(localize("Costumes"),"h3"),s=e("ol"),t.costumes.asArray().forEach(function(t){var o=e("li",s,t.name);i(t.thumbnail(new Point(40,40)),o,!0).attributes.class="toc"})),t.sounds.length()&&(o(localize("Sounds"),"h3"),s=e("ol"),t.sounds.asArray().forEach(function(t){o(t.name,"li",s)})),r(t.variables),h.length&&(o(localize("Scripts"),"h3"),h.forEach(function(t){i(t instanceof BlockMorph?t.scriptPic():t.fullImageClassic()).attributes.class="script"})),n(t.customBlocks)}),c=d.globalVariables(),(Object.keys(c.vars).length||d.globalBlocks.length)&&(e("hr"),o(localize("For all Sprites"),"a",e("li",p)).attributes.href="#global",o(localize("For all Sprites"),"h2").attributes.id="global",r(c),n(d.globalBlocks)),this.saveFileAs("<!DOCTYPE html>"+s.toString(),"text/html;charset=utf-8",l)},IDE_Morph.prototype.openProjectString=function(t){var e,o=this;this.nextSteps([function(){e=o.showMessage("Opening project...")},function(){nop()},function(){o.rawOpenProjectString(t)},function(){e.destroy()}])},IDE_Morph.prototype.rawOpenProjectString=function(t){if(this.toggleAppMode(!1),this.spriteBar.tabBar.tabTo("scripts"),StageMorph.prototype.hiddenPrimitives={},StageMorph.prototype.codeMappings={},StageMorph.prototype.codeHeaders={},StageMorph.prototype.enableCodeMapping=!1,StageMorph.prototype.enableInheritance=!0,StageMorph.prototype.enableSublistIDs=!1,Process.prototype.enableLiveCoding=!1,Process.prototype.isCatchingErrors)try{this.serializer.openProject(this.serializer.load(t,this),this)}catch(t){this.showMessage("Load failed: "+t)}else this.serializer.openProject(this.serializer.load(t,this),this);this.stopFastTracking(),$(".snapScript").val(t)},IDE_Morph.prototype.openBlocksString=function(t,e,o){var i,r=this;this.nextSteps([function(){i=r.showMessage("Opening blocks...")},function(){nop()},function(){r.rawOpenBlocksString(t,e,o)},function(){i.destroy()}])},IDE_Morph.prototype.rawOpenBlocksString=function(t,e,o){var i,r=this;if(Process.prototype.isCatchingErrors)try{i=this.serializer.loadBlocks(t,r.stage)}catch(t){this.showMessage("Load failed: "+t)}else i=this.serializer.loadBlocks(t,r.stage);o?(i.forEach(function(t){t.receiver=r.stage,r.stage.globalBlocks.push(t),r.stage.replaceDoubleDefinitionsFor(t)}),this.flushPaletteCache(),this.refreshPalette(),this.showMessage("Imported Blocks Module"+(e?": "+e:"")+".",2)):new BlockImportDialogMorph(i,this.stage,e).popUp()},IDE_Morph.prototype.openSpritesString=function(t){var e,o=this;this.nextSteps([function(){e=o.showMessage("Opening sprite...")},function(){nop()},function(){o.rawOpenSpritesString(t)},function(){e.destroy()}])},IDE_Morph.prototype.rawOpenSpritesString=function(t){if(Process.prototype.isCatchingErrors)try{this.serializer.loadSprites(t,this)}catch(t){this.showMessage("Load failed: "+t)}else this.serializer.loadSprites(t,this)},IDE_Morph.prototype.openMediaString=function(t){if(Process.prototype.isCatchingErrors)try{this.serializer.loadMedia(t)}catch(t){this.showMessage("Load failed: "+t)}else this.serializer.loadMedia(t);this.showMessage("Imported Media Module.",2)},IDE_Morph.prototype.openScriptString=function(t){var e,o=this;this.nextSteps([function(){e=o.showMessage("Opening script...")},function(){nop()},function(){o.rawOpenScriptString(t)},function(){e.destroy()}])},IDE_Morph.prototype.rawOpenScriptString=function(t){var e,o,i=this.currentSprite.scripts;if(Process.prototype.isCatchingErrors)try{e=this.serializer.parse(t,this.currentSprite),o=this.serializer.loadScript(e,this.currentSprite)}catch(t){this.showMessage("Load failed: "+t)}else e=this.serializer.loadScript(t,this.currentSprite),o=this.serializer.loadScript(e,this.currentSprite);o.setPosition(this.world().hand.position()),i.add(o),i.adjustBounds(),i.lastDroppedBlock=o,i.recordDrop({origin:this.palette,position:this.palette.center()}),this.showMessage("Imported Script.",2)},IDE_Morph.prototype.openProject=function(t){var e;t&&(this.showMessage("opening project\n"+t),this.setProjectName(t),e=localStorage["-snap-project-"+t],this.openProjectString(e),this.setURL("#open:"+e))},IDE_Morph.prototype.setURL=function(t){this.projectsInURLs&&(location.hash=t)},IDE_Morph.prototype.saveFileAs=function(t,e,o){var i,r,n=!1,s=this.world();i="."+("plain"===(i=e.split("/")[1].split(";")[0])?"txt":i);try{n=!!new Blob}catch(t){}n?(t instanceof Blob||(t=function(t,e){var o,i=t,r=t.split(",");if(0===t.indexOf("data:")&&r[0].indexOf("base64")>-1)for(t=atob(r[1]),i=new Uint8Array(t.length),o=t.length;o--;)i[o]=t.charCodeAt(o);return new Blob([i],{type:e})}(t,e)),saveAs(t,o+i,!1)):((r=new DialogBoxMorph).inform(localize("Could not export")+" "+o,"unable to export text",s),r.fixLayout(),r.drawNew())},IDE_Morph.prototype.saveCanvasAs=function(t,e){this.saveFileAs(t.toDataURL(),"image/png",e)},IDE_Morph.prototype.saveXMLAs=function(t,e){this.saveFileAs(t,"text/xml;chartset=utf-8",e)},IDE_Morph.prototype.switchToUserMode=function(){var t=this.world();t.isDevMode=!1,Process.prototype.isCatchingErrors=!0,this.controlBar.updateLabel(),this.isAutoFill=!0,this.isDraggable=!1,this.reactToWorldResize(t.bounds.copy()),this.siblings().forEach(function(e){e instanceof DialogBoxMorph?t.add(e):e.destroy()}),this.flushBlocksCache(),this.refreshPalette(),t.reactToDropOf=function(e){e instanceof DialogBoxMorph||(t.hand.grabOrigin?e.slideBackTo(t.hand.grabOrigin):t.hand.grab(e))},this.showMessage("entering user mode",1)},IDE_Morph.prototype.switchToDevMode=function(){var t=this.world();t.isDevMode=!0,Process.prototype.isCatchingErrors=!1,this.controlBar.updateLabel(),this.isAutoFill=!1,this.isDraggable=!0,this.setExtent(t.extent().subtract(100)),this.setPosition(t.position().add(20)),this.flushBlocksCache(),this.refreshPalette(),delete t.reactToDropOf,this.showMessage("entering development mode.\n\nerror catching is turned off,\nuse the browser's web console\nto see error messages.")},IDE_Morph.prototype.flushBlocksCache=function(t){t?(this.stage.blocksCache[t]=null,this.stage.children.forEach(function(e){e instanceof SpriteMorph&&(e.blocksCache[t]=null)})):(this.stage.blocksCache={},this.stage.children.forEach(function(t){t instanceof SpriteMorph&&(t.blocksCache={})})),this.flushPaletteCache(t)},IDE_Morph.prototype.flushPaletteCache=function(t){t?(this.stage.paletteCache[t]=null,this.stage.children.forEach(function(e){e instanceof SpriteMorph&&(e.paletteCache[t]=null)})):(this.stage.paletteCache={},this.stage.children.forEach(function(t){t instanceof SpriteMorph&&(t.paletteCache={})}))},IDE_Morph.prototype.toggleZebraColoring=function(){var t=[];BlockMorph.prototype.zebraContrast?BlockMorph.prototype.zebraContrast=0:BlockMorph.prototype.zebraContrast=40,this.stage.children.concat(this.stage).forEach(function(e){isSnapObject(e)&&(t=t.concat(e.scripts.children.filter(function(t){return t instanceof BlockMorph})))}),t.forEach(function(t){t.fixBlockColor(null,!0)})},IDE_Morph.prototype.toggleDynamicInputLabels=function(){var t;if(SyntaxElementMorph.prototype.dynamicInputLabels=!SyntaxElementMorph.prototype.dynamicInputLabels,Process.prototype.isCatchingErrors)try{t=this.serializer.serialize(this.stage)}catch(t){this.showMessage("Serialization failed: "+t)}else t=this.serializer.serialize(this.stage);SpriteMorph.prototype.initBlocks(),this.spriteBar.tabBar.tabTo("scripts"),this.createCategories(),this.createCorralBar(),this.openProjectString(t)},IDE_Morph.prototype.toggleBlurredShadows=function(){window.useBlurredShadows=!useBlurredShadows},IDE_Morph.prototype.toggleLongFormInputDialog=function(){InputSlotDialogMorph.prototype.isLaunchingExpanded=!InputSlotDialogMorph.prototype.isLaunchingExpanded,InputSlotDialogMorph.prototype.isLaunchingExpanded?this.saveSetting("longform",!0):this.removeSetting("longform")},IDE_Morph.prototype.togglePlainPrototypeLabels=function(){BlockLabelPlaceHolderMorph.prototype.plainLabel=!BlockLabelPlaceHolderMorph.prototype.plainLabel,BlockLabelPlaceHolderMorph.prototype.plainLabel?this.saveSetting("plainprototype",!0):this.removeSetting("plainprototype")},IDE_Morph.prototype.togglePreferEmptySlotDrops=function(){ScriptsMorph.prototype.isPreferringEmptySlots=!ScriptsMorph.prototype.isPreferringEmptySlots},IDE_Morph.prototype.toggleVirtualKeyboard=function(){MorphicPreferences.useVirtualKeyboard=!MorphicPreferences.useVirtualKeyboard},IDE_Morph.prototype.toggleInputSliders=function(){MorphicPreferences.useSliderForInput=!MorphicPreferences.useSliderForInput},IDE_Morph.prototype.toggleSliderExecute=function(){ArgMorph.prototype.executeOnSliderEdit=!ArgMorph.prototype.executeOnSliderEdit},IDE_Morph.prototype.toggleAppMode=function(t){var e=this.world(),o=[this.logo,this.controlBar.cloudButton,this.controlBar.projectButton,this.controlBar.settingsButton,this.controlBar.steppingButton,this.controlBar.stageSizeButton,this.paletteHandle,this.stageHandle,this.corral,this.corralBar,this.spriteEditor,this.spriteBar,this.palette,this.categories];this.isAppMode=isNil(t)?!this.isAppMode:t,Morph.prototype.trackChanges=!1,this.isAppMode?(this.wasSingleStepping=Process.prototype.enableSingleStepping,this.wasSingleStepping&&this.toggleSingleStepping(),this.setColor(this.appModeColor),this.controlBar.setColor(this.color),this.controlBar.appModeButton.refresh(),o.forEach(function(t){t.hide()}),e.children.forEach(function(t){t instanceof DialogBoxMorph&&t.hide()}),e.keyboardReceiver instanceof ScriptFocusMorph&&e.keyboardReceiver.stopEditing()):(this.wasSingleStepping&&!Process.prototype.enableSingleStepping&&this.toggleSingleStepping(),this.setColor(this.backgroundColor),this.controlBar.setColor(this.frameColor),o.forEach(function(t){t.show()}),this.stage.setScale(1),e.children.forEach(function(t){t instanceof DialogBoxMorph&&t.show()}),e.allChildren().filter(function(t){return t instanceof ScrollFrameMorph}).forEach(function(t){t.adjustScrollBars()}),this.currentSprite===this.stage&&this.spriteBar.children.forEach(function(t){t instanceof PushButtonMorph&&t.hide()}),this.currentSprite.scripts.updateToolbar()),this.setExtent(this.world().extent())},IDE_Morph.prototype.toggleStageSize=function(t,e){function o(){r.isSmallStage=isNil(t)?!r.isSmallStage:t}function i(t){r.isSmallStage=!0,a.animations.push(new Animation(function(t){r.stageRatio=t,r.setExtent(a.extent())},function(){return r.stageRatio},t-r.stageRatio,s,null,function(){r.isSmallStage=1!==t,r.controlBar.stageSizeButton.refresh()}))}var r=this,n=e||.5,s=this.isAnimating?100:0,a=this.world(),h=16===a.currentKey,l=18===a.currentKey;h?(n=3*SpriteIconMorph.prototype.thumbSize.x/this.stage.dimensions.x,this.isSmallStage&&n!==this.stageRatio||o()):l?(n=this.width()/2/this.stage.dimensions.x,this.isSmallStage&&n!==this.stageRatio||o()):o(),i(this.isSmallStage?n:1)},IDE_Morph.prototype.setPaletteWidth=function(t){var e=this.isAnimating?100:0,o=this.world(),i=this;o.animations.push(new Animation(function(t){i.paletteWidth=t,i.setExtent(o.extent())},function(){return i.paletteWidth},t-i.paletteWidth,e))},IDE_Morph.prototype.createNewProject=function(){var t=this;this.confirm("Replace the current project with a new one?","New Project",function(){t.newProject()})},IDE_Morph.prototype.openProjectsBrowser=function(){new ProjectDialogMorph(this,"open").popUp()},IDE_Morph.prototype.saveProjectsBrowser=function(){"examples"===this.source&&(this.source="local"),new ProjectDialogMorph(this,"save").popUp()},IDE_Morph.prototype.languageMenu=function(){var t=new MenuMorph(this),e=this.world(),o=this.controlBar.settingsButton.bottomLeft(),i=this;SnapTranslator.languages().forEach(function(e){t.addItem((SnapTranslator.language===e?"✓ ":"    ")+SnapTranslator.languageName(e),function(){i.loadNewProject=!1,i.setLanguage(e)})}),t.popup(e,o)},IDE_Morph.prototype.setLanguage=function(t,e){this.openDefaultProject(importString)},IDE_Morph.prototype.openDefaultProject=function(t){var e=t;""!=t&&this.openProjectString(e)},IDE_Morph.prototype.reflectLanguage=function(t,e){var o,i=location.hash;if(SnapTranslator.language=t,!this.loadNewProject)if(Process.prototype.isCatchingErrors)try{o=this.serializer.serialize(this.stage)}catch(t){this.showMessage("Serialization failed: "+t)}else o=this.serializer.serialize(this.stage);SpriteMorph.prototype.initBlocks(),this.spriteBar.tabBar.tabTo("scripts"),this.createCategories(),this.createCorralBar(),this.fixLayout(),this.loadNewProject?(this.newProject(),location.hash=i):this.openProjectString(o),this.saveSetting("language",t),e&&e.call(this)},IDE_Morph.prototype.userSetBlocksScale=function(){var t,e,o,i,r,n=this;(t=new CommandBlockMorph).color=SpriteMorph.prototype.blockColor.motion,t.setSpec(localize("build")),(e=new CommandBlockMorph).color=SpriteMorph.prototype.blockColor.sound,e.setSpec(localize("your own")),t.nextBlock(e),(e=new CommandBlockMorph).color=SpriteMorph.prototype.blockColor.operators,e.setSpec(localize("blocks")),t.bottomBlock().nextBlock(e),(i=new FrameMorph).acceptsDrops=!1,i.color=IDE_Morph.prototype.groupColor,i.cachedTexture=this.scriptsPaneTexture,i.setExtent(new Point(250,180)),t.setPosition(i.position().add(10)),i.add(t),(o=new Morph).alpha=0,o.setExtent(i.extent()),o.setPosition(i.position()),i.add(o),r=function(e){t.blockSequence().forEach(function(t){t.setScale(e),t.drawNew(),t.setSpec(t.blockSpec)}),t.changed()},new DialogBoxMorph(null,function(t){n.setBlocksScale(Math.min(t,12))}).withKey("zoomBlocks").prompt("Zoom blocks",SyntaxElementMorph.prototype.scale.toString(),this.world(),i,{"normal (1x)":1,"demo (1.2x)":1.2,"presentation (1.4x)":1.4,"big (2x)":2,"huge (4x)":4,"giant (8x)":8,"monstrous (10x)":10},!1,!0,1,12,r)},IDE_Morph.prototype.setBlocksScale=function(t){var e;if(Process.prototype.isCatchingErrors)try{e=this.serializer.serialize(this.stage)}catch(t){this.showMessage("Serialization failed: "+t)}else e=this.serializer.serialize(this.stage);SyntaxElementMorph.prototype.setScale(t),CommentMorph.prototype.refreshScale(),SpriteMorph.prototype.initBlocks(),this.spriteBar.tabBar.tabTo("scripts"),this.createCategories(),this.createCorralBar(),this.fixLayout(),this.openProjectString(e),this.saveSetting("zoom",t)},IDE_Morph.prototype.userSetStageSize=function(){new DialogBoxMorph(this,this.setStageExtent,this).promptVector("Stage size",StageMorph.prototype.dimensions,new Point(480,360),"Stage width","Stage height",this.world(),null,null)},IDE_Morph.prototype.setStageExtent=function(t){var e=this,o=this.world(),i=t.max(new Point(240,180));this.stageRatio=1,this.isSmallStage=!1,this.controlBar.stageSizeButton.refresh(),this.setExtent(o.extent()),this.isAnimating?e.step=function(){var t=i.subtract(StageMorph.prototype.dimensions).divideBy(2);t.abs().lt(new Point(5,5))?(StageMorph.prototype.dimensions=i,delete e.step):StageMorph.prototype.dimensions=StageMorph.prototype.dimensions.add(t),e.stage.setExtent(StageMorph.prototype.dimensions),e.stage.clearPenTrails(),e.fixLayout(),this.setExtent(o.extent())}:(StageMorph.prototype.dimensions=i,this.stage.setExtent(StageMorph.prototype.dimensions),this.stage.clearPenTrails(),this.fixLayout(),this.setExtent(o.extent()))},IDE_Morph.prototype.userSetDragThreshold=function(){new DialogBoxMorph(this,function(t){MorphicPreferences.grabThreshold=Math.min(Math.max(+t,0),200)},this).prompt("Dragging threshold",MorphicPreferences.grabThreshold.toString(),this.world(),null,null,null,!0)},IDE_Morph.prototype.initializeCloud=function(){var t=this,e=this.world();new DialogBoxMorph(null,function(e){var o,i=hex_sha512(e.password);SnapCloud.login(e.username,i,function(){e.choice&&(o=SnapCloud.encodeDict({username:e.username,password:i}),localStorage["-snap-user"]=o),t.source="cloud",t.showMessage("now connected.",2)},t.cloudError())}).withKey("cloudlogin").promptCredentials("Sign in","login",null,null,null,null,"stay signed in on this computer\nuntil logging out",e,t.cloudIcon(),t.cloudMsg)},IDE_Morph.prototype.createCloudAccount=function(){var t=this,e=this.world();new DialogBoxMorph(null,function(o){SnapCloud.signup(o.username,o.email,function(o,i){(new DialogBoxMorph).inform(i,o+".\n\nAn e-mail with your password\nhas been sent to the address provided",e,t.cloudIcon(null,new Color(0,180,0)))},t.cloudError())}).withKey("cloudsignup").promptCredentials("Sign up","signup","http://snap.berkeley.edu/tos.html","Terms of Service...","http://snap.berkeley.edu/privacy.html","Privacy...","I have read and agree\nto the Terms of Service",e,t.cloudIcon(),t.cloudMsg)},IDE_Morph.prototype.resetCloudPassword=function(){var t=this,e=this.world();new DialogBoxMorph(null,function(o){SnapCloud.resetPassword(o.username,function(o,i){(new DialogBoxMorph).inform(i,o+".\n\nAn e-mail with a link to\nreset your password\nhas been sent to the address provided",e,t.cloudIcon(null,new Color(0,180,0)))},t.cloudError())}).withKey("cloudresetpassword").promptCredentials("Reset password","resetPassword",null,null,null,null,null,e,t.cloudIcon(),t.cloudMsg)},IDE_Morph.prototype.changeCloudPassword=function(){var t=this,e=this.world();new DialogBoxMorph(null,function(e){SnapCloud.changePassword(e.oldpassword,e.password,function(){t.logout(),t.showMessage("password has been changed.",2)},t.cloudError())}).withKey("cloudpassword").promptCredentials("Change Password","changePassword",null,null,null,null,null,e,t.cloudIcon(),t.cloudMsg)},IDE_Morph.prototype.logout=function(){var t=this;delete localStorage["-snap-user"],SnapCloud.logout(function(){SnapCloud.clear(),t.showMessage("disconnected.",2)},function(){SnapCloud.clear(),t.showMessage("disconnected.",2)})},IDE_Morph.prototype.saveProjectToCloud=function(t){var e=this;t&&(this.showMessage("Saving project\nto the cloud..."),this.setProjectName(t),SnapCloud.saveProject(this,function(){e.showMessage("saved.",2)},this.cloudError()))},IDE_Morph.prototype.exportProjectMedia=function(t){var e,o;if(this.serializer.isCollectingMedia=!0,t){this.setProjectName(t);try{e=this.showMessage("Exporting"),o=this.serializer.mediaXML(t),this.saveXMLAs(o,this.projectName+" media"),e.destroy(),this.showMessage("Exported!",1)}catch(t){if(!Process.prototype.isCatchingErrors)throw t;this.serializer.isCollectingMedia=!1,this.showMessage("Export failed: "+t)}}this.serializer.isCollectingMedia=!1,this.serializer.flushMedia()},IDE_Morph.prototype.exportProjectNoMedia=function(t){var e,o;if(this.serializer.isCollectingMedia=!0,t)if(this.setProjectName(t),Process.prototype.isCatchingErrors)try{e=this.showMessage("Exporting"),o=this.serializer.serialize(this.stage),this.saveXMLAs(o,this.projectName),e.destroy(),this.showMessage("Exported!",1)}catch(t){this.serializer.isCollectingMedia=!1,this.showMessage("Export failed: "+t)}else e=this.showMessage("Exporting"),o=this.serializer.serialize(this.stage),this.saveXMLAs(o,this.projectName),e.destroy(),this.showMessage("Exported!",1);this.serializer.isCollectingMedia=!1,this.serializer.flushMedia()},IDE_Morph.prototype.exportProjectAsCloudData=function(t){var e,o;if(this.serializer.isCollectingMedia=!0,t)if(this.setProjectName(t),Process.prototype.isCatchingErrors)try{e=this.showMessage("Exporting"),"<snapdata>"+(o=this.serializer.serialize(this.stage))+this.serializer.mediaXML(t)+"</snapdata>",this.saveXMLAs(o,this.projectName),e.destroy(),this.showMessage("Exported!",1)}catch(t){this.serializer.isCollectingMedia=!1,this.showMessage("Export failed: "+t)}else e=this.showMessage("Exporting"),"<snapdata>"+(o=this.serializer.serialize(this.stage))+this.serializer.mediaXML(t)+"</snapdata>",this.saveXMLAs(o,this.projectName),e.destroy(),this.showMessage("Exported!",1);this.serializer.isCollectingMedia=!1,this.serializer.flushMedia()},IDE_Morph.prototype.cloudAcknowledge=function(){var t=this;return function(e,o){nop(e),(new DialogBoxMorph).inform("Cloud Connection","Successfully connected to:\nhttp://"+o,t.world(),t.cloudIcon(null,new Color(0,180,0)))}},IDE_Morph.prototype.cloudResponse=function(){var t=this;return function(e,o){var i=e;i.length>50&&(i=i.substring(0,50)+"..."),(new DialogBoxMorph).inform("Snap!Cloud","http://"+o+":\n\nresponds:\n"+i,t.world(),t.cloudIcon(null,new Color(0,180,0)))}},IDE_Morph.prototype.cloudError=function(){var t=this;return function(e,o){var i=e;t.shield&&(t.shield.destroy(),t.shield=null),i.length>50&&(i=i.substring(0,50)+"..."),(new DialogBoxMorph).inform("Snap!Cloud",(o?o+"\n":"")+i,t.world(),t.cloudIcon(null,new Color(180,0,0)))}},IDE_Morph.prototype.cloudIcon=function(t,e){var o=e||DialogBoxMorph.prototype.titleBarColor,i=MorphicPreferences.isFlat,r=new SymbolMorph(i?"cloud":"cloudGradient",t||50,o,i?null:new Point(-1,-1),o.darker(50));return i||r.addShadow(new Point(1,1),1,o.lighter(95)),r},IDE_Morph.prototype.setCloudURL=function(){new DialogBoxMorph(null,function(t){SnapCloud.url=t}).withKey("cloudURL").prompt("Cloud URL",SnapCloud.url,this.world(),null,{"Snap!Cloud":"https://snap.apps.miosoft.com/SnapCloud"})},IDE_Morph.prototype.getURL=function(t,e){var o=new XMLHttpRequest,i=e instanceof Function,r=this;try{if(o.open("GET",t,i),i&&(o.onreadystatechange=function(){if(4===o.readyState){if(!o.responseText)throw new Error("unable to retrieve "+t);e.call(r,o.responseText)}}),o.send(),!i){if(200===o.status)return o.responseText;throw new Error("unable to retrieve "+t)}}catch(t){if(r.showMessage(t.toString()),!i)return o.responseText;e.call(this)}},IDE_Morph.prototype.showMessage=function(t,e){var o,i=new MenuMorph(null,t);return i.popUpCenteredInWorld(this.world()),e&&(o=setInterval(function(){i.destroy(),clearInterval(o)},1e3*e)),i},IDE_Morph.prototype.inform=function(t,e){(new DialogBoxMorph).inform(t,localize(e),this.world())},IDE_Morph.prototype.confirm=function(t,e,o){new DialogBoxMorph(null,o).askYesNo(e,localize(t),this.world())},IDE_Morph.prototype.prompt=function(t,e,o,i){new DialogBoxMorph(null,e).withKey(i).prompt(t,"",this.world(),null,o)},ProjectDialogMorph.prototype=new DialogBoxMorph,ProjectDialogMorph.prototype.constructor=ProjectDialogMorph,ProjectDialogMorph.uber=DialogBoxMorph.prototype,ProjectDialogMorph.prototype.init=function(t,e){var o=this;this.ide=t,this.task=e||"open",this.source=t.source||"local",this.projectList=[],this.handle=null,this.srcBar=null,this.nameField=null,this.filterField=null,this.magnifyingGlass=null,this.listField=null,this.preview=null,this.notesText=null,this.notesField=null,this.deleteButton=null,this.shareButton=null,this.unshareButton=null,ProjectDialogMorph.uber.init.call(this,this,null,null),this.labelString="save"===this.task?"Save Project":"Open Project",this.createLabel(),this.key="project"+e,this.buildContents(),this.onNextStep=function(){o.setSource(o.source)}},ProjectDialogMorph.prototype.buildContents=function(){var t,e;this.addBody(new Morph),this.body.color=this.color,this.srcBar=new AlignmentMorph("column",this.padding/2),this.ide.cloudMsg&&((e=new TextMorph(this.ide.cloudMsg,10,null,!1,null,null,null,null,new Point(1,1),new Color(255,255,255))).refresh=nop,this.srcBar.add(e)),this.addSourceButton("cloud",localize("Cloud"),"cloud"),this.addSourceButton("local",localize("Browser"),"storage"),"open"===this.task&&(this.buildFilterField(),this.addSourceButton("examples",localize("Examples"),"poster")),this.srcBar.fixLayout(),this.body.add(this.srcBar),"save"===this.task&&(this.nameField=new InputFieldMorph(this.ide.projectName),this.body.add(this.nameField)),this.listField=new ListMorph([]),this.fixListFieldItemColors(),this.listField.fixLayout=nop,this.listField.edge=InputFieldMorph.prototype.edge,this.listField.fontSize=InputFieldMorph.prototype.fontSize,this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.listField.contrast=InputFieldMorph.prototype.contrast,this.listField.drawNew=InputFieldMorph.prototype.drawNew,this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.body.add(this.listField),this.preview=new Morph,this.preview.fixLayout=nop,this.preview.edge=InputFieldMorph.prototype.edge,this.preview.fontSize=InputFieldMorph.prototype.fontSize,this.preview.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.preview.contrast=InputFieldMorph.prototype.contrast,this.preview.drawNew=function(){InputFieldMorph.prototype.drawNew.call(this),this.texture&&this.drawTexture(this.texture)},this.preview.drawCachedTexture=function(){this.image.getContext("2d").drawImage(this.cachedTexture,this.edge,this.edge),this.changed()},this.preview.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.preview.setExtent(this.ide.serializer.thumbnailSize.add(2*this.preview.edge)),this.body.add(this.preview),this.preview.drawNew(),"save"===this.task&&(t=this.ide.stage.thumbnail(SnapSerializer.prototype.thumbnailSize),this.preview.texture=null,this.preview.cachedTexture=t,this.preview.drawCachedTexture()),this.notesField=new ScrollFrameMorph,this.notesField.fixLayout=nop,this.notesField.edge=InputFieldMorph.prototype.edge,this.notesField.fontSize=InputFieldMorph.prototype.fontSize,this.notesField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.notesField.contrast=InputFieldMorph.prototype.contrast,this.notesField.drawNew=InputFieldMorph.prototype.drawNew,this.notesField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.notesField.acceptsDrops=!1,this.notesField.contents.acceptsDrops=!1,"open"===this.task?this.notesText=new TextMorph(""):(this.notesText=new TextMorph(this.ide.projectNotes),this.notesText.isEditable=!0,this.notesText.enableSelecting()),this.notesField.isTextLineWrapping=!0,this.notesField.padding=3,this.notesField.setContents(this.notesText),this.notesField.setWidth(this.preview.width()),this.body.add(this.notesField),"open"===this.task?(this.addButton("openProject","Open"),this.action="openProject"):(this.addButton("saveProject","Save"),this.action="saveProject"),this.shareButton=this.addButton("shareProject","Share"),this.unshareButton=this.addButton("unshareProject","Unshare"),this.shareButton.hide(),this.unshareButton.hide(),this.deleteButton=this.addButton("deleteProject","Delete"),this.addButton("cancel","Cancel"),e?this.setExtent(new Point(455,335).add(e.extent())):this.setExtent(new Point(455,335)),this.fixLayout()},ProjectDialogMorph.prototype.popUp=function(t){var e=t||this.ide.world();e&&(ProjectDialogMorph.uber.popUp.call(this,e),this.handle=new HandleMorph(this,350,300,this.corner,this.corner))},ProjectDialogMorph.prototype.addSourceButton=function(t,e,o){var i,r=this,n=new StringMorph(e,10,null,!0,null,null,new Point(1,1),new Color(255,255,255)),s=new StringMorph(e,10,null,!0,null,null,new Point(-1,-1),this.titleBarColor.darker(50),new Color(255,255,255)),a=new Morph,h=new Morph;n.add(new SymbolMorph(o,24,this.titleBarColor.darker(20),new Point(1,1),this.titleBarColor.darker(50))),n.children[0].setCenter(n.center()),n.children[0].setBottom(n.top()-this.padding/2),a.image=n.fullImage(),a.bounds=n.fullBounds(),s.add(new SymbolMorph(o,24,new Color(255,255,255),new Point(-1,-1),this.titleBarColor.darker(50))),s.children[0].setCenter(s.center()),s.children[0].setBottom(s.top()-this.padding/2),h.image=s.fullImage(),h.bounds=s.fullBounds(),(i=new ToggleButtonMorph(null,r,function(){r.setSource(t)},[a,h],function(){return r.source===t})).corner=this.buttonCorner,i.edge=this.buttonEdge,i.outline=this.buttonOutline,i.outlineColor=this.buttonOutlineColor,i.outlineGradient=this.buttonOutlineGradient,i.labelMinExtent=new Point(60,0),i.padding=this.buttonPadding,i.contrast=this.buttonContrast,i.pressColor=this.titleBarColor.darker(20),i.drawNew(),i.fixLayout(),i.refresh(),this.srcBar.add(i)},ProjectDialogMorph.prototype.fixListFieldItemColors=function(){var t=this;this.listField.contents.children[0].alpha=0,this.listField.contents.children[0].children.forEach(function(e){e.pressColor=t.titleBarColor.darker(20),e.color=new Color(0,0,0,0),e.noticesTransparentClick=!0})},ProjectDialogMorph.prototype.buildFilterField=function(){var t=this;this.filterField=new InputFieldMorph(""),this.magnifyingGlass=new SymbolMorph("magnifyingGlass",this.filterField.height(),this.titleBarColor.darker(50)),this.body.add(this.magnifyingGlass),this.body.add(this.filterField),this.filterField.reactToKeystroke=function(e){var o=this.getValue();t.listField.elements=t.projectList.filter(function(t){var e,i;return t.ProjectName?(e=t.ProjectName,i=t.Notes):(e=t.name,i=t.notes||""),e.toLowerCase().indexOf(o.toLowerCase())>-1||i.toLowerCase().indexOf(o.toLowerCase())>-1}),0===t.listField.elements.length&&t.listField.elements.push("(no matches)"),t.clearDetails(),t.listField.buildListContents(),t.fixListFieldItemColors(),t.listField.adjustScrollBars(),t.listField.scrollY(t.listField.top()),t.fixLayout()}},ProjectDialogMorph.prototype.setSource=function(t){var e,o=this;switch(this.source=t,this.srcBar.children.forEach(function(t){t.refresh()}),this.source){case"cloud":return e=o.ide.showMessage("Updating\nproject list..."),this.projectList=[],void SnapCloud.getProjectList(function(t){"cloud"===o.source&&o.installCloudProjectList(t),e.destroy()},function(t,i){e.destroy(),o.ide.cloudError().call(null,t,i)});case"examples":this.projectList=this.getExamplesProjectList();break;case"local":this.projectList=this.getLocalProjectList()}this.listField.destroy(),this.listField=new ListMorph(this.projectList,this.projectList.length>0?function(t){return t.name||t}:null,null,function(){o.ok()}),this.fixListFieldItemColors(),this.listField.fixLayout=nop,this.listField.edge=InputFieldMorph.prototype.edge,this.listField.fontSize=InputFieldMorph.prototype.fontSize,this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.listField.contrast=InputFieldMorph.prototype.contrast,this.listField.drawNew=InputFieldMorph.prototype.drawNew,this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,"local"===this.source?this.listField.action=function(t){var e,i;void 0!==t&&(o.nameField&&o.nameField.setContents(t.name||""),"open"===o.task&&(e=localStorage["-snap-project-"+t.name])&&(i=o.ide.serializer.parse(e),o.notesText.text=i.childNamed("notes").contents||"",o.notesText.drawNew(),o.notesField.contents.adjustBounds(),o.preview.texture=i.childNamed("thumbnail").contents||null,o.preview.cachedTexture=null,o.preview.drawNew()),o.edit())}:this.listField.action=function(t){var e,i;void 0!==t&&(o.nameField&&o.nameField.setContents(t.name||""),e=o.ide.getURL(o.ide.resourceURL("Examples",t.fileName)),i=o.ide.serializer.parse(e),o.notesText.text=i.childNamed("notes").contents||"",o.notesText.drawNew(),o.notesField.contents.adjustBounds(),o.preview.texture=i.childNamed("thumbnail").contents||null,o.preview.cachedTexture=null,o.preview.drawNew(),o.edit())},this.body.add(this.listField),this.shareButton.hide(),this.unshareButton.hide(),"local"===this.source?this.deleteButton.show():this.deleteButton.hide(),this.buttons.fixLayout(),this.fixLayout(),"open"===this.task&&this.clearDetails()},ProjectDialogMorph.prototype.getLocalProjectList=function(){var t,e,o=[];for(t in localStorage)Object.prototype.hasOwnProperty.call(localStorage,t)&&"-snap-project-"===t.substr(0,14)&&(e={name:t.substr(14),thumb:null,notes:null},o.push(e));return o.sort(function(t,e){return t.name.toLowerCase()<e.name.toLowerCase()?-1:1}),o},ProjectDialogMorph.prototype.getExamplesProjectList=function(){return this.ide.getMediaList("Examples")},ProjectDialogMorph.prototype.installCloudProjectList=function(t){var e=this;this.projectList=t||[],this.projectList.sort(function(t,e){return t.ProjectName.toLowerCase()<e.ProjectName.toLowerCase()?-1:1}),this.listField.destroy(),this.listField=new ListMorph(this.projectList,this.projectList.length>0?function(t){return t.ProjectName||t}:null,[["bold",function(t){return"true"===t.Public}]],function(){e.ok()}),this.fixListFieldItemColors(),this.listField.fixLayout=nop,this.listField.edge=InputFieldMorph.prototype.edge,this.listField.fontSize=InputFieldMorph.prototype.fontSize,this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.listField.contrast=InputFieldMorph.prototype.contrast,this.listField.drawNew=InputFieldMorph.prototype.drawNew,this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.listField.action=function(t){void 0!==t&&(e.nameField&&e.nameField.setContents(t.ProjectName||""),"open"===e.task&&(e.notesText.text=t.Notes||"",e.notesText.drawNew(),e.notesField.contents.adjustBounds(),e.preview.texture=t.Thumbnail||null,e.preview.cachedTexture=null,e.preview.drawNew(),new SpeechBubbleMorph(new TextMorph(localize("last changed")+"\n"+t.Updated,null,null,null,null,"center")).popUp(e.world(),e.preview.rightCenter().add(new Point(2,0)))),"true"===t.Public?(e.shareButton.hide(),e.unshareButton.show()):(e.unshareButton.hide(),e.shareButton.show()),e.buttons.fixLayout(),e.fixLayout(),e.edit())},this.body.add(this.listField),this.shareButton.show(),this.unshareButton.hide(),this.deleteButton.show(),this.buttons.fixLayout(),this.fixLayout(),"open"===this.task&&this.clearDetails()},ProjectDialogMorph.prototype.clearDetails=function(){this.notesText.text="",this.notesText.drawNew(),this.notesField.contents.adjustBounds(),this.preview.texture=null,this.preview.cachedTexture=null,this.preview.drawNew()},ProjectDialogMorph.prototype.openProject=function(){var t,e=this.listField.selected;e&&(this.ide.source=this.source,"cloud"===this.source?this.openCloudProject(e):"examples"===this.source?(t=this.ide.getURL(this.ide.resourceURL("Examples",e.fileName)),this.ide.openProjectString(t),this.destroy()):(this.ide.openProject(e.name),this.destroy()))},ProjectDialogMorph.prototype.openCloudProject=function(t){var e=this;e.ide.nextSteps([function(){e.ide.showMessage("Fetching project\nfrom the cloud...")},function(){e.rawOpenCloudProject(t)}])},ProjectDialogMorph.prototype.rawOpenCloudProject=function(t){var e=this;SnapCloud.reconnect(function(){SnapCloud.callService("getRawProject",function(o){SnapCloud.disconnect(),e.ide.source="cloud",e.ide.droppedText(o),"true"===t.Public&&(location.hash="#present:Username="+encodeURIComponent(SnapCloud.username)+"&ProjectName="+encodeURIComponent(t.ProjectName))},e.ide.cloudError(),[t.ProjectName])},e.ide.cloudError()),this.destroy()},ProjectDialogMorph.prototype.saveProject=function(){var t=this.nameField.contents().text.text,e=this.notesText.text,o=this;this.ide.projectNotes=e||this.ide.projectNotes,t&&("cloud"===this.source?detect(this.projectList,function(e){return e.ProjectName===t})?this.ide.confirm(localize("Are you sure you want to replace")+'\n"'+t+'"?',"Replace Project",function(){o.ide.setProjectName(t),o.saveCloudProject()}):(this.ide.setProjectName(t),o.saveCloudProject()):detect(this.projectList,function(e){return e.name===t})?this.ide.confirm(localize("Are you sure you want to replace")+'\n"'+t+'"?',"Replace Project",function(){o.ide.setProjectName(t),o.ide.source="local",o.ide.saveProject(t),o.destroy()}):(this.ide.setProjectName(t),o.ide.source="local",this.ide.saveProject(t),this.destroy()))},ProjectDialogMorph.prototype.saveCloudProject=function(){var t=this;this.ide.showMessage("Saving project\nto the cloud..."),SnapCloud.saveProject(this.ide,function(){t.ide.source="cloud",t.ide.showMessage("saved.",2)},this.ide.cloudError()),this.destroy()},ProjectDialogMorph.prototype.deleteProject=function(){var t,e,o,i=this;"cloud"===this.source?(t=this.listField.selected)&&this.ide.confirm(localize("Are you sure you want to delete")+'\n"'+t.ProjectName+'"?',"Delete Project",function(){SnapCloud.reconnect(function(){SnapCloud.callService("deleteProject",function(){SnapCloud.disconnect(),i.ide.hasChangedMedia=!0,e=i.projectList.indexOf(t),i.projectList.splice(e,1),i.installCloudProjectList(i.projectList)},i.ide.cloudError(),[t.ProjectName])},i.ide.cloudError())}):this.listField.selected&&(o=this.listField.selected.name,this.ide.confirm(localize("Are you sure you want to delete")+'\n"'+o+'"?',"Delete Project",function(){delete localStorage["-snap-project-"+o],i.setSource(i.source)}))},ProjectDialogMorph.prototype.shareProject=function(){var t=this,e=this.ide,o=this.listField.selected,i=this.listField.active;o&&this.ide.confirm(localize("Are you sure you want to publish")+'\n"'+o.ProjectName+'"?',"Share Project",function(){t.ide.showMessage("sharing\nproject..."),SnapCloud.reconnect(function(){if(SnapCloud.callService("publishProject",function(){SnapCloud.disconnect(),o.Public="true",t.unshareButton.show(),t.shareButton.hide(),i.label.isBold=!0,i.label.drawNew(),i.label.changed(),t.buttons.fixLayout(),t.drawNew(),t.ide.showMessage("shared.",2)},t.ide.cloudError(),[o.ProjectName]),o.ProjectName===e.projectName){var r=SnapCloud.username,n="Username="+encodeURIComponent(r.toLowerCase())+"&ProjectName="+encodeURIComponent(o.ProjectName);location.hash="present:"+n}},t.ide.cloudError())})},ProjectDialogMorph.prototype.unshareProject=function(){var t=this,e=this.ide,o=this.listField.selected,i=this.listField.active;o&&this.ide.confirm(localize("Are you sure you want to unpublish")+'\n"'+o.ProjectName+'"?',"Unshare Project",function(){t.ide.showMessage("unsharing\nproject..."),SnapCloud.reconnect(function(){SnapCloud.callService("unpublishProject",function(){SnapCloud.disconnect(),o.Public="false",t.shareButton.show(),t.unshareButton.hide(),i.label.isBold=!1,i.label.drawNew(),i.label.changed(),t.buttons.fixLayout(),t.drawNew(),t.ide.showMessage("unshared.",2)},t.ide.cloudError(),[o.ProjectName]),o.ProjectName===e.projectName&&(location.hash="")},t.ide.cloudError())})},ProjectDialogMorph.prototype.edit=function(){this.nameField?this.nameField.edit():this.filterField&&this.filterField.edit()},ProjectDialogMorph.prototype.fixLayout=function(){var t=fontHeight(this.titleFontSize)+2*this.titlePadding,e=this.padding/2,o=this.nameField||this.filterField,i=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,this.buttons&&this.buttons.children.length>0&&this.buttons.fixLayout(),this.body&&(this.body.setPosition(this.position().add(new Point(this.padding,t+this.padding))),this.body.setExtent(new Point(this.width()-2*this.padding,this.height()-3*this.padding-t-this.buttons.height())),this.srcBar.setPosition(this.body.position()),o.setWidth(this.body.width()-this.srcBar.width()-6*this.padding),o.setLeft(this.srcBar.right()+3*this.padding),o.setTop(this.srcBar.top()),o.drawNew(),this.listField.setLeft(this.srcBar.right()+this.padding),this.listField.setWidth(this.body.width()-this.srcBar.width()-this.preview.width()-this.padding-e),this.listField.contents.children[0].adjustWidths(),this.listField.setTop(o.bottom()+this.padding),this.listField.setHeight(this.body.height()-o.height()-this.padding),this.magnifyingGlass&&(this.magnifyingGlass.setTop(o.top()),this.magnifyingGlass.setLeft(this.listField.left())),this.preview.setRight(this.body.right()),this.preview.setTop(o.bottom()+this.padding),this.notesField.setTop(this.preview.bottom()+e),this.notesField.setLeft(this.preview.left()),this.notesField.setHeight(this.body.bottom()-this.preview.bottom()-e)),this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(t-this.label.height())/2)),this.buttons&&this.buttons.children.length>0&&(this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding)),Morph.prototype.trackChanges=i,this.changed()},LibraryImportDialogMorph.prototype=new DialogBoxMorph,LibraryImportDialogMorph.prototype.constructor=LibraryImportDialogMorph,LibraryImportDialogMorph.uber=DialogBoxMorph.prototype,LibraryImportDialogMorph.prototype.init=function(t,e){LibraryImportDialogMorph.uber.init.call(this,this,null,null),this.ide=t,this.key="importLibrary",this.librariesData=e,this.libraryCache={},this.handle=null,this.listField=null,this.palette=null,this.notesText=null,this.notesField=null,this.labelString="Import library",this.createLabel(),this.buildContents()},LibraryImportDialogMorph.prototype.buildContents=function(){this.addBody(new Morph),this.body.color=this.color,this.initializePalette(),this.initializeLibraryDescription(),this.installLibrariesList(),this.addButton("importLibrary","Import"),this.addButton("cancel","Cancel"),this.setExtent(new Point(460,455)),this.fixLayout()},LibraryImportDialogMorph.prototype.initializePalette=function(){this.palette&&this.palette.destroy(),this.palette=new ScrollFrameMorph(null,null,SpriteMorph.prototype.sliderColor),this.palette.color=SpriteMorph.prototype.paletteColor,this.palette.padding=4,this.palette.isDraggable=!1,this.palette.acceptsDrops=!1,this.palette.contents.acceptsDrops=!1,this.body.add(this.palette)},LibraryImportDialogMorph.prototype.initializeLibraryDescription=function(){this.notesField&&this.notesField.destroy(),this.notesField=new ScrollFrameMorph,this.notesField.fixLayout=nop,this.notesField.edge=InputFieldMorph.prototype.edge,this.notesField.fontSize=InputFieldMorph.prototype.fontSize,this.notesField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.notesField.contrast=InputFieldMorph.prototype.contrast,this.notesField.drawNew=InputFieldMorph.prototype.drawNew,this.notesField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.notesField.acceptsDrops=!1,this.notesField.contents.acceptsDrops=!1,this.notesText=new TextMorph(""),this.notesField.isTextLineWrapping=!0,this.notesField.padding=3,this.notesField.setContents(this.notesText),this.notesField.setHeight(100),this.body.add(this.notesField)},LibraryImportDialogMorph.prototype.installLibrariesList=function(){var t=this;this.listField&&this.listField.destroy(),this.listField=new ListMorph(this.librariesData,function(t){return t.name},null,function(){t.importLibrary()}),this.fixListFieldItemColors(),this.listField.fixLayout=nop,this.listField.edge=InputFieldMorph.prototype.edge,this.listField.fontSize=InputFieldMorph.prototype.fontSize,this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.listField.contrast=InputFieldMorph.prototype.contrast,this.listField.drawNew=InputFieldMorph.prototype.drawNew,this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.listField.action=function(e){isNil(e)||(t.notesText.text=e.description||"",t.notesText.drawNew(),t.notesField.contents.adjustBounds(),t.hasCached(e.fileName)?t.displayBlocks(e.fileName):(t.showMessage(localize("Loading")+"\n"+localize(e.name)),t.ide.getURL(t.ide.resourceURL("libraries",e.fileName),function(o){t.cacheLibrary(e.fileName,t.ide.serializer.loadBlocks(o)),t.displayBlocks(e.fileName)})))},this.listField.setWidth(200),this.body.add(this.listField),this.fixLayout()},LibraryImportDialogMorph.prototype.popUp=function(){var t=this.ide.world();t&&(LibraryImportDialogMorph.uber.popUp.call(this,t),this.handle=new HandleMorph(this,300,300,this.corner,this.corner))},LibraryImportDialogMorph.prototype.fixListFieldItemColors=ProjectDialogMorph.prototype.fixListFieldItemColors,LibraryImportDialogMorph.prototype.clearDetails=ProjectDialogMorph.prototype.clearDetails,LibraryImportDialogMorph.prototype.fixLayout=function(){var t=fontHeight(this.titleFontSize)+2*this.titlePadding,e=this.padding/2,o=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,this.body&&(this.body.setPosition(this.position().add(new Point(this.padding,t+this.padding))),this.body.setExtent(new Point(this.width()-2*this.padding,this.height()-3*this.padding-t-this.buttons.height())),this.listField.setExtent(new Point(200,this.body.height())),this.notesField.setExtent(new Point(this.body.width()-this.listField.width()-e,100)),this.palette.setExtent(new Point(this.notesField.width(),this.body.height()-this.notesField.height()-e)),this.listField.contents.children[0].adjustWidths(),this.listField.setPosition(this.body.position()),this.palette.setPosition(this.listField.topRight().add(new Point(e,0))),this.notesField.setPosition(this.palette.bottomLeft().add(new Point(0,e)))),this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(t-this.label.height())/2)),this.buttons&&(this.buttons.fixLayout(),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding)),Morph.prototype.trackChanges=o,this.changed()},LibraryImportDialogMorph.prototype.hasCached=function(t){return this.libraryCache.hasOwnProperty(t)},LibraryImportDialogMorph.prototype.cacheLibrary=function(t,e){this.libraryCache[t]=e},LibraryImportDialogMorph.prototype.cachedLibrary=function(t){return this.libraryCache[t]},LibraryImportDialogMorph.prototype.importLibrary=function(){var t=this.ide,e=this.listField.selected.fileName,o=this.listField.selected.name;this.hasCached(e)?(this.cachedLibrary(e).forEach(function(e){e.receiver=t.stage,t.stage.globalBlocks.push(e),t.stage.replaceDoubleDefinitionsFor(e)}),t.showMessage(localize("Imported")+" "+localize(o),2)):(t.showMessage(localize("Loading")+" "+localize(o)),t.getURL(t.resourceURL("libraries",e),function(e){t.droppedText(e,o)})),this.destroy()},LibraryImportDialogMorph.prototype.displayBlocks=function(t){var e,o,i,r,n,s=this,a=this.cachedLibrary(t);a.length&&(this.initializePalette(),e=this.palette.left()+4,o=this.palette.top(),SpriteMorph.prototype.categories.forEach(function(t){a.forEach(function(a){a.category===t&&(t!==r&&(o+=4),r=t,i=a.templateInstance().fullImage(),(n=new Morph).setExtent(new Point(i.width,i.height)),n.image=i,n.setPosition(new Point(e,o)),s.palette.addContents(n),o+=n.fullBounds().height()+4)})}),this.palette.scrollX(4),this.palette.scrollY(4),this.fixLayout())},LibraryImportDialogMorph.prototype.showMessage=function(t){var e=new MenuMorph(null,t);this.initializePalette(),this.fixLayout(),e.popUpCenteredInWorld(this.palette.contents)},SpriteIconMorph.prototype=new ToggleButtonMorph,SpriteIconMorph.prototype.constructor=SpriteIconMorph,SpriteIconMorph.uber=ToggleButtonMorph.prototype,SpriteIconMorph.prototype.thumbSize=new Point(40,40),SpriteIconMorph.prototype.labelShadowOffset=null,SpriteIconMorph.prototype.labelShadowColor=null,SpriteIconMorph.prototype.labelColor=new Color(255,255,255),SpriteIconMorph.prototype.fontSize=9,SpriteIconMorph.prototype.init=function(t,e){var o,i,r,n,s=this;e||(o=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor]),i=function(){var t=s.parentThatIsA(IDE_Morph);t&&t.selectSprite(s.object)},r=function(){var t=s.parentThatIsA(IDE_Morph);return!!t&&t.currentSprite===s.object},n=function(){return t.exemplar?localize("parent")+":\n"+t.exemplar.name:null},this.object=t||new SpriteMorph,this.version=this.object.version,this.thumbnail=null,this.rotationButton=null,SpriteIconMorph.uber.init.call(this,o,null,i,this.object.name,r,null,n,e),this.isDraggable=!0,this.createThumbnail(),this.padding=2,this.corner=8,this.fixLayout(),this.fps=1},SpriteIconMorph.prototype.createThumbnail=function(){this.thumbnail&&this.thumbnail.destroy(),this.thumbnail=new Morph,this.thumbnail.setExtent(this.thumbSize),this.object instanceof SpriteMorph?(this.thumbnail.image=this.object.fullThumbnail(this.thumbSize),this.createRotationButton()):this.thumbnail.image=this.object.thumbnail(this.thumbSize),this.add(this.thumbnail)},SpriteIconMorph.prototype.createLabel=function(){var t;this.label&&this.label.destroy(),t=new StringMorph(this.object.name,this.fontSize,this.fontStyle,!0,!1,!1,this.labelShadowOffset,this.labelShadowColor,this.labelColor),this.label=new FrameMorph,this.label.acceptsDrops=!1,this.label.alpha=0,this.label.setExtent(t.extent()),t.setPosition(this.label.position()),this.label.add(t),this.add(this.label)},SpriteIconMorph.prototype.createRotationButton=function(){var t,e=this;this.rotationButton&&(this.rotationButton.destroy(),this.roationButton=null),this.object.anchor&&((t=new ToggleButtonMorph(null,null,function(){e.object.rotatesWithAnchor=!e.object.rotatesWithAnchor},["→","↻"],function(){return e.object.rotatesWithAnchor})).corner=8,t.labelMinExtent=new Point(11,11),t.padding=0,t.pressColor=t.color,t.drawNew(),t.fixLayout(),t.refresh(),t.changed(),this.rotationButton=t,this.add(this.rotationButton))},SpriteIconMorph.prototype.step=function(){this.version!==this.object.version&&(this.createThumbnail(),this.createLabel(),this.fixLayout(),this.version=this.object.version,this.refresh())},SpriteIconMorph.prototype.fixLayout=function(){if(!this.thumbnail||!this.label)return null;this.setWidth(this.thumbnail.width()+2*this.outline+2*this.edge+2*this.padding),this.setHeight(this.thumbnail.height()+2*this.outline+2*this.edge+3*this.padding+this.label.height()),this.thumbnail.setCenter(this.center()),this.thumbnail.setTop(this.top()+this.outline+this.edge+this.padding),this.rotationButton&&(this.rotationButton.setTop(this.top()),this.rotationButton.setRight(this.right())),this.label.setWidth(Math.min(this.label.children[0].width(),this.thumbnail.width())),this.label.setCenter(this.center()),this.label.setTop(this.thumbnail.bottom()+this.padding)},SpriteIconMorph.prototype.userMenu=function(){var t=new MenuMorph(this),e=this;return this.object instanceof StageMorph?(t.addItem("pic...",function(){e.parentThatIsA(IDE_Morph).saveCanvasAs(e.object.fullImageClassic(),this.object.name)},"open a new window\nwith a picture of the stage"),t):this.object instanceof SpriteMorph?(t.addItem("show","showSpriteOnStage"),t.addLine(),t.addItem("duplicate","duplicateSprite"),StageMorph.prototype.enableInheritance&&t.addItem("clone","instantiateSprite"),t.addItem("delete","removeSprite"),t.addLine(),StageMorph.prototype.enableInheritance&&(t.addItem("parent...","chooseExemplar"),this.object.exemplar&&t.addItem("release","releaseSprite","make temporary and\nhide in the sprite corral")),this.object.anchor&&t.addItem(localize("detach from")+" "+this.object.anchor.name,function(){e.object.detachFromAnchor()}),this.object.parts.length&&t.addItem("detach all parts",function(){e.object.detachAllParts()}),t.addItem("export...","exportSprite"),t):null},SpriteIconMorph.prototype.duplicateSprite=function(){var t=this.parentThatIsA(IDE_Morph);t&&t.duplicateSprite(this.object)},SpriteIconMorph.prototype.instantiateSprite=function(){var t=this.parentThatIsA(IDE_Morph);t&&t.instantiateSprite(this.object)},SpriteIconMorph.prototype.removeSprite=function(){var t=this.parentThatIsA(IDE_Morph);t&&t.removeSprite(this.object)},SpriteIconMorph.prototype.exportSprite=function(){this.object.exportSprite()},SpriteIconMorph.prototype.chooseExemplar=function(){this.object.chooseExemplar()},SpriteIconMorph.prototype.releaseSprite=function(){this.object.release()},SpriteIconMorph.prototype.showSpriteOnStage=function(){this.object.showOnStage()},SpriteIconMorph.prototype.mouseDoubleClick=function(){this.object instanceof SpriteMorph&&this.object.flash()},SpriteIconMorph.prototype.createBackgrounds=function(){var t,e=this.extent();if(this.template)return this.image=this.template.image,this.normalImage=this.template.normalImage,this.highlightImage=this.template.highlightImage,this.pressImage=this.template.pressImage,null;this.normalImage=newCanvas(e),t=this.normalImage.getContext("2d"),this.drawBackground(t,this.color),this.highlightImage=newCanvas(e),t=this.highlightImage.getContext("2d"),this.drawBackground(t,this.highlightColor),this.pressImage=newCanvas(e),t=this.pressImage.getContext("2d"),this.drawOutline(t),this.drawBackground(t,this.pressColor),this.drawEdges(t,this.pressColor,this.pressColor.lighter(this.contrast),this.pressColor.darker(this.contrast)),this.image=this.normalImage},SpriteIconMorph.prototype.prepareToBeGrabbed=function(){var t,e=this.parentThatIsA(IDE_Morph);this.mouseClickLeft(),this.alpha=.85,e&&(t=e.sprites.asArray().indexOf(this.object),e.sprites.remove(t+1),e.createCorral(),e.fixLayout())},SpriteIconMorph.prototype.justDropped=function(){this.alpha=1},SpriteIconMorph.prototype.wantsDropOf=function(t){return t instanceof BlockMorph||t instanceof CostumeIconMorph||t instanceof SoundIconMorph},SpriteIconMorph.prototype.reactToDropOf=function(t,e){t instanceof BlockMorph?this.copyStack(t):t instanceof CostumeIconMorph?this.copyCostume(t.object):t instanceof SoundIconMorph&&this.copySound(t.object),this.world().add(t),t.slideBackTo(e.grabOrigin)},SpriteIconMorph.prototype.copyStack=function(t){var e=this.object,o=t.fullCopy(),i=Math.max(e.scripts.children.map(function(t){return t.fullBounds().bottom()}).concat([e.scripts.top()]));o.setPosition(new Point(e.scripts.left()+20,i+20)),e.scripts.add(o),o.allComments().forEach(function(t){t.align(o)}),e.scripts.adjustBounds(),o.allChildren().forEach(function(t){!t.isCustomBlock||t.isGlobal||e.getMethod(t.blockSpec)||t.deleteBlock()})},SpriteIconMorph.prototype.copyCostume=function(t){var e=t.copy();e.name=this.object.newCostumeName(e.name),this.object.addCostume(e),this.object.wearCostume(e)},SpriteIconMorph.prototype.copySound=function(t){var e=t.copy();this.object.addSound(e.audio,e.name)},CostumeIconMorph.prototype=new ToggleButtonMorph,CostumeIconMorph.prototype.constructor=CostumeIconMorph,CostumeIconMorph.uber=ToggleButtonMorph.prototype,CostumeIconMorph.prototype.thumbSize=new Point(80,60),CostumeIconMorph.prototype.labelShadowOffset=null,CostumeIconMorph.prototype.labelShadowColor=null,CostumeIconMorph.prototype.labelColor=new Color(255,255,255),CostumeIconMorph.prototype.fontSize=9,CostumeIconMorph.prototype.init=function(t,e){var o,i,r,n=this;e||(o=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor]),i=function(){var t=n.parentThatIsA(IDE_Morph),e=n.parentThatIsA(WardrobeMorph);t&&t.currentSprite.wearCostume(n.object),e&&e.updateSelection()},r=function(){var t=n.parentThatIsA(IDE_Morph);return!!t&&t.currentSprite.costume===n.object},this.object=t||new Costume,this.version=this.object.version,this.thumbnail=null,CostumeIconMorph.uber.init.call(this,o,null,i,this.object.name,r,null,null,e),this.isDraggable=!0,this.createThumbnail(),this.padding=2,this.corner=8,this.fixLayout(),this.fps=1},CostumeIconMorph.prototype.createThumbnail=function(){var t;SpriteIconMorph.prototype.createThumbnail.call(this),this.object instanceof SVG_Costume&&((t=new StringMorph("svg",.8*this.fontSize,this.fontStyle,!1,!1,!1,this.labelShadowOffset,this.labelShadowColor,this.labelColor)).setBottom(this.thumbnail.bottom()),this.thumbnail.add(t))},CostumeIconMorph.prototype.createLabel=SpriteIconMorph.prototype.createLabel,CostumeIconMorph.prototype.step=SpriteIconMorph.prototype.step,CostumeIconMorph.prototype.fixLayout=SpriteIconMorph.prototype.fixLayout,CostumeIconMorph.prototype.userMenu=function(){var t=new MenuMorph(this);return this.object instanceof Costume?(t.addItem("edit","editCostume"),16===this.world().currentKey&&t.addItem("edit rotation point only...","editRotationPointOnly",null,new Color(100,0,0)),t.addItem("rename","renameCostume"),t.addLine(),t.addItem("duplicate","duplicateCostume"),t.addItem("delete","removeCostume"),t.addLine(),t.addItem("export","exportCostume"),t):null},CostumeIconMorph.prototype.editCostume=function(){this.disinherit(),this.object instanceof SVG_Costume?this.object.editRotationPointOnly(this.world()):this.object.edit(this.world(),this.parentThatIsA(IDE_Morph),!1)},CostumeIconMorph.prototype.editRotationPointOnly=function(){var t=this.parentThatIsA(IDE_Morph);this.object.editRotationPointOnly(this.world()),t.hasChangedMedia=!0},CostumeIconMorph.prototype.renameCostume=function(){this.disinherit();var t=this.object,e=this.parentThatIsA(WardrobeMorph),o=this.parentThatIsA(IDE_Morph);new DialogBoxMorph(null,function(i){i&&i!==t.name&&(t.name=e.sprite.newCostumeName(i,t),t.version=Date.now(),o.hasChangedMedia=!0)}).prompt(this.currentSprite instanceof SpriteMorph?"rename costume":"rename background",t.name,this.world())},CostumeIconMorph.prototype.duplicateCostume=function(){var t=this.parentThatIsA(WardrobeMorph),e=this.parentThatIsA(IDE_Morph),o=this.object.copy();o.name=t.sprite.newCostumeName(o.name),t.sprite.addCostume(o),t.updateList(),e&&e.currentSprite.wearCostume(o)},CostumeIconMorph.prototype.removeCostume=function(){var t=this.parentThatIsA(WardrobeMorph),e=this.parent.children.indexOf(this),o=CamSnapshotDialogMorph.prototype.enableCamera?3:2,i=this.parentThatIsA(IDE_Morph);t.removeCostumeAt(e-o),i.currentSprite.costume===this.object&&i.currentSprite.wearCostume(null)},CostumeIconMorph.prototype.exportCostume=function(){var t=this.parentThatIsA(IDE_Morph);this.object instanceof SVG_Costume?t.saveFileAs(this.object.contents.src,"text/svg",this.object.name):t.saveCanvasAs(this.object.contents,this.object.name)},CostumeIconMorph.prototype.createBackgrounds=SpriteIconMorph.prototype.createBackgrounds,CostumeIconMorph.prototype.disinherit=function(){var t=this.parentThatIsA(WardrobeMorph),e=this.parent.children.indexOf(this);t.sprite.inheritsAttribute("costumes")&&(t.sprite.shadowAttribute("costumes"),this.object=t.sprite.costumes.at(e-2))},CostumeIconMorph.prototype.prepareToBeGrabbed=function(){this.disinherit(),this.mouseClickLeft(),this.removeCostume()},TurtleIconMorph.prototype=new ToggleButtonMorph,TurtleIconMorph.prototype.constructor=TurtleIconMorph,TurtleIconMorph.uber=ToggleButtonMorph.prototype,TurtleIconMorph.prototype.thumbSize=new Point(80,60),TurtleIconMorph.prototype.labelShadowOffset=null,TurtleIconMorph.prototype.labelShadowColor=null,TurtleIconMorph.prototype.labelColor=new Color(255,255,255),TurtleIconMorph.prototype.fontSize=9,TurtleIconMorph.prototype.init=function(t,e){var o,i,r,n=this;e||(o=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor]),i=function(){var t=n.parentThatIsA(IDE_Morph),e=n.parentThatIsA(WardrobeMorph);t&&t.currentSprite.wearCostume(null),e&&e.updateSelection()},r=function(){var t=n.parentThatIsA(IDE_Morph);return!!t&&null===t.currentSprite.costume},this.object=t,this.version=this.object.version,this.thumbnail=null,TurtleIconMorph.uber.init.call(this,o,null,i,"default",r,null,null,e),this.isDraggable=!1,this.createThumbnail(),this.padding=2,this.corner=8,this.fixLayout()},TurtleIconMorph.prototype.createThumbnail=function(){var t=MorphicPreferences.isFlat;this.thumbnail&&this.thumbnail.destroy(),this.object instanceof SpriteMorph?this.thumbnail=new SymbolMorph("turtle",this.thumbSize.y,this.labelColor,t?null:new Point(-1,-1),new Color(0,0,0)):this.thumbnail=new SymbolMorph("stage",this.thumbSize.y,this.labelColor,t?null:new Point(-1,-1),new Color(0,0,0)),this.add(this.thumbnail)},TurtleIconMorph.prototype.createLabel=function(){var t;this.label&&this.label.destroy(),t=new StringMorph(localize(this.object instanceof SpriteMorph?"Turtle":"Empty"),this.fontSize,this.fontStyle,!0,!1,!1,this.labelShadowOffset,this.labelShadowColor,this.labelColor),this.label=new FrameMorph,this.label.acceptsDrops=!1,this.label.alpha=0,this.label.setExtent(t.extent()),t.setPosition(this.label.position()),this.label.add(t),this.add(this.label)},TurtleIconMorph.prototype.fixLayout=SpriteIconMorph.prototype.fixLayout,TurtleIconMorph.prototype.createBackgrounds=SpriteIconMorph.prototype.createBackgrounds,TurtleIconMorph.prototype.userMenu=function(){var t=this,e=new MenuMorph(this,"pen");return this.object instanceof StageMorph?null:(e.addItem(("tip"===this.object.penPoint?"●":"○")+" "+localize("tip"),function(){t.object.penPoint="tip",t.object.changed(),t.object.drawNew(),t.object.changed()}),e.addItem(("middle"===this.object.penPoint?"●":"○")+" "+localize("middle"),function(){t.object.penPoint="middle",t.object.changed(),t.object.drawNew(),t.object.changed()}),e)},WardrobeMorph.prototype=new ScrollFrameMorph,WardrobeMorph.prototype.constructor=WardrobeMorph,WardrobeMorph.uber=ScrollFrameMorph.prototype,WardrobeMorph.prototype.init=function(t,e){this.sprite=t||new SpriteMorph,this.costumesVersion=null,this.spriteVersion=null,WardrobeMorph.uber.init.call(this,null,null,e),this.fps=2,this.updateList()},WardrobeMorph.prototype.updateList=function(){var t,e,o,i,r,n=this,s=this.left()+5,a=this.top()+5,h=Morph.prototype.trackChanges,l=this.contents.position();this.changed(),h=Morph.prototype.trackChanges,Morph.prototype.trackChanges=!1,this.contents.destroy(),this.contents=new FrameMorph(this),this.contents.acceptsDrops=!1,this.contents.reactToDropOf=function(t){n.reactToDropOf(t)},this.addBack(this.contents),(t=new TurtleIconMorph(this.sprite)).setPosition(new Point(s,a)),n.addContents(t),a=t.bottom()+4,(i=new PushButtonMorph(this,"paintNew",new SymbolMorph("brush",15))).padding=0,i.corner=12,i.color=IDE_Morph.prototype.groupColor,i.highlightColor=IDE_Morph.prototype.frameColor.darker(50),i.pressColor=i.highlightColor,i.labelMinExtent=new Point(36,18),i.labelShadowOffset=new Point(-1,-1),i.labelShadowColor=i.highlightColor,i.labelColor=TurtleIconMorph.prototype.labelColor,i.contrast=this.buttonContrast,i.drawNew(),i.hint="Paint a new costume",i.setPosition(new Point(s,a)),i.fixLayout(),i.setCenter(t.center()),i.setLeft(t.right()+16),this.addContents(i),CamSnapshotDialogMorph.prototype.enableCamera&&((r=new PushButtonMorph(this,"newFromCam",new SymbolMorph("camera",15))).padding=0,r.corner=12,r.color=IDE_Morph.prototype.groupColor,r.highlightColor=IDE_Morph.prototype.frameColor.darker(50),r.pressColor=i.highlightColor,r.labelMinExtent=new Point(36,18),r.labelShadowOffset=new Point(-1,-1),r.labelShadowColor=i.highlightColor,r.labelColor=TurtleIconMorph.prototype.labelColor,r.contrast=this.buttonContrast,r.drawNew(),r.hint="Import a new costume from your webcam",r.setPosition(new Point(s,a)),r.fixLayout(),r.setCenter(i.center()),r.setLeft(i.right()+5),this.addContents(r),CamSnapshotDialogMorph.prototype.enabled||(r.disable(),r.hint=CamSnapshotDialogMorph.prototype.notSupportedMessage),document.addEventListener("cameraDisabled",function(){r.disable(),r.hint=CamSnapshotDialogMorph.prototype.notSupportedMessage})),(o=new TextMorph(localize("costumes tab help"))).fontSize=9,o.setColor(SpriteMorph.prototype.paletteTextColor),o.setPosition(new Point(s,a)),this.addContents(o),a=o.bottom()+4,this.sprite.costumes.asArray().forEach(function(o){e=t=new CostumeIconMorph(o,e),t.setPosition(new Point(s,a)),n.addContents(t),a=t.bottom()+4}),this.costumesVersion=this.sprite.costumes.lastChanged,this.contents.setPosition(l),this.adjustScrollBars(),Morph.prototype.trackChanges=h,this.changed(),this.updateSelection()},WardrobeMorph.prototype.updateSelection=function(){this.contents.children.forEach(function(t){t.refresh&&t.refresh()}),this.spriteVersion=this.sprite.version},WardrobeMorph.prototype.step=function(){this.costumesVersion!==this.sprite.costumes.lastChanged&&this.updateList(),this.spriteVersion!==this.sprite.version&&this.updateSelection()},WardrobeMorph.prototype.removeCostumeAt=function(t){this.sprite.shadowAttribute("costumes"),this.sprite.costumes.remove(t),this.updateList()},WardrobeMorph.prototype.paintNew=function(){var t=new Costume(newCanvas(null,!0),this.sprite.newCostumeName(localize("Untitled"))),e=this.parentThatIsA(IDE_Morph),o=this;t.edit(this.world(),e,!0,null,function(){o.sprite.shadowAttribute("costumes"),o.sprite.addCostume(t),o.updateList(),e&&e.currentSprite.wearCostume(t)})},WardrobeMorph.prototype.newFromCam=function(){var t=this.parentThatIsA(IDE_Morph),e=this,o=this.sprite;new CamSnapshotDialogMorph(t,o,nop,function(t){o.addCostume(t),o.wearCostume(t),e.updateList()}).popUp(this.world())},WardrobeMorph.prototype.wantsDropOf=function(t){return t instanceof CostumeIconMorph},WardrobeMorph.prototype.reactToDropOf=function(t){var e=0,o=t.object,i=t.top();t.destroy(),this.contents.children.forEach(function(t){t instanceof CostumeIconMorph&&t.top()<i-4&&(e+=1)}),this.sprite.shadowAttribute("costumes"),this.sprite.costumes.add(o,e+1),this.updateList(),t.mouseClickLeft()},SoundIconMorph.prototype=new ToggleButtonMorph,SoundIconMorph.prototype.constructor=SoundIconMorph,SoundIconMorph.uber=ToggleButtonMorph.prototype,SoundIconMorph.prototype.thumbSize=new Point(80,60),SoundIconMorph.prototype.labelShadowOffset=null,SoundIconMorph.prototype.labelShadowColor=null,SoundIconMorph.prototype.labelColor=new Color(255,255,255),SoundIconMorph.prototype.fontSize=9,SoundIconMorph.prototype.init=function(t,e){var o,i,r;e||(o=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor]),i=function(){nop()},r=function(){return!1},this.object=t,this.version=this.object.version,this.thumbnail=null,SoundIconMorph.uber.init.call(this,o,null,i,this.object.name,r,null,null,e),this.isDraggable=!0,this.createThumbnail(),this.padding=2,this.corner=8,this.fixLayout(),this.fps=1},SoundIconMorph.prototype.createThumbnail=function(){var t;this.thumbnail&&this.thumbnail.destroy(),this.thumbnail=new Morph,this.thumbnail.setExtent(this.thumbSize),this.add(this.thumbnail),t=new StringMorph(this.createInfo(),"16","",!0,!1,!1,this.labelShadowOffset,this.labelShadowColor,new Color(200,200,200)),this.thumbnail.add(t),t.setCenter(new Point(40,15)),this.button=new PushButtonMorph(this,"toggleAudioPlaying",this.object.previewAudio?"Stop":"Play"),this.button.drawNew(),this.button.hint="Play sound",this.button.fixLayout(),this.thumbnail.add(this.button),this.button.setCenter(new Point(40,40))},SoundIconMorph.prototype.createInfo=function(){var t=Math.round(this.object.audio.duration||0),e=t%60;return Math.floor(t/60).toString()+":"+(e<10?"0":"")+e.toString()},SoundIconMorph.prototype.toggleAudioPlaying=function(){var t=this;this.object.previewAudio?(this.button.labelString="Play",this.button.hint="Play sound",this.object.previewAudio.pause(),this.object.previewAudio.terminated=!0,this.object.previewAudio=null):(this.button.labelString="Stop",this.button.hint="Stop sound",this.object.previewAudio=this.object.play(),this.object.previewAudio.addEventListener("ended",function(){t.audioHasEnded()},!1)),this.button.createLabel()},SoundIconMorph.prototype.audioHasEnded=function(){this.button.trigger(),this.button.mouseLeave()},SoundIconMorph.prototype.createLabel=SpriteIconMorph.prototype.createLabel,SoundIconMorph.prototype.fixLayout=SpriteIconMorph.prototype.fixLayout,SoundIconMorph.prototype.userMenu=function(){var t=new MenuMorph(this);return this.object instanceof Sound?(t.addItem("rename","renameSound"),t.addItem("delete","removeSound"),t):null},SoundIconMorph.prototype.renameSound=function(){var t=this.object,e=this.parentThatIsA(IDE_Morph),o=this;this.disinherit(),new DialogBoxMorph(null,function(i){i&&i!==t.name&&(t.name=i,t.version=Date.now(),o.createLabel(),o.fixLayout(),e.hasChangedMedia=!0)}).prompt("rename sound",t.name,this.world())},SoundIconMorph.prototype.removeSound=function(){var t=this.parentThatIsA(JukeboxMorph),e=this.parent.children.indexOf(this);t.removeSound(e)},SoundIconMorph.prototype.createBackgrounds=SpriteIconMorph.prototype.createBackgrounds,SoundIconMorph.prototype.createLabel=SpriteIconMorph.prototype.createLabel,SoundIconMorph.prototype.disinherit=function(){var t=this.parentThatIsA(JukeboxMorph),e=this.parent.children.indexOf(this);t.sprite.inheritsAttribute("sounds")&&(t.sprite.shadowAttribute("sounds"),this.object=t.sprite.sounds.at(e))},SoundIconMorph.prototype.prepareToBeGrabbed=function(){this.disinherit(),this.removeSound()},JukeboxMorph.prototype=new ScrollFrameMorph,JukeboxMorph.prototype.constructor=JukeboxMorph,JukeboxMorph.uber=ScrollFrameMorph.prototype,JukeboxMorph.prototype.init=function(t,e){this.sprite=t||new SpriteMorph,this.soundsVersion=null,this.spriteVersion=null,JukeboxMorph.uber.init.call(this,null,null,e),this.acceptsDrops=!1,this.fps=2,this.updateList()},JukeboxMorph.prototype.updateList=function(){var t,e,o,i=this,r=this.left()+5,n=this.top()+5,s=Morph.prototype.trackChanges;this.changed(),s=Morph.prototype.trackChanges,Morph.prototype.trackChanges=!1,this.contents.destroy(),this.contents=new FrameMorph(this),this.contents.acceptsDrops=!1,this.contents.reactToDropOf=function(t){i.reactToDropOf(t)},this.addBack(this.contents),(o=new TextMorph(localize("import a sound from your computer\nby dragging it into here"))).fontSize=9,o.setColor(SpriteMorph.prototype.paletteTextColor),o.setPosition(new Point(r,n)),this.addContents(o),n=o.bottom()+4,this.sprite.sounds.asArray().forEach(function(o){e=t=new SoundIconMorph(o,e),t.setPosition(new Point(r,n)),i.addContents(t),n=t.bottom()+4}),this.soundsVersion=this.sprite.costumes.lastChanged,Morph.prototype.trackChanges=s,this.changed(),this.updateSelection()},JukeboxMorph.prototype.updateSelection=function(){this.contents.children.forEach(function(t){t.refresh&&t.refresh()}),this.spriteVersion=this.sprite.version},JukeboxMorph.prototype.step=function(){this.soundsVersion!==this.sprite.sounds.lastChanged&&this.updateList(),this.spriteVersion!==this.sprite.version&&this.updateSelection()},JukeboxMorph.prototype.removeSound=function(t){this.sprite.sounds.remove(t),this.updateList()},JukeboxMorph.prototype.wantsDropOf=function(t){return t instanceof SoundIconMorph},JukeboxMorph.prototype.reactToDropOf=function(t){var e=0,o=t.object,i=t.top();t.destroy(),this.contents.children.forEach(function(t){t.top()<i-4&&(e+=1)}),this.sprite.shadowAttribute("sounds"),this.sprite.sounds.add(o,e),this.updateList()},StageHandleMorph.prototype=new Morph,StageHandleMorph.prototype.constructor=StageHandleMorph,StageHandleMorph.uber=Morph.prototype,StageHandleMorph.prototype.init=function(t){this.target=t||null,HandleMorph.uber.init.call(this),this.color=MorphicPreferences.isFlat?IDE_Morph.prototype.groupColor:new Color(190,190,190),this.isDraggable=!1,this.noticesTransparentClick=!0,this.setExtent(new Point(12,50))},StageHandleMorph.prototype.drawNew=function(){this.normalImage=newCanvas(this.extent()),this.highlightImage=newCanvas(this.extent()),this.drawOnCanvas(this.normalImage,this.color),this.drawOnCanvas(this.highlightImage,MorphicPreferences.isFlat?new Color(245,245,255):new Color(100,100,255),this.color),this.image=this.normalImage,this.fixLayout()},StageHandleMorph.prototype.drawOnCanvas=function(t,e,o){var i,r,n,s=t.getContext("2d"),a=t.height/8,h=t.width/6,l=h/2;for(s.lineWidth=h,s.lineCap="round",r=t.height/2,s.strokeStyle=e.toString(),i=t.width/12,n=0;n<3;n+=1)n>0&&(s.beginPath(),s.moveTo(i,r-(a-l)),s.lineTo(i,r+(a-l)),s.stroke()),i+=2*h,a*=2;if(o)for(s.strokeStyle=o.toString(),i=t.width/12+h,a=t.height/8,n=0;n<3;n+=1)n>0&&(s.beginPath(),s.moveTo(i,r-(a-l)),s.lineTo(i,r+(a-l)),s.stroke()),i+=2*h,a*=2},StageHandleMorph.prototype.fixLayout=function(){if(this.target){var t=this.target.parentThatIsA(IDE_Morph);this.setTop(this.target.top()+10),this.setRight(this.target.left()),t&&t.add(this)}},StageHandleMorph.prototype.step=null,StageHandleMorph.prototype.mouseDownLeft=function(t){var e=this.world(),o=this.right()-t.x,i=this,r=this.target.parentThatIsA(IDE_Morph);if(!this.target)return null;r.isSmallStage=!0,r.controlBar.stageSizeButton.refresh(),this.step=function(){var t,n;e.hand.mouseButton?(t=e.hand.bounds.origin.x+o,n=i.target.right()-t,r.stageRatio=n/i.target.dimensions.x,r.setExtent(e.extent())):(this.step=null,r.isSmallStage=1!==r.stageRatio,r.controlBar.stageSizeButton.refresh())}},StageHandleMorph.prototype.mouseEnter=function(){this.image=this.highlightImage,this.changed()},StageHandleMorph.prototype.mouseLeave=function(){this.image=this.normalImage,this.changed()},StageHandleMorph.prototype.mouseDoubleClick=function(){this.target.parentThatIsA(IDE_Morph).toggleStageSize(!0,1)},PaletteHandleMorph.prototype=new Morph,PaletteHandleMorph.prototype.constructor=PaletteHandleMorph,PaletteHandleMorph.uber=Morph.prototype,PaletteHandleMorph.prototype.init=function(t){this.target=t||null,HandleMorph.uber.init.call(this),this.color=MorphicPreferences.isFlat?new Color(255,255,255):new Color(190,190,190),this.isDraggable=!1,this.noticesTransparentClick=!0,this.setExtent(new Point(12,50))},PaletteHandleMorph.prototype.drawNew=StageHandleMorph.prototype.drawNew,PaletteHandleMorph.prototype.drawOnCanvas=StageHandleMorph.prototype.drawOnCanvas,PaletteHandleMorph.prototype.fixLayout=function(){if(this.target){var t=this.target.parentThatIsA(IDE_Morph);this.setTop(this.target.top()+10),this.setRight(this.target.right()),t&&t.add(this)}},PaletteHandleMorph.prototype.step=null,PaletteHandleMorph.prototype.mouseDownLeft=function(t){var e=this.world(),o=this.right()-t.x,i=this.target.parentThatIsA(IDE_Morph);if(!this.target)return null;this.step=function(){var t;e.hand.mouseButton?(t=e.hand.bounds.origin.x+o,i.paletteWidth=Math.min(Math.max(200,t),i.stageHandle.left()-i.spriteBar.tabBar.width()),i.setExtent(e.extent())):this.step=null}},PaletteHandleMorph.prototype.mouseEnter=StageHandleMorph.prototype.mouseEnter,PaletteHandleMorph.prototype.mouseLeave=StageHandleMorph.prototype.mouseLeave,PaletteHandleMorph.prototype.mouseDoubleClick=function(){this.target.parentThatIsA(IDE_Morph).setPaletteWidth(200)},CamSnapshotDialogMorph.prototype=new DialogBoxMorph,CamSnapshotDialogMorph.prototype.constructor=CamSnapshotDialogMorph,CamSnapshotDialogMorph.uber=DialogBoxMorph.prototype,CamSnapshotDialogMorph.prototype.enableCamera=!0,CamSnapshotDialogMorph.prototype.enabled=!0,CamSnapshotDialogMorph.prototype.notSupportedMessage='Please make sure your web browser is up to date\nand your camera is properly configured. \n\nSome browsers also require you to access Snap!\nthrough HTTPS to use the camera.\n\nPlase replace the "http://" part of the address\nin your browser by "https://" and try again.',CamSnapshotDialogMorph.prototype.init=function(t,e,o,i){this.ide=t,this.sprite=e,this.padding=10,this.oncancel=o,this.accept=i,this.videoElement=null,this.videoView=new Morph,CamSnapshotDialogMorph.uber.init.call(this),this.labelString="Camera",this.createLabel(),this.buildContents()},CamSnapshotDialogMorph.prototype.buildContents=function(){function t(){e.disable(),e.ide.inform("Camera not supported",CamSnapshotDialogMorph.prototype.notSupportedMessage),e.videoElement&&e.videoElement.remove(),e.cancel()}var e=this,o=this.sprite.parentThatIsA(StageMorph);this.videoElement=document.createElement("video"),this.videoElement.hidden=!0,this.videoElement.width=o.dimensions.x,this.videoElement.height=o.dimensions.y,document.body.appendChild(this.videoElement),navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&navigator.mediaDevices.getUserMedia({video:!0}).then(function(o){e.videoElement.srcObject=o,e.videoElement.play().catch(t),e.videoElement.stream=o}).catch(t),this.videoView.setExtent(o.dimensions),this.videoView.image=newCanvas(o.dimensions),this.videoView.drawOn=function(t){var i,r,n=t.getContext("2d"),s=e.videoElement.videoWidth,a=e.videoElement.videoHeight,h=o.dimensions.x,l=o.dimensions.y;s&&(n.save(),n.translate(h,0),n.scale(-1,1),s/h>a/l?(i=h*(a/l),r=a):(i=s,r=l*(s/h)),n.drawImage(e.videoElement,0,0,i,r,-1*this.left(),this.top(),h,l),n.restore())},this.videoView.step=function(){this.changed()},this.addBody(new AlignmentMorph("column",this.padding/2)),this.body.add(this.videoView),this.body.fixLayout(),this.addButton("ok","Save"),this.addButton("cancel","Cancel"),this.fixLayout(),this.drawNew()},CamSnapshotDialogMorph.prototype.ok=function(){this.accept(new Costume(this.videoView.fullImageClassic(),this.sprite.newCostumeName("camera")).flipped())},CamSnapshotDialogMorph.prototype.disable=function(){CamSnapshotDialogMorph.prototype.enabled=!1,document.dispatchEvent(new Event("cameraDisabled"))},CamSnapshotDialogMorph.prototype.destroy=function(){this.oncancel.call(this),this.close()},CamSnapshotDialogMorph.prototype.close=function(){this.videoElement&&this.videoElement.stream&&(this.videoElement.stream.getTracks()[0].stop(),this.videoElement.remove()),CamSnapshotDialogMorph.uber.destroy.call(this)},modules.paint="2017-April-10";var PaintEditorMorph,PaintCanvasMorph,PaintColorPickerMorph;PaintEditorMorph.prototype=new DialogBoxMorph,PaintEditorMorph.prototype.constructor=PaintEditorMorph,PaintEditorMorph.uber=DialogBoxMorph.prototype,PaintEditorMorph.prototype.padding=10,PaintEditorMorph.prototype.init=function(){this.paper=null,this.oncancel=null,PaintEditorMorph.uber.init.call(this),this.labelString="Paint Editor",this.createLabel(),this.buildContents()},PaintEditorMorph.prototype.buildContents=function(){var t=this;this.paper=new PaintCanvasMorph(function(){return t.shift}),this.paper.setExtent(StageMorph.prototype.dimensions),this.addBody(new AlignmentMorph("row",this.padding)),this.controls=new AlignmentMorph("column",this.padding/2),this.controls.alignment="left",this.edits=new AlignmentMorph("row",this.padding/2),this.buildEdits(),this.controls.add(this.edits),this.body.color=this.color,this.body.add(this.controls),this.body.add(this.paper),this.toolbox=new BoxMorph,this.toolbox.color=SpriteMorph.prototype.paletteColor.lighter(8),this.toolbox.borderColor=this.toolbox.color.lighter(40),MorphicPreferences.isFlat&&(this.toolbox.edge=0),this.buildToolbox(),this.controls.add(this.toolbox),this.scaleBox=new AlignmentMorph("row",this.padding/2),this.buildScaleBox(),this.controls.add(this.scaleBox),this.propertiesControls={colorpicker:null,penSizeSlider:null,penSizeField:null,primaryColorButton:null,primaryColorViewer:null,constrain:null},this.populatePropertiesMenu(),this.addButton("ok","OK"),this.addButton("cancel","Cancel"),this.refreshToolButtons(),this.fixLayout(),this.drawNew()},PaintEditorMorph.prototype.buildToolbox=function(){var t={brush:"Paintbrush tool\n(free draw)",rectangle:"Stroked Rectangle\n(shift: square)",circle:"Stroked Ellipse\n(shift: circle)",eraser:"Eraser tool",crosshairs:"Set the rotation center",line:"Line tool\n(shift: vertical/horizontal)",rectangleSolid:"Filled Rectangle\n(shift: square)",circleSolid:"Filled Ellipse\n(shift: circle)",paintbucket:"Fill a region",pipette:"Pipette tool\n(pick a color anywhere)"},e=this,o=this.toolbox.left(),i=this.toolbox.top(),r=0,n=0;Object.keys(t).forEach(function(s){var a=e.toolButton(s,t[s]);a.setPosition(new Point(o+r,i+n)),r+=a.width()+2,"crosshairs"===s&&(r=0,n+=a.height()+2,e.paper.drawcrosshair()),e.toolbox[s]=a,e.toolbox.add(a)}),this.toolbox.bounds=this.toolbox.fullBounds().expandBy(10),this.toolbox.drawNew()},PaintEditorMorph.prototype.buildEdits=function(){var t=this.paper;this.edits.add(this.pushButton("undo",function(){t.undo()})),this.edits.add(this.pushButton("clear",function(){t.clearCanvas()})),this.edits.fixLayout()},PaintEditorMorph.prototype.buildScaleBox=function(){var t=this.paper;this.scaleBox.add(this.pushButton("grow",function(){t.scale(.05,.05)})),this.scaleBox.add(this.pushButton("shrink",function(){t.scale(-.05,-.05)})),this.scaleBox.add(this.pushButton("flip ↔",function(){t.scale(-2,0)})),this.scaleBox.add(this.pushButton("flip ↕",function(){t.scale(0,-2)})),this.scaleBox.fixLayout()},PaintEditorMorph.prototype.openIn=function(t,e,o,i){this.oldim=e,this.callback=i||nop,this.processKeyUp=function(){this.shift=!1,this.propertiesControls.constrain.refresh()},this.processKeyDown=function(){this.shift=16===this.world().currentKey,this.propertiesControls.constrain.refresh()},this.oldim&&(this.paper.automaticCrosshairs=isNil(o),this.paper.centermerge(this.oldim,this.paper.paper),this.paper.rotationCenter=(o||new Point(0,0)).add(new Point((this.paper.paper.width-this.oldim.width)/2,(this.paper.paper.height-this.oldim.height)/2)),this.paper.drawNew()),this.key="paint",this.popUp(t)},PaintEditorMorph.prototype.fixLayout=function(){var t=Morph.prototype.trackChanges;this.changed(),t=Morph.prototype.trackChanges,Morph.prototype.trackChanges=!1,this.paper&&(this.paper.buildContents(),this.paper.drawNew()),this.controls&&this.controls.fixLayout(),this.body&&this.body.fixLayout(),PaintEditorMorph.uber.fixLayout.call(this),Morph.prototype.trackChanges=t,this.changed()},PaintEditorMorph.prototype.refreshToolButtons=function(){this.toolbox.children.forEach(function(t){t.refresh()})},PaintEditorMorph.prototype.ok=function(){this.paper.updateAutomaticCenter(),this.callback(this.paper.paper,this.paper.rotationCenter),this.destroy()},PaintEditorMorph.prototype.cancel=function(){this.oncancel&&this.oncancel(),this.destroy()},PaintEditorMorph.prototype.populatePropertiesMenu=function(){var t=this.controls,e=this,o=this.propertiesControls,i=new AlignmentMorph("row",this.padding);o.primaryColorViewer=new Morph,o.primaryColorViewer.setExtent(new Point(180,50)),o.primaryColorViewer.color=new Color(0,0,0),o.colorpicker=new PaintColorPickerMorph(new Point(180,100),function(t){var i,r,n=newCanvas(o.primaryColorViewer.extent()),s=n.getContext("2d");if(e.paper.settings.primarycolor=t,"transparent"===t)for(i=0;i<180;i+=5)for(r=0;r<15;r+=5)s.fillStyle=(r+i)/5%2==0?"rgba(0, 0, 0, 0.2)":"rgba(0, 0, 0, 0.5)",s.fillRect(i,r,5,5);else s.fillStyle=t.toString(),s.fillRect(0,0,180,15);s.strokeStyle="black",s.lineWidth=Math.min(e.paper.settings.linewidth,20),s.beginPath(),s.lineCap="round",s.moveTo(20,30),s.lineTo(160,30),s.stroke(),o.primaryColorViewer.image=n,o.primaryColorViewer.changed()}),o.colorpicker.action(new Color(0,0,0)),o.penSizeSlider=new SliderMorph(0,20,5,5),o.penSizeSlider.orientation="horizontal",o.penSizeSlider.setHeight(15),o.penSizeSlider.setWidth(150),o.penSizeSlider.action=function(t){o.penSizeField&&o.penSizeField.setContents(t),e.paper.settings.linewidth=t,o.colorpicker.action(e.paper.settings.primarycolor)},o.penSizeField=new InputFieldMorph("5",!0,null,!1),o.penSizeField.contents().minWidth=20,o.penSizeField.setWidth(25),o.penSizeField.accept=function(){var t=parseFloat(o.penSizeField.getValue());o.penSizeSlider.value=t,o.penSizeSlider.drawNew(),o.penSizeSlider.updateValue(),this.setContents(t),e.paper.settings.linewidth=t,this.world().keyboardReceiver=e,o.colorpicker.action(e.paper.settings.primarycolor)},i.add(o.penSizeSlider),i.add(o.penSizeField),i.color=e.color,i.fixLayout(),o.penSizeField.drawNew(),o.constrain=new ToggleMorph("checkbox",this,function(){e.shift=!e.shift},"Constrain proportions of shapes?\n(you can also hold shift)",function(){return e.shift}),t.add(o.colorpicker),t.add(o.primaryColorViewer),t.add(new TextMorph(localize("Brush size"))),t.add(i),t.add(o.constrain)},PaintEditorMorph.prototype.toolButton=function(t,e){var o,i=this;return o=new ToggleButtonMorph(null,this,function(){i.paper.currentTool=t,i.paper.toolChanged(t),i.refreshToolButtons(),"pipette"===t&&i.getUserColor()},new SymbolMorph(t,18),function(){return i.paper.currentTool===t}),o.hint=e,o.drawNew(),o.fixLayout(),o},PaintEditorMorph.prototype.pushButton=function(t,e,o){return new PushButtonMorph(this,e,t,null,o)},PaintEditorMorph.prototype.getUserColor=function(){var t=this,e=this.world(),o=e.hand,i=getDocumentPositionOf(e.worldCanvas),r=o.processMouseMove,n=o.processMouseDown,s=o.processMouseUp;o.processMouseMove=function(r){var n;o.setPosition(new Point(r.pageX-i.x,r.pageY-i.y)),(n=e.getGlobalPixelColor(o.position())).a&&(n.a=255,t.propertiesControls.colorpicker.action(n))},o.processMouseDown=nop,o.processMouseUp=function(){t.paper.currentTool="brush",t.paper.toolChanged("brush"),t.refreshToolButtons(),o.processMouseMove=r,o.processMouseDown=n,o.processMouseUp=s}},PaintColorPickerMorph.prototype=new Morph,PaintColorPickerMorph.prototype.constructor=PaintColorPickerMorph,PaintColorPickerMorph.uber=Morph.prototype,PaintColorPickerMorph.prototype.init=function(t,e){this.setExtent(t||new Point(200,100)),this.action=e||nop,this.drawNew()},PaintColorPickerMorph.prototype.drawNew=function(){var t,e,o=0,i=0,r=newCanvas(this.extent()),n=r.getContext("2d");for(o=0;o<this.width();o+=1)for(i=0;i<this.height()-20;i+=1)n.fillStyle="hsl("+360*o/this.width()+",100%,"+100*i/(this.height()-20)+"%)",n.fillRect(o,i,1,1);for(o=0;o<this.width();o+=1)e=Math.floor(255*o/this.width()),n.fillStyle="rgb("+e+", "+e+", "+e+")",n.fillRect(o,this.height()-20,1,10);for(t=["black","white","gray"],o=0;o<t.length;o+=1)n.fillStyle=t[o],n.fillRect(o*this.width()/t.length,this.height()-10,this.width()/t.length,10);for(o=2*this.width()/3;o<this.width();o+=2)for(i=this.height()-10;i<this.height();i+=2)(o+i)/2%2==0&&(n.fillStyle="#DDD",n.fillRect(o,i,2,2));this.image=r},PaintColorPickerMorph.prototype.mouseDownLeft=function(t){t.subtract(this.position()).x>2*this.width()/3&&t.subtract(this.position()).y>this.height()-10?this.action("transparent"):this.action(this.getPixelColor(t))},PaintColorPickerMorph.prototype.mouseMove=PaintColorPickerMorph.prototype.mouseDownLeft,PaintCanvasMorph.prototype=new Morph,PaintCanvasMorph.prototype.constructor=PaintCanvasMorph,PaintCanvasMorph.uber=Morph.prototype,PaintCanvasMorph.prototype.init=function(t){this.rotationCenter=new Point(240,180),this.dragRect=null,this.previousDragPoint=null,this.currentTool="brush",this.dragRect=new Rectangle,this.mask=newCanvas(this.extent(),!0),this.paper=newCanvas(this.extent(),!0),this.erasermask=newCanvas(this.extent(),!0),this.background=newCanvas(this.extent()),this.settings={primarycolor:new Color(0,0,0,255),secondarycolor:new Color(0,0,0,255),linewidth:3},this.brushBuffer=[],this.undoBuffer=[],this.isShiftPressed=t||function(){return 16===this.world().currentKey},this.automaticCrosshairs=!0,this.noticesTransparentClick=!0,this.buildContents()},PaintCanvasMorph.prototype.calculateCanvasCenter=function(t){var e=Costume.prototype.canvasBoundingBox(t);return null===e?null:new Point((e.origin.x+e.corner.x)/2,(e.origin.y+e.corner.y)/2)},PaintCanvasMorph.prototype.updateAutomaticCenter=function(){if(this.automaticCrosshairs){var t=this.calculateCanvasCenter(this.paper);null!==t&&(this.rotationCenter=t)}},PaintCanvasMorph.prototype.scale=function(t,e){this.updateAutomaticCenter(),this.mask=newCanvas(this.extent(),!0);var o=newCanvas(this.extent(),!0);o.getContext("2d").save(),o.getContext("2d").translate(this.rotationCenter.x,this.rotationCenter.y),o.getContext("2d").scale(1+t,1+e),o.getContext("2d").drawImage(this.paper,-this.rotationCenter.x,-this.rotationCenter.y),o.getContext("2d").restore(),this.paper=o,this.drawNew(),this.changed()},PaintCanvasMorph.prototype.cacheUndo=function(){var t=newCanvas(this.extent(),!0);this.merge(this.paper,t),this.undoBuffer.push(t)},PaintCanvasMorph.prototype.undo=function(){this.undoBuffer.length>0&&(this.paper=newCanvas(this.extent(),!0),this.mask.width=this.mask.width+1-1,this.merge(this.undoBuffer.pop(),this.paper),this.drawNew(),this.changed())},PaintCanvasMorph.prototype.merge=function(t,e){e.getContext("2d").drawImage(t,0,0)},PaintCanvasMorph.prototype.centermerge=function(t,e){e.getContext("2d").drawImage(t,(e.width-t.width)/2,(e.height-t.height)/2)},PaintCanvasMorph.prototype.clearCanvas=function(){this.buildContents(),this.drawNew(),this.changed()},PaintCanvasMorph.prototype.toolChanged=function(t){this.mask=newCanvas(this.extent(),!0),"crosshairs"===t&&(this.updateAutomaticCenter(),this.drawcrosshair()),this.drawNew(),this.changed()},PaintCanvasMorph.prototype.drawcrosshair=function(t){var e=t||this.mask.getContext("2d"),o=this.rotationCenter;e.lineWidth=1,e.strokeStyle="black",e.clearRect(0,0,this.mask.width,this.mask.height),e.globalAlpha=.5,e.fillStyle="white",e.beginPath(),e.arc(o.x,o.y,20,radians(0),radians(360),!1),e.closePath(),e.fill(),e.stroke(),e.beginPath(),e.arc(o.x,o.y,10,radians(0),radians(360),!1),e.stroke(),e.beginPath(),e.moveTo(0,o.y),e.lineTo(this.mask.width,o.y),e.stroke(),e.beginPath(),e.moveTo(o.x,0),e.lineTo(o.x,this.mask.height),e.stroke(),this.drawNew(),this.changed()},PaintCanvasMorph.prototype.floodfill=function(t){var e,o,i,r,n=this.paper.width,s=this.paper.height,a=this.paper.getContext("2d"),h=a.getImageData(0,0,n,s),l=h.data,p=[Math.round(Math.round(t.y)*n+t.x)];if(o=function(t){var e=4*t;return[l[e],l[e+1],l[e+2],l[e+3]]},i=o(p[0]),r=function(t){return t[0]===i[0]&&t[1]===i[1]&&t[2]===i[2]&&t[3]===i[3]},(0!==i[3]||"transparent"!==this.settings.primarycolor)&&!(i[0]===this.settings.primarycolor.r&&i[1]===this.settings.primarycolor.g&&i[2]===this.settings.primarycolor.b&&i[3]===this.settings.primarycolor.a||0===i[3]&&0===this.settings.primarycolor.a)){for(;p.length>0;)r(o(e=p.pop()))&&(e%n>1&&(p.push(e+1),p.push(e-1)),e>0&&e<s*n&&(p.push(e+n),p.push(e-n))),"transparent"===this.settings.primarycolor?l[4*e+3]=0:(l[4*e]=this.settings.primarycolor.r,l[4*e+1]=this.settings.primarycolor.g,l[4*e+2]=this.settings.primarycolor.b,l[4*e+3]=255*this.settings.primarycolor.a);a.putImageData(h,0,0),this.drawNew(),this.changed()}},PaintCanvasMorph.prototype.mouseDownLeft=function(t){return this.cacheUndo(),this.dragRect.origin=t.subtract(this.bounds.origin),this.dragRect.corner=t.subtract(this.bounds.origin),this.previousDragPoint=this.dragRect.corner.copy(),"crosshairs"===this.currentTool?(this.rotationCenter=t.subtract(this.bounds.origin),void this.drawcrosshair()):"paintbucket"===this.currentTool?this.floodfill(t.subtract(this.bounds.origin)):void("transparent"===this.settings.primarycolor&&"crosshairs"!==this.currentTool&&(this.erasermask=newCanvas(this.extent(),!0),this.merge(this.paper,this.erasermask)))},PaintCanvasMorph.prototype.mouseMove=function(t){function e(){return Math.max(Math.abs(c),Math.abs(d))*(c/Math.abs(c))}function o(){return Math.max(Math.abs(c),Math.abs(d))*(d/Math.abs(d))}if("paintbucket"!==this.currentTool){var i,r=t.subtract(this.bounds.origin),n=this.mask.getContext("2d"),s=this.paper.getContext("2d"),a=this.dragRect.origin.x,h=this.dragRect.origin.y,l=r.x,p=r.y,c=(l-a)/2,d=(p-h)/2,u=this.paper.width;switch(n.save(),this.brushBuffer.push([l,p]),n.lineWidth=this.settings.linewidth,n.clearRect(0,0,this.bounds.width(),this.bounds.height()),this.dragRect.corner=r.subtract(this.dragRect.origin),"transparent"===this.settings.primarycolor&&"crosshairs"!==this.currentTool?(this.merge(this.erasermask,this.mask),s.clearRect(0,0,this.bounds.width(),this.bounds.height()),n.globalCompositeOperation="destination-out"):(n.fillStyle=this.settings.primarycolor.toString(),n.strokeStyle=this.settings.primarycolor.toString()),this.currentTool){case"rectangle":this.isShiftPressed()?n.strokeRect(a,h,2*e(),2*o()):n.strokeRect(a,h,2*c,2*d);break;case"rectangleSolid":this.isShiftPressed()?n.fillRect(a,h,2*e(),2*o()):n.fillRect(a,h,2*c,2*d);break;case"brush":for(n.lineCap="round",n.lineJoin="round",n.beginPath(),n.moveTo(this.brushBuffer[0][0],this.brushBuffer[0][1]),i=0;i<this.brushBuffer.length;i+=1)n.lineTo(this.brushBuffer[i][0],this.brushBuffer[i][1]);n.stroke();break;case"line":n.beginPath(),n.moveTo(a,h),this.isShiftPressed()?Math.abs(d)>Math.abs(c)?n.lineTo(a,p):n.lineTo(l,h):n.lineTo(l,p),n.stroke();break;case"circle":case"circleSolid":if(n.beginPath(),this.isShiftPressed())n.arc(a,h,new Point(a,h).distanceTo(new Point(l,p)),0,2*Math.PI,!1);else{for(i=0;i<u;i+=1)n.lineTo(i,2*d*Math.sqrt(2-Math.pow((i-a)/(2*c),2))+h);for(i=u;i>0;i-=1)n.lineTo(i,2*d*-1*Math.sqrt(2-Math.pow((i-a)/(2*c),2))+h)}n.closePath(),"circleSolid"===this.currentTool?n.fill():"circle"===this.currentTool&&n.stroke();break;case"crosshairs":this.automaticCrosshairs=!1,this.rotationCenter=r.copy(),this.drawcrosshair(n);break;case"eraser":for(this.merge(this.paper,this.mask),n.save(),n.globalCompositeOperation="destination-out",n.beginPath(),n.moveTo(this.brushBuffer[0][0],this.brushBuffer[0][1]),i=0;i<this.brushBuffer.length;i+=1)n.lineTo(this.brushBuffer[i][0],this.brushBuffer[i][1]);n.stroke(),n.restore(),this.paper=newCanvas(this.extent(),!0),this.merge(this.mask,this.paper);break;default:nop()}this.previousDragPoint=r,this.drawNew(),this.changed(),n.restore()}},PaintCanvasMorph.prototype.mouseClickLeft=function(){"crosshairs"!==this.currentTool&&this.merge(this.mask,this.paper),this.brushBuffer=[]},PaintCanvasMorph.prototype.mouseLeaveDragging=PaintCanvasMorph.prototype.mouseClickLeft,PaintCanvasMorph.prototype.buildContents=function(){this.background=newCanvas(this.extent()),this.paper=newCanvas(this.extent(),!0),this.mask=newCanvas(this.extent(),!0),this.erasermask=newCanvas(this.extent(),!0);var t,e,o=this.background.getContext("2d");for(t=0;t<this.background.width;t+=5)for(e=0;e<this.background.height;e+=5)o.fillStyle=(t+e)/5%2==1?"rgba(255, 255, 255, 1)":"rgba(255, 255, 255, 0.3)",o.fillRect(t,e,5,5)},PaintCanvasMorph.prototype.drawNew=function(){var t=newCanvas(this.extent(),!0);this.merge(this.background,t),this.merge(this.paper,t),this.merge(this.mask,t),this.image=t,this.drawFrame()},PaintCanvasMorph.prototype.drawFrame=function(){var t,e;t=this.image.getContext("2d"),this.parent?(this.color=this.parent.color.lighter(.75*this.contrast),e=this.parent.color):e=new Color(120,120,120),t.fillStyle=this.color.toString(),this.cachedClr=e.toString(),this.cachedClrBright=e.lighter(this.contrast).toString(),this.cachedClrDark=e.darker(this.contrast).toString(),this.drawRectBorder(t)},PaintCanvasMorph.prototype.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,PaintCanvasMorph.prototype.edge=InputFieldMorph.prototype.edge,PaintCanvasMorph.prototype.fontSize=InputFieldMorph.prototype.fontSize,PaintCanvasMorph.prototype.typeInPadding=InputFieldMorph.prototype.typeInPadding,PaintCanvasMorph.prototype.contrast=InputFieldMorph.prototype.contrast,modules.lists="2017-September-01";var List,ListWatcherMorph;List.prototype.enableTables=!1,List.prototype.toString=function(){return"a List ["+this.length+" elements]"},List.prototype.changed=function(){this.lastChanged=Date.now()},List.prototype.cons=function(t,e){var o=new List;if(!(e instanceof List||isNil(e)))throw new Error("cdr isn't a list: "+e);return o.first=isNil(t)?null:t,o.rest=e||null,o.isLinked=!0,o},List.prototype.cdr=function(){var t,e;if(this.isLinked)return this.rest||new List;if(this.contents.length<2)return new List;for(t=new List,e=this.contents.length;e>1;e-=1)t=this.cons(this.at(e),t);return t},List.prototype.add=function(t,e){var o=e||this.length()+1,i=isNil(t)?null:t;this.becomeArray(),this.contents.splice(o-1,0,i),this.changed()},List.prototype.put=function(t,e){var o=0===t?0:!1!==t&&(t||null);this.becomeArray(),this.contents[e-1]=o,this.changed()},List.prototype.remove=function(t){this.becomeArray(),this.contents.splice(t-1,1),this.changed()},List.prototype.clear=function(){this.contents=[],this.first=null,this.rest=null,this.isLinked=!1,this.changed()},List.prototype.length=function(){if(this.isLinked){for(var t=this,e=0;t&&t.isLinked;)e+=1,t=t.rest;return e+(t?t.contents.length:0)}return this.contents.length},List.prototype.at=function(t){for(var e,o=+t,i=this;i.isLinked;){if(!(o>1))return i.first;i=i.rest,o-=1}return e=i.contents[o-1],isNil(e)?"":e},List.prototype.contains=function(t){for(var e=this;e.isLinked;){if(snapEquals(e.first,t))return!0;e=e.rest}return e.contents.some(function(e){return snapEquals(e,t)})},List.prototype.isTable=function(){return this.enableTables&&(this.length()>100||this.cols()>1)},List.prototype.get=function(t,e){var o,i,r;return t?e?(o=this.at(e),o instanceof List?(i=o.length(),r=this.cols(),t>i?null:1===r&&i>1?[o]:t>=r&&i>r?new Variable(o.at(t)):o.at(t)):1===t&&e<=this.rows()?[o]:null):1===this.cols()?localize("items"):this.colName(t):e?e>this.rows()?null:this.rowName(e):[this.length()]},List.prototype.rows=function(){return this.length()},List.prototype.cols=function(){var t=this.at(1);return t instanceof List?t.length():1},List.prototype.colName=function(t){return t>this.cols()?null:String.fromCharCode(64+(t%26||26)).repeat(Math.floor((t-1)/26)+1)},List.prototype.rowName=function(t){return t},List.prototype.columnNames=function(){return[]},List.prototype.version=function(t,e){var o,i,r=Math.min(t+e,this.length()),n=this.lastChanged;for(i=t;i<=r;i+=1)o=this.at(i),n=Math.max(n,o.lastChanged?o.lastChanged:0);return n},List.prototype.asArray=function(){return this.becomeArray(),this.contents},List.prototype.itemsArray=function(){if(this.isLinked){for(var t,e=this,o=[];e&&e.isLinked;)o.push(e.first),e=e.rest;if(e)for(t=1;t<=e.contents.length;t+=1)o.push(e.at(t));return o}return this.contents},List.prototype.asText=function(){for(var t,e,o,i="",r=this;r.isLinked;)(e=r.first)instanceof List?i=i.concat(e.asText()):(e=isNil(e)?"":e.toString(),i=i.concat(e)),r=r.rest;for(t=r.length(),o=1;o<=t;o+=1)(e=r.at(o))instanceof List?i=i.concat(e.asText()):(e=isNil(e)?"":e.toString(),i=i.concat(e));return i},List.prototype.becomeArray=function(){this.isLinked&&(this.contents=this.itemsArray(),this.isLinked=!1,this.first=null,this.rest=null)},List.prototype.becomeLinked=function(){var t,e,o=this;if(!this.isLinked){for(e=this.length(),t=0;t<e;t+=1)o.first=this.contents[t],t<e-1&&(o.rest=new List,o.isLinked=!0,o=o.rest);this.contents=[],this.isLinked=!0}},List.prototype.equalTo=function(t){var e,o,i,r=this,n=t;if(!(t instanceof List))return!1;for(;r.isLinked&&n.isLinked;){if(!snapEquals(r.first,n.first))return!1;r=r.rest,n=n.rest}for(n.isLinked&&(e=n,n=r,r=e),o=0;r.isLinked;){if(!snapEquals(r.first,n.contents[o]))return!1;r=r.rest,o+=1}if(e=0,r.contents.length!==n.contents.length-o)return!1;for(i=r.contents.length;i>0;){if(i-=1,!snapEquals(r.contents[e],n.contents[o]))return!1;e+=1,o+=1}return!0},ListWatcherMorph.prototype=new BoxMorph,ListWatcherMorph.prototype.constructor=ListWatcherMorph,ListWatcherMorph.uber=BoxMorph.prototype,ListWatcherMorph.prototype.cellColor=SpriteMorph.prototype.blockColor.lists,ListWatcherMorph.prototype.init=function(t,e){var o=this;this.list=t||new List,this.start=1,this.range=100,this.lastUpdated=Date.now(),this.lastCell=null,this.parentCell=e||null,this.label=new StringMorph(localize("length: ")+this.list.length(),SyntaxElementMorph.prototype.fontSize,null,!1,!1,!1,MorphicPreferences.isFlat?new Point:new Point(1,1),new Color(255,255,255)),this.label.mouseClickLeft=function(){o.startIndexMenu()},this.frame=new ScrollFrameMorph(null,10),this.frame.alpha=0,this.frame.acceptsDrops=!1,this.frame.contents.acceptsDrops=!1,this.handle=new HandleMorph(this,80,70,3,3),this.handle.setExtent(new Point(13,13)),this.arrow=new ArrowMorph("down",SyntaxElementMorph.prototype.fontSize),this.arrow.mouseClickLeft=function(){o.startIndexMenu()},this.arrow.setRight(this.handle.right()),this.arrow.setBottom(this.handle.top()),this.handle.add(this.arrow),this.plusButton=new PushButtonMorph(this.list,"add","+"),this.plusButton.padding=0,this.plusButton.edge=0,this.plusButton.outlineColor=this.color,this.plusButton.drawNew(),this.plusButton.fixLayout(),ListWatcherMorph.uber.init.call(this,SyntaxElementMorph.prototype.rounding,1.000001,new Color(120,120,120)),this.color=new Color(220,220,220),this.isDraggable=!1,this.setExtent(new Point(80,70).multiplyBy(SyntaxElementMorph.prototype.scale)),this.add(this.label),this.add(this.frame),this.add(this.plusButton),this.add(this.handle),this.handle.drawNew(),this.update(),this.fixLayout()},ListWatcherMorph.prototype.update=function(t){var e,o,i,r,n,s,a,h,l,p;if(this.frame.contents.children.forEach(function(t){t instanceof CellMorph&&(t.contentsMorph instanceof ListWatcherMorph?t.contentsMorph.update():isSnapObject(t.contents)&&t.update())}),this.lastUpdated===this.list.lastChanged&&!t)return null;for(this.updateLength(!0),this.start=Math.max(Math.min(this.start,Math.floor((this.list.length()-1)/this.range)*this.range+1),1),l=Math.min(this.start+this.range-1,this.list.length()),i=Math.min(3*(l-this.start+1),this.frame.contents.children.length),e=0;e<i;e+=3)o=this.start+e/3,n=this.frame.contents.children[e],a=this.frame.contents.children[e+1],h=this.frame.contents.children[e+2],s=this.list.at(o),n.contents!==s&&(n.contents=s,n.drawNew(),this.lastCell&&n.setLeft(this.lastCell.left())),this.lastCell=n,a.text!==o.toString()&&(a.text=o.toString(),a.drawNew()),h.action=o;for(r=3*(l-this.start+1);this.frame.contents.children.length>r;)this.frame.contents.children[r].destroy();if(i=r,e=this.frame.contents.children.length,p=Date.now(),i>e+1)for(e;e<i;e+=3){if(Date.now()-p>1e3)return this.fixLayout(),this.frame.contents.adjustBounds(),this.frame.contents.setLeft(this.frame.left()),null;o=this.start+e/3,a=new StringMorph(o.toString(),SyntaxElementMorph.prototype.fontSize,null,!1,!1,!1,MorphicPreferences.isFlat?new Point:new Point(1,1),new Color(255,255,255)),n=new CellMorph(this.list.at(o),this.cellColor,o,this.parentCell),(h=new PushButtonMorph(this.list.remove,o,"-",this.list)).padding=1,h.edge=0,h.corner=1,h.outlineColor=this.color.darker(),h.drawNew(),h.fixLayout(),this.frame.contents.add(n),this.lastCell?n.setPosition(this.lastCell.bottomLeft()):n.setTop(this.frame.contents.top()),this.lastCell=n,a.setCenter(n.center()),a.setRight(n.left()-2),this.frame.contents.add(a),this.frame.contents.add(h)}this.lastCell=null,this.fixLayout(),this.frame.contents.adjustBounds(),this.frame.contents.setLeft(this.frame.left()),this.updateLength(),this.lastUpdated=this.list.lastChanged},ListWatcherMorph.prototype.updateLength=function(t){this.label.text=localize("length: ")+this.list.length(),this.label.color=t?new Color(0,0,100):new Color(0,0,0),this.label.drawNew(),this.label.setCenter(this.center()),this.label.setBottom(this.bottom()-3)},ListWatcherMorph.prototype.startIndexMenu=function(){var t,e,o=this,i=Math.ceil(this.list.length()/this.range),r=new MenuMorph(function(t){o.setStartIndex(t)},null,o);for(r.addItem("1...",1),t=1;t<i;t+=1)e=100*t+1,r.addItem(e+"...",e);r.popUpAtHand(this.world())},ListWatcherMorph.prototype.setStartIndex=function(t){this.start=t,this.list.changed()},ListWatcherMorph.prototype.fixLayout=function(){this.label&&(Morph.prototype.trackChanges=!1,this.frame&&(this.arrangeCells(),this.frame.silentSetPosition(this.position().add(3)),this.frame.bounds.corner=this.bounds.corner.subtract(new Point(3,17)),this.frame.drawNew(),this.frame.contents.adjustBounds()),this.label.setCenter(this.center()),this.label.setBottom(this.bottom()-3),this.plusButton.setLeft(this.left()+3),this.plusButton.setBottom(this.bottom()-3),Morph.prototype.trackChanges=!0,this.changed(),this.parent&&this.parent.fixLayout&&this.parent.fixLayout())},ListWatcherMorph.prototype.arrangeCells=function(){var t,e,o,i,r,n=this.frame.contents.children.length;for(t=0;t<n;t+=3)e=this.frame.contents.children[t],o=this.frame.contents.children[t+1],i=this.frame.contents.children[t+2],r&&e.setTop(r.bottom()),o&&(o.setTop(e.center().y-o.height()/2),o.setRight(e.left()-2)),i&&(i.setCenter(e.center()),i.setLeft(e.right()+2)),r=e;this.frame.contents.adjustBounds()},ListWatcherMorph.prototype.expand=function(t){var e=this.frame.contents.extent(),o=new Point(e.x+6,e.y+this.label.height()+6);t&&(o=o.min(t)),this.setExtent(o),this.handle.setRight(this.right()-3),this.handle.setBottom(this.bottom()-3)},ListWatcherMorph.prototype.userMenu=function(){if(!List.prototype.enableTables)return this.escalateEvent("userMenu");var t=new MenuMorph(this),e=this;return t.addItem("table view...","showTableView"),t.addLine(),t.addItem("open in dialog...",function(){new TableDialogMorph(e.list).popUp(e.world())}),t},ListWatcherMorph.prototype.showTableView=function(){var t=this.parentThatIsAnyOf([SpriteBubbleMorph,SpeechBubbleMorph,CellMorph]);t&&(t instanceof SpriteBubbleMorph?(t.changed(),t.drawNew(!0)):t instanceof SpeechBubbleMorph?(t.contents=new TableFrameMorph(new TableMorph(this.list,10)),t.contents.expand(this.extent()),t.drawNew(!0)):(t.drawNew(!0,"table"),t.contentsMorph.expand(this.extent())),t.fixLayout())},ListWatcherMorph.prototype.mouseDoubleClick=function(t){List.prototype.enableTables?new TableDialogMorph(this.list).popUp(this.world()):this.escalateEvent("mouseDoubleClick",t)},ListWatcherMorph.prototype.show=function(){ListWatcherMorph.uber.show.call(this),this.frame.contents.adjustBounds()},ListWatcherMorph.prototype.drawNew=function(){WatcherMorph.prototype.drawNew.call(this),this.fixLayout()},modules.byob="2017-December-01";var CustomBlockDefinition,CustomCommandBlockMorph,CustomReporterBlockMorph,BlockDialogMorph,BlockEditorMorph,PrototypeHatBlockMorph,BlockLabelFragment,BlockLabelFragmentMorph,BlockInputFragmentMorph,BlockLabelPlaceHolderMorph,InputSlotDialogMorph,VariableDialogMorph,JaggedBlockMorph,BlockExportDialogMorph,BlockImportDialogMorph,BlockRemovalDialogMorph;CustomBlockDefinition.prototype.blockInstance=function(){var t;return t="command"===this.type?new CustomCommandBlockMorph(this):new CustomReporterBlockMorph(this,"predicate"===this.type),t.isDraggable=!0,t},CustomBlockDefinition.prototype.templateInstance=function(){var t;return(t=this.blockInstance()).refreshDefaults(this),t.isDraggable=!1,t.isTemplate=!0,t},CustomBlockDefinition.prototype.prototypeInstance=function(){var t,e,o=this;return(t="command"===this.type?new CustomCommandBlockMorph(this,!0):new CustomReporterBlockMorph(this,"predicate"===this.type,!0)).parts().forEach(function(t){t instanceof BlockInputFragmentMorph&&(e=o.declarations[t.fragment.labelString])&&(t.fragment.type=e[0],t.fragment.defaultValue=e[1],t.fragment.options=e[2],t.fragment.isReadOnly=e[3]||!1)}),t},CustomBlockDefinition.prototype.copyAndBindTo=function(t,e){var o=copy(this);return delete o[XML_Serializer.prototype.idProperty],o.receiver=t,o.declarations=copy(this.declarations),e?(o.body=null,o):(o.body&&(o.body=Process.prototype.reify.call(null,this.body.expression,new List(this.inputNames())),o.body.outerContext=null),o)},CustomBlockDefinition.prototype.blockSpec=function(){var t,e=this,o=[];return this.parseSpec(this.spec).forEach(function(i){t="%"===i[0]&&i.length>1?e.typeOf(i.slice(1)):"$nl"===i?"%br":i,o.push(t),o.push(" ")}),"".concat.apply("",o).trim()},CustomBlockDefinition.prototype.helpSpec=function(){var t=[];return this.parseSpec(this.spec).forEach(function(e){"%"!==e[0]&&t.push(e)}),"".concat.apply("",t).replace(/\?/g,"")},CustomBlockDefinition.prototype.typeOf=function(t){return this.declarations[t]?this.declarations[t][0]:"%s"},CustomBlockDefinition.prototype.defaultValueOf=function(t){return this.declarations[t]?this.declarations[t][1]:""},CustomBlockDefinition.prototype.defaultValueOfInputIdx=function(t){var e=this.inputNames()[t];return this.defaultValueOf(e)},CustomBlockDefinition.prototype.dropDownMenuOfInputIdx=function(t){var e=this.inputNames()[t];return this.dropDownMenuOf(e)},CustomBlockDefinition.prototype.isReadOnlyInputIdx=function(t){var e=this.inputNames()[t];return this.isReadOnlyInput(e)},CustomBlockDefinition.prototype.inputOptionsOfIdx=function(t){var e=this.inputNames()[t];return this.inputOptionsOf(e)},CustomBlockDefinition.prototype.dropDownMenuOf=function(t){return this.declarations[t]&&this.declarations[t][2]?this.parseChoices(this.declarations[t][2]):null},CustomBlockDefinition.prototype.parseChoices=function(t){var e={},o=[e];return t.split("\n").forEach(function(t){var i=t.split("=");"}"===i[0]?(o.pop(),e=o[o.length-1]):"{"===i[1]?(e={},o[o.length-1][i[0]]=e,o.push(e)):e[i[0]]=isNil(i[1])?i[0]:i[1]}),e},CustomBlockDefinition.prototype.isReadOnlyInput=function(t){return this.declarations[t]&&!0===this.declarations[t][3]},CustomBlockDefinition.prototype.inputOptionsOf=function(t){return[this.dropDownMenuOf(t),this.isReadOnlyInput(t)]},CustomBlockDefinition.prototype.inputNames=function(){var t=[];return this.parseSpec(this.spec).forEach(function(e){"%"===e[0]&&e.length>1&&t.push(e.slice(1))}),t},CustomBlockDefinition.prototype.parseSpec=function(t){var e,o,i=[],r="",n=!1;for(e=0;e<t.length;e+=1)"'"===(o=t[e])?n=!n:" "!==o||n?r=r.concat(o):(i.push(r),r="");return i.push(r),i},CustomBlockDefinition.prototype.isDirectlyRecursive=function(){var t;return null!==this.cachedIsRecursive?this.cachedIsRecursive:(this.body?(t=this.blockSpec(),this.cachedIsRecursive=this.body.expression.anyChild(function(e){return e.isCustomBlock&&e.blockSpec===t})):this.cachedIsRecursive=!1,this.cachedIsRecursive)},CustomBlockDefinition.prototype.localizedSpec=function(){function t(t){return t.length>1&&"%"===t[0]}if(this.cachedTranslation)return this.cachedTranslation;var e,o,i=this.translations[SnapTranslator.language],r=this.blockSpec(),n=-1;return isNil(i)?r:(o=BlockMorph.prototype.parseSpec(r).filter(function(e){return t(e)}),e=BlockMorph.prototype.parseSpec(i),e.some(function(e){return t(e)})||e.filter(function(t){return"_"===t}).length!==o.length?this.cachedTranslation=r:(e=e.map(function(t){return"_"===t?(n+=1,o[n]):t}),this.cachedTranslation=e.join(" ")),this.cachedTranslation)},CustomBlockDefinition.prototype.abstractBlockSpec=function(){return BlockMorph.prototype.parseSpec(this.blockSpec()).map(function(t){return t.length>1&&"%"===t[0]?"_":t}).join(" ")},CustomBlockDefinition.prototype.translationsAsText=function(){var t=this,e="";return Object.keys(this.translations).forEach(function(o){e+=o+":"+t.translations[o]+"\n"}),e},CustomBlockDefinition.prototype.updateTranslations=function(t){var e=this,o=t.split("\n").filter(function(t){return t.length});this.translations={},o.forEach(function(t){var o=t.indexOf(":"),i=t.slice(0,o).trim(),r=t.slice(o+1).trim();o&&(e.translations[i]=r)})},CustomBlockDefinition.prototype.scriptsPicture=function(){return this.scriptsModel().scriptsPicture()},CustomBlockDefinition.prototype.sortedElements=function(){return this.scriptsModel().sortedElements()},CustomBlockDefinition.prototype.scriptsModel=function(){var t,e,o,i,r;return t=new ScriptsMorph,t.cleanUpMargin=10,(e=new PrototypeHatBlockMorph(this)).setPosition(t.position().add(10)),null!==this.comment&&(i=this.comment.fullCopy(),e.comment=i,i.block=e),null!==this.body&&e.nextBlock(this.body.expression.fullCopy()),t.add(e),e.fixBlockColor(null,!0),this.scripts.forEach(function(e){(o=e.fullCopy()).setPosition(t.position().add(e.position())),t.add(o),o instanceof BlockMorph&&o.allComments().forEach(function(t){t.align(o)})}),e.allComments().forEach(function(t){t.align(e)}),(r=e.parts()[0]).fixLayout(),r.forceNormalColoring(),r.fixBlockColor(e,!0),t.fixMultiArgs(),t},CustomBlockDefinition.prototype.purgeCorpses=function(){this.body&&this.body.expression.isCorpse&&(this.body=null),this.scripts=this.scripts.filter(function(t){return!t.isCorpse})},CustomCommandBlockMorph.prototype=new CommandBlockMorph,CustomCommandBlockMorph.prototype.constructor=CustomCommandBlockMorph,CustomCommandBlockMorph.uber=CommandBlockMorph.prototype,CustomCommandBlockMorph.prototype.isCustomBlock=!0,CustomCommandBlockMorph.prototype.init=function(t,e){this.definition=t,this.semanticSpec="",this.isGlobal=!!t&&t.isGlobal,this.isPrototype=e||!1,CustomCommandBlockMorph.uber.init.call(this,!0),this.category=t.category,this.selector="evaluateCustomBlock",this.variables=null,this.initializeVariables(),t&&this.refresh()},CustomCommandBlockMorph.prototype.initializeVariables=function(t){var e=this;this.variables=new VariableFrame,this.isGlobal&&this.definition.variableNames.forEach(function(o){var i=t?t[o]:null;e.variables.addVar(o,i instanceof Variable?i.value:null)})},CustomCommandBlockMorph.prototype.refresh=function(t,e){var o,i=t||this.definition,r=this.isPrototype?i.spec:i.localizedSpec();this.semanticSpec=i.blockSpec(),this.isGlobal||this.isPrototype||(this.definition=null),this.setCategory(i.category),this.blockSpec!==r?(o=this.inputs(),this.zebraContrast?this.fixBlockColor():this.forceNormalColoring(),this.setSpec(r,e,i),this.fixLabelColor(),this.restoreInputs(o)):this.inputs().forEach(function(t,e){t instanceof InputSlotMorph&&t.setChoices.apply(t,i.inputOptionsOfIdx(e))}),this.cachedInputs=null,this.inputs().forEach(function(t,e){t instanceof TemplateSlotMorph&&"↑"===t.contents()&&t.setContents(i.inputNames()[e])}),this.isGlobal&&this.initializeVariables(this.variables.vars),this.forceNormalColoring(),this.drawNew(),this.fixBlockColor(null,!0)},CustomCommandBlockMorph.prototype.restoreInputs=function(t){var e,o=0,i=this;this.isPrototype||(this.cachedInputs=null,this.inputs().forEach(function(r){(e=t[o])instanceof ReporterBlockMorph&&!(r instanceof TemplateSlotMorph)?i.silentReplaceInput(r,e.fullCopy()):e instanceof InputSlotMorph&&r instanceof InputSlotMorph?r.setContents(e.evaluate()):e instanceof TemplateSlotMorph&&r instanceof TemplateSlotMorph?r.setContents(e.evaluate()):e instanceof CSlotMorph&&r instanceof CSlotMorph&&r.nestedBlock(e.evaluate()),o+=1}),this.cachedInputs=null)},CustomCommandBlockMorph.prototype.refreshDefaults=function(t){var e=0,o=this;this.inputs().forEach(function(i){(i instanceof InputSlotMorph||i instanceof BooleanSlotMorph)&&i.setContents((t||o.definition).defaultValueOfInputIdx(e)),e+=1}),this.cachedInputs=null},CustomCommandBlockMorph.prototype.refreshPrototype=function(){var t,e,o,i,r=[],n=this,s=0;if(!this.isPrototype)return null;t=this.parentThatIsA(PrototypeHatBlockMorph),this.parts().forEach(function(t){t.fragment.isDeleted||(t.fragment.type?r.push(t.fragment):(o=n.definition.parseSpec(t.fragment.labelString)).forEach(function(e){(i=t.fragment.copy()).labelString=e,r.push(i)}))}),e=this.specFromFragments(),this instanceof CustomCommandBlockMorph&&("reporter"===t.type||"predicate"===t.type)?(n=new CustomReporterBlockMorph(this.definition,"predicate"===t.type,!0),t.silentReplaceInput(this,n)):this instanceof CustomReporterBlockMorph&&("command"===t.type?(n=new CustomCommandBlockMorph(this.definition,!0),t.silentReplaceInput(this,n)):(this.isPredicate="predicate"===t.type,this.drawNew())),n.setCategory(t.blockCategory||"other"),t.fixBlockColor(),n.setSpec(e),n.parts().forEach(function(t){t instanceof BlockLabelPlaceHolderMorph||(r[s]&&(t.fragment=r[s]),s+=1)}),this.refreshPrototypeSlotTypes(),t.fixLayout()},CustomCommandBlockMorph.prototype.refreshPrototypeSlotTypes=function(){this.parts().forEach(function(t){t instanceof BlockInputFragmentMorph&&(t.template().instantiationSpec=t.contents(),t.setContents(t.fragment.defTemplateSpecFragment()))}),this.fixBlockColor(null,!0)},CustomCommandBlockMorph.prototype.inputFragmentNames=function(){var t=[];return this.parts().forEach(function(e){!e.fragment.isDeleted&&e.fragment.type&&t.push(e.fragment.labelString)}),t},CustomCommandBlockMorph.prototype.upvarFragmentNames=function(){var t=[];return this.parts().forEach(function(e){e.fragment.isDeleted||"%upvar"!==e.fragment.type||t.push(e.fragment.labelString)}),t},CustomCommandBlockMorph.prototype.upvarFragmentName=function(t){return this.upvarFragmentNames()[t]||"↑"},CustomCommandBlockMorph.prototype.specFromFragments=function(){var t="";return this.parts().forEach(function(e){e.fragment.isDeleted||(t=t+e.fragment.defSpecFragment()+" ")}),t.trim()},CustomCommandBlockMorph.prototype.blockSpecFromFragments=function(){var t="";return this.parts().forEach(function(e){e.fragment.isDeleted||(t=t+e.fragment.blockSpecFragment()+" ")}),t.trim()},CustomCommandBlockMorph.prototype.declarationsFromFragments=function(){var t={};return this.parts().forEach(function(e){e instanceof BlockInputFragmentMorph&&(t[e.fragment.labelString]=[e.fragment.type,e.fragment.defaultValue,e.fragment.options,e.fragment.isReadOnly])}),t},CustomCommandBlockMorph.prototype.parseSpec=function(t){return this.isPrototype?CustomBlockDefinition.prototype.parseSpec(t):CustomCommandBlockMorph.uber.parseSpec.call(this,t)},CustomCommandBlockMorph.prototype.mouseClickLeft=function(){if(!this.isPrototype)return CustomCommandBlockMorph.uber.mouseClickLeft.call(this);this.edit()},CustomCommandBlockMorph.prototype.edit=function(){var t,e,o,i,r=this,n=this.definition;if(this.isPrototype)(e=this.definition.blockInstance()).addShadow(),o=this.parentThatIsA(PrototypeHatBlockMorph),new BlockDialogMorph(null,function(t){t&&(o.blockCategory=t.category,o.type=t.type,r.refreshPrototype())},r).openForChange("Change block",o.blockCategory,o.type,r.world(),e.fullImage(),r.isInUse());else{if(i=this.scriptTarget(),!this.isGlobal){if(contains(Object.keys(i.inheritedBlocks()),this.blockSpec))return void this.duplicateBlockDefinition();n=i.getMethod(this.semanticSpec)}Morph.prototype.trackChanges=!1,(t=new BlockEditorMorph(n,i)).popUp(),Morph.prototype.trackChanges=!0,t.changed()}},CustomCommandBlockMorph.prototype.labelPart=function(t){var e;return this.isPrototype?("%"===t[0]&&t.length>1?e=new BlockInputFragmentMorph(t.replace(/%/g,"")):((e=new BlockLabelFragmentMorph(t)).fontSize=this.fontSize,e.color=new Color(255,255,255),e.isBold=!0,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=this.embossing,e.drawNew()),e):CustomCommandBlockMorph.uber.labelPart.call(this,t)},CustomCommandBlockMorph.prototype.placeHolder=function(){var t;return t=new BlockLabelPlaceHolderMorph,t.fontSize=1.4*this.fontSize,t.color=new Color(45,45,45),t.drawNew(),t},CustomCommandBlockMorph.prototype.attachTargets=function(){return this.isPrototype?[]:CustomCommandBlockMorph.uber.attachTargets.call(this)},CustomCommandBlockMorph.prototype.isInUse=function(){var t=this.definition,e=this.scriptTarget(),o=e.parentThatIsA(IDE_Morph);return t.isGlobal&&o?o.sprites.asArray().concat([o.stage]).some(function(e,o){return e.usesBlockInstance(t,!1,o)}):e.allDependentInvocationsOf(this.blockSpec).length>0},CustomCommandBlockMorph.prototype.userMenu=function(){function t(t,e,i,r,n){o.addItem((i?"☑ ":"☐ ")+localize(t),e,i?r:n)}function e(t){var e=r.parentThatIsA(StageMorph),i=n.variables;o.addItem(t+"...",function(){var o,r=detect(e.children,function(e){return e instanceof WatcherMorph&&e.target===i&&e.getter===t});if(null!==r)return r.show(),void r.fixLayout();(r=new WatcherMorph(t+" "+localize("(temporary)"),SpriteMorph.prototype.blockColor.variables,i,t)).setPosition(e.position().add(10)),(o=e.watchers(r.left())).length>0&&r.setTop(o[o.length-1].bottom()),e.add(r),r.fixLayout()})}var o,i=this.parentThatIsA(PrototypeHatBlockMorph),r=this.scriptTarget(),n=this,s=16===this.world().currentKey;return this.isPrototype?((o=new MenuMorph(this)).addItem("script pic...",function(){var t=this.world().children[0];t.saveCanvasAs(this.topBlock().scriptPic(),(t.projectName||localize("untitled"))+" "+localize("script pic"))},"open a new window\nwith a picture of this script"),o.addItem("translations...",function(){i.parentThatIsA(BlockEditorMorph).editTranslations()},"experimental -\nunder construction"),this.isGlobal&&(i.inputs().length<2?o.addItem("block variables...",function(){i.enableBlockVars()},"experimental -\nunder construction"):o.addItem("remove block variables...",function(){i.enableBlockVars(!1)},"experimental -\nunder construction"))):((o=this.constructor.uber.userMenu.call(this))?o.addLine():o=new MenuMorph(this),s&&o.addItem("duplicate block definition...","duplicateBlockDefinition",null,new Color(100,0,0)),this.isTemplate?this.isGlobal?o.addItem("delete block definition...","deleteBlockDefinition"):contains(Object.keys(r.inheritedBlocks()),this.blockSpec)?t("inherited",function(){var t=n.parentThatIsA(IDE_Morph);r.customBlocks.push(r.getMethod(n.blockSpec).copyAndBindTo(r)),t&&(t.flushPaletteCache(),t.refreshPalette())},!0,"uncheck to\ndisinherit",null):r.exemplar&&r.exemplar.getMethod(this.blockSpec)?t("inherited","deleteBlockDefinition",!1,null,localize("check to inherit\nfrom")+" "+r.exemplar.name):o.addItem("delete block definition...","deleteBlockDefinition"):(this.isGlobal||contains(Object.keys(r.ownBlocks()),this.blockSpec))&&o.addItem("delete block definition...","deleteBlockDefinition"),this.variables.names().forEach(function(t){e(t)})),o.addItem("edit...","edit"),o},CustomCommandBlockMorph.prototype.exportBlockDefinition=function(){var t=(new SnapSerializer).serialize(this.definition);this.parentThatIsA(IDE_Morph).saveXMLAs(t,this.spec)},CustomCommandBlockMorph.prototype.duplicateBlockDefinition=function(){var t=this.scriptTarget(),e=this.parentThatIsA(IDE_Morph),o=(this.isGlobal?this.definition:t.getMethod(this.blockSpec)).copyAndBindTo(t);this.isGlobal?e.stage.globalBlocks.push(o):t.customBlocks.push(o),e.flushPaletteCache(),e.refreshPalette(),new BlockEditorMorph(o,t).popUp()},CustomCommandBlockMorph.prototype.deleteBlockDefinition=function(){var t,e,o,i,r,n=this.scriptTarget(),s=this;if(this.isPrototype)return null;(r=(i=this.isGlobal?this.definition:n.getLocalMethod(this.blockSpec)).blockInstance()).addShadow(),new DialogBoxMorph(this,function(){n.deleteAllBlockInstances(i),i.isGlobal?(e=n.parentThatIsA(StageMorph),-1!==(t=e.globalBlocks.indexOf(i))&&e.globalBlocks.splice(t,1)):(-1!==(t=n.customBlocks.indexOf(i))&&n.customBlocks.splice(t,1),(i=n.getMethod(s.blockSpec))&&n.allDependentInvocationsOf(s.blockSpec).forEach(function(t){t.refresh(i)})),(o=n.parentThatIsA(IDE_Morph))&&(o.flushPaletteCache(),o.refreshPalette())},this).askYesNo("Delete Custom Block",localize("block deletion dialog text"),s.world(),r.fullImage())},CustomCommandBlockMorph.prototype.relabel=function(t){var e=new MenuMorph(this),o=this.inputs().map(function(t){return t.fullCopy()}),i=this;t.forEach(function(t){var r=t.blockInstance();r.restoreInputs(o),r.fixBlockColor(null,!0),r.addShadow(new Point(3,3)),e.addItem(r,function(){i.definition=t,i.refresh()})}),e.popup(this.world(),this.bottomLeft().subtract(new Point(8,this instanceof CommandBlockMorph?this.corner:0)))},CustomCommandBlockMorph.prototype.alternatives=function(){var t=this.scriptTarget(),e=t.parentThatIsA(StageMorph),o=t.customBlocks.concat(e.globalBlocks),i=this instanceof CommandBlockMorph?"command":this.isPredicate?"predicate":"reporter",r=this;return o.filter(function(t){return t!==r.definition&&t.type===i})},CustomReporterBlockMorph.prototype=new ReporterBlockMorph,CustomReporterBlockMorph.prototype.constructor=CustomReporterBlockMorph,CustomReporterBlockMorph.uber=ReporterBlockMorph.prototype,CustomReporterBlockMorph.prototype.isCustomBlock=!0,CustomReporterBlockMorph.prototype.init=function(t,e,o){this.definition=t,this.semanticSpec="",this.isGlobal=!!t&&t.isGlobal,this.isPrototype=o||!1,CustomReporterBlockMorph.uber.init.call(this,e,!0),this.category=t.category,this.variables=new VariableFrame,this.initializeVariables(),this.selector="evaluateCustomBlock",t&&this.refresh()},CustomReporterBlockMorph.prototype.initializeVariables=CustomCommandBlockMorph.prototype.initializeVariables,CustomReporterBlockMorph.prototype.refresh=function(t){var e=t||this.definition;CustomCommandBlockMorph.prototype.refresh.call(this,t,!0),this.isPrototype||(this.isPredicate="predicate"===e.type),this.parent instanceof SyntaxElementMorph&&(this.parent.cachedInputs=null),this.drawNew()},CustomReporterBlockMorph.prototype.mouseClickLeft=function(){if(!this.isPrototype)return CustomReporterBlockMorph.uber.mouseClickLeft.call(this);this.edit()},CustomReporterBlockMorph.prototype.placeHolder=CustomCommandBlockMorph.prototype.placeHolder,CustomReporterBlockMorph.prototype.parseSpec=CustomCommandBlockMorph.prototype.parseSpec,CustomReporterBlockMorph.prototype.edit=CustomCommandBlockMorph.prototype.edit,CustomReporterBlockMorph.prototype.labelPart=CustomCommandBlockMorph.prototype.labelPart,CustomReporterBlockMorph.prototype.upvarFragmentNames=CustomCommandBlockMorph.prototype.upvarFragmentNames,CustomReporterBlockMorph.prototype.upvarFragmentName=CustomCommandBlockMorph.prototype.upvarFragmentName,CustomReporterBlockMorph.prototype.inputFragmentNames=CustomCommandBlockMorph.prototype.inputFragmentNames,CustomReporterBlockMorph.prototype.specFromFragments=CustomCommandBlockMorph.prototype.specFromFragments,CustomReporterBlockMorph.prototype.blockSpecFromFragments=CustomCommandBlockMorph.prototype.blockSpecFromFragments,CustomReporterBlockMorph.prototype.declarationsFromFragments=CustomCommandBlockMorph.prototype.declarationsFromFragments,CustomReporterBlockMorph.prototype.refreshPrototype=CustomCommandBlockMorph.prototype.refreshPrototype,CustomReporterBlockMorph.prototype.refreshPrototypeSlotTypes=CustomCommandBlockMorph.prototype.refreshPrototypeSlotTypes,CustomReporterBlockMorph.prototype.restoreInputs=CustomCommandBlockMorph.prototype.restoreInputs,CustomReporterBlockMorph.prototype.refreshDefaults=CustomCommandBlockMorph.prototype.refreshDefaults,CustomReporterBlockMorph.prototype.isInUse=CustomCommandBlockMorph.prototype.isInUse,CustomReporterBlockMorph.prototype.userMenu=CustomCommandBlockMorph.prototype.userMenu,CustomReporterBlockMorph.prototype.duplicateBlockDefinition=CustomCommandBlockMorph.prototype.duplicateBlockDefinition,CustomReporterBlockMorph.prototype.deleteBlockDefinition=CustomCommandBlockMorph.prototype.deleteBlockDefinition,CustomReporterBlockMorph.prototype.bubbleHelp=CustomCommandBlockMorph.prototype.bubbleHelp,CustomReporterBlockMorph.prototype.popUpbubbleHelp=CustomCommandBlockMorph.prototype.popUpbubbleHelp,CustomReporterBlockMorph.prototype.relabel=CustomCommandBlockMorph.prototype.relabel,CustomReporterBlockMorph.prototype.alternatives=CustomCommandBlockMorph.prototype.alternatives,JaggedBlockMorph.prototype=new ReporterBlockMorph,JaggedBlockMorph.prototype.constructor=JaggedBlockMorph,JaggedBlockMorph.uber=ReporterBlockMorph.prototype,JaggedBlockMorph.prototype.jag=5,JaggedBlockMorph.prototype.init=function(t){JaggedBlockMorph.uber.init.call(this),t&&this.setSpec(t),"%cs"===t&&(this.minWidth=25,this.fixLayout())},JaggedBlockMorph.prototype.drawNew=function(){var t;this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),(t=this.image.getContext("2d")).fillStyle=this.cachedClr,this.drawBackground(t),MorphicPreferences.isFlat||this.drawEdges(t),this.eraseHoles(t)},JaggedBlockMorph.prototype.drawBackground=function(t){var e,o,i=this.width(),r=this.height(),n=Math.round(r/this.jag),s=r/n;for(t.fillStyle=this.cachedClr,t.beginPath(),t.moveTo(0,0),t.lineTo(i,0),o=0,e=0;e<n;e+=1)o+=s/2,t.lineTo(i-this.jag/2,o),o+=s/2,t.lineTo(i,o);for(t.lineTo(0,r),o=r,e=0;e<n;e+=1)o-=s/2,t.lineTo(this.jag/2,o),o-=s/2,t.lineTo(0,o);t.closePath(),t.fill()},JaggedBlockMorph.prototype.drawEdges=function(t){var e,o,i,r=this.width(),n=this.height(),s=Math.round(n/this.jag),a=n/s,h=this.edge/2;for(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",(e=t.createLinearGradient(0,0,0,this.edge)).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(h,h),t.lineTo(r-h,h),t.stroke(),i=0,o=0;o<s;o+=1)t.strokeStyle=this.cachedClrDark,t.beginPath(),t.moveTo(r-h,i),i+=a/2,t.lineTo(r-this.jag/2-h,i),t.stroke(),i+=a/2;for((e=t.createLinearGradient(0,n-this.edge,0,n)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(r-h,n-h),t.lineTo(h,n-h),t.stroke(),i=n,o=0;o<s;o+=1)t.strokeStyle=this.cachedClrBright,t.beginPath(),t.moveTo(h,i),i-=a/2,t.lineTo(this.jag/2+h,i),t.stroke(),i-=a/2},BlockDialogMorph.prototype=new DialogBoxMorph,BlockDialogMorph.prototype.constructor=BlockDialogMorph,BlockDialogMorph.uber=DialogBoxMorph.prototype,BlockDialogMorph.prototype.init=function(t,e,o){this.blockType="command",this.category="other",this.isGlobal=!0,this.types=null,this.categories=null,BlockDialogMorph.uber.init.call(this,t,e,o),this.key="makeABlock",this.types=new AlignmentMorph("row",this.padding),this.add(this.types),this.scopes=new AlignmentMorph("row",this.padding),this.add(this.scopes),this.categories=new BoxMorph,this.categories.color=SpriteMorph.prototype.paletteColor.lighter(8),this.categories.borderColor=this.categories.color.lighter(40),this.createCategoryButtons(),this.fixCategoriesLayout(),this.add(this.categories),this.createTypeButtons(),this.creatpanel_LefteButtons(),this.fixLayout()},BlockDialogMorph.prototype.openForChange=function(t,e,o,i,r,n){var s=SpriteMorph.prototype.blockColor[e];this.key="changeABlock",this.category=e,this.blockType=o,this.categories.children.forEach(function(t){t.refresh()}),this.types.children.forEach(function(t){t.setColor(s),t.refresh()}),this.labelString=t,this.createLabel(),r&&this.setPicture(r),this.addButton("ok","OK"),this.addButton("cancel","Cancel"),n&&(this.types.destroy(),this.types=null),this.scopes.destroy(),this.scopes=null,this.fixLayout(),this.drawNew(),this.popUp(i)},BlockDialogMorph.prototype.createCategoryButtons=function(){var t=this,e=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,SpriteMorph.prototype.categories.forEach(function(e){t.addCategoryButton(e)}),Morph.prototype.trackChanges=e},BlockDialogMorph.prototype.addCategoryButton=function(t){var e,o=this,i=[SpriteMorph.prototype.paletteColor,SpriteMorph.prototype.paletteColor.darker(50),SpriteMorph.prototype.blockColor[t]];return e=new ToggleButtonMorph(i,this,function(){o.category=t,o.categories.children.forEach(function(t){t.refresh()}),o.types&&o.types.children.forEach(function(t){t.setColor(i[2])}),o.edit()},t[0].toUpperCase().concat(t.slice(1)),function(){return o.category===t},null,null,null,75,!0),e.corner=8,e.padding=0,e.labelShadowOffset=new Point(-1,-1),e.labelShadowColor=i[1],e.labelColor=IDE_Morph.prototype.buttonLabelColor,e.contrast=this.buttonContrast,e.fixLayout(),e.refresh(),this.categories.add(e),e},BlockDialogMorph.prototype.fixCategoriesLayout=function(){var t,e,o=this.categories.children[0].width(),i=this.categories.children[0].height(),r=Math.ceil(this.categories.children.length/2),n=this.categories.left(),s=this.categories.top(),a=0,h=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,this.categories.children.forEach(function(r){a+=1,t=Math.ceil(a/2),e=2-a%2,r.setPosition(new Point(n+(15*e+(e-1)*o),s+(2*t+(t-1)*i+10)))}),MorphicPreferences.isFlat&&(this.categories.corner=0,this.categories.border=0,this.categories.edge=0),this.categories.setExtent(new Point(45+2*o,2*(r+1)+r*i+20)),Morph.prototype.trackChanges=h,this.categories.changed()},BlockDialogMorph.prototype.createTypeButtons=function(){var t,e=this,o=SpriteMorph.prototype.blockColor[this.category];(t=new CommandBlockMorph).setColor(o),t.setSpec(localize("Command")),this.addBlockTypeButton(function(){e.setType("command")},t,function(){return"command"===e.blockType}),(t=new ReporterBlockMorph).setColor(o),t.setSpec(localize("Reporter")),this.addBlockTypeButton(function(){e.setType("reporter")},t,function(){return"reporter"===e.blockType}),(t=new ReporterBlockMorph(!0)).setColor(o),t.setSpec(localize("Predicate")),this.addBlockTypeButton(function(){e.setType("predicate")},t,function(){return"predicate"===e.blockType})},BlockDialogMorph.prototype.addBlockTypeButton=function(t,e,o){var i=new ToggleElementMorph(this,t,e,o,null,null,"rebuild");return i.refresh(),this.types.add(i),i},BlockDialogMorph.prototype.addTypeButton=function(t,e,o){var i=new ToggleMorph("radiobutton",this,t,e,o);return i.edge=this.buttonEdge/2,i.outline=this.buttonOutline/2,i.outlineColor=this.buttonOutlineColor,i.outlineGradient=this.buttonOutlineGradient,i.contrast=this.buttonContrast,i.drawNew(),i.fixLayout(),this.types.add(i),i},BlockDialogMorph.prototype.setType=function(t){this.blockType=t||this.blockType,this.types.children.forEach(function(t){t.refresh()}),this.edit()},BlockDialogMorph.prototype.creatpanel_LefteButtons=function(){var t=this;this.addScopeButton(function(){t.setScope("global")},"for all sprites",function(){return t.isGlobal}),this.addScopeButton(function(){t.setScope("local")},"for this sprite only",function(){return!t.isGlobal})},BlockDialogMorph.prototype.addScopeButton=function(t,e,o){var i=new ToggleMorph("radiobutton",this,t,e,o);return i.edge=this.buttonEdge/2,i.outline=this.buttonOutline/2,i.outlineColor=this.buttonOutlineColor,i.outlineGradient=this.buttonOutlineGradient,i.contrast=this.buttonContrast,i.drawNew(),i.fixLayout(),this.scopes.add(i),i},BlockDialogMorph.prototype.setScope=function(t){this.isGlobal="global"===t,this.scopes.children.forEach(function(t){t.refresh()}),this.edit()},BlockDialogMorph.prototype.getInput=function(){var t,e,o;return this.body instanceof InputFieldMorph&&(t=this.normalizeSpaces(this.body.getValue())),e=new CustomBlockDefinition(t),e.type=this.blockType,e.category=this.category,e.isGlobal=this.isGlobal,"reporter"!==e.type&&"predicate"!==e.type||((o=Process.prototype.reify.call(null,SpriteMorph.prototype.blockForSelector("doReport"),new List,!0)).outerContext=null,e.body=o),e},BlockDialogMorph.prototype.fixLayout=function(){var t=fontHeight(this.titleFontSize)+2*this.titlePadding;this.body?(this.body.setPosition(this.position().add(new Point(this.padding,t+this.padding))),this.silentSetWidth(this.body.width()+2*this.padding),this.silentSetHeight(this.body.height()+2*this.padding+t),this.categories&&(this.categories.setCenter(this.body.center()),this.categories.setTop(this.body.top()),this.body.setTop(this.categories.bottom()+this.padding),this.silentSetHeight(this.height()+this.categories.height()+this.padding))):this.head&&(this.types?(this.types.fixLayout(),this.silentSetWidth(Math.max(this.types.width(),this.head.width())+2*this.padding)):this.silentSetWidth(Math.max(this.categories.width(),this.head.width())+2*this.padding),this.head.setCenter(this.center()),this.head.setTop(t+this.padding),this.silentSetHeight(this.head.height()+2*this.padding+t),this.categories&&(this.categories.setCenter(this.center()),this.categories.setTop(this.head.bottom()+this.padding),this.silentSetHeight(this.height()+this.categories.height()+this.padding))),this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(t-this.label.height())/2)),this.types&&(this.types.fixLayout(),this.silentSetHeight(this.height()+this.types.height()+this.padding),this.silentSetWidth(Math.max(this.width(),this.types.width()+2*this.padding)),this.types.setCenter(this.center()),this.body?this.types.setTop(this.body.bottom()+this.padding):this.categories&&this.types.setTop(this.categories.bottom()+this.padding)),this.scopes&&(this.scopes.fixLayout(),this.silentSetHeight(this.height()+this.scopes.height()+this.padding/3),this.silentSetWidth(Math.max(this.width(),this.scopes.width()+2*this.padding)),this.scopes.setCenter(this.center()),this.types&&this.scopes.setTop(this.types.bottom()+this.padding/3)),this.buttons&&this.buttons.children.length>0&&(this.buttons.fixLayout(),this.silentSetHeight(this.height()+this.buttons.height()+this.padding),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding))},BlockDialogMorph.prototype.accept=function(){this.body instanceof InputFieldMorph&&""===this.normalizeSpaces(this.body.getValue())?this.edit():BlockDialogMorph.uber.accept.call(this)},BlockEditorMorph.prototype=new DialogBoxMorph,BlockEditorMorph.prototype.constructor=BlockEditorMorph,BlockEditorMorph.uber=DialogBoxMorph.prototype,BlockEditorMorph.prototype.init=function(t,e){var o,i,r,n,s,a=this,h=Process.prototype.enableLiveCoding||Process.prototype.enableSingleStepping;this.definition=t,this.translations=t.translationsAsText(),this.handle=null,BlockEditorMorph.uber.init.call(this,e,function(){a.updateDefinition()},e),this.key="editBlock"+t.spec,this.labelString=this.definition.isGlobal?"Block Editor":"Method Editor",this.createLabel(),(o=new ScriptsMorph).rejectsHats=!0,o.isDraggable=!1,o.color=IDE_Morph.prototype.groupColor,o.cachedTexture=IDE_Morph.prototype.scriptsPaneTexture,o.cleanUpMargin=10,(i=new PrototypeHatBlockMorph(this.definition)).setPosition(o.position().add(10)),null!==t.comment&&(s=t.comment.fullCopy(),i.comment=s,s.block=i),null!==t.body&&i.nextBlock(h?t.body.expression:t.body.expression.fullCopy()),o.add(i),i.fixBlockColor(null,!0),i.drawNew(),this.definition.scripts.forEach(function(t){(n=t.fullCopy()).setPosition(o.position().add(t.position())),o.add(n),n instanceof BlockMorph&&n.allComments().forEach(function(t){t.align(n)})}),i.allComments().forEach(function(t){t.align(i)}),(r=new ScrollFrameMorph(o)).padding=10,r.growth=50,r.isDraggable=!1,r.acceptsDrops=!1,r.contents.acceptsDrops=!0,o.scrollFrame=r,o.updateToolbar(),this.addBody(r),this.addButton("ok","OK"),h||(this.addButton("updateDefinition","Apply"),this.addButton("cancel","Cancel")),this.setExtent(new Point(375,300)),this.fixLayout(),o.fixMultiArgs(),(n=i.parts()[0]).forceNormalColoring(),n.fixBlockColor(i,!0)},BlockEditorMorph.prototype.popUp=function(){var t=this.target.world();t&&(BlockEditorMorph.uber.popUp.call(this,t),this.setInitialDimensions(),this.handle=new HandleMorph(this,280,220,this.corner,this.corner),t.keyboardReceiver=null)},BlockEditorMorph.prototype.justDropped=function(){nop()},BlockEditorMorph.prototype.accept=function(t){t instanceof CursorMorph||(this.action&&("function"==typeof this.target?"function"==typeof this.action?this.target.call(this.environment,this.action.call()):this.target.call(this.environment,this.action):"function"==typeof this.action?this.action.call(this.target,this.getInput()):this.target[this.action](this.getInput())),this.close())},BlockEditorMorph.prototype.cancel=function(t){t instanceof CursorMorph||this.close()},BlockEditorMorph.prototype.close=function(){var t,e,o=this;return this.definition.isGlobal&&(e=detect(this.body.contents.allChildren(),function(t){return t.definition&&!t.definition.isGlobal}))?((e=e.definition.blockInstance()).addShadow(),void(new DialogBoxMorph).inform("Local Block(s) in Global Definition","This global block definition contains one or more\nlocal custom blocks which must be removed first.",o.world(),e.fullImage())):(t=this.target.doubleDefinitionsFor(this.definition)).length>0?((e=t[0].blockInstance()).addShadow(),void new DialogBoxMorph(this,"consolidateDoubles",this).askYesNo("Same Named Blocks","Another custom block with this name exists.\nWould you like to replace it?",o.world(),e.fullImage())):void this.destroy()},BlockEditorMorph.prototype.consolidateDoubles=function(){this.target.replaceDoubleDefinitionsFor(this.definition),this.destroy()},BlockEditorMorph.prototype.refreshAllBlockInstances=function(t){var e=this.definition,o=this.target.paletteBlockInstance(e);this.definition.isGlobal?this.target.allBlockInstances(this.definition).forEach(function(t){t.refresh()}):this.target.allDependentInvocationsOf(t).forEach(function(t){t.refresh(e)}),o&&o.refreshDefaults()},BlockEditorMorph.prototype.updateDefinition=function(){var t,e,o,i=this.definition.blockSpec(),r=this.body.contents.position(),n=this;this.definition.receiver=this.target,this.definition.spec=this.prototypeSpec(),this.definition.declarations=this.prototypeSlots(),this.definition.variableNames=this.variableNames(),this.definition.scripts=[],this.definition.updateTranslations(this.translations),this.definition.cachedTranslation=null,this.definition.editorDimensions=this.bounds.copy(),this.definition.cachedIsRecursive=null,this.body.contents.children.forEach(function(e){e instanceof PrototypeHatBlockMorph?t=e:(e instanceof BlockMorph||e instanceof CommentMorph&&!e.block)&&((o=e.fullCopy()).parent=null,o.setPosition(e.position().subtract(r)),n.definition.scripts.push(o))}),t&&(this.definition.category!==t.blockCategory&&this.target.shadowAttribute("scripts"),this.definition.category=t.blockCategory,this.definition.type=t.type,t.comment?(this.definition.comment=t.comment.fullCopy(),this.definition.comment.block=!0):this.definition.comment=null),this.definition.body=this.context(t),this.refreshAllBlockInstances(i),(e=this.target.parentThatIsA(IDE_Morph)).flushPaletteCache(),e.refreshPalette()},BlockEditorMorph.prototype.context=function(t){var e,o,i;return e=t||detect(this.body.contents.children,function(t){return t instanceof PrototypeHatBlockMorph}),null===(o=e.nextBlock())?null:(o.allChildren().forEach(function(t){t instanceof BlockMorph&&(t.cachedInputs=null)}),i=Process.prototype.reify.call(null,o,new List(this.definition.inputNames()),!0),i.outerContext=null,i)},BlockEditorMorph.prototype.prototypeSpec=function(){return detect(this.body.contents.children,function(t){return t instanceof PrototypeHatBlockMorph}).parts()[0].specFromFragments()},BlockEditorMorph.prototype.prototypeSlots=function(){return detect(this.body.contents.children,function(t){return t instanceof PrototypeHatBlockMorph}).parts()[0].declarationsFromFragments()},BlockEditorMorph.prototype.variableNames=function(){return detect(this.body.contents.children,function(t){return t instanceof PrototypeHatBlockMorph}).variableNames()},BlockEditorMorph.prototype.editTranslations=function(){var t=this,e=this.definition.blockInstance();e.addShadow(new Point(3,3)),new DialogBoxMorph(t,function(e){t.translations=e},t).promptCode("Custom Block Translations",t.translations,t.world(),e.fullImage(),t.definition.abstractBlockSpec()+"\n\n"+localize('Enter one translation per line. use colon (":") as lang/spec delimiter\nand underscore ("_") as placeholder for an input, e.g.:\n\nen:say _ for _ secs'))},BlockEditorMorph.prototype.setInitialDimensions=function(){var t=this.world(),e=t.extent().subtract(new Point(this.padding,this.padding)),o=fontHeight(this.titleFontSize)+2*this.titlePadding,i=this.buttons.height();if(this.definition.editorDimensions)return this.setPosition(this.definition.editorDimensions.origin),this.setExtent(this.definition.editorDimensions.extent().min(e)),void this.keepWithin(t);this.setExtent(this.body.contents.extent().add(new Point(this.padding,this.padding+o+i)).min(e)),this.setCenter(this.world().center())},BlockEditorMorph.prototype.fixLayout=function(){var t=fontHeight(this.titleFontSize)+2*this.titlePadding;this.buttons&&this.buttons.children.length>0&&this.buttons.fixLayout(),this.body&&(this.body.setPosition(this.position().add(new Point(this.padding,t+this.padding))),this.body.setExtent(new Point(this.width()-2*this.padding,this.height()-3*this.padding-t-this.buttons.height()))),this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(t-this.label.height())/2)),this.buttons&&this.buttons.children.length>0&&(this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding))},PrototypeHatBlockMorph.prototype=new HatBlockMorph,PrototypeHatBlockMorph.prototype.constructor=PrototypeHatBlockMorph,PrototypeHatBlockMorph.uber=HatBlockMorph.prototype,PrototypeHatBlockMorph.prototype.init=function(t){var e,o=t.prototypeInstance();this.definition=t,this.blockCategory=t?t.category:null,this.type=t?t.type:null,HatBlockMorph.uber.init.call(this),this.color=SpriteMorph.prototype.blockColor.control,this.category="control",this.add(o),t.variableNames.length&&(e=this.labelPart("%blockVars"),this.add(this.labelPart("%br")),this.add(e),t.variableNames.forEach(function(t){e.addInput(t)})),o.refreshPrototypeSlotTypes(),this.fixLayout(),o.fixBlockColor(this,!0)},PrototypeHatBlockMorph.prototype.mouseClickLeft=function(){if(16===this.world().currentKey)return this.focus();this.parts()[0].mouseClickLeft()},PrototypeHatBlockMorph.prototype.userMenu=function(){return this.parts()[0].userMenu()},PrototypeHatBlockMorph.prototype.fixBlockColor=function(t,e){var o=this.parts()[0]||t;if(this.zebraContrast||e){if(!this.zebraContrast&&e)return this.forceNormalColoring();o.category===this.category?o.color.eq(this.color)&&this.alternateBlockColor():this.category&&!this.color.eq(SpriteMorph.prototype.blockColor[this.category])&&this.alternateBlockColor(),e&&this.fixChildrensBlockColor(!0)}},PrototypeHatBlockMorph.prototype.variableNames=function(t){var e=this.parts();return e.length<3?[]:e[2].evaluate()},PrototypeHatBlockMorph.prototype.enableBlockVars=function(t){var e=this.parts()[0];!1===t?this.setSpec("%s",!0):this.setSpec("%s %br %blockVars",!0),this.replaceInput(this.parts()[0],e),this.spec=null},BlockLabelFragment.prototype.defSpecFragment=function(){var t=this.type?"%'":"";return this.isDeleted?"":t+this.labelString+(this.type?"'":"")},BlockLabelFragment.prototype.defTemplateSpecFragment=function(){var t="";return this.type?(this.isUpvar()?t=" ↑":this.isMultipleInput()?t="...":"%cs"===this.type?t=" λ":"%b"===this.type?t=" ?":"%l"===this.type?t=" ︙":"%obj"===this.type?t=" %turtleOutline":contains(["%cmdRing","%repRing","%predRing","%anyUE","%boolUE"],this.type)?t=" λ":this.defaultValue?t="%n"===this.type?" # = "+this.defaultValue.toString():" = "+this.defaultValue.toString():"%n"===this.type&&(t=" #"),this.labelString+t):this.defSpecFragment()},BlockLabelFragment.prototype.blockSpecFragment=function(){return this.isDeleted?"":this.type||this.labelString},BlockLabelFragment.prototype.copy=function(){var t=new BlockLabelFragment(this.labelString);return t.type=this.type,t.defaultValue=this.defaultValue,t.options=this.options,t.isReadOnly=this.isReadOnly,t},BlockLabelFragment.prototype.isSingleInput=function(){return!this.isMultipleInput()&&"%upvar"!==this.type},BlockLabelFragment.prototype.isMultipleInput=function(){return!!this.type&&this.type.indexOf("%mult")>-1},BlockLabelFragment.prototype.isUpvar=function(){return!!this.type&&"%upvar"===this.type},BlockLabelFragment.prototype.setToSingleInput=function(){if(!this.type)return null;"%upvar"===this.type?this.type="%s":this.type=this.singleInputType()},BlockLabelFragment.prototype.setToMultipleInput=function(){if(!this.type)return null;"%upvar"===this.type&&(this.type="%s"),this.type="%mult".concat(this.singleInputType())},BlockLabelFragment.prototype.setToUpvar=function(){if(!this.type)return null;this.type="%upvar"},BlockLabelFragment.prototype.singleInputType=function(){return this.type?this.isMultipleInput()?this.type.substr(5):this.type:null},BlockLabelFragment.prototype.setSingleInputType=function(t){this.type&&this.isMultipleInput()?this.type="%mult".concat(t):this.type=t},BlockLabelFragmentMorph.prototype=new StringMorph,BlockLabelFragmentMorph.prototype.constructor=BlockLabelFragmentMorph,BlockLabelFragmentMorph.uber=StringMorph.prototype,BlockLabelFragmentMorph.prototype.init=function(t){this.fragment=new BlockLabelFragment(t),this.fragment.type=null,this.sO=null,BlockLabelFragmentMorph.uber.init.call(this,t,null,SyntaxElementMorph.prototype.labelFontStyle,null,null,null,null,null,null,SyntaxElementMorph.prototype.labelFontName)},BlockLabelFragmentMorph.prototype.mouseEnter=function(){this.sO=this.shadowOffset,this.shadowOffset=this.sO.neg(),this.drawNew(),this.changed()},BlockLabelFragmentMorph.prototype.mouseLeave=function(){this.shadowOffset=this.sO,this.drawNew(),this.changed()},BlockLabelFragmentMorph.prototype.mouseClickLeft=function(){var t=this.fragment.copy(),e=this,o=this instanceof BlockLabelPlaceHolderMorph,i=this.parent.parseSpec(this.parent.blockSpec).length<2;new InputSlotDialogMorph(t,null,function(){e.updateBlockLabel(t)},this,this.parent.definition.category).open(this instanceof BlockLabelFragmentMorph?"Edit label fragment":o?"Create input name":"Edit input name",t.labelString,this.world(),null,o||i)},BlockLabelFragmentMorph.prototype.updateBlockLabel=function(t){var e=this.parentThatIsA(BlockMorph);this.fragment=t,e&&e.refreshPrototype()},BlockLabelFragmentMorph.prototype.userMenu=function(){var t=this,e=new Color(100,100,130),o=new MenuMorph(function(e){var o=t.text.split("-");t.changed(),o[0]="$"+e,t.text=o.join("-"),t.fragment.labelString=t.text,t.parent.parent.changed(),t.drawNew(),t.changed(),t.parent.parent.fixLayout(),t.parent.parent.changed()},null,this,this.fontSize);return SymbolMorph.prototype.names.forEach(function(t){o.addItem([new SymbolMorph(t,o.fontSize,e),t],t)}),o.addLine(),o.addItem("⏎ "+localize("new line"),"nl"),o},BlockLabelPlaceHolderMorph.prototype=new StringMorph,BlockLabelPlaceHolderMorph.prototype.constructor=BlockLabelPlaceHolderMorph,BlockLabelPlaceHolderMorph.uber=StringMorph.prototype,BlockLabelPlaceHolderMorph.prototype.plainLabel=!1,BlockLabelPlaceHolderMorph.prototype.init=function(){this.fragment=new BlockLabelFragment(""),this.fragment.type="%s",this.fragment.isDeleted=!0,this.isHighlighted=!1,this.isProtectedLabel=!0,BlockLabelFragmentMorph.uber.init.call(this,"+")},BlockLabelPlaceHolderMorph.prototype.drawNew=function(){var t,e,o,i,r,n;this.plainLabel&&(this.text=this.isHighlighted?" + ":""),this.image=newCanvas(),(t=this.image.getContext("2d")).font=this.font(),e=Math.max(t.measureText(this.text).width+Math.abs(this.shadowOffset.x),1),this.bounds.corner=this.bounds.origin.add(new Point(e,fontHeight(this.fontSize)+Math.abs(this.shadowOffset.y))),this.image.width=e,this.image.height=this.height(),this.isHighlighted&&(r=Math.floor(e/2),n=Math.floor(this.height()/2),t.fillStyle=this.color.toString(),t.beginPath(),t.arc(r,1.2*n,Math.min(r,n),radians(0),radians(360),!1),t.closePath(),t.fill()),t.font=this.font(),t.textAlign="left",t.textBaseline="bottom",this.shadowColor&&(o=Math.max(this.shadowOffset.x,0),i=Math.max(this.shadowOffset.y,0),t.fillStyle=this.shadowColor.toString(),t.fillText(this.text,o,fontHeight(this.fontSize)+i)),o=Math.abs(Math.min(this.shadowOffset.x,0)),i=Math.abs(Math.min(this.shadowOffset.y,0)),t.fillStyle=this.isHighlighted?"white":this.color.toString(),t.fillText(this.text,o,fontHeight(this.fontSize)+i),this.parent&&(this.parent.fixLayout&&this.parent.fixLayout(),this.parent.parent instanceof PrototypeHatBlockMorph&&this.parent.parent.fixLayout())},BlockLabelPlaceHolderMorph.prototype.mouseEnter=function(){var t=this.parentThatIsA(PrototypeHatBlockMorph);this.isHighlighted=!0,this.plainLabel&&t?(t.changed(),this.drawNew(),t.changed()):(this.drawNew(),this.changed())},BlockLabelPlaceHolderMorph.prototype.mouseLeave=function(){var t=this.parentThatIsA(PrototypeHatBlockMorph);this.isHighlighted=!1,this.plainLabel&&t?(t.changed(),this.drawNew(),t.changed()):(this.drawNew(),this.changed())},BlockLabelPlaceHolderMorph.prototype.mouseClickLeft=BlockLabelFragmentMorph.prototype.mouseClickLeft,BlockLabelPlaceHolderMorph.prototype.updateBlockLabel=BlockLabelFragmentMorph.prototype.updateBlockLabel,BlockInputFragmentMorph.prototype=new TemplateSlotMorph,BlockInputFragmentMorph.prototype.constructor=BlockInputFragmentMorph,BlockInputFragmentMorph.uber=TemplateSlotMorph.prototype,BlockInputFragmentMorph.prototype.init=function(t){this.fragment=new BlockLabelFragment(t),this.fragment.type="%s",BlockInputFragmentMorph.uber.init.call(this,t)},BlockInputFragmentMorph.prototype.mouseClickLeft=BlockLabelFragmentMorph.prototype.mouseClickLeft,BlockInputFragmentMorph.prototype.updateBlockLabel=BlockLabelFragmentMorph.prototype.updateBlockLabel,InputSlotDialogMorph.prototype=new DialogBoxMorph,InputSlotDialogMorph.prototype.constructor=InputSlotDialogMorph,InputSlotDialogMorph.uber=DialogBoxMorph.prototype,InputSlotDialogMorph.prototype.isLaunchingExpanded=!1,InputSlotDialogMorph.prototype.init=function(t,e,o,i,r){var n=SyntaxElementMorph.prototype.scale,s=fontHeight(10)/1.2*n;this.fragment=t||new BlockLabelFragment,this.textfield=null,this.types=null,this.slots=null,this.isExpanded=!1,this.category=r||"other",this.cachedRadioButton=null,this.noDelete=!1,BlockDialogMorph.uber.init.call(this,e,o,i),this.types=new AlignmentMorph("row",this.padding),this.types.respectHiddens=!0,this.add(this.types),this.slots=new BoxMorph,this.slots.color=new Color(55,55,55),this.slots.borderColor=this.slots.color.lighter(50),this.slots.setExtent(new Point(24*(s+10),10.4*(s+10*n))),this.add(this.slots),this.createSlotTypeButtons(),this.fixSlotsLayout(),this.addSlotsMenu(),this.createTypeButtons(),this.fixLayout()},InputSlotDialogMorph.prototype.createTypeButtons=function(){var t,e,o=this,i=SpriteMorph.prototype.blockColor[this.category];(t=new JaggedBlockMorph(localize("Title text"))).setColor(i),this.addBlockTypeButton(function(){o.setType(null)},t,function(){return null===o.fragment.type}),(t=new JaggedBlockMorph("%inputName")).setColor(i),this.addBlockTypeButton(function(){o.setType("%s")},t,function(){return null!==o.fragment.type}),(e=new ArrowMorph("right",PushButtonMorph.prototype.fontSize+4,2)).noticesTransparentClick=!0,this.types.add(e),this.types.fixLayout(),e.refresh=function(){null===o.fragment.type?(o.isExpanded=!1,e.hide(),o.drawNew()):(e.show(),o.isExpanded?e.direction="down":e.direction="right",e.drawNew(),e.changed())},e.mouseClickLeft=function(){e.isVisible&&(o.isExpanded=!o.isExpanded,o.types.children.forEach(function(t){t.refresh()}),o.drawNew(),o.edit())},e.refresh()},InputSlotDialogMorph.prototype.addTypeButton=BlockDialogMorph.prototype.addTypeButton,InputSlotDialogMorph.prototype.addBlockTypeButton=BlockDialogMorph.prototype.addBlockTypeButton,InputSlotDialogMorph.prototype.setType=function(t){this.textfield.choices=t?null:this.symbolMenu,this.textfield.drawNew(),this.fragment.type=t||null,this.types.children.forEach(function(t){t.refresh()}),this.slots.children.forEach(function(t){t.refresh()}),this.edit()},InputSlotDialogMorph.prototype.getInput=function(){var t;return this.body instanceof InputFieldMorph&&(t=this.normalizeSpaces(this.body.getValue())),t?(this.fragment.labelString=t,contains(["%b","%boolUE"],this.fragment.type)?this.fragment.defaultValue=this.slots.defaultSwitch.evaluate():this.fragment.defaultValue=this.slots.defaultInputField.getValue(),t):(this.noDelete||(this.fragment.isDeleted=!0),null)},InputSlotDialogMorph.prototype.fixLayout=function(){var t,e=this.left(),o=fontHeight(this.titleFontSize)+2*this.titlePadding;if(!this.isExpanded)return this.slots&&this.slots.hide(),BlockDialogMorph.prototype.fixLayout.call(this);this.slots.show(),t=this.slots.width(),this.body.setPosition(this.position().add(new Point(this.padding+(t-this.body.width())/2,o+this.padding))),this.label.setLeft(e+this.padding+(t-this.label.width())/2),this.label.setTop(this.top()+(o-this.label.height())/2),this.types.fixLayout(),this.types.setTop(this.body.bottom()+this.padding),this.types.setLeft(e+this.padding+(t-this.types.width())/2),this.slots.setPosition(new Point(this.left()+this.padding,this.types.bottom()+this.padding)),this.slots.children.forEach(function(t){t.refresh()}),this.buttons.fixLayout(),this.buttons.setTop(this.slots.bottom()+this.padding),this.buttons.setLeft(e+this.padding+(t-this.buttons.width())/2),this.silentSetHeight(this.buttons.bottom()-this.top()+this.padding),this.silentSetWidth(this.slots.right()-this.left()+this.padding)},InputSlotDialogMorph.prototype.open=function(t,e,o,i,r){var n=new InputFieldMorph(e),s=Morph.prototype.trackChanges;this.fragment.type||(n.choices=this.symbolMenu),Morph.prototype.trackChanges=!1,this.isExpanded=this.isLaunchingExpanded,n.setWidth(250),this.labelString=t,this.createLabel(),i&&this.setPicture(i),this.addBody(n),n.drawNew(),this.textfield=n,this.addButton("ok","OK"),r?this.noDelete=!0:this.addButton("deleteFragment","Delete"),this.addButton("cancel","Cancel"),this.fixLayout(),this.drawNew(),this.fixLayout(),this.popUp(o),this.add(this.types),Morph.prototype.trackChanges=s,this.changed()},InputSlotDialogMorph.prototype.symbolMenu=function(){var t=[],e=new Color(100,100,130),o=this;return SymbolMorph.prototype.names.forEach(function(i){t.push([[new SymbolMorph(i,o.fontSize,e),localize(i)],"$"+i])}),t.push(["⏎ "+localize("new line"),"$nl"]),t},InputSlotDialogMorph.prototype.deleteFragment=function(){this.fragment.isDeleted=!0,this.accept()},InputSlotDialogMorph.prototype.createSlotTypeButtons=function(){var t,e,o,i=this,r=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,this.addSlotTypeButton("Object","%obj"),this.addSlotTypeButton("Text","%txt"),this.addSlotTypeButton("List","%l"),this.addSlotTypeButton("Number","%n"),this.addSlotTypeButton("Any type","%s"),this.addSlotTypeButton("Boolean (T/F)","%b"),this.addSlotTypeButton("Command\n(inline)","%cmdRing"),this.addSlotTypeButton("Reporter","%repRing"),this.addSlotTypeButton("Predicate","%predRing"),this.addSlotTypeButton("Command\n(C-shape)","%cs"),this.addSlotTypeButton("Any\n(unevaluated)","%anyUE"),this.addSlotTypeButton("Boolean\n(unevaluated)","%boolUE"),this.slots.radioButtonSingle=this.addSlotArityButton(function(){i.setSlotArity("single")},"Single input.",function(){return i.fragment.isSingleInput()}),this.addSlotArityButton(function(){i.setSlotArity("multiple")},"Multiple inputs (value is list of inputs)",function(){return i.fragment.isMultipleInput()}),this.addSlotArityButton(function(){i.setSlotArity("upvar")},"Upvar - make internal variable visible to caller",function(){return i.fragment.isUpvar()}),(t=new StringMorph(localize("Default Value:"))).fontSize=this.slots.radioButtonSingle.fontSize,t.setColor(new Color(255,255,255)),t.refresh=function(){i.isExpanded&&contains(["%s","%n","%txt","%anyUE","%b","%boolUE"],i.fragment.type)?t.show():t.hide()},this.slots.defaultInputLabel=t,this.slots.add(t),(e=new InputFieldMorph(this.fragment.defaultValue)).contents().fontSize=t.fontSize,e.contrast=90,e.contents().drawNew(),e.setWidth(50),e.refresh=function(){i.isExpanded&&contains(["%s","%n","%txt","%anyUE"],i.fragment.type)?(e.show(),"%n"===i.fragment.type?e.setIsNumeric(!0):e.setIsNumeric(!1)):e.hide()},this.slots.defaultInputField=e,this.slots.add(e),e.drawNew(),(o=new BooleanSlotMorph(this.fragment.defaultValue)).refresh=function(){i.isExpanded&&contains(["%b","%boolUE"],i.fragment.type)?o.show():o.hide()},this.slots.defaultSwitch=o,this.slots.add(o),o.drawNew(),Morph.prototype.trackChanges=r},InputSlotDialogMorph.prototype.setSlotType=function(t){this.fragment.setSingleInputType(t),this.slots.children.forEach(function(t){t.refresh()}),this.edit()},InputSlotDialogMorph.prototype.setSlotArity=function(t){"single"===t?this.fragment.setToSingleInput():"multiple"===t?this.fragment.setToMultipleInput():"upvar"===t&&this.fragment.setToUpvar(),this.slots.children.forEach(function(t){t.refresh()}),this.edit()},InputSlotDialogMorph.prototype.addSlotTypeButton=function(t,e){var o,i,r=this,n=new JaggedBlockMorph(e);return o=function(){return r.fragment.singleInputType()===e},n.setCategory(this.category),n.rebuild(),i=new ToggleMorph("radiobutton",this,function(){r.setSlotType(e)},t,o,null,null,this.cachedRadioButton,n.fullImage(),"rebuild"),i.edge=this.buttonEdge/2,i.outline=this.buttonOutline/2,i.outlineColor=this.buttonOutlineColor,i.outlineGradient=this.buttonOutlineGradient,i.drawNew(),i.fixLayout(),i.label.isBold=!1,i.label.setColor(new Color(255,255,255)),this.cachedRadioButton||(this.cachedRadioButton=i),this.slots.add(i),i},InputSlotDialogMorph.prototype.addSlotArityButton=function(t,e,o){var i=new ToggleMorph("radiobutton",this,t,e,o,null,null,this.cachedRadioButton);return i.edge=this.buttonEdge/2,i.outline=this.buttonOutline/2,i.outlineColor=this.buttonOutlineColor,i.outlineGradient=this.buttonOutlineGradient,i.drawNew(),i.fixLayout(),i.label.setColor(new Color(255,255,255)),this.slots.add(i),this.cachedRadioButton||(this.cachedRadioButton=i),i},InputSlotDialogMorph.prototype.fixSlotsLayout=function(){var t,e,o=this.slots,i=SyntaxElementMorph.prototype.scale,r=10*i,n=14*i,s=(fontHeight(10)/1.2+15)*i,a=(fontHeight(10)/1.2+10)*i,h=[o.left()+r,o.left()+o.width()/3,o.left()+2*o.width()/3],l=[o.top()+n,o.top()+n+s,o.top()+n+2*s,o.top()+n+3*s,o.top()+n+4*s,o.top()+n+5*s,o.top()+n+5*s+a,o.top()+n+5*s+2*a],p=-1,c=Morph.prototype.trackChanges;for(Morph.prototype.trackChanges=!1,t=0;t<12;t+=1)e=t%3,t%3==0&&(p+=1),o.children[t].setPosition(new Point(h[e],l[p]));for(e=0,p=5,t=12;t<15;t+=1)o.children[t].setPosition(new Point(h[e],l[p+t-12]));this.slots.defaultInputLabel.setPosition(this.slots.radioButtonSingle.label.topRight().add(new Point(5,0))),this.slots.defaultInputField.setCenter(this.slots.defaultInputLabel.center().add(new Point(this.slots.defaultInputField.width()/2+this.slots.defaultInputLabel.width()/2+5,0))),this.slots.defaultSwitch.setCenter(this.slots.defaultInputLabel.center().add(new Point(this.slots.defaultSwitch.width()/2+this.slots.defaultInputLabel.width()/2+5,0))),Morph.prototype.trackChanges=c,this.slots.changed()},InputSlotDialogMorph.prototype.addSlotsMenu=function(){var t=this;this.slots.userMenu=function(){if(contains(["%s","%n","%txt","%anyUE"],t.fragment.type)){var e=new MenuMorph(t);return e.addItem("options...","editSlotOptions"),e.addItem((t.fragment.isReadOnly?"☑ ":"☐ ")+localize("read-only"),function(){t.fragment.isReadOnly=!t.fragment.isReadOnly}),e}return Morph.prototype.userMenu.call(t)}},InputSlotDialogMorph.prototype.editSlotOptions=function(){var t=this;new DialogBoxMorph(t,function(e){t.fragment.options=e.trim()},t).promptCode("Input Slot Options",t.fragment.options,t.world(),null,localize('Enter one option per line.\nOptionally use "=" as key/value delimiter and {} for submenus. e.g.\n   the answer=42'))},InputSlotDialogMorph.prototype.hide=function(){this.isVisible=!1,this.changed()},InputSlotDialogMorph.prototype.show=function(){this.isVisible=!0,this.changed()},VariableDialogMorph.prototype=new DialogBoxMorph,VariableDialogMorph.prototype.constructor=VariableDialogMorph,VariableDialogMorph.uber=DialogBoxMorph.prototype,VariableDialogMorph.prototype.init=function(t,e,o){this.types=null,this.isGlobal=!0,BlockDialogMorph.uber.init.call(this,t,e,o),this.types=new AlignmentMorph("row",this.padding),this.add(this.types),this.createTypeButtons()},VariableDialogMorph.prototype.createTypeButtons=function(){var t=this;this.addTypeButton(function(){t.setType("global")},"for all sprites",function(){return t.isGlobal}),this.addTypeButton(function(){t.setType("local")},"for this sprite only",function(){return!t.isGlobal})},VariableDialogMorph.prototype.addTypeButton=BlockDialogMorph.prototype.addTypeButton,VariableDialogMorph.prototype.setType=function(t){this.isGlobal="global"===t,this.types.children.forEach(function(t){t.refresh()}),this.edit()},VariableDialogMorph.prototype.getInput=function(){var t=this.normalizeSpaces(this.body.getValue());return t?[t,this.isGlobal]:null},VariableDialogMorph.prototype.fixLayout=function(){var t=fontHeight(this.titleFontSize)+2*this.titlePadding;this.body&&(this.body.setPosition(this.position().add(new Point(this.padding,t+this.padding))),this.silentSetWidth(this.body.width()+2*this.padding),this.silentSetHeight(this.body.height()+2*this.padding+t)),this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(t-this.label.height())/2)),this.types&&(this.types.fixLayout(),this.silentSetHeight(this.height()+this.types.height()+this.padding),this.silentSetWidth(Math.max(this.width(),this.types.width()+2*this.padding)),this.types.setCenter(this.center()),this.body?this.types.setTop(this.body.bottom()+this.padding):this.categories&&this.types.setTop(this.categories.bottom()+this.padding)),this.buttons&&this.buttons.children.length>0&&(this.buttons.fixLayout(),this.silentSetHeight(this.height()+this.buttons.height()+this.padding),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding))},BlockExportDialogMorph.prototype=new DialogBoxMorph,BlockExportDialogMorph.prototype.constructor=BlockExportDialogMorph,BlockExportDialogMorph.uber=DialogBoxMorph.prototype,BlockExportDialogMorph.prototype.key="blockExport",BlockExportDialogMorph.prototype.init=function(t,e){var o=this;this.serializer=t,this.blocks=e.slice(0),this.handle=null,BlockExportDialogMorph.uber.init.call(this,null,function(){o.exportBlocks()},null),this.labelString="Export blocks",this.createLabel(),this.buildContents()},BlockExportDialogMorph.prototype.buildContents=function(){var t,e,o,i,r,n,s=this;(t=new ScrollFrameMorph(null,null,SpriteMorph.prototype.sliderColor)).color=SpriteMorph.prototype.paletteColor,t.padding=4,t.isDraggable=!1,t.acceptsDrops=!1,t.contents.acceptsDrops=!1,e=t.left()+4,o=t.top()+4,SpriteMorph.prototype.categories.forEach(function(a){s.blocks.forEach(function(h){h.category===a&&(n&&a!==n&&(o+=4),n=a,i=h.templateInstance(),(r=new ToggleMorph("checkbox",s,function(){var t=s.blocks.indexOf(h);t>-1?s.blocks.splice(t,1):s.blocks.push(h)},null,function(){return contains(s.blocks,h)},null,null,null,i.fullImage())).setPosition(new Point(e,o+(r.top()-r.toggleElement.top()))),t.addContents(r),o+=r.fullBounds().height()+4)})}),t.scrollX(4),t.scrollY(4),this.addBody(t),this.addButton("ok","OK"),this.addButton("cancel","Cancel"),this.setExtent(new Point(220,300)),this.fixLayout()},BlockExportDialogMorph.prototype.popUp=function(t){var e=t||this.target.world();e&&(BlockExportDialogMorph.uber.popUp.call(this,e),this.handle=new HandleMorph(this,200,220,this.corner,this.corner))},BlockExportDialogMorph.prototype.userMenu=function(){var t=new MenuMorph(this,"select");return t.addItem("all","selectAll"),t.addItem("none","selectNone"),t},BlockExportDialogMorph.prototype.selectAll=function(){this.body.contents.children.forEach(function(t){t.state||t.trigger()})},BlockExportDialogMorph.prototype.selectNone=function(){this.blocks=[],this.body.contents.children.forEach(function(t){t.refresh()})},BlockExportDialogMorph.prototype.exportBlocks=function(){var t=this.serializer.serialize(this.blocks,!0),e=this.world().children[0];this.blocks.length>0?(t='<blocks app="'+this.serializer.app+'" version="'+this.serializer.version+'">'+t+"</blocks>",e.saveXMLAs(t,(e.projectName||localize("untitled"))+" "+localize("blocks"))):(new DialogBoxMorph).inform("Export blocks","no blocks were selected",this.world())},BlockExportDialogMorph.prototype.fixLayout=BlockEditorMorph.prototype.fixLayout,BlockImportDialogMorph.prototype=new DialogBoxMorph,BlockImportDialogMorph.prototype.constructor=BlockImportDialogMorph,BlockImportDialogMorph.uber=DialogBoxMorph.prototype,BlockImportDialogMorph.prototype.key="blockImport",BlockImportDialogMorph.prototype.init=function(t,e,o){var i=this;this.blocks=t.slice(0),this.handle=null,BlockExportDialogMorph.uber.init.call(this,e,function(){i.importBlocks(o)},null),this.labelString=localize("Import blocks")+(o?": ":"")+o||"",this.createLabel(),this.buildContents()},BlockImportDialogMorph.prototype.buildContents=BlockExportDialogMorph.prototype.buildContents,BlockImportDialogMorph.prototype.popUp=BlockExportDialogMorph.prototype.popUp,BlockImportDialogMorph.prototype.userMenu=BlockExportDialogMorph.prototype.userMenu,BlockImportDialogMorph.prototype.selectAll=BlockExportDialogMorph.prototype.selectAll,BlockImportDialogMorph.prototype.selectNone=BlockExportDialogMorph.prototype.selectNone,BlockImportDialogMorph.prototype.importBlocks=function(t){var e=this.target.parentThatIsA(IDE_Morph);e&&(this.blocks.length>0?(this.blocks.forEach(function(t){t.receiver=e.stage,e.stage.globalBlocks.push(t),e.stage.replaceDoubleDefinitionsFor(t)}),e.flushPaletteCache(),e.refreshPalette(),e.showMessage("Imported Blocks Module"+(t?": "+t:"")+".",2)):(new DialogBoxMorph).inform("Import blocks","no blocks were selected",this.world()))},BlockImportDialogMorph.prototype.fixLayout=BlockEditorMorph.prototype.fixLayout,BlockRemovalDialogMorph.prototype=new DialogBoxMorph,BlockRemovalDialogMorph.prototype.constructor=BlockImportDialogMorph,BlockRemovalDialogMorph.uber=DialogBoxMorph.prototype,BlockRemovalDialogMorph.prototype.key="blockRemove",BlockRemovalDialogMorph.prototype.init=function(t,e){var o=this;this.blocks=t.slice(0),this.handle=null,BlockExportDialogMorph.uber.init.call(this,e,function(){o.removeBlocks()},null),this.labelString=localize("Remove unused blocks")+(name?": ":"")+name||"",this.createLabel(),this.buildContents()},BlockRemovalDialogMorph.prototype.buildContents=BlockExportDialogMorph.prototype.buildContents,BlockRemovalDialogMorph.prototype.popUp=BlockExportDialogMorph.prototype.popUp,BlockRemovalDialogMorph.prototype.userMenu=BlockExportDialogMorph.prototype.userMenu,BlockRemovalDialogMorph.prototype.selectAll=BlockExportDialogMorph.prototype.selectAll,BlockRemovalDialogMorph.prototype.selectNone=BlockExportDialogMorph.prototype.selectNone,BlockRemovalDialogMorph.prototype.removeBlocks=function(){var t=this.target.parentThatIsA(IDE_Morph);t&&(this.blocks.length>0?(this.blocks.forEach(function(e){var o=t.stage.globalBlocks.indexOf(e);-1!==o&&t.stage.globalBlocks.splice(o,1)}),t.flushPaletteCache(),t.refreshPalette(),t.showMessage(this.blocks.length+" "+localize("unused block(s) removed"),2)):(new DialogBoxMorph).inform("Remove unused blocks","no blocks were selected",this.world()))},BlockRemovalDialogMorph.prototype.fixLayout=BlockEditorMorph.prototype.fixLayout,modules.tables="2017-September-01";var Table,TableCellMorph,TableMorph,TableFrameMorph;Table.prototype.demo=function(t){this.fillWithTestData(),new TableDialogMorph(this).popUp(t)},Table.prototype.changed=function(){this.lastChanged=Date.now()},Table.prototype.get=function(t,e){return t?e?t>this.colCount||e>this.rowCount?null:(this.contents[e-1]||[])[t-1]:this.colName(t):e?this.rowName(e):[this.rowCount]},Table.prototype.row=function(t){return this.contents[t-1]},Table.prototype.col=function(t){var e,o=[],i=t-1;for(e=0;e<this.rowCount;e+=1)o.push(this.contents[e][i]);return o},Table.prototype.colName=function(t){if(t>this.colCount)return null;var e=this.colNames[t-1];return void 0!==e?e:String.fromCharCode(64+(t%26||26)).repeat(Math.floor((t-1)/26)+1)},Table.prototype.rowName=function(t){return t>this.rowCount?null:this.rowNames[t-1]||t},Table.prototype.rows=function(){return this.rowCount},Table.prototype.cols=function(){return this.colCount},Table.prototype.columnNames=function(){return this.colNames},Table.prototype.set=function(t,e,o){this.contents[o-1][e-1]=t,this.changed()},Table.prototype.setRows=function(t,e,o){this.contents=t,e&&(this.colNames=e),o&&(this.rowNames=o),this.changed()},Table.prototype.setCols=function(t,e,o){var i,r;for(r=0;r<this.colCount;r+=1)for(i=0;i<this.rowCount;i+=1)this.contents[i][r]=t[r][i];e&&(this.colNames=e),o&&(this.rowNames=o),this.changed()},Table.prototype.setColNames=function(t){this.colNames=t||[],this.changed()},Table.prototype.setRowNames=function(t){this.rowNames=t||[],this.changed()},Table.prototype.setColName=function(t,e){this.colNames[t+1]=e,this.changed()},Table.prototype.setRowName=function(t,e){this.rowNames[t+1]=e,this.changed()},Table.prototype.addRow=function(t,e){this.contents[this.rowCount]=t||new Array(this.rowCount),this.rowNames[this.rowCount]=e,this.rowCount+=1,this.changed()},Table.prototype.addCol=function(t,e){var o;if(t)for(o=0;o<this.col;o+=1)this.contents[o][this.colCount]=t[o];this.colNames[this.colCount]=e,this.colCount+=1,this.changed()},Table.prototype.toList=function(){return new List(this.contents.map(function(t){return new List(t)}))},Table.prototype.fillWithTestData=function(){var t,e;for(t=1;t<=this.colCount;t+=1)for(e=1;e<=this.rowCount;e+=1)this.set(this.colName(t)+this.rowName(e),t,e)},TableCellMorph.prototype=new Morph,TableCellMorph.prototype.constructor=TableCellMorph,TableCellMorph.uber=Morph.prototype,TableCellMorph.prototype.listSymbol=ArgMorph.prototype.listIcon(),TableCellMorph.prototype.init=function(t,e,o){this.data=t,this.isLabel=o||!1,TableCellMorph.uber.init.call(this,!0),this.noticesTransparentClick=!0,e&&this.silentSetExtent(e),this.drawNew()},TableCellMorph.prototype.setData=function(t,e){this.data=t,e&&!e.eq(this.extent())?(this.silentSetExtent(e),this.drawNew()):this.drawData()},TableCellMorph.prototype.getData=function(){return this.data instanceof Array?this.data[0]:this.data},TableCellMorph.prototype.drawNew=function(){this.image=newCanvas(this.extent()),this.drawData()},TableCellMorph.prototype.drawData=function(t,e){var o,i,r,n,s=t||this.dataRepresentation(this.data),a=this.image.getContext("2d"),h=SyntaxElementMorph.prototype.fontSize,l=TableMorph.prototype.highContrast?"rgb(220, 220, 220)":"transparent",p=(this.isLabel?this.data instanceof Array?"italic":"":this.shouldBeList()?"bold":"")+" "+h+"px Helvetica, Arial, sans-serif",c=e||(this.isLabel?l:this.shouldBeList()?"rgb(217, 77, 17)":this.isOvershooting()?"white":isNil(this.data)?l:"white"),d=!this.isLabel&&this.shouldBeList()?"white":"black",u=this.width(),g=this.height();a.clearRect(0,0,u,g),a.fillStyle=c,this.shouldBeList()?(BoxMorph.prototype.outlinePath.call(this,a,SyntaxElementMorph.prototype.corner+1,0),a.fill()):this.isOvershooting()?(this.raggedBoxPath(a),a.fill()):a.fillRect(0,0,u,g),s&&(s instanceof HTMLCanvasElement?(r=Math.max((u-s.width)/2,0),n=Math.max((g-s.height)/2,0),a.shadowOffsetX=4,a.shadowOffsetY=4,a.shadowBlur=4,a.shadowColor="lightgray",a.drawImage(s,r,n)):(a.font=p,a.textAlign="left",a.textBaseline="bottom",o=a.measureText(s).width,i=fontHeight(h),a.fillStyle=d,r=Math.max((u-o)/2,0),n=Math.max((g-i)/2,0),a.fillText(s,r,i+n)))},TableCellMorph.prototype.dataRepresentation=function(t){return t instanceof Morph?isSnapObject(t)?t.thumbnail(new Point(40,40)):t.fullImageClassic():isString(t)?t.length>100?t.slice(0,100)+"...":t:"number"==typeof t?t.toString():"boolean"==typeof t?SpriteMorph.prototype.booleanMorph.call(null,t).fullImage():t instanceof Array?this.dataRepresentation(t[0]):t instanceof Variable?this.dataRepresentation(t.value):t instanceof HTMLCanvasElement?t:t instanceof Context?t.image():t instanceof Costume?t.thumbnail(new Point(40,40)):t instanceof Sound?new SymbolMorph("notes",30).image:t instanceof List?this.listSymbol:t?t.toString():0===t?"0":null},TableCellMorph.prototype.raggedBoxPath=function(t){var e=this.width(),o=this.height(),i=.75*e,r=o/6,n=0;for(t.beginPath(),t.moveTo(0,0),t.lineTo(e,0),n=0;n<o;n+=2*r)t.lineTo(i,n+r),t.lineTo(e,n+2*r);t.lineTo(e,o),t.lineTo(0,o),t.closePath()},TableCellMorph.prototype.shouldBeList=function(){return this.data instanceof Array},TableCellMorph.prototype.isOvershooting=function(){return this.data instanceof Variable},TableCellMorph.prototype.mouseDoubleClick=function(t){this.data instanceof Table||this.data instanceof List?new TableDialogMorph(this.data).popUp(this.world()):this.data instanceof Array&&this.data[0]instanceof List?new TableDialogMorph(this.data[0]).popUp(this.world()):this.escalateEvent("mouseDoubleClick",t)},TableCellMorph.prototype.mouseEnter=function(){var t,e,o;this.isLabel&&(e=(t=this.parentThatIsA(TableMorph)).world().hand.left()-t.left(),(o=t.columnAt(e))>0&&(this.drawData(o,"rgb(220, 220, 250)"),this.changed()))},TableCellMorph.prototype.mouseLeave=function(){this.isLabel&&(this.drawData(),this.changed())},TableMorph.prototype=new FrameMorph,TableMorph.prototype.constructor=TableMorph,TableMorph.uber=FrameMorph.prototype,TableMorph.prototype.highContrast=!1,TableMorph.prototype.init=function(t,e,o,i,r,n,s,a,h,l){this.table=t,this.scrollBarSize=e||MorphicPreferences.scrollBarSize,this.startRow=i||1,this.startCol=r||1,this.textHeight=Math.ceil(1.3*fontHeight(SyntaxElementMorph.prototype.fontSize)),this.rowHeight=a||this.textHeight,this.colWidths=s||[],this.globalColWidth=n||Math.ceil(3.5*this.textHeight),this.colLabelHeight=h||this.textHeight,this.padding=l||SyntaxElementMorph.prototype.scale,this.tableVersion=this.table.lastChanged,this.hBar=null,this.vBar=null,this.rowLabelWidth=0,this.columns=[],this.rows=0,this.maxStartRow=null,this.maxStartCol=null,this.dragAnchor=null,this.resizeAnchor=null,this.resizeCol=null,this.resizeRow=null,this.wantsUpdate=!1,Morph.prototype.init.call(this,!0),o&&this.silentSetExtent(o),this.initScrollBars(),this.drawNew()},TableMorph.prototype.initScrollBars=function(){var t=this;this.hBar=new SliderMorph(1,null,null,null,"horizontal"),this.hBar.setHeight(this.scrollBarSize),this.hBar.action=function(e){t.showData(e,null,!0)},this.hBar.isDraggable=!1,this.add(this.hBar),this.vBar=new SliderMorph(1,null,null,null,"vertical"),this.vBar.setWidth(this.scrollBarSize),this.vBar.action=function(e){t.showData(null,e,!0)},this.vBar.isDraggable=!1,this.add(this.vBar)},TableMorph.prototype.updateScrollBars=function(){1===this.maxStartCol?this.hBar.hide():(this.hBar.show(),this.hBar.stop=this.maxStartCol,this.hBar.value=this.startCol,this.hBar.size=Math.max(this.hBar.rangeSize()*this.columns.length/this.table.cols(),this.hBar.rangeSize()/10),this.hBar.drawNew()),this.vBar.stop=this.maxStartRow,this.vBar.value=this.startRow,1===this.maxStartRow?this.vBar.hide():(this.vBar.show(),this.vBar.size=Math.max(this.vBar.rangeSize()*this.rows/this.table.rows(),this.vBar.rangeSize()/10),this.vBar.drawNew())},TableMorph.prototype.drawNew=function(){var t,e,o;if(this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),t.fillStyle="rgb(220, 220, 220)",BoxMorph.prototype.outlinePath.call(this,t,SyntaxElementMorph.prototype.corner+1,0),t.fill(),this.rowLabelWidth=this.rowLabelsWidth(),this.columns=this.columnsLayout(),this.rows=this.visibleRows(),this.highContrast&&this.table.cols()>1){for(e=this.padding,o=this.startCol;o<=this.table.cols();o+=1)e+=this.colWidth(o)+this.padding;t.fillStyle="darkGray",t.fillRect(this.padding+this.rowLabelWidth,this.padding+this.colLabelHeight,e,(this.rowHeight+this.padding)*(this.table.rows()+1-this.startRow)+this.padding)}this.buildCells(),this.hBar.setWidth(this.width()-this.vBar.width()),this.hBar.setLeft(this.left()),this.hBar.setBottom(this.bottom()),this.vBar.setHeight(this.height()-this.hBar.height()),this.vBar.setRight(this.right()),this.vBar.setTop(this.top())},TableMorph.prototype.buildCells=function(){var t,e,o,i=this.position();for(this.children=[],o=0;o<=this.columns.length;o+=1)for(e=0;e<=this.rows;e+=1)(t=new TableCellMorph(this.table.get(o?o+this.startCol-1:o,e?e+this.startRow-1:e),new Point(o?this.colWidth(o+this.startCol-1):this.rowLabelWidth,e?this.rowHeight:this.colLabelHeight),!(e&&o),!1)).setPosition(new Point(o?this.columns[o-1]:this.padding,e?2*this.padding+this.colLabelHeight+(e-1)*(this.rowHeight+this.padding):this.padding).add(i)),this.add(t),isSnapObject(t.getData())&&(this.wantsUpdate=!0);this.add(this.hBar),this.add(this.vBar),this.updateScrollBars(),this.changed()},TableMorph.prototype.drawData=function(t){var e,o,i,r=0;for(i=0;i<=this.columns.length;i+=1)for(o=0;o<=this.rows;o+=1)e=this.children[r],r+=1,e.setData(this.table.get(i?i+this.startCol-1:i,o?o+this.startRow-1:o)),isSnapObject(e.getData())&&(this.wantsUpdate=!0);t||this.updateScrollBars(),this.changed()},TableMorph.prototype.scroll=function(t,e){this.showData(Math.min(this.maxStartCol,Math.max(1,this.startCol+Math.round(t))),Math.min(this.maxStartRow,Math.max(1,this.startRow+Math.round(e)))),this.updateScrollBars()},TableMorph.prototype.showData=function(t,e,o){var i=t||this.startCol,r=e||this.startRow;if(i===this.startCol){if(r===this.startRow)return;this.startRow=r,this.rows=this.visibleRows(),this.drawData(o)}else this.startCol=i,this.startRow=r,this.rows=this.visibleRows(),this.colWidths.length?(this.columns=this.columnsLayout(),this.buildCells()):this.drawData(o)},TableMorph.prototype.step=function(){this.dragAnchor?this.shiftCells(this.world().hand.position()):this.resizeAnchor&&this.resizeCells(this.world().hand.position()),this.update()},TableMorph.prototype.update=function(){var t,e,o=this.table instanceof List?this.table.version(this.startRow,this.rows):this.table.lastChanged;(this.tableVersion!==o||this.wantsUpdate)&&(this.wantsUpdate=!1,this.table instanceof List?(t=this.columns.length,e=this.rows,this.rowLabelWidth=this.rowLabelsWidth(),this.columns=this.columnsLayout(),this.rows=this.visibleRows(),this.columns.length!==t||this.rows!==e?this.buildCells():this.drawData()):this.drawData(),this.tableVersion=o)},TableMorph.prototype.rowLabelsWidth=function(){var t=newCanvas().getContext("2d");return t.font="italic "+SyntaxElementMorph.prototype.fontSize+"px Helvetica, Arial, sans-serif",Math.max(0,Math.max.apply(null,this.table.columnNames().map(function(e){return e?t.measureText(e).width:0})))||t.measureText(this.table.rows().toString()).width+6*SyntaxElementMorph.prototype.scale},TableMorph.prototype.columnsLayout=function(){var t,e,o=[],i=2*this.padding+this.rowLabelWidth;for(t=this.table.cols(),e=i;e<this.width()&&t>0;)e+=this.colWidth(t),t-=1;for(0===t&&e<this.width()?this.maxStartCol=1:this.maxStartCol=Math.min(t+2,this.table.cols()),this.startCol=Math.min(this.startCol,this.maxStartCol),t=this.startCol;i<this.width()&&t<this.table.cols()+this.startCol;)e=this.colWidth(t),o.push(i),i+=e,i+=this.padding,t+=1;return o},TableMorph.prototype.colWidth=function(t){return this.colWidths[t-1]||this.globalColWidth},TableMorph.prototype.visibleRows=function(){var t,e=this.height()-this.colLabelHeight-this.padding;return e<0?0:(t=Math.ceil(e/(this.rowHeight+this.padding)),this.maxStartRow=Math.max(1,this.table.rows()-t+2),this.startRow=Math.min(this.startRow,this.maxStartRow),Math.min(this.table.rows(),t))},TableMorph.prototype.globalExtent=function(){var t,e=this.rowLabelsWidth()+2,o=this.table.cols();for(t=0;t<o;t+=1)e+=this.colWidth(t+1),e+=this.padding;return 1===o&&(e+=this.scrollBarSize,e+=2*this.padding),new Point(e+this.padding,this.colLabelHeight+2*this.padding+(this.rowHeight+this.padding)*this.table.rows())},TableMorph.prototype.mouseScroll=function(t,e){this.scroll(-+e*MorphicPreferences.mouseScrollAmount/4,-+t*MorphicPreferences.mouseScrollAmount)},TableMorph.prototype.mouseDownLeft=function(t){var e=t.subtract(this.position());e.x<=this.rowLabelWidth||e.y<=this.colLabelHeight?(16===this.world().currentKey?this.resizeCol=0:this.resizeCol=this.columnAt(e.x),this.resizeRow=e.y>this.colLabelHeight,this.resizeAnchor=t):(this.resizeRow=null,this.dragAnchor=t)},TableMorph.prototype.mouseClickLeft=function(t){this.dragAnchor=null,this.resizeAnchor=null,this.resizeRow=null},TableMorph.prototype.mouseLeaveDragging=function(t){this.dragAnchor=null,this.resizeAnchor=null,this.resizeRow=null},TableMorph.prototype.mouseDoubleClick=function(t){this.parentThatIsA(TableDialogMorph)?this.escalateEvent("mouseDoubleClick",t):new TableDialogMorph(this.table,this.globalColWidth,this.colWidths,this.rowHeight).popUp(this.world())},TableMorph.prototype.shiftCells=function(t){var e=this.dragAnchor.subtract(t),o=Math.round(e.x/this.globalColWidth),i=Math.round(e.y/this.rowHeight);(o||i)&&(this.scroll(o,i),this.dragAnchor=t)},TableMorph.prototype.resizeCells=function(t){var e,o=t.subtract(this.resizeAnchor);if(this.resizeCol)this.colWidths[this.resizeCol-1]=Math.max(16,(this.colWidths[this.resizeCol-1]||this.globalColWidth)+o.x);else if(this.resizeRow)this.rowHeight=Math.max(16,this.rowHeight+o.y);else for(this.globalColWidth=Math.max(16,this.globalColWidth+o.x),e=0;e<this.colWidths.length;e+=1)this.colWidths[e]&&(this.colWidths[e]=Math.max(16,this.colWidths[e]+o.x));this.highContrast?this.drawNew():(this.rowLabelWidth=this.rowLabelsWidth(),this.columns=this.columnsLayout(),this.rows=this.visibleRows(),this.buildCells()),this.resizeAnchor=t},TableMorph.prototype.columnAt=function(t){var e=0;if(t<this.columns[0])return 0;for(;t>this.columns[e];)e+=1;return e+this.startCol-1},TableMorph.prototype.userMenu=function(){var t=new MenuMorph(this);return this.parentThatIsA(TableDialogMorph)?(this.colWidths.length&&(t.addItem("reset columns","resetColumns"),t.addLine()),t.addItem("open in another dialog...","openInDialog"),t):(this.colWidths.length&&t.addItem("reset columns","resetColumns"),t.addItem("list view...","showListView"),t.addLine(),t.addItem("open in dialog...","openInDialog"),t)},TableMorph.prototype.resetColumns=function(){this.colWidths=[],this.highContrast?this.drawNew():(this.rowLabelWidth=this.rowLabelsWidth(),this.columns=this.columnsLayout(),this.rows=this.visibleRows(),this.buildCells())},TableMorph.prototype.openInDialog=function(){new TableDialogMorph(this.table,this.globalColWidth,this.colWidths,this.rowHeight).popUp(this.world())},TableMorph.prototype.showListView=function(){var t=this.parentThatIsAnyOf([SpriteBubbleMorph,SpeechBubbleMorph,CellMorph]);t&&(t instanceof SpriteBubbleMorph?(t.changed(),t.drawNew(!0)):t instanceof SpeechBubbleMorph?(t.contents=new ListWatcherMorph(this.table),t.contents.step=t.contents.update,t.contents.expand(this.extent()),t.drawNew(!0)):(t.drawNew(!0),t.contentsMorph.expand(this.extent())),t.fixLayout())},TableMorph.prototype.show=function(){TableMorph.uber.show.call(this),this.updateScrollBars()},TableFrameMorph.prototype=new Morph,TableFrameMorph.prototype.constructor=TableFrameMorph,TableFrameMorph.uber=Morph.prototype,TableFrameMorph.prototype.init=function(t,e){this.tableMorph=t,this.handle=null,TableFrameMorph.uber.init.call(this,!0),this.color="transparent",this.noticesTransparentClick=!1,this.bounds=this.tableMorph.bounds.copy(),this.add(this.tableMorph),e||(this.handle=new HandleMorph(this,80,25,null,null)),this.drawNew()},TableFrameMorph.prototype.fixLayout=function(){var t=this.extent();this.tableMorph.extent().eq(t)||(this.tableMorph.setExtent(this.extent()),this.parent&&this.parent.fixLayout&&this.parent.fixLayout())},TableFrameMorph.prototype.setExtent=function(t,e){TableFrameMorph.uber.setExtent.call(this,t,e),this.fixLayout()},TableFrameMorph.prototype.expand=function(t){var e=this.tableMorph.globalExtent();t&&(e=e.min(t)),this.setExtent(e),this.handle.setRight(this.right()),this.handle.setBottom(this.bottom())},TableDialogMorph.prototype=new DialogBoxMorph,TableDialogMorph.prototype.constructor=TableDialogMorph,TableDialogMorph.uber=DialogBoxMorph.prototype,TableDialogMorph.prototype.init=function(t,e,o,i){this.handle=null,this.data=t,this.tableView=null,TableDialogMorph.uber.init.call(this),this.labelString="Table view",this.createLabel(),this.buildContents(t,e,o,i)},TableDialogMorph.prototype.buildContents=function(t,e,o,i){this.tableView=new TableMorph(t,null,null,null,null,e,o,i,null,null),this.addBody(new TableFrameMorph(this.tableView,!0)),this.addButton("ok","OK")},TableDialogMorph.prototype.setInitialDimensions=function(){var t=this.world().extent().subtract(new Point(this.padding,this.padding)),e=fontHeight(this.titleFontSize)+3*this.titlePadding,o=this.buttons.height();this.setExtent(this.tableView.globalExtent().add(new Point(2*this.padding,2*this.padding+e+o)).min(t).max(new Point(100,100))),this.setCenter(this.world().center())},TableDialogMorph.prototype.popUp=function(t){t&&(TableDialogMorph.uber.popUp.call(this,t),this.setInitialDimensions(),this.handle=new HandleMorph(this,100,100,this.corner,this.corner))},TableDialogMorph.prototype.fixLayout=BlockEditorMorph.prototype.fixLayout,modules.symbols="2017-September-26";var SymbolMorph;SymbolMorph.prototype=new Morph,SymbolMorph.prototype.constructor=SymbolMorph,SymbolMorph.uber=Morph.prototype,SymbolMorph.prototype.names=["square","pointRight","stepForward","gears","file","fullScreen","normalScreen","smallStage","normalStage","turtle","stage","turtleOutline","pause","flag","octagon","cloud","cloudOutline","cloudGradient","turnRight","turnLeft","storage","poster","flash","brush","rectangle","rectangleSolid","circle","circleSolid","line","cross","crosshairs","paintbucket","eraser","pipette","speechBubble","speechBubbleOutline","turnBack","turnForward","arrowUp","arrowUpOutline","arrowLeft","arrowLeftOutline","arrowDown","arrowDownOutline","arrowRight","arrowRightOutline","robot","magnifyingGlass","magnifierOutline","notes","camera","location","footprints","keyboard","keyboardFilled"],SymbolMorph.prototype.init=function(t,e,o,i,r){this.isProtectedLabel=!1,this.isReadOnly=!0,this.name=t||"square",this.size=e||(0===e?0:50),this.shadowOffset=i||new Point(0,0),this.shadowColor=r||null,SymbolMorph.uber.init.call(this,!0),this.color=o||new Color(0,0,0),this.drawNew()},SymbolMorph.prototype.setLabelColor=function(t,e,o){this.shadowOffset=o||new Point,this.shadowColor=e,this.setColor(t)},SymbolMorph.prototype.drawNew=function(){var t,e,o,i,r;this.image=newCanvas(new Point(this.symbolWidth()+Math.abs(this.shadowOffset.x),this.size+Math.abs(this.shadowOffset.y))),this.silentSetWidth(this.image.width),this.silentSetHeight(this.image.height),t=this.image.getContext("2d"),i=this.shadowOffset.x<0?0:this.shadowOffset.x,r=this.shadowOffset.y<0?0:this.shadowOffset.y,e=this.shadowOffset.x<0?Math.abs(this.shadowOffset.x):0,o=this.shadowOffset.y<0?Math.abs(this.shadowOffset.y):0,this.shadowColor&&t.drawImage(this.symbolCanvasColored(this.shadowColor),i,r),t.drawImage(this.symbolCanvasColored(this.color),e,o)},SymbolMorph.prototype.symbolCanvasColored=function(t){if(this.name instanceof Costume)return this.name.thumbnail(new Point(this.symbolWidth(),this.size));var e=newCanvas(new Point(this.symbolWidth(),this.size));switch(this.name){case"square":return this.drawSymbolStop(e,t);case"pointRight":return this.drawSymbolPointRight(e,t);case"stepForward":return this.drawSymbolStepForward(e,t);case"gears":return this.drawSymbolGears(e,t);case"file":return this.drawSymbolFile(e,t);case"fullScreen":return this.drawSymbolFullScreen(e,t);case"normalScreen":return this.drawSymbolNormalScreen(e,t);case"smallStage":return this.drawSymbolSmallStage(e,t);case"normalStage":return this.drawSymbolNormalStage(e,t);case"turtle":return this.drawSymbolTurtle(e,t);case"stage":return this.drawSymbolStop(e,t);case"turtleOutline":return this.drawSymbolTurtleOutline(e,t);case"pause":return this.drawSymbolPause(e,t);case"flag":return this.drawSymbolFlag(e,t);case"octagon":return this.drawSymbolOctagon(e,t);case"cloud":return this.drawSymbolCloud(e,t);case"cloudOutline":return this.drawSymbolCloudOutline(e,t);case"cloudGradient":return this.drawSymbolCloudGradient(e,t);case"turnRight":return this.drawSymbolTurnRight(e,t);case"turnLeft":return this.drawSymbolTurnLeft(e,t);case"storage":return this.drawSymbolStorage(e,t);case"poster":return this.drawSymbolPoster(e,t);case"flash":return this.drawSymbolFlash(e,t);case"brush":return this.drawSymbolBrush(e,t);case"rectangle":return this.drawSymbolRectangle(e,t);case"rectangleSolid":return this.drawSymbolRectangleSolid(e,t);case"circle":return this.drawSymbolCircle(e,t);case"circleSolid":return this.drawSymbolCircleSolid(e,t);case"line":return this.drawSymbolLine(e,t);case"cross":return this.drawSymbolCross(e,t);case"crosshairs":return this.drawSymbolCrosshairs(e,t);case"paintbucket":return this.drawSymbolPaintbucket(e,t);case"eraser":return this.drawSymbolEraser(e,t);case"pipette":return this.drawSymbolPipette(e,t);case"speechBubble":return this.drawSymbolSpeechBubble(e,t);case"speechBubbleOutline":return this.drawSymbolSpeechBubbleOutline(e,t);case"turnBack":return this.drawSymbolTurnBack(e,t);case"turnForward":return this.drawSymbolTurnForward(e,t);case"arrowUp":return this.drawSymbolArrowUp(e,t);case"arrowUpOutline":return this.drawSymbolArrowUpOutline(e,t);case"arrowLeft":return this.drawSymbolArrowLeft(e,t);case"arrowLeftOutline":return this.drawSymbolArrowLeftOutline(e,t);case"arrowDown":return this.drawSymbolArrowDown(e,t);case"arrowDownOutline":return this.drawSymbolArrowDownOutline(e,t);case"arrowRight":return this.drawSymbolArrowRight(e,t);case"arrowRightOutline":return this.drawSymbolArrowRightOutline(e,t);case"robot":return this.drawSymbolRobot(e,t);case"magnifyingGlass":return this.drawSymbolMagnifyingGlass(e,t);case"magnifierOutline":return this.drawSymbolMagnifierOutline(e,t);case"notes":return this.drawSymbolNotes(e,t);case"camera":return this.drawSymbolCamera(e,t);case"location":return this.drawSymbolLocation(e,t);case"footprints":return this.drawSymbolFootprints(e,t);case"keyboard":return this.drawSymbolKeyboard(e,t);case"keyboardFilled":return this.drawSymbolKeyboardFilled(e,t);default:return e}},SymbolMorph.prototype.symbolWidth=function(){var t=this.size;if(this.name instanceof Costume)return t/this.name.height()*this.name.width();switch(this.name){case"pointRight":return Math.sqrt(t*t-Math.pow(t/2,2));case"location":return.6*t;case"flash":case"file":return.8*t;case"smallStage":case"normalStage":return 1.2*t;case"turtle":case"turtleOutline":case"stage":return 1.3*t;case"cloud":case"cloudGradient":case"cloudOutline":case"turnBack":case"turnForward":case"keyboard":case"keyboardFilled":return 1.6*t;case"turnRight":case"turnLeft":return t/3*2;default:return t}},SymbolMorph.prototype.drawSymbolStop=function(t,e){var o=t.getContext("2d");return o.fillStyle=e.toString(),o.fillRect(0,0,t.width,t.height),t},SymbolMorph.prototype.drawSymbolPointRight=function(t,e){var o=t.getContext("2d");return o.fillStyle=e.toString(),o.beginPath(),o.moveTo(0,0),o.lineTo(t.width,Math.round(t.height/2)),o.lineTo(0,t.height),o.lineTo(0,0),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolStepForward=function(t,e){var o=t.getContext("2d");return o.fillStyle=e.toString(),o.beginPath(),o.moveTo(0,0),o.lineTo(.75*t.width,Math.round(t.height/2)),o.lineTo(0,t.height),o.lineTo(0,0),o.closePath(),o.fill(),o.fillRect(.75*t.width,0,.25*t.width,t.height),t},SymbolMorph.prototype.drawSymbolGears=function(t,e){var o=t.getContext("2d"),i=t.width,r=i/2,n=i/6;return o.strokeStyle=e.toString(),o.lineWidth=t.width/7,o.beginPath(),o.arc(r,r,i,radians(0),radians(360),!0),o.arc(r,r,1.5*n,radians(0),radians(360),!1),o.closePath(),o.clip(),o.moveTo(0,r),o.lineTo(i,r),o.stroke(),o.moveTo(r,0),o.lineTo(r,i),o.stroke(),o.moveTo(n,n),o.lineTo(i-n,i-n),o.stroke(),o.moveTo(i-n,n),o.lineTo(n,i-n),o.stroke(),t},SymbolMorph.prototype.drawSymbolFile=function(t,e){var o=t.getContext("2d"),i=Math.min(t.width,t.height)/2;return o.fillStyle=e.toString(),o.beginPath(),o.moveTo(0,0),o.lineTo(i,0),o.lineTo(i,i),o.lineTo(t.width,i),o.lineTo(t.width,t.height),o.lineTo(0,t.height),o.closePath(),o.fill(),o.fillStyle=e.darker(25).toString(),o.beginPath(),o.moveTo(i,0),o.lineTo(t.width,i),o.lineTo(i,i),o.lineTo(i,0),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolFullScreen=function(t,e){var o=t.getContext("2d"),i=t.height,r=t.width/2,n=t.width/20,s=t.width/2;return o.strokeStyle=e.toString(),o.lineWidth=t.width/5,o.moveTo(r-n,r+n),o.lineTo(0,i),o.stroke(),o.strokeStyle=e.toString(),o.lineWidth=t.width/5,o.moveTo(r+n,r-n),o.lineTo(i,0),o.stroke(),o.fillStyle=e.toString(),o.beginPath(),o.moveTo(0,i),o.lineTo(0,i-s),o.lineTo(s,i),o.closePath(),o.fill(),o.fillStyle=e.toString(),o.beginPath(),o.moveTo(i,0),o.lineTo(i-s,0),o.lineTo(i,s),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolNormalScreen=function(t,e){var o=t.getContext("2d"),i=t.height,r=t.width/2,n=t.width/20,s=t.width;return o.strokeStyle=e.toString(),o.lineWidth=t.width/5,o.moveTo(r-3*n,r+3*n),o.lineTo(0,i),o.stroke(),o.strokeStyle=e.toString(),o.lineWidth=t.width/5,o.moveTo(r+3*n,r-3*n),o.lineTo(i,0),o.stroke(),o.fillStyle=e.toString(),o.beginPath(),o.moveTo(r+n,r-n),o.lineTo(s,r-n),o.lineTo(r+n,0),o.closePath(),o.fill(),o.fillStyle=e.toString(),o.beginPath(),o.moveTo(r-n,r+n),o.lineTo(0,r+n),o.lineTo(r-n,s),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolSmallStage=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.height,n=i/2,s=r/2;return o.fillStyle=e.darker(40).toString(),o.fillRect(0,0,i,r),o.fillStyle=e.toString(),o.fillRect(n,0,n,s),t},SymbolMorph.prototype.drawSymbolNormalStage=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.height,n=i/2,s=r/2;return o.fillStyle=e.toString(),o.fillRect(0,0,i,r),o.fillStyle=e.darker(25).toString(),o.fillRect(n,0,n,s),t},SymbolMorph.prototype.drawSymbolTurtle=function(t,e){var o=t.getContext("2d");return o.fillStyle=e.toString(),o.beginPath(),o.moveTo(0,0),o.lineTo(t.width,t.height/2),o.lineTo(0,t.height),o.lineTo(t.height/2,t.height/2),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolTurtleOutline=function(t,e){var o=t.getContext("2d");return o.strokeStyle=e.toString(),o.beginPath(),o.moveTo(0,0),o.lineTo(t.width,t.height/2),o.lineTo(0,t.height),o.lineTo(t.height/2,t.height/2),o.closePath(),o.stroke(),t},SymbolMorph.prototype.drawSymbolPause=function(t,e){var o=t.getContext("2d"),i=t.width/5;return o.fillStyle=e.toString(),o.fillRect(0,0,2*i,t.height),o.fillRect(3*i,0,2*i,t.height),t},SymbolMorph.prototype.drawSymbolFlag=function(t,e){var o=t.getContext("2d"),i=t.width,r=Math.max(i/12,1),n=t.height;return o.lineWidth=r,o.strokeStyle=e.toString(),o.beginPath(),o.moveTo(r/2,0),o.lineTo(r/2,t.height),o.stroke(),o.lineWidth=n/2,o.beginPath(),o.moveTo(0,n/4),o.bezierCurveTo(.8*i,n/4,.1*i,.5*n,i,.5*n),o.stroke(),t},SymbolMorph.prototype.drawSymbolOctagon=function(t,e){var o=t.getContext("2d"),i=t.width,r=(i-.383*i)/2;return o.fillStyle=e.toString(),o.beginPath(),o.moveTo(r,0),o.lineTo(i-r,0),o.lineTo(i,r),o.lineTo(i,i-r),o.lineTo(i-r,i),o.lineTo(r,i),o.lineTo(0,i-r),o.lineTo(0,r),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolCloud=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.height,n=2*r/5,s=r/4,a=3*r/10,h=r/5;return o.fillStyle=e.toString(),o.beginPath(),o.arc(s,r-s,s,radians(90),radians(259),!1),o.arc(i/20*5,r/9*4,h,radians(165),radians(300),!1),o.arc(i/20*11,n,n,radians(200),radians(357),!1),o.arc(i-a,r-a,a,radians(269),radians(90),!1),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolCloudGradient=function(t,e){var o,i=t.getContext("2d"),r=t.width,n=t.height,s=2*n/5,a=n/4,h=3*n/10,l=n/5;return(o=i.createRadialGradient(0,0,0,0,0,r)).addColorStop(0,e.lighter(25).toString()),o.addColorStop(1,e.darker(25).toString()),i.fillStyle=o,i.beginPath(),i.arc(a,n-a,a,radians(90),radians(259),!1),i.arc(r/20*5,n/9*4,l,radians(165),radians(300),!1),i.arc(r/20*11,s,s,radians(200),radians(357),!1),i.arc(r-h,n-h,h,radians(269),radians(90),!1),i.closePath(),i.fill(),t},SymbolMorph.prototype.drawSymbolCloudOutline=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.height,n=2*r/5,s=r/4,a=3*r/10,h=r/5;return o.strokeStyle=e.toString(),o.beginPath(),o.arc(s+1,r-s-1,s,radians(90),radians(259),!1),o.arc(i/20*5,r/9*4,h,radians(165),radians(300),!1),o.arc(i/20*11,n+1,n,radians(200),radians(357),!1),o.arc(i-a-1,r-a-1,a,radians(269),radians(90),!1),o.closePath(),o.stroke(),t},SymbolMorph.prototype.drawSymbolTurnRight=function(t,e){var o=t.getContext("2d"),i=t.width,r=Math.max(i/10,1),n=i/2;return o.lineWidth=r,o.strokeStyle=e.toString(),o.beginPath(),o.arc(n,2*n,n-r/2,radians(0),radians(-90),!1),o.stroke(),o.fillStyle=e.toString(),o.beginPath(),o.moveTo(i,n),o.lineTo(n,0),o.lineTo(n,2*n),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolTurnLeft=function(t,e){var o=t.getContext("2d"),i=t.width,r=Math.max(i/10,1),n=i/2;return o.lineWidth=r,o.strokeStyle=e.toString(),o.beginPath(),o.arc(n,2*n,n-r/2,radians(180),radians(-90),!0),o.stroke(),o.fillStyle=e.toString(),o.beginPath(),o.moveTo(0,n),o.lineTo(n,0),o.lineTo(n,2*n),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolStorage=function(t,e){function o(t,o){i.fillStyle=e.toString(),i.beginPath(),i.arc(r/2,t-n,s,radians(60),radians(120),!1),i.lineTo(0,t-2*a),i.arc(r/2,t-n-2*a,s,radians(120),radians(60),!0),i.closePath(),i.fill(),i.fillStyle=e.darker(25).toString(),i.beginPath(),o&&i.arc(r/2,t-n-2*a,s,radians(120),radians(60),!0),i.arc(r/2,t+6*a+1,s,radians(60),radians(120),!0),i.closePath(),o?i.fill():i.stroke()}var i=t.getContext("2d"),r=t.width,n=t.height,s=t.height,a=t.height/11;return i.strokeStyle=e.toString(),o(n),o(n-3*a),o(n-6*a,!1),t},SymbolMorph.prototype.drawSymbolPoster=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.height,n=.75*r,s=t.height/5;return o.fillStyle=e.toString(),o.strokeStyle=e.toString(),o.lineWidth=i/15,o.moveTo(i/2,r/3),o.lineTo(i/6,r),o.stroke(),o.moveTo(i/2,r/3),o.lineTo(i/2,r),o.stroke(),o.moveTo(i/2,r/3),o.lineTo(5*i/6,r),o.stroke(),o.fillRect(0,0,i,n),o.clearRect(0,n,i,i/20),o.clearRect(i-s,n-s,s+1,s+1),o.fillStyle=e.darker(25).toString(),o.beginPath(),o.moveTo(i,n-s),o.lineTo(i-s,n-s),o.lineTo(i-s,n),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolFlash=function(t,e){var o=t.getContext("2d"),i=t.width,r=i/3,n=t.height,s=n/3,a=s/3;return o.fillStyle=e.toString(),o.beginPath(),o.moveTo(r,0),o.lineTo(0,s),o.lineTo(r,s),o.lineTo(0,2*s),o.lineTo(r,2*s),o.lineTo(0,n),o.lineTo(i,2*s-a),o.lineTo(2*r,2*s-a),o.lineTo(i,s-a),o.lineTo(2*r,s-a),o.lineTo(i,0),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolBrush=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.height,n=Math.max(i/30,.5);return o.fillStyle=e.toString(),o.lineWidth=2*n,o.beginPath(),o.moveTo(i/8*3,r/2),o.quadraticCurveTo(0,r/2,n,r-n),o.quadraticCurveTo(i/2,r,i/2,r/8*5),o.closePath(),o.fill(),o.lineJoin="round",o.lineCap="round",o.strokeStyle=e.toString(),o.moveTo(i/8*3,r/2),o.lineTo(.75*i,n),o.quadraticCurveTo(i,0,i-n,.25*r),o.stroke(),o.moveTo(i/2,r/8*5),o.lineTo(i-n,.25*r),o.stroke(),t},SymbolMorph.prototype.drawSymbolRectangle=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.width,n=Math.max(i/20,.5);return o.strokeStyle=e.toString(),o.lineWidth=2*n,o.beginPath(),o.moveTo(n,n),o.lineTo(i-n,n),o.lineTo(i-n,r-n),o.lineTo(n,r-n),o.closePath(),o.stroke(),t},SymbolMorph.prototype.drawSymbolRectangleSolid=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.width;return o.fillStyle=e.toString(),o.beginPath(),o.moveTo(0,0),o.lineTo(i,0),o.lineTo(i,r),o.lineTo(0,r),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolCircle=function(t,e){var o=t.getContext("2d"),i=t.width,r=Math.max(i/20,.5);return o.strokeStyle=e.toString(),o.lineWidth=2*r,o.arc(i/2,i/2,i/2-r,radians(0),radians(360),!1),o.stroke(),t},SymbolMorph.prototype.drawSymbolCircleSolid=function(t,e){var o=t.getContext("2d"),i=t.width;return o.fillStyle=e.toString(),o.arc(i/2,i/2,i/2,radians(0),radians(360),!1),o.fill(),t},SymbolMorph.prototype.drawSymbolLine=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.height,n=Math.max(i/20,.5);return o.strokeStyle=e.toString(),o.lineWidth=2*n,o.lineCap="round",o.moveTo(n,n),o.lineTo(i-n,r-n),o.stroke(),t},SymbolMorph.prototype.drawSymbolCross=function(t,e){var o=t.getContext("2d"),i=t.width,r=Math.max(i/20,.5);return o.strokeStyle=e.toString(),o.lineWidth=2*r,o.lineCap="round",o.moveTo(r,i/2),o.lineTo(i-r,i/2),o.stroke(),o.moveTo(i/2,r),o.lineTo(i/2,i-r),o.stroke(),t},SymbolMorph.prototype.drawSymbolCrosshairs=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.height,n=.5;return o.strokeStyle=e.toString(),o.lineWidth=1,o.moveTo(n,r/2),o.lineTo(i-n,r/2),o.stroke(),o.moveTo(i/2,n),o.lineTo(i/2,r-n),o.stroke(),o.moveTo(i/2,r/2),o.arc(i/2,i/2,i/3-n,radians(0),radians(360),!1),o.stroke(),t},SymbolMorph.prototype.drawSymbolPaintbucket=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.height,n=t.width/5,s=Math.max(i/30,.5);return o.strokeStyle=e.toString(),o.lineWidth=2*s,o.beginPath(),o.moveTo(2*n,n),o.lineTo(4*n,3*n),o.lineTo(3*n,4*n),o.quadraticCurveTo(2*n,r,n,4*n),o.quadraticCurveTo(0,3*n,n,2*n),o.closePath(),o.stroke(),o.lineWidth=s,o.moveTo(2*n,2.5*n),o.arc(2*n,2.5*n,s,radians(0),radians(360),!1),o.stroke(),o.moveTo(2*n,2.5*n),o.lineTo(2*n,n/2+s),o.stroke(),o.arc(1.5*n,n/2+s,n/2,radians(0),radians(180),!0),o.stroke(),o.moveTo(n,n/2+s),o.lineTo(n,2*n),o.stroke(),o.fillStyle=e.toString(),o.beginPath(),o.moveTo(3.5*n,3.5*n),o.quadraticCurveTo(i,3.5*n,i-s,r),o.lineTo(i,r),o.quadraticCurveTo(i,2*n,2.5*n,1.5*n),o.lineTo(4*n,3*n),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolEraser=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.height,n=t.width/4,s=Math.max(i/20,.5);return o.strokeStyle=e.toString(),o.lineWidth=2*s,o.beginPath(),o.moveTo(3*n,s),o.lineTo(s,3*n),o.quadraticCurveTo(n,r,2*n,3*n),o.lineTo(i-s,n),o.closePath(),o.stroke(),o.fillStyle=e.toString(),o.beginPath(),o.moveTo(3*n,0),o.lineTo(1.5*n,1.5*n),o.lineTo(2.5*n,2.5*n),o.lineTo(i,n),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolPipette=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.height,n=t.width/4,s=n/2,a=Math.max(i/20,.5);return o.strokeStyle=e.toString(),o.lineWidth=2*a,o.beginPath(),o.moveTo(a,r-a),o.quadraticCurveTo(s,r-s,s,r-n),o.lineTo(2*n,1.5*n),o.stroke(),o.beginPath(),o.moveTo(a,r-a),o.quadraticCurveTo(s,r-s,n,r-s),o.lineTo(2.5*n,2*n),o.stroke(),o.fillStyle=e.toString(),o.arc(3*n,n,n-a,radians(0),radians(360),!1),o.fill(),o.beginPath(),o.moveTo(2*n,n),o.lineTo(3*n,2*n),o.stroke(),t},SymbolMorph.prototype.drawSymbolSpeechBubble=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.height,n=t.width/3,s=Math.max(i/20,.5);return o.fillStyle=e.toString(),o.lineWidth=2*s,o.beginPath(),o.moveTo(n,2*n),o.quadraticCurveTo(s,2*n,s,n),o.quadraticCurveTo(s,s,n,s),o.lineTo(2*n,s),o.quadraticCurveTo(i-s,s,i-s,n),o.quadraticCurveTo(i-s,2*n,2*n,2*n),o.lineTo(n/2,r-s),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolSpeechBubbleOutline=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.height,n=t.width/3,s=Math.max(i/20,.5);return o.strokeStyle=e.toString(),o.lineWidth=2*s,o.beginPath(),o.moveTo(n,2*n),o.quadraticCurveTo(s,2*n,s,n),o.quadraticCurveTo(s,s,n,s),o.lineTo(2*n,s),o.quadraticCurveTo(i-s,s,i-s,n),o.quadraticCurveTo(i-s,2*n,2*n,2*n),o.lineTo(n/2,r-s),o.closePath(),o.stroke(),t},SymbolMorph.prototype.drawSymbolTurnBack=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.height,n=t.width/2,s=t.height/2,a=Math.max(i/20,.5);return o.fillStyle=e.toString(),o.lineWidth=2*a,o.beginPath(),o.moveTo(0,s),o.lineTo(n,0),o.lineTo(n,r),o.closePath(),o.fill(),o.lineWidth=3*a,o.strokeStyle=e.toString(),o.beginPath(),o.arc(n,r,s,radians(0),radians(-90),!0),o.stroke(),t},SymbolMorph.prototype.drawSymbolTurnForward=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.height,n=t.width/2,s=t.height/2,a=Math.max(i/20,.5);return o.fillStyle=e.toString(),o.lineWidth=2*a,o.beginPath(),o.moveTo(i,s),o.lineTo(n,0),o.lineTo(n,r),o.closePath(),o.fill(),o.lineWidth=3*a,o.strokeStyle=e.toString(),o.beginPath(),o.arc(n,r,s,radians(-180),radians(-90),!1),o.stroke(),t},SymbolMorph.prototype.drawSymbolArrowUp=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.height,n=t.width/2,s=Math.max(i/20,.5);return o.fillStyle=e.toString(),o.lineWidth=2*s,o.beginPath(),o.moveTo(s,n),o.lineTo(n,s),o.lineTo(i-s,n),o.lineTo(.65*i,n),o.lineTo(.65*i,r-s),o.lineTo(.35*i,r-s),o.lineTo(.35*i,n),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolArrowUpOutline=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.height,n=t.width/2,s=Math.max(i/20,.5);return o.strokeStyle=e.toString(),o.lineWidth=2*s,o.beginPath(),o.moveTo(s,n),o.lineTo(n,s),o.lineTo(i-s,n),o.lineTo(.65*i,n),o.lineTo(.65*i,r-s),o.lineTo(.35*i,r-s),o.lineTo(.35*i,n),o.closePath(),o.stroke(),t},SymbolMorph.prototype.drawSymbolArrowDown=function(t,e){var o=t.getContext("2d"),i=t.width;return o.save(),o.translate(i,i),o.rotate(radians(180)),this.drawSymbolArrowUp(t,e),o.restore(),t},SymbolMorph.prototype.drawSymbolArrowDownOutline=function(t,e){var o=t.getContext("2d"),i=t.width;return o.save(),o.translate(i,i),o.rotate(radians(180)),this.drawSymbolArrowUpOutline(t,e),o.restore(),t},SymbolMorph.prototype.drawSymbolArrowLeft=function(t,e){var o=t.getContext("2d"),i=t.width;return o.save(),o.translate(0,i),o.rotate(radians(-90)),this.drawSymbolArrowUp(t,e),o.restore(),t},SymbolMorph.prototype.drawSymbolArrowLeftOutline=function(t,e){var o=t.getContext("2d"),i=t.width;return o.save(),o.translate(0,i),o.rotate(radians(-90)),this.drawSymbolArrowUpOutline(t,e),o.restore(),t},SymbolMorph.prototype.drawSymbolArrowRight=function(t,e){var o=t.getContext("2d"),i=t.width;return o.save(),o.translate(i,0),o.rotate(radians(90)),this.drawSymbolArrowUp(t,e),o.restore(),t},SymbolMorph.prototype.drawSymbolArrowRightOutline=function(t,e){var o=t.getContext("2d"),i=t.width;return o.save(),o.translate(i,0),o.rotate(radians(90)),this.drawSymbolArrowUpOutline(t,e),o.restore(),t},SymbolMorph.prototype.drawSymbolRobot=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.height,n=t.width/6,s=n/2,a=Math.max(i/20,.5);return o.fillStyle=e.toString(),o.beginPath(),o.moveTo(n+a,n),o.lineTo(2*n,n),o.lineTo(2.5*n,1.5*n),o.lineTo(3.5*n,1.5*n),o.lineTo(4*n,n),o.lineTo(5*n-a,n),o.lineTo(4*n,3*n),o.lineTo(4*n,4*n-a),o.lineTo(2*n,4*n-a),o.lineTo(2*n,3*n),o.closePath(),o.fill(),o.beginPath(),o.moveTo(2.75*n,n+a),o.lineTo(2.4*n,n),o.lineTo(2.2*n,0),o.lineTo(3.8*n,0),o.lineTo(3.6*n,n),o.lineTo(3.25*n,n+a),o.closePath(),o.fill(),o.beginPath(),o.moveTo(2.5*n,4*n),o.lineTo(n,4*n),o.lineTo(s+a,r),o.lineTo(2*n,r),o.closePath(),o.fill(),o.beginPath(),o.moveTo(3.5*n,4*n),o.lineTo(5*n,4*n),o.lineTo(i-(s+a),r),o.lineTo(4*n,r),o.closePath(),o.fill(),o.beginPath(),o.moveTo(n,n),o.lineTo(a,1.5*n),o.lineTo(a,3.25*n),o.lineTo(1.5*n,3.5*n),o.closePath(),o.fill(),o.beginPath(),o.moveTo(5*n,n),o.lineTo(i-a,1.5*n),o.lineTo(i-a,3.25*n),o.lineTo(4.5*n,3.5*n),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolMagnifyingGlass=function(t,e){var o,i=t.getContext("2d"),r=t.width,n=t.height,s=.3*r,a=2*r/3-Math.sqrt(s),h=n/3+Math.sqrt(s),l=Math.max(r/5,.5);return i.strokeStyle=e.toString(),(o=i.createRadialGradient(a,h,0,a+s,h+s,r)).addColorStop(0,e.inverted().lighter(50).toString()),o.addColorStop(1,e.inverted().darker(25).toString()),i.fillStyle=o,i.arc(a,h,s,radians(0),radians(360),!1),i.fill(),i.lineWidth=l/2,i.arc(a,h,s,radians(0),radians(360),!1),i.stroke(),i.lineWidth=l,i.beginPath(),i.moveTo(l/2,n-l/2),i.lineTo(a-Math.sqrt(s+l),h+Math.sqrt(s+l)),i.closePath(),i.stroke(),t},SymbolMorph.prototype.drawSymbolMagnifierOutline=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.height,n=.3*i,s=2*i/3-Math.sqrt(n),a=r/3+Math.sqrt(n),h=Math.max(i/5,.5);return o.strokeStyle=e.toString(),o.lineWidth=.5*h,o.arc(s,a,n,radians(0),radians(360),!1),o.stroke(),o.lineWidth=h,o.beginPath(),o.moveTo(h/2,r-h/2),o.lineTo(s-Math.sqrt(n+h),a+Math.sqrt(n+h)),o.closePath(),o.stroke(),t},SymbolMorph.prototype.drawSymbolNotes=function(t,e){var o=t.getContext("2d"),i=t.width,r=i/6,n=Math.max(r/3,1);return o.strokeStyle=e.toString(),o.fillStyle=e.toString(),o.arc(r,i-r,r,radians(0),radians(360),!1),o.fill(),o.arc(i-r,i-2*r,r,radians(0),radians(360),!1),o.fill(),o.beginPath(),o.moveTo(2*r-n,r),o.lineTo(i,0),o.lineTo(i,r),o.lineTo(2*r-n,2*r),o.closePath(),o.fill(),o.lineWidth=n,o.beginPath(),o.moveTo(2*r-n/2,i-r),o.lineTo(2*r-n/2,r+n),o.stroke(),o.beginPath(),o.moveTo(i-n/2,i-2*r),o.lineTo(i-n/2,n),o.stroke(),t},SymbolMorph.prototype.drawSymbolCamera=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.width,n=.16*i,s=Math.max(i/20,.5);return o.lineWidth=2*s,o.fillStyle=e.toString(),o.beginPath(),o.moveTo(s,5*r/6),o.lineTo(i-s,5*r/6),o.lineTo(i-s,r/4),o.lineTo(3*i/4,r/4),o.lineTo(5*i/8,s),o.lineTo(3*i/8,s),o.lineTo(i/4,r/4),o.lineTo(s,r/4),o.closePath(),o.fill(),o.save(),o.globalCompositeOperation="destination-out",o.beginPath(),o.arc(i/2,r/2,n,radians(0),radians(360),!1),o.fill(),o.restore(),t},SymbolMorph.prototype.drawSymbolLocation=function(t,e){var o=t.getContext("2d"),i=t.width,r=t.height,n=i/2;return o.fillStyle=e.toString(),o.beginPath(),o.arc(n,n,n,radians(-210),radians(30),!1),o.lineTo(n,r),o.closePath(),o.fill(),o.globalCompositeOperation="destination-out",o.beginPath(),o.arc(n,n,.5*n,radians(0),radians(360),!1),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolFootprints=function(t,e){var o=t.getContext("2d"),i=t.width,r=i/10,n=1.5*r;return o.fillStyle=e.toString(),o.beginPath(),o.arc(n,n,n,radians(-200),radians(0),!1),o.lineTo(2*n,5.5*r),o.lineTo(r,6*r),o.closePath(),o.fill(),o.beginPath(),o.arc(2.25*r,6.75*r,r,radians(-40),radians(-170),!1),o.closePath(),o.fill(),o.beginPath(),o.arc(i-n,4.5*r,n,radians(-180),radians(20),!1),o.lineTo(i-r,8.5*r),o.lineTo(i-2*n,8*r),o.closePath(),o.fill(),o.beginPath(),o.arc(i-2.25*r,9*r,r,radians(0),radians(-150),!1),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolKeyboard=function(t,e){var o,i,r=t.getContext("2d"),n=t.height,s=n/10,a=n/5;for(r.fillStyle=e.toString(),o=0;o<2;o+=1)for(i=0;i<5;i+=1)r.fillRect((s+a)*i+s,(s+a)*o+s,a,a);return r.fillRect(4*s,7*s,4*a,a),t},SymbolMorph.prototype.drawSymbolKeyboardFilled=function(t,e){var o,i,r=t.getContext("2d"),n=t.width,s=t.height,a=s/10,h=s/5;for(r.fillStyle=e.toString(),r.fillRect(0,0,n,s),r.globalCompositeOperation="destination-out",o=0;o<2;o+=1)for(i=0;i<5;i+=1)r.fillRect((a+h)*i+a,(a+h)*o+a,h,h);return r.fillRect(4*a,7*a,4*h,h),t},modules.xml="2017-November-15";var ReadStream,XML_Element;ReadStream.prototype.nonSpace=/\S|$/g,ReadStream.prototype.nonWord=/[\s\>\/\=]|$/g,ReadStream.prototype.next=function(t){var e,o;return void 0===t?(e=this.contents[this.index],this.index+=1,e):(o=this.index,this.index+=t,this.contents.slice(o,this.index))},ReadStream.prototype.peek=function(){return this.contents[this.index]},ReadStream.prototype.skip=function(t){this.index+=t||1},ReadStream.prototype.atEnd=function(){return this.index>this.contents.length-1},ReadStream.prototype.upTo=function(t){var e=this.contents.indexOf(t,this.index);return-1===e?"":this.contents.slice(this.index,this.index=e)},ReadStream.prototype.peekUpTo=function(t){var e=this.contents.indexOf(t,this.index);return-1===e?"":this.contents.slice(this.index,e)},ReadStream.prototype.skipSpace=function(){this.nonSpace.lastIndex=this.index;var t=this.nonSpace.exec(this.contents);t&&(this.index=t.index)},ReadStream.prototype.word=function(){this.nonWord.lastIndex=this.index;var t=this.nonWord.exec(this.contents);return t?this.contents.slice(this.index,this.index=t.index):""},XML_Element.prototype=Object.create(Node.prototype),XML_Element.prototype.constructor=XML_Element,XML_Element.uber=Node.prototype,XML_Element.prototype.indentation="  ",XML_Element.prototype.init=function(t,e,o){this.tag=t||"unnamed",this.attributes={},this.contents=e||"",XML_Element.uber.init.call(this),o&&o.addChild(this)},XML_Element.prototype.require=function(t){var e=this.childNamed(t);if(!e)throw new Error("Missing required element <"+t+">!");return e},XML_Element.prototype.childNamed=function(t){return detect(this.children,function(e){return e.tag===t})},XML_Element.prototype.childrenNamed=function(t){return this.children.filter(function(e){return e.tag===t})},XML_Element.prototype.parentNamed=function(t){return this.tag===t?this:this.parent?this.parent.parentNamed(t):null},XML_Element.prototype.toString=function(t,e){var o,i,r="",n="",s=e||0;if(t){for(i=0;i<s;i+=1)n+=this.indentation;r+=n}r+="<"+this.tag;for(o in this.attributes)Object.prototype.hasOwnProperty.call(this.attributes,o)&&this.attributes[o]&&(r+=" "+o+'="'+this.escape(this.attributes[o])+'"');return this.contents.length||this.children.length?(r+=">",r+=this.escape(this.contents),this.children.forEach(function(e){t&&(r+="\n"),r+=e.toString(t,s+1)}),t&&this.children.length&&(r+="\n"+n),r+="</"+this.tag+">"):r+="/>",r},XML_Element.prototype.escape=function(t,e){var o,i,r=isNil(t)?"":t.toString(),n="";for(o=0;o<r.length;o+=1)switch(i=r[o]){case"'":n+="&apos;";break;case'"':n+=e?i:"&quot;";break;case"<":n+="&lt;";break;case">":n+="&gt;";break;case"&":n+="&amp;";break;case"\n":n+="&#xD;";break;case"~":n+="&#126;";break;default:n+=i}return n},XML_Element.prototype.unescape=function(t){return t.replace(/&(amp|apos|quot|lt|gt|#xD|#126);/g,function(t,e){switch(e){case"amp":return"&";case"apos":return"'";case"quot":return'"';case"lt":return"<";case"gt":return">";case"#xD":return"\n";case"#126":return"~";default:console.warn("unreachable")}})},XML_Element.prototype.parseString=function(t){var e=new ReadStream(t);e.upTo("<"),e.skip(),this.parseStream(e)},XML_Element.prototype.parseStream=function(t){var e,o,i;for(this.tag=t.word(),t.skipSpace(),i=t.peek();">"!==i&&"/"!==i;){if(e=t.word(),t.skipSpace(),"="!==t.next())throw new Error('Expected "=" after attribute name');if(t.skipSpace(),'"'!==(i=t.next())&&"'"!==i)throw new Error("Expected single- or double-quoted attribute value");o=t.upTo(i),t.skip(1),t.skipSpace(),this.attributes[e]=this.unescape(o),i=t.peek()}if("/"!==i){if(">"!==t.next())throw new Error('Expected ">" after tag name and attributes');for(;!t.atEnd();)if("<"===(i=t.next())){if("/"===t.peek()){if(t.skip(),t.word()!==this.tag)throw new Error("Expected to close "+this.tag);return t.upTo(">"),t.skip(),void(this.contents=this.unescape(this.contents))}new XML_Element(null,null,this).parseStream(t)}else this.contents+=i}else if(t.skip(),">"!==t.next())throw new Error('Expected ">" after "/" in empty tag')},modules.store="2017-December-01",XML_Serializer.prototype.idProperty="serializationID",XML_Serializer.prototype.mediaIdProperty="serializationMediaID",XML_Serializer.prototype.mediaDetectionProperty="isMedia",XML_Serializer.prototype.version=1,XML_Serializer.prototype.serialize=function(t,e){var o;return this.flush(),this.flushMedia(),this.isExportingBlocksLibrary=e,o=this.store(t),this.flush(),o},XML_Serializer.prototype.store=function(t,e){return isNil(t)||!t.toXML?"":this.isCollectingMedia&&t[this.mediaDetectionProperty]?(this.addMedia(t,e),this.format('<ref mediaID="@"></ref>',t[this.mediaIdProperty])):t[this.idProperty]?this.format('<ref id="@"></ref>',t[this.idProperty]):(this.add(t),t.toXML(this,e).replace("~",this.format('id="@"',t[this.idProperty])))},XML_Serializer.prototype.mediaXML=function(){var t="<media>",e=this;return this.media.forEach(function(o){var i=o.toXML(e).replace("~",e.format('mediaID="@"',o[e.mediaIdProperty]));t+=i}),t+"</media>"},XML_Serializer.prototype.add=function(t){return t[this.idProperty]?-1:(this.contents.push(t),t[this.idProperty]=this.contents.length,this.contents.length)},XML_Serializer.prototype.addMedia=function(t,e){return t[this.mediaIdProperty]?-1:(this.media.push(t),t[this.mediaIdProperty]=e?e+"_"+t.name:this.media.length,this.media.length)},XML_Serializer.prototype.at=function(t){return this.contents[t-1]},XML_Serializer.prototype.flush=function(){var t=this;this.contents.forEach(function(e){delete e[t.idProperty]}),this.contents=[]},XML_Serializer.prototype.flushMedia=function(){var t=this;this.media instanceof Array&&this.media.forEach(function(e){delete e[t.mediaIdProperty]}),this.media=[],this.isExportingBlocksLibrary=!1},XML_Serializer.prototype.escape=XML_Element.prototype.escape,XML_Serializer.prototype.unescape=XML_Element.prototype.unescape,XML_Serializer.prototype.format=function(t){var e,o=this,i=-1,r=arguments;return t.replace(/[@$%]([\d]+)?/g,function(t,n){return n=parseInt(n,10),e=isNaN(n)?r[(i+=1)+1]:r[n+1],"@"===t?o.escape(e):"$"===t?o.escape(e,!0):e})},XML_Serializer.prototype.load=function(t){throw nop(t),new Error("loading should be implemented in heir of XML_Serializer")},XML_Serializer.prototype.parse=function(t){var e=new XML_Element;return e.parseString(t),e};var SnapSerializer;SnapSerializer.prototype=new XML_Serializer,SnapSerializer.prototype.constructor=SnapSerializer,SnapSerializer.uber=XML_Serializer.prototype,SnapSerializer.prototype.app="Snap! 4.1, http://snap.berkeley.edu",SnapSerializer.prototype.thumbnailSize=new Point(160,120),SnapSerializer.prototype.watcherLabels={xPosition:"x position",yPosition:"y position",direction:"direction",getScale:"size",getTempo:"tempo",getLastAnswer:"answer",getLastMessage:"message",getTimer:"timer",getCostumeIdx:"costume #",reportMouseX:"mouse x",reportMouseY:"mouse y",reportThreadCount:"processes"},SnapSerializer.prototype.init=function(){this.project={},this.objects={},this.mediaDict={}},XML_Serializer.prototype.mediaXML=function(t){var e='<media name="'+(t||"untitled")+'" app="'+this.app+'" version="'+this.version+'">',o=this;return this.media.forEach(function(t){var i=t.toXML(o).replace("~",o.format('mediaID="@"',t[o.mediaIdProperty]));e+=i}),e+"</media>"},SnapSerializer.prototype.load=function(t,e){return this.loadProjectModel(this.parse(t),e)},SnapSerializer.prototype.loadProjectModel=function(t,e){var o=t.attributes.app,i=o?o.split(" ")[0]:null;return e&&i&&i!==this.app.split(" ")[0]&&e.inform(i+" Project","This project has been created by a different app:\n\n"+i+"\n\nand may be incompatible or fail to load here."),this.rawLoadProjectModel(t)},SnapSerializer.prototype.rawLoadProjectModel=function(t){var e,o,i=this,r={sprites:{}};if(this.project=r,e={project:t},+t.attributes.version>this.version)throw"Project uses newer version of Serializer";if(this.objects={},r.name=e.project.attributes.name,!r.name){for(o=1;Object.prototype.hasOwnProperty.call(localStorage,"-snap-project-Untitled "+o);)o+=1;r.name="Untitled "+o}return e.notes=e.project.childNamed("notes"),e.notes&&(r.notes=e.notes.contents),e.globalVariables=e.project.childNamed("variables"),r.globalVariables=new VariableFrame,e.stage=e.project.require("stage"),StageMorph.prototype.frameRate=0,r.stage=new StageMorph(r.globalVariables),Object.prototype.hasOwnProperty.call(e.stage.attributes,"id")&&(this.objects[e.stage.attributes.id]=r.stage),e.stage.attributes.name&&(r.stage.name=e.stage.attributes.name),"true"===e.stage.attributes.scheduled&&(r.stage.fps=30,StageMorph.prototype.frameRate=30),e.pentrails=e.stage.childNamed("pentrails"),e.pentrails&&(r.pentrails=new Image,r.pentrails.onload=function(){r.stage.trailsCanvas&&(normalizeCanvas(r.stage.trailsCanvas),r.stage.trailsCanvas.getContext("2d").drawImage(r.pentrails,0,0),r.stage.changed())},r.pentrails.src=e.pentrails.contents),r.stage.setTempo(e.stage.attributes.tempo),StageMorph.prototype.dimensions=new Point(480,360),e.stage.attributes.width&&(StageMorph.prototype.dimensions.x=Math.max(+e.stage.attributes.width,240)),e.stage.attributes.height&&(StageMorph.prototype.dimensions.y=Math.max(+e.stage.attributes.height,180)),r.stage.setExtent(StageMorph.prototype.dimensions),SpriteMorph.prototype.useFlatLineEnds="flat"===e.stage.attributes.lines,BooleanSlotMorph.prototype.isTernary="false"!==e.stage.attributes.ternary,r.stage.isThreadSafe="true"===e.stage.attributes.threadsafe,StageMorph.prototype.enableCodeMapping="true"===e.stage.attributes.codify,StageMorph.prototype.enableInheritance="false"!==e.stage.attributes.inheritance,StageMorph.prototype.enableSublistIDs="true"===e.stage.attributes.sublistIDs,e.hiddenPrimitives=e.project.childNamed("hidden"),e.hiddenPrimitives&&e.hiddenPrimitives.contents.split(" ").forEach(function(t){t&&(StageMorph.prototype.hiddenPrimitives[t]=!0)}),e.codeHeaders=e.project.childNamed("headers"),e.codeHeaders&&e.codeHeaders.children.forEach(function(t){StageMorph.prototype.codeHeaders[t.tag]=t.contents}),e.codeMappings=e.project.childNamed("code"),e.codeMappings&&e.codeMappings.children.forEach(function(t){StageMorph.prototype.codeMappings[t.tag]=t.contents}),e.globalBlocks=e.project.childNamed("blocks"),e.globalBlocks&&(this.loadCustomBlocks(r.stage,e.globalBlocks,!0),this.populateCustomBlocks(r.stage,e.globalBlocks,!0)),this.loadObject(r.stage,e.stage),e.sprites=e.stage.require("sprites"),r.sprites[r.stage.name]=r.stage,e.sprites.childrenNamed("sprite").forEach(function(t){i.loadValue(t)}),i.project.stage.children.forEach(function(t){var e,o;t.inheritanceInfo&&((e=i.project.sprites[t.inheritanceInfo.exemplar])&&t.setExemplar(e),t.inheritedAttributes=t.inheritanceInfo.delegated||[]),t.nestingInfo&&((o=i.project.sprites[t.nestingInfo.anchor])&&o.attachPart(t),t.rotatesWithAnchor="true"===t.nestingInfo.synch)}),i.project.stage.children.forEach(function(t){var e;t.nestingInfo&&(t.nestingScale=+(t.nestingInfo.scale||t.scale),delete t.nestingInfo),["scripts","costumes","sounds"].forEach(function(e){t.inheritsAttribute(e)&&t.refreshInheritedAttribute(e)}),t.inheritsAttribute("costumes")&&(e=t.costumes.asArray()[t.inheritanceInfo.costumeNumber-1])&&(e.loaded?t.wearCostume(e,!0):e.loaded=function(){t.wearCostume(e,!0),this.loaded=!0}),delete t.inheritanceInfo}),e.globalVariables&&this.loadVariables(r.globalVariables,e.globalVariables),this.objects={},e.sprites.childrenNamed("watcher").forEach(function(t){var e,o,n,s,a,h;o=i.loadColor(t.attributes.color),n=Object.prototype.hasOwnProperty.call(t.attributes,"scope")?r.sprites[t.attributes.scope]:null,s=Object.prototype.hasOwnProperty.call(t.attributes,"hidden")&&"false"!==t.attributes.hidden,(e=Object.prototype.hasOwnProperty.call(t.attributes,"var")?new WatcherMorph(t.attributes.var,o,isNil(n)?r.globalVariables:n.variables,t.attributes.var,s):new WatcherMorph(localize(i.watcherLabels[t.attributes.s]),o,n,t.attributes.s,s)).setStyle(t.attributes.style||"normal"),"slider"===e.style&&(e.setSliderMin(t.attributes.min||"1",!0),e.setSliderMax(t.attributes.max||"100",!0)),e.setPosition(r.stage.topLeft().add(new Point(+t.attributes.x||0,+t.attributes.y||0))),r.stage.add(e),e.onNextStep=function(){this.currentValue=null},e.currentValue instanceof List&&((a=t.attributes.extX)&&e.cellMorph.contentsMorph.setWidth(+a),(h=t.attributes.extY)&&e.cellMorph.contentsMorph.setHeight(+h),e.cellMorph.contentsMorph.handle.drawNew())}),i.project.stage.children.forEach(function(t){t.inheritedMethodsCache=[]}),this.objects={},r},SnapSerializer.prototype.loadBlocks=function(t,e){var o,i=new StageMorph;if(this.project={stage:i,sprites:{},targetStage:e},+(o=this.parse(t)).attributes.version>this.version)throw"Module uses newer version of Serializer";return this.loadCustomBlocks(i,o,!0),this.populateCustomBlocks(i,o,!0),this.objects={},i.globalBlocks.forEach(function(t){t.receiver=null}),this.objects={},this.project={},this.mediaDict={},i.globalBlocks},SnapSerializer.prototype.loadSprites=function(t,e){var o,i,r=this;if(i=this.project={globalVariables:e.globalVariables,stage:e.stage,sprites:{}},i.sprites[i.stage.name]=i.stage,+(o=this.parse(t)).attributes.version>this.version)throw"Module uses newer version of Serializer";o.childrenNamed("sprite").forEach(function(t){var o=new SpriteMorph(i.globalVariables);t.attributes.id&&(r.objects[t.attributes.id]=o),t.attributes.name&&(o.name=e.newSpriteName(t.attributes.name),i.sprites[o.name]=o),t.attributes.color&&(o.color=r.loadColor(t.attributes.color)),t.attributes.pen&&(o.penPoint=t.attributes.pen),i.stage.add(o),e.sprites.add(o),o.scale=parseFloat(t.attributes.scale||"1"),o.rotationStyle=parseFloat(t.attributes.rotation||"1"),o.isDraggable="false"!==t.attributes.draggable,o.isVisible="true"!==t.attributes.hidden,o.heading=parseFloat(t.attributes.heading)||0,o.drawNew(),o.gotoXY(+t.attributes.x||0,+t.attributes.y||0),r.loadObject(o,t)}),i.stage.children.forEach(function(t){var e,o;t.inheritanceInfo&&(e=i.sprites[t.inheritanceInfo.exemplar])&&t.setExemplar(e),t.nestingInfo&&((o=i.sprites[t.nestingInfo.anchor])&&o.attachPart(t),t.rotatesWithAnchor="true"===t.nestingInfo.synch)}),i.stage.children.forEach(function(t){delete t.inheritanceInfo,t.nestingInfo&&(t.nestingScale=+(t.nestingInfo.scale||t.scale),delete t.nestingInfo)}),this.objects={},this.project={},this.mediaDict={},e.createCorral(),e.fixLayout()},SnapSerializer.prototype.loadMedia=function(t){return this.loadMediaModel(this.parse(t))},SnapSerializer.prototype.loadMediaModel=function(t){var e=this,o=t;if(this.mediaDict={},+o.attributes.version>this.version)throw"Module uses newer version of Serializer";return o.children.forEach(function(t){e.loadValue(t)}),this.mediaDict},SnapSerializer.prototype.loadObject=function(t,e){var o=e.require("blocks"),i=e.childNamed("dispatches");e.attributes.instrument&&(t.instrument=+e.attributes.instrument),this.loadInheritanceInfo(t,e),this.loadNestingInfo(t,e),t.inheritanceInfo&&t.inheritanceInfo.delegated instanceof Array&&contains(t.inheritanceInfo.delegated,"costumes")||this.loadCostumes(t,e),t.inheritanceInfo&&t.inheritanceInfo.delegated instanceof Array&&contains(t.inheritanceInfo.delegated,"sounds")||this.loadSounds(t,e),this.loadCustomBlocks(t,o),i&&this.loadCustomBlocks(t,i,!1,!0),this.populateCustomBlocks(t,o),this.loadVariables(t.variables,e.require("variables"),t),t.inheritanceInfo&&t.inheritanceInfo.delegated instanceof Array&&contains(t.inheritanceInfo.delegated,"scripts")||this.loadScripts(t,t.scripts,e.require("scripts"))},SnapSerializer.prototype.loadInheritanceInfo=function(t,e){var o,i=e.childNamed("inherit");i&&(t.inheritanceInfo=i.attributes,(o=i.childNamed("list"))&&(t.inheritanceInfo.delegated=this.loadValue(o).asArray()),t.inheritanceInfo.costumeNumber=e.attributes.costume)},SnapSerializer.prototype.loadNestingInfo=function(t,e){var o=e.childNamed("nest");o&&(t.nestingInfo=o.attributes)},SnapSerializer.prototype.loadCostumes=function(t,e){var o,i=e.childNamed("costumes");i&&(t.costumes=this.loadValue(i.require("list")),t.costumes.type="costume"),Object.prototype.hasOwnProperty.call(e.attributes,"costume")&&(o=t.costumes.asArray()[e.attributes.costume-1])&&(o.loaded?t.wearCostume(o,!0):o.loaded=function(){t.wearCostume(o,!0),this.loaded=!0})},SnapSerializer.prototype.loadSounds=function(t,e){var o=e.childNamed("sounds");o&&(t.sounds=this.loadValue(o.require("list")),t.sounds.type="sound")},SnapSerializer.prototype.loadVariables=function(t,e,o){var i=this;e.children.forEach(function(e){var r,n;"variable"===e.tag&&(n=e.children[0],(r=new Variable).isTransient="true"===e.attributes.transient,r.value=r.isTransient||!n?0:i.loadValue(n,o),t.vars[e.attributes.name]=r)})},SnapSerializer.prototype.loadCustomBlocks=function(t,e,o,i){var r=this;e.children.forEach(function(e){var n,s,a,h,l,p,c,d,u;"block-definition"===e.tag&&((n=new CustomBlockDefinition(e.attributes.s||"",t)).category=e.attributes.category||"other",n.type=e.attributes.type||"command",n.isGlobal=!0===o,i?t.inheritedMethodsCache.push(n):n.isGlobal?t.globalBlocks.push(n):t.customBlocks.push(n),s=n.parseSpec(n.spec).filter(function(t){return"%"===t.charAt(0)&&t.length>1}).map(function(t){return t.substr(1)}),n.names=s,(a=e.childNamed("inputs"))&&(u=-1,a.children.forEach(function(t){var e=t.childNamed("options");"input"===t.tag&&(u+=1,n.declarations[s[u]]=[t.attributes.type,contains(["%b","%boolUE"],t.attributes.type)?t.contents?"true"===t.contents:null:t.contents,e?e.contents:void 0,"true"===t.attributes.readonly])})),(h=e.childNamed("variables"))&&(n.variableNames=r.loadValue(h.require("list")).asArray()),(l=e.childNamed("header"))&&(n.codeHeader=l.contents),(p=e.childNamed("code"))&&(n.codeMapping=p.contents),(c=e.childNamed("translations"))&&n.updateTranslations(c.contents),(d=e.childNamed("comment"))&&(n.comment=r.loadComment(d)))})},SnapSerializer.prototype.populateCustomBlocks=function(t,e,o){var i=this;e.children.forEach(function(e,r){var n,s,a;"block-definition"===e.tag&&(n=o?t.globalBlocks[r]:t.customBlocks[r],(s=e.childNamed("script"))&&(n.body=new Context(null,s?i.loadScript(s,t):null,null,t),n.body.inputs=n.names.slice(0)),(a=e.childNamed("scripts"))&&(n.scripts=i.loadScriptsArray(a,t)),delete n.names)})},SnapSerializer.prototype.loadScripts=function(t,e,o){var i=this,r=SyntaxElementMorph.prototype.scale;e.cachedTexture=IDE_Morph.prototype.scriptsPaneTexture,o.children.forEach(function(o){var n;if("script"===o.tag){if(!(n=i.loadScript(o,t)))return;n.setPosition(new Point((+o.attributes.x||0)*r,(+o.attributes.y||0)*r).add(e.topLeft())),e.add(n),n.fixBlockColor(null,!0),n.allComments().forEach(function(t){t.align(n)})}else if("comment"===o.tag){if(!(n=i.loadComment(o)))return;n.setPosition(new Point((+o.attributes.x||0)*r,(+o.attributes.y||0)*r).add(e.topLeft())),e.add(n)}})},SnapSerializer.prototype.loadScriptsArray=function(t,e){var o=this,i=SyntaxElementMorph.prototype.scale,r=[];return t.children.forEach(function(t){var n;if("script"===t.tag){if(!(n=o.loadScript(t,e)))return;n.setPosition(new Point((+t.attributes.x||0)*i,(+t.attributes.y||0)*i)),r.push(n),n.fixBlockColor(null,!0)}else if("comment"===t.tag){if(!(n=o.loadComment(t)))return;n.setPosition(new Point((+t.attributes.x||0)*i,(+t.attributes.y||0)*i)),r.push(n)}}),r},SnapSerializer.prototype.loadScript=function(t,e){var o,i,r,n=this;return t.children.forEach(function(t){if(r=n.loadBlock(t,!1,e)){if(i){if(!(i.nextBlock&&r instanceof CommandBlockMorph))return console.log("SNAP: expecting a command but getting a reporter:\n  "+i.blockSpec+"\n  "+r.blockSpec),o;i.nextBlock(r)}else o=r;i=r}}),o},SnapSerializer.prototype.loadComment=function(t){var e=new CommentMorph(t.contents),o=SyntaxElementMorph.prototype.scale;return e.isCollapsed="true"===t.attributes.collapsed,e.setTextWidth(+t.attributes.w*o),e},SnapSerializer.prototype.loadBlock=function(t,e,o){var i,r,n,s,a,h,l=0;if("block"===t.tag){if(Object.prototype.hasOwnProperty.call(t.attributes,"var"))return SpriteMorph.prototype.variableBlock(t.attributes.var);i=SpriteMorph.prototype.blockForSelector(t.attributes.s),(h=SpriteMorph.prototype.blockMigrations[t.attributes.s])&&(l=h.offset)}else if("custom-block"===t.tag){if(s=!t.attributes.scope,a=s?this.project.stage:o,s?!(r=detect(a.globalBlocks,function(e){return e.blockSpec()===t.attributes.s}))&&this.project.targetStage&&(r=detect(this.project.targetStage.globalBlocks,function(e){return e.blockSpec()===t.attributes.s})):r=detect(a.customBlocks,function(e){return e.blockSpec()===t.attributes.s})||(a.inheritedMethodsCache?detect(a.inheritedMethodsCache,function(e){return e.blockSpec()===t.attributes.s}):null),!r)return this.obsoleteBlock(e);i="command"===r.type?new CustomCommandBlockMorph(r,!1):new CustomReporterBlockMorph(r,"predicate"===r.type,!1)}return null===i&&(i=this.obsoleteBlock(e)),i.isDraggable=!0,n=i.inputs(),t.children.forEach(function(t,e){"variables"===t.tag?this.loadVariables(i.variables,t,o):"comment"===t.tag?(i.comment=this.loadComment(t),i.comment.block=i):"receiver"===t.tag?nop():this.loadInput(t,n[e+l],i,o)},this),i.cachedInputs=null,i},SnapSerializer.prototype.obsoleteBlock=function(t){var e=t?new ReporterBlockMorph:new CommandBlockMorph;return e.selector="errorObsolete",e.color=new Color(200,0,20),e.setSpec("Obsolete!"),e.isDraggable=!0,e},SnapSerializer.prototype.loadInput=function(t,e,o,i){var r,n=this;if(!isNil(e))if("script"===t.tag)(r=this.loadScript(t,i))&&(e.add(r),e.fixLayout());else if("autolambda"===t.tag&&t.children[0])(r=this.loadBlock(t.children[0],!0,i))&&(e.silentReplaceInput(e.children[0],r),e.fixLayout());else if("list"===t.tag){for(;e.inputs().length>0;)e.removeInput();t.children.forEach(function(t){e.addInput(),n.loadInput(t,e.children[e.children.length-2],e,i)}),e.fixLayout()}else"block"===t.tag||"custom-block"===t.tag?o.silentReplaceInput(e,this.loadBlock(t,!0,i)):"color"===t.tag?e.setColor(this.loadColor(t.contents)):isNil(this.loadValue(t))||isNil(e)||!e.setContents||e.setContents(this.loadValue(t))},SnapSerializer.prototype.loadValue=function(t,e){function o(){Object.prototype.hasOwnProperty.call(t.attributes,"id")&&(f.objects[t.attributes.id]=i),Object.prototype.hasOwnProperty.call(t.attributes,"mediaID")&&(f.mediaDict[t.attributes.mediaID]=i)}var i,r,n,s,a,h,l,p,c,d,u,g,f=this;switch(t.tag){case"ref":if(Object.prototype.hasOwnProperty.call(t.attributes,"id"))return this.objects[t.attributes.id];if(Object.prototype.hasOwnProperty.call(t.attributes,"mediaID"))return this.mediaDict[t.attributes.mediaID];throw new Error("expecting a reference id");case"l":return(d=t.childNamed("option"))?[d.contents]:(u=t.childNamed("bool"),u?this.loadValue(u):t.contents);case"bool":return"true"===t.contents;case"list":return t.attributes.hasOwnProperty("linked")?(i=new List,i.isLinked=!0,o(),n=i,(s=t.childrenNamed("item")).forEach(function(o,r){var n=o.children[0];i.first=n?f.loadValue(n,e):0;var a=t.childNamed("list")||t.childNamed("ref");a?i.rest=f.loadValue(a,e):r<s.length-1&&(i.rest=new List,(i=i.rest).isLinked=!0)}),n):(i=new List,o(),i.contents=t.childrenNamed("item").map(function(t){var o=t.children[0];return o?f.loadValue(o,e):0}),i);case"sprite":return i=new SpriteMorph(f.project.globalVariables),t.attributes.id&&(f.objects[t.attributes.id]=i),t.attributes.name&&(i.name=t.attributes.name,f.project.sprites[t.attributes.name]=i),t.attributes.idx&&(i.idx=+t.attributes.idx),t.attributes.color&&(i.color=f.loadColor(t.attributes.color)),t.attributes.pen&&(i.penPoint=t.attributes.pen),f.project.stage.add(i),i.scale=parseFloat(t.attributes.scale||"1"),i.rotationStyle=parseFloat(t.attributes.rotation||"1"),i.isDraggable="false"!==t.attributes.draggable,i.isVisible="true"!==t.attributes.hidden,i.heading=parseFloat(t.attributes.heading)||0,i.drawNew(),i.gotoXY(+t.attributes.x||0,+t.attributes.y||0),f.loadObject(i,t),i;case"context":return i=new Context(null),o(),(a=t.childNamed("origin"))&&(a=a.childNamed("ref")||a.childNamed("sprite"))&&(i.origin=this.loadValue(a)),(a=t.childNamed("receiver"))&&(a=a.childNamed("ref")||a.childNamed("sprite"))&&(i.receiver=this.loadValue(a)),g=i.origin||i.receiver||e,a=t.childNamed("script"),a?i.expression=this.loadScript(a,g):(a=t.childNamed("block")||t.childNamed("custom-block"))?i.expression=this.loadBlock(a,null,g):(a=t.childNamed("l"))&&(u=a.childNamed("bool"),i.expression=u?new BooleanSlotMorph(this.loadValue(u)):new InputSlotMorph(a.contents)),i.expression instanceof BlockMorph&&(r=0,i.expression.allEmptySlots().forEach(function(t){r+=1,t.bindingID=t instanceof MultiArgMorph?["arguments"]:r}),i.emptySlots=r),(a=t.childNamed("inputs"))&&a.children.forEach(function(t){"input"===t.tag&&i.inputs.push(t.contents)}),(a=t.childNamed("variables"))&&this.loadVariables(i.variables,a,g),(a=t.childNamed("context"))&&(i.outerContext=this.loadValue(a,g)),i.outerContext&&i.receiver&&!i.outerContext.variables.parentFrame&&(i.outerContext.variables.parentFrame=i.receiver.variables),i;case"costume":return h=new Point,Object.prototype.hasOwnProperty.call(t.attributes,"center-x")&&(h.x=parseFloat(t.attributes["center-x"])),Object.prototype.hasOwnProperty.call(t.attributes,"center-y")&&(h.y=parseFloat(t.attributes["center-y"])),Object.prototype.hasOwnProperty.call(t.attributes,"name")&&(p=t.attributes.name),Object.prototype.hasOwnProperty.call(t.attributes,"image")&&(l=new Image,0!==t.attributes.image.indexOf("data:image/svg+xml")||MorphicPreferences.rasterizeSVGs?(i=new Costume(null,p,h),l.onload=function(){var t=newCanvas(new Point(l.width,l.height),!0);t.getContext("2d").drawImage(l,0,0),i.contents=t,i.version=+new Date,"function"==typeof i.loaded?i.loaded():i.loaded=!0}):(i=new SVG_Costume(null,p,h),l.onload=function(){i.contents=l,i.version=+new Date,"function"==typeof i.loaded?i.loaded():i.loaded=!0}),l.src=t.attributes.image),o(),i;case"sound":return c=new Audio,c.src=t.attributes.sound,i=new Sound(c,t.attributes.name),Object.prototype.hasOwnProperty.call(t.attributes,"mediaID")&&(f.mediaDict[t.attributes.mediaID]=i),o(),i}},SnapSerializer.prototype.loadColor=function(t){var e=(t||"").split(",");return new Color(parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3]))},SnapSerializer.prototype.openProject=function(t,e){var o,i=e.stage,r=[];t&&t.stage&&(e.projectName=t.name,e.projectNotes=t.notes||"",e.globalVariables&&(e.globalVariables=t.globalVariables),i&&i.destroy(),e.add(t.stage),e.stage=t.stage,(r=e.stage.children.filter(function(t){return t instanceof SpriteMorph})).sort(function(t,e){return t.idx-e.idx}),e.sprites=new List(r),o=r[0]||t.stage,sizeOf(this.mediaDict)>0?(e.hasChangedMedia=!1,this.mediaDict={}):e.hasChangedMedia=!0,t.stage.drawNew(),e.createCorral(),e.selectSprite(o),e.fixLayout(),e.world().keyboardReceiver=t.stage)},StageMorph.prototype.toXML=function(t){function e(t){var e="";return Object.keys(StageMorph.prototype[t]).forEach(function(o){e+="<"+o+">"+XML_Element.prototype.escape(StageMorph.prototype[t][o])+"</"+o+">"}),e}var o,i=normalizeCanvas(this.thumbnail(SnapSerializer.prototype.thumbnailSize),!0),r=this.parentThatIsA(IDE_Morph);try{o=i.toDataURL("image/png")}catch(t){o=null}return this.removeAllClones(),t.format('<project name="@" app="@" version="@"><notes>$</notes><thumbnail>$</thumbnail><stage name="@" width="@" height="@" costume="@" tempo="@" threadsafe="@" %lines="@" ternary="@" codify="@" inheritance="@" sublistIDs="@" scheduled="@" ~><pentrails>$</pentrails><costumes>%</costumes><sounds>%</sounds><variables>%</variables><blocks>%</blocks><scripts>%</scripts><sprites>%</sprites></stage><hidden>$</hidden><headers>%</headers><code>%</code><blocks>%</blocks><variables>%</variables></project>',r&&r.projectName?r.projectName:localize("Untitled"),t.app,t.version,r&&r.projectNotes?r.projectNotes:"",o,this.name,StageMorph.prototype.dimensions.x,StageMorph.prototype.dimensions.y,this.getCostumeIdx(),this.getTempo(),this.isThreadSafe,this.instrument?' instrument="'+parseInt(this.instrument)+'" ':"",SpriteMorph.prototype.useFlatLineEnds?"flat":"round",BooleanSlotMorph.prototype.isTernary,this.enableCodeMapping,this.enableInheritance,this.enableSublistIDs,0!==StageMorph.prototype.frameRate,normalizeCanvas(this.trailsCanvas,!0).toDataURL("image/png"),t.store(this.costumes,this.name+"_cst"),t.store(this.sounds,this.name+"_snd"),t.store(this.variables),t.store(this.customBlocks),t.store(this.scripts),t.store(this.children),Object.keys(StageMorph.prototype.hiddenPrimitives).reduce(function(t,e){return t+" "+e},""),e("codeHeaders"),e("codeMappings"),t.store(this.globalBlocks),r&&r.globalVariables?t.store(r.globalVariables):"")},SpriteMorph.prototype.toXML=function(t){var e=this.parentThatIsA(StageMorph),o=e?e.parentThatIsA(IDE_Morph):null,i=o?o.sprites.asArray().indexOf(this)+1:0,r=this.inheritsAttribute("costumes"),n=this.inheritsAttribute("sounds"),s=this.inheritsAttribute("scripts");return t.format('<sprite name="@" idx="@" x="@" y="@" heading="@" scale="@" rotation="@"% draggable="@"% costume="@" color="@,@,@" pen="@" ~>%%'+(r?"%":"<costumes>%</costumes>")+(n?"%":"<sounds>%</sounds>")+"<blocks>%</blocks><variables>%</variables>"+(this.exemplar?"<dispatches>%</dispatches>":"%")+(s?"%":"<scripts>%</scripts>")+"</sprite>",this.name,i,this.xPosition(),this.yPosition(),this.heading,this.scale,this.rotationStyle,this.instrument?' instrument="'+parseInt(this.instrument)+'" ':"",this.isDraggable,this.isVisible?"":' hidden="true"',this.getCostumeIdx(),this.color.r,this.color.g,this.color.b,this.penPoint,this.exemplar?'<inherit exemplar="'+this.exemplar.name+'">'+(this.inheritedAttributes.length?t.store(new List(this.inheritedAttributes)):"")+"</inherit>":"",this.anchor?'<nest anchor="'+this.anchor.name+'" synch="'+this.rotatesWithAnchor+(this.scale===this.nestingScale?"":'" scale="'+this.nestingScale)+'"/>':"",r?"":t.store(this.costumes,this.name+"_cst"),n?"":t.store(this.sounds,this.name+"_snd"),this.customBlocks?t.store(this.customBlocks):"",t.store(this.variables),this.exemplar?t.store(this.inheritedMethods()):"",s?"":t.store(this.scripts))},Costume.prototype[XML_Serializer.prototype.mediaDetectionProperty]=!0,Costume.prototype.toXML=function(t){return t.format('<costume name="@" center-x="@" center-y="@" image="@" ~/>',this.name,this.rotationCenter.x,this.rotationCenter.y,this instanceof SVG_Costume?this.contents.src:normalizeCanvas(this.contents).toDataURL("image/png"))},Sound.prototype[XML_Serializer.prototype.mediaDetectionProperty]=!0,Sound.prototype.toXML=function(t){return t.format('<sound name="@" sound="@" ~/>',this.name,this.toDataURL())},VariableFrame.prototype.toXML=function(t){var e=this;return Object.keys(this.vars).reduce(function(o,i){var r,n=e.vars[i].value;return r=e.vars[i].isTransient?t.format('<variable name="@" transient="true"/>',i):void 0===n||null===n?t.format('<variable name="@"/>',i):t.format('<variable name="@">%</variable>',i,"object"==typeof n?isSnapObject(n)?"":t.store(n):"boolean"==typeof n?t.format("<bool>$</bool>",n):t.format("<l>$</l>",n)),o+r},"")},WatcherMorph.prototype.toXML=function(t){var e=this.target instanceof VariableFrame,o=this.currentValue instanceof List,i=this.readoutColor,r=this.parent?this.topLeft().subtract(this.parent.topLeft()):this.topLeft();return this.isTemporary()?"":t.format('<watcher% % style="@"% x="@" y="@" color="@,@,@"%%/>',e&&this.target.owner||!e&&this.target?t.format(' scope="@"',e?this.target.owner.name:this.target.name):"",t.format(e?'var="@"':'s="@"',this.getter),this.style,e&&"slider"===this.style?t.format(' min="@" max="@"',this.sliderMorph.start,this.sliderMorph.stop):"",r.x,r.y,i.r,i.g,i.b,o?t.format(' extX="@" extY="@"',this.cellMorph.contentsMorph.width(),this.cellMorph.contentsMorph.height()):"",this.isVisible?"":' hidden="true"')},ScriptsMorph.prototype.toXML=function(t){return this.children.reduce(function(e,o){return o instanceof BlockMorph?e+o.toScriptXML(t,!0):o instanceof CommentMorph&&!o.block?e+o.toXML(t):e},"")},BlockMorph.prototype.toXML=BlockMorph.prototype.toScriptXML=function(t,e){var o,i,r=SyntaxElementMorph.prototype.scale,n=this;o=this.parent?this.topLeft().subtract(this.parent.topLeft()):this.topLeft(),i=e?t.format('<script x="@" y="@">',o.x/r,o.y/r):"<script>";do{i+=n.toBlockXML(t),n=n.nextBlock()}while(n);return i+="<\/script>"},BlockMorph.prototype.toBlockXML=function(t){return t.format('<block s="@">%%</block>',this.selector,t.store(this.inputs()),this.comment?this.comment.toXML(t):"")},ReporterBlockMorph.prototype.toXML=function(t){return"reportGetVar"===this.selector?t.format('<block var="@"/>',this.blockSpec):this.toBlockXML(t)},ReporterBlockMorph.prototype.toScriptXML=function(t,e){var o,i=SyntaxElementMorph.prototype.scale;return o=this.parent?this.topLeft().subtract(this.parent.topLeft()):this.topLeft(),e?t.format('<script x="@" y="@">%<\/script>',o.x/i,o.y/i,this.toXML(t)):t.format("<script>%<\/script>",this.toXML(t))},CustomCommandBlockMorph.prototype.toBlockXML=function(t){var e=this.isGlobal?void 0:"local";return t.format('<custom-block s="@"%>%%%</custom-block>',this.semanticSpec,this.isGlobal?"":t.format(' scope="@"',e),t.store(this.inputs()),this.isGlobal&&this.definition.variableNames.length&&!t.isExportingBlocksLibrary?"<variables>"+this.variables.toXML(t)+"</variables>":"",this.comment?this.comment.toXML(t):"")},CustomReporterBlockMorph.prototype.toBlockXML=CustomCommandBlockMorph.prototype.toBlockXML,CustomBlockDefinition.prototype.toXML=function(t){var e=this;return t.format('<block-definition s="@" type="@" category="@">%'+(this.variableNames.length?"<variables>%</variables>":"@")+"<header>@</header><code>@</code><translations>@</translations><inputs>%</inputs>%%</block-definition>",this.spec,this.type,this.category||"other",this.comment?this.comment.toXML(t):"",this.variableNames.length?t.store(new List(this.variableNames)):"",this.codeHeader||"",this.codeMapping||"",this.translationsAsText(),Object.keys(this.declarations).reduce(function(o,i){return o+t.format('<input type="@"$>$%</input>',e.declarations[i][0],e.declarations[i][3]?' readonly="true"':"",e.declarations[i][1],e.declarations[i][2]?"<options>"+e.declarations[i][2]+"</options>":"")},""),this.body?t.store(this.body.expression):"",this.scripts.length>0?"<scripts>"+function(e){return e.reduce(function(e,o){return o instanceof BlockMorph?e+o.toScriptXML(t,!0):o instanceof CommentMorph&&!o.block?e+o.toXML(t):e},"")}(this.scripts)+"</scripts>":"")},ArgMorph.prototype.toXML=function(){return"<l/>"},BooleanSlotMorph.prototype.toXML=function(){return"boolean"==typeof this.value?"<l><bool>"+this.value+"</bool></l>":"<l/>"},InputSlotMorph.prototype.toXML=function(t){return this.constant?t.format("<l><option>$</option></l>",this.constant):t.format("<l>$</l>",this.contents().text)},TemplateSlotMorph.prototype.toXML=function(t){return t.format("<l>$</l>",this.contents())},CommandSlotMorph.prototype.toXML=function(t){var e=this.children[0];return e instanceof BlockMorph?e instanceof ReporterBlockMorph?t.format("<autolambda>%</autolambda>",t.store(e)):t.store(e):"<script><\/script>"},FunctionSlotMorph.prototype.toXML=CommandSlotMorph.prototype.toXML,MultiArgMorph.prototype.toXML=function(t){return t.format("<list>%</list>",t.store(this.inputs()))},ArgLabelMorph.prototype.toXML=function(t){return t.format("%",t.store(this.inputs()[0]))},ColorSlotMorph.prototype.toXML=function(t){return t.format("<color>$,$,$,$</color>",this.color.r,this.color.g,this.color.b,this.color.a)},List.prototype.toXML=function(t,e){var o,i,r;if(this.isLinked){if(o='<list linked="linked" ~>',StageMorph.prototype.enableSublistIDs)return i=this.first,isNil(i)||(o+=t.format("<item>%</item>","object"==typeof i?isSnapObject(i)?"":t.store(i,e):"boolean"==typeof i?t.format("<bool>$</bool>",i):t.format("<l>$</l>",i))),isNil(this.rest)||(o+=t.store(this.rest,e)),o+"</list>";r=this;do{isNil(i=r.first)||(o+=t.format("<item>%</item>","object"==typeof i?isSnapObject(i)?"":t.store(i,e):"boolean"==typeof i?t.format("<bool>$</bool>",i):t.format("<l>$</l>",i))),r=r.rest}while(!isNil(r));return o+"</list>"}return t.format("<list ~>%</list>",this.contents.reduce(function(o,i){return o+t.format("<item>%</item>","object"==typeof i?isSnapObject(i)?"":t.store(i,e):"boolean"==typeof i?t.format("<bool>$</bool>",i):t.format("<l>$</l>",i))},""))},Context.prototype.toXML=function(t){return this.isContinuation?"":t.format("<context ~><inputs>%</inputs><variables>%</variables>%<receiver>%</receiver><origin>%</origin>%</context>",this.inputs.reduce(function(e,o){return e+t.format("<input>$</input>",o)},""),this.variables?t.store(this.variables):"",this.expression?t.store(this.expression):"",this.receiver?t.store(this.receiver):"",this.receiver?t.store(this.origin):"",this.outerContext?t.store(this.outerContext):"")},CommentMorph.prototype.toXML=function(t){var e,o=SyntaxElementMorph.prototype.scale;return this.block?t.format('<comment w="@" collapsed="@">%</comment>',this.textWidth()/o,this.isCollapsed,t.escape(this.text())):(e=this.parent?this.topLeft().subtract(this.parent.topLeft()):this.topLeft(),t.format('<comment x="@" y="@" w="@" collapsed="@">%</comment>',e.x/o,e.y/o,this.textWidth()/o,this.isCollapsed,t.escape(this.text())))},modules.cloud="2015-December-15";var Cloud,SnapCloud=new Cloud("https://snap.apps.miosoft.com/SnapCloud");Cloud.prototype.clear=function(){this.username=null,this.password=null,this.session=null,this.limo=null,this.route=null,this.api={}},Cloud.prototype.hasProtocol=function(){return 0===this.url.toLowerCase().indexOf("http")},Cloud.prototype.setRoute=function(t){var e,o=0;for(e=0;e<t.length;e+=1)o+=t.charCodeAt(e);o=o%20+1,this.route=".sc1m"+(o<10?"0":"")+o},Cloud.prototype.signup=function(t,e,o,i){var r=new XMLHttpRequest,n=this;try{r.open("GET",(this.hasProtocol()?"":"http://")+this.url+"SignUp?Username="+encodeURIComponent(t)+"&Email="+encodeURIComponent(e),!0),r.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),r.withCredentials=!0,r.onreadystatechange=function(){4===r.readyState&&(r.responseText?0===r.responseText.indexOf("ERROR")?i.call(this,r.responseText,"Signup"):o.call(null,r.responseText,"Signup"):i.call(null,n.url+"SignUp",localize("could not connect to:")))},r.send(null)}catch(t){i.call(this,t.toString(),"Snap!Cloud")}},Cloud.prototype.getPublicProject=function(t,e,o){var i=new XMLHttpRequest,r=this;try{i.open("GET",(this.hasProtocol()?"":"http://")+this.url+"RawPublic?"+t,!0),i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),i.withCredentials=!0,i.onreadystatechange=function(){4===i.readyState&&(i.responseText?0===i.responseText.indexOf("ERROR")?o.call(this,i.responseText):e.call(null,i.responseText):o.call(null,r.url+"Public",localize("could not connect to:")))},i.send(null)}catch(t){o.call(this,t.toString(),"Snap!Cloud")}},Cloud.prototype.resetPassword=function(t,e,o){var i=new XMLHttpRequest,r=this;try{i.open("GET",(this.hasProtocol()?"":"http://")+this.url+"ResetPW?Username="+encodeURIComponent(t),!0),i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),i.withCredentials=!0,i.onreadystatechange=function(){4===i.readyState&&(i.responseText?0===i.responseText.indexOf("ERROR")?o.call(this,i.responseText,"Reset Password"):e.call(null,i.responseText,"Reset Password"):o.call(null,r.url+"ResetPW",localize("could not connect to:")))},i.send(null)}catch(t){o.call(this,t.toString(),"Snap!Cloud")}},Cloud.prototype.login=function(t,e,o,i){var r=new XMLHttpRequest,n=JSON.stringify({__h:e,__u:t}),s=this;this.setRoute(t);try{r.open("POST",(this.hasProtocol()?"":"http://")+this.url+"?SESSIONGLUE="+this.route,!0),r.setRequestHeader("Content-Type","application/json; charset=utf-8"),r.setRequestHeader("SESSIONGLUE",this.route),r.withCredentials=!0,r.onreadystatechange=function(){4===r.readyState&&(r.responseText?(s.api=s.parseAPI(r.responseText),s.session=r.getResponseHeader("MioCracker").split(";")[0],s.limo=this.getResponseHeader("miocracker").substring(9,this.getResponseHeader("miocracker").indexOf("=")),s.api.logout?(s.username=t,s.password=e,o.call(null,s.api,"Snap!Cloud")):i.call(null,r.responseText,"connection failed")):i.call(null,s.url,localize("could not connect to:")))},r.send(n)}catch(t){i.call(this,t.toString(),"Snap!Cloud")}},Cloud.prototype.reconnect=function(t,e){this.username&&this.password?this.login(this.username,this.password,t,e):this.message("You are not logged in")},Cloud.prototype.saveProject=function(t,e,o){var i,r,n,s,a=this;if(t.serializer.isCollectingMedia=!0,i=t.serializer.serialize(t.stage),r=t.hasChangedMedia?t.serializer.mediaXML(t.projectName):null,t.serializer.isCollectingMedia=!1,t.serializer.flushMedia(),s=r?r.length:0,n=i.length+s,s>10485760)throw(new DialogBoxMorph).inform("Snap!Cloud - Cannot Save Project","The media inside this project exceeds 10 MB.\nPlease reduce the size of costumes or sounds.\n",t.world(),t.cloudIcon(null,new Color(180,0,0))),new Error("Project media exceeds 10 MB size limit");try{t.serializer.parse(i)}catch(e){throw t.showMessage("Serialization of program data failed:\n"+e),new Error("Serialization of program data failed:\n"+e)}if(null!==r)try{t.serializer.parse(r)}catch(e){throw t.showMessage("Serialization of media failed:\n"+e),new Error("Serialization of media failed:\n"+e)}t.serializer.isCollectingMedia=!1,t.serializer.flushMedia(),t.showMessage("Uploading "+Math.round(n/1024)+" KB..."),a.reconnect(function(){a.callService("saveProject",function(o,i){e.call(null,o,i),a.disconnect(),t.hasChangedMedia=!1},o,[t.projectName,i,r,i.length,r?r.length:0])},o)},Cloud.prototype.getProjectList=function(t,e){var o=this;this.reconnect(function(){o.callService("getProjectList",function(e,i){t.call(null,e,i),o.disconnect()},e)},e)},Cloud.prototype.changePassword=function(t,e,o,i){var r=this;this.reconnect(function(){r.callService("changePassword",function(t,e){o.call(null,t,e),r.disconnect()},i,[hex_sha512(t),hex_sha512(e)])},i)},Cloud.prototype.logout=function(t,e){this.clear(),this.callService("logout",t,e)},Cloud.prototype.disconnect=function(){this.callService("logout",nop,nop)},Cloud.prototype.callURL=function(t,e,o){var i,r=new XMLHttpRequest,n=this;try{i=t+"&SESSIONGLUE="+this.route+"&_Limo="+this.limo,r.open("GET",i,!0),r.withCredentials=!0,r.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),r.setRequestHeader("MioCracker",this.session),r.setRequestHeader("SESSIONGLUE",this.route),r.onreadystatechange=function(){if(4===r.readyState)if(r.responseText){var i=n.parseResponse(r.responseText);e.call(null,i,t)}else o.call(null,t,"no response from:")},r.send(null)}catch(e){o.call(this,e.toString(),t)}},Cloud.prototype.callService=function(t,e,o,i){var r,n,s=new XMLHttpRequest,a=this.api[t],h=this;if(this.session)if(a){i&&i.length>0&&(n={},a.parameters.forEach(function(t,e){n[t]=i[e]}));try{r=this.url+"/"+a.url+"&SESSIONGLUE="+this.route+"&_Limo="+this.limo,s.open(a.method,r,!0),s.withCredentials=!0,s.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),s.setRequestHeader("MioCracker",this.session),s.setRequestHeader("SESSIONGLUE",this.route),s.onreadystatechange=function(){if(4===s.readyState){var i=[];if(s.responseText&&0===s.responseText.indexOf("ERROR"))return void o.call(this,s.responseText,localize("Service:")+" "+localize(t));"login"===t&&(h.api=h.parseAPI(s.responseText)),i="getRawProject"===t?s.responseText:h.parseResponse(s.responseText),e.call(null,i,a.url)}},s.send(this.encodeDict(n))}catch(t){o.call(this,t.toString(),a.url)}}else o.call(null,"service "+t+" is not available","API");else o.call(null,"You are not connected","Cloud")},Cloud.prototype.parseAPI=function(t){var e={};return t.split(" ").forEach(function(t){var o,i={};t.split("&").forEach(function(t){var r=t.split("="),n=decodeURIComponent(r[0]).toLowerCase(),s=decodeURIComponent(r[1]);"service"===n?e[s]=i:"parameters"===n?(1!==(o=s.split(",")).length||o[0])&&(i.parameters=o):i[n]=s})}),e},Cloud.prototype.parseResponse=function(t){var e=[];return t?(t.split(" ").forEach(function(t){var o={};t.split("&").forEach(function(t){var e=t.split("="),i=decodeURIComponent(e[0]),r=decodeURIComponent(e[1]);o[i]=r}),e.push(o)}),e):e},Cloud.prototype.parseDict=function(t){var e={};return t?(t.split("&").forEach(function(t){var o=t.split("="),i=decodeURIComponent(o[0]),r=decodeURIComponent(o[1]);e[i]=r}),e):e},Cloud.prototype.encodeDict=function(t){var e,o,i="";if(!t)return null;for(o in t)t.hasOwnProperty(o)&&(e=encodeURIComponent(o)+"="+encodeURIComponent(t[o]),i.length>0&&(i+="&"),i+=e);return i},Cloud.prototype.message=function(t){alert(t)};var hex_sha512=function(t){function t(t){return o.SHA512(e(t)).toString(o.enc.Hex)}function e(t){for(var e,o,i="",r=-1;++r<t.length;)e=t.charCodeAt(r),o=r+1<t.length?t.charCodeAt(r+1):0,55296<=e&&e<=56319&&56320<=o&&o<=57343&&(e=65536+((1023&e)<<10)+(1023&o),r++),e<=127?i+=String.fromCharCode(e):e<=2047?i+=String.fromCharCode(192|e>>>6&31,128|63&e):e<=65535?i+=String.fromCharCode(224|e>>>12&15,128|e>>>6&63,128|63&e):e<=2097151&&(i+=String.fromCharCode(240|e>>>18&7,128|e>>>12&63,128|e>>>6&63,128|63&e));return i}var o=o||function(t,e){var o={},i=o.lib={},r=i.Base=function(){function t(){}return{extend:function(e){t.prototype=this;var o=new t;return e&&o.mixIn(e),o.$super=this,o},create:function(){var t=this.extend();return t.init.apply(t,arguments),t},init:function(){},mixIn:function(t){for(var e in t)t.hasOwnProperty(e)&&(this[e]=t[e]);t.hasOwnProperty("toString")&&(this.toString=t.toString)},clone:function(){return this.$super.extend(this)}}}(),n=i.WordArray=r.extend({init:function(t,e){t=this.words=t||[],this.sigBytes=void 0!=e?e:4*t.length},toString:function(t){return(t||a).stringify(this)},concat:function(t){var e=this.words,o=t.words,i=this.sigBytes,t=t.sigBytes;if(this.clamp(),i%4)for(var r=0;r<t;r++)e[i+r>>>2]|=(o[r>>>2]>>>24-r%4*8&255)<<24-(i+r)%4*8;else if(65535<o.length)for(r=0;r<t;r+=4)e[i+r>>>2]=o[r>>>2];else e.push.apply(e,o);return this.sigBytes+=t,this},clamp:function(){var e=this.words,o=this.sigBytes;e[o>>>2]&=4294967295<<32-o%4*8,e.length=t.ceil(o/4)},clone:function(){var t=r.clone.call(this);return t.words=this.words.slice(0),t},random:function(e){for(var o=[],i=0;i<e;i+=4)o.push(4294967296*t.random()|0);return n.create(o,e)}}),s=o.enc={},a=s.Hex={stringify:function(t){for(var e=t.words,t=t.sigBytes,o=[],i=0;i<t;i++){var r=e[i>>>2]>>>24-i%4*8&255;o.push((r>>>4).toString(16)),o.push((15&r).toString(16))}return o.join("")},parse:function(t){for(var e=t.length,o=[],i=0;i<e;i+=2)o[i>>>3]|=parseInt(t.substr(i,2),16)<<24-i%8*4;return n.create(o,e/2)}},h=s.Latin1={stringify:function(t){for(var e=t.words,t=t.sigBytes,o=[],i=0;i<t;i++)o.push(String.fromCharCode(e[i>>>2]>>>24-i%4*8&255));return o.join("")},parse:function(t){for(var e=t.length,o=[],i=0;i<e;i++)o[i>>>2]|=(255&t.charCodeAt(i))<<24-i%4*8;return n.create(o,e)}},l=s.Utf8={stringify:function(t){try{return decodeURIComponent(escape(h.stringify(t)))}catch(t){throw Error("Malformed UTF-8 data")}},parse:function(t){return h.parse(unescape(encodeURIComponent(t)))}},p=i.BufferedBlockAlgorithm=r.extend({reset:function(){this._data=n.create(),this._nDataBytes=0},_append:function(t){"string"==typeof t&&(t=l.parse(t)),this._data.concat(t),this._nDataBytes+=t.sigBytes},_process:function(e){var o=this._data,i=o.words,r=o.sigBytes,s=this.blockSize,a=r/(4*s),e=(a=e?t.ceil(a):t.max((0|a)-this._minBufferSize,0))*s,r=t.min(4*e,r);if(e){for(var h=0;h<e;h+=s)this._doProcessBlock(i,h);h=i.splice(0,e),o.sigBytes-=r}return n.create(h,r)},clone:function(){var t=r.clone.call(this);return t._data=this._data.clone(),t},_minBufferSize:0});i.Hasher=p.extend({init:function(){this.reset()},reset:function(){p.reset.call(this),this._doReset()},update:function(t){return this._append(t),this._process(),this},finalize:function(t){return t&&this._append(t),this._doFinalize(),this._hash},clone:function(){var t=p.clone.call(this);return t._hash=this._hash.clone(),t},blockSize:16,_createHelper:function(t){return function(e,o){return t.create(o).finalize(e)}},_createHmacHelper:function(t){return function(e,o){return c.HMAC.create(t,o).finalize(e)}}});var c=o.algo={};return o}(Math);!function(t){var e=o,i=e.lib,r=i.Base,n=i.WordArray;(e=e.x64={}).Word=r.extend({init:function(t,e){this.high=t,this.low=e}}),e.WordArray=r.extend({init:function(t,e){t=this.words=t||[],this.sigBytes=void 0!=e?e:8*t.length},toX32:function(){for(var t=this.words,e=t.length,o=[],i=0;i<e;i++){var r=t[i];o.push(r.high),o.push(r.low)}return n.create(o,this.sigBytes)},clone:function(){for(var t=r.clone.call(this),e=t.words=this.words.slice(0),o=e.length,i=0;i<o;i++)e[i]=e[i].clone();return t}})}(),function(){function t(){return r.create.apply(r,arguments)}var e=o,i=e.lib.Hasher,r=(s=e.x64).Word,n=s.WordArray,s=e.algo,a=[t(1116352408,3609767458),t(1899447441,602891725),t(3049323471,3964484399),t(3921009573,2173295548),t(961987163,4081628472),t(1508970993,3053834265),t(2453635748,2937671579),t(2870763221,3664609560),t(3624381080,2734883394),t(310598401,1164996542),t(607225278,1323610764),t(1426881987,3590304994),t(1925078388,4068182383),t(2162078206,991336113),t(2614888103,633803317),t(3248222580,3479774868),t(3835390401,2666613458),t(4022224774,944711139),t(264347078,2341262773),t(604807628,2007800933),t(770255983,1495990901),t(1249150122,1856431235),t(1555081692,3175218132),t(1996064986,2198950837),t(2554220882,3999719339),t(2821834349,766784016),t(2952996808,2566594879),t(3210313671,3203337956),t(3336571891,1034457026),t(3584528711,2466948901),t(113926993,3758326383),t(338241895,168717936),t(666307205,1188179964),t(773529912,1546045734),t(1294757372,1522805485),t(1396182291,2643833823),t(1695183700,2343527390),t(1986661051,1014477480),t(2177026350,1206759142),t(2456956037,344077627),t(2730485921,1290863460),t(2820302411,3158454273),t(3259730800,3505952657),t(3345764771,106217008),t(3516065817,3606008344),t(3600352804,1432725776),t(4094571909,1467031594),t(275423344,851169720),t(430227734,3100823752),t(506948616,1363258195),t(659060556,3750685593),t(883997877,3785050280),t(958139571,3318307427),t(1322822218,3812723403),t(1537002063,2003034995),t(1747873779,3602036899),t(1955562222,1575990012),t(2024104815,1125592928),t(2227730452,2716904306),t(2361852424,442776044),t(2428436474,593698344),t(2756734187,3733110249),t(3204031479,2999351573),t(3329325298,3815920427),t(3391569614,3928383900),t(3515267271,566280711),t(3940187606,3454069534),t(4118630271,4000239992),t(116418474,1914138554),t(174292421,2731055270),t(289380356,3203993006),t(460393269,320620315),t(685471733,587496836),t(852142971,1086792851),t(1017036298,365543100),t(1126000580,2618297676),t(1288033470,3409855158),t(1501505948,4234509866),t(1607167915,987167468),t(1816402316,1246189591)],h=[];!function(){for(var e=0;80>e;e++)h[e]=t()}(),s=s.SHA512=i.extend({_doReset:function(){this._hash=n.create([t(1779033703,4089235720),t(3144134277,2227873595),t(1013904242,4271175723),t(2773480762,1595750129),t(1359893119,2917565137),t(2600822924,725511199),t(528734635,4215389547),t(1541459225,327033209)])},_doProcessBlock:function(t,e){for(var o=(c=this._hash.words)[0],i=c[1],r=c[2],n=c[3],s=c[4],l=c[5],p=c[6],c=c[7],d=o.high,u=o.low,g=i.high,f=i.low,m=r.high,y=r.low,M=n.high,b=n.low,w=s.high,S=s.low,C=l.high,v=l.low,x=p.high,k=p.low,B=c.high,P=c.low,T=d,I=u,E=g,L=f,D=m,A=y,F=M,R=b,N=w,O=S,z=C,j=v,H=x,W=k,V=B,G=P,_=0;80>_;_++){$=h[_];if(16>_)var U=$.high=0|t[e+2*_],X=$.low=0|t[e+2*_+1];else{var X=(U=h[_-15]).high,U=((K=U.low)<<31|X>>>1)^(K<<24|X>>>8)^X>>>7,K=(X<<31|K>>>1)^(X<<24|K>>>8)^(X<<25|K>>>7),X=(q=h[_-2]).high,q=((Y=q.low)<<13|X>>>19)^(X<<3|Y>>>29)^X>>>6,Y=(X<<13|Y>>>19)^(Y<<3|X>>>29)^(X<<26|Y>>>6),J=(X=h[_-7]).high,Q=(Z=h[_-16]).high,Z=Z.low,U=(U=(U=U+J+((X=K+X.low)>>>0<K>>>0?1:0))+q+((X=X+Y)>>>0<Y>>>0?1:0))+Q+((X=X+Z)>>>0<Z>>>0?1:0);$.high=U,$.low=X}var J=N&z^~N&H,Z=O&j^~O&W,$=T&E^T&D^E&D,tt=I&L^I&A^L&A,K=(I<<4|T>>>28)^(T<<30|I>>>2)^(T<<25|I>>>7),q=(T<<4|I>>>28)^(I<<30|T>>>2)^(I<<25|T>>>7),et=(Y=a[_]).high,ot=Y.low,Q=(Q=(Q=(Q=V+((O<<18|N>>>14)^(O<<14|N>>>18)^(N<<23|O>>>9))+((Y=G+((N<<18|O>>>14)^(N<<14|O>>>18)^(O<<23|N>>>9)))>>>0<G>>>0?1:0))+J+((Y=Y+Z)>>>0<Z>>>0?1:0))+et+((Y=Y+ot)>>>0<ot>>>0?1:0))+U+((Y=Y+X)>>>0<X>>>0?1:0),$=K+$+((X=q+tt)>>>0<q>>>0?1:0),V=H,G=W,H=z,W=j,z=N,j=O,N=F+Q+((O=R+Y|0)>>>0<R>>>0?1:0)|0,F=D,R=A,D=E,A=L,E=T,L=I,T=Q+$+((I=Y+X|0)>>>0<Y>>>0?1:0)|0}u=o.low=u+I|0,o.high=d+T+(u>>>0<I>>>0?1:0)|0,f=i.low=f+L|0,i.high=g+E+(f>>>0<L>>>0?1:0)|0,y=r.low=y+A|0,r.high=m+D+(y>>>0<A>>>0?1:0)|0,b=n.low=b+R|0,n.high=M+F+(b>>>0<R>>>0?1:0)|0,S=s.low=S+O|0,s.high=w+N+(S>>>0<O>>>0?1:0)|0,v=l.low=v+j|0,l.high=C+z+(v>>>0<j>>>0?1:0)|0,k=p.low=k+W|0,p.high=x+H+(k>>>0<W>>>0?1:0)|0,P=c.low=P+G|0,c.high=B+V+(P>>>0<G>>>0?1:0)|0},_doFinalize:function(){var t=this._data,e=t.words,o=8*this._nDataBytes,i=8*t.sigBytes;e[i>>>5]|=128<<24-i%32,e[31+(i+128>>>10<<5)]=o,t.sigBytes=4*e.length,this._process(),this._hash=this._hash.toX32()},blockSize:32}),e.SHA512=i._createHelper(s),e.HmacSHA512=i._createHmacHelper(s)}();return t}({}),saveAs=saveAs||function(t){if(!(void 0===t||"undefined"!=typeof navigator&&/MSIE [1-9]\./.test(navigator.userAgent))){var e=function(){return t.URL||t.webkitURL||t},o=t.document.createElementNS("http://www.w3.org/1999/xhtml","a"),i="download"in o,r=function(t){var e=new MouseEvent("click");t.dispatchEvent(e)},n=/constructor/i.test(t.HTMLElement)||t.safari,s=/CriOS\/[\d]+/.test(navigator.userAgent),a=function(e){(t.setImmediate||t.setTimeout)(function(){throw e},0)},h=function(t){setTimeout(function(){"string"==typeof t?e().revokeObjectURL(t):t.remove()},4e4)},l=function(t,e,o){for(var i=(e=[].concat(e)).length;i--;){var r=t["on"+e[i]];if("function"==typeof r)try{r.call(t,o||t)}catch(t){a(t)}}},p=function(t){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(t.type)?new Blob([String.fromCharCode(65279),t],{type:t.type}):t},c=function(a,c,d){d||(a=p(a));var u,g=this,f="application/octet-stream"===a.type,m=function(){l(g,"writestart progress write writeend".split(" "))};if(g.readyState=g.INIT,i)return u=e().createObjectURL(a),void setTimeout(function(){o.href=u,o.download=c,r(o),m(),h(u),g.readyState=g.DONE});!function(){if((s||f&&n)&&t.FileReader){var o=new FileReader;return o.onloadend=function(){var e=s?o.result:o.result.replace(/^data:[^;]*;/,"data:attachment/file;");t.open(e,"_blank")||(t.location.href=e),e=void 0,g.readyState=g.DONE,m()},o.readAsDataURL(a),void(g.readyState=g.INIT)}u||(u=e().createObjectURL(a)),f?t.location.href=u:t.open(u,"_blank")||(t.location.href=u),g.readyState=g.DONE,m(),h(u)}()},d=c.prototype;return"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(t,e,o){return e=e||t.name||"download",o||(t=p(t)),navigator.msSaveOrOpenBlob(t,e)}:(d.abort=function(){},d.readyState=d.INIT=0,d.WRITING=1,d.DONE=2,d.error=d.onwritestart=d.onprogress=d.onwrite=d.onabort=d.onerror=d.onwriteend=null,function(t,e,o){return new c(t,e||t.name||"download",o)})}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);"undefined"!=typeof module&&module.exports?module.exports.saveAs=saveAs:"undefined"!=typeof define&&null!==define&&null!==define.amd&&define("FileSaver.js",function(){return saveAs}),disableRetinaSupport();var elementCanvas=document.getElementsByClassName("world");return(world=new WorldMorph(elementCanvas[0])).worldCanvas.focus(),(new IDE_Morph).openIn(world),loop(),world.panelLeft=panel_Left,"visible"==config.blockPanelSizer&&LeftExpand(),"nonVisible"==config.blockPanelSizer&&LeftReducer(),$(".bPanel").change(function(t){var e=$(".bPanel").val();"nonVisible"==e&&LeftReducer(),"visible"==e&&LeftExpand()}),$(".snapScriptSaver").click(function(t){importator(),$(".snapScriptButton").prop("disabled",!1),setTimeout(function(){alert("Attention vous devez sauvegarder le projet Snap importé en appuyant sur le bouton SAUVEGARDER LE PROJET qui vient d'être activé dans le panneau latéral!")},5e3)}),$(".snapScriptButton").click(function(t){alert("Le projet a été intégré à la PCI avec succès.")}),panel_Left},mod});