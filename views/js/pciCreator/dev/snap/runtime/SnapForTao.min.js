define("taoQtiItem/portableLib/jquery_2_1_1",[],function(){return function(global,factory){"object"==typeof module&&"object"==typeof module.exports?module.exports=global.document?factory(global,!0):function(w){if(!w.document)throw new Error("jQuery requires a window with a document");return factory(w)}:factory(global)}("undefined"!=typeof window?window:this,function(window,noGlobal){function isArraylike(obj){var length=obj.length,type=jQuery.type(obj);return"function"!==type&&!jQuery.isWindow(obj)&&(!(1!==obj.nodeType||!length)||("array"===type||0===length||"number"==typeof length&&length>0&&length-1 in obj))}function winnow(elements,qualifier,not){if(jQuery.isFunction(qualifier))return jQuery.grep(elements,function(elem,i){
return!!qualifier.call(elem,i,elem)!==not});if(qualifier.nodeType)return jQuery.grep(elements,function(elem){return elem===qualifier!==not});if("string"==typeof qualifier){if(risSimple.test(qualifier))return jQuery.filter(qualifier,elements,not);qualifier=jQuery.filter(qualifier,elements)}return jQuery.grep(elements,function(elem){return indexOf.call(qualifier,elem)>=0!==not})}function sibling(cur,dir){for(;(cur=cur[dir])&&1!==cur.nodeType;);return cur}function createOptions(options){var object=optionsCache[options]={};return jQuery.each(options.match(rnotwhite)||[],function(_,flag){object[flag]=!0}),object}function completed(){document.removeEventListener("DOMContentLoaded",completed,!1),
window.removeEventListener("load",completed,!1),jQuery.ready()}function Data(){Object.defineProperty(this.cache={},0,{get:function(){return{}}}),this.expando=jQuery.expando+Math.random()}function dataAttr(elem,key,data){var name;if(void 0===data&&1===elem.nodeType)if(name="data-"+key.replace(rmultiDash,"-$1").toLowerCase(),data=elem.getAttribute(name),"string"==typeof data){try{data="true"===data||"false"!==data&&("null"===data?null:+data+""===data?+data:rbrace.test(data)?jQuery.parseJSON(data):data)}catch(e){}data_user.set(elem,key,data)}else data=void 0;return data}function returnTrue(){return!0}function returnFalse(){return!1}function safeActiveElement(){try{
return document.activeElement}catch(err){}}function manipulationTarget(elem,content){return jQuery.nodeName(elem,"table")&&jQuery.nodeName(11!==content.nodeType?content:content.firstChild,"tr")?elem.getElementsByTagName("tbody")[0]||elem.appendChild(elem.ownerDocument.createElement("tbody")):elem}function disableScript(elem){return elem.type=(null!==elem.getAttribute("type"))+"/"+elem.type,elem}function restoreScript(elem){var match=rscriptTypeMasked.exec(elem.type);return match?elem.type=match[1]:elem.removeAttribute("type"),elem}function setGlobalEval(elems,refElements){for(var i=0,l=elems.length;i<l;i++)data_priv.set(elems[i],"globalEval",!refElements||data_priv.get(refElements[i],"globalEval"));
}function cloneCopyEvent(src,dest){var i,l,type,pdataOld,pdataCur,udataOld,udataCur,events;if(1===dest.nodeType){if(data_priv.hasData(src)&&(pdataOld=data_priv.access(src),pdataCur=data_priv.set(dest,pdataOld),events=pdataOld.events)){delete pdataCur.handle,pdataCur.events={};for(type in events)for(i=0,l=events[type].length;i<l;i++)jQuery.event.add(dest,type,events[type][i])}data_user.hasData(src)&&(udataOld=data_user.access(src),udataCur=jQuery.extend({},udataOld),data_user.set(dest,udataCur))}}function getAll(context,tag){var ret=context.getElementsByTagName?context.getElementsByTagName(tag||"*"):context.querySelectorAll?context.querySelectorAll(tag||"*"):[];
return void 0===tag||tag&&jQuery.nodeName(context,tag)?jQuery.merge([context],ret):ret}function fixInput(src,dest){var nodeName=dest.nodeName.toLowerCase();"input"===nodeName&&rcheckableType.test(src.type)?dest.checked=src.checked:"input"!==nodeName&&"textarea"!==nodeName||(dest.defaultValue=src.defaultValue)}function actualDisplay(name,doc){var style,elem=jQuery(doc.createElement(name)).appendTo(doc.body),display=window.getDefaultComputedStyle&&(style=window.getDefaultComputedStyle(elem[0]))?style.display:jQuery.css(elem[0],"display");return elem.detach(),display}function defaultDisplay(nodeName){var doc=document,display=elemdisplay[nodeName];return display||(display=actualDisplay(nodeName,doc),
"none"!==display&&display||(iframe=(iframe||jQuery("<iframe frameborder='0' width='0' height='0'/>")).appendTo(doc.documentElement),doc=iframe[0].contentDocument,doc.write(),doc.close(),display=actualDisplay(nodeName,doc),iframe.detach()),elemdisplay[nodeName]=display),display}function curCSS(elem,name,computed){var width,minWidth,maxWidth,ret,style=elem.style;return computed=computed||getStyles(elem),computed&&(ret=computed.getPropertyValue(name)||computed[name]),computed&&(""!==ret||jQuery.contains(elem.ownerDocument,elem)||(ret=jQuery.style(elem,name)),rnumnonpx.test(ret)&&rmargin.test(name)&&(width=style.width,minWidth=style.minWidth,maxWidth=style.maxWidth,
style.minWidth=style.maxWidth=style.width=ret,ret=computed.width,style.width=width,style.minWidth=minWidth,style.maxWidth=maxWidth)),void 0!==ret?ret+"":ret}function addGetHookIf(conditionFn,hookFn){return{get:function(){return conditionFn()?void delete this.get:(this.get=hookFn).apply(this,arguments)}}}function vendorPropName(style,name){if(name in style)return name;for(var capName=name[0].toUpperCase()+name.slice(1),origName=name,i=cssPrefixes.length;i--;)if(name=cssPrefixes[i]+capName,name in style)return name;return origName}function setPositiveNumber(elem,value,subtract){var matches=rnumsplit.exec(value);return matches?Math.max(0,matches[1]-(subtract||0))+(matches[2]||"px"):value;
}function augmentWidthOrHeight(elem,name,extra,isBorderBox,styles){for(var i=extra===(isBorderBox?"border":"content")?4:"width"===name?1:0,val=0;i<4;i+=2)"margin"===extra&&(val+=jQuery.css(elem,extra+cssExpand[i],!0,styles)),isBorderBox?("content"===extra&&(val-=jQuery.css(elem,"padding"+cssExpand[i],!0,styles)),"margin"!==extra&&(val-=jQuery.css(elem,"border"+cssExpand[i]+"Width",!0,styles))):(val+=jQuery.css(elem,"padding"+cssExpand[i],!0,styles),"padding"!==extra&&(val+=jQuery.css(elem,"border"+cssExpand[i]+"Width",!0,styles)));return val}function getWidthOrHeight(elem,name,extra){var valueIsBorderBox=!0,val="width"===name?elem.offsetWidth:elem.offsetHeight,styles=getStyles(elem),isBorderBox="border-box"===jQuery.css(elem,"boxSizing",!1,styles);
if(val<=0||null==val){if(val=curCSS(elem,name,styles),(val<0||null==val)&&(val=elem.style[name]),rnumnonpx.test(val))return val;valueIsBorderBox=isBorderBox&&(support.boxSizingReliable()||val===elem.style[name]),val=parseFloat(val)||0}return val+augmentWidthOrHeight(elem,name,extra||(isBorderBox?"border":"content"),valueIsBorderBox,styles)+"px"}function showHide(elements,show){for(var display,elem,hidden,values=[],index=0,length=elements.length;index<length;index++)elem=elements[index],elem.style&&(values[index]=data_priv.get(elem,"olddisplay"),display=elem.style.display,show?(values[index]||"none"!==display||(elem.style.display=""),""===elem.style.display&&isHidden(elem)&&(values[index]=data_priv.access(elem,"olddisplay",defaultDisplay(elem.nodeName)))):(hidden=isHidden(elem),
"none"===display&&hidden||data_priv.set(elem,"olddisplay",hidden?display:jQuery.css(elem,"display"))));for(index=0;index<length;index++)elem=elements[index],elem.style&&(show&&"none"!==elem.style.display&&""!==elem.style.display||(elem.style.display=show?values[index]||"":"none"));return elements}function Tween(elem,options,prop,end,easing){return new Tween.prototype.init(elem,options,prop,end,easing)}function createFxNow(){return setTimeout(function(){fxNow=void 0}),fxNow=jQuery.now()}function genFx(type,includeWidth){var which,i=0,attrs={height:type};for(includeWidth=includeWidth?1:0;i<4;i+=2-includeWidth)which=cssExpand[i],attrs["margin"+which]=attrs["padding"+which]=type;
return includeWidth&&(attrs.opacity=attrs.width=type),attrs}function createTween(value,prop,animation){for(var tween,collection=(tweeners[prop]||[]).concat(tweeners["*"]),index=0,length=collection.length;index<length;index++)if(tween=collection[index].call(animation,prop,value))return tween}function defaultPrefilter(elem,props,opts){var prop,value,toggle,tween,hooks,oldfire,display,checkDisplay,anim=this,orig={},style=elem.style,hidden=elem.nodeType&&isHidden(elem),dataShow=data_priv.get(elem,"fxshow");opts.queue||(hooks=jQuery._queueHooks(elem,"fx"),null==hooks.unqueued&&(hooks.unqueued=0,oldfire=hooks.empty.fire,hooks.empty.fire=function(){hooks.unqueued||oldfire();
}),hooks.unqueued++,anim.always(function(){anim.always(function(){hooks.unqueued--,jQuery.queue(elem,"fx").length||hooks.empty.fire()})})),1===elem.nodeType&&("height"in props||"width"in props)&&(opts.overflow=[style.overflow,style.overflowX,style.overflowY],display=jQuery.css(elem,"display"),checkDisplay="none"===display?data_priv.get(elem,"olddisplay")||defaultDisplay(elem.nodeName):display,"inline"===checkDisplay&&"none"===jQuery.css(elem,"float")&&(style.display="inline-block")),opts.overflow&&(style.overflow="hidden",anim.always(function(){style.overflow=opts.overflow[0],style.overflowX=opts.overflow[1],style.overflowY=opts.overflow[2]}));for(prop in props)if(value=props[prop],
rfxtypes.exec(value)){if(delete props[prop],toggle=toggle||"toggle"===value,value===(hidden?"hide":"show")){if("show"!==value||!dataShow||void 0===dataShow[prop])continue;hidden=!0}orig[prop]=dataShow&&dataShow[prop]||jQuery.style(elem,prop)}else display=void 0;if(jQuery.isEmptyObject(orig))"inline"===("none"===display?defaultDisplay(elem.nodeName):display)&&(style.display=display);else{dataShow?"hidden"in dataShow&&(hidden=dataShow.hidden):dataShow=data_priv.access(elem,"fxshow",{}),toggle&&(dataShow.hidden=!hidden),hidden?jQuery(elem).show():anim.done(function(){jQuery(elem).hide()}),anim.done(function(){var prop;data_priv.remove(elem,"fxshow");for(prop in orig)jQuery.style(elem,prop,orig[prop]);
});for(prop in orig)tween=createTween(hidden?dataShow[prop]:0,prop,anim),prop in dataShow||(dataShow[prop]=tween.start,hidden&&(tween.end=tween.start,tween.start="width"===prop||"height"===prop?1:0))}}function propFilter(props,specialEasing){var index,name,easing,value,hooks;for(index in props)if(name=jQuery.camelCase(index),easing=specialEasing[name],value=props[index],jQuery.isArray(value)&&(easing=value[1],value=props[index]=value[0]),index!==name&&(props[name]=value,delete props[index]),hooks=jQuery.cssHooks[name],hooks&&"expand"in hooks){value=hooks.expand(value),delete props[name];for(index in value)index in props||(props[index]=value[index],specialEasing[index]=easing);
}else specialEasing[name]=easing}function Animation(elem,properties,options){var result,stopped,index=0,length=animationPrefilters.length,deferred=jQuery.Deferred().always(function(){delete tick.elem}),tick=function(){if(stopped)return!1;for(var currentTime=fxNow||createFxNow(),remaining=Math.max(0,animation.startTime+animation.duration-currentTime),temp=remaining/animation.duration||0,percent=1-temp,index=0,length=animation.tweens.length;index<length;index++)animation.tweens[index].run(percent);return deferred.notifyWith(elem,[animation,percent,remaining]),percent<1&&length?remaining:(deferred.resolveWith(elem,[animation]),!1)},animation=deferred.promise({elem:elem,
props:jQuery.extend({},properties),opts:jQuery.extend(!0,{specialEasing:{}},options),originalProperties:properties,originalOptions:options,startTime:fxNow||createFxNow(),duration:options.duration,tweens:[],createTween:function(prop,end){var tween=jQuery.Tween(elem,animation.opts,prop,end,animation.opts.specialEasing[prop]||animation.opts.easing);return animation.tweens.push(tween),tween},stop:function(gotoEnd){var index=0,length=gotoEnd?animation.tweens.length:0;if(stopped)return this;for(stopped=!0;index<length;index++)animation.tweens[index].run(1);return gotoEnd?deferred.resolveWith(elem,[animation,gotoEnd]):deferred.rejectWith(elem,[animation,gotoEnd]),this;
}}),props=animation.props;for(propFilter(props,animation.opts.specialEasing);index<length;index++)if(result=animationPrefilters[index].call(animation,elem,props,animation.opts))return result;return jQuery.map(props,createTween,animation),jQuery.isFunction(animation.opts.start)&&animation.opts.start.call(elem,animation),jQuery.fx.timer(jQuery.extend(tick,{elem:elem,anim:animation,queue:animation.opts.queue})),animation.progress(animation.opts.progress).done(animation.opts.done,animation.opts.complete).fail(animation.opts.fail).always(animation.opts.always)}function addToPrefiltersOrTransports(structure){return function(dataTypeExpression,func){"string"!=typeof dataTypeExpression&&(func=dataTypeExpression,
dataTypeExpression="*");var dataType,i=0,dataTypes=dataTypeExpression.toLowerCase().match(rnotwhite)||[];if(jQuery.isFunction(func))for(;dataType=dataTypes[i++];)"+"===dataType[0]?(dataType=dataType.slice(1)||"*",(structure[dataType]=structure[dataType]||[]).unshift(func)):(structure[dataType]=structure[dataType]||[]).push(func)}}function inspectPrefiltersOrTransports(structure,options,originalOptions,jqXHR){function inspect(dataType){var selected;return inspected[dataType]=!0,jQuery.each(structure[dataType]||[],function(_,prefilterOrFactory){var dataTypeOrTransport=prefilterOrFactory(options,originalOptions,jqXHR);return"string"!=typeof dataTypeOrTransport||seekingTransport||inspected[dataTypeOrTransport]?seekingTransport?!(selected=dataTypeOrTransport):void 0:(options.dataTypes.unshift(dataTypeOrTransport),
inspect(dataTypeOrTransport),!1)}),selected}var inspected={},seekingTransport=structure===transports;return inspect(options.dataTypes[0])||!inspected["*"]&&inspect("*")}function ajaxExtend(target,src){var key,deep,flatOptions=jQuery.ajaxSettings.flatOptions||{};for(key in src)void 0!==src[key]&&((flatOptions[key]?target:deep||(deep={}))[key]=src[key]);return deep&&jQuery.extend(!0,target,deep),target}function ajaxHandleResponses(s,jqXHR,responses){for(var ct,type,finalDataType,firstDataType,contents=s.contents,dataTypes=s.dataTypes;"*"===dataTypes[0];)dataTypes.shift(),void 0===ct&&(ct=s.mimeType||jqXHR.getResponseHeader("Content-Type"));if(ct)for(type in contents)if(contents[type]&&contents[type].test(ct)){
dataTypes.unshift(type);break}if(dataTypes[0]in responses)finalDataType=dataTypes[0];else{for(type in responses){if(!dataTypes[0]||s.converters[type+" "+dataTypes[0]]){finalDataType=type;break}firstDataType||(firstDataType=type)}finalDataType=finalDataType||firstDataType}if(finalDataType)return finalDataType!==dataTypes[0]&&dataTypes.unshift(finalDataType),responses[finalDataType]}function ajaxConvert(s,response,jqXHR,isSuccess){var conv2,current,conv,tmp,prev,converters={},dataTypes=s.dataTypes.slice();if(dataTypes[1])for(conv in s.converters)converters[conv.toLowerCase()]=s.converters[conv];for(current=dataTypes.shift();current;)if(s.responseFields[current]&&(jqXHR[s.responseFields[current]]=response),
!prev&&isSuccess&&s.dataFilter&&(response=s.dataFilter(response,s.dataType)),prev=current,current=dataTypes.shift())if("*"===current)current=prev;else if("*"!==prev&&prev!==current){if(conv=converters[prev+" "+current]||converters["* "+current],!conv)for(conv2 in converters)if(tmp=conv2.split(" "),tmp[1]===current&&(conv=converters[prev+" "+tmp[0]]||converters["* "+tmp[0]])){conv===!0?conv=converters[conv2]:converters[conv2]!==!0&&(current=tmp[0],dataTypes.unshift(tmp[1]));break}if(conv!==!0)if(conv&&s.throws)response=conv(response);else try{response=conv(response)}catch(e){return{state:"parsererror",error:conv?e:"No conversion from "+prev+" to "+current}}}return{
state:"success",data:response}}function buildParams(prefix,obj,traditional,add){var name;if(jQuery.isArray(obj))jQuery.each(obj,function(i,v){traditional||rbracket.test(prefix)?add(prefix,v):buildParams(prefix+"["+("object"==typeof v?i:"")+"]",v,traditional,add)});else if(traditional||"object"!==jQuery.type(obj))add(prefix,obj);else for(name in obj)buildParams(prefix+"["+name+"]",obj[name],traditional,add)}function getWindow(elem){return jQuery.isWindow(elem)?elem:9===elem.nodeType&&elem.defaultView}var arr=[],slice=arr.slice,concat=arr.concat,push=arr.push,indexOf=arr.indexOf,class2type={},toString=class2type.toString,hasOwn=class2type.hasOwnProperty,support={},document=window.document,version="2.1.1",jQuery=function(selector,context){
return new jQuery.fn.init(selector,context)},rtrim=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,rmsPrefix=/^-ms-/,rdashAlpha=/-([\da-z])/gi,fcamelCase=function(all,letter){return letter.toUpperCase()};jQuery.fn=jQuery.prototype={jquery:version,constructor:jQuery,selector:"",length:0,toArray:function(){return slice.call(this)},get:function(num){return null!=num?num<0?this[num+this.length]:this[num]:slice.call(this)},pushStack:function(elems){var ret=jQuery.merge(this.constructor(),elems);return ret.prevObject=this,ret.context=this.context,ret},each:function(callback,args){return jQuery.each(this,callback,args)},map:function(callback){return this.pushStack(jQuery.map(this,function(elem,i){
return callback.call(elem,i,elem)}))},slice:function(){return this.pushStack(slice.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(i){var len=this.length,j=+i+(i<0?len:0);return this.pushStack(j>=0&&j<len?[this[j]]:[])},end:function(){return this.prevObject||this.constructor(null)},push:push,sort:arr.sort,splice:arr.splice},jQuery.extend=jQuery.fn.extend=function(){var options,name,src,copy,copyIsArray,clone,target=arguments[0]||{},i=1,length=arguments.length,deep=!1;for("boolean"==typeof target&&(deep=target,target=arguments[i]||{},i++),"object"==typeof target||jQuery.isFunction(target)||(target={}),
i===length&&(target=this,i--);i<length;i++)if(null!=(options=arguments[i]))for(name in options)src=target[name],copy=options[name],target!==copy&&(deep&&copy&&(jQuery.isPlainObject(copy)||(copyIsArray=jQuery.isArray(copy)))?(copyIsArray?(copyIsArray=!1,clone=src&&jQuery.isArray(src)?src:[]):clone=src&&jQuery.isPlainObject(src)?src:{},target[name]=jQuery.extend(deep,clone,copy)):void 0!==copy&&(target[name]=copy));return target},jQuery.extend({expando:"jQuery"+(version+Math.random()).replace(/\D/g,""),isReady:!0,error:function(msg){throw new Error(msg)},noop:function(){},isFunction:function(obj){return"function"===jQuery.type(obj)},isArray:Array.isArray,isWindow:function(obj){
return null!=obj&&obj===obj.window},isNumeric:function(obj){return!jQuery.isArray(obj)&&obj-parseFloat(obj)>=0},isPlainObject:function(obj){return"object"===jQuery.type(obj)&&!obj.nodeType&&!jQuery.isWindow(obj)&&!(obj.constructor&&!hasOwn.call(obj.constructor.prototype,"isPrototypeOf"))},isEmptyObject:function(obj){var name;for(name in obj)return!1;return!0},type:function(obj){return null==obj?obj+"":"object"==typeof obj||"function"==typeof obj?class2type[toString.call(obj)]||"object":typeof obj},globalEval:function(code){var script,indirect=eval;code=jQuery.trim(code),code&&(1===code.indexOf("use strict")?(script=document.createElement("script"),script.text=code,
document.head.appendChild(script).parentNode.removeChild(script)):indirect(code))},camelCase:function(string){return string.replace(rmsPrefix,"ms-").replace(rdashAlpha,fcamelCase)},nodeName:function(elem,name){return elem.nodeName&&elem.nodeName.toLowerCase()===name.toLowerCase()},each:function(obj,callback,args){var value,i=0,length=obj.length,isArray=isArraylike(obj);if(args){if(isArray)for(;i<length&&(value=callback.apply(obj[i],args),value!==!1);i++);else for(i in obj)if(value=callback.apply(obj[i],args),value===!1)break}else if(isArray)for(;i<length&&(value=callback.call(obj[i],i,obj[i]),value!==!1);i++);else for(i in obj)if(value=callback.call(obj[i],i,obj[i]),
value===!1)break;return obj},trim:function(text){return null==text?"":(text+"").replace(rtrim,"")},makeArray:function(arr,results){var ret=results||[];return null!=arr&&(isArraylike(Object(arr))?jQuery.merge(ret,"string"==typeof arr?[arr]:arr):push.call(ret,arr)),ret},inArray:function(elem,arr,i){return null==arr?-1:indexOf.call(arr,elem,i)},merge:function(first,second){for(var len=+second.length,j=0,i=first.length;j<len;j++)first[i++]=second[j];return first.length=i,first},grep:function(elems,callback,invert){for(var callbackInverse,matches=[],i=0,length=elems.length,callbackExpect=!invert;i<length;i++)callbackInverse=!callback(elems[i],i),callbackInverse!==callbackExpect&&matches.push(elems[i]);
return matches},map:function(elems,callback,arg){var value,i=0,length=elems.length,isArray=isArraylike(elems),ret=[];if(isArray)for(;i<length;i++)value=callback(elems[i],i,arg),null!=value&&ret.push(value);else for(i in elems)value=callback(elems[i],i,arg),null!=value&&ret.push(value);return concat.apply([],ret)},guid:1,proxy:function(fn,context){var tmp,args,proxy;if("string"==typeof context&&(tmp=fn[context],context=fn,fn=tmp),jQuery.isFunction(fn))return args=slice.call(arguments,2),proxy=function(){return fn.apply(context||this,args.concat(slice.call(arguments)))},proxy.guid=fn.guid=fn.guid||jQuery.guid++,proxy},now:Date.now,support:support}),jQuery.each("Boolean Number String Function Array Date RegExp Object Error".split(" "),function(i,name){
class2type["[object "+name+"]"]=name.toLowerCase()});var Sizzle=function(window){function Sizzle(selector,context,results,seed){var match,elem,m,nodeType,i,groups,old,nid,newContext,newSelector;if((context?context.ownerDocument||context:preferredDoc)!==document&&setDocument(context),context=context||document,results=results||[],!selector||"string"!=typeof selector)return results;if(1!==(nodeType=context.nodeType)&&9!==nodeType)return[];if(documentIsHTML&&!seed){if(match=rquickExpr.exec(selector))if(m=match[1]){if(9===nodeType){if(elem=context.getElementById(m),!elem||!elem.parentNode)return results;if(elem.id===m)return results.push(elem),results}else if(context.ownerDocument&&(elem=context.ownerDocument.getElementById(m))&&contains(context,elem)&&elem.id===m)return results.push(elem),
results}else{if(match[2])return push.apply(results,context.getElementsByTagName(selector)),results;if((m=match[3])&&support.getElementsByClassName&&context.getElementsByClassName)return push.apply(results,context.getElementsByClassName(m)),results}if(support.qsa&&(!rbuggyQSA||!rbuggyQSA.test(selector))){if(nid=old=expando,newContext=context,newSelector=9===nodeType&&selector,1===nodeType&&"object"!==context.nodeName.toLowerCase()){for(groups=tokenize(selector),(old=context.getAttribute("id"))?nid=old.replace(rescape,"\\$&"):context.setAttribute("id",nid),nid="[id='"+nid+"'] ",i=groups.length;i--;)groups[i]=nid+toSelector(groups[i]);newContext=rsibling.test(selector)&&testContext(context.parentNode)||context,
newSelector=groups.join(",")}if(newSelector)try{return push.apply(results,newContext.querySelectorAll(newSelector)),results}catch(qsaError){}finally{old||context.removeAttribute("id")}}}return select(selector.replace(rtrim,"$1"),context,results,seed)}function createCache(){function cache(key,value){return keys.push(key+" ")>Expr.cacheLength&&delete cache[keys.shift()],cache[key+" "]=value}var keys=[];return cache}function markFunction(fn){return fn[expando]=!0,fn}function assert(fn){var div=document.createElement("div");try{return!!fn(div)}catch(e){return!1}finally{div.parentNode&&div.parentNode.removeChild(div),div=null}}function addHandle(attrs,handler){for(var arr=attrs.split("|"),i=attrs.length;i--;)Expr.attrHandle[arr[i]]=handler;
}function siblingCheck(a,b){var cur=b&&a,diff=cur&&1===a.nodeType&&1===b.nodeType&&(~b.sourceIndex||MAX_NEGATIVE)-(~a.sourceIndex||MAX_NEGATIVE);if(diff)return diff;if(cur)for(;cur=cur.nextSibling;)if(cur===b)return-1;return a?1:-1}function createInputPseudo(type){return function(elem){var name=elem.nodeName.toLowerCase();return"input"===name&&elem.type===type}}function createButtonPseudo(type){return function(elem){var name=elem.nodeName.toLowerCase();return("input"===name||"button"===name)&&elem.type===type}}function createPositionalPseudo(fn){return markFunction(function(argument){return argument=+argument,markFunction(function(seed,matches){for(var j,matchIndexes=fn([],seed.length,argument),i=matchIndexes.length;i--;)seed[j=matchIndexes[i]]&&(seed[j]=!(matches[j]=seed[j]));
})})}function testContext(context){return context&&typeof context.getElementsByTagName!==strundefined&&context}function setFilters(){}function toSelector(tokens){for(var i=0,len=tokens.length,selector="";i<len;i++)selector+=tokens[i].value;return selector}function addCombinator(matcher,combinator,base){var dir=combinator.dir,checkNonElements=base&&"parentNode"===dir,doneName=done++;return combinator.first?function(elem,context,xml){for(;elem=elem[dir];)if(1===elem.nodeType||checkNonElements)return matcher(elem,context,xml)}:function(elem,context,xml){var oldCache,outerCache,newCache=[dirruns,doneName];if(xml){for(;elem=elem[dir];)if((1===elem.nodeType||checkNonElements)&&matcher(elem,context,xml))return!0;
}else for(;elem=elem[dir];)if(1===elem.nodeType||checkNonElements){if(outerCache=elem[expando]||(elem[expando]={}),(oldCache=outerCache[dir])&&oldCache[0]===dirruns&&oldCache[1]===doneName)return newCache[2]=oldCache[2];if(outerCache[dir]=newCache,newCache[2]=matcher(elem,context,xml))return!0}}}function elementMatcher(matchers){return matchers.length>1?function(elem,context,xml){for(var i=matchers.length;i--;)if(!matchers[i](elem,context,xml))return!1;return!0}:matchers[0]}function multipleContexts(selector,contexts,results){for(var i=0,len=contexts.length;i<len;i++)Sizzle(selector,contexts[i],results);return results}function condense(unmatched,map,filter,context,xml){
for(var elem,newUnmatched=[],i=0,len=unmatched.length,mapped=null!=map;i<len;i++)(elem=unmatched[i])&&(filter&&!filter(elem,context,xml)||(newUnmatched.push(elem),mapped&&map.push(i)));return newUnmatched}function setMatcher(preFilter,selector,matcher,postFilter,postFinder,postSelector){return postFilter&&!postFilter[expando]&&(postFilter=setMatcher(postFilter)),postFinder&&!postFinder[expando]&&(postFinder=setMatcher(postFinder,postSelector)),markFunction(function(seed,results,context,xml){var temp,i,elem,preMap=[],postMap=[],preexisting=results.length,elems=seed||multipleContexts(selector||"*",context.nodeType?[context]:context,[]),matcherIn=!preFilter||!seed&&selector?elems:condense(elems,preMap,preFilter,context,xml),matcherOut=matcher?postFinder||(seed?preFilter:preexisting||postFilter)?[]:results:matcherIn;
if(matcher&&matcher(matcherIn,matcherOut,context,xml),postFilter)for(temp=condense(matcherOut,postMap),postFilter(temp,[],context,xml),i=temp.length;i--;)(elem=temp[i])&&(matcherOut[postMap[i]]=!(matcherIn[postMap[i]]=elem));if(seed){if(postFinder||preFilter){if(postFinder){for(temp=[],i=matcherOut.length;i--;)(elem=matcherOut[i])&&temp.push(matcherIn[i]=elem);postFinder(null,matcherOut=[],temp,xml)}for(i=matcherOut.length;i--;)(elem=matcherOut[i])&&(temp=postFinder?indexOf.call(seed,elem):preMap[i])>-1&&(seed[temp]=!(results[temp]=elem))}}else matcherOut=condense(matcherOut===results?matcherOut.splice(preexisting,matcherOut.length):matcherOut),postFinder?postFinder(null,results,matcherOut,xml):push.apply(results,matcherOut);
})}function matcherFromTokens(tokens){for(var checkContext,matcher,j,len=tokens.length,leadingRelative=Expr.relative[tokens[0].type],implicitRelative=leadingRelative||Expr.relative[" "],i=leadingRelative?1:0,matchContext=addCombinator(function(elem){return elem===checkContext},implicitRelative,!0),matchAnyContext=addCombinator(function(elem){return indexOf.call(checkContext,elem)>-1},implicitRelative,!0),matchers=[function(elem,context,xml){return!leadingRelative&&(xml||context!==outermostContext)||((checkContext=context).nodeType?matchContext(elem,context,xml):matchAnyContext(elem,context,xml))}];i<len;i++)if(matcher=Expr.relative[tokens[i].type])matchers=[addCombinator(elementMatcher(matchers),matcher)];else{
if(matcher=Expr.filter[tokens[i].type].apply(null,tokens[i].matches),matcher[expando]){for(j=++i;j<len&&!Expr.relative[tokens[j].type];j++);return setMatcher(i>1&&elementMatcher(matchers),i>1&&toSelector(tokens.slice(0,i-1).concat({value:" "===tokens[i-2].type?"*":""})).replace(rtrim,"$1"),matcher,i<j&&matcherFromTokens(tokens.slice(i,j)),j<len&&matcherFromTokens(tokens=tokens.slice(j)),j<len&&toSelector(tokens))}matchers.push(matcher)}return elementMatcher(matchers)}function matcherFromGroupMatchers(elementMatchers,setMatchers){var bySet=setMatchers.length>0,byElement=elementMatchers.length>0,superMatcher=function(seed,context,xml,results,outermost){var elem,j,matcher,matchedCount=0,i="0",unmatched=seed&&[],setMatched=[],contextBackup=outermostContext,elems=seed||byElement&&Expr.find.TAG("*",outermost),dirrunsUnique=dirruns+=null==contextBackup?1:Math.random()||.1,len=elems.length;
for(outermost&&(outermostContext=context!==document&&context);i!==len&&null!=(elem=elems[i]);i++){if(byElement&&elem){for(j=0;matcher=elementMatchers[j++];)if(matcher(elem,context,xml)){results.push(elem);break}outermost&&(dirruns=dirrunsUnique)}bySet&&((elem=!matcher&&elem)&&matchedCount--,seed&&unmatched.push(elem))}if(matchedCount+=i,bySet&&i!==matchedCount){for(j=0;matcher=setMatchers[j++];)matcher(unmatched,setMatched,context,xml);if(seed){if(matchedCount>0)for(;i--;)unmatched[i]||setMatched[i]||(setMatched[i]=pop.call(results));setMatched=condense(setMatched)}push.apply(results,setMatched),outermost&&!seed&&setMatched.length>0&&matchedCount+setMatchers.length>1&&Sizzle.uniqueSort(results);
}return outermost&&(dirruns=dirrunsUnique,outermostContext=contextBackup),unmatched};return bySet?markFunction(superMatcher):superMatcher}var i,support,Expr,getText,isXML,tokenize,compile,select,outermostContext,sortInput,hasDuplicate,setDocument,document,docElem,documentIsHTML,rbuggyQSA,rbuggyMatches,matches,contains,expando="sizzle"+-new Date,preferredDoc=window.document,dirruns=0,done=0,classCache=createCache(),tokenCache=createCache(),compilerCache=createCache(),sortOrder=function(a,b){return a===b&&(hasDuplicate=!0),0},strundefined="undefined",MAX_NEGATIVE=1<<31,hasOwn={}.hasOwnProperty,arr=[],pop=arr.pop,push_native=arr.push,push=arr.push,slice=arr.slice,indexOf=arr.indexOf||function(elem){
for(var i=0,len=this.length;i<len;i++)if(this[i]===elem)return i;return-1},booleans="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",whitespace="[\\x20\\t\\r\\n\\f]",characterEncoding="(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+",identifier=characterEncoding.replace("w","w#"),attributes="\\["+whitespace+"*("+characterEncoding+")(?:"+whitespace+"*([*^$|!~]?=)"+whitespace+"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+identifier+"))|)"+whitespace+"*\\]",pseudos=":("+characterEncoding+")(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|"+attributes+")*)|.*)\\)|)",rtrim=new RegExp("^"+whitespace+"+|((?:^|[^\\\\])(?:\\\\.)*)"+whitespace+"+$","g"),rcomma=new RegExp("^"+whitespace+"*,"+whitespace+"*"),rcombinators=new RegExp("^"+whitespace+"*([>+~]|"+whitespace+")"+whitespace+"*"),rattributeQuotes=new RegExp("="+whitespace+"*([^\\]'\"]*?)"+whitespace+"*\\]","g"),rpseudo=new RegExp(pseudos),ridentifier=new RegExp("^"+identifier+"$"),matchExpr={
ID:new RegExp("^#("+characterEncoding+")"),CLASS:new RegExp("^\\.("+characterEncoding+")"),TAG:new RegExp("^("+characterEncoding.replace("w","w*")+")"),ATTR:new RegExp("^"+attributes),PSEUDO:new RegExp("^"+pseudos),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+whitespace+"*(even|odd|(([+-]|)(\\d*)n|)"+whitespace+"*(?:([+-]|)"+whitespace+"*(\\d+)|))"+whitespace+"*\\)|)","i"),bool:new RegExp("^(?:"+booleans+")$","i"),needsContext:new RegExp("^"+whitespace+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+whitespace+"*((?:-\\d)?\\d*)"+whitespace+"*\\)|)(?=[^-]|$)","i")},rinputs=/^(?:input|select|textarea|button)$/i,rheader=/^h\d$/i,rnative=/^[^{]+\{\s*\[native \w/,rquickExpr=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,rsibling=/[+~]/,rescape=/'|\\/g,runescape=new RegExp("\\\\([\\da-f]{1,6}"+whitespace+"?|("+whitespace+")|.)","ig"),funescape=function(_,escaped,escapedWhitespace){
var high="0x"+escaped-65536;return high!==high||escapedWhitespace?escaped:high<0?String.fromCharCode(high+65536):String.fromCharCode(high>>10|55296,1023&high|56320)};try{push.apply(arr=slice.call(preferredDoc.childNodes),preferredDoc.childNodes),arr[preferredDoc.childNodes.length].nodeType}catch(e){push={apply:arr.length?function(target,els){push_native.apply(target,slice.call(els))}:function(target,els){for(var j=target.length,i=0;target[j++]=els[i++];);target.length=j-1}}}support=Sizzle.support={},isXML=Sizzle.isXML=function(elem){var documentElement=elem&&(elem.ownerDocument||elem).documentElement;return!!documentElement&&"HTML"!==documentElement.nodeName},
setDocument=Sizzle.setDocument=function(node){var hasCompare,doc=node?node.ownerDocument||node:preferredDoc,parent=doc.defaultView;return doc!==document&&9===doc.nodeType&&doc.documentElement?(document=doc,docElem=doc.documentElement,documentIsHTML=!isXML(doc),parent&&parent!==parent.top&&(parent.addEventListener?parent.addEventListener("unload",function(){setDocument()},!1):parent.attachEvent&&parent.attachEvent("onunload",function(){setDocument()})),support.attributes=assert(function(div){return div.className="i",!div.getAttribute("className")}),support.getElementsByTagName=assert(function(div){return div.appendChild(doc.createComment("")),!div.getElementsByTagName("*").length;
}),support.getElementsByClassName=rnative.test(doc.getElementsByClassName)&&assert(function(div){return div.innerHTML="<div class='a'></div><div class='a i'></div>",div.firstChild.className="i",2===div.getElementsByClassName("i").length}),support.getById=assert(function(div){return docElem.appendChild(div).id=expando,!doc.getElementsByName||!doc.getElementsByName(expando).length}),support.getById?(Expr.find.ID=function(id,context){if(typeof context.getElementById!==strundefined&&documentIsHTML){var m=context.getElementById(id);return m&&m.parentNode?[m]:[]}},Expr.filter.ID=function(id){var attrId=id.replace(runescape,funescape);return function(elem){return elem.getAttribute("id")===attrId;
}}):(delete Expr.find.ID,Expr.filter.ID=function(id){var attrId=id.replace(runescape,funescape);return function(elem){var node=typeof elem.getAttributeNode!==strundefined&&elem.getAttributeNode("id");return node&&node.value===attrId}}),Expr.find.TAG=support.getElementsByTagName?function(tag,context){if(typeof context.getElementsByTagName!==strundefined)return context.getElementsByTagName(tag)}:function(tag,context){var elem,tmp=[],i=0,results=context.getElementsByTagName(tag);if("*"===tag){for(;elem=results[i++];)1===elem.nodeType&&tmp.push(elem);return tmp}return results},Expr.find.CLASS=support.getElementsByClassName&&function(className,context){if(typeof context.getElementsByClassName!==strundefined&&documentIsHTML)return context.getElementsByClassName(className);
},rbuggyMatches=[],rbuggyQSA=[],(support.qsa=rnative.test(doc.querySelectorAll))&&(assert(function(div){div.innerHTML="<select msallowclip=''><option selected=''></option></select>",div.querySelectorAll("[msallowclip^='']").length&&rbuggyQSA.push("[*^$]="+whitespace+"*(?:''|\"\")"),div.querySelectorAll("[selected]").length||rbuggyQSA.push("\\["+whitespace+"*(?:value|"+booleans+")"),div.querySelectorAll(":checked").length||rbuggyQSA.push(":checked")}),assert(function(div){var input=doc.createElement("input");input.setAttribute("type","hidden"),div.appendChild(input).setAttribute("name","D"),div.querySelectorAll("[name=d]").length&&rbuggyQSA.push("name"+whitespace+"*[*^$|!~]?="),
div.querySelectorAll(":enabled").length||rbuggyQSA.push(":enabled",":disabled"),div.querySelectorAll("*,:x"),rbuggyQSA.push(",.*:")})),(support.matchesSelector=rnative.test(matches=docElem.matches||docElem.webkitMatchesSelector||docElem.mozMatchesSelector||docElem.oMatchesSelector||docElem.msMatchesSelector))&&assert(function(div){support.disconnectedMatch=matches.call(div,"div"),matches.call(div,"[s!='']:x"),rbuggyMatches.push("!=",pseudos)}),rbuggyQSA=rbuggyQSA.length&&new RegExp(rbuggyQSA.join("|")),rbuggyMatches=rbuggyMatches.length&&new RegExp(rbuggyMatches.join("|")),hasCompare=rnative.test(docElem.compareDocumentPosition),contains=hasCompare||rnative.test(docElem.contains)?function(a,b){
var adown=9===a.nodeType?a.documentElement:a,bup=b&&b.parentNode;return a===bup||!(!bup||1!==bup.nodeType||!(adown.contains?adown.contains(bup):a.compareDocumentPosition&&16&a.compareDocumentPosition(bup)))}:function(a,b){if(b)for(;b=b.parentNode;)if(b===a)return!0;return!1},sortOrder=hasCompare?function(a,b){if(a===b)return hasDuplicate=!0,0;var compare=!a.compareDocumentPosition-!b.compareDocumentPosition;return compare?compare:(compare=(a.ownerDocument||a)===(b.ownerDocument||b)?a.compareDocumentPosition(b):1,1&compare||!support.sortDetached&&b.compareDocumentPosition(a)===compare?a===doc||a.ownerDocument===preferredDoc&&contains(preferredDoc,a)?-1:b===doc||b.ownerDocument===preferredDoc&&contains(preferredDoc,b)?1:sortInput?indexOf.call(sortInput,a)-indexOf.call(sortInput,b):0:4&compare?-1:1);
}:function(a,b){if(a===b)return hasDuplicate=!0,0;var cur,i=0,aup=a.parentNode,bup=b.parentNode,ap=[a],bp=[b];if(!aup||!bup)return a===doc?-1:b===doc?1:aup?-1:bup?1:sortInput?indexOf.call(sortInput,a)-indexOf.call(sortInput,b):0;if(aup===bup)return siblingCheck(a,b);for(cur=a;cur=cur.parentNode;)ap.unshift(cur);for(cur=b;cur=cur.parentNode;)bp.unshift(cur);for(;ap[i]===bp[i];)i++;return i?siblingCheck(ap[i],bp[i]):ap[i]===preferredDoc?-1:bp[i]===preferredDoc?1:0},doc):document},Sizzle.matches=function(expr,elements){return Sizzle(expr,null,null,elements)},Sizzle.matchesSelector=function(elem,expr){if((elem.ownerDocument||elem)!==document&&setDocument(elem),expr=expr.replace(rattributeQuotes,"='$1']"),
support.matchesSelector&&documentIsHTML&&(!rbuggyMatches||!rbuggyMatches.test(expr))&&(!rbuggyQSA||!rbuggyQSA.test(expr)))try{var ret=matches.call(elem,expr);if(ret||support.disconnectedMatch||elem.document&&11!==elem.document.nodeType)return ret}catch(e){}return Sizzle(expr,document,null,[elem]).length>0},Sizzle.contains=function(context,elem){return(context.ownerDocument||context)!==document&&setDocument(context),contains(context,elem)},Sizzle.attr=function(elem,name){(elem.ownerDocument||elem)!==document&&setDocument(elem);var fn=Expr.attrHandle[name.toLowerCase()],val=fn&&hasOwn.call(Expr.attrHandle,name.toLowerCase())?fn(elem,name,!documentIsHTML):void 0;
return void 0!==val?val:support.attributes||!documentIsHTML?elem.getAttribute(name):(val=elem.getAttributeNode(name))&&val.specified?val.value:null},Sizzle.error=function(msg){throw new Error("Syntax error, unrecognized expression: "+msg)},Sizzle.uniqueSort=function(results){var elem,duplicates=[],j=0,i=0;if(hasDuplicate=!support.detectDuplicates,sortInput=!support.sortStable&&results.slice(0),results.sort(sortOrder),hasDuplicate){for(;elem=results[i++];)elem===results[i]&&(j=duplicates.push(i));for(;j--;)results.splice(duplicates[j],1)}return sortInput=null,results},getText=Sizzle.getText=function(elem){var node,ret="",i=0,nodeType=elem.nodeType;if(nodeType){
if(1===nodeType||9===nodeType||11===nodeType){if("string"==typeof elem.textContent)return elem.textContent;for(elem=elem.firstChild;elem;elem=elem.nextSibling)ret+=getText(elem)}else if(3===nodeType||4===nodeType)return elem.nodeValue}else for(;node=elem[i++];)ret+=getText(node);return ret},Expr=Sizzle.selectors={cacheLength:50,createPseudo:markFunction,match:matchExpr,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(match){return match[1]=match[1].replace(runescape,funescape),match[3]=(match[3]||match[4]||match[5]||"").replace(runescape,funescape),
"~="===match[2]&&(match[3]=" "+match[3]+" "),match.slice(0,4)},CHILD:function(match){return match[1]=match[1].toLowerCase(),"nth"===match[1].slice(0,3)?(match[3]||Sizzle.error(match[0]),match[4]=+(match[4]?match[5]+(match[6]||1):2*("even"===match[3]||"odd"===match[3])),match[5]=+(match[7]+match[8]||"odd"===match[3])):match[3]&&Sizzle.error(match[0]),match},PSEUDO:function(match){var excess,unquoted=!match[6]&&match[2];return matchExpr.CHILD.test(match[0])?null:(match[3]?match[2]=match[4]||match[5]||"":unquoted&&rpseudo.test(unquoted)&&(excess=tokenize(unquoted,!0))&&(excess=unquoted.indexOf(")",unquoted.length-excess)-unquoted.length)&&(match[0]=match[0].slice(0,excess),
match[2]=unquoted.slice(0,excess)),match.slice(0,3))}},filter:{TAG:function(nodeNameSelector){var nodeName=nodeNameSelector.replace(runescape,funescape).toLowerCase();return"*"===nodeNameSelector?function(){return!0}:function(elem){return elem.nodeName&&elem.nodeName.toLowerCase()===nodeName}},CLASS:function(className){var pattern=classCache[className+" "];return pattern||(pattern=new RegExp("(^|"+whitespace+")"+className+"("+whitespace+"|$)"))&&classCache(className,function(elem){return pattern.test("string"==typeof elem.className&&elem.className||typeof elem.getAttribute!==strundefined&&elem.getAttribute("class")||"")})},ATTR:function(name,operator,check){return function(elem){
var result=Sizzle.attr(elem,name);return null==result?"!="===operator:!operator||(result+="","="===operator?result===check:"!="===operator?result!==check:"^="===operator?check&&0===result.indexOf(check):"*="===operator?check&&result.indexOf(check)>-1:"$="===operator?check&&result.slice(-check.length)===check:"~="===operator?(" "+result+" ").indexOf(check)>-1:"|="===operator&&(result===check||result.slice(0,check.length+1)===check+"-"))}},CHILD:function(type,what,argument,first,last){var simple="nth"!==type.slice(0,3),forward="last"!==type.slice(-4),ofType="of-type"===what;return 1===first&&0===last?function(elem){return!!elem.parentNode}:function(elem,context,xml){
var cache,outerCache,node,diff,nodeIndex,start,dir=simple!==forward?"nextSibling":"previousSibling",parent=elem.parentNode,name=ofType&&elem.nodeName.toLowerCase(),useCache=!xml&&!ofType;if(parent){if(simple){for(;dir;){for(node=elem;node=node[dir];)if(ofType?node.nodeName.toLowerCase()===name:1===node.nodeType)return!1;start=dir="only"===type&&!start&&"nextSibling"}return!0}if(start=[forward?parent.firstChild:parent.lastChild],forward&&useCache){for(outerCache=parent[expando]||(parent[expando]={}),cache=outerCache[type]||[],nodeIndex=cache[0]===dirruns&&cache[1],diff=cache[0]===dirruns&&cache[2],node=nodeIndex&&parent.childNodes[nodeIndex];node=++nodeIndex&&node&&node[dir]||(diff=nodeIndex=0)||start.pop();)if(1===node.nodeType&&++diff&&node===elem){
outerCache[type]=[dirruns,nodeIndex,diff];break}}else if(useCache&&(cache=(elem[expando]||(elem[expando]={}))[type])&&cache[0]===dirruns)diff=cache[1];else for(;(node=++nodeIndex&&node&&node[dir]||(diff=nodeIndex=0)||start.pop())&&((ofType?node.nodeName.toLowerCase()!==name:1!==node.nodeType)||!++diff||(useCache&&((node[expando]||(node[expando]={}))[type]=[dirruns,diff]),node!==elem)););return diff-=last,diff===first||diff%first===0&&diff/first>=0}}},PSEUDO:function(pseudo,argument){var args,fn=Expr.pseudos[pseudo]||Expr.setFilters[pseudo.toLowerCase()]||Sizzle.error("unsupported pseudo: "+pseudo);return fn[expando]?fn(argument):fn.length>1?(args=[pseudo,pseudo,"",argument],
Expr.setFilters.hasOwnProperty(pseudo.toLowerCase())?markFunction(function(seed,matches){for(var idx,matched=fn(seed,argument),i=matched.length;i--;)idx=indexOf.call(seed,matched[i]),seed[idx]=!(matches[idx]=matched[i])}):function(elem){return fn(elem,0,args)}):fn}},pseudos:{not:markFunction(function(selector){var input=[],results=[],matcher=compile(selector.replace(rtrim,"$1"));return matcher[expando]?markFunction(function(seed,matches,context,xml){for(var elem,unmatched=matcher(seed,null,xml,[]),i=seed.length;i--;)(elem=unmatched[i])&&(seed[i]=!(matches[i]=elem))}):function(elem,context,xml){return input[0]=elem,matcher(input,null,xml,results),!results.pop();
}}),has:markFunction(function(selector){return function(elem){return Sizzle(selector,elem).length>0}}),contains:markFunction(function(text){return function(elem){return(elem.textContent||elem.innerText||getText(elem)).indexOf(text)>-1}}),lang:markFunction(function(lang){return ridentifier.test(lang||"")||Sizzle.error("unsupported lang: "+lang),lang=lang.replace(runescape,funescape).toLowerCase(),function(elem){var elemLang;do if(elemLang=documentIsHTML?elem.lang:elem.getAttribute("xml:lang")||elem.getAttribute("lang"))return elemLang=elemLang.toLowerCase(),elemLang===lang||0===elemLang.indexOf(lang+"-");while((elem=elem.parentNode)&&1===elem.nodeType);return!1;
}}),target:function(elem){var hash=window.location&&window.location.hash;return hash&&hash.slice(1)===elem.id},root:function(elem){return elem===docElem},focus:function(elem){return elem===document.activeElement&&(!document.hasFocus||document.hasFocus())&&!!(elem.type||elem.href||~elem.tabIndex)},enabled:function(elem){return elem.disabled===!1},disabled:function(elem){return elem.disabled===!0},checked:function(elem){var nodeName=elem.nodeName.toLowerCase();return"input"===nodeName&&!!elem.checked||"option"===nodeName&&!!elem.selected},selected:function(elem){return elem.parentNode&&elem.parentNode.selectedIndex,elem.selected===!0},empty:function(elem){for(elem=elem.firstChild;elem;elem=elem.nextSibling)if(elem.nodeType<6)return!1;
return!0},parent:function(elem){return!Expr.pseudos.empty(elem)},header:function(elem){return rheader.test(elem.nodeName)},input:function(elem){return rinputs.test(elem.nodeName)},button:function(elem){var name=elem.nodeName.toLowerCase();return"input"===name&&"button"===elem.type||"button"===name},text:function(elem){var attr;return"input"===elem.nodeName.toLowerCase()&&"text"===elem.type&&(null==(attr=elem.getAttribute("type"))||"text"===attr.toLowerCase())},first:createPositionalPseudo(function(){return[0]}),last:createPositionalPseudo(function(matchIndexes,length){return[length-1]}),eq:createPositionalPseudo(function(matchIndexes,length,argument){return[argument<0?argument+length:argument];
}),even:createPositionalPseudo(function(matchIndexes,length){for(var i=0;i<length;i+=2)matchIndexes.push(i);return matchIndexes}),odd:createPositionalPseudo(function(matchIndexes,length){for(var i=1;i<length;i+=2)matchIndexes.push(i);return matchIndexes}),lt:createPositionalPseudo(function(matchIndexes,length,argument){for(var i=argument<0?argument+length:argument;--i>=0;)matchIndexes.push(i);return matchIndexes}),gt:createPositionalPseudo(function(matchIndexes,length,argument){for(var i=argument<0?argument+length:argument;++i<length;)matchIndexes.push(i);return matchIndexes})}},Expr.pseudos.nth=Expr.pseudos.eq;for(i in{radio:!0,checkbox:!0,file:!0,password:!0,
image:!0})Expr.pseudos[i]=createInputPseudo(i);for(i in{submit:!0,reset:!0})Expr.pseudos[i]=createButtonPseudo(i);return setFilters.prototype=Expr.filters=Expr.pseudos,Expr.setFilters=new setFilters,tokenize=Sizzle.tokenize=function(selector,parseOnly){var matched,match,tokens,type,soFar,groups,preFilters,cached=tokenCache[selector+" "];if(cached)return parseOnly?0:cached.slice(0);for(soFar=selector,groups=[],preFilters=Expr.preFilter;soFar;){matched&&!(match=rcomma.exec(soFar))||(match&&(soFar=soFar.slice(match[0].length)||soFar),groups.push(tokens=[])),matched=!1,(match=rcombinators.exec(soFar))&&(matched=match.shift(),tokens.push({value:matched,type:match[0].replace(rtrim," ")
}),soFar=soFar.slice(matched.length));for(type in Expr.filter)!(match=matchExpr[type].exec(soFar))||preFilters[type]&&!(match=preFilters[type](match))||(matched=match.shift(),tokens.push({value:matched,type:type,matches:match}),soFar=soFar.slice(matched.length));if(!matched)break}return parseOnly?soFar.length:soFar?Sizzle.error(selector):tokenCache(selector,groups).slice(0)},compile=Sizzle.compile=function(selector,match){var i,setMatchers=[],elementMatchers=[],cached=compilerCache[selector+" "];if(!cached){for(match||(match=tokenize(selector)),i=match.length;i--;)cached=matcherFromTokens(match[i]),cached[expando]?setMatchers.push(cached):elementMatchers.push(cached);
cached=compilerCache(selector,matcherFromGroupMatchers(elementMatchers,setMatchers)),cached.selector=selector}return cached},select=Sizzle.select=function(selector,context,results,seed){var i,tokens,token,type,find,compiled="function"==typeof selector&&selector,match=!seed&&tokenize(selector=compiled.selector||selector);if(results=results||[],1===match.length){if(tokens=match[0]=match[0].slice(0),tokens.length>2&&"ID"===(token=tokens[0]).type&&support.getById&&9===context.nodeType&&documentIsHTML&&Expr.relative[tokens[1].type]){if(context=(Expr.find.ID(token.matches[0].replace(runescape,funescape),context)||[])[0],!context)return results;compiled&&(context=context.parentNode),
selector=selector.slice(tokens.shift().value.length)}for(i=matchExpr.needsContext.test(selector)?0:tokens.length;i--&&(token=tokens[i],!Expr.relative[type=token.type]);)if((find=Expr.find[type])&&(seed=find(token.matches[0].replace(runescape,funescape),rsibling.test(tokens[0].type)&&testContext(context.parentNode)||context))){if(tokens.splice(i,1),selector=seed.length&&toSelector(tokens),!selector)return push.apply(results,seed),results;break}}return(compiled||compile(selector,match))(seed,context,!documentIsHTML,results,rsibling.test(selector)&&testContext(context.parentNode)||context),results},support.sortStable=expando.split("").sort(sortOrder).join("")===expando,
support.detectDuplicates=!!hasDuplicate,setDocument(),support.sortDetached=assert(function(div1){return 1&div1.compareDocumentPosition(document.createElement("div"))}),assert(function(div){return div.innerHTML="<a href='#'></a>","#"===div.firstChild.getAttribute("href")})||addHandle("type|href|height|width",function(elem,name,isXML){if(!isXML)return elem.getAttribute(name,"type"===name.toLowerCase()?1:2)}),support.attributes&&assert(function(div){return div.innerHTML="<input/>",div.firstChild.setAttribute("value",""),""===div.firstChild.getAttribute("value")})||addHandle("value",function(elem,name,isXML){if(!isXML&&"input"===elem.nodeName.toLowerCase())return elem.defaultValue;
}),assert(function(div){return null==div.getAttribute("disabled")})||addHandle(booleans,function(elem,name,isXML){var val;if(!isXML)return elem[name]===!0?name.toLowerCase():(val=elem.getAttributeNode(name))&&val.specified?val.value:null}),Sizzle}(window);jQuery.find=Sizzle,jQuery.expr=Sizzle.selectors,jQuery.expr[":"]=jQuery.expr.pseudos,jQuery.unique=Sizzle.uniqueSort,jQuery.text=Sizzle.getText,jQuery.isXMLDoc=Sizzle.isXML,jQuery.contains=Sizzle.contains;var rneedsContext=jQuery.expr.match.needsContext,rsingleTag=/^<(\w+)\s*\/?>(?:<\/\1>|)$/,risSimple=/^.[^:#\[\.,]*$/;jQuery.filter=function(expr,elems,not){var elem=elems[0];return not&&(expr=":not("+expr+")"),
1===elems.length&&1===elem.nodeType?jQuery.find.matchesSelector(elem,expr)?[elem]:[]:jQuery.find.matches(expr,jQuery.grep(elems,function(elem){return 1===elem.nodeType}))},jQuery.fn.extend({find:function(selector){var i,len=this.length,ret=[],self=this;if("string"!=typeof selector)return this.pushStack(jQuery(selector).filter(function(){for(i=0;i<len;i++)if(jQuery.contains(self[i],this))return!0}));for(i=0;i<len;i++)jQuery.find(selector,self[i],ret);return ret=this.pushStack(len>1?jQuery.unique(ret):ret),ret.selector=this.selector?this.selector+" "+selector:selector,ret},filter:function(selector){return this.pushStack(winnow(this,selector||[],!1))},not:function(selector){
return this.pushStack(winnow(this,selector||[],!0))},is:function(selector){return!!winnow(this,"string"==typeof selector&&rneedsContext.test(selector)?jQuery(selector):selector||[],!1).length}});var rootjQuery,rquickExpr=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]*))$/,init=jQuery.fn.init=function(selector,context){var match,elem;if(!selector)return this;if("string"==typeof selector){if(match="<"===selector[0]&&">"===selector[selector.length-1]&&selector.length>=3?[null,selector,null]:rquickExpr.exec(selector),!match||!match[1]&&context)return!context||context.jquery?(context||rootjQuery).find(selector):this.constructor(context).find(selector);if(match[1]){if(context=context instanceof jQuery?context[0]:context,
jQuery.merge(this,jQuery.parseHTML(match[1],context&&context.nodeType?context.ownerDocument||context:document,!0)),rsingleTag.test(match[1])&&jQuery.isPlainObject(context))for(match in context)jQuery.isFunction(this[match])?this[match](context[match]):this.attr(match,context[match]);return this}return elem=document.getElementById(match[2]),elem&&elem.parentNode&&(this.length=1,this[0]=elem),this.context=document,this.selector=selector,this}return selector.nodeType?(this.context=this[0]=selector,this.length=1,this):jQuery.isFunction(selector)?"undefined"!=typeof rootjQuery.ready?rootjQuery.ready(selector):selector(jQuery):(void 0!==selector.selector&&(this.selector=selector.selector,
this.context=selector.context),jQuery.makeArray(selector,this))};init.prototype=jQuery.fn,rootjQuery=jQuery(document);var rparentsprev=/^(?:parents|prev(?:Until|All))/,guaranteedUnique={children:!0,contents:!0,next:!0,prev:!0};jQuery.extend({dir:function(elem,dir,until){for(var matched=[],truncate=void 0!==until;(elem=elem[dir])&&9!==elem.nodeType;)if(1===elem.nodeType){if(truncate&&jQuery(elem).is(until))break;matched.push(elem)}return matched},sibling:function(n,elem){for(var matched=[];n;n=n.nextSibling)1===n.nodeType&&n!==elem&&matched.push(n);return matched}}),jQuery.fn.extend({has:function(target){var targets=jQuery(target,this),l=targets.length;return this.filter(function(){
for(var i=0;i<l;i++)if(jQuery.contains(this,targets[i]))return!0})},closest:function(selectors,context){for(var cur,i=0,l=this.length,matched=[],pos=rneedsContext.test(selectors)||"string"!=typeof selectors?jQuery(selectors,context||this.context):0;i<l;i++)for(cur=this[i];cur&&cur!==context;cur=cur.parentNode)if(cur.nodeType<11&&(pos?pos.index(cur)>-1:1===cur.nodeType&&jQuery.find.matchesSelector(cur,selectors))){matched.push(cur);break}return this.pushStack(matched.length>1?jQuery.unique(matched):matched)},index:function(elem){return elem?"string"==typeof elem?indexOf.call(jQuery(elem),this[0]):indexOf.call(this,elem.jquery?elem[0]:elem):this[0]&&this[0].parentNode?this.first().prevAll().length:-1;
},add:function(selector,context){return this.pushStack(jQuery.unique(jQuery.merge(this.get(),jQuery(selector,context))))},addBack:function(selector){return this.add(null==selector?this.prevObject:this.prevObject.filter(selector))}}),jQuery.each({parent:function(elem){var parent=elem.parentNode;return parent&&11!==parent.nodeType?parent:null},parents:function(elem){return jQuery.dir(elem,"parentNode")},parentsUntil:function(elem,i,until){return jQuery.dir(elem,"parentNode",until)},next:function(elem){return sibling(elem,"nextSibling")},prev:function(elem){return sibling(elem,"previousSibling")},nextAll:function(elem){return jQuery.dir(elem,"nextSibling")},prevAll:function(elem){
return jQuery.dir(elem,"previousSibling")},nextUntil:function(elem,i,until){return jQuery.dir(elem,"nextSibling",until)},prevUntil:function(elem,i,until){return jQuery.dir(elem,"previousSibling",until)},siblings:function(elem){return jQuery.sibling((elem.parentNode||{}).firstChild,elem)},children:function(elem){return jQuery.sibling(elem.firstChild)},contents:function(elem){return elem.contentDocument||jQuery.merge([],elem.childNodes)}},function(name,fn){jQuery.fn[name]=function(until,selector){var matched=jQuery.map(this,fn,until);return"Until"!==name.slice(-5)&&(selector=until),selector&&"string"==typeof selector&&(matched=jQuery.filter(selector,matched)),this.length>1&&(guaranteedUnique[name]||jQuery.unique(matched),
rparentsprev.test(name)&&matched.reverse()),this.pushStack(matched)}});var rnotwhite=/\S+/g,optionsCache={};jQuery.Callbacks=function(options){options="string"==typeof options?optionsCache[options]||createOptions(options):jQuery.extend({},options);var memory,fired,firing,firingStart,firingLength,firingIndex,list=[],stack=!options.once&&[],fire=function(data){for(memory=options.memory&&data,fired=!0,firingIndex=firingStart||0,firingStart=0,firingLength=list.length,firing=!0;list&&firingIndex<firingLength;firingIndex++)if(list[firingIndex].apply(data[0],data[1])===!1&&options.stopOnFalse){memory=!1;break}firing=!1,list&&(stack?stack.length&&fire(stack.shift()):memory?list=[]:self.disable());
},self={add:function(){if(list){var start=list.length;!function add(args){jQuery.each(args,function(_,arg){var type=jQuery.type(arg);"function"===type?options.unique&&self.has(arg)||list.push(arg):arg&&arg.length&&"string"!==type&&add(arg)})}(arguments),firing?firingLength=list.length:memory&&(firingStart=start,fire(memory))}return this},remove:function(){return list&&jQuery.each(arguments,function(_,arg){for(var index;(index=jQuery.inArray(arg,list,index))>-1;)list.splice(index,1),firing&&(index<=firingLength&&firingLength--,index<=firingIndex&&firingIndex--)}),this},has:function(fn){return fn?jQuery.inArray(fn,list)>-1:!(!list||!list.length)},empty:function(){
return list=[],firingLength=0,this},disable:function(){return list=stack=memory=void 0,this},disabled:function(){return!list},lock:function(){return stack=void 0,memory||self.disable(),this},locked:function(){return!stack},fireWith:function(context,args){return!list||fired&&!stack||(args=args||[],args=[context,args.slice?args.slice():args],firing?stack.push(args):fire(args)),this},fire:function(){return self.fireWith(this,arguments),this},fired:function(){return!!fired}};return self},jQuery.extend({Deferred:function(func){var tuples=[["resolve","done",jQuery.Callbacks("once memory"),"resolved"],["reject","fail",jQuery.Callbacks("once memory"),"rejected"],["notify","progress",jQuery.Callbacks("memory")]],state="pending",promise={
state:function(){return state},always:function(){return deferred.done(arguments).fail(arguments),this},then:function(){var fns=arguments;return jQuery.Deferred(function(newDefer){jQuery.each(tuples,function(i,tuple){var fn=jQuery.isFunction(fns[i])&&fns[i];deferred[tuple[1]](function(){var returned=fn&&fn.apply(this,arguments);returned&&jQuery.isFunction(returned.promise)?returned.promise().done(newDefer.resolve).fail(newDefer.reject).progress(newDefer.notify):newDefer[tuple[0]+"With"](this===promise?newDefer.promise():this,fn?[returned]:arguments)})}),fns=null}).promise()},promise:function(obj){return null!=obj?jQuery.extend(obj,promise):promise}},deferred={};
return promise.pipe=promise.then,jQuery.each(tuples,function(i,tuple){var list=tuple[2],stateString=tuple[3];promise[tuple[1]]=list.add,stateString&&list.add(function(){state=stateString},tuples[1^i][2].disable,tuples[2][2].lock),deferred[tuple[0]]=function(){return deferred[tuple[0]+"With"](this===deferred?promise:this,arguments),this},deferred[tuple[0]+"With"]=list.fireWith}),promise.promise(deferred),func&&func.call(deferred,deferred),deferred},when:function(subordinate){var progressValues,progressContexts,resolveContexts,i=0,resolveValues=slice.call(arguments),length=resolveValues.length,remaining=1!==length||subordinate&&jQuery.isFunction(subordinate.promise)?length:0,deferred=1===remaining?subordinate:jQuery.Deferred(),updateFunc=function(i,contexts,values){
return function(value){contexts[i]=this,values[i]=arguments.length>1?slice.call(arguments):value,values===progressValues?deferred.notifyWith(contexts,values):--remaining||deferred.resolveWith(contexts,values)}};if(length>1)for(progressValues=new Array(length),progressContexts=new Array(length),resolveContexts=new Array(length);i<length;i++)resolveValues[i]&&jQuery.isFunction(resolveValues[i].promise)?resolveValues[i].promise().done(updateFunc(i,resolveContexts,resolveValues)).fail(deferred.reject).progress(updateFunc(i,progressContexts,progressValues)):--remaining;return remaining||deferred.resolveWith(resolveContexts,resolveValues),deferred.promise()}});var readyList;
jQuery.fn.ready=function(fn){return jQuery.ready.promise().done(fn),this},jQuery.extend({isReady:!1,readyWait:1,holdReady:function(hold){hold?jQuery.readyWait++:jQuery.ready(!0)},ready:function(wait){(wait===!0?--jQuery.readyWait:jQuery.isReady)||(jQuery.isReady=!0,wait!==!0&&--jQuery.readyWait>0||(readyList.resolveWith(document,[jQuery]),jQuery.fn.triggerHandler&&(jQuery(document).triggerHandler("ready"),jQuery(document).off("ready"))))}}),jQuery.ready.promise=function(obj){return readyList||(readyList=jQuery.Deferred(),"complete"===document.readyState?setTimeout(jQuery.ready):(document.addEventListener("DOMContentLoaded",completed,!1),window.addEventListener("load",completed,!1))),
readyList.promise(obj)},jQuery.ready.promise();var access=jQuery.access=function(elems,fn,key,value,chainable,emptyGet,raw){var i=0,len=elems.length,bulk=null==key;if("object"===jQuery.type(key)){chainable=!0;for(i in key)jQuery.access(elems,fn,i,key[i],!0,emptyGet,raw)}else if(void 0!==value&&(chainable=!0,jQuery.isFunction(value)||(raw=!0),bulk&&(raw?(fn.call(elems,value),fn=null):(bulk=fn,fn=function(elem,key,value){return bulk.call(jQuery(elem),value)})),fn))for(;i<len;i++)fn(elems[i],key,raw?value:value.call(elems[i],i,fn(elems[i],key)));return chainable?elems:bulk?fn.call(elems):len?fn(elems[0],key):emptyGet};jQuery.acceptData=function(owner){return 1===owner.nodeType||9===owner.nodeType||!+owner.nodeType;
},Data.uid=1,Data.accepts=jQuery.acceptData,Data.prototype={key:function(owner){if(!Data.accepts(owner))return 0;var descriptor={},unlock=owner[this.expando];if(!unlock){unlock=Data.uid++;try{descriptor[this.expando]={value:unlock},Object.defineProperties(owner,descriptor)}catch(e){descriptor[this.expando]=unlock,jQuery.extend(owner,descriptor)}}return this.cache[unlock]||(this.cache[unlock]={}),unlock},set:function(owner,data,value){var prop,unlock=this.key(owner),cache=this.cache[unlock];if("string"==typeof data)cache[data]=value;else if(jQuery.isEmptyObject(cache))jQuery.extend(this.cache[unlock],data);else for(prop in data)cache[prop]=data[prop];return cache;
},get:function(owner,key){var cache=this.cache[this.key(owner)];return void 0===key?cache:cache[key]},access:function(owner,key,value){var stored;return void 0===key||key&&"string"==typeof key&&void 0===value?(stored=this.get(owner,key),void 0!==stored?stored:this.get(owner,jQuery.camelCase(key))):(this.set(owner,key,value),void 0!==value?value:key)},remove:function(owner,key){var i,name,camel,unlock=this.key(owner),cache=this.cache[unlock];if(void 0===key)this.cache[unlock]={};else{jQuery.isArray(key)?name=key.concat(key.map(jQuery.camelCase)):(camel=jQuery.camelCase(key),key in cache?name=[key,camel]:(name=camel,name=name in cache?[name]:name.match(rnotwhite)||[])),
i=name.length;for(;i--;)delete cache[name[i]]}},hasData:function(owner){return!jQuery.isEmptyObject(this.cache[owner[this.expando]]||{})},discard:function(owner){owner[this.expando]&&delete this.cache[owner[this.expando]]}};var data_priv=new Data,data_user=new Data,rbrace=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,rmultiDash=/([A-Z])/g;jQuery.extend({hasData:function(elem){return data_user.hasData(elem)||data_priv.hasData(elem)},data:function(elem,name,data){return data_user.access(elem,name,data)},removeData:function(elem,name){data_user.remove(elem,name)},_data:function(elem,name,data){return data_priv.access(elem,name,data)},_removeData:function(elem,name){data_priv.remove(elem,name);
}}),jQuery.fn.extend({data:function(key,value){var i,name,data,elem=this[0],attrs=elem&&elem.attributes;if(void 0===key){if(this.length&&(data=data_user.get(elem),1===elem.nodeType&&!data_priv.get(elem,"hasDataAttrs"))){for(i=attrs.length;i--;)attrs[i]&&(name=attrs[i].name,0===name.indexOf("data-")&&(name=jQuery.camelCase(name.slice(5)),dataAttr(elem,name,data[name])));data_priv.set(elem,"hasDataAttrs",!0)}return data}return"object"==typeof key?this.each(function(){data_user.set(this,key)}):access(this,function(value){var data,camelKey=jQuery.camelCase(key);if(elem&&void 0===value){if(data=data_user.get(elem,key),void 0!==data)return data;if(data=data_user.get(elem,camelKey),
void 0!==data)return data;if(data=dataAttr(elem,camelKey,void 0),void 0!==data)return data}else this.each(function(){var data=data_user.get(this,camelKey);data_user.set(this,camelKey,value),key.indexOf("-")!==-1&&void 0!==data&&data_user.set(this,key,value)})},null,value,arguments.length>1,null,!0)},removeData:function(key){return this.each(function(){data_user.remove(this,key)})}}),jQuery.extend({queue:function(elem,type,data){var queue;if(elem)return type=(type||"fx")+"queue",queue=data_priv.get(elem,type),data&&(!queue||jQuery.isArray(data)?queue=data_priv.access(elem,type,jQuery.makeArray(data)):queue.push(data)),queue||[]},dequeue:function(elem,type){type=type||"fx";
var queue=jQuery.queue(elem,type),startLength=queue.length,fn=queue.shift(),hooks=jQuery._queueHooks(elem,type),next=function(){jQuery.dequeue(elem,type)};"inprogress"===fn&&(fn=queue.shift(),startLength--),fn&&("fx"===type&&queue.unshift("inprogress"),delete hooks.stop,fn.call(elem,next,hooks)),!startLength&&hooks&&hooks.empty.fire()},_queueHooks:function(elem,type){var key=type+"queueHooks";return data_priv.get(elem,key)||data_priv.access(elem,key,{empty:jQuery.Callbacks("once memory").add(function(){data_priv.remove(elem,[type+"queue",key])})})}}),jQuery.fn.extend({queue:function(type,data){var setter=2;return"string"!=typeof type&&(data=type,type="fx",setter--),
arguments.length<setter?jQuery.queue(this[0],type):void 0===data?this:this.each(function(){var queue=jQuery.queue(this,type,data);jQuery._queueHooks(this,type),"fx"===type&&"inprogress"!==queue[0]&&jQuery.dequeue(this,type)})},dequeue:function(type){return this.each(function(){jQuery.dequeue(this,type)})},clearQueue:function(type){return this.queue(type||"fx",[])},promise:function(type,obj){var tmp,count=1,defer=jQuery.Deferred(),elements=this,i=this.length,resolve=function(){--count||defer.resolveWith(elements,[elements])};for("string"!=typeof type&&(obj=type,type=void 0),type=type||"fx";i--;)tmp=data_priv.get(elements[i],type+"queueHooks"),tmp&&tmp.empty&&(count++,
tmp.empty.add(resolve));return resolve(),defer.promise(obj)}});var pnum=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,cssExpand=["Top","Right","Bottom","Left"],isHidden=function(elem,el){return elem=el||elem,"none"===jQuery.css(elem,"display")||!jQuery.contains(elem.ownerDocument,elem)},rcheckableType=/^(?:checkbox|radio)$/i;!function(){var fragment=document.createDocumentFragment(),div=fragment.appendChild(document.createElement("div")),input=document.createElement("input");input.setAttribute("type","radio"),input.setAttribute("checked","checked"),input.setAttribute("name","t"),div.appendChild(input),support.checkClone=div.cloneNode(!0).cloneNode(!0).lastChild.checked,
div.innerHTML="<textarea>x</textarea>",support.noCloneChecked=!!div.cloneNode(!0).lastChild.defaultValue}();var strundefined="undefined";support.focusinBubbles="onfocusin"in window;var rkeyEvent=/^key/,rmouseEvent=/^(?:mouse|pointer|contextmenu)|click/,rfocusMorph=/^(?:focusinfocus|focusoutblur)$/,rtypenamespace=/^([^.]*)(?:\.(.+)|)$/;jQuery.event={global:{},add:function(elem,types,handler,data,selector){var handleObjIn,eventHandle,tmp,events,t,handleObj,special,handlers,type,namespaces,origType,elemData=data_priv.get(elem);if(elemData)for(handler.handler&&(handleObjIn=handler,handler=handleObjIn.handler,selector=handleObjIn.selector),handler.guid||(handler.guid=jQuery.guid++),
(events=elemData.events)||(events=elemData.events={}),(eventHandle=elemData.handle)||(eventHandle=elemData.handle=function(e){return typeof jQuery!==strundefined&&jQuery.event.triggered!==e.type?jQuery.event.dispatch.apply(elem,arguments):void 0}),types=(types||"").match(rnotwhite)||[""],t=types.length;t--;)tmp=rtypenamespace.exec(types[t])||[],type=origType=tmp[1],namespaces=(tmp[2]||"").split(".").sort(),type&&(special=jQuery.event.special[type]||{},type=(selector?special.delegateType:special.bindType)||type,special=jQuery.event.special[type]||{},handleObj=jQuery.extend({type:type,origType:origType,data:data,handler:handler,guid:handler.guid,selector:selector,
needsContext:selector&&jQuery.expr.match.needsContext.test(selector),namespace:namespaces.join(".")},handleObjIn),(handlers=events[type])||(handlers=events[type]=[],handlers.delegateCount=0,special.setup&&special.setup.call(elem,data,namespaces,eventHandle)!==!1||elem.addEventListener&&elem.addEventListener(type,eventHandle,!1)),special.add&&(special.add.call(elem,handleObj),handleObj.handler.guid||(handleObj.handler.guid=handler.guid)),selector?handlers.splice(handlers.delegateCount++,0,handleObj):handlers.push(handleObj),jQuery.event.global[type]=!0)},remove:function(elem,types,handler,selector,mappedTypes){var j,origCount,tmp,events,t,handleObj,special,handlers,type,namespaces,origType,elemData=data_priv.hasData(elem)&&data_priv.get(elem);
if(elemData&&(events=elemData.events)){for(types=(types||"").match(rnotwhite)||[""],t=types.length;t--;)if(tmp=rtypenamespace.exec(types[t])||[],type=origType=tmp[1],namespaces=(tmp[2]||"").split(".").sort(),type){for(special=jQuery.event.special[type]||{},type=(selector?special.delegateType:special.bindType)||type,handlers=events[type]||[],tmp=tmp[2]&&new RegExp("(^|\\.)"+namespaces.join("\\.(?:.*\\.|)")+"(\\.|$)"),origCount=j=handlers.length;j--;)handleObj=handlers[j],!mappedTypes&&origType!==handleObj.origType||handler&&handler.guid!==handleObj.guid||tmp&&!tmp.test(handleObj.namespace)||selector&&selector!==handleObj.selector&&("**"!==selector||!handleObj.selector)||(handlers.splice(j,1),
handleObj.selector&&handlers.delegateCount--,special.remove&&special.remove.call(elem,handleObj));origCount&&!handlers.length&&(special.teardown&&special.teardown.call(elem,namespaces,elemData.handle)!==!1||jQuery.removeEvent(elem,type,elemData.handle),delete events[type])}else for(type in events)jQuery.event.remove(elem,type+types[t],handler,selector,!0);jQuery.isEmptyObject(events)&&(delete elemData.handle,data_priv.remove(elem,"events"))}},trigger:function(event,data,elem,onlyHandlers){var i,cur,tmp,bubbleType,ontype,handle,special,eventPath=[elem||document],type=hasOwn.call(event,"type")?event.type:event,namespaces=hasOwn.call(event,"namespace")?event.namespace.split("."):[];
if(cur=tmp=elem=elem||document,3!==elem.nodeType&&8!==elem.nodeType&&!rfocusMorph.test(type+jQuery.event.triggered)&&(type.indexOf(".")>=0&&(namespaces=type.split("."),type=namespaces.shift(),namespaces.sort()),ontype=type.indexOf(":")<0&&"on"+type,event=event[jQuery.expando]?event:new jQuery.Event(type,"object"==typeof event&&event),event.isTrigger=onlyHandlers?2:3,event.namespace=namespaces.join("."),event.namespace_re=event.namespace?new RegExp("(^|\\.)"+namespaces.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,event.result=void 0,event.target||(event.target=elem),data=null==data?[event]:jQuery.makeArray(data,[event]),special=jQuery.event.special[type]||{},onlyHandlers||!special.trigger||special.trigger.apply(elem,data)!==!1)){
if(!onlyHandlers&&!special.noBubble&&!jQuery.isWindow(elem)){for(bubbleType=special.delegateType||type,rfocusMorph.test(bubbleType+type)||(cur=cur.parentNode);cur;cur=cur.parentNode)eventPath.push(cur),tmp=cur;tmp===(elem.ownerDocument||document)&&eventPath.push(tmp.defaultView||tmp.parentWindow||window)}for(i=0;(cur=eventPath[i++])&&!event.isPropagationStopped();)event.type=i>1?bubbleType:special.bindType||type,handle=(data_priv.get(cur,"events")||{})[event.type]&&data_priv.get(cur,"handle"),handle&&handle.apply(cur,data),handle=ontype&&cur[ontype],handle&&handle.apply&&jQuery.acceptData(cur)&&(event.result=handle.apply(cur,data),event.result===!1&&event.preventDefault());
return event.type=type,onlyHandlers||event.isDefaultPrevented()||special._default&&special._default.apply(eventPath.pop(),data)!==!1||!jQuery.acceptData(elem)||ontype&&jQuery.isFunction(elem[type])&&!jQuery.isWindow(elem)&&(tmp=elem[ontype],tmp&&(elem[ontype]=null),jQuery.event.triggered=type,elem[type](),jQuery.event.triggered=void 0,tmp&&(elem[ontype]=tmp)),event.result}},dispatch:function(event){event=jQuery.event.fix(event);var i,j,ret,matched,handleObj,handlerQueue=[],args=slice.call(arguments),handlers=(data_priv.get(this,"events")||{})[event.type]||[],special=jQuery.event.special[event.type]||{};if(args[0]=event,event.delegateTarget=this,!special.preDispatch||special.preDispatch.call(this,event)!==!1){
for(handlerQueue=jQuery.event.handlers.call(this,event,handlers),i=0;(matched=handlerQueue[i++])&&!event.isPropagationStopped();)for(event.currentTarget=matched.elem,j=0;(handleObj=matched.handlers[j++])&&!event.isImmediatePropagationStopped();)event.namespace_re&&!event.namespace_re.test(handleObj.namespace)||(event.handleObj=handleObj,event.data=handleObj.data,ret=((jQuery.event.special[handleObj.origType]||{}).handle||handleObj.handler).apply(matched.elem,args),void 0!==ret&&(event.result=ret)===!1&&(event.preventDefault(),event.stopPropagation()));return special.postDispatch&&special.postDispatch.call(this,event),event.result}},handlers:function(event,handlers){
var i,matches,sel,handleObj,handlerQueue=[],delegateCount=handlers.delegateCount,cur=event.target;if(delegateCount&&cur.nodeType&&(!event.button||"click"!==event.type))for(;cur!==this;cur=cur.parentNode||this)if(cur.disabled!==!0||"click"!==event.type){for(matches=[],i=0;i<delegateCount;i++)handleObj=handlers[i],sel=handleObj.selector+" ",void 0===matches[sel]&&(matches[sel]=handleObj.needsContext?jQuery(sel,this).index(cur)>=0:jQuery.find(sel,this,null,[cur]).length),matches[sel]&&matches.push(handleObj);matches.length&&handlerQueue.push({elem:cur,handlers:matches})}return delegateCount<handlers.length&&handlerQueue.push({elem:this,handlers:handlers.slice(delegateCount)
}),handlerQueue},props:"altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(event,original){return null==event.which&&(event.which=null!=original.charCode?original.charCode:original.keyCode),event}},mouseHooks:{props:"button buttons clientX clientY offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(event,original){var eventDoc,doc,body,button=original.button;return null==event.pageX&&null!=original.clientX&&(eventDoc=event.target.ownerDocument||document,doc=eventDoc.documentElement,
body=eventDoc.body,event.pageX=original.clientX+(doc&&doc.scrollLeft||body&&body.scrollLeft||0)-(doc&&doc.clientLeft||body&&body.clientLeft||0),event.pageY=original.clientY+(doc&&doc.scrollTop||body&&body.scrollTop||0)-(doc&&doc.clientTop||body&&body.clientTop||0)),event.which||void 0===button||(event.which=1&button?1:2&button?3:4&button?2:0),event}},fix:function(event){if(event[jQuery.expando])return event;var i,prop,copy,type=event.type,originalEvent=event,fixHook=this.fixHooks[type];for(fixHook||(this.fixHooks[type]=fixHook=rmouseEvent.test(type)?this.mouseHooks:rkeyEvent.test(type)?this.keyHooks:{}),copy=fixHook.props?this.props.concat(fixHook.props):this.props,
event=new jQuery.Event(originalEvent),i=copy.length;i--;)prop=copy[i],event[prop]=originalEvent[prop];return event.target||(event.target=document),3===event.target.nodeType&&(event.target=event.target.parentNode),fixHook.filter?fixHook.filter(event,originalEvent):event},special:{load:{noBubble:!0},focus:{trigger:function(){if(this!==safeActiveElement()&&this.focus)return this.focus(),!1},delegateType:"focusin"},blur:{trigger:function(){if(this===safeActiveElement()&&this.blur)return this.blur(),!1},delegateType:"focusout"},click:{trigger:function(){if("checkbox"===this.type&&this.click&&jQuery.nodeName(this,"input"))return this.click(),!1},_default:function(event){
return jQuery.nodeName(event.target,"a")}},beforeunload:{postDispatch:function(event){void 0!==event.result&&event.originalEvent&&(event.originalEvent.returnValue=event.result)}}},simulate:function(type,elem,event,bubble){var e=jQuery.extend(new jQuery.Event,event,{type:type,isSimulated:!0,originalEvent:{}});bubble?jQuery.event.trigger(e,null,elem):jQuery.event.dispatch.call(elem,e),e.isDefaultPrevented()&&event.preventDefault()}},jQuery.removeEvent=function(elem,type,handle){elem.removeEventListener&&elem.removeEventListener(type,handle,!1)},jQuery.Event=function(src,props){return this instanceof jQuery.Event?(src&&src.type?(this.originalEvent=src,this.type=src.type,
this.isDefaultPrevented=src.defaultPrevented||void 0===src.defaultPrevented&&src.returnValue===!1?returnTrue:returnFalse):this.type=src,props&&jQuery.extend(this,props),this.timeStamp=src&&src.timeStamp||jQuery.now(),void(this[jQuery.expando]=!0)):new jQuery.Event(src,props)},jQuery.Event.prototype={isDefaultPrevented:returnFalse,isPropagationStopped:returnFalse,isImmediatePropagationStopped:returnFalse,preventDefault:function(){var e=this.originalEvent;this.isDefaultPrevented=returnTrue,e&&e.preventDefault&&e.preventDefault()},stopPropagation:function(){var e=this.originalEvent;this.isPropagationStopped=returnTrue,e&&e.stopPropagation&&e.stopPropagation()},stopImmediatePropagation:function(){
var e=this.originalEvent;this.isImmediatePropagationStopped=returnTrue,e&&e.stopImmediatePropagation&&e.stopImmediatePropagation(),this.stopPropagation()}},jQuery.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},function(orig,fix){jQuery.event.special[orig]={delegateType:fix,bindType:fix,handle:function(event){var ret,target=this,related=event.relatedTarget,handleObj=event.handleObj;return related&&(related===target||jQuery.contains(target,related))||(event.type=handleObj.origType,ret=handleObj.handler.apply(this,arguments),event.type=fix),ret}}}),support.focusinBubbles||jQuery.each({focus:"focusin",blur:"focusout"
},function(orig,fix){var handler=function(event){jQuery.event.simulate(fix,event.target,jQuery.event.fix(event),!0)};jQuery.event.special[fix]={setup:function(){var doc=this.ownerDocument||this,attaches=data_priv.access(doc,fix);attaches||doc.addEventListener(orig,handler,!0),data_priv.access(doc,fix,(attaches||0)+1)},teardown:function(){var doc=this.ownerDocument||this,attaches=data_priv.access(doc,fix)-1;attaches?data_priv.access(doc,fix,attaches):(doc.removeEventListener(orig,handler,!0),data_priv.remove(doc,fix))}}}),jQuery.fn.extend({on:function(types,selector,data,fn,one){var origFn,type;if("object"==typeof types){"string"!=typeof selector&&(data=data||selector,
selector=void 0);for(type in types)this.on(type,selector,data,types[type],one);return this}if(null==data&&null==fn?(fn=selector,data=selector=void 0):null==fn&&("string"==typeof selector?(fn=data,data=void 0):(fn=data,data=selector,selector=void 0)),fn===!1)fn=returnFalse;else if(!fn)return this;return 1===one&&(origFn=fn,fn=function(event){return jQuery().off(event),origFn.apply(this,arguments)},fn.guid=origFn.guid||(origFn.guid=jQuery.guid++)),this.each(function(){jQuery.event.add(this,types,fn,data,selector)})},one:function(types,selector,data,fn){return this.on(types,selector,data,fn,1)},off:function(types,selector,fn){var handleObj,type;if(types&&types.preventDefault&&types.handleObj)return handleObj=types.handleObj,
jQuery(types.delegateTarget).off(handleObj.namespace?handleObj.origType+"."+handleObj.namespace:handleObj.origType,handleObj.selector,handleObj.handler),this;if("object"==typeof types){for(type in types)this.off(type,selector,types[type]);return this}return selector!==!1&&"function"!=typeof selector||(fn=selector,selector=void 0),fn===!1&&(fn=returnFalse),this.each(function(){jQuery.event.remove(this,types,fn,selector)})},trigger:function(type,data){return this.each(function(){jQuery.event.trigger(type,data,this)})},triggerHandler:function(type,data){var elem=this[0];if(elem)return jQuery.event.trigger(type,data,elem,!0)}});var rxhtmlTag=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/gi,rtagName=/<([\w:]+)/,rhtml=/<|&#?\w+;/,rnoInnerhtml=/<(?:script|style|link)/i,rchecked=/checked\s*(?:[^=]|=\s*.checked.)/i,rscriptType=/^$|\/(?:java|ecma)script/i,rscriptTypeMasked=/^true\/(.*)/,rcleanScript=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g,wrapMap={
option:[1,"<select multiple='multiple'>","</select>"],thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};wrapMap.optgroup=wrapMap.option,wrapMap.tbody=wrapMap.tfoot=wrapMap.colgroup=wrapMap.caption=wrapMap.thead,wrapMap.th=wrapMap.td,jQuery.extend({clone:function(elem,dataAndEvents,deepDataAndEvents){var i,l,srcElements,destElements,clone=elem.cloneNode(!0),inPage=jQuery.contains(elem.ownerDocument,elem);if(!(support.noCloneChecked||1!==elem.nodeType&&11!==elem.nodeType||jQuery.isXMLDoc(elem)))for(destElements=getAll(clone),
srcElements=getAll(elem),i=0,l=srcElements.length;i<l;i++)fixInput(srcElements[i],destElements[i]);if(dataAndEvents)if(deepDataAndEvents)for(srcElements=srcElements||getAll(elem),destElements=destElements||getAll(clone),i=0,l=srcElements.length;i<l;i++)cloneCopyEvent(srcElements[i],destElements[i]);else cloneCopyEvent(elem,clone);return destElements=getAll(clone,"script"),destElements.length>0&&setGlobalEval(destElements,!inPage&&getAll(elem,"script")),clone},buildFragment:function(elems,context,scripts,selection){for(var elem,tmp,tag,wrap,contains,j,fragment=context.createDocumentFragment(),nodes=[],i=0,l=elems.length;i<l;i++)if(elem=elems[i],elem||0===elem)if("object"===jQuery.type(elem))jQuery.merge(nodes,elem.nodeType?[elem]:elem);else if(rhtml.test(elem)){
for(tmp=tmp||fragment.appendChild(context.createElement("div")),tag=(rtagName.exec(elem)||["",""])[1].toLowerCase(),wrap=wrapMap[tag]||wrapMap._default,tmp.innerHTML=wrap[1]+elem.replace(rxhtmlTag,"<$1></$2>")+wrap[2],j=wrap[0];j--;)tmp=tmp.lastChild;jQuery.merge(nodes,tmp.childNodes),tmp=fragment.firstChild,tmp.textContent=""}else nodes.push(context.createTextNode(elem));for(fragment.textContent="",i=0;elem=nodes[i++];)if((!selection||jQuery.inArray(elem,selection)===-1)&&(contains=jQuery.contains(elem.ownerDocument,elem),tmp=getAll(fragment.appendChild(elem),"script"),contains&&setGlobalEval(tmp),scripts))for(j=0;elem=tmp[j++];)rscriptType.test(elem.type||"")&&scripts.push(elem);
return fragment},cleanData:function(elems){for(var data,elem,type,key,special=jQuery.event.special,i=0;void 0!==(elem=elems[i]);i++){if(jQuery.acceptData(elem)&&(key=elem[data_priv.expando],key&&(data=data_priv.cache[key]))){if(data.events)for(type in data.events)special[type]?jQuery.event.remove(elem,type):jQuery.removeEvent(elem,type,data.handle);data_priv.cache[key]&&delete data_priv.cache[key]}delete data_user.cache[elem[data_user.expando]]}}}),jQuery.fn.extend({text:function(value){return access(this,function(value){return void 0===value?jQuery.text(this):this.empty().each(function(){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||(this.textContent=value);
})},null,value,arguments.length)},append:function(){return this.domManip(arguments,function(elem){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var target=manipulationTarget(this,elem);target.appendChild(elem)}})},prepend:function(){return this.domManip(arguments,function(elem){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var target=manipulationTarget(this,elem);target.insertBefore(elem,target.firstChild)}})},before:function(){return this.domManip(arguments,function(elem){this.parentNode&&this.parentNode.insertBefore(elem,this)})},after:function(){return this.domManip(arguments,function(elem){this.parentNode&&this.parentNode.insertBefore(elem,this.nextSibling);
})},remove:function(selector,keepData){for(var elem,elems=selector?jQuery.filter(selector,this):this,i=0;null!=(elem=elems[i]);i++)keepData||1!==elem.nodeType||jQuery.cleanData(getAll(elem)),elem.parentNode&&(keepData&&jQuery.contains(elem.ownerDocument,elem)&&setGlobalEval(getAll(elem,"script")),elem.parentNode.removeChild(elem));return this},empty:function(){for(var elem,i=0;null!=(elem=this[i]);i++)1===elem.nodeType&&(jQuery.cleanData(getAll(elem,!1)),elem.textContent="");return this},clone:function(dataAndEvents,deepDataAndEvents){return dataAndEvents=null!=dataAndEvents&&dataAndEvents,deepDataAndEvents=null==deepDataAndEvents?dataAndEvents:deepDataAndEvents,
this.map(function(){return jQuery.clone(this,dataAndEvents,deepDataAndEvents)})},html:function(value){return access(this,function(value){var elem=this[0]||{},i=0,l=this.length;if(void 0===value&&1===elem.nodeType)return elem.innerHTML;if("string"==typeof value&&!rnoInnerhtml.test(value)&&!wrapMap[(rtagName.exec(value)||["",""])[1].toLowerCase()]){value=value.replace(rxhtmlTag,"<$1></$2>");try{for(;i<l;i++)elem=this[i]||{},1===elem.nodeType&&(jQuery.cleanData(getAll(elem,!1)),elem.innerHTML=value);elem=0}catch(e){}}elem&&this.empty().append(value)},null,value,arguments.length)},replaceWith:function(){var arg=arguments[0];return this.domManip(arguments,function(elem){
arg=this.parentNode,jQuery.cleanData(getAll(this)),arg&&arg.replaceChild(elem,this)}),arg&&(arg.length||arg.nodeType)?this:this.remove()},detach:function(selector){return this.remove(selector,!0)},domManip:function(args,callback){args=concat.apply([],args);var fragment,first,scripts,hasScripts,node,doc,i=0,l=this.length,set=this,iNoClone=l-1,value=args[0],isFunction=jQuery.isFunction(value);if(isFunction||l>1&&"string"==typeof value&&!support.checkClone&&rchecked.test(value))return this.each(function(index){var self=set.eq(index);isFunction&&(args[0]=value.call(this,index,self.html())),self.domManip(args,callback)});if(l&&(fragment=jQuery.buildFragment(args,this[0].ownerDocument,!1,this),
first=fragment.firstChild,1===fragment.childNodes.length&&(fragment=first),first)){for(scripts=jQuery.map(getAll(fragment,"script"),disableScript),hasScripts=scripts.length;i<l;i++)node=fragment,i!==iNoClone&&(node=jQuery.clone(node,!0,!0),hasScripts&&jQuery.merge(scripts,getAll(node,"script"))),callback.call(this[i],node,i);if(hasScripts)for(doc=scripts[scripts.length-1].ownerDocument,jQuery.map(scripts,restoreScript),i=0;i<hasScripts;i++)node=scripts[i],rscriptType.test(node.type||"")&&!data_priv.access(node,"globalEval")&&jQuery.contains(doc,node)&&(node.src?jQuery._evalUrl&&jQuery._evalUrl(node.src):jQuery.globalEval(node.textContent.replace(rcleanScript,"")));
}return this}}),jQuery.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(name,original){jQuery.fn[name]=function(selector){for(var elems,ret=[],insert=jQuery(selector),last=insert.length-1,i=0;i<=last;i++)elems=i===last?this:this.clone(!0),jQuery(insert[i])[original](elems),push.apply(ret,elems.get());return this.pushStack(ret)}});var iframe,elemdisplay={},rmargin=/^margin/,rnumnonpx=new RegExp("^("+pnum+")(?!px)[a-z%]+$","i"),getStyles=function(elem){return elem.ownerDocument.defaultView.getComputedStyle(elem,null)};!function(){function computePixelPositionAndBoxSizingReliable(){div.style.cssText="-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;display:block;margin-top:1%;top:1%;border:1px;padding:1px;width:4px;position:absolute",
div.innerHTML="",docElem.appendChild(container);var divStyle=window.getComputedStyle(div,null);pixelPositionVal="1%"!==divStyle.top,boxSizingReliableVal="4px"===divStyle.width,docElem.removeChild(container)}var pixelPositionVal,boxSizingReliableVal,docElem=document.documentElement,container=document.createElement("div"),div=document.createElement("div");div.style&&(div.style.backgroundClip="content-box",div.cloneNode(!0).style.backgroundClip="",support.clearCloneStyle="content-box"===div.style.backgroundClip,container.style.cssText="border:0;width:0;height:0;top:0;left:-9999px;margin-top:1px;position:absolute",container.appendChild(div),window.getComputedStyle&&jQuery.extend(support,{
pixelPosition:function(){return computePixelPositionAndBoxSizingReliable(),pixelPositionVal},boxSizingReliable:function(){return null==boxSizingReliableVal&&computePixelPositionAndBoxSizingReliable(),boxSizingReliableVal},reliableMarginRight:function(){var ret,marginDiv=div.appendChild(document.createElement("div"));return marginDiv.style.cssText=div.style.cssText="-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box;display:block;margin:0;border:0;padding:0",marginDiv.style.marginRight=marginDiv.style.width="0",div.style.width="1px",docElem.appendChild(container),ret=!parseFloat(window.getComputedStyle(marginDiv,null).marginRight),
docElem.removeChild(container),ret}}))}(),jQuery.swap=function(elem,options,callback,args){var ret,name,old={};for(name in options)old[name]=elem.style[name],elem.style[name]=options[name];ret=callback.apply(elem,args||[]);for(name in options)elem.style[name]=old[name];return ret};var rdisplayswap=/^(none|table(?!-c[ea]).+)/,rnumsplit=new RegExp("^("+pnum+")(.*)$","i"),rrelNum=new RegExp("^([+-])=("+pnum+")","i"),cssShow={position:"absolute",visibility:"hidden",display:"block"},cssNormalTransform={letterSpacing:"0",fontWeight:"400"},cssPrefixes=["Webkit","O","Moz","ms"];jQuery.extend({cssHooks:{opacity:{get:function(elem,computed){if(computed){var ret=curCSS(elem,"opacity");
return""===ret?"1":ret}}}},cssNumber:{columnCount:!0,fillOpacity:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{float:"cssFloat"},style:function(elem,name,value,extra){if(elem&&3!==elem.nodeType&&8!==elem.nodeType&&elem.style){var ret,type,hooks,origName=jQuery.camelCase(name),style=elem.style;return name=jQuery.cssProps[origName]||(jQuery.cssProps[origName]=vendorPropName(style,origName)),hooks=jQuery.cssHooks[name]||jQuery.cssHooks[origName],void 0===value?hooks&&"get"in hooks&&void 0!==(ret=hooks.get(elem,!1,extra))?ret:style[name]:(type=typeof value,"string"===type&&(ret=rrelNum.exec(value))&&(value=(ret[1]+1)*ret[2]+parseFloat(jQuery.css(elem,name)),
type="number"),null!=value&&value===value&&("number"!==type||jQuery.cssNumber[origName]||(value+="px"),support.clearCloneStyle||""!==value||0!==name.indexOf("background")||(style[name]="inherit"),hooks&&"set"in hooks&&void 0===(value=hooks.set(elem,value,extra))||(style[name]=value)),void 0)}},css:function(elem,name,extra,styles){var val,num,hooks,origName=jQuery.camelCase(name);return name=jQuery.cssProps[origName]||(jQuery.cssProps[origName]=vendorPropName(elem.style,origName)),hooks=jQuery.cssHooks[name]||jQuery.cssHooks[origName],hooks&&"get"in hooks&&(val=hooks.get(elem,!0,extra)),void 0===val&&(val=curCSS(elem,name,styles)),"normal"===val&&name in cssNormalTransform&&(val=cssNormalTransform[name]),
""===extra||extra?(num=parseFloat(val),extra===!0||jQuery.isNumeric(num)?num||0:val):val}}),jQuery.each(["height","width"],function(i,name){jQuery.cssHooks[name]={get:function(elem,computed,extra){if(computed)return rdisplayswap.test(jQuery.css(elem,"display"))&&0===elem.offsetWidth?jQuery.swap(elem,cssShow,function(){return getWidthOrHeight(elem,name,extra)}):getWidthOrHeight(elem,name,extra)},set:function(elem,value,extra){var styles=extra&&getStyles(elem);return setPositiveNumber(elem,value,extra?augmentWidthOrHeight(elem,name,extra,"border-box"===jQuery.css(elem,"boxSizing",!1,styles),styles):0)}}}),jQuery.cssHooks.marginRight=addGetHookIf(support.reliableMarginRight,function(elem,computed){
if(computed)return jQuery.swap(elem,{display:"inline-block"},curCSS,[elem,"marginRight"])}),jQuery.each({margin:"",padding:"",border:"Width"},function(prefix,suffix){jQuery.cssHooks[prefix+suffix]={expand:function(value){for(var i=0,expanded={},parts="string"==typeof value?value.split(" "):[value];i<4;i++)expanded[prefix+cssExpand[i]+suffix]=parts[i]||parts[i-2]||parts[0];return expanded}},rmargin.test(prefix)||(jQuery.cssHooks[prefix+suffix].set=setPositiveNumber)}),jQuery.fn.extend({css:function(name,value){return access(this,function(elem,name,value){var styles,len,map={},i=0;if(jQuery.isArray(name)){for(styles=getStyles(elem),len=name.length;i<len;i++)map[name[i]]=jQuery.css(elem,name[i],!1,styles);
return map}return void 0!==value?jQuery.style(elem,name,value):jQuery.css(elem,name)},name,value,arguments.length>1)},show:function(){return showHide(this,!0)},hide:function(){return showHide(this)},toggle:function(state){return"boolean"==typeof state?state?this.show():this.hide():this.each(function(){isHidden(this)?jQuery(this).show():jQuery(this).hide()})}}),jQuery.Tween=Tween,Tween.prototype={constructor:Tween,init:function(elem,options,prop,end,easing,unit){this.elem=elem,this.prop=prop,this.easing=easing||"swing",this.options=options,this.start=this.now=this.cur(),this.end=end,this.unit=unit||(jQuery.cssNumber[prop]?"":"px")},cur:function(){var hooks=Tween.propHooks[this.prop];
return hooks&&hooks.get?hooks.get(this):Tween.propHooks._default.get(this)},run:function(percent){var eased,hooks=Tween.propHooks[this.prop];return this.options.duration?this.pos=eased=jQuery.easing[this.easing](percent,this.options.duration*percent,0,1,this.options.duration):this.pos=eased=percent,this.now=(this.end-this.start)*eased+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),hooks&&hooks.set?hooks.set(this):Tween.propHooks._default.set(this),this}},Tween.prototype.init.prototype=Tween.prototype,Tween.propHooks={_default:{get:function(tween){var result;return null==tween.elem[tween.prop]||tween.elem.style&&null!=tween.elem.style[tween.prop]?(result=jQuery.css(tween.elem,tween.prop,""),
result&&"auto"!==result?result:0):tween.elem[tween.prop]},set:function(tween){jQuery.fx.step[tween.prop]?jQuery.fx.step[tween.prop](tween):tween.elem.style&&(null!=tween.elem.style[jQuery.cssProps[tween.prop]]||jQuery.cssHooks[tween.prop])?jQuery.style(tween.elem,tween.prop,tween.now+tween.unit):tween.elem[tween.prop]=tween.now}}},Tween.propHooks.scrollTop=Tween.propHooks.scrollLeft={set:function(tween){tween.elem.nodeType&&tween.elem.parentNode&&(tween.elem[tween.prop]=tween.now)}},jQuery.easing={linear:function(p){return p},swing:function(p){return.5-Math.cos(p*Math.PI)/2}},jQuery.fx=Tween.prototype.init,jQuery.fx.step={};var fxNow,timerId,rfxtypes=/^(?:toggle|show|hide)$/,rfxnum=new RegExp("^(?:([+-])=|)("+pnum+")([a-z%]*)$","i"),rrun=/queueHooks$/,animationPrefilters=[defaultPrefilter],tweeners={
"*":[function(prop,value){var tween=this.createTween(prop,value),target=tween.cur(),parts=rfxnum.exec(value),unit=parts&&parts[3]||(jQuery.cssNumber[prop]?"":"px"),start=(jQuery.cssNumber[prop]||"px"!==unit&&+target)&&rfxnum.exec(jQuery.css(tween.elem,prop)),scale=1,maxIterations=20;if(start&&start[3]!==unit){unit=unit||start[3],parts=parts||[],start=+target||1;do scale=scale||".5",start/=scale,jQuery.style(tween.elem,prop,start+unit);while(scale!==(scale=tween.cur()/target)&&1!==scale&&--maxIterations)}return parts&&(start=tween.start=+start||+target||0,tween.unit=unit,tween.end=parts[1]?start+(parts[1]+1)*parts[2]:+parts[2]),tween}]};jQuery.Animation=jQuery.extend(Animation,{
tweener:function(props,callback){jQuery.isFunction(props)?(callback=props,props=["*"]):props=props.split(" ");for(var prop,index=0,length=props.length;index<length;index++)prop=props[index],tweeners[prop]=tweeners[prop]||[],tweeners[prop].unshift(callback)},prefilter:function(callback,prepend){prepend?animationPrefilters.unshift(callback):animationPrefilters.push(callback)}}),jQuery.speed=function(speed,easing,fn){var opt=speed&&"object"==typeof speed?jQuery.extend({},speed):{complete:fn||!fn&&easing||jQuery.isFunction(speed)&&speed,duration:speed,easing:fn&&easing||easing&&!jQuery.isFunction(easing)&&easing};return opt.duration=jQuery.fx.off?0:"number"==typeof opt.duration?opt.duration:opt.duration in jQuery.fx.speeds?jQuery.fx.speeds[opt.duration]:jQuery.fx.speeds._default,
null!=opt.queue&&opt.queue!==!0||(opt.queue="fx"),opt.old=opt.complete,opt.complete=function(){jQuery.isFunction(opt.old)&&opt.old.call(this),opt.queue&&jQuery.dequeue(this,opt.queue)},opt},jQuery.fn.extend({fadeTo:function(speed,to,easing,callback){return this.filter(isHidden).css("opacity",0).show().end().animate({opacity:to},speed,easing,callback)},animate:function(prop,speed,easing,callback){var empty=jQuery.isEmptyObject(prop),optall=jQuery.speed(speed,easing,callback),doAnimation=function(){var anim=Animation(this,jQuery.extend({},prop),optall);(empty||data_priv.get(this,"finish"))&&anim.stop(!0)};return doAnimation.finish=doAnimation,empty||optall.queue===!1?this.each(doAnimation):this.queue(optall.queue,doAnimation);
},stop:function(type,clearQueue,gotoEnd){var stopQueue=function(hooks){var stop=hooks.stop;delete hooks.stop,stop(gotoEnd)};return"string"!=typeof type&&(gotoEnd=clearQueue,clearQueue=type,type=void 0),clearQueue&&type!==!1&&this.queue(type||"fx",[]),this.each(function(){var dequeue=!0,index=null!=type&&type+"queueHooks",timers=jQuery.timers,data=data_priv.get(this);if(index)data[index]&&data[index].stop&&stopQueue(data[index]);else for(index in data)data[index]&&data[index].stop&&rrun.test(index)&&stopQueue(data[index]);for(index=timers.length;index--;)timers[index].elem!==this||null!=type&&timers[index].queue!==type||(timers[index].anim.stop(gotoEnd),dequeue=!1,
timers.splice(index,1));!dequeue&&gotoEnd||jQuery.dequeue(this,type)})},finish:function(type){return type!==!1&&(type=type||"fx"),this.each(function(){var index,data=data_priv.get(this),queue=data[type+"queue"],hooks=data[type+"queueHooks"],timers=jQuery.timers,length=queue?queue.length:0;for(data.finish=!0,jQuery.queue(this,type,[]),hooks&&hooks.stop&&hooks.stop.call(this,!0),index=timers.length;index--;)timers[index].elem===this&&timers[index].queue===type&&(timers[index].anim.stop(!0),timers.splice(index,1));for(index=0;index<length;index++)queue[index]&&queue[index].finish&&queue[index].finish.call(this);delete data.finish})}}),jQuery.each(["toggle","show","hide"],function(i,name){
var cssFn=jQuery.fn[name];jQuery.fn[name]=function(speed,easing,callback){return null==speed||"boolean"==typeof speed?cssFn.apply(this,arguments):this.animate(genFx(name,!0),speed,easing,callback)}}),jQuery.each({slideDown:genFx("show"),slideUp:genFx("hide"),slideToggle:genFx("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(name,props){jQuery.fn[name]=function(speed,easing,callback){return this.animate(props,speed,easing,callback)}}),jQuery.timers=[],jQuery.fx.tick=function(){var timer,i=0,timers=jQuery.timers;for(fxNow=jQuery.now();i<timers.length;i++)timer=timers[i],timer()||timers[i]!==timer||timers.splice(i--,1);
timers.length||jQuery.fx.stop(),fxNow=void 0},jQuery.fx.timer=function(timer){jQuery.timers.push(timer),timer()?jQuery.fx.start():jQuery.timers.pop()},jQuery.fx.interval=13,jQuery.fx.start=function(){timerId||(timerId=setInterval(jQuery.fx.tick,jQuery.fx.interval))},jQuery.fx.stop=function(){clearInterval(timerId),timerId=null},jQuery.fx.speeds={slow:600,fast:200,_default:400},jQuery.fn.delay=function(time,type){return time=jQuery.fx?jQuery.fx.speeds[time]||time:time,type=type||"fx",this.queue(type,function(next,hooks){var timeout=setTimeout(next,time);hooks.stop=function(){clearTimeout(timeout)}})},function(){var input=document.createElement("input"),select=document.createElement("select"),opt=select.appendChild(document.createElement("option"));
input.type="checkbox",support.checkOn=""!==input.value,support.optSelected=opt.selected,select.disabled=!0,support.optDisabled=!opt.disabled,input=document.createElement("input"),input.value="t",input.type="radio",support.radioValue="t"===input.value}();var nodeHook,boolHook,attrHandle=jQuery.expr.attrHandle;jQuery.fn.extend({attr:function(name,value){return access(this,jQuery.attr,name,value,arguments.length>1)},removeAttr:function(name){return this.each(function(){jQuery.removeAttr(this,name)})}}),jQuery.extend({attr:function(elem,name,value){var hooks,ret,nType=elem.nodeType;if(elem&&3!==nType&&8!==nType&&2!==nType)return typeof elem.getAttribute===strundefined?jQuery.prop(elem,name,value):(1===nType&&jQuery.isXMLDoc(elem)||(name=name.toLowerCase(),
hooks=jQuery.attrHooks[name]||(jQuery.expr.match.bool.test(name)?boolHook:nodeHook)),void 0===value?hooks&&"get"in hooks&&null!==(ret=hooks.get(elem,name))?ret:(ret=jQuery.find.attr(elem,name),null==ret?void 0:ret):null!==value?hooks&&"set"in hooks&&void 0!==(ret=hooks.set(elem,value,name))?ret:(elem.setAttribute(name,value+""),value):void jQuery.removeAttr(elem,name))},removeAttr:function(elem,value){var name,propName,i=0,attrNames=value&&value.match(rnotwhite);if(attrNames&&1===elem.nodeType)for(;name=attrNames[i++];)propName=jQuery.propFix[name]||name,jQuery.expr.match.bool.test(name)&&(elem[propName]=!1),elem.removeAttribute(name)},attrHooks:{type:{set:function(elem,value){
if(!support.radioValue&&"radio"===value&&jQuery.nodeName(elem,"input")){var val=elem.value;return elem.setAttribute("type",value),val&&(elem.value=val),value}}}}}),boolHook={set:function(elem,value,name){return value===!1?jQuery.removeAttr(elem,name):elem.setAttribute(name,name),name}},jQuery.each(jQuery.expr.match.bool.source.match(/\w+/g),function(i,name){var getter=attrHandle[name]||jQuery.find.attr;attrHandle[name]=function(elem,name,isXML){var ret,handle;return isXML||(handle=attrHandle[name],attrHandle[name]=ret,ret=null!=getter(elem,name,isXML)?name.toLowerCase():null,attrHandle[name]=handle),ret}});var rfocusable=/^(?:input|select|textarea|button)$/i;jQuery.fn.extend({
prop:function(name,value){return access(this,jQuery.prop,name,value,arguments.length>1)},removeProp:function(name){return this.each(function(){delete this[jQuery.propFix[name]||name]})}}),jQuery.extend({propFix:{for:"htmlFor",class:"className"},prop:function(elem,name,value){var ret,hooks,notxml,nType=elem.nodeType;if(elem&&3!==nType&&8!==nType&&2!==nType)return notxml=1!==nType||!jQuery.isXMLDoc(elem),notxml&&(name=jQuery.propFix[name]||name,hooks=jQuery.propHooks[name]),void 0!==value?hooks&&"set"in hooks&&void 0!==(ret=hooks.set(elem,value,name))?ret:elem[name]=value:hooks&&"get"in hooks&&null!==(ret=hooks.get(elem,name))?ret:elem[name]},propHooks:{tabIndex:{
get:function(elem){return elem.hasAttribute("tabindex")||rfocusable.test(elem.nodeName)||elem.href?elem.tabIndex:-1}}}}),support.optSelected||(jQuery.propHooks.selected={get:function(elem){var parent=elem.parentNode;return parent&&parent.parentNode&&parent.parentNode.selectedIndex,null}}),jQuery.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){jQuery.propFix[this.toLowerCase()]=this});var rclass=/[\t\r\n\f]/g;jQuery.fn.extend({addClass:function(value){var classes,elem,cur,clazz,j,finalValue,proceed="string"==typeof value&&value,i=0,len=this.length;if(jQuery.isFunction(value))return this.each(function(j){
jQuery(this).addClass(value.call(this,j,this.className))});if(proceed)for(classes=(value||"").match(rnotwhite)||[];i<len;i++)if(elem=this[i],cur=1===elem.nodeType&&(elem.className?(" "+elem.className+" ").replace(rclass," "):" ")){for(j=0;clazz=classes[j++];)cur.indexOf(" "+clazz+" ")<0&&(cur+=clazz+" ");finalValue=jQuery.trim(cur),elem.className!==finalValue&&(elem.className=finalValue)}return this},removeClass:function(value){var classes,elem,cur,clazz,j,finalValue,proceed=0===arguments.length||"string"==typeof value&&value,i=0,len=this.length;if(jQuery.isFunction(value))return this.each(function(j){jQuery(this).removeClass(value.call(this,j,this.className));
});if(proceed)for(classes=(value||"").match(rnotwhite)||[];i<len;i++)if(elem=this[i],cur=1===elem.nodeType&&(elem.className?(" "+elem.className+" ").replace(rclass," "):"")){for(j=0;clazz=classes[j++];)for(;cur.indexOf(" "+clazz+" ")>=0;)cur=cur.replace(" "+clazz+" "," ");finalValue=value?jQuery.trim(cur):"",elem.className!==finalValue&&(elem.className=finalValue)}return this},toggleClass:function(value,stateVal){var type=typeof value;return"boolean"==typeof stateVal&&"string"===type?stateVal?this.addClass(value):this.removeClass(value):jQuery.isFunction(value)?this.each(function(i){jQuery(this).toggleClass(value.call(this,i,this.className,stateVal),stateVal);
}):this.each(function(){if("string"===type)for(var className,i=0,self=jQuery(this),classNames=value.match(rnotwhite)||[];className=classNames[i++];)self.hasClass(className)?self.removeClass(className):self.addClass(className);else type!==strundefined&&"boolean"!==type||(this.className&&data_priv.set(this,"__className__",this.className),this.className=this.className||value===!1?"":data_priv.get(this,"__className__")||"")})},hasClass:function(selector){for(var className=" "+selector+" ",i=0,l=this.length;i<l;i++)if(1===this[i].nodeType&&(" "+this[i].className+" ").replace(rclass," ").indexOf(className)>=0)return!0;return!1}});var rreturn=/\r/g;jQuery.fn.extend({
val:function(value){var hooks,ret,isFunction,elem=this[0];{if(arguments.length)return isFunction=jQuery.isFunction(value),this.each(function(i){var val;1===this.nodeType&&(val=isFunction?value.call(this,i,jQuery(this).val()):value,null==val?val="":"number"==typeof val?val+="":jQuery.isArray(val)&&(val=jQuery.map(val,function(value){return null==value?"":value+""})),hooks=jQuery.valHooks[this.type]||jQuery.valHooks[this.nodeName.toLowerCase()],hooks&&"set"in hooks&&void 0!==hooks.set(this,val,"value")||(this.value=val))});if(elem)return hooks=jQuery.valHooks[elem.type]||jQuery.valHooks[elem.nodeName.toLowerCase()],hooks&&"get"in hooks&&void 0!==(ret=hooks.get(elem,"value"))?ret:(ret=elem.value,
"string"==typeof ret?ret.replace(rreturn,""):null==ret?"":ret)}}}),jQuery.extend({valHooks:{option:{get:function(elem){var val=jQuery.find.attr(elem,"value");return null!=val?val:jQuery.trim(jQuery.text(elem))}},select:{get:function(elem){for(var value,option,options=elem.options,index=elem.selectedIndex,one="select-one"===elem.type||index<0,values=one?null:[],max=one?index+1:options.length,i=index<0?max:one?index:0;i<max;i++)if(option=options[i],(option.selected||i===index)&&(support.optDisabled?!option.disabled:null===option.getAttribute("disabled"))&&(!option.parentNode.disabled||!jQuery.nodeName(option.parentNode,"optgroup"))){if(value=jQuery(option).val(),
one)return value;values.push(value)}return values},set:function(elem,value){for(var optionSet,option,options=elem.options,values=jQuery.makeArray(value),i=options.length;i--;)option=options[i],(option.selected=jQuery.inArray(option.value,values)>=0)&&(optionSet=!0);return optionSet||(elem.selectedIndex=-1),values}}}}),jQuery.each(["radio","checkbox"],function(){jQuery.valHooks[this]={set:function(elem,value){if(jQuery.isArray(value))return elem.checked=jQuery.inArray(jQuery(elem).val(),value)>=0}},support.checkOn||(jQuery.valHooks[this].get=function(elem){return null===elem.getAttribute("value")?"on":elem.value})}),jQuery.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(i,name){
jQuery.fn[name]=function(data,fn){return arguments.length>0?this.on(name,null,data,fn):this.trigger(name)}}),jQuery.fn.extend({hover:function(fnOver,fnOut){return this.mouseenter(fnOver).mouseleave(fnOut||fnOver)},bind:function(types,data,fn){return this.on(types,null,data,fn)},unbind:function(types,fn){return this.off(types,null,fn)},delegate:function(selector,types,data,fn){return this.on(types,selector,data,fn)},undelegate:function(selector,types,fn){return 1===arguments.length?this.off(selector,"**"):this.off(types,selector||"**",fn)}});var nonce=jQuery.now(),rquery=/\?/;jQuery.parseJSON=function(data){return JSON.parse(data+"")},jQuery.parseXML=function(data){
var xml,tmp;if(!data||"string"!=typeof data)return null;try{tmp=new DOMParser,xml=tmp.parseFromString(data,"text/xml")}catch(e){xml=void 0}return xml&&!xml.getElementsByTagName("parsererror").length||jQuery.error("Invalid XML: "+data),xml};var ajaxLocParts,ajaxLocation,rhash=/#.*$/,rts=/([?&])_=[^&]*/,rheaders=/^(.*?):[ \t]*([^\r\n]*)$/gm,rlocalProtocol=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,rnoContent=/^(?:GET|HEAD)$/,rprotocol=/^\/\//,rurl=/^([\w.+-]+:)(?:\/\/(?:[^\/?#]*@|)([^\/?#:]*)(?::(\d+)|)|)/,prefilters={},transports={},allTypes="*/".concat("*");try{ajaxLocation=location.href}catch(e){ajaxLocation=document.createElement("a"),ajaxLocation.href="",
ajaxLocation=ajaxLocation.href}ajaxLocParts=rurl.exec(ajaxLocation.toLowerCase())||[],jQuery.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:ajaxLocation,type:"GET",isLocal:rlocalProtocol.test(ajaxLocParts[1]),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":allTypes,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":jQuery.parseJSON,"text xml":jQuery.parseXML
},flatOptions:{url:!0,context:!0}},ajaxSetup:function(target,settings){return settings?ajaxExtend(ajaxExtend(target,jQuery.ajaxSettings),settings):ajaxExtend(jQuery.ajaxSettings,target)},ajaxPrefilter:addToPrefiltersOrTransports(prefilters),ajaxTransport:addToPrefiltersOrTransports(transports),ajax:function(url,options){function done(status,nativeStatusText,responses,headers){var isSuccess,success,error,response,modified,statusText=nativeStatusText;2!==state&&(state=2,timeoutTimer&&clearTimeout(timeoutTimer),transport=void 0,responseHeadersString=headers||"",jqXHR.readyState=status>0?4:0,isSuccess=status>=200&&status<300||304===status,responses&&(response=ajaxHandleResponses(s,jqXHR,responses)),
response=ajaxConvert(s,response,jqXHR,isSuccess),isSuccess?(s.ifModified&&(modified=jqXHR.getResponseHeader("Last-Modified"),modified&&(jQuery.lastModified[cacheURL]=modified),modified=jqXHR.getResponseHeader("etag"),modified&&(jQuery.etag[cacheURL]=modified)),204===status||"HEAD"===s.type?statusText="nocontent":304===status?statusText="notmodified":(statusText=response.state,success=response.data,error=response.error,isSuccess=!error)):(error=statusText,!status&&statusText||(statusText="error",status<0&&(status=0))),jqXHR.status=status,jqXHR.statusText=(nativeStatusText||statusText)+"",isSuccess?deferred.resolveWith(callbackContext,[success,statusText,jqXHR]):deferred.rejectWith(callbackContext,[jqXHR,statusText,error]),
jqXHR.statusCode(statusCode),statusCode=void 0,fireGlobals&&globalEventContext.trigger(isSuccess?"ajaxSuccess":"ajaxError",[jqXHR,s,isSuccess?success:error]),completeDeferred.fireWith(callbackContext,[jqXHR,statusText]),fireGlobals&&(globalEventContext.trigger("ajaxComplete",[jqXHR,s]),--jQuery.active||jQuery.event.trigger("ajaxStop")))}"object"==typeof url&&(options=url,url=void 0),options=options||{};var transport,cacheURL,responseHeadersString,responseHeaders,timeoutTimer,parts,fireGlobals,i,s=jQuery.ajaxSetup({},options),callbackContext=s.context||s,globalEventContext=s.context&&(callbackContext.nodeType||callbackContext.jquery)?jQuery(callbackContext):jQuery.event,deferred=jQuery.Deferred(),completeDeferred=jQuery.Callbacks("once memory"),statusCode=s.statusCode||{},requestHeaders={},requestHeadersNames={},state=0,strAbort="canceled",jqXHR={
readyState:0,getResponseHeader:function(key){var match;if(2===state){if(!responseHeaders)for(responseHeaders={};match=rheaders.exec(responseHeadersString);)responseHeaders[match[1].toLowerCase()]=match[2];match=responseHeaders[key.toLowerCase()]}return null==match?null:match},getAllResponseHeaders:function(){return 2===state?responseHeadersString:null},setRequestHeader:function(name,value){var lname=name.toLowerCase();return state||(name=requestHeadersNames[lname]=requestHeadersNames[lname]||name,requestHeaders[name]=value),this},overrideMimeType:function(type){return state||(s.mimeType=type),this},statusCode:function(map){var code;if(map)if(state<2)for(code in map)statusCode[code]=[statusCode[code],map[code]];else jqXHR.always(map[jqXHR.status]);
return this},abort:function(statusText){var finalText=statusText||strAbort;return transport&&transport.abort(finalText),done(0,finalText),this}};if(deferred.promise(jqXHR).complete=completeDeferred.add,jqXHR.success=jqXHR.done,jqXHR.error=jqXHR.fail,s.url=((url||s.url||ajaxLocation)+"").replace(rhash,"").replace(rprotocol,ajaxLocParts[1]+"//"),s.type=options.method||options.type||s.method||s.type,s.dataTypes=jQuery.trim(s.dataType||"*").toLowerCase().match(rnotwhite)||[""],null==s.crossDomain&&(parts=rurl.exec(s.url.toLowerCase()),s.crossDomain=!(!parts||parts[1]===ajaxLocParts[1]&&parts[2]===ajaxLocParts[2]&&(parts[3]||("http:"===parts[1]?"80":"443"))===(ajaxLocParts[3]||("http:"===ajaxLocParts[1]?"80":"443")))),
s.data&&s.processData&&"string"!=typeof s.data&&(s.data=jQuery.param(s.data,s.traditional)),inspectPrefiltersOrTransports(prefilters,s,options,jqXHR),2===state)return jqXHR;fireGlobals=s.global,fireGlobals&&0===jQuery.active++&&jQuery.event.trigger("ajaxStart"),s.type=s.type.toUpperCase(),s.hasContent=!rnoContent.test(s.type),cacheURL=s.url,s.hasContent||(s.data&&(cacheURL=s.url+=(rquery.test(cacheURL)?"&":"?")+s.data,delete s.data),s.cache===!1&&(s.url=rts.test(cacheURL)?cacheURL.replace(rts,"$1_="+nonce++):cacheURL+(rquery.test(cacheURL)?"&":"?")+"_="+nonce++)),s.ifModified&&(jQuery.lastModified[cacheURL]&&jqXHR.setRequestHeader("If-Modified-Since",jQuery.lastModified[cacheURL]),
jQuery.etag[cacheURL]&&jqXHR.setRequestHeader("If-None-Match",jQuery.etag[cacheURL])),(s.data&&s.hasContent&&s.contentType!==!1||options.contentType)&&jqXHR.setRequestHeader("Content-Type",s.contentType),jqXHR.setRequestHeader("Accept",s.dataTypes[0]&&s.accepts[s.dataTypes[0]]?s.accepts[s.dataTypes[0]]+("*"!==s.dataTypes[0]?", "+allTypes+"; q=0.01":""):s.accepts["*"]);for(i in s.headers)jqXHR.setRequestHeader(i,s.headers[i]);if(s.beforeSend&&(s.beforeSend.call(callbackContext,jqXHR,s)===!1||2===state))return jqXHR.abort();strAbort="abort";for(i in{success:1,error:1,complete:1})jqXHR[i](s[i]);if(transport=inspectPrefiltersOrTransports(transports,s,options,jqXHR)){
jqXHR.readyState=1,fireGlobals&&globalEventContext.trigger("ajaxSend",[jqXHR,s]),s.async&&s.timeout>0&&(timeoutTimer=setTimeout(function(){jqXHR.abort("timeout")},s.timeout));try{state=1,transport.send(requestHeaders,done)}catch(e){if(!(state<2))throw e;done(-1,e)}}else done(-1,"No Transport");return jqXHR},getJSON:function(url,data,callback){return jQuery.get(url,data,callback,"json")},getScript:function(url,callback){return jQuery.get(url,void 0,callback,"script")}}),jQuery.each(["get","post"],function(i,method){jQuery[method]=function(url,data,callback,type){return jQuery.isFunction(data)&&(type=type||callback,callback=data,data=void 0),jQuery.ajax({url:url,
type:method,dataType:type,data:data,success:callback})}}),jQuery.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(i,type){jQuery.fn[type]=function(fn){return this.on(type,fn)}}),jQuery._evalUrl=function(url){return jQuery.ajax({url:url,type:"GET",dataType:"script",async:!1,global:!1,throws:!0})},jQuery.fn.extend({wrapAll:function(html){var wrap;return jQuery.isFunction(html)?this.each(function(i){jQuery(this).wrapAll(html.call(this,i))}):(this[0]&&(wrap=jQuery(html,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&wrap.insertBefore(this[0]),wrap.map(function(){for(var elem=this;elem.firstElementChild;)elem=elem.firstElementChild;
return elem}).append(this)),this)},wrapInner:function(html){return jQuery.isFunction(html)?this.each(function(i){jQuery(this).wrapInner(html.call(this,i))}):this.each(function(){var self=jQuery(this),contents=self.contents();contents.length?contents.wrapAll(html):self.append(html)})},wrap:function(html){var isFunction=jQuery.isFunction(html);return this.each(function(i){jQuery(this).wrapAll(isFunction?html.call(this,i):html)})},unwrap:function(){return this.parent().each(function(){jQuery.nodeName(this,"body")||jQuery(this).replaceWith(this.childNodes)}).end()}}),jQuery.expr.filters.hidden=function(elem){return elem.offsetWidth<=0&&elem.offsetHeight<=0},jQuery.expr.filters.visible=function(elem){
return!jQuery.expr.filters.hidden(elem)};var r20=/%20/g,rbracket=/\[\]$/,rCRLF=/\r?\n/g,rsubmitterTypes=/^(?:submit|button|image|reset|file)$/i,rsubmittable=/^(?:input|select|textarea|keygen)/i;jQuery.param=function(a,traditional){var prefix,s=[],add=function(key,value){value=jQuery.isFunction(value)?value():null==value?"":value,s[s.length]=encodeURIComponent(key)+"="+encodeURIComponent(value)};if(void 0===traditional&&(traditional=jQuery.ajaxSettings&&jQuery.ajaxSettings.traditional),jQuery.isArray(a)||a.jquery&&!jQuery.isPlainObject(a))jQuery.each(a,function(){add(this.name,this.value)});else for(prefix in a)buildParams(prefix,a[prefix],traditional,add);return s.join("&").replace(r20,"+");
},jQuery.fn.extend({serialize:function(){return jQuery.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var elements=jQuery.prop(this,"elements");return elements?jQuery.makeArray(elements):this}).filter(function(){var type=this.type;return this.name&&!jQuery(this).is(":disabled")&&rsubmittable.test(this.nodeName)&&!rsubmitterTypes.test(type)&&(this.checked||!rcheckableType.test(type))}).map(function(i,elem){var val=jQuery(this).val();return null==val?null:jQuery.isArray(val)?jQuery.map(val,function(val){return{name:elem.name,value:val.replace(rCRLF,"\r\n")}}):{name:elem.name,value:val.replace(rCRLF,"\r\n")}}).get()}}),jQuery.ajaxSettings.xhr=function(){
try{return new XMLHttpRequest}catch(e){}};var xhrId=0,xhrCallbacks={},xhrSuccessStatus={0:200,1223:204},xhrSupported=jQuery.ajaxSettings.xhr();window.ActiveXObject&&jQuery(window).on("unload",function(){for(var key in xhrCallbacks)xhrCallbacks[key]()}),support.cors=!!xhrSupported&&"withCredentials"in xhrSupported,support.ajax=xhrSupported=!!xhrSupported,jQuery.ajaxTransport(function(options){var callback;if(support.cors||xhrSupported&&!options.crossDomain)return{send:function(headers,complete){var i,xhr=options.xhr(),id=++xhrId;if(xhr.open(options.type,options.url,options.async,options.username,options.password),options.xhrFields)for(i in options.xhrFields)xhr[i]=options.xhrFields[i];
options.mimeType&&xhr.overrideMimeType&&xhr.overrideMimeType(options.mimeType),options.crossDomain||headers["X-Requested-With"]||(headers["X-Requested-With"]="XMLHttpRequest");for(i in headers)xhr.setRequestHeader(i,headers[i]);callback=function(type){return function(){callback&&(delete xhrCallbacks[id],callback=xhr.onload=xhr.onerror=null,"abort"===type?xhr.abort():"error"===type?complete(xhr.status,xhr.statusText):complete(xhrSuccessStatus[xhr.status]||xhr.status,xhr.statusText,"string"==typeof xhr.responseText?{text:xhr.responseText}:void 0,xhr.getAllResponseHeaders()))}},xhr.onload=callback(),xhr.onerror=callback("error"),callback=xhrCallbacks[id]=callback("abort");
try{xhr.send(options.hasContent&&options.data||null)}catch(e){if(callback)throw e}},abort:function(){callback&&callback()}}}),jQuery.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/(?:java|ecma)script/},converters:{"text script":function(text){return jQuery.globalEval(text),text}}}),jQuery.ajaxPrefilter("script",function(s){void 0===s.cache&&(s.cache=!1),s.crossDomain&&(s.type="GET")}),jQuery.ajaxTransport("script",function(s){if(s.crossDomain){var script,callback;return{send:function(_,complete){script=jQuery("<script>").prop({async:!0,charset:s.scriptCharset,src:s.url}).on("load error",callback=function(evt){
script.remove(),callback=null,evt&&complete("error"===evt.type?404:200,evt.type)}),document.head.appendChild(script[0])},abort:function(){callback&&callback()}}}});var oldCallbacks=[],rjsonp=/(=)\?(?=&|$)|\?\?/;jQuery.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var callback=oldCallbacks.pop()||jQuery.expando+"_"+nonce++;return this[callback]=!0,callback}}),jQuery.ajaxPrefilter("json jsonp",function(s,originalSettings,jqXHR){var callbackName,overwritten,responseContainer,jsonProp=s.jsonp!==!1&&(rjsonp.test(s.url)?"url":"string"==typeof s.data&&!(s.contentType||"").indexOf("application/x-www-form-urlencoded")&&rjsonp.test(s.data)&&"data");if(jsonProp||"jsonp"===s.dataTypes[0])return callbackName=s.jsonpCallback=jQuery.isFunction(s.jsonpCallback)?s.jsonpCallback():s.jsonpCallback,
jsonProp?s[jsonProp]=s[jsonProp].replace(rjsonp,"$1"+callbackName):s.jsonp!==!1&&(s.url+=(rquery.test(s.url)?"&":"?")+s.jsonp+"="+callbackName),s.converters["script json"]=function(){return responseContainer||jQuery.error(callbackName+" was not called"),responseContainer[0]},s.dataTypes[0]="json",overwritten=window[callbackName],window[callbackName]=function(){responseContainer=arguments},jqXHR.always(function(){window[callbackName]=overwritten,s[callbackName]&&(s.jsonpCallback=originalSettings.jsonpCallback,oldCallbacks.push(callbackName)),responseContainer&&jQuery.isFunction(overwritten)&&overwritten(responseContainer[0]),responseContainer=overwritten=void 0;
}),"script"}),jQuery.parseHTML=function(data,context,keepScripts){if(!data||"string"!=typeof data)return null;"boolean"==typeof context&&(keepScripts=context,context=!1),context=context||document;var parsed=rsingleTag.exec(data),scripts=!keepScripts&&[];return parsed?[context.createElement(parsed[1])]:(parsed=jQuery.buildFragment([data],context,scripts),scripts&&scripts.length&&jQuery(scripts).remove(),jQuery.merge([],parsed.childNodes))};var _load=jQuery.fn.load;jQuery.fn.load=function(url,params,callback){if("string"!=typeof url&&_load)return _load.apply(this,arguments);var selector,type,response,self=this,off=url.indexOf(" ");return off>=0&&(selector=jQuery.trim(url.slice(off)),
url=url.slice(0,off)),jQuery.isFunction(params)?(callback=params,params=void 0):params&&"object"==typeof params&&(type="POST"),self.length>0&&jQuery.ajax({url:url,type:type,dataType:"html",data:params}).done(function(responseText){response=arguments,self.html(selector?jQuery("<div>").append(jQuery.parseHTML(responseText)).find(selector):responseText)}).complete(callback&&function(jqXHR,status){self.each(callback,response||[jqXHR.responseText,status,jqXHR])}),this},jQuery.expr.filters.animated=function(elem){return jQuery.grep(jQuery.timers,function(fn){return elem===fn.elem}).length};var docElem=window.document.documentElement;jQuery.offset={setOffset:function(elem,options,i){
var curPosition,curLeft,curCSSTop,curTop,curOffset,curCSSLeft,calculatePosition,position=jQuery.css(elem,"position"),curElem=jQuery(elem),props={};"static"===position&&(elem.style.position="relative"),curOffset=curElem.offset(),curCSSTop=jQuery.css(elem,"top"),curCSSLeft=jQuery.css(elem,"left"),calculatePosition=("absolute"===position||"fixed"===position)&&(curCSSTop+curCSSLeft).indexOf("auto")>-1,calculatePosition?(curPosition=curElem.position(),curTop=curPosition.top,curLeft=curPosition.left):(curTop=parseFloat(curCSSTop)||0,curLeft=parseFloat(curCSSLeft)||0),jQuery.isFunction(options)&&(options=options.call(elem,i,curOffset)),null!=options.top&&(props.top=options.top-curOffset.top+curTop),
null!=options.left&&(props.left=options.left-curOffset.left+curLeft),"using"in options?options.using.call(elem,props):curElem.css(props)}},jQuery.fn.extend({offset:function(options){if(arguments.length)return void 0===options?this:this.each(function(i){jQuery.offset.setOffset(this,options,i)});var docElem,win,elem=this[0],box={top:0,left:0},doc=elem&&elem.ownerDocument;if(doc)return docElem=doc.documentElement,jQuery.contains(docElem,elem)?(typeof elem.getBoundingClientRect!==strundefined&&(box=elem.getBoundingClientRect()),win=getWindow(doc),{top:box.top+win.pageYOffset-docElem.clientTop,left:box.left+win.pageXOffset-docElem.clientLeft}):box},position:function(){
if(this[0]){var offsetParent,offset,elem=this[0],parentOffset={top:0,left:0};return"fixed"===jQuery.css(elem,"position")?offset=elem.getBoundingClientRect():(offsetParent=this.offsetParent(),offset=this.offset(),jQuery.nodeName(offsetParent[0],"html")||(parentOffset=offsetParent.offset()),parentOffset.top+=jQuery.css(offsetParent[0],"borderTopWidth",!0),parentOffset.left+=jQuery.css(offsetParent[0],"borderLeftWidth",!0)),{top:offset.top-parentOffset.top-jQuery.css(elem,"marginTop",!0),left:offset.left-parentOffset.left-jQuery.css(elem,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){for(var offsetParent=this.offsetParent||docElem;offsetParent&&!jQuery.nodeName(offsetParent,"html")&&"static"===jQuery.css(offsetParent,"position");)offsetParent=offsetParent.offsetParent;
return offsetParent||docElem})}}),jQuery.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(method,prop){var top="pageYOffset"===prop;jQuery.fn[method]=function(val){return access(this,function(elem,method,val){var win=getWindow(elem);return void 0===val?win?win[prop]:elem[method]:void(win?win.scrollTo(top?window.pageXOffset:val,top?val:window.pageYOffset):elem[method]=val)},method,val,arguments.length,null)}}),jQuery.each(["top","left"],function(i,prop){jQuery.cssHooks[prop]=addGetHookIf(support.pixelPosition,function(elem,computed){if(computed)return computed=curCSS(elem,prop),rnumnonpx.test(computed)?jQuery(elem).position()[prop]+"px":computed;
})}),jQuery.each({Height:"height",Width:"width"},function(name,type){jQuery.each({padding:"inner"+name,content:type,"":"outer"+name},function(defaultExtra,funcName){jQuery.fn[funcName]=function(margin,value){var chainable=arguments.length&&(defaultExtra||"boolean"!=typeof margin),extra=defaultExtra||(margin===!0||value===!0?"margin":"border");return access(this,function(elem,type,value){var doc;return jQuery.isWindow(elem)?elem.document.documentElement["client"+name]:9===elem.nodeType?(doc=elem.documentElement,Math.max(elem.body["scroll"+name],doc["scroll"+name],elem.body["offset"+name],doc["offset"+name],doc["client"+name])):void 0===value?jQuery.css(elem,type,extra):jQuery.style(elem,type,value,extra);
},type,chainable?margin:void 0,chainable,null)}})}),jQuery.fn.size=function(){return this.length},jQuery.fn.andSelf=jQuery.fn.addBack;var _jQuery=window.jQuery,_$=window.$;return jQuery.noConflict=function(deep){return window.$===jQuery&&(window.$=_$),deep&&window.jQuery===jQuery&&(window.jQuery=_jQuery),jQuery},typeof noGlobal===strundefined&&(window.jQuery=window.$=jQuery),jQuery}),jQuery.noConflict(!0)}),define("taoQtiItem/portableLib/OAT/util/xml",[],function(){return{addNamespace:function(xml,ns){return ns?xml.replace(/<(\/)?([^!\/:>]+)(\/)?>/g,"<$1"+ns+":$2$3>"):xml},removeNamespace:function(markup){return markup.replace(/<(\/)?(\w*):([^>]*)>/g,"<$1$3>");
}}}),define("taoQtiItem/portableLib/OAT/util/math",["taoQtiItem/portableLib/jquery_2_1_1","mathJax"],function($,MathJax){"use strict";return{render:function($container){MathJax&&$container.find("math").each(function(){var $wrap,$math=$(this);$math.wrap($("<span>",{class:"math-renderer"})),$wrap=$math.parent(".math-renderer"),MathJax.Hub.Queue(["Typeset",MathJax.Hub,$wrap[0]])})}}}),function(window,document,undefined){!function(factory){"use strict";"function"==typeof define&&define.amd?define("taoQtiItem/portableLib/jquery.qtip",["taoQtiItem/portableLib/jquery_2_1_1"],factory):jQuery&&!jQuery.fn.qtip&&factory(jQuery)}(function($){"use strict";function QTip(target,options,id,attr){
this.id=id,this.target=target,this.tooltip=NULL,this.elements={target:target},this._id=NAMESPACE+"-"+id,this.timers={img:{}},this.options=options,this.plugins={},this.cache={event:{},target:$(),disabled:FALSE,attr:attr,onTooltip:FALSE,lastClass:""},this.rendered=this.destroyed=this.disabled=this.waiting=this.hiddenDuringWait=this.positioning=this.triggering=FALSE}function invalidOpt(a){return a===NULL||"object"!==$.type(a)}function invalidContent(c){return!($.isFunction(c)||c&&c.attr||c.length||"object"===$.type(c)&&(c.jquery||c.then))}function sanitizeOptions(opts){var content,text,ajax,once;return invalidOpt(opts)?FALSE:(invalidOpt(opts.metadata)&&(opts.metadata={
type:opts.metadata}),"content"in opts&&(content=opts.content,invalidOpt(content)||content.jquery||content.done?(text=invalidContent(content)?FALSE:content,content=opts.content={text:text}):text=content.text,"ajax"in content&&(ajax=content.ajax,once=ajax&&ajax.once!==FALSE,delete content.ajax,content.text=function(event,api){var loading=text||$(this).attr(api.options.content.attr)||"Loading...",deferred=$.ajax($.extend({},ajax,{context:api})).then(ajax.success,NULL,ajax.error).then(function(newContent){return newContent&&once&&api.set("content.text",newContent),newContent},function(xhr,status,error){api.destroyed||0===xhr.status||api.set("content.text",status+": "+error);
});return once?loading:(api.set("content.text",loading),deferred)}),"title"in content&&($.isPlainObject(content.title)&&(content.button=content.title.button,content.title=content.title.text),invalidContent(content.title||FALSE)&&(content.title=FALSE))),"position"in opts&&invalidOpt(opts.position)&&(opts.position={my:opts.position,at:opts.position}),"show"in opts&&invalidOpt(opts.show)&&(opts.show=opts.show.jquery?{target:opts.show}:opts.show===TRUE?{ready:TRUE}:{event:opts.show}),"hide"in opts&&invalidOpt(opts.hide)&&(opts.hide=opts.hide.jquery?{target:opts.hide}:{event:opts.hide}),"style"in opts&&invalidOpt(opts.style)&&(opts.style={classes:opts.style}),$.each(PLUGINS,function(){
this.sanitize&&this.sanitize(opts)}),opts)}function convertNotation(options,notation){for(var obj,i=0,option=options,levels=notation.split(".");option=option[levels[i++]];)i<levels.length&&(obj=option);return[obj||options,levels.pop()]}function setCallback(notation,args){var category,rule,match;for(category in this.checks)if(this.checks.hasOwnProperty(category))for(rule in this.checks[category])this.checks[category].hasOwnProperty(rule)&&(match=new RegExp(rule,"i").exec(notation))&&(args.push(match),("builtin"===category||this.plugins[category])&&this.checks[category][rule].apply(this.plugins[category]||this,args))}function createWidgetClass(cls){return WIDGET.concat("").join(cls?"-"+cls+" ":" ");
}function delay(callback,duration){return duration>0?setTimeout($.proxy(callback,this),duration):void callback.call(this)}function showMethod(event){this.tooltip.hasClass(CLASS_DISABLED)||(clearTimeout(this.timers.show),clearTimeout(this.timers.hide),this.timers.show=delay.call(this,function(){this.toggle(TRUE,event)},this.options.show.delay))}function hideMethod(event){if(!this.tooltip.hasClass(CLASS_DISABLED)&&!this.destroyed){var relatedTarget=$(event.relatedTarget),ontoTooltip=relatedTarget.closest(SELECTOR)[0]===this.tooltip[0],ontoTarget=relatedTarget[0]===this.options.show.target[0];if(clearTimeout(this.timers.show),clearTimeout(this.timers.hide),this!==relatedTarget[0]&&"mouse"===this.options.position.target&&ontoTooltip||this.options.hide.fixed&&/mouse(out|leave|move)/.test(event.type)&&(ontoTooltip||ontoTarget))try{
event.preventDefault(),event.stopImmediatePropagation()}catch(e){}else this.timers.hide=delay.call(this,function(){this.toggle(FALSE,event)},this.options.hide.delay,this)}}function inactiveMethod(event){!this.tooltip.hasClass(CLASS_DISABLED)&&this.options.hide.inactive&&(clearTimeout(this.timers.inactive),this.timers.inactive=delay.call(this,function(){this.hide(event)},this.options.hide.inactive))}function repositionMethod(event){this.rendered&&this.tooltip[0].offsetWidth>0&&this.reposition(event)}function delegate(selector,events,method){$(document.body).delegate(selector,(events.split?events:events.join("."+NAMESPACE+" "))+"."+NAMESPACE,function(){var api=QTIP.api[$.attr(this,ATTR_ID)];
api&&!api.disabled&&method.apply(api,arguments)})}function init(elem,id,opts){var obj,posOptions,attr,config,title,docBody=$(document.body),newTarget=elem[0]===document?docBody:elem,metadata=elem.metadata?elem.metadata(opts.metadata):NULL,metadata5="html5"===opts.metadata.type&&metadata?metadata[opts.metadata.name]:NULL,html5=elem.data(opts.metadata.name||"qtipopts");try{html5="string"==typeof html5?$.parseJSON(html5):html5}catch(e){}if(config=$.extend(TRUE,{},QTIP.defaults,opts,"object"==typeof html5?sanitizeOptions(html5):NULL,sanitizeOptions(metadata5||metadata)),posOptions=config.position,config.id=id,"boolean"==typeof config.content.text){if(attr=elem.attr(config.content.attr),
config.content.attr===FALSE||!attr)return FALSE;config.content.text=attr}if(posOptions.container.length||(posOptions.container=docBody),posOptions.target===FALSE&&(posOptions.target=newTarget),config.show.target===FALSE&&(config.show.target=newTarget),config.show.solo===TRUE&&(config.show.solo=posOptions.container.closest("body")),config.hide.target===FALSE&&(config.hide.target=newTarget),config.position.viewport===TRUE&&(config.position.viewport=posOptions.container),posOptions.container=posOptions.container.eq(0),posOptions.at=new CORNER(posOptions.at,TRUE),posOptions.my=new CORNER(posOptions.my),elem.data(NAMESPACE))if(config.overwrite)elem.qtip("destroy",!0);else if(config.overwrite===FALSE)return FALSE;
return elem.attr(ATTR_HAS,id),config.suppress&&(title=elem.attr("title"))&&elem.removeAttr("title").attr(oldtitle,title).attr("title",""),obj=new QTip(elem,config,id,!!attr),elem.data(NAMESPACE,obj),obj}function camel(s){return s.charAt(0).toUpperCase()+s.slice(1)}function vendorCss(elem,prop){var cur,val,ucProp=prop.charAt(0).toUpperCase()+prop.slice(1),props=(prop+" "+cssPrefixes.join(ucProp+" ")+ucProp).split(" "),i=0;if(cssProps[prop])return elem.css(cssProps[prop]);for(;cur=props[i++];)if((val=elem.css(cur))!==undefined)return cssProps[prop]=cur,val}function intCss(elem,prop){return Math.ceil(parseFloat(vendorCss(elem,prop)))}function Tip(qtip,options){this._ns="tip",
this.options=options,this.offset=options.offset,this.size=[options.width,options.height],this.qtip=qtip,this.init(qtip)}function Modal(api,options){this.options=options,this._ns="-modal",this.qtip=api,this.init(api)}function Ie6(api){this._ns="ie6",this.qtip=api,this.init(api)}var QTIP,PROTOTYPE,CORNER,CHECKS,trackingBound,TRUE=!0,FALSE=!1,NULL=null,X="x",Y="y",WIDTH="width",HEIGHT="height",TOP="top",LEFT="left",BOTTOM="bottom",RIGHT="right",CENTER="center",FLIPINVERT="flipinvert",SHIFT="shift",PLUGINS={},NAMESPACE="qtip",ATTR_HAS="data-hasqtip",ATTR_ID="data-qtip-id",WIDGET=["ui-widget","ui-tooltip"],SELECTOR="."+NAMESPACE,INACTIVE_EVENTS="click dblclick mousedown mouseup mousemove mouseleave mouseenter".split(" "),CLASS_FIXED=NAMESPACE+"-fixed",CLASS_DEFAULT=NAMESPACE+"-default",CLASS_FOCUS=NAMESPACE+"-focus",CLASS_HOVER=NAMESPACE+"-hover",CLASS_DISABLED=NAMESPACE+"-disabled",replaceSuffix="_replacedByqTip",oldtitle="oldtitle",BROWSER={
ie:function(){var v,i;for(v=4,i=document.createElement("div");(i.innerHTML="<!--[if gt IE "+v+"]><i></i><![endif]-->")&&i.getElementsByTagName("i")[0];v+=1);return v>4?v:NaN}(),iOS:parseFloat((""+(/CPU.*OS ([0-9_]{1,5})|(CPU like).*AppleWebKit.*Mobile/i.exec(navigator.userAgent)||[0,""])[1]).replace("undefined","3_2").replace("_",".").replace("_",""))||FALSE};PROTOTYPE=QTip.prototype,PROTOTYPE._when=function(deferreds){return $.when.apply($,deferreds)},PROTOTYPE.render=function(show){if(this.rendered||this.destroyed)return this;var self=this,options=this.options,cache=this.cache,elements=this.elements,text=options.content.text,title=options.content.title,button=options.content.button,posOptions=options.position,deferreds=[];
return $.attr(this.target[0],"aria-describedby",this._id),cache.posClass=this._createPosClass((this.position={my:posOptions.my,at:posOptions.at}).my),this.tooltip=elements.tooltip=$("<div/>",{id:this._id,class:[NAMESPACE,CLASS_DEFAULT,options.style.classes,cache.posClass].join(" "),width:options.style.width||"",height:options.style.height||"",tracking:"mouse"===posOptions.target&&posOptions.adjust.mouse,role:"alert","aria-live":"polite","aria-atomic":FALSE,"aria-describedby":this._id+"-content","aria-hidden":TRUE}).toggleClass(CLASS_DISABLED,this.disabled).attr(ATTR_ID,this.id).data(NAMESPACE,this).appendTo(posOptions.container).append(elements.content=$("<div />",{
class:NAMESPACE+"-content",id:this._id+"-content","aria-atomic":TRUE})),this.rendered=-1,this.positioning=TRUE,title&&(this._createTitle(),$.isFunction(title)||deferreds.push(this._updateTitle(title,FALSE))),button&&this._createButton(),$.isFunction(text)||deferreds.push(this._updateContent(text,FALSE)),this.rendered=TRUE,this._setWidget(),$.each(PLUGINS,function(name){var instance;"render"===this.initialize&&(instance=this(self))&&(self.plugins[name]=instance)}),this._unassignEvents(),this._assignEvents(),this._when(deferreds).then(function(){self._trigger("render"),self.positioning=FALSE,self.hiddenDuringWait||!options.show.ready&&!show||self.toggle(TRUE,cache.event,FALSE),
self.hiddenDuringWait=FALSE}),QTIP.api[this.id]=this,this},PROTOTYPE.destroy=function(immediate){function process(){if(!this.destroyed){this.destroyed=TRUE;var timer,target=this.target,title=target.attr(oldtitle);this.rendered&&this.tooltip.stop(1,0).find("*").remove().end().remove(),$.each(this.plugins,function(){this.destroy&&this.destroy()});for(timer in this.timers)this.timers.hasOwnProperty(timer)&&clearTimeout(this.timers[timer]);target.removeData(NAMESPACE).removeAttr(ATTR_ID).removeAttr(ATTR_HAS).removeAttr("aria-describedby"),this.options.suppress&&title&&target.attr("title",title).removeAttr(oldtitle),this._unassignEvents(),this.options=this.elements=this.cache=this.timers=this.plugins=this.mouse=NULL,
delete QTIP.api[this.id]}}return this.destroyed?this.target:(immediate===TRUE&&"hide"!==this.triggering||!this.rendered?process.call(this):(this.tooltip.one("tooltiphidden",$.proxy(process,this)),!this.triggering&&this.hide()),this.target)},CHECKS=PROTOTYPE.checks={builtin:{"^id$":function(obj,o,v,prev){var id=v===TRUE?QTIP.nextid:v,newId=NAMESPACE+"-"+id;id!==FALSE&&id.length>0&&!$("#"+newId).length?(this._id=newId,this.rendered&&(this.tooltip[0].id=this._id,this.elements.content[0].id=this._id+"-content",this.elements.title[0].id=this._id+"-title")):obj[o]=prev},"^prerender":function(obj,o,v){v&&!this.rendered&&this.render(this.options.show.ready)},"^content.text$":function(obj,o,v){
this._updateContent(v)},"^content.attr$":function(obj,o,v,prev){this.options.content.text===this.target.attr(prev)&&this._updateContent(this.target.attr(v))},"^content.title$":function(obj,o,v){return v?(v&&!this.elements.title&&this._createTitle(),void this._updateTitle(v)):this._removeTitle()},"^content.button$":function(obj,o,v){this._updateButton(v)},"^content.title.(text|button)$":function(obj,o,v){this.set("content."+o,v)},"^position.(my|at)$":function(obj,o,v){"string"==typeof v&&(this.position[o]=obj[o]=new CORNER(v,"at"===o))},"^position.container$":function(obj,o,v){this.rendered&&this.tooltip.appendTo(v)},"^show.ready$":function(obj,o,v){v&&(!this.rendered&&this.render(TRUE)||this.toggle(TRUE));
},"^style.classes$":function(obj,o,v,p){this.rendered&&this.tooltip.removeClass(p).addClass(v)},"^style.(width|height)":function(obj,o,v){this.rendered&&this.tooltip.css(o,v)},"^style.widget|content.title":function(){this.rendered&&this._setWidget()},"^style.def":function(obj,o,v){this.rendered&&this.tooltip.toggleClass(CLASS_DEFAULT,!!v)},"^events.(render|show|move|hide|focus|blur)$":function(obj,o,v){this.rendered&&this.tooltip[($.isFunction(v)?"":"un")+"bind"]("tooltip"+o,v)},"^(show|hide|position).(event|target|fixed|inactive|leave|distance|viewport|adjust)":function(){if(this.rendered){var posOptions=this.options.position;this.tooltip.attr("tracking","mouse"===posOptions.target&&posOptions.adjust.mouse),
this._unassignEvents(),this._assignEvents()}}}},PROTOTYPE.get=function(notation){if(this.destroyed)return this;var o=convertNotation(this.options,notation.toLowerCase()),result=o[0][o[1]];return result.precedance?result.string():result};var rmove=/^position\.(my|at|adjust|target|container|viewport)|style|content|show\.ready/i,rrender=/^prerender|show\.ready/i;PROTOTYPE.set=function(option,value){if(this.destroyed)return this;var name,rendered=this.rendered,reposition=FALSE,options=this.options;return"string"==typeof option?(name=option,option={},option[name]=value):option=$.extend({},option),$.each(option,function(notation,val){if(rendered&&rrender.test(notation))return void delete option[notation];
var previous,obj=convertNotation(options,notation.toLowerCase());previous=obj[0][obj[1]],obj[0][obj[1]]=val&&val.nodeType?$(val):val,reposition=rmove.test(notation)||reposition,option[notation]=[obj[0],obj[1],val,previous]}),sanitizeOptions(options),this.positioning=TRUE,$.each(option,$.proxy(setCallback,this)),this.positioning=FALSE,this.rendered&&this.tooltip[0].offsetWidth>0&&reposition&&this.reposition("mouse"===options.position.target?NULL:this.cache.event),this},PROTOTYPE._update=function(content,element){var self=this,cache=this.cache;return this.rendered&&content?($.isFunction(content)&&(content=content.call(this.elements.target,cache.event,this)||""),
$.isFunction(content.then)?(cache.waiting=TRUE,content.then(function(c){return cache.waiting=FALSE,self._update(c,element)},NULL,function(e){return self._update(e,element)})):content===FALSE||!content&&""!==content?FALSE:(content.jquery&&content.length>0?element.empty().append(content.css({display:"block",visibility:"visible"})):element.html(content),this._waitForContent(element).then(function(images){self.rendered&&self.tooltip[0].offsetWidth>0&&self.reposition(cache.event,!images.length)}))):FALSE},PROTOTYPE._waitForContent=function(element){var cache=this.cache;return cache.waiting=TRUE,($.fn.imagesLoaded?element.imagesLoaded():(new $.Deferred).resolve([])).done(function(){
cache.waiting=FALSE}).promise()},PROTOTYPE._updateContent=function(content,reposition){this._update(content,this.elements.content,reposition)},PROTOTYPE._updateTitle=function(content,reposition){this._update(content,this.elements.title,reposition)===FALSE&&this._removeTitle(FALSE)},PROTOTYPE._createTitle=function(){var elements=this.elements,id=this._id+"-title";elements.titlebar&&this._removeTitle(),elements.titlebar=$("<div />",{class:NAMESPACE+"-titlebar "+(this.options.style.widget?createWidgetClass("header"):"")}).append(elements.title=$("<div />",{id:id,class:NAMESPACE+"-title","aria-atomic":TRUE})).insertBefore(elements.content).delegate(".qtip-close","mousedown keydown mouseup keyup mouseout",function(event){
$(this).toggleClass("ui-state-active ui-state-focus","down"===event.type.substr(-4))}).delegate(".qtip-close","mouseover mouseout",function(event){$(this).toggleClass("ui-state-hover","mouseover"===event.type)}),this.options.content.button&&this._createButton()},PROTOTYPE._removeTitle=function(reposition){var elements=this.elements;elements.title&&(elements.titlebar.remove(),elements.titlebar=elements.title=elements.button=NULL,reposition!==FALSE&&this.reposition())},PROTOTYPE._createPosClass=function(my){return NAMESPACE+"-pos-"+(my||this.options.position.my).abbrev()},PROTOTYPE.reposition=function(event,effect){if(!this.rendered||this.positioning||this.destroyed)return this;
this.positioning=TRUE;var pluginCalculations,offset,adjusted,newClass,cache=this.cache,tooltip=this.tooltip,posOptions=this.options.position,target=posOptions.target,my=posOptions.my,at=posOptions.at,viewport=posOptions.viewport,container=posOptions.container,adjust=posOptions.adjust,method=adjust.method.split(" "),tooltipWidth=tooltip.outerWidth(FALSE),tooltipHeight=tooltip.outerHeight(FALSE),targetWidth=0,targetHeight=0,type=tooltip.css("position"),position={left:0,top:0},visible=tooltip[0].offsetWidth>0,isScroll=event&&"scroll"===event.type,win=$(window),doc=container[0].ownerDocument,mouse=this.mouse;if($.isArray(target)&&2===target.length)at={x:LEFT,y:TOP
},position={left:target[0],top:target[1]};else if("mouse"===target)at={x:LEFT,y:TOP},(!adjust.mouse||this.options.hide.distance)&&cache.origin&&cache.origin.pageX?event=cache.origin:!event||event&&("resize"===event.type||"scroll"===event.type)?event=cache.event:mouse&&mouse.pageX&&(event=mouse),"static"!==type&&(position=container.offset()),doc.body.offsetWidth!==(window.innerWidth||doc.documentElement.clientWidth)&&(offset=$(document.body).offset()),position={left:event.pageX-position.left+(offset&&offset.left||0),top:event.pageY-position.top+(offset&&offset.top||0)},adjust.mouse&&isScroll&&mouse&&(position.left-=(mouse.scrollX||0)-win.scrollLeft(),position.top-=(mouse.scrollY||0)-win.scrollTop());else{
if("event"===target?event&&event.target&&"scroll"!==event.type&&"resize"!==event.type?cache.target=$(event.target):event.target||(cache.target=this.elements.target):"event"!==target&&(cache.target=$(target.jquery?target:this.elements.target)),target=cache.target,target=$(target).eq(0),0===target.length)return this;target[0]===document||target[0]===window?(targetWidth=BROWSER.iOS?window.innerWidth:target.width(),targetHeight=BROWSER.iOS?window.innerHeight:target.height(),target[0]===window&&(position={top:(viewport||target).scrollTop(),left:(viewport||target).scrollLeft()})):PLUGINS.imagemap&&target.is("area")?pluginCalculations=PLUGINS.imagemap(this,target,at,PLUGINS.viewport?method:FALSE):PLUGINS.svg&&target&&target[0].ownerSVGElement?pluginCalculations=PLUGINS.svg(this,target,at,PLUGINS.viewport?method:FALSE):(targetWidth=target.outerWidth(FALSE),
targetHeight=target.outerHeight(FALSE),position=target.offset()),pluginCalculations&&(targetWidth=pluginCalculations.width,targetHeight=pluginCalculations.height,offset=pluginCalculations.offset,position=pluginCalculations.position),position=this.reposition.offset(target,position,container),(BROWSER.iOS>3.1&&BROWSER.iOS<4.1||BROWSER.iOS>=4.3&&BROWSER.iOS<4.33||!BROWSER.iOS&&"fixed"===type)&&(position.left-=win.scrollLeft(),position.top-=win.scrollTop()),(!pluginCalculations||pluginCalculations&&pluginCalculations.adjustable!==FALSE)&&(position.left+=at.x===RIGHT?targetWidth:at.x===CENTER?targetWidth/2:0,position.top+=at.y===BOTTOM?targetHeight:at.y===CENTER?targetHeight/2:0);
}return position.left+=adjust.x+(my.x===RIGHT?-tooltipWidth:my.x===CENTER?-tooltipWidth/2:0),position.top+=adjust.y+(my.y===BOTTOM?-tooltipHeight:my.y===CENTER?-tooltipHeight/2:0),PLUGINS.viewport?(adjusted=position.adjusted=PLUGINS.viewport(this,position,posOptions,targetWidth,targetHeight,tooltipWidth,tooltipHeight),offset&&adjusted.left&&(position.left+=offset.left),offset&&adjusted.top&&(position.top+=offset.top),adjusted.my&&(this.position.my=adjusted.my)):position.adjusted={left:0,top:0},cache.posClass!==(newClass=this._createPosClass(this.position.my))&&(cache.posClass=newClass,tooltip.removeClass(cache.posClass).addClass(newClass)),this._trigger("move",[position,viewport.elem||viewport],event)?(delete position.adjusted,
effect===FALSE||!visible||isNaN(position.left)||isNaN(position.top)||"mouse"===target||!$.isFunction(posOptions.effect)?tooltip.css(position):$.isFunction(posOptions.effect)&&(posOptions.effect.call(tooltip,this,$.extend({},position)),tooltip.queue(function(next){$(this).css({opacity:"",height:""}),BROWSER.ie&&this.style.removeAttribute("filter"),next()})),this.positioning=FALSE,this):this},PROTOTYPE.reposition.offset=function(elem,pos,container){function scroll(e,i){pos.left+=i*e.scrollLeft(),pos.top+=i*e.scrollTop()}if(!container[0])return pos;var scrolled,position,parentOffset,overflow,ownerDocument=$(elem[0].ownerDocument),quirks=!!BROWSER.ie&&"CSS1Compat"!==document.compatMode,parent=container[0];
do"static"!==(position=$.css(parent,"position"))&&("fixed"===position?(parentOffset=parent.getBoundingClientRect(),scroll(ownerDocument,-1)):(parentOffset=$(parent).position(),parentOffset.left+=parseFloat($.css(parent,"borderLeftWidth"))||0,parentOffset.top+=parseFloat($.css(parent,"borderTopWidth"))||0),pos.left-=parentOffset.left+(parseFloat($.css(parent,"marginLeft"))||0),pos.top-=parentOffset.top+(parseFloat($.css(parent,"marginTop"))||0),scrolled||"hidden"===(overflow=$.css(parent,"overflow"))||"visible"===overflow||(scrolled=$(parent)));while(parent=parent.offsetParent);return scrolled&&(scrolled[0]!==ownerDocument[0]||quirks)&&scroll(scrolled,1),pos};var C=(CORNER=PROTOTYPE.reposition.Corner=function(corner,forceY){
corner=(""+corner).replace(/([A-Z])/," $1").replace(/middle/gi,CENTER).toLowerCase(),this.x=(corner.match(/left|right/i)||corner.match(/center/)||["inherit"])[0].toLowerCase(),this.y=(corner.match(/top|bottom|center/i)||["inherit"])[0].toLowerCase(),this.forceY=!!forceY;var f=corner.charAt(0);this.precedance="t"===f||"b"===f?Y:X}).prototype;C.invert=function(z,center){this[z]=this[z]===LEFT?RIGHT:this[z]===RIGHT?LEFT:center||this[z]},C.string=function(join){var x=this.x,y=this.y,result=x!==y?"center"===x||"center"!==y&&(this.precedance===Y||this.forceY)?[y,x]:[x,y]:[x];return join!==!1?result.join(" "):result},C.abbrev=function(){var result=this.string(!1);return result[0].charAt(0)+(result[1]&&result[1].charAt(0)||"");
},C.clone=function(){return new CORNER(this.string(),this.forceY)},PROTOTYPE.toggle=function(state,event){var cache=this.cache,options=this.options,tooltip=this.tooltip;if(event){if(/over|enter/.test(event.type)&&cache.event&&/out|leave/.test(cache.event.type)&&options.show.target.add(event.target).length===options.show.target.length&&tooltip.has(event.relatedTarget).length)return this;cache.event=$.event.fix(event)}if(this.waiting&&!state&&(this.hiddenDuringWait=TRUE),!this.rendered)return state?this.render(1):this;if(this.destroyed||this.disabled)return this;var identicalState,allow,after,type=state?"show":"hide",opts=this.options[type],posOptions=this.options.position,contentOptions=this.options.content,width=this.tooltip.css("width"),visible=this.tooltip.is(":visible"),animate=state||1===opts.target.length,sameTarget=!event||opts.target.length<2||cache.target[0]===event.target;
return(typeof state).search("boolean|number")&&(state=!visible),identicalState=!tooltip.is(":animated")&&visible===state&&sameTarget,allow=identicalState?NULL:!!this._trigger(type,[90]),this.destroyed?this:(allow!==FALSE&&state&&this.focus(event),!allow||identicalState?this:($.attr(tooltip[0],"aria-hidden",!state),state?(this.mouse&&(cache.origin=$.event.fix(this.mouse)),$.isFunction(contentOptions.text)&&this._updateContent(contentOptions.text,FALSE),$.isFunction(contentOptions.title)&&this._updateTitle(contentOptions.title,FALSE),!trackingBound&&"mouse"===posOptions.target&&posOptions.adjust.mouse&&($(document).bind("mousemove."+NAMESPACE,this._storeMouse),
trackingBound=TRUE),width||tooltip.css("width",tooltip.outerWidth(FALSE)),this.reposition(event,arguments[2]),width||tooltip.css("width",""),opts.solo&&("string"==typeof opts.solo?$(opts.solo):$(SELECTOR,opts.solo)).not(tooltip).not(opts.target).qtip("hide",new $.Event("tooltipsolo"))):(clearTimeout(this.timers.show),delete cache.origin,trackingBound&&!$(SELECTOR+'[tracking="true"]:visible',opts.solo).not(tooltip).length&&($(document).unbind("mousemove."+NAMESPACE),trackingBound=FALSE),this.blur(event)),after=$.proxy(function(){state?(BROWSER.ie&&tooltip[0].style.removeAttribute("filter"),tooltip.css("overflow",""),"string"==typeof opts.autofocus&&$(this.options.show.autofocus,tooltip).focus(),
this.options.show.target.trigger("qtip-"+this.id+"-inactive")):tooltip.css({display:"",visibility:"",opacity:"",left:"",top:""}),this._trigger(state?"visible":"hidden")},this),opts.effect===FALSE||animate===FALSE?(tooltip[type](),after()):$.isFunction(opts.effect)?(tooltip.stop(1,1),opts.effect.call(tooltip,this),tooltip.queue("fx",function(n){after(),n()})):tooltip.fadeTo(90,state?1:0,after),state&&opts.target.trigger("qtip-"+this.id+"-inactive"),this))},PROTOTYPE.show=function(event){return this.toggle(TRUE,event)},PROTOTYPE.hide=function(event){return this.toggle(FALSE,event)},PROTOTYPE.focus=function(event){if(!this.rendered||this.destroyed)return this;var qtips=$(SELECTOR),tooltip=this.tooltip,curIndex=parseInt(tooltip[0].style.zIndex,10),newIndex=QTIP.zindex+qtips.length;
return tooltip.hasClass(CLASS_FOCUS)||this._trigger("focus",[newIndex],event)&&(curIndex!==newIndex&&(qtips.each(function(){this.style.zIndex>curIndex&&(this.style.zIndex=this.style.zIndex-1)}),qtips.filter("."+CLASS_FOCUS).qtip("blur",event)),tooltip.addClass(CLASS_FOCUS)[0].style.zIndex=newIndex),this},PROTOTYPE.blur=function(event){return!this.rendered||this.destroyed?this:(this.tooltip.removeClass(CLASS_FOCUS),this._trigger("blur",[this.tooltip.css("zIndex")],event),this)},PROTOTYPE.disable=function(state){return this.destroyed?this:("toggle"===state?state=!(this.rendered?this.tooltip.hasClass(CLASS_DISABLED):this.disabled):"boolean"!=typeof state&&(state=TRUE),
this.rendered&&this.tooltip.toggleClass(CLASS_DISABLED,state).attr("aria-disabled",state),this.disabled=!!state,this)},PROTOTYPE.enable=function(){return this.disable(FALSE)},PROTOTYPE._createButton=function(){var self=this,elements=this.elements,tooltip=elements.tooltip,button=this.options.content.button,isString="string"==typeof button,close=isString?button:"Close tooltip";elements.button&&elements.button.remove(),button.jquery?elements.button=button:elements.button=$("<a />",{class:"qtip-close "+(this.options.style.widget?"":NAMESPACE+"-icon"),title:close,"aria-label":close}).prepend($("<span />",{class:"ui-icon ui-icon-close",html:"&times;"})),elements.button.appendTo(elements.titlebar||tooltip).attr("role","button").click(function(event){
return tooltip.hasClass(CLASS_DISABLED)||self.hide(event),FALSE})},PROTOTYPE._updateButton=function(button){if(!this.rendered)return FALSE;var elem=this.elements.button;button?this._createButton():elem.remove()},PROTOTYPE._setWidget=function(){var on=this.options.style.widget,elements=this.elements,tooltip=elements.tooltip,disabled=tooltip.hasClass(CLASS_DISABLED);tooltip.removeClass(CLASS_DISABLED),CLASS_DISABLED=on?"ui-state-disabled":"qtip-disabled",tooltip.toggleClass(CLASS_DISABLED,disabled),tooltip.toggleClass("ui-helper-reset "+createWidgetClass(),on).toggleClass(CLASS_DEFAULT,this.options.style.def&&!on),elements.content&&elements.content.toggleClass(createWidgetClass("content"),on),
elements.titlebar&&elements.titlebar.toggleClass(createWidgetClass("header"),on),elements.button&&elements.button.toggleClass(NAMESPACE+"-icon",!on)},PROTOTYPE._storeMouse=function(event){return(this.mouse=$.event.fix(event)).type="mousemove",this},PROTOTYPE._bind=function(targets,events,method,suffix,context){if(targets&&method&&events.length){var ns="."+this._id+(suffix?"-"+suffix:"");return $(targets).bind((events.split?events:events.join(ns+" "))+ns,$.proxy(method,context||this)),this}},PROTOTYPE._unbind=function(targets,suffix){return targets&&$(targets).unbind("."+this._id+(suffix?"-"+suffix:"")),this},PROTOTYPE._trigger=function(type,args,event){var callback=new $.Event("tooltip"+type);
return callback.originalEvent=event&&$.extend({},event)||this.cache.event||NULL,this.triggering=type,this.tooltip.trigger(callback,[this].concat(args||[])),this.triggering=FALSE,!callback.isDefaultPrevented()},PROTOTYPE._bindEvents=function(showEvents,hideEvents,showTargets,hideTargets,showCallback,hideCallback){var similarTargets=showTargets.filter(hideTargets).add(hideTargets.filter(showTargets)),toggleEvents=[];similarTargets.length&&($.each(hideEvents,function(i,type){var showIndex=$.inArray(type,showEvents);showIndex>-1&&toggleEvents.push(showEvents.splice(showIndex,1)[0])}),toggleEvents.length&&(this._bind(similarTargets,toggleEvents,function(event){var state=!!this.rendered&&this.tooltip[0].offsetWidth>0;
(state?hideCallback:showCallback).call(this,event)}),showTargets=showTargets.not(similarTargets),hideTargets=hideTargets.not(similarTargets))),this._bind(showTargets,showEvents,showCallback),this._bind(hideTargets,hideEvents,hideCallback)},PROTOTYPE._assignInitialEvents=function(event){function hoverIntent(hoverEvent){return this.disabled||this.destroyed?FALSE:(this.cache.event=hoverEvent&&$.event.fix(hoverEvent),this.cache.target=hoverEvent&&$(hoverEvent.target),clearTimeout(this.timers.show),void(this.timers.show=delay.call(this,function(){this.render("object"==typeof hoverEvent||options.show.ready)},options.prerender?0:options.show.delay)))}var options=this.options,showTarget=options.show.target,hideTarget=options.hide.target,showEvents=options.show.event?$.trim(""+options.show.event).split(" "):[],hideEvents=options.hide.event?$.trim(""+options.hide.event).split(" "):[];
this._bind(this.elements.target,["remove","removeqtip"],function(){this.destroy(!0)},"destroy"),/mouse(over|enter)/i.test(options.show.event)&&!/mouse(out|leave)/i.test(options.hide.event)&&hideEvents.push("mouseleave"),this._bind(showTarget,"mousemove",function(moveEvent){this._storeMouse(moveEvent),this.cache.onTarget=TRUE}),this._bindEvents(showEvents,hideEvents,showTarget,hideTarget,hoverIntent,function(){return this.timers?void clearTimeout(this.timers.show):FALSE}),(options.show.ready||options.prerender)&&hoverIntent.call(this,event)},PROTOTYPE._assignEvents=function(){var self=this,options=this.options,posOptions=options.position,tooltip=this.tooltip,showTarget=options.show.target,hideTarget=options.hide.target,containerTarget=posOptions.container,viewportTarget=posOptions.viewport,documentTarget=$(document),windowTarget=$(window),showEvents=options.show.event?$.trim(""+options.show.event).split(" "):[],hideEvents=options.hide.event?$.trim(""+options.hide.event).split(" "):[];
$.each(options.events,function(name,callback){self._bind(tooltip,"toggle"===name?["tooltipshow","tooltiphide"]:["tooltip"+name],callback,null,tooltip)}),/mouse(out|leave)/i.test(options.hide.event)&&"window"===options.hide.leave&&this._bind(documentTarget,["mouseout","blur"],function(event){/select|option/.test(event.target.nodeName)||event.relatedTarget||this.hide(event)}),options.hide.fixed?hideTarget=hideTarget.add(tooltip.addClass(CLASS_FIXED)):/mouse(over|enter)/i.test(options.show.event)&&this._bind(hideTarget,"mouseleave",function(){clearTimeout(this.timers.show)}),(""+options.hide.event).indexOf("unfocus")>-1&&this._bind(containerTarget.closest("html"),["mousedown","touchstart"],function(event){
var elem=$(event.target),enabled=this.rendered&&!this.tooltip.hasClass(CLASS_DISABLED)&&this.tooltip[0].offsetWidth>0,isAncestor=elem.parents(SELECTOR).filter(this.tooltip[0]).length>0;elem[0]===this.target[0]||elem[0]===this.tooltip[0]||isAncestor||this.target.has(elem[0]).length||!enabled||this.hide(event)}),"number"==typeof options.hide.inactive&&(this._bind(showTarget,"qtip-"+this.id+"-inactive",inactiveMethod,"inactive"),this._bind(hideTarget.add(tooltip),QTIP.inactiveEvents,inactiveMethod)),this._bindEvents(showEvents,hideEvents,showTarget,hideTarget,showMethod,hideMethod),this._bind(showTarget.add(tooltip),"mousemove",function(event){if("number"==typeof options.hide.distance){
var origin=this.cache.origin||{},limit=this.options.hide.distance,abs=Math.abs;(abs(event.pageX-origin.pageX)>=limit||abs(event.pageY-origin.pageY)>=limit)&&this.hide(event)}this._storeMouse(event)}),"mouse"===posOptions.target&&posOptions.adjust.mouse&&(options.hide.event&&this._bind(showTarget,["mouseenter","mouseleave"],function(event){return this.cache?void(this.cache.onTarget="mouseenter"===event.type):FALSE}),this._bind(documentTarget,"mousemove",function(event){this.rendered&&this.cache.onTarget&&!this.tooltip.hasClass(CLASS_DISABLED)&&this.tooltip[0].offsetWidth>0&&this.reposition(event)})),(posOptions.adjust.resize||viewportTarget.length)&&this._bind($.event.special.resize?viewportTarget:windowTarget,"resize",repositionMethod),
posOptions.adjust.scroll&&this._bind(windowTarget.add(posOptions.container),"scroll",repositionMethod)},PROTOTYPE._unassignEvents=function(){var options=this.options,showTargets=options.show.target,hideTargets=options.hide.target,targets=$.grep([this.elements.target[0],this.rendered&&this.tooltip[0],options.position.container[0],options.position.viewport[0],options.position.container.closest("html")[0],window,document],function(i){return"object"==typeof i});showTargets&&showTargets.toArray&&(targets=targets.concat(showTargets.toArray())),hideTargets&&hideTargets.toArray&&(targets=targets.concat(hideTargets.toArray())),this._unbind(targets)._unbind(targets,"destroy")._unbind(targets,"inactive");
},$(function(){delegate(SELECTOR,["mouseenter","mouseleave"],function(event){var state="mouseenter"===event.type,tooltip=$(event.currentTarget),target=$(event.relatedTarget||event.target),options=this.options;state?(this.focus(event),tooltip.hasClass(CLASS_FIXED)&&!tooltip.hasClass(CLASS_DISABLED)&&clearTimeout(this.timers.hide)):"mouse"===options.position.target&&options.position.adjust.mouse&&options.hide.event&&options.show.target&&!target.closest(options.show.target[0]).length&&this.hide(event),tooltip.toggleClass(CLASS_HOVER,state)}),delegate("["+ATTR_ID+"]",INACTIVE_EVENTS,inactiveMethod)}),QTIP=$.fn.qtip=function(options,notation,newValue){var command=(""+options).toLowerCase(),returned=NULL,args=$.makeArray(arguments).slice(1),event=args[args.length-1],opts=this[0]?$.data(this[0],NAMESPACE):NULL;
return!arguments.length&&opts||"api"===command?opts:"string"==typeof options?(this.each(function(){var api=$.data(this,NAMESPACE);if(!api)return TRUE;if(event&&event.timeStamp&&(api.cache.event=event),!notation||"option"!==command&&"options"!==command)api[command]&&api[command].apply(api,args);else{if(newValue===undefined&&!$.isPlainObject(notation))return returned=api.get(notation),FALSE;api.set(notation,newValue)}}),returned!==NULL?returned:this):"object"!=typeof options&&arguments.length?void 0:(opts=sanitizeOptions($.extend(TRUE,{},options)),this.each(function(i){var api,id;return id=$.isArray(opts.id)?opts.id[i]:opts.id,id=!id||id===FALSE||id.length<1||QTIP.api[id]?QTIP.nextid++:id,
api=init($(this),id,opts),api===FALSE?TRUE:(QTIP.api[id]=api,$.each(PLUGINS,function(){"initialize"===this.initialize&&this(api)}),void api._assignInitialEvents(event))}))},$.qtip=QTip,QTIP.api={},$.each({attr:function(attr,val){if(this.length){var self=this[0],title="title",api=$.data(self,"qtip");if(attr===title&&api&&api.options&&"object"==typeof api&&"object"==typeof api.options&&api.options.suppress)return arguments.length<2?$.attr(self,oldtitle):(api&&api.options.content.attr===title&&api.cache.attr&&api.set("content.text",val),this.attr(oldtitle,val))}return $.fn["attr"+replaceSuffix].apply(this,arguments)},clone:function(keepData){var elems=$.fn["clone"+replaceSuffix].apply(this,arguments);
return keepData||elems.filter("["+oldtitle+"]").attr("title",function(){return $.attr(this,oldtitle)}).removeAttr(oldtitle),elems}},function(name,func){if(!func||$.fn[name+replaceSuffix])return TRUE;var old=$.fn[name+replaceSuffix]=$.fn[name];$.fn[name]=function(){return func.apply(this,arguments)||old.apply(this,arguments)}}),$.ui||($["cleanData"+replaceSuffix]=$.cleanData,$.cleanData=function(elems){for(var elem,i=0;(elem=$(elems[i])).length;i++)if(elem.attr(ATTR_HAS))try{elem.triggerHandler("removeqtip")}catch(e){}$["cleanData"+replaceSuffix].apply(this,arguments)}),QTIP.version="3.0.3",QTIP.nextid=0,QTIP.inactiveEvents=INACTIVE_EVENTS,QTIP.zindex=15e3,QTIP.defaults={
prerender:FALSE,id:FALSE,overwrite:TRUE,suppress:TRUE,content:{text:TRUE,attr:"title",title:FALSE,button:FALSE},position:{my:"top left",at:"bottom right",target:FALSE,container:FALSE,viewport:FALSE,adjust:{x:0,y:0,mouse:TRUE,scroll:TRUE,resize:TRUE,method:"flipinvert flipinvert"},effect:function(api,pos){$(this).animate(pos,{duration:200,queue:FALSE})}},show:{target:FALSE,event:"mouseenter",effect:TRUE,delay:90,solo:FALSE,ready:FALSE,autofocus:FALSE},hide:{target:FALSE,event:"mouseleave",effect:TRUE,delay:0,fixed:FALSE,inactive:FALSE,leave:"window",distance:FALSE},style:{classes:"",widget:FALSE,width:FALSE,height:FALSE,def:TRUE},events:{render:NULL,move:NULL,
show:NULL,hide:NULL,toggle:NULL,visible:NULL,hidden:NULL,focus:NULL,blur:NULL}};var TIP,createVML,SCALE,PIXEL_RATIO,BACKING_STORE_RATIO,MARGIN="margin",BORDER="border",COLOR="color",BG_COLOR="background-color",TRANSPARENT="transparent",IMPORTANT=" !important",HASCANVAS=!!document.createElement("canvas").getContext,INVALID=/rgba?\(0, 0, 0(, 0)?\)|transparent|#123456/i,cssProps={},cssPrefixes=["Webkit","O","Moz","ms"];HASCANVAS?(PIXEL_RATIO=window.devicePixelRatio||1,BACKING_STORE_RATIO=function(){var context=document.createElement("canvas").getContext("2d");return context.backingStorePixelRatio||context.webkitBackingStorePixelRatio||context.mozBackingStorePixelRatio||context.msBackingStorePixelRatio||context.oBackingStorePixelRatio||1;
}(),SCALE=PIXEL_RATIO/BACKING_STORE_RATIO):createVML=function(tag,props,style){return"<qtipvml:"+tag+' xmlns="urn:schemas-microsoft.com:vml" class="qtip-vml" '+(props||"")+' style="behavior: url(#default#VML); '+(style||"")+'" />'},$.extend(Tip.prototype,{init:function(qtip){var context,tip;tip=this.element=qtip.elements.tip=$("<div />",{class:NAMESPACE+"-tip"}).prependTo(qtip.tooltip),HASCANVAS?(context=$("<canvas />").appendTo(this.element)[0].getContext("2d"),context.lineJoin="miter",context.miterLimit=1e5,context.save()):(context=createVML("shape",'coordorigin="0,0"',"position:absolute;"),this.element.html(context+context),qtip._bind($("*",tip).add(tip),["click","mousedown"],function(event){
event.stopPropagation()},this._ns)),qtip._bind(qtip.tooltip,"tooltipmove",this.reposition,this._ns,this),this.create()},_swapDimensions:function(){this.size[0]=this.options.height,this.size[1]=this.options.width},_resetDimensions:function(){this.size[0]=this.options.width,this.size[1]=this.options.height},_useTitle:function(corner){var titlebar=this.qtip.elements.titlebar;return titlebar&&(corner.y===TOP||corner.y===CENTER&&this.element.position().top+this.size[1]/2+this.options.offset<titlebar.outerHeight(TRUE))},_parseCorner:function(corner){var my=this.qtip.options.position.my;return corner===FALSE||my===FALSE?corner=FALSE:corner===TRUE?corner=new CORNER(my.string()):corner.string||(corner=new CORNER(corner),
corner.fixed=TRUE),corner},_parseWidth:function(corner,side,use){var elements=this.qtip.elements,prop=BORDER+camel(side)+"Width";return(use?intCss(use,prop):intCss(elements.content,prop)||intCss(this._useTitle(corner)&&elements.titlebar||elements.content,prop)||intCss(elements.tooltip,prop))||0},_parseRadius:function(corner){var elements=this.qtip.elements,prop=BORDER+camel(corner.y)+camel(corner.x)+"Radius";return BROWSER.ie<9?0:intCss(this._useTitle(corner)&&elements.titlebar||elements.content,prop)||intCss(elements.tooltip,prop)||0},_invalidColour:function(elem,prop,compare){var val=elem.css(prop);return!val||compare&&val===elem.css(compare)||INVALID.test(val)?FALSE:val;
},_parseColours:function(corner){var elements=this.qtip.elements,tip=this.element.css("cssText",""),borderSide=BORDER+camel(corner[corner.precedance])+camel(COLOR),colorElem=this._useTitle(corner)&&elements.titlebar||elements.content,css=this._invalidColour,color=[];return color[0]=css(tip,BG_COLOR)||css(colorElem,BG_COLOR)||css(elements.content,BG_COLOR)||css(elements.tooltip,BG_COLOR)||tip.css(BG_COLOR),color[1]=css(tip,borderSide,COLOR)||css(colorElem,borderSide,COLOR)||css(elements.content,borderSide,COLOR)||css(elements.tooltip,borderSide,COLOR)||elements.tooltip.css(borderSide),$("*",tip).add(tip).css("cssText",BG_COLOR+":"+TRANSPARENT+IMPORTANT+";"+BORDER+":0"+IMPORTANT+";"),
color},_calculateSize:function(corner){var bigHyp,ratio,result,y=corner.precedance===Y,width=this.options.width,height=this.options.height,isCenter="c"===corner.abbrev(),base=(y?width:height)*(isCenter?.5:1),pow=Math.pow,round=Math.round,smallHyp=Math.sqrt(pow(base,2)+pow(height,2)),hyp=[this.border/base*smallHyp,this.border/height*smallHyp];return hyp[2]=Math.sqrt(pow(hyp[0],2)-pow(this.border,2)),hyp[3]=Math.sqrt(pow(hyp[1],2)-pow(this.border,2)),bigHyp=smallHyp+hyp[2]+hyp[3]+(isCenter?0:hyp[0]),ratio=bigHyp/smallHyp,result=[round(ratio*width),round(ratio*height)],y?result:result.reverse()},_calculateTip:function(corner,size,scale){scale=scale||1,size=size||this.size;
var width=size[0]*scale,height=size[1]*scale,width2=Math.ceil(width/2),height2=Math.ceil(height/2),tips={br:[0,0,width,height,width,0],bl:[0,0,width,0,0,height],tr:[0,height,width,0,width,height],tl:[0,0,0,height,width,height],tc:[0,height,width2,0,width,height],bc:[0,0,width,0,width2,height],rc:[0,0,width,height2,0,height],lc:[width,0,width,height,0,height2]};return tips.lt=tips.br,tips.rt=tips.bl,tips.lb=tips.tr,tips.rb=tips.tl,tips[corner.abbrev()]},_drawCoords:function(context,coords){context.beginPath(),context.moveTo(coords[0],coords[1]),context.lineTo(coords[2],coords[3]),context.lineTo(coords[4],coords[5]),context.closePath()},create:function(){var c=this.corner=(HASCANVAS||BROWSER.ie)&&this._parseCorner(this.options.corner);
return this.enabled=!!this.corner&&"c"!==this.corner.abbrev(),this.enabled&&(this.qtip.cache.corner=c.clone(),this.update()),this.element.toggle(this.enabled),this.corner},update:function(corner,position){if(!this.enabled)return this;var color,precedance,context,coords,bigCoords,translate,newSize,border,elements=this.qtip.elements,tip=this.element,inner=tip.children(),options=this.options,curSize=this.size,mimic=options.mimic,round=Math.round;corner||(corner=this.qtip.cache.corner||this.corner),mimic===FALSE?mimic=corner:(mimic=new CORNER(mimic),mimic.precedance=corner.precedance,"inherit"===mimic.x?mimic.x=corner.x:"inherit"===mimic.y?mimic.y=corner.y:mimic.x===mimic.y&&(mimic[corner.precedance]=corner[corner.precedance])),
precedance=mimic.precedance,corner.precedance===X?this._swapDimensions():this._resetDimensions(),color=this.color=this._parseColours(corner),color[1]!==TRANSPARENT?(border=this.border=this._parseWidth(corner,corner[corner.precedance]),options.border&&border<1&&!INVALID.test(color[1])&&(color[0]=color[1]),this.border=border=options.border!==TRUE?options.border:border):this.border=border=0,newSize=this.size=this._calculateSize(corner),tip.css({width:newSize[0],height:newSize[1],lineHeight:newSize[1]+"px"}),translate=corner.precedance===Y?[round(mimic.x===LEFT?border:mimic.x===RIGHT?newSize[0]-curSize[0]-border:(newSize[0]-curSize[0])/2),round(mimic.y===TOP?newSize[1]-curSize[1]:0)]:[round(mimic.x===LEFT?newSize[0]-curSize[0]:0),round(mimic.y===TOP?border:mimic.y===BOTTOM?newSize[1]-curSize[1]-border:(newSize[1]-curSize[1])/2)],
HASCANVAS?(context=inner[0].getContext("2d"),context.restore(),context.save(),context.clearRect(0,0,6e3,6e3),coords=this._calculateTip(mimic,curSize,SCALE),bigCoords=this._calculateTip(mimic,this.size,SCALE),inner.attr(WIDTH,newSize[0]*SCALE).attr(HEIGHT,newSize[1]*SCALE),inner.css(WIDTH,newSize[0]).css(HEIGHT,newSize[1]),this._drawCoords(context,bigCoords),context.fillStyle=color[1],context.fill(),context.translate(translate[0]*SCALE,translate[1]*SCALE),this._drawCoords(context,coords),context.fillStyle=color[0],context.fill()):(coords=this._calculateTip(mimic),coords="m"+coords[0]+","+coords[1]+" l"+coords[2]+","+coords[3]+" "+coords[4]+","+coords[5]+" xe",
translate[2]=border&&/^(r|b)/i.test(corner.string())?8===BROWSER.ie?2:1:0,inner.css({coordsize:newSize[0]+border+" "+newSize[1]+border,antialias:""+(mimic.string().indexOf(CENTER)>-1),left:translate[0]-translate[2]*Number(precedance===X),top:translate[1]-translate[2]*Number(precedance===Y),width:newSize[0]+border,height:newSize[1]+border}).each(function(i){var $this=$(this);$this[$this.prop?"prop":"attr"]({coordsize:newSize[0]+border+" "+newSize[1]+border,path:coords,fillcolor:color[0],filled:!!i,stroked:!i}).toggle(!(!border&&!i)),!i&&$this.html(createVML("stroke",'weight="'+2*border+'px" color="'+color[1]+'" miterlimit="1000" joinstyle="miter"'))})),window.opera&&setTimeout(function(){
elements.tip.css({display:"inline-block",visibility:"visible"})},1),position!==FALSE&&this.calculate(corner,newSize)},calculate:function(corner,size){if(!this.enabled)return FALSE;var precedance,corners,self=this,elements=this.qtip.elements,tip=this.element,userOffset=this.options.offset,position={};return corner=corner||this.corner,precedance=corner.precedance,size=size||this._calculateSize(corner),corners=[corner.x,corner.y],precedance===X&&corners.reverse(),$.each(corners,function(i,side){var b,bc,br;side===CENTER?(b=precedance===Y?LEFT:TOP,position[b]="50%",position[MARGIN+"-"+b]=-Math.round(size[precedance===Y?0:1]/2)+userOffset):(b=self._parseWidth(corner,side,elements.tooltip),
bc=self._parseWidth(corner,side,elements.content),br=self._parseRadius(corner),position[side]=Math.max(-self.border,i?bc:userOffset+(br>b?br:-b)))}),position[corner[precedance]]-=size[precedance===X?0:1],tip.css({margin:"",top:"",bottom:"",left:"",right:""}).css(position),position},reposition:function(event,api,pos){function shiftflip(direction,precedance,popposite,side,opposite){direction===SHIFT&&newCorner.precedance===precedance&&adjust[side]&&newCorner[popposite]!==CENTER?newCorner.precedance=newCorner.precedance===X?Y:X:direction!==SHIFT&&adjust[side]&&(newCorner[precedance]=newCorner[precedance]===CENTER?adjust[side]>0?side:opposite:newCorner[precedance]===side?opposite:side);
}function shiftonly(xy,side,opposite){newCorner[xy]===CENTER?css[MARGIN+"-"+side]=shift[xy]=offset[MARGIN+"-"+side]-adjust[side]:(props=offset[opposite]!==undefined?[adjust[side],-offset[side]]:[-adjust[side],offset[side]],(shift[xy]=Math.max(props[0],props[1]))>props[0]&&(pos[side]-=adjust[side],shift[side]=FALSE),css[offset[opposite]!==undefined?opposite:side]=shift[xy])}if(this.enabled){var offset,props,cache=api.cache,newCorner=this.corner.clone(),adjust=pos.adjusted,method=api.options.position.adjust.method.split(" "),horizontal=method[0],vertical=method[1]||method[0],shift={left:FALSE,top:FALSE,x:0,y:0},css={};this.corner.fixed!==TRUE&&(shiftflip(horizontal,X,Y,LEFT,RIGHT),
shiftflip(vertical,Y,X,TOP,BOTTOM),newCorner.string()===cache.corner.string()&&cache.cornerTop===adjust.top&&cache.cornerLeft===adjust.left||this.update(newCorner,FALSE)),offset=this.calculate(newCorner),offset.right!==undefined&&(offset.left=-offset.right),offset.bottom!==undefined&&(offset.top=-offset.bottom),offset.user=this.offset,shift.left=horizontal===SHIFT&&!!adjust.left,shift.left&&shiftonly(X,LEFT,RIGHT),shift.top=vertical===SHIFT&&!!adjust.top,shift.top&&shiftonly(Y,TOP,BOTTOM),this.element.css(css).toggle(!(shift.x&&shift.y||newCorner.x===CENTER&&shift.y||newCorner.y===CENTER&&shift.x)),pos.left-=offset.left.charAt?offset.user:horizontal!==SHIFT||shift.top||!shift.left&&!shift.top?offset.left+this.border:0,
pos.top-=offset.top.charAt?offset.user:vertical!==SHIFT||shift.left||!shift.left&&!shift.top?offset.top+this.border:0,cache.cornerLeft=adjust.left,cache.cornerTop=adjust.top,cache.corner=newCorner.clone()}},destroy:function(){this.qtip._unbind(this.qtip.tooltip,this._ns),this.qtip.elements.tip&&this.qtip.elements.tip.find("*").remove().end().remove()}}),TIP=PLUGINS.tip=function(api){return new Tip(api,api.options.style.tip)},TIP.initialize="render",TIP.sanitize=function(options){if(options.style&&"tip"in options.style){var opts=options.style.tip;"object"!=typeof opts&&(opts=options.style.tip={corner:opts}),/string|boolean/i.test(typeof opts.corner)||(opts.corner=TRUE);
}},CHECKS.tip={"^position.my|style.tip.(corner|mimic|border)$":function(){this.create(),this.qtip.reposition()},"^style.tip.(height|width)$":function(obj){this.size=[obj.width,obj.height],this.update(),this.qtip.reposition()},"^content.title|style.(classes|widget)$":function(){this.update()}},$.extend(TRUE,QTIP.defaults,{style:{tip:{corner:TRUE,mimic:FALSE,width:6,height:6,border:TRUE,offset:0}}});var MODAL,OVERLAY,MODALCLASS="qtip-modal",MODALSELECTOR="."+MODALCLASS;OVERLAY=function(){function focusable(element){if($.expr[":"].focusable)return $.expr[":"].focusable;var map,mapName,img,isTabIndexNotNaN=!isNaN($.attr(element,"tabindex")),nodeName=element.nodeName&&element.nodeName.toLowerCase();
return"area"===nodeName?(map=element.parentNode,mapName=map.name,!(!element.href||!mapName||"map"!==map.nodeName.toLowerCase())&&(img=$("img[usemap=#"+mapName+"]")[0],!!img&&img.is(":visible"))):/input|select|textarea|button|object/.test(nodeName)?!element.disabled:"a"===nodeName?element.href||isTabIndexNotNaN:isTabIndexNotNaN}function focusInputs(blurElems){focusableElems.length<1&&blurElems.length?blurElems.not("body").blur():focusableElems.first().focus()}function stealFocus(event){if(elem.is(":visible")){var targetOnTop,target=$(event.target),tooltip=current.tooltip,container=target.closest(SELECTOR);targetOnTop=container.length<1?FALSE:parseInt(container[0].style.zIndex,10)>parseInt(tooltip[0].style.zIndex,10),
targetOnTop||target.closest(SELECTOR)[0]===tooltip[0]||focusInputs(target)}}var current,prevState,elem,self=this,focusableElems={};$.extend(self,{init:function(){return elem=self.elem=$("<div />",{id:"qtip-overlay",html:"<div></div>",mousedown:function(){return FALSE}}).hide(),$(document.body).bind("focusin"+MODALSELECTOR,stealFocus),$(document).bind("keydown"+MODALSELECTOR,function(event){current&&current.options.show.modal.escape&&27===event.keyCode&&current.hide(event)}),elem.bind("click"+MODALSELECTOR,function(event){current&&current.options.show.modal.blur&&current.hide(event)}),self},update:function(api){current=api,focusableElems=api.options.show.modal.stealfocus!==FALSE?api.tooltip.find("*").filter(function(){
return focusable(this)}):[]},toggle:function(api,state,duration){var tooltip=api.tooltip,options=api.options.show.modal,effect=options.effect,type=state?"show":"hide",visible=elem.is(":visible"),visibleModals=$(MODALSELECTOR).filter(":visible:not(:animated)").not(tooltip);return self.update(api),state&&options.stealfocus!==FALSE&&focusInputs($(":focus")),elem.toggleClass("blurs",options.blur),state&&elem.appendTo(document.body),elem.is(":animated")&&visible===state&&prevState!==FALSE||!state&&visibleModals.length?self:(elem.stop(TRUE,FALSE),$.isFunction(effect)?effect.call(elem,state):effect===FALSE?elem[type]():elem.fadeTo(parseInt(duration,10)||90,state?1:0,function(){
state||elem.hide()}),state||elem.queue(function(next){elem.css({left:"",top:""}),$(MODALSELECTOR).length||elem.detach(),next()}),prevState=state,current.destroyed&&(current=NULL),self)}}),self.init()},OVERLAY=new OVERLAY,$.extend(Modal.prototype,{init:function(qtip){var tooltip=qtip.tooltip;return this.options.on?(qtip.elements.overlay=OVERLAY.elem,tooltip.addClass(MODALCLASS).css("z-index",QTIP.modal_zindex+$(MODALSELECTOR).length),qtip._bind(tooltip,["tooltipshow","tooltiphide"],function(event,api,duration){var oEvent=event.originalEvent;if(event.target===tooltip[0])if(oEvent&&"tooltiphide"===event.type&&/mouse(leave|enter)/.test(oEvent.type)&&$(oEvent.relatedTarget).closest(OVERLAY.elem[0]).length)try{
event.preventDefault()}catch(e){}else(!oEvent||oEvent&&"tooltipsolo"!==oEvent.type)&&this.toggle(event,"tooltipshow"===event.type,duration)},this._ns,this),qtip._bind(tooltip,"tooltipfocus",function(event,api){if(!event.isDefaultPrevented()&&event.target===tooltip[0]){var qtips=$(MODALSELECTOR),newIndex=QTIP.modal_zindex+qtips.length,curIndex=parseInt(tooltip[0].style.zIndex,10);OVERLAY.elem[0].style.zIndex=newIndex-1,qtips.each(function(){this.style.zIndex>curIndex&&(this.style.zIndex-=1)}),qtips.filter("."+CLASS_FOCUS).qtip("blur",event.originalEvent),tooltip.addClass(CLASS_FOCUS)[0].style.zIndex=newIndex,OVERLAY.update(api);try{event.preventDefault()}catch(e){}
}},this._ns,this),void qtip._bind(tooltip,"tooltiphide",function(event){event.target===tooltip[0]&&$(MODALSELECTOR).filter(":visible").not(tooltip).last().qtip("focus",event)},this._ns,this)):this},toggle:function(event,state,duration){return event&&event.isDefaultPrevented()?this:void OVERLAY.toggle(this.qtip,!!state,duration)},destroy:function(){this.qtip.tooltip.removeClass(MODALCLASS),this.qtip._unbind(this.qtip.tooltip,this._ns),OVERLAY.toggle(this.qtip,FALSE),delete this.qtip.elements.overlay}}),MODAL=PLUGINS.modal=function(api){return new Modal(api,api.options.show.modal)},MODAL.sanitize=function(opts){opts.show&&("object"!=typeof opts.show.modal?opts.show.modal={
on:!!opts.show.modal}:"undefined"==typeof opts.show.modal.on&&(opts.show.modal.on=TRUE))},QTIP.modal_zindex=QTIP.zindex-200,MODAL.initialize="render",CHECKS.modal={"^show.modal.(on|blur)$":function(){this.destroy(),this.init(),this.qtip.elems.overlay.toggle(this.qtip.tooltip[0].offsetWidth>0)}},$.extend(TRUE,QTIP.defaults,{show:{modal:{on:FALSE,effect:TRUE,blur:TRUE,stealfocus:TRUE,escape:TRUE}}}),PLUGINS.viewport=function(api,position,posOptions,targetWidth,targetHeight,elemWidth,elemHeight){function calculate(side,otherSide,type,adjustment,side1,side2,lengthName,targetLength,elemLength){var initialPos=position[side1],mySide=my[side],atSide=at[side],isShift=type===SHIFT,myLength=mySide===side1?elemLength:mySide===side2?-elemLength:-elemLength/2,atLength=atSide===side1?targetLength:atSide===side2?-targetLength:-targetLength/2,sideOffset=viewportScroll[side1]+viewportOffset[side1]-(containerStatic?0:containerOffset[side1]),overflow1=sideOffset-initialPos,overflow2=initialPos+elemLength-(lengthName===WIDTH?viewportWidth:viewportHeight)-sideOffset,offset=myLength-(my.precedance===side||mySide===my[otherSide]?atLength:0)-(atSide===CENTER?targetLength/2:0);
return isShift?(offset=(mySide===side1?1:-1)*myLength,position[side1]+=overflow1>0?overflow1:overflow2>0?-overflow2:0,position[side1]=Math.max(-containerOffset[side1]+viewportOffset[side1],initialPos-offset,Math.min(Math.max(-containerOffset[side1]+viewportOffset[side1]+(lengthName===WIDTH?viewportWidth:viewportHeight),initialPos+offset),position[side1],"center"===mySide?initialPos-myLength:1e9))):(adjustment*=type===FLIPINVERT?2:0,overflow1>0&&(mySide!==side1||overflow2>0)?(position[side1]-=offset+adjustment,newMy.invert(side,side1)):overflow2>0&&(mySide!==side2||overflow1>0)&&(position[side1]-=(mySide===CENTER?-offset:offset)+adjustment,newMy.invert(side,side2)),
position[side1]<viewportScroll[side1]&&-position[side1]>overflow2&&(position[side1]=initialPos,newMy=my.clone())),position[side1]-initialPos}var fixed,newMy,containerOffset,containerStatic,viewportWidth,viewportHeight,viewportScroll,viewportOffset,target=posOptions.target,tooltip=api.elements.tooltip,my=posOptions.my,at=posOptions.at,adjust=posOptions.adjust,method=adjust.method.split(" "),methodX=method[0],methodY=method[1]||method[0],viewport=posOptions.viewport,container=posOptions.container,adjusted={left:0,top:0};return viewport.jquery&&target[0]!==window&&target[0]!==document.body&&"none"!==adjust.method?(containerOffset=container.offset()||adjusted,containerStatic="static"===container.css("position"),
fixed="fixed"===tooltip.css("position"),viewportWidth=viewport[0]===window?viewport.width():viewport.outerWidth(FALSE),viewportHeight=viewport[0]===window?viewport.height():viewport.outerHeight(FALSE),viewportScroll={left:fixed?0:viewport.scrollLeft(),top:fixed?0:viewport.scrollTop()},viewportOffset=viewport.offset()||adjusted,"shift"===methodX&&"shift"===methodY||(newMy=my.clone()),adjusted={left:"none"!==methodX?calculate(X,Y,methodX,adjust.x,LEFT,RIGHT,WIDTH,targetWidth,elemWidth):0,top:"none"!==methodY?calculate(Y,X,methodY,adjust.y,TOP,BOTTOM,HEIGHT,targetHeight,elemHeight):0,my:newMy}):adjusted},PLUGINS.polys={polygon:function(baseCoords,corner){var next,newWidth,newHeight,result={
width:0,height:0,position:{top:1e10,right:0,bottom:0,left:1e10},adjustable:FALSE},i=0,coords=[],compareX=1,compareY=1,realX=0,realY=0;for(i=baseCoords.length;i--;)next=[parseInt(baseCoords[--i],10),parseInt(baseCoords[i+1],10)],next[0]>result.position.right&&(result.position.right=next[0]),next[0]<result.position.left&&(result.position.left=next[0]),next[1]>result.position.bottom&&(result.position.bottom=next[1]),next[1]<result.position.top&&(result.position.top=next[1]),coords.push(next);if(newWidth=result.width=Math.abs(result.position.right-result.position.left),newHeight=result.height=Math.abs(result.position.bottom-result.position.top),"c"===corner.abbrev())result.position={
left:result.position.left+result.width/2,top:result.position.top+result.height/2};else{for(;newWidth>0&&newHeight>0&&compareX>0&&compareY>0;)for(newWidth=Math.floor(newWidth/2),newHeight=Math.floor(newHeight/2),corner.x===LEFT?compareX=newWidth:corner.x===RIGHT?compareX=result.width-newWidth:compareX+=Math.floor(newWidth/2),corner.y===TOP?compareY=newHeight:corner.y===BOTTOM?compareY=result.height-newHeight:compareY+=Math.floor(newHeight/2),i=coords.length;i--&&!(coords.length<2);)realX=coords[i][0]-result.position.left,realY=coords[i][1]-result.position.top,(corner.x===LEFT&&realX>=compareX||corner.x===RIGHT&&realX<=compareX||corner.x===CENTER&&(realX<compareX||realX>result.width-compareX)||corner.y===TOP&&realY>=compareY||corner.y===BOTTOM&&realY<=compareY||corner.y===CENTER&&(realY<compareY||realY>result.height-compareY))&&coords.splice(i,1);
result.position={left:coords[0][0],top:coords[0][1]}}return result},rect:function(ax,ay,bx,by){return{width:Math.abs(bx-ax),height:Math.abs(by-ay),position:{left:Math.min(ax,bx),top:Math.min(ay,by)}}},_angles:{tc:1.5,tr:7/4,tl:5/4,bc:.5,br:.25,bl:.75,rc:2,lc:1,c:0},ellipse:function(cx,cy,rx,ry,corner){var c=PLUGINS.polys._angles[corner.abbrev()],rxc=0===c?0:rx*Math.cos(c*Math.PI),rys=ry*Math.sin(c*Math.PI);return{width:2*rx-Math.abs(rxc),height:2*ry-Math.abs(rys),position:{left:cx+rxc,top:cy+rys},adjustable:FALSE}},circle:function(cx,cy,r,corner){return PLUGINS.polys.ellipse(cx,cy,r,r,corner)}},PLUGINS.svg=function(api,svg,corner){for(var frameOffset,mtx,transformed,len,next,i,points,result,position,elem=svg[0],root=$(elem.ownerSVGElement),ownerDocument=elem.ownerDocument,strokeWidth2=(parseInt(svg.css("stroke-width"),10)||0)/2;!elem.getBBox;)elem=elem.parentNode;
if(!elem.getBBox||!elem.parentNode)return FALSE;switch(elem.nodeName){case"ellipse":case"circle":result=PLUGINS.polys.ellipse(elem.cx.baseVal.value,elem.cy.baseVal.value,(elem.rx||elem.r).baseVal.value+strokeWidth2,(elem.ry||elem.r).baseVal.value+strokeWidth2,corner);break;case"line":case"polygon":case"polyline":for(points=elem.points||[{x:elem.x1.baseVal.value,y:elem.y1.baseVal.value},{x:elem.x2.baseVal.value,y:elem.y2.baseVal.value}],result=[],i=-1,len=points.numberOfItems||points.length;++i<len;)next=points.getItem?points.getItem(i):points[i],result.push.apply(result,[next.x,next.y]);result=PLUGINS.polys.polygon(result,corner);break;default:result=elem.getBBox(),
result={width:result.width,height:result.height,position:{left:result.x,top:result.y}}}return position=result.position,root=root[0],root.createSVGPoint&&(mtx=elem.getScreenCTM(),points=root.createSVGPoint(),points.x=position.left,points.y=position.top,transformed=points.matrixTransform(mtx),position.left=transformed.x,position.top=transformed.y),ownerDocument!==document&&"mouse"!==api.position.target&&(frameOffset=$((ownerDocument.defaultView||ownerDocument.parentWindow).frameElement).offset(),frameOffset&&(position.left+=frameOffset.left,position.top+=frameOffset.top)),ownerDocument=$(ownerDocument),position.left+=ownerDocument.scrollLeft(),position.top+=ownerDocument.scrollTop(),
result},PLUGINS.imagemap=function(api,area,corner){area.jquery||(area=$(area));var imageOffset,coords,i,result,len,shape=(area.attr("shape")||"rect").toLowerCase().replace("poly","polygon"),image=$('img[usemap="#'+area.parent("map").attr("name")+'"]'),coordsString=$.trim(area.attr("coords")),coordsArray=coordsString.replace(/,$/,"").split(",");if(!image.length)return FALSE;if("polygon"===shape)result=PLUGINS.polys.polygon(coordsArray,corner);else{if(!PLUGINS.polys[shape])return FALSE;for(i=-1,len=coordsArray.length,coords=[];++i<len;)coords.push(parseInt(coordsArray[i],10));result=PLUGINS.polys[shape].apply(this,coords.concat(corner))}return imageOffset=image.offset(),
imageOffset.left+=Math.ceil((image.outerWidth(FALSE)-image.width())/2),imageOffset.top+=Math.ceil((image.outerHeight(FALSE)-image.height())/2),result.position.left+=imageOffset.left,result.position.top+=imageOffset.top,result};var IE6,BGIFRAME='<iframe class="qtip-bgiframe" frameborder="0" tabindex="-1" src="javascript:\'\';"  style="display:block; position:absolute; z-index:-1; filter:alpha(opacity=0); -ms-filter:"progid:DXImageTransform.Microsoft.Alpha(Opacity=0)";"></iframe>';$.extend(Ie6.prototype,{_scroll:function(){var overlay=this.qtip.elements.overlay;overlay&&(overlay[0].style.top=$(window).scrollTop()+"px")},init:function(qtip){var tooltip=qtip.tooltip;
$("select, object").length<1&&(this.bgiframe=qtip.elements.bgiframe=$(BGIFRAME).appendTo(tooltip),qtip._bind(tooltip,"tooltipmove",this.adjustBGIFrame,this._ns,this)),this.redrawContainer=$("<div/>",{id:NAMESPACE+"-rcontainer"}).appendTo(document.body),qtip.elements.overlay&&qtip.elements.overlay.addClass("qtipmodal-ie6fix")&&(qtip._bind(window,["scroll","resize"],this._scroll,this._ns,this),qtip._bind(tooltip,["tooltipshow"],this._scroll,this._ns,this)),this.redraw()},adjustBGIFrame:function(){var tipAdjust,offset,tooltip=this.qtip.tooltip,dimensions={height:tooltip.outerHeight(FALSE),width:tooltip.outerWidth(FALSE)},plugin=this.qtip.plugins.tip,tip=this.qtip.elements.tip;
offset=parseInt(tooltip.css("borderLeftWidth"),10)||0,offset={left:-offset,top:-offset},plugin&&tip&&(tipAdjust="x"===plugin.corner.precedance?[WIDTH,LEFT]:[HEIGHT,TOP],offset[tipAdjust[1]]-=tip[tipAdjust[0]]()),this.bgiframe.css(offset).css(dimensions)},redraw:function(){if(this.qtip.rendered<1||this.drawing)return this;var perc,width,max,min,tooltip=this.qtip.tooltip,style=this.qtip.options.style,container=this.qtip.options.position.container;return this.qtip.drawing=1,style.height&&tooltip.css(HEIGHT,style.height),style.width?tooltip.css(WIDTH,style.width):(tooltip.css(WIDTH,"").appendTo(this.redrawContainer),width=tooltip.width(),width%2<1&&(width+=1),max=tooltip.css("maxWidth")||"",
min=tooltip.css("minWidth")||"",perc=(max+min).indexOf("%")>-1?container.width()/100:0,max=(max.indexOf("%")>-1?perc:1*parseInt(max,10))||width,min=(min.indexOf("%")>-1?perc:1*parseInt(min,10))||0,width=max+min?Math.min(Math.max(width,min),max):width,tooltip.css(WIDTH,Math.round(width)).appendTo(container)),this.drawing=0,this},destroy:function(){this.bgiframe&&this.bgiframe.remove(),this.qtip._unbind([window,this.qtip.tooltip],this._ns)}}),IE6=PLUGINS.ie6=function(api){return 6===BROWSER.ie?new Ie6(api):FALSE},IE6.initialize="render",CHECKS.ie6={"^content|style$":function(){this.redraw()}}})}(window,document),define("taoQtiItem/portableLib/OAT/util/tooltip",["taoQtiItem/portableLib/jquery_2_1_1","taoQtiItem/portableLib/jquery.qtip"],function($){
"use strict";return{render:function($container){$container.find('[data-role="tooltip-target"]').each(function(){var $content,contentHtml,$target=$(this),contentId=$target.attr("aria-describedBy");contentId&&($content=$container.find("#"+contentId),$content.length&&(contentHtml=$content.html(),$target.qtip({overwrite:!0,theme:"default",content:{text:contentHtml},position:{target:"event",my:"bottom center",at:"top center"}})))})}}}),define("taoQtiItem/portableLib/OAT/util/html",["taoQtiItem/portableLib/OAT/util/xml","taoQtiItem/portableLib/OAT/util/math","taoQtiItem/portableLib/OAT/util/tooltip"],function(xml,math,tooltip){"use strict";return{render:function($container){
var markup=$container.html();markup=xml.removeNamespace(markup),$container.html(markup),math.render($container),tooltip.render($container)}}}),define("SnapForTao/runtime/js/lib/snapsrc",[],function(){"use strict";var panel_Left,stageSaver,worldwatcher,attemptLimit=0,snapsrc={};return snapsrc.snap=function(id,$container,config){function localize(string){return SnapTranslator.translate(string)}function Localizer(language,dict){this.language=language||"en",this.dict=dict||{}}function nop(){return null}function localize(string){var strong;return strong=dicofr[string]?dicofr[string]:string}function isNil(thing){return void 0===thing||null===thing}function contains(list,element){
return list.indexOf(element)!==-1}function detect(list,predicate){var i,size=list.length;for(i=0;i<size;i+=1)if(predicate.call(null,list[i]))return list[i];return null}function sizeOf(object){var key,size=0;for(key in object)Object.prototype.hasOwnProperty.call(object,key)&&(size+=1);return size}function isString(target){return"string"==typeof target||target instanceof String}function isObject(target){return null!==target&&("object"==typeof target||target instanceof Object)}function radians(degrees){return degrees*Math.PI/180}function degrees(radians){return 180*radians/Math.PI}function fontHeight(height){var minHeight=Math.max(height,MorphicPreferences.minimumFontHeight);
return 1.2*minHeight}function isWordChar(aCharacter){return aCharacter.match(/[A-zÀ-ÿ0-9]/)}function newCanvas(extentPoint,nonRetina){var canvas,ext;return ext=extentPoint||{x:0,y:0},canvas=document.createElement("canvas"),canvas.width=ext.x,canvas.height=ext.y,nonRetina&&canvas.isRetinaEnabled&&(canvas.isRetinaEnabled=!0),canvas}function getMinimumFontHeight(){var ctx,maxX,data,x,y,str="I",size=50,canvas=document.createElement("canvas");for(canvas.width=size,canvas.height=size,ctx=canvas.getContext("2d"),ctx.font="1px serif",maxX=ctx.measureText(str).width,ctx.fillStyle="black",ctx.textBaseline="bottom",ctx.fillText(str,0,size),y=0;y<size;y+=1)for(x=0;x<maxX;x+=1)if(data=ctx.getImageData(x,y,1,1),
0!==data.data[3])return size-y+1;return 0}function getBlurredShadowSupport(){var source,target,ctx;return source=document.createElement("canvas"),source.width=10,source.height=10,ctx=source.getContext("2d"),ctx.fillStyle="rgb(255, 0, 0)",ctx.beginPath(),ctx.arc(5,5,5,0,2*Math.PI,!0),ctx.closePath(),ctx.fill(),target=document.createElement("canvas"),target.width=10,target.height=10,ctx=target.getContext("2d"),ctx.shadowBlur=10,ctx.shadowColor="rgba(0, 0, 255, 1)",ctx.drawImage(source,0,0),!!ctx.getImageData(0,0,1,1).data[3]}function getDocumentPositionOf(aDOMelement){var pos,offsetParent;if(null===aDOMelement)return{x:0,y:0};for(pos={x:aDOMelement.offsetLeft,y:aDOMelement.offsetTop
},offsetParent=aDOMelement.offsetParent;null!==offsetParent;)pos.x+=offsetParent.offsetLeft,pos.y+=offsetParent.offsetTop,offsetParent!==document.body&&offsetParent!==document.documentElement&&(pos.x-=offsetParent.scrollLeft,pos.y-=offsetParent.scrollTop),offsetParent=offsetParent.offsetParent;return pos}function copy(target){var value,c,property,keys,l,i;if("object"!=typeof target)return target;if(value=target.valueOf(),target!==value)return new target.constructor(value);if(target instanceof target.constructor&&target.constructor!==Object)for(c=Object.create(target.constructor.prototype),keys=Object.keys(target),l=keys.length,i=0;i<l;i+=1)property=keys[i],c[property]=target[property];else{
c={};for(property in target)c[property]=target[property]}return c}function enableRetinaSupport(){function getPixelRatio(imageSource){return imageSource.isRetinaEnabled?(originalDevicePixelRatio||1)/backingStorePixelRatio:1}var ctx=document.createElement("canvas").getContext("2d"),backingStorePixelRatio=ctx.webkitBackingStorePixelRatio||ctx.mozBackingStorePixelRatio||ctx.msBackingStorePixelRatio||ctx.oBackingStorePixelRatio||ctx.backingStorePixelRatio||1,originalDevicePixelRatio=Math.ceil(window.devicePixelRatio),canvasProto=HTMLCanvasElement.prototype,contextProto=CanvasRenderingContext2D.prototype,uber={drawImage:contextProto.drawImage,getImageData:contextProto.getImageData,
width:Object.getOwnPropertyDescriptor(canvasProto,"width"),height:Object.getOwnPropertyDescriptor(canvasProto,"height"),shadowOffsetX:Object.getOwnPropertyDescriptor(contextProto,"shadowOffsetX"),shadowOffsetY:Object.getOwnPropertyDescriptor(contextProto,"shadowOffsetY"),shadowBlur:Object.getOwnPropertyDescriptor(contextProto,"shadowBlur")};backingStorePixelRatio!==originalDevicePixelRatio&&(Object.keys(uber).some(function(any){var prop=uber[any];return prop.hasOwnProperty("configurable")&&!prop.configurable})||(canvasProto._isRetinaEnabled=!0,canvasProto._bak=uber,Object.defineProperty(canvasProto,"isRetinaEnabled",{get:function(){return this._isRetinaEnabled;
},set:function(enabled){var prevPixelRatio=getPixelRatio(this),prevWidth=this.width,prevHeight=this.height;this._isRetinaEnabled=enabled,getPixelRatio(this)!=prevPixelRatio&&(this.width=prevWidth,this.height=prevHeight)},configurable:!0}),Object.defineProperty(canvasProto,"width",{get:function(){return uber.width.get.call(this)/getPixelRatio(this)},set:function(width){try{var context,pixelRatio=getPixelRatio(this);uber.width.set.call(this,width*pixelRatio),context=this.getContext("2d"),context.restore(),context.save(),context.scale(pixelRatio,pixelRatio)}catch(err){console.log("Retina Display Support Problem",err),uber.width.set.call(this,width)}}}),Object.defineProperty(canvasProto,"height",{
get:function(){return uber.height.get.call(this)/getPixelRatio(this)},set:function(height){var context,pixelRatio=getPixelRatio(this);uber.height.set.call(this,height*pixelRatio),context=this.getContext("2d"),context.restore(),context.save(),context.scale(pixelRatio,pixelRatio)}}),contextProto.drawImage=function(image){var sx,sy,sWidth,sHeight,dx,dy,dWidth,dHeight,pixelRatio=getPixelRatio(image);switch(arguments.length){case 9:sx=arguments[1],sy=arguments[2],sWidth=arguments[3],sHeight=arguments[4],dx=arguments[5],dy=arguments[6],dWidth=arguments[7],dHeight=arguments[8];break;case 5:sx=0,sy=0,sWidth=image.width,sHeight=image.height,dx=arguments[1],dy=arguments[2],
dWidth=arguments[3],dHeight=arguments[4];break;case 3:sx=0,sy=0,sWidth=image.width,sHeight=image.height,dx=arguments[1],dy=arguments[2],dWidth=image.width,dHeight=image.height;break;default:throw Error("Called drawImage() with "+arguments.length+" arguments")}uber.drawImage.call(this,image,sx*pixelRatio,sy*pixelRatio,sWidth*pixelRatio,sHeight*pixelRatio,dx,dy,dWidth,dHeight)},contextProto.getImageData=function(sx,sy,sw,sh){var pixelRatio=getPixelRatio(this.canvas);return uber.getImageData.call(this,sx*pixelRatio,sy*pixelRatio,sw*pixelRatio,sh*pixelRatio)},Object.defineProperty(contextProto,"shadowOffsetX",{get:function(){return uber.shadowOffsetX.get.call(this)/getPixelRatio(this.canvas);
},set:function(offset){var pixelRatio=getPixelRatio(this.canvas);uber.shadowOffsetX.set.call(this,offset*pixelRatio)}}),Object.defineProperty(contextProto,"shadowOffsetY",{get:function(){return uber.shadowOffsetY.get.call(this)/getPixelRatio(this.canvas)},set:function(offset){var pixelRatio=getPixelRatio(this.canvas);uber.shadowOffsetY.set.call(this,offset*pixelRatio)}}),Object.defineProperty(contextProto,"shadowBlur",{get:function(){return uber.shadowBlur.get.call(this)/getPixelRatio(this.canvas)},set:function(blur){var pixelRatio=getPixelRatio(this.canvas);uber.shadowBlur.set.call(this,blur*pixelRatio)}})))}function isRetinaSupported(){var ctx=document.createElement("canvas").getContext("2d"),backingStorePixelRatio=ctx.webkitBackingStorePixelRatio||ctx.mozBackingStorePixelRatio||ctx.msBackingStorePixelRatio||ctx.oBackingStorePixelRatio||ctx.backingStorePixelRatio||1,canvasProto=HTMLCanvasElement.prototype,contextProto=CanvasRenderingContext2D.prototype,uber={
drawImage:contextProto.drawImage,getImageData:contextProto.getImageData,width:Object.getOwnPropertyDescriptor(canvasProto,"width"),height:Object.getOwnPropertyDescriptor(canvasProto,"height"),shadowOffsetX:Object.getOwnPropertyDescriptor(contextProto,"shadowOffsetX"),shadowOffsetY:Object.getOwnPropertyDescriptor(contextProto,"shadowOffsetY"),shadowBlur:Object.getOwnPropertyDescriptor(contextProto,"shadowBlur")};return backingStorePixelRatio!==window.devicePixelRatio&&!Object.keys(uber).some(function(any){var prop=uber[any];return prop.hasOwnProperty("configurable")&&!prop.configurable})}function isRetinaEnabled(){return HTMLCanvasElement.prototype.hasOwnProperty("_isRetinaEnabled");
}function disableRetinaSupport(){var canvasProto,contextProto,uber;isRetinaEnabled()&&(canvasProto=HTMLCanvasElement.prototype,contextProto=CanvasRenderingContext2D.prototype,uber=canvasProto._bak,Object.defineProperty(canvasProto,"width",uber.width),Object.defineProperty(canvasProto,"height",uber.height),contextProto.drawImage=uber.drawImage,contextProto.getImageData=uber.getImageData,Object.defineProperty(contextProto,"shadowOffsetX",uber.shadowOffsetX),Object.defineProperty(contextProto,"shadowOffsetY",uber.shadowOffsetY),Object.defineProperty(contextProto,"shadowBlur",uber.shadowBlur),delete canvasProto._isRetinaEnabled,delete canvasProto.isRetinaEnabled,
delete canvasProto._bak)}function normalizeCanvas(aCanvas,getCopy){var cpy;return aCanvas.isRetinaEnabled?(cpy=newCanvas(new Point(aCanvas.width,aCanvas.height),!0),cpy.getContext("2d").drawImage(aCanvas,0,0),getCopy?cpy:(aCanvas.isRetinaEnabled=!1,aCanvas.width=cpy.width,aCanvas.height=cpy.height,aCanvas.getContext("2d").drawImage(cpy,0,0),aCanvas)):aCanvas}function Animation(setter,getter,delta,duration,easing,onComplete){this.setter=setter,this.getter=getter,this.delta=delta||0,this.duration=duration||0,this.easing=isString(easing)?this.easings[easing]||this.easings.sinusoidal:easing||this.easings.sinusoidal,this.onComplete=onComplete||null,this.endTime=null,
this.destination=null,this.isActive=!1,this.start()}function Color(r,g,b,a){this.r=r||0,this.g=g||0,this.b=b||0,this.a=a||(0===a?0:1)}function Point(x,y){this.x=x||0,this.y=y||0}function Rectangle(left,top,right,bottom){this.init(new Point(left||0,top||0),new Point(right||0,bottom||0))}function Node(parent,childrenArray){this.init(parent||null,childrenArray||[])}function Morph(){this.init()}function ShadowMorph(){this.init()}function HandleMorph(target,minX,minY,insetX,insetY,type){this.init(target,minX,minY,insetX,insetY,type)}function PenMorph(){this.init()}function ColorPaletteMorph(target,sizePoint){this.init(target||null,sizePoint||new Point(80,50))}function GrayPaletteMorph(target,sizePoint){
this.init(target||null,sizePoint||new Point(80,10))}function ColorPickerMorph(defaultColor){this.init(defaultColor||new Color(255,255,255))}function BlinkerMorph(rate){this.init(rate)}function CursorMorph(aStringOrTextMorph){this.init(aStringOrTextMorph)}function BoxMorph(edge,border,borderColor){this.init(edge,border,borderColor)}function SpeechBubbleMorph(contents,color,edge,border,borderColor,padding,isThought){this.init(contents,color,edge,border,borderColor,padding,isThought)}function CircleBoxMorph(orientation){this.init(orientation||"vertical")}function SliderButtonMorph(orientation){this.init(orientation)}function SliderMorph(start,stop,value,size,orientation,color){
this.init(start||1,stop||100,value||50,size||10,orientation||"vertical",color)}function MouseSensorMorph(edge,border,borderColor){this.init(edge,border,borderColor)}function InspectorMorph(target){this.init(target)}function MenuMorph(target,title,environment,fontSize){this.init(target,title,environment,fontSize)}function StringMorph(text,fontSize,fontStyle,bold,italic,isNumeric,shadowOffset,shadowColor,color,fontName){this.init(text,fontSize,fontStyle,bold,italic,isNumeric,shadowOffset,shadowColor,color,fontName)}function TextMorph(text,fontSize,fontStyle,bold,italic,alignment,width,fontName,shadowOffset,shadowColor){this.init(text,fontSize,fontStyle,bold,italic,alignment,width,fontName,shadowOffset,shadowColor);
}function TriggerMorph(target,action,labelString,fontSize,fontStyle,environment,hint,labelColor,labelBold,labelItalic,doubleClickAction){this.init(target,action,labelString,fontSize,fontStyle,environment,hint,labelColor,labelBold,labelItalic,doubleClickAction)}function MenuItemMorph(target,action,labelString,fontSize,fontStyle,environment,hint,color,bold,italic,doubleClickAction,shortcut){this.shortcutString=shortcut||null,this.shortcut=null,this.init(target,action,labelString,fontSize,fontStyle,environment,hint,color,bold,italic,doubleClickAction)}function FrameMorph(aScrollFrame){this.init(aScrollFrame)}function ScrollFrameMorph(scroller,size,sliderColor){this.init(scroller,size,sliderColor);
}function ListMorph(elements,labelGetter,format,doubleClickAction){this.init(elements||[],labelGetter||function(element){return isString(element)?element:element.toSource?element.toSource():element.toString()},format||[],doubleClickAction)}function StringFieldMorph(defaultContents,minWidth,fontSize,fontStyle,bold,italic,isNumeric){this.init(defaultContents||"",minWidth||100,fontSize||12,fontStyle||"sans-serif",bold||!1,italic||!1,isNumeric)}function BouncerMorph(){this.init()}function HandMorph(aWorld){this.init(aWorld)}function WorldMorph(aCanvas,fillPage){this.init(aCanvas,fillPage)}function PushButtonMorph(target,action,labelString,environment,hint,template){
this.init(target,action,labelString,environment,hint,template)}function ToggleButtonMorph(colors,target,action,labelString,query,environment,hint,template,minWidth,hasPreview,isPicture){this.init(colors,target,action,labelString,query,environment,hint,template,minWidth,hasPreview,isPicture)}function TabMorph(colors,target,action,labelString,query,environment,hint){this.init(colors,target,action,labelString,query,environment,hint)}function ToggleMorph(style,target,action,labelString,query,environment,hint,template,element,builder){this.init(style,target,action,labelString,query,environment,hint,template,element,builder)}function ToggleElementMorph(target,action,element,query,environment,hint,builder,labelString){
this.init(target,action,element,query,environment,hint,builder,labelString)}function DialogBoxMorph(target,action,environment){this.init(target,action,environment)}function AlignmentMorph(orientation,padding){this.init(orientation,padding)}function InputFieldMorph(text,isNumeric,choiceDict,isReadOnly){this.init(text,isNumeric,choiceDict,isReadOnly)}function PianoMenuMorph(target,environment,fontSize,soundType){this.init(target,environment,fontSize,soundType)}function PianoKeyMorph(target,action,labelString,fontSize,fontStyle,environment,hint,color,bold,italic,doubleClickAction,label){this.init(target,action,labelString,fontSize,fontStyle,environment,hint,color,bold,italic,doubleClickAction,label),
this.feedback=label}function SyntaxElementMorph(){this.init()}function BlockMorph(){this.init()}function CommandBlockMorph(){this.init()}function HatBlockMorph(){this.init()}function ReporterBlockMorph(isPredicate){this.init(isPredicate)}function RingMorph(){this.init()}function ScriptsMorph(){this.init()}function ArgMorph(type){this.init(type)}function CommandSlotMorph(){this.init()}function RingCommandSlotMorph(){this.init()}function CSlotMorph(){this.init()}function InputSlotMorph(text,isNumeric,choiceDict,isReadOnly){this.init(text,isNumeric,choiceDict,isReadOnly)}function TemplateSlotMorph(name){this.init(name)}function BooleanSlotMorph(initialValue){this.init(initialValue);
}function ArrowMorph(direction,size,padding,color){this.init(direction,size,padding,color)}function TextSlotMorph(text,isNumeric,choiceDict,isReadOnly){this.init(text,isNumeric,choiceDict,isReadOnly)}function ColorSlotMorph(clr){this.init(clr)}function BlockHighlightMorph(){this.threadCount=0,this.init()}function MultiArgMorph(slotSpec,labelTxt,min,eSpec,arrowColor,labelColor,shadowColor,shadowOffset,isTransparent){this.init(slotSpec,labelTxt,min,eSpec,arrowColor,labelColor,shadowColor,shadowOffset,isTransparent)}function ArgLabelMorph(argMorph,labelTxt){this.init(argMorph,labelTxt)}function FunctionSlotMorph(isPredicate){this.init(isPredicate)}function ReporterSlotMorph(isPredicate){
this.init(isPredicate)}function RingReporterSlotMorph(isPredicate){this.init(isPredicate)}function CommentMorph(contents){this.init(contents)}function ScriptFocusMorph(editor,initialElement,position){this.init(editor,initialElement,position)}function snapEquals(a,b){if(a instanceof List||b instanceof List)return a instanceof List&&b instanceof List&&a.equalTo(b);var i,x=+a,y=+b,specials=[!0,!1,""];for(i=9;i<=13;i+=1)specials.push(String.fromCharCode(i));return specials.push(String.fromCharCode(160)),(isNaN(x)||isNaN(y)||[a,b].some(function(any){return contains(specials,any)||isString(any)&&any.indexOf(" ")>-1}))&&(x=a,y=b),isString(x)&&isString(y)?x.toLowerCase()===y.toLowerCase():x===y;
}function invoke(action,contextArgs,receiver,timeout,timeoutErrorMsg,suppressErrors){var proc=new Process,deadline=timeout?Date.now()+timeout:null;if(action instanceof Context)receiver&&(action=proc.reportContextFor(receiver)),proc.initializeFor(action,contextArgs||new List);else{if(!(action instanceof BlockMorph)){if(action.evaluate)return action.evaluate();throw new Error("expecting a block or ring but getting "+action)}if(proc.topBlock=action,!receiver)throw new Error("expecting a receiver but getting "+receiver);proc.homeContext=new Context,proc.homeContext.receiver=receiver,receiver.variables&&(proc.homeContext.variables.parentFrame=receiver.variables),proc.context=new Context(null,action.blockSequence(),proc.homeContext);
}for(suppressErrors&&(proc.isCatchingErrors=!1);proc.isRunning();){if(deadline&&Date.now()>deadline)throw new Error(localize(timeoutErrorMsg||"a synchronous Snap! script has timed out"));proc.runStep(deadline)}return proc.homeContext.inputs[0]}function ThreadManager(){this.processes=[],this.wantsToPause=!1}function compteur(){compteurGo++,$container.find(".compteur").html(";Nombre de tentatives : "+compteurGo);var nbTry=config.testLimiter-compteurGo;nbTry>1&&(world.children[0].projectName=" ATTENTION : Il vous reste "+nbTry+" tentatives !"),1==nbTry&&(world.children[0].projectName=" ATTENTION DERNIERE TENTATIVE !"),world.children[0].controlBar.updateLabel(),compteurGo>=config.testLimiter&&0!=config.testLimiter&&($container.find(".snapy").append("<div class='bg_try_stop'></div"),
$container.find(".snapy").append("<div class='txt_try_stop'>Nombre d'essais maximum atteint. Soumettez votre réponse pour continuer.</div>"),$container.find(".world").hide())}function Process(topBlock,receiver,onComplete,yieldFirst){this.topBlock=topBlock||null,this.receiver=receiver,this.instrument=receiver?receiver.instrument:null,this.readyToYield=!1,this.readyToTerminate=!1,this.isDead=!1,this.isClicked=!1,this.isShowingResult=!1,this.errorFlag=!1,this.context=null,this.homeContext=new Context(null,null,null,receiver),this.lastYield=Date.now(),this.isFirstStep=!0,this.isAtomic=!1,this.prompter=null,this.httpRequest=null,this.isPaused=!1,this.pauseOffset=null,
this.frameCount=0,this.exportResult=!1,this.onComplete=onComplete||null,this.procedureCount=0,this.flashingContext=null,this.isInterrupted=!1,topBlock&&(this.homeContext.variables.parentFrame=this.homeContext.receiver.variables,this.context=new Context(null,topBlock.blockSequence(),this.homeContext),yieldFirst&&this.pushContext("doYield"))}function Context(parentContext,expression,outerContext,receiver){this.outerContext=outerContext||null,this.parentContext=parentContext||null,this.expression=expression||null,this.receiver=receiver||null,this.origin=receiver||null,this.variables=new VariableFrame,this.outerContext&&(this.variables.parentFrame=this.outerContext.variables,
this.receiver=this.outerContext.receiver),this.inputs=[],this.pc=0,this.isContinuation=!1,this.startTime=null,this.activeAudio=null,this.activeNote=null,this.isCustomBlock=!1,this.emptySlots=0,this.tag=null,this.isFlashing=!1}function Variable(value,isTransient){this.value=value,this.isTransient=isTransient||!1}function VariableFrame(parentFrame,owner){this.vars={},this.parentFrame=parentFrame||null,this.owner=owner||null}function isSnapObject(thing){return thing instanceof SpriteMorph||thing instanceof StageMorph}function SpriteMorph(globals){this.init(globals)}function SpriteHighlightMorph(){this.init()}function StageMorph(globals){this.init(globals)}function SpriteBubbleMorph(data,stage,isThought,isQuestion){
this.init(data,stage,isThought,isQuestion)}function Costume(canvas,name,rotationCenter){this.contents=canvas?normalizeCanvas(canvas,!0):newCanvas(null,!0),this.shrinkToFit(this.maxExtent()),this.name=name||null,this.rotationCenter=rotationCenter||this.center(),this.version=Date.now(),this.loaded=null}function SVG_Costume(svgImage,name,rotationCenter){this.contents=svgImage,this.shrinkToFit(this.maxExtent()),this.name=name||null,this.rotationCenter=rotationCenter||this.center(),this.version=Date.now(),this.loaded=null}function CostumeEditorMorph(costume){this.init(costume)}function Sound(audio,name){this.audio=audio,this.name=name||"Sound"}function Note(pitch){
this.pitch=0===pitch?0:pitch||69,this.setupContext(),this.oscillator=null}function CellMorph(contents,color,idx,parentCell){this.init(contents,color,idx,parentCell)}function WatcherMorph(label,color,target,getter,isHidden){this.init(label,color,target,getter,isHidden)}function StagePrompterMorph(question){this.init(question)}function IDE_Morph(isAutoFill){this.init(isAutoFill)}function ProjectDialogMorph(ide,label){this.init(ide,label)}function LibraryImportDialogMorph(ide,librariesData){this.init(ide,librariesData)}function SpriteIconMorph(aSprite,aTemplate){this.init(aSprite,aTemplate)}function CostumeIconMorph(aCostume,aTemplate){this.init(aCostume,aTemplate);
}function TurtleIconMorph(aSpriteOrStage,aTemplate){this.init(aSpriteOrStage,aTemplate)}function WardrobeMorph(aSprite,sliderColor){this.init(aSprite,sliderColor)}function SoundIconMorph(aSound,aTemplate){this.init(aSound,aTemplate)}function JukeboxMorph(aSprite,sliderColor){this.init(aSprite,sliderColor)}function StageHandleMorph(target){this.init(target)}function PaletteHandleMorph(target){this.init(target)}function CamSnapshotDialogMorph(ide,sprite,onCancel,onAccept){this.init(ide,sprite,onCancel,onAccept)}function PaintEditorMorph(){this.init()}function PaintColorPickerMorph(extent,action){this.init(extent,action)}function PaintCanvasMorph(shift){this.init(shift);
}function List(array){this.type=null,this.contents=array||[],this.first=null,this.rest=null,this.isLinked=!1,this.lastChanged=Date.now()}function ListWatcherMorph(list,parentCell){this.init(list,parentCell)}function CustomBlockDefinition(spec,receiver){this.body=null,this.scripts=[],this.category=null,this.isGlobal=!1,this.type="command",this.spec=spec||"",this.declarations={},this.variableNames=[],this.comment=null,this.codeMapping=null,this.codeHeader=null,this.translations={},this.receiver=receiver||null,this.editorDimensions=null,this.cachedIsRecursive=null,this.cachedTranslation=null}function CustomCommandBlockMorph(definition,isProto){this.init(definition,isProto);
}function CustomReporterBlockMorph(definition,isPredicate,isProto){this.init(definition,isPredicate,isProto)}function JaggedBlockMorph(spec){this.init(spec)}function BlockDialogMorph(target,action,environment){this.init(target,action,environment)}function BlockEditorMorph(definition,target){this.init(definition,target)}function PrototypeHatBlockMorph(definition){this.init(definition)}function BlockLabelFragment(labelString){this.labelString=labelString||"",this.type="%s",this.defaultValue="",this.options="",this.isReadOnly=!1,this.isDeleted=!1}function BlockLabelFragmentMorph(text){this.init(text)}function BlockLabelPlaceHolderMorph(){this.init()}function BlockInputFragmentMorph(text){
this.init(text)}function InputSlotDialogMorph(fragment,target,action,environment,category){this.init(fragment,target,action,environment,category)}function VariableDialogMorph(target,action,environment){this.init(target,action,environment)}function BlockExportDialogMorph(serializer,blocks){this.init(serializer,blocks)}function BlockImportDialogMorph(blocks,target,name){this.init(blocks,target,name)}function BlockRemovalDialogMorph(blocks,target){this.init(blocks,target)}function Table(cols,rows){this.colCount=+cols,this.rowCount=+rows,this.colNames=[],this.rowNames=[],this.contents=new Array(+rows);for(var i=0;i<rows;i+=1)this.contents[i]=new Array(+cols);this.lastChanged=Date.now();
}function TableCellMorph(data,extent,isLabel){this.init(data,extent,isLabel)}function TableMorph(table,scrollBarSize,extent,startRow,startCol,globalColWidth,colWidths,rowHeight,colLabelHeight,padding){this.init(table,scrollBarSize,extent,startRow,startCol,globalColWidth,colWidths,rowHeight,colLabelHeight,padding)}function TableFrameMorph(tableMorph,noResize){this.init(tableMorph,noResize)}function TableDialogMorph(data,globalColWidth,colWidths,rowHeight){this.init(data,globalColWidth,colWidths,rowHeight)}function SymbolMorph(name,size,color,shadowOffset,shadowColor){this.init(name,size,color,shadowOffset,shadowColor)}function ReadStream(arrayOrString){this.contents=arrayOrString||"",
this.index=0}function XML_Element(tag,contents,parent){this.init(tag,contents,parent)}function XML_Serializer(){this.contents=[],this.media=[],this.isCollectingMedia=!1,this.isExportingBlocksLibrary=!1}function SnapSerializer(){this.init()}function Cloud(url){this.username=null,this.password=null,this.url=url,this.session=null,this.limo=null,this.route=null,this.api={}}function loop(){requestAnimationFrame(loop),world.doOneCycle()}var Localizer,SnapTranslator=new Localizer,importString="",getSnapProjectScript="scriptPlaceHolder";importString="shield"==config.snapScript?"":config.snapScript,Localizer.prototype.translate=function(string){return Object.prototype.hasOwnProperty.call(this.dict[this.language],string)?this.dict[this.language][string]:string;
},Localizer.prototype.languages=function(){var property,arr=[];for(property in this.dict)Object.prototype.hasOwnProperty.call(this.dict,property)&&arr.push(property);return arr.sort()},Localizer.prototype.languageName=function(lang){return this.dict[lang].language_name||lang},Localizer.prototype.credits=function(){var txt="",myself=this;return this.languages().forEach(function(lang){txt=txt+"\n"+myself.languageName(lang)+" ("+lang+") - "+myself.dict[lang].language_translator+" - "+myself.dict[lang].last_changed}),txt},Localizer.prototype.unload=function(){var dict,keep=["language_name","language_translator","last_changed"],myself=this;this.languages().forEach(function(lang){
var key;if("en"!==lang){dict=myself.dict[lang];for(key in dict)Object.prototype.hasOwnProperty.call(dict,key)&&!contains(keep,key)&&delete dict[key]}})},SnapTranslator.dict.en={language_name:"English",language_translator:"Jens Mönig","translator_e-mail":"jens@moenig.org",last_changed:"2015-12-22",any:"random","file menu import hint":"load an exported project file\nor block library, a costume\nor a sound","settings menu prefer empty slots hint":"check to focus on empty slots\nwhen dragging & dropping reporters","costumes tab help":"import a picture from another web page or from\na file on your computer by dropping it here\n","block deletion dialog text":"Are you sure you want to delete this\ncustom block and all its instances?",
"download to disk text":"This item could not be opened in a new tab.\nIt has been saved to your browser's downloads folder.","unable to export text":"This item could not be exported from Snap!.\nIt's likely that your project may contain a lot of media (sounds and images) or that you are using an older browser.Please try using a recent version of Chrome, Firefox, or Safari."},SnapTranslator.dict.fr={language_name:"Français",language_translator:"Jean-Jacques Valliet, Mark Rafter, Martin Quinson, Damien Caselli","translator_e-mail":"i.scool@mac.com",last_changed:"2016-10-27"};var morphicVersion="2017-September-26",modules={},useBlurredShadows=getBlurredShadowSupport(),standardSettings={
minimumFontHeight:getMinimumFontHeight(),globalFontFamily:"",menuFontName:"sans-serif",menuFontSize:12,bubbleHelpFontSize:10,prompterFontName:"sans-serif",prompterFontSize:12,prompterSliderSize:10,handleSize:15,scrollBarSize:12,mouseScrollAmount:40,useSliderForInput:!1,useVirtualKeyboard:!0,isTouchDevice:!1,rasterizeSVGs:!1,isFlat:!1,grabThreshold:5},touchScreenSettings={minimumFontHeight:standardSettings.minimumFontHeight,globalFontFamily:"",menuFontName:"sans-serif",menuFontSize:24,bubbleHelpFontSize:18,prompterFontName:"sans-serif",prompterFontSize:24,prompterSliderSize:20,handleSize:26,scrollBarSize:24,mouseScrollAmount:40,useSliderForInput:!0,useVirtualKeyboard:!0,
isTouchDevice:!1,rasterizeSVGs:!1,isFlat:!1,grabThreshold:5},MorphicPreferences=standardSettings;enableRetinaSupport();var dicofr={language_name:"Français",language_translator:"Jean-Jacques Valliet, Mark Rafter, Martin Quinson, Damien Caselli","translator_e-mail":"i.scool@mac.com",last_changed:"2016-10-27",untitled:"Sans Titre","development mode":"mode développeur",Motion:"Mouvement",Looks:"Apparence",Sound:"Sons",Pen:"Stylo",Control:"Contrôles",Sensing:"Capteurs",Operators:"Opérateurs",Variables:"Variables",Lists:"Listes",Other:"Autres",draggable:"déplaçable avec la souris",Scripts:"Scripts",Costumes:"Costumes",Sounds:"Sons",Sprite:"Lutin",Stage:"Scène","don't rotate":"le lutin ne pivote jamais",
"can rotate":"le lutin pivote \nautour de son centre de rotation","only face left/right":"le lutin reste en position horizontale \nsoit vers la gauche soit vers la droite ","add a new sprite":"ajouter un nouveau lutin","add a new Turtle sprite":"ajouter un nouveau lutin Tortue","costumes tab help":"Importer une image depuis votre ordinateur ou une page web \npar un presser-glisser-déposer dans l'aire des costumes","import a sound from your computer\nby dragging it into here":"Importer un son depuis votre ordinateur \npar un presser-glisser-déposer dans l'aire des sons","Stage selected:\nno motion primitives":"Scène sélectionnée :\naucune brique de déplaçement",
"move %n steps":"avancer de %n pas","turn %clockwise %n degrees":"tourner de %n degrés %clockwise","turn %counterclockwise %n degrees":"tourner de %n degrés %counterclockwise","point in direction %dir":"se diriger en faisant un angle de %dir","point towards %dst":"se diriger vers %dst","go to x: %n y: %n":"aller à x: %n y: %n","go to %dst":"aller à %dst","glide %n secs to x: %n y: %n":"glisser en %n sec. à x: %n y: %n","change x by %n":"ajouter %n à x","set x to %n":"donner la valeur %n à x","change y by %n":"ajouter %n à y","set y to %n":"donner la valeur %n à y","if on edge, bounce":"rebondir si le bord est atteint","x position":"position x","y position":"position y",
direction:"direction","switch to costume %cst":"basculer sur le costume %cst","next costume":"costume suivant","costume #":"costume n°","say %s for %n secs":"dire %s pendant %n sec.","say %s":"dire %s","think %s for %n secs":"penser %s pendant %n sec.","think %s":"penser %s","Hello!":"Salut !","Hmm...":"Mmmh...","change %eff effect by %n":"ajouter à l'effet %eff %n","set %eff effect to %n":"mettre l'effet %eff à %n","clear graphic effects":"annuler les effets graphiques","change size by %n":"ajouter %n à la taille","set size to %n %":"choisir %n % de la taille initiale",size:"taille",show:"montrer",hide:"cacher","go to front":"envoyer au premier plan","go back %n layers":"déplacer de %n plan arrière",
"development mode \ndebugging primitives:":"mode développement \ndebugging primitives:","console log %mult%s":"console log %mult%s","alert %mult%s":"Pop-up: %mult%s","play sound %snd":"jouer le son %snd","play sound %snd until done":"jouer le son %snd jusqu'au bout","stop all sounds":"arrêter tous les sons","rest for %n beats":"faire une pause pour %n temps","play note %n for %n beats":"jouer la note %n pour %n temps","change tempo by %n":"ajouter %n au tempo","set tempo to %n bpm":"choisir le tempo à %n bpm",tempo:"tempo",clear:"effacer tout","pen down":"stylo en position d'écriture","pen up":"relever le stylo","set pen color to %clr":"mettre la couleur %clr pour le stylo",
"change pen color by %n":"ajouter %n à la couleur du stylo","set pen color to %n":"choisir la couleur %n pour le stylo","change pen shade by %n":"ajouter %n à l'intensité du stylo ","set pen shade to %n":"choisir l'intensité %n pour le stylo","change pen size by %n":"ajouter %n à la taille du stylo ","set pen size to %n":"choisir la taille %n pour le stylo",stamp:"estampiller",fill:"remplir","when %greenflag clicked":"Quand %greenflag est pressé","when %keyHat key pressed":"Quand %keyHat est pressé","when I am clicked":"Quand je suis pressé ","when I am %interaction":"Quand je suis %interaction","when I receive %msgHat":"Quand je reçois %msgHat","broadcast %msg":"envoyer à tous %msg",
"broadcast %msg and wait":"envoyer à tous %msg et attendre","Message name":"Nom du message","wait %n secs":"attendre %n sec.","wait until %b":"attendre jusqu'à %b","forever %c":"répéter indéfiniment %c","repeat %n %c":"répéter %n fois %c","repeat until %b %c":"répéter jusqu'à %b %c","if %b %c":"si %b %c","if %b %c else %c":"si %b %c sinon %c","report %s":"rapporte %s","stop block":"arrêter le bloc","stop script":"arrêter le script","stop %stopOthersChoices":"arrêter %stopOthersChoices","stop %stopChoices":"arrêter %stopChoices","stop all %stop":"arrêter tout %stop","run %cmdRing %inputs":"exécute %cmdRing  %inputs","launch %cmdRing %inputs":"lance %cmdRing %inputs",
"call %repRing %inputs":"appelle %repRing %inputs","run %cmdRing w/continuation":"exécute %cmdRing avec continuation","call %cmdRing w/continuation":"appelle %cmdRing avec continuation","warp %c":"Englobe %c","when I start as a clone":"Quand je commence comme clone","create a clone of %cln":"Clone %cln",myself:"moi-même","delete this clone":"supprime ce clone","pause all %pause":"mettre en pause %pause","all but this script":"tout sauf ce script","other scripts in sprite":"les autres scripts de ce lutin","this script":"ce script","this block":"ce bloc","touching %col ?":"%col touché ?","touching %clr ?":"couleur %clr touchée ?","color %clr is touching %clr ?":"couleur %clr touche %clr ?",
"ask %s and wait":"demander %s et attendre","what's your name?":"Quel est ton nom ?",answer:"réponse","mouse x":"souris x","mouse y":"souris y","mouse down?":"souris pressée ?","key %key pressed?":"touche %key pressée ?","distance to %dst":"distance de %dst","reset timer":"réinitialiser le chronomètre",timer:"chronomètre","%att of %spr":"%att de %spr","my %get":"attribut %get","http:// %s":"http:// %s","turbo mode?":"turbo mode activé ?","set turbo mode to %b":"turbo mode prend la valeur %b","filtered for %clr":"filtré pour %clr","stack size":"taille de la pile",frames:"cadres","%n mod %n":"%n mod %n","round %n":"arrondi de %n","%fun of %n":"%fun appliqué à %n",
"pick random %n to %n":"nombre aléatoire entre %n et %n","%b and %b":"%b et %b","%b or %b":"%b ou %b","not %b":"non %b",true:"vrai",false:"faux","join %words":"regroupe %words","split %s by %delim":"découpe %s entre les %delim",hello:"Bonjour",world:"Monde","letter %n of %s":"lettre %n de %s","length of %s":"longueur de %s","unicode of %s":"valeur unicode de %s","unicode %n as letter":"unicode %n comme lettre","is %s a %typ ?":"%s est un(e) %typ ?","is %s identical to %s ?":"%s est identique à %s ?","type of %s":"type de %s","Make a variable":"Nouvelle variable","Variable name":"Nom de la variable","Delete a variable":"Supprimer une variable","set %var to %s":"%var prend la valeur %s",
"change %var by %n":"ajouter à %var %n","show variable %var":"afficher la variable %var","hide variable %var":"cacher la variable %var","script variables %scriptVars":"variables du script %scriptVars","list %exp":"liste %exp","%s in front of %l":"%s au début de %l","item %idx of %l":"élément %idx de %l","all but first of %l":"tous sauf le premier de %l","length of %l":"longueur de %l","%l contains %s":"%l contient %s",thing:"qqchose","add %s to %l":"ajouter %s à %l","delete %ida of %l":"supprimer l'élément %ida de %l","insert %s at %idx of %l":"insérer %s en position %idx de %l","replace item %idx of %l with %s":"remplacer l'élément %idx de %l par %s","Make a block":"Nouveau bloc",
"About...":"À propos de Snap!...","Reference manual":"Manuel de référence","Snap! website":"Snap! le site web","Download source":"Télécharger le code source","Switch back to user mode":"Revenir en mode utilisateur","disable deep-Morphic\ncontext menus\nand show user-friendly ones":"désactiver la fonction morphic","Switch to dev mode":"Passer en mode développeur","enable Morphic\ncontext menus\nand inspectors,\nnot user-friendly!":"activer la fonction morphic","Project notes...":"Notes du projet...",New:"Nouveau","Open...":"Ouvrir...",Save:"Sauvegarder","Save As...":"Sauvegarder sous...","Import...":"Importer...","file menu import hint":"importer un projet exporté,\nune bibliothèque de blocs\nun costume ou un son",
"Export project as plain text...":"Exporter le projet comme texte...","Export project...":"Exporter le projet...","save project data as XML\nto your downloads folder":"sauvegarder le projet au\nformat XML dans votre\ndossier Téléchargements","show project data as XML\nin a new browser window":"ouvrir le projet au format XML\ndans une nouvelle fenêtre de votre navigateur","Export blocks...":"Exporter les blocs ","show global custom block definitions as XML\nin a new browser window":"montrer les définitions de bloc global personnalisé au format XML \ndans une nouvelle fenêtre de navigateur","Unused blocks...":"Blocs inutilisés...","find unused global custom blocks\nand remove their definitions":"trouver et supprimer les blocs personnalisés inutilisés",
"Remove unused blocks":"Supprimer les blocs inutilisés","there are currently no unused\nglobal custom blocks in this project":"Aucun bloc inutilisé dans ce projet","unused block(s) removed":"bloc(s) inutilisé(s) supprimé(s)","Export summary...":"Exporter un résumé...","open a new browser browser window\n with a summary of this project":"voir un résumé de ce projet dans\nune nouvelle fenêtre du navigateur","Import tools":"Importer les outils","load the official library of\npowerful blocks":"Importer la bibliothèque officielle\nd'outils avancés","Libraries...":"Bibliothèques...","Import library":"Importer une bibliothèque","Language...":"Langue...","Blurred shadows":"Ombres floues",
"uncheck to use solid drop\nshadows and highlights":"Décocher pour utiliser des rehauts et des ombres \n portées floues","check to use blurred drop\nshadows and highlights":"cocher pour utiliser des rehauts et des ombres \n portées pleines","Zebra coloring":"Colorations alternées","check to enable alternating\ncolors for nested blocks":"cocher pour activer des couleurs alternées \n pour les blocs emboîtés","uncheck to disable alternating\ncolors for nested block":"décocher pour désactiver des couleurs alternées \n pour les blocs emboîtés","Prefer empty slot drops":"Préférer des entrées vides","settings menu prefer empty slots hint":"cocher pour préférer des entrées vides \nlors du glisser-déposer d'un reporter",
"uncheck to allow dropped\nreporters to kick out others":"décocher pour ne pas préférer des entrées vides \nlors du glisser-déposer d'un reporter","Long form input dialog":"Boîte d'entrée en mode détaillé","check to always show slot\ntypes in the input dialog":"cocher pour toujours ouvrir la boîte de dialogue \nd'entrée en mode détaillé : avec tous les types de blocs","uncheck to use the input\ndialog in short form":"décocher pour utiliser la boîte de dialogue \nd'entrée en mode simple ","Virtual keyboard":"Clavier virtuel","uncheck to disable\nvirtual keyboard support\nfor mobile devices":"décocher pour désactiver le clavier virtuel pour \nles tablettes et smartphones : mobile devices  ",
"check to enable\nvirtual keyboard support\nfor mobile devices":"cocher pour activer le clavier virtuel pour \nles tablettes et smartphones : mobile devices  ","Input sliders":"Entrée curseurs","uncheck to disable\ninput sliders for\nentry fields":"décocher pour désactiver le curseur coulissant \ndans le champ de saisie","check to enable\ninput sliders for\nentry fields":"cocher pour activer un curseur coulissant \ndans le champ de saisie ","Clicking sound":"Cliquetis","uncheck to turn\nblock clicking\nsound off":"décocher pour désactiver le cliquetis \nlors de l'emboîtement des blocs","check to turn\nblock clicking\nsound on":"cocher pour activer le cliquetis \nlors de l'emboîtement des blocs",
"Turbo mode":"Mode turbo","check to prioritize\nscript execution":"cocher pour favoriser l'exécution du script","uncheck to run scripts\nat normal speed":"décocher pour exécuter le script en vitesse normale","Flat design":"Style alégé","check for alternative\nGUI design":"cocher pour un style d'interface alternatif","uncheck for default\nGUI design":"décocher pour le style classique d'interface","Keyboard Editing":"Édition au clavier","uncheck to disable\nkeyboard editing support":"décocher pour désactiver l'édition au clavier","check to enable\nkeyboard editing support":"cocher pour activer l'édition au clavier","Thread safe scripts":"Scripts réentrants","check to disallow\nscript reentrance":"cocher pour interdire\n la réentrance des scripts\net les exécuter séparément",
"uncheck to allow\nscript reentrance":"décocher pour permettre\n la réentrance des scripts\noù certains s'exécutent en paralèlle","Prefer smooth animations":"Vitesse d'animation fixe","uncheck for greater speed\nat variable frame rates":"décocher pour une vitesse\nd'animation maximale (mais variable)","check for smooth, predictable\nanimations across computers":"cocher pour une vitesse d'animation\nfixe et identique sur tous les ordinateurs","with inputs":"avec entrées","input names:":"renseigner un nom :","Input Names:":"Renseigner un nom :",help:"Aide","hide primitives":"Masquer les blocs de base","show primitives":"Afficher les blocs de base","help...":"Aide...",
duplicate:"dupliquer","make a copy\nand pick it up":"faire une copie\n et le déplacer","only duplicate this block":"ne dupliquer que ce bloc",delete:"supprimer","script pic...":"image du script...","open a new window\nwith a picture of this script":"ouvrir une nouvelle fenêtre avec une \nimage .png de ce script",ringify:"entourer",unringify:"détourer","delete block definition...":"supprimer les définitions de bloc","edit...":"éditer...",edit:"éditer",move:"déplacer","detach from":"Détacher de","detach all parts":"Détacher toutes les parties","export...":"Exporter...","paint a new sprite":"dessiner un nouveau lutin","clean up":"effacer","arrange scripts\nvertically":"arrange scripts\nvertically",
"add comment":"ajouter un commentaire","make a block...":"créer un nouveau bloc...",rename:"renommer",export:"exporter","rename costume":"renommer un costume","Paint a new costume":"Dessiner un nouveau costume","Play sound":"jouer un son","Stop sound":"arrêter un son",Stop:"arrêter",Play:"jouer","rename sound":"renommer un son",OK:"OK",Ok:"Ok",Cancel:"Annuler",Yes:"Oui",No:"Non",Open:"Ouvrir",Browser:"Navigateur",Examples:"Exemples",Help:"Aide",Untitled:"Sans titre","Open Project":"Ouvrir un projet","(empty)":"(vide)","Saved!":"Enregistrê !","Delete Project":"Supprimer un projet","Are you sure you want to delete":"Souhaitez-vous vraiment supprimer ?","rename...":"Renommer...",
"Costume Editor":"êditeur de costumes","click or drag crosshairs to move the rotation center":"cliquez ou faites dêfiler la ligne de mire  pour dêfinir le centre de rotation du costume","Project Notes":"Notes du projet","New Project":"Nouveau projet","Replace the current project with a new one?":"Remplacer le projet actuel par un nouveau ?","Open Projekt":"Ouvrir un projet","Save Project As...":"Sauvegarder le projet sous...","Export blocks":"exporter des blocs","this project doesn't have any\ncustom global blocks yet":"ce projet ne contient pas \nde bloc global personnalisé",select:"sélectionner",all:"tout",none:"aucun","for all sprites":"pour tous les lutins",
"for this sprite only":"pour ce lutin uniquement","Change block":"Changer le bloc",Command:"Commande",Reporter:"Reporter",Predicate:"Prédicat","Block Editor":"Éditeur de bloc",Apply:"Appliquer","Delete Custom Block":"Effacer le bloc personnalisé","block deletion dialog text":"Êtes-vous sûr de vouloir supprimer ce bloc personnalisé \net toutes ses instances ?","Create input name":"Créer le nom de l'entrée","Edit input name":"Éditer le nom de l'entrée","Edit label fragment":"Éditer le fragment du label","Title text":"Texte du titre","Input name":"Nom de l'entrée",Delete:"Supprimer",Object:"Objet",Number:"Nombre",Text:"Texte",List:"Liste","Any type":"Tout type",
"Boolean (T/F)":"Booléen (V/F)","Command\n(inline)":"Commande\n(en ligne)","Command\n(C-shape)":"Commande\n(en forme de C)","Any\n(unevaluated)":"Tout type\n(non évaluée)","Boolean\n(unevaluated)":"Booléen\n(non évaluée)","Single input.":"Entrée unique.","Default Value:":"Valeur par défaut :","Multiple inputs (value is list of inputs)":"Entrées multiples (la valeur est une liste des entrées)","Upvar - make internal variable visible to caller":"Upvar - Rendre la variable interne visible pour l'appelant",whitespace:"espaces blancs",line:"lignes",tab:"tabulations",cr:"retours de ligne",letter:"lettres","About Snap":"À propos de Snap","Back...":"Retour...","License...":"Licence...",
"Modules...":"Modules...","Credits...":"Contributeurs...","Translators...":"Traducteurs...",License:"License","current module versions:":"Versions du module courant :",Contributors:"Contributeurs",Translations:"Traductions",normal:"normal",large:"grand",slider:"curseur","slider min...":"min...","slider max...":"max...","Slider minimum value":"Valeur minimale du curseur","Slider maximum value":"Valeur maximale du curseur","length: ":"Longueur : ","add comment here...":"ajoute un commentaire ici","(90) right":"(90) à droite","(-90) left":"(-90) à gauche","(0) up":"(0) vers le haut","(180) down":"(180) vers le bas","mouse-pointer":"pointeur souris",edge:"bord","pen trails":"traces de stylo",
Turtle:"Pointeur",Empty:"Vide",color:"couleur",fisheye:"fisheye",whirl:"tourbillon",pixelate:"pixelisation",mosaic:"mosaïque",saturation:"saturation",brightness:"luminosité",ghost:"transparence",negative:"négatif",comic:"moiré",confetti:"confetti",space:"espace","up arrow":"flèche vers le haut","down arrow":"flèche vers le bas","right arrow":"flèche vers la droite","left arrow":"flèche vers la gauche",a:"a",b:"b",c:"c",d:"d",e:"e",f:"f",g:"g",h:"h",i:"i",j:"j",k:"k",l:"l",m:"m",n:"n",o:"o",p:"p",q:"q",r:"r",s:"s",t:"t",u:"u",v:"v",w:"w",x:"x",y:"y",z:"z",0:"0",1:"1",2:"2",3:"3",4:"4",5:"5",6:"6",7:"7",8:"8",9:"9","new...":"nouveau...",abs:"v. absolue",sqrt:"racine",
sin:"sin",cos:"cos",tan:"tan",asin:"asin",acos:"acos",atan:"atan",ln:"ln","e^":"e^",number:"nombre",text:"texte",Boolean:"booléen",list:"liste",command:"bloc de commande",reporter:"bloc reporter",predicate:"prédicat",last:"dernier",any:"n'importe quel","find blocks...":"chercher des blocs...","hide primitives":"cacher les primitives","show primitives":"montrer les primitives","Login...":"Connexion...","Signup...":"S'enregistrer...","Reset Password...":"Remise à zéro du mot de passe...","show all":"tout montrer","pic...":"image...","open a new window\nwith a picture of the stage":"ouvre une nouvelle fenêtre\navec une image de la scène","scripts pic...":"image des scripts...",
"open a new window\nwith a picture of all scripts":"ouvre une nouvelle fenêtre\navec une image de tous les scripts","Stage size...":"Taille de la scène...","Zoom blocks...":"Agrandir les blocs...","Plain prototype labels":"Étiquettes simples de définition","uncheck to always show (+) symbols\nin block prototype labels":"décocher pour montrer en permanance le symbole (+)\ndans les étiquettes de définition de bloc","check to hide (+) symbols\nin block prototype labels":"cocher pour cacher le symbole (+)\ndans les étiquettes de définition de bloc","check for flat ends of lines":"cocher pour dessiner des fins de ligne plates","uncheck for round ends of lines":"décocher pour dessiner des fins de lignes arrondies",
"Flat line ends":"Fins de ligne plates","Codification support":"Support de la « codification »","uncheck to disable\nblock to text mapping features":"décocher pour déactiver\nla fonction de transformation :\nbloc vers texte","check for block\nto text mapping features":"cocher pour activer\nla fonction de transformation :\nbloc vers texte","Inheritance support":"Support de l'héritage","current %dates":"date courante %dates",year:"année",month:"mois",date:"jour",hour:"heure",minute:"minute",second:"seconde","time in milliseconds":"heure en millisecondes","day of week":"jour de la semaine",brightness:"luminosité",transparence:"transparence",negative:"négatif",comic:"bande dessinée",
clicked:"cliqué",pressed:"pressé",dropped:"déposé","mouse-entered":"survolé","mouse-departed":"quitté","when %b":"Quand %b","JavaScript function ( %mult%s ) { %code }":"fonction JavaScript ( %mult%s ) { %code }","Press CTRL+C one more time to effectively copy to clipboard.":"Taper une nouvelle fois sur CTRL+C pour copier effectivement vers le presse-papier.","Press CTRL+V one more time to effectively paste from clipboard.":"Taper une nouvelle fois sur CTRL+V pour coller effectivement depuis le presse-papier.","Press CTRL+X one more time to effectively cut to clipboard.":"Taper une nouvelle fois sur CTRL+X pour couper effectivement vers le presse-papier.",undo:"défaire",
"Paintbrush tool\n(free draw)":"Pinceau\n(dessin à main levée)","Stroked Rectangle\n(shift: square)":"Rectangle\n(Maj : carré)","Stroked Ellipse\n(shift: circle)":"Ellipse\n(Maj : cercle)","Eraser tool":"Gomme","Set the rotation center":"Fixer le centre de rotation","Line tool\n(shift: vertical/horizontal)":"Ligne\n(Maj: verticale/horizontale)","Filled Rectangle\n(shift: square)":"Rectangle plein\n(Maj: carré)","Filled Ellipse\n(shift: circle)":"Ellipse pleine\n(Maj: cercle)","Fill a region":"Remplir une région","Pipette tool\n(pick a color anywhere)":"Pipette\n(sélectionnez une couleur n'importe où)",grow:"agrandir",shrink:"réduire","flip ↔":"miroir ↔","flip ↕":"miroir ↕",
"Brush size":"Taille de pinceau","Constrain proportions of shapes?\n(you can also hold shift)":"Contraindre les proportions de la forme ?\n(vous pouvez aussi maintenir appuyé Maj)"};Animation.prototype.easings={linear:function(t){return t},sinusoidal:function(t){return 1-Math.cos(radians(90*t))},quadratic:function(t){return t<.5?2*t*t:(4-2*t)*t-1},cubic:function(t){return t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1},elastic:function(t){return(t-=.5)<0?(.01+.01/t)*Math.sin(50*t):(.02-.01/t)*Math.sin(50*t)+1},sine_in:function(t){return 1-Math.sin(radians(90+90*t))},quad_in:function(t){return t*t},cubic_in:function(t){return t*t*t},elastic_in:function(t){return(.04-.04/t)*Math.sin(25*t)+1;
},sine_out:function(t){return Math.sin(radians(90*t))},quad_out:function(t){return t*(2-t)},elastic_out:function(t){return.04*t/--t*Math.sin(25*t)}},Animation.prototype.start=function(){this.endTime=Date.now()+this.duration,this.destination=this.getter.call(this)+this.delta,this.isActive=!0},Animation.prototype.step=function(){if(this.isActive){var now=Date.now();now>this.endTime?(this.setter(this.destination),this.isActive=!1,this.onComplete&&this.onComplete()):this.setter(this.destination-this.delta*this.easing((this.endTime-now)/this.duration))}},Color.prototype.toString=function(){return"rgba("+Math.round(this.r)+","+Math.round(this.g)+","+Math.round(this.b)+","+this.a+")";
},Color.prototype.copy=function(){return new Color(this.r,this.g,this.b,this.a)},Color.prototype.eq=function(aColor){return aColor&&this.r===aColor.r&&this.g===aColor.g&&this.b===aColor.b},Color.prototype.hsv=function(){var max,min,h,s,v,d,rr=this.r/255,gg=this.g/255,bb=this.b/255;if(max=Math.max(rr,gg,bb),min=Math.min(rr,gg,bb),h=max,s=max,v=max,d=max-min,s=0===max?0:d/max,max===min)h=0;else{switch(max){case rr:h=(gg-bb)/d+(gg<bb?6:0);break;case gg:h=(bb-rr)/d+2;break;case bb:h=(rr-gg)/d+4}h/=6}return[h,s,v]},Color.prototype.set_hsv=function(h,s,v){var i,f,p,q,t;switch(i=Math.floor(6*h),f=6*h-i,p=v*(1-s),q=v*(1-f*s),t=v*(1-(1-f)*s),i%6){case 0:this.r=v,this.g=t,
this.b=p;break;case 1:this.r=q,this.g=v,this.b=p;break;case 2:this.r=p,this.g=v,this.b=t;break;case 3:this.r=p,this.g=q,this.b=v;break;case 4:this.r=t,this.g=p,this.b=v;break;case 5:this.r=v,this.g=p,this.b=q}this.r*=255,this.g*=255,this.b*=255},Color.prototype.mixed=function(proportion,otherColor){var frac1=Math.min(Math.max(proportion,0),1),frac2=1-frac1;return new Color(this.r*frac1+otherColor.r*frac2,this.g*frac1+otherColor.g*frac2,this.b*frac1+otherColor.b*frac2)},Color.prototype.darker=function(percent){var fract=.8333;return percent&&(fract=(100-percent)/100),this.mixed(fract,new Color(0,0,0))},Color.prototype.lighter=function(percent){var fract=.8333;return percent&&(fract=(100-percent)/100),
this.mixed(fract,new Color(255,255,255))},Color.prototype.dansDarker=function(){var hsv=this.hsv(),result=new Color,vv=Math.max(hsv[2]-.16,0);return result.set_hsv(hsv[0],hsv[1],vv),result},Color.prototype.inverted=function(){return new Color(255-this.r,255-this.g,255-this.b)},Point.prototype.toString=function(){return Math.round(this.x.toString())+"@"+Math.round(this.y.toString())},Point.prototype.copy=function(){return new Point(this.x,this.y)},Point.prototype.eq=function(aPoint){return this.x===aPoint.x&&this.y===aPoint.y},Point.prototype.lt=function(aPoint){return this.x<aPoint.x&&this.y<aPoint.y},Point.prototype.gt=function(aPoint){return this.x>aPoint.x&&this.y>aPoint.y;
},Point.prototype.ge=function(aPoint){return this.x>=aPoint.x&&this.y>=aPoint.y},Point.prototype.le=function(aPoint){return this.x<=aPoint.x&&this.y<=aPoint.y},Point.prototype.max=function(aPoint){return new Point(Math.max(this.x,aPoint.x),Math.max(this.y,aPoint.y))},Point.prototype.min=function(aPoint){return new Point(Math.min(this.x,aPoint.x),Math.min(this.y,aPoint.y))},Point.prototype.round=function(){return new Point(Math.round(this.x),Math.round(this.y))},Point.prototype.abs=function(){return new Point(Math.abs(this.x),Math.abs(this.y))},Point.prototype.neg=function(){return new Point(-this.x,-this.y)},Point.prototype.mirror=function(){return new Point(this.y,this.x);
},Point.prototype.floor=function(){return new Point(Math.max(Math.floor(this.x),0),Math.max(Math.floor(this.y),0))},Point.prototype.ceil=function(){return new Point(Math.ceil(this.x),Math.ceil(this.y))},Point.prototype.add=function(other){return other instanceof Point?new Point(this.x+other.x,this.y+other.y):new Point(this.x+other,this.y+other)},Point.prototype.subtract=function(other){return other instanceof Point?new Point(this.x-other.x,this.y-other.y):new Point(this.x-other,this.y-other)},Point.prototype.multiplyBy=function(other){return other instanceof Point?new Point(this.x*other.x,this.y*other.y):new Point(this.x*other,this.y*other)},Point.prototype.divideBy=function(other){
return other instanceof Point?new Point(this.x/other.x,this.y/other.y):new Point(this.x/other,this.y/other)},Point.prototype.floorDivideBy=function(other){return other instanceof Point?new Point(Math.floor(this.x/other.x),Math.floor(this.y/other.y)):new Point(Math.floor(this.x/other),Math.floor(this.y/other))},Point.prototype.r=function(){var t=this.multiplyBy(this);return Math.sqrt(t.x+t.y)},Point.prototype.degrees=function(){var tan,theta;return 0===this.x?this.y>=0?90:270:(tan=this.y/this.x,theta=Math.atan(tan),this.x>=0?this.y>=0?degrees(theta):360+degrees(theta):180+degrees(theta))},Point.prototype.theta=function(){var tan,theta;return 0===this.x?radians(this.y>=0?90:270):(tan=this.y/this.x,
theta=Math.atan(tan),this.x>=0?this.y>=0?theta:radians(360)+theta:radians(180)+theta)},Point.prototype.crossProduct=function(aPoint){return this.multiplyBy(aPoint.mirror())},Point.prototype.distanceTo=function(aPoint){return aPoint.subtract(this).r()},Point.prototype.rotate=function(direction,center){var offset=this.subtract(center);return"right"===direction?new Point(-offset.y,offset.y).add(center):"left"===direction?new Point(offset.y,-offset.y).add(center):center.subtract(offset)},Point.prototype.flip=function(direction,center){return"vertical"===direction?new Point(this.x,2*center.y-this.y):new Point(2*center.x-this.x,this.y)},Point.prototype.distanceAngle=function(dist,angle){
var x,y,deg=angle;return deg>270?deg-=360:deg<-270&&(deg+=360),-90<=deg&&deg<=90?(x=Math.sin(radians(deg))*dist,y=Math.sqrt(dist*dist-x*x),new Point(x+this.x,this.y-y)):(x=Math.sin(radians(180-deg))*dist,y=Math.sqrt(dist*dist-x*x),new Point(x+this.x,this.y+y))},Point.prototype.scaleBy=function(scalePoint){return this.multiplyBy(scalePoint)},Point.prototype.translateBy=function(deltaPoint){return this.add(deltaPoint)},Point.prototype.rotateBy=function(angle,centerPoint){var center=centerPoint||new Point(0,0),p=this.subtract(center),r=p.r(),theta=angle-p.theta();return new Point(center.x+r*Math.cos(theta),center.y-r*Math.sin(theta))},Point.prototype.asArray=function(){
return[this.x,this.y]},Rectangle.prototype.init=function(originPoint,cornerPoint){this.origin=originPoint,this.corner=cornerPoint},Rectangle.prototype.toString=function(){return"["+this.origin.toString()+" | "+this.extent().toString()+"]"},Rectangle.prototype.copy=function(){return new Rectangle(this.left(),this.top(),this.right(),this.bottom())},Point.prototype.corner=function(cornerPoint){return new Rectangle(this.x,this.y,cornerPoint.x,cornerPoint.y)},Point.prototype.rectangle=function(aPoint){var org,crn;return org=this.min(aPoint),crn=this.max(aPoint),new Rectangle(org.x,org.y,crn.x,crn.y)},Point.prototype.extent=function(aPoint){var crn=this.add(aPoint);
return new Rectangle(this.x,this.y,crn.x,crn.y)},Rectangle.prototype.setTo=function(left,top,right,bottom){this.origin=new Point(left||(0===left?0:this.left()),top||(0===top?0:this.top())),this.corner=new Point(right||(0===right?0:this.right()),bottom||(0===bottom?0:this.bottom()))},Rectangle.prototype.area=function(){var w=this.width();return w<0?0:Math.max(w*this.height(),0)},Rectangle.prototype.bottom=function(){return this.corner.y},Rectangle.prototype.bottomCenter=function(){return new Point(this.center().x,this.bottom())},Rectangle.prototype.bottomLeft=function(){return new Point(this.origin.x,this.corner.y)},Rectangle.prototype.bottomRight=function(){return this.corner.copy();
},Rectangle.prototype.boundingBox=function(){return this},Rectangle.prototype.center=function(){return this.origin.add(this.corner.subtract(this.origin).floorDivideBy(2))},Rectangle.prototype.corners=function(){return[this.origin,this.bottomLeft(),this.corner,this.topRight()]},Rectangle.prototype.extent=function(){return this.corner.subtract(this.origin)},Rectangle.prototype.height=function(){return this.corner.y-this.origin.y},Rectangle.prototype.left=function(){return this.origin.x},Rectangle.prototype.leftCenter=function(){return new Point(this.left(),this.center().y)},Rectangle.prototype.right=function(){return this.corner.x},Rectangle.prototype.rightCenter=function(){
return new Point(this.right(),this.center().y)},Rectangle.prototype.top=function(){return this.origin.y},Rectangle.prototype.topCenter=function(){return new Point(this.center().x,this.top())},Rectangle.prototype.topLeft=function(){return this.origin},Rectangle.prototype.topRight=function(){return new Point(this.corner.x,this.origin.y)},Rectangle.prototype.width=function(){return this.corner.x-this.origin.x},Rectangle.prototype.position=function(){return this.origin},Rectangle.prototype.eq=function(aRect){return this.origin.eq(aRect.origin)&&this.corner.eq(aRect.corner)},Rectangle.prototype.abs=function(){var newOrigin,newCorner;return newOrigin=this.origin.abs(),
newCorner=this.corner.max(newOrigin),newOrigin.corner(newCorner)},Rectangle.prototype.insetBy=function(delta){var result=new Rectangle;return result.origin=this.origin.add(delta),result.corner=this.corner.subtract(delta),result},Rectangle.prototype.expandBy=function(delta){var result=new Rectangle;return result.origin=this.origin.subtract(delta),result.corner=this.corner.add(delta),result},Rectangle.prototype.growBy=function(delta){var result=new Rectangle;return result.origin=this.origin.copy(),result.corner=this.corner.add(delta),result},Rectangle.prototype.intersect=function(aRect){var result=new Rectangle;return result.origin=this.origin.max(aRect.origin),
result.corner=this.corner.min(aRect.corner),result},Rectangle.prototype.merge=function(aRect){var result=new Rectangle;return result.origin=this.origin.min(aRect.origin),result.corner=this.corner.max(aRect.corner),result},Rectangle.prototype.mergeWith=function(aRect){this.origin=this.origin.min(aRect.origin),this.corner=this.corner.max(aRect.corner)},Rectangle.prototype.round=function(){return this.origin.round().corner(this.corner.round())},Rectangle.prototype.spread=function(){return this.origin.floor().corner(this.corner.ceil()).expandBy(1)},Rectangle.prototype.amountToTranslateWithin=function(aRect){var dx=0,dy=0;return this.right()>aRect.right()&&(dx=aRect.right()-this.right()),
this.bottom()>aRect.bottom()&&(dy=aRect.bottom()-this.bottom()),this.left()+dx<aRect.left()&&(dx=aRect.left()-this.left()),this.top()+dy<aRect.top()&&(dy=aRect.top()-this.top()),new Point(dx,dy)},Rectangle.prototype.containsPoint=function(aPoint){return this.origin.le(aPoint)&&aPoint.lt(this.corner)},Rectangle.prototype.containsRectangle=function(aRect){return aRect.origin.gt(this.origin)&&aRect.corner.lt(this.corner)},Rectangle.prototype.intersects=function(aRect){var ro=aRect.origin,rc=aRect.corner;return rc.x>=this.origin.x&&rc.y>=this.origin.y&&ro.x<=this.corner.x&&ro.y<=this.corner.y},Rectangle.prototype.isNearTo=function(aRect,threshold){var ro=aRect.origin,rc=aRect.corner,border=threshold||0;
return rc.x+border>=this.origin.x&&rc.y+border>=this.origin.y&&ro.x-border<=this.corner.x&&ro.y-border<=this.corner.y},Rectangle.prototype.scaleBy=function(scale){var o=this.origin.multiplyBy(scale),c=this.corner.multiplyBy(scale);return new Rectangle(o.x,o.y,c.x,c.y)},Rectangle.prototype.translateBy=function(factor){var o=this.origin.add(factor),c=this.corner.add(factor);return new Rectangle(o.x,o.y,c.x,c.y)},Rectangle.prototype.asArray=function(){return[this.left(),this.top(),this.right(),this.bottom()]},Rectangle.prototype.asArray_xywh=function(){return[this.left(),this.top(),this.width(),this.height()]},Node.prototype.init=function(parent,childrenArray){this.parent=parent||null,
this.children=childrenArray||[]},Node.prototype.toString=function(){return"a Node["+this.children.length.toString()+"]"},Node.prototype.addChild=function(aNode){this.children.push(aNode),aNode.parent=this},Node.prototype.addChildFirst=function(aNode){this.children.splice(0,null,aNode),aNode.parent=this},Node.prototype.removeChild=function(aNode){var idx=this.children.indexOf(aNode);idx!==-1&&this.children.splice(idx,1)},Node.prototype.root=function(){return null===this.parent?this:this.parent.root()},Node.prototype.depth=function(){return null===this.parent?0:this.parent.depth()+1},Node.prototype.allChildren=function(){var result=[this];return this.children.forEach(function(child){
result=result.concat(child.allChildren())}),result},Node.prototype.forAllChildren=function(aFunction){this.children.length>0&&this.children.forEach(function(child){child.forAllChildren(aFunction)}),aFunction.call(null,this)},Node.prototype.anyChild=function(aPredicate){var i;if(aPredicate.call(null,this))return!0;for(i=0;i<this.children.length;i+=1)if(this.children[i].anyChild(aPredicate))return!0;return!1},Node.prototype.allLeafs=function(){var result=[];return this.allChildren().forEach(function(element){0===element.children.length&&result.push(element)}),result},Node.prototype.allParents=function(){var result=[this];return null!==this.parent&&(result=result.concat(this.parent.allParents())),
result},Node.prototype.siblings=function(){var myself=this;return null===this.parent?[]:this.parent.children.filter(function(child){return child!==myself})},Node.prototype.parentThatIsA=function(constructor){return this instanceof constructor?this:this.parent?this.parent.parentThatIsA(constructor):null},Node.prototype.parentThatIsAnyOf=function(constructors){var yup=!1,myself=this;return constructors.forEach(function(each){if(myself.constructor===each)return void(yup=!0)}),yup?this:this.parent?this.parent.parentThatIsAnyOf(constructors):null};var Morph,WorldMorph,HandMorph,ShadowMorph,FrameMorph,MenuMorph,HandleMorph,StringFieldMorph,ColorPickerMorph,SliderMorph,ScrollFrameMorph,InspectorMorph,StringMorph,TextMorph;
Morph.prototype=new Node,Morph.prototype.constructor=Morph,Morph.uber=Node.prototype,Morph.prototype.trackChanges=!0,Morph.prototype.shadowBlur=4,Morph.prototype.init=function(noDraw){Morph.uber.init.call(this),this.isMorph=!0,this.image=null,this.bounds=new Rectangle(0,0,50,40),this.cachedFullImage=null,this.cachedFullBounds=null,this.color=new Color(80,80,80),this.texture=null,this.cachedTexture=null,this.alpha=1,this.isVisible=!0,this.isDraggable=!1,this.isTemplate=!1,this.acceptsDrops=!1,this.noticesTransparentClick=!1,noDraw||this.drawNew(),this.fps=0,this.customContextMenu=null,this.lastTime=Date.now(),this.onNextStep=null},Morph.prototype.toString=function(){
return"a "+(this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])+" "+this.children.length.toString()+" "+this.bounds},Morph.prototype.destroy=function(){null!==this.parent&&(this.fullChanged(),this.parent.removeChild(this))},Morph.prototype.stepFrame=function(){if(!this.step)return null;var current,elapsed,leftover,nxt;current=Date.now(),elapsed=current-this.lastTime,leftover=this.fps>0?1e3/this.fps-elapsed:0,leftover<1&&(this.lastTime=current,this.onNextStep&&(nxt=this.onNextStep,this.onNextStep=null,nxt.call(this)),this.step(),this.children.forEach(function(child){child.stepFrame()}))},Morph.prototype.nextSteps=function(arrayOfFunctions){
var lst=arrayOfFunctions||[],nxt=lst.shift(),myself=this;nxt&&(this.onNextStep=function(){nxt.call(myself),myself.nextSteps(lst)})},Morph.prototype.step=nop,Morph.prototype.left=function(){return this.bounds.left()},Morph.prototype.right=function(){return this.bounds.right()},Morph.prototype.top=function(){return this.bounds.top()},Morph.prototype.bottom=function(){return this.bounds.bottom()},Morph.prototype.center=function(){return this.bounds.center()},Morph.prototype.bottomCenter=function(){return this.bounds.bottomCenter()},Morph.prototype.bottomLeft=function(){return this.bounds.bottomLeft()},Morph.prototype.bottomRight=function(){return this.bounds.bottomRight();
},Morph.prototype.boundingBox=function(){return this.bounds},Morph.prototype.corners=function(){return this.bounds.corners()},Morph.prototype.leftCenter=function(){return this.bounds.leftCenter()},Morph.prototype.rightCenter=function(){return this.bounds.rightCenter()},Morph.prototype.topCenter=function(){return this.bounds.topCenter()},Morph.prototype.topLeft=function(){return this.bounds.topLeft()},Morph.prototype.topRight=function(){return this.bounds.topRight()},Morph.prototype.position=function(){return this.bounds.origin},Morph.prototype.extent=function(){return this.bounds.extent()},Morph.prototype.width=function(){return this.bounds.width()},Morph.prototype.height=function(){
return this.bounds.height()},Morph.prototype.fullBounds=function(){var result;return result=this.bounds,this.children.forEach(function(child){child.isVisible&&(result=result.merge(child.fullBounds()))}),result},Morph.prototype.fullBoundsNoShadow=function(){var result;return result=this.bounds,this.children.forEach(function(child){child instanceof ShadowMorph||!child.isVisible||(result=result.merge(child.fullBounds()))}),result},Morph.prototype.visibleBounds=function(){var visible=this.bounds,frames=this.allParents().filter(function(p){return p instanceof FrameMorph});return frames.forEach(function(f){visible=visible.intersect(f.bounds)}),visible},Morph.prototype.moveBy=function(delta){
this.fullChanged(),this.silentMoveBy(delta),this.fullChanged()},Morph.prototype.silentMoveBy=function(delta){var children=this.children,i=children.length;for(this.bounds=this.bounds.translateBy(delta),this.cachedFullBounds&&(this.cachedFullBounds=this.cachedFullBounds.translateBy(delta)),i;i>0;i-=1)children[i-1].silentMoveBy(delta)},Morph.prototype.setPosition=function(aPoint){var delta=aPoint.subtract(this.topLeft());0===delta.x&&0===delta.y||this.moveBy(delta)},Morph.prototype.silentSetPosition=function(aPoint){var delta=aPoint.subtract(this.topLeft());0===delta.x&&0===delta.y||this.silentMoveBy(delta)},Morph.prototype.setLeft=function(x){this.setPosition(new Point(x,this.top()));
},Morph.prototype.setRight=function(x){this.setPosition(new Point(x-this.width(),this.top()))},Morph.prototype.setTop=function(y){this.setPosition(new Point(this.left(),y))},Morph.prototype.setBottom=function(y){this.setPosition(new Point(this.left(),y-this.height()))},Morph.prototype.setCenter=function(aPoint){this.setPosition(aPoint.subtract(this.extent().floorDivideBy(2)))},Morph.prototype.setFullCenter=function(aPoint){this.setPosition(aPoint.subtract(this.fullBounds().extent().floorDivideBy(2)))},Morph.prototype.keepWithin=function(aMorph){var leftOff,rightOff,topOff,bottomOff;leftOff=this.fullBounds().left()-aMorph.left(),leftOff<0&&this.moveBy(new Point(-leftOff,0)),
rightOff=this.fullBounds().right()-aMorph.right(),rightOff>0&&this.moveBy(new Point(-rightOff,0)),topOff=this.fullBounds().top()-aMorph.top(),topOff<0&&this.moveBy(new Point(0,-topOff)),bottomOff=this.fullBounds().bottom()-aMorph.bottom(),bottomOff>0&&this.moveBy(new Point(0,-bottomOff))},Morph.prototype.scrollIntoView=function(){var leftOff,rightOff,topOff,bottomOff,sf=this.parentThatIsA(ScrollFrameMorph);sf&&(rightOff=Math.min(this.fullBounds().right()-sf.right(),sf.contents.right()-sf.right()),rightOff>0&&sf.contents.moveBy(new Point(-rightOff,0)),leftOff=this.fullBounds().left()-sf.left(),leftOff<0&&sf.contents.moveBy(new Point(-leftOff,0)),topOff=this.fullBounds().top()-sf.top(),
topOff<0&&sf.contents.moveBy(new Point(0,-topOff)),bottomOff=this.fullBounds().bottom()-sf.bottom(),bottomOff>0&&sf.contents.moveBy(new Point(0,-bottomOff)),sf.adjustScrollBars())},Morph.prototype.setExtent=function(aPoint,silently){return silently?void this.silentSetExtent(aPoint):void(aPoint.eq(this.extent())||(this.changed(),this.silentSetExtent(aPoint),this.changed(),this.drawNew()))},Morph.prototype.silentSetExtent=function(aPoint){var ext,newWidth,newHeight;ext=aPoint.round(),newWidth=Math.max(ext.x,0),newHeight=Math.max(ext.y,0),this.bounds.corner=new Point(this.bounds.origin.x+newWidth,this.bounds.origin.y+newHeight)},Morph.prototype.setWidth=function(width){
this.setExtent(new Point(width||0,this.height()))},Morph.prototype.silentSetWidth=function(width){var w=Math.max(Math.round(width||0),0);this.bounds.corner=new Point(this.bounds.origin.x+w,this.bounds.corner.y)},Morph.prototype.setHeight=function(height){this.setExtent(new Point(this.width(),height||0))},Morph.prototype.silentSetHeight=function(height){var h=Math.max(Math.round(height||0),0);this.bounds.corner=new Point(this.bounds.corner.x,this.bounds.origin.y+h)},Morph.prototype.setColor=function(aColor){aColor&&(this.color.eq(aColor)||(this.color=aColor,this.changed(),this.drawNew()))},Morph.prototype.drawNew=function(){this.image=newCanvas(this.extent());var context=this.image.getContext("2d");
context.fillStyle=this.color.toString(),context.beginPath(),context.moveTo(0,0),context.lineTo(this.image.width,0),context.lineTo(this.image.width,this.image.height),context.lineTo(0,this.image.height+1e-4),context.closePath(),context.fill(),this.cachedTexture?this.drawCachedTexture():this.texture&&this.drawTexture(this.texture)},Morph.prototype.drawTexture=function(url){var myself=this;this.cachedTexture=new Image,this.cachedTexture.onload=function(){myself.drawCachedTexture()},this.cachedTexture.src=this.texture=url},Morph.prototype.drawCachedTexture=function(){var x,y,bg=this.cachedTexture,cols=Math.floor(this.image.width/bg.width),lines=Math.floor(this.image.height/bg.height),context=this.image.getContext("2d");
for(y=0;y<=lines;y+=1)for(x=0;x<=cols;x+=1)context.drawImage(bg,x*bg.width,y*bg.height);this.changed()},Morph.prototype.drawOn=function(aCanvas,aRect){var rectangle,area,delta,src,context,w,h,sl,st,pic=this.cachedFullImage||this.image,bounds=this.cachedFullBounds||this.bounds;if(!this.isVisible)return null;if(rectangle=aRect||bounds,area=rectangle.intersect(bounds),area.extent().gt(new Point(0,0))){if(delta=bounds.position().neg(),src=area.copy().translateBy(delta),context=aCanvas.getContext("2d"),context.globalAlpha=this.alpha,sl=src.left(),st=src.top(),w=Math.min(src.width(),pic.width-sl),h=Math.min(src.height(),pic.height-st),w<1||h<1)return null;context.drawImage(pic,sl,st,w,h,area.left(),area.top(),w,h);
}},Morph.prototype.fullDrawOn=function(aCanvas,aRect){var rectangle;return this.isVisible?(rectangle=aRect||this.cachedFullBounds||this.fullBounds(),this.drawOn(aCanvas,rectangle),void(this.cachedFullImage||this.children.forEach(function(child){child.fullDrawOn(aCanvas,rectangle)}))):null},Morph.prototype.hide=function(){this.isVisible=!1,this.changed(),this.children.forEach(function(child){child.hide()})},Morph.prototype.show=function(){this.isVisible=!0,this.changed(),this.children.forEach(function(child){child.show()})},Morph.prototype.toggleVisibility=function(){this.isVisible=!this.isVisible,this.changed(),this.children.forEach(function(child){child.toggleVisibility();
})},Morph.prototype.fullImageClassic=function(){var fb=this.cachedFullBounds||this.fullBounds(),img=newCanvas(fb.extent()),ctx=img.getContext("2d");return ctx.translate(-fb.origin.x,-fb.origin.y),this.fullDrawOn(img,fb),img.globalAlpha=this.alpha,img},Morph.prototype.fullImage=function(){var img,ctx,fb;return img=newCanvas(this.fullBounds().extent()),ctx=img.getContext("2d"),fb=this.fullBounds(),this.allChildren().forEach(function(morph){morph.isVisible&&(ctx.globalAlpha=morph.alpha,morph.image.width&&morph.image.height&&ctx.drawImage(morph.image,morph.bounds.origin.x-fb.origin.x,morph.bounds.origin.y-fb.origin.y))}),img},Morph.prototype.shadowImage=function(off,color){
var fb,img,outline,sha,ctx,offset=off||new Point(7,7),clr=color||new Color(0,0,0);return fb=this.fullBounds().extent(),img=this.fullImage(),outline=newCanvas(fb),ctx=outline.getContext("2d"),ctx.drawImage(img,0,0),ctx.globalCompositeOperation="destination-out",ctx.drawImage(img,-offset.x,-offset.y),sha=newCanvas(fb),ctx=sha.getContext("2d"),ctx.drawImage(outline,0,0),ctx.globalCompositeOperation="source-atop",ctx.fillStyle=clr.toString(),ctx.fillRect(0,0,fb.x,fb.y),sha},Morph.prototype.shadowImageBlurred=function(off,color){var fb,img,sha,ctx,offset=off||new Point(7,7),blur=this.shadowBlur,clr=color||new Color(0,0,0);return fb=this.fullBounds().extent().add(2*blur),
img=this.fullImage(),sha=newCanvas(fb),ctx=sha.getContext("2d"),ctx.shadowOffsetX=offset.x,ctx.shadowOffsetY=offset.y,ctx.shadowBlur=blur,ctx.shadowColor=clr.toString(),ctx.drawImage(img,blur-offset.x,blur-offset.y),ctx.shadowOffsetX=0,ctx.shadowOffsetY=0,ctx.shadowBlur=0,ctx.globalCompositeOperation="destination-out",ctx.drawImage(img,blur-offset.x,blur-offset.y),sha},Morph.prototype.shadow=function(off,a,color){var shadow=new ShadowMorph,offset=off||new Point(7,7),alpha=a||(0===a?0:.2),fb=this.fullBounds();return shadow.setExtent(fb.extent().add(2*this.shadowBlur)),useBlurredShadows&&!MorphicPreferences.isFlat?(shadow.image=this.shadowImageBlurred(offset,color),
shadow.alpha=alpha,shadow.setPosition(fb.origin.add(offset).subtract(this.shadowBlur))):(shadow.image=this.shadowImage(offset,color),shadow.alpha=alpha,shadow.setPosition(fb.origin.add(offset))),shadow},Morph.prototype.addShadow=function(off,a,color){var shadow,offset=off||new Point(7,7),alpha=a||(0===a?0:.2);return shadow=this.shadow(offset,alpha,color),this.addBack(shadow),this.fullChanged(),shadow},Morph.prototype.getShadow=function(){var shadows;return shadows=this.children.slice(0).reverse().filter(function(child){return child instanceof ShadowMorph}),0!==shadows.length?shadows[0]:null},Morph.prototype.removeShadow=function(){var shadow=this.getShadow();null!==shadow&&(this.fullChanged(),
this.removeChild(shadow))},Morph.prototype.penTrails=function(){return this.image},Morph.prototype.changed=function(){if(this.trackChanges){var w=this.root();w instanceof WorldMorph&&w.broken.push(this.visibleBounds().spread())}this.parent&&this.parent.childChanged(this)},Morph.prototype.fullChanged=function(){if(this.trackChanges){var w=this.root();w instanceof WorldMorph&&w.broken.push((this.cachedFullBounds||this.fullBounds()).spread())}},Morph.prototype.childChanged=function(){this.parent&&this.parent.childChanged(this)},Morph.prototype.world=function(){var root=this.root();return root instanceof WorldMorph?root:root instanceof HandMorph?root.world:null},
Morph.prototype.add=function(aMorph){var owner=aMorph.parent;null!==owner&&owner.removeChild(aMorph),this.addChild(aMorph)},Morph.prototype.addBack=function(aMorph){var owner=aMorph.parent;null!==owner&&owner.removeChild(aMorph),this.addChildFirst(aMorph)},Morph.prototype.topMorphAt=function(point){var i,result;if(!this.isVisible)return null;for(i=this.children.length-1;i>=0;i-=1)if(result=this.children[i].topMorphAt(point))return result;return!this.bounds.containsPoint(point)||!this.noticesTransparentClick&&this.isTransparentAt(point)?null:this},Morph.prototype.topMorphSuchThat=function(predicate){var next;return predicate.call(null,this)?(next=detect(this.children.slice(0).reverse(),predicate),
next?next.topMorphSuchThat(predicate):this):null},Morph.prototype.overlappedMorphs=function(){var morphs,world=this.world(),fb=this.fullBounds(),myself=this,allParents=this.allParents(),allChildren=this.allChildren();return morphs=world.allChildren(),morphs.filter(function(m){return m.isVisible&&m!==myself&&m!==world&&!contains(allParents,m)&&!contains(allChildren,m)&&m.fullBounds().intersects(fb)})},Morph.prototype.getPixelColor=function(aPoint){var point,context,data;return point=aPoint.subtract(this.bounds.origin),context=this.image.getContext("2d"),data=context.getImageData(point.x,point.y,1,1),new Color(data.data[0],data.data[1],data.data[2],data.data[3]/255);
},Morph.prototype.isTransparentAt=function(aPoint){var point,context,data;return!!this.bounds.containsPoint(aPoint)&&(!this.texture&&(point=aPoint.subtract(this.bounds.origin),context=this.image.getContext("2d"),data=context.getImageData(Math.floor(point.x),Math.floor(point.y),1,1),0===data.data[3]))},Morph.prototype.copy=function(){var c=copy(this);return c.parent=null,c.children=[],c.bounds=this.bounds.copy(),c},Morph.prototype.fullCopy=function(){var c,map=new Map;return c=this.copyRecordingReferences(map),c.forAllChildren(function(m){m.updateReferences(map)}),c},Morph.prototype.copyRecordingReferences=function(map){var c=this.copy();return map.set(this,c),
this.children.forEach(function(m){c.add(m.copyRecordingReferences(map))}),c},Morph.prototype.updateReferences=function(map){var property,value,reference,i,properties=Object.keys(this),l=properties.length;for(i=0;i<l;i+=1)property=properties[i],value=this[property],value&&value.isMorph&&(reference=map.get(value),reference&&(this[property]=reference))},Morph.prototype.rootForGrab=function(){return this instanceof ShadowMorph?this.parent.rootForGrab():this.parent instanceof ScrollFrameMorph?this.parent:null===this.parent||this.parent instanceof WorldMorph||this.parent instanceof FrameMorph||this.isDraggable===!0?this:this.parent.rootForGrab()},Morph.prototype.isCorrectingOutsideDrag=function(){
return!0},Morph.prototype.wantsDropOf=function(aMorph){return!(aMorph instanceof HandleMorph||aMorph instanceof MenuMorph||aMorph instanceof InspectorMorph)&&this.acceptsDrops},Morph.prototype.pickUp=function(wrrld){var world=wrrld||this.world();this.setPosition(world.hand.position().subtract(this.extent().floorDivideBy(2))),world.hand.grab(this)},Morph.prototype.isPickedUp=function(){return null!==this.parentThatIsA(HandMorph)},Morph.prototype.situation=function(){return this.parent?{origin:this.parent,position:this.position().subtract(this.parent.position())}:null},Morph.prototype.slideBackTo=function(situation,msecs,onBeforeDrop,onComplete){var pos=situation.origin.position().add(situation.position),myself=this;
this.glideTo(pos,msecs,null,function(){situation.origin.add(myself),onBeforeDrop&&onBeforeDrop(),myself.justDropped&&myself.justDropped(),situation.origin.reactToDropOf&&situation.origin.reactToDropOf(myself),onComplete&&onComplete()})},Morph.prototype.glideTo=function(endPoint,msecs,easing,onComplete){var world=this.world(),myself=this;world.animations.push(new Animation(function(x){myself.setLeft(x)},function(){return myself.left()},-(this.left()-endPoint.x),msecs||100,easing,onComplete)),world.animations.push(new Animation(function(y){myself.setTop(y)},function(){return myself.top()},-(this.top()-endPoint.y),msecs||100,easing))},Morph.prototype.fadeTo=function(endAlpha,msecs,easing,onComplete){
var world=this.world(),myself=this,oldAlpha=this.alpha;this.children.forEach(function(child){child.fadeTo(endAlpha,msecs,easing)}),world.animations.push(new Animation(function(n){myself.alpha=n,myself.changed()},function(){return myself.alpha},endAlpha-this.alpha,msecs||200,easing,function(){myself.alpha=oldAlpha,onComplete&&onComplete()}))},Morph.prototype.perish=function(msecs,onComplete){var myself=this;this.fadeTo(0,msecs||100,null,function(){myself.destroy(),onComplete&&onComplete()})},Morph.prototype.nop=nop,Morph.prototype.resize=function(){this.world().activeHandle=new HandleMorph(this)},Morph.prototype.move=function(){this.world().activeHandle=new HandleMorph(this,null,null,null,null,"move");
},Morph.prototype.moveCenter=function(){this.world().activeHandle=new HandleMorph(this,null,null,null,null,"moveCenter")},Morph.prototype.hint=function(msg){var m,text;text=msg,msg?msg.toString&&(text=msg.toString()):text="NULL",m=new MenuMorph(this,text),m.isDraggable=!0,m.popUpCenteredAtHand(this.world())},Morph.prototype.inform=function(msg){var m,text;text=msg,msg?msg.toString&&(text=msg.toString()):text="NULL",m=new MenuMorph(this,text),m.addItem("Ok"),m.isDraggable=!0,m.popUpCenteredAtHand(this.world())},Morph.prototype.prompt=function(msg,callback,environment,defaultContents,width,floorNum,ceilingNum,isRounded){var menu,entryField,slider,isNumeric;ceilingNum&&(isNumeric=!0),
menu=new MenuMorph(callback||null,msg||"",environment||null),entryField=new StringFieldMorph(defaultContents||"",width||100,MorphicPreferences.prompterFontSize,MorphicPreferences.prompterFontName,!1,!1,isNumeric),menu.items.push(entryField),(ceilingNum||MorphicPreferences.useSliderForInput)&&(slider=new SliderMorph(floorNum||0,ceilingNum,parseFloat(defaultContents),Math.floor((ceilingNum-floorNum)/4),"horizontal"),slider.alpha=1,slider.color=new Color(225,225,225),slider.button.color=menu.borderColor,slider.button.highlightColor=slider.button.color.copy(),slider.button.highlightColor.b+=100,slider.button.pressColor=slider.button.color.copy(),slider.button.pressColor.b+=150,
slider.setHeight(MorphicPreferences.prompterSliderSize),isRounded?slider.action=function(num){entryField.changed(),entryField.text.text=Math.round(num).toString(),entryField.text.drawNew(),entryField.text.changed(),entryField.text.edit()}:slider.action=function(num){entryField.changed(),entryField.text.text=num.toString(),entryField.text.drawNew(),entryField.text.changed()},menu.items.push(slider)),menu.addLine(2),menu.addItem("Ok",function(){return entryField.string()}),menu.addItem("Cancel",function(){return null}),menu.isDraggable=!0,menu.popUpAtHand(this.world()),entryField.text.edit()},Morph.prototype.pickColor=function(msg,callback,environment,defaultContents){
var menu,colorPicker;menu=new MenuMorph(callback||null,msg||"",environment||null),colorPicker=new ColorPickerMorph(defaultContents),menu.items.push(colorPicker),menu.addLine(2),menu.addItem("Ok",function(){return colorPicker.getChoice()}),menu.addItem("Cancel",function(){return null}),menu.isDraggable=!0,menu.popUpAtHand(this.world())},Morph.prototype.inspect=function(anotherObject){var inspector,world=this.world instanceof Function?this.world():this.root()||this.world,inspectee=this;anotherObject&&(inspectee=anotherObject),inspector=new InspectorMorph(inspectee),inspector.setPosition(world.hand.position()),inspector.keepWithin(world),world.add(inspector),inspector.changed();
},Morph.prototype.contextMenu=function(){var world;return this.customContextMenu?this.customContextMenu:(world=this.world instanceof Function?this.world():this.world,world&&world.isDevMode?this.parent===world?this.developersMenu():this.hierarchyMenu():this.userMenu()||this.parent&&this.parent.userMenu())},Morph.prototype.hierarchyMenu=function(){var parents=this.allParents(),world=this.world instanceof Function?this.world():this.world,menu=new MenuMorph(this,null);return parents.forEach(function(each){each.developersMenu&&each!==world&&menu.addMenu(each.toString().slice(0,50),each.developersMenu())}),menu},Morph.prototype.developersMenu=function(){var world=this.world instanceof Function?this.world():this.world,userMenu=this.userMenu()||this.parent&&this.parent.userMenu(),menu=new MenuMorph(this,this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0]);
return userMenu&&(menu.addMenu("user features",userMenu),menu.addLine()),menu.addItem("color...",function(){this.pickColor(menu.title+localize("\ncolor:"),this.setColor,this,this.color)},"choose another color \nfor this morph"),menu.addItem("transparency...",function(){this.prompt(menu.title+localize("\nalpha\nvalue:"),this.setAlphaScaled,this,(100*this.alpha).toString(),null,1,100,!0)},"set this morph's\nalpha value"),menu.addItem("resize...","resize","show a handle\nwhich can be dragged\nto change this morph's extent"),menu.addLine(),menu.addItem("duplicate",function(){this.fullCopy().pickUp(this.world())},"make a copy\nand pick it up"),menu.addItem("pick up","pickUp","detach and put \ninto the hand"),
menu.addItem("attach...","attach","stick this morph\nto another one"),menu.addItem("move...","move","show a handle\nwhich can be dragged\nto move this morph"),menu.addItem("inspect...","inspect","open a window\non all properties"),menu.addItem("pic...",function(){window.open(this.fullImageClassic().toDataURL())},"open a new window\nwith a picture of this morph"),menu.addLine(),this.isDraggable?menu.addItem("lock","toggleIsDraggable","make this morph\nunmovable"):menu.addItem("unlock","toggleIsDraggable","make this morph\nmovable"),menu.addItem("hide","hide"),menu.addItem("delete","destroy"),this instanceof WorldMorph||(menu.addLine(),menu.addItem("World...",function(){
world.contextMenu().popUpAtHand(world)},"show the\nWorld's menu")),menu},Morph.prototype.userMenu=function(){return null},Morph.prototype.setAlphaScaled=function(alpha){var newAlpha,unscaled;"number"==typeof alpha?(unscaled=alpha/100,this.alpha=Math.min(Math.max(unscaled,.1),1)):(newAlpha=parseFloat(alpha),isNaN(newAlpha)||(unscaled=newAlpha/100,this.alpha=Math.min(Math.max(unscaled,.1),1))),this.changed()},Morph.prototype.attach=function(){var choices=this.overlappedMorphs(),menu=new MenuMorph(this,"choose new parent:"),myself=this;choices.forEach(function(each){menu.addItem(each.toString().slice(0,50),function(){each.add(myself),myself.isDraggable=!1})}),choices.length>0&&menu.popUpAtHand(this.world());
},Morph.prototype.toggleIsDraggable=function(){this.isDraggable=!this.isDraggable},Morph.prototype.colorSetters=function(){return["color"]},Morph.prototype.numericalSetters=function(){return["setLeft","setTop","setWidth","setHeight","setAlphaScaled"]},Morph.prototype.allEntryFields=function(){return this.allChildren().filter(function(each){return each.isEditable&&(each instanceof StringMorph||each instanceof TextMorph)})},Morph.prototype.nextEntryField=function(current){var fields=this.allEntryFields(),idx=fields.indexOf(current);return idx!==-1&&fields.length>idx+1?fields[idx+1]:fields[0]},Morph.prototype.previousEntryField=function(current){var fields=this.allEntryFields(),idx=fields.indexOf(current);
return idx!==-1?idx>0?fields[idx-1]:fields[fields.length-1]:fields[0]},Morph.prototype.tab=function(editField){this.nextTab?this.nextTab(editField):this.parent&&this.parent.tab(editField)},Morph.prototype.backTab=function(editField){this.previousTab?this.previousTab(editField):this.parent&&this.parent.backTab(editField)},Morph.prototype.escalateEvent=function(functionName,arg){for(var handler=this.parent;!handler[functionName]&&null!==handler.parent;)handler=handler.parent;handler[functionName]&&handler[functionName](arg)},Morph.prototype.evaluateString=function(code){var result;try{result=eval(code),this.drawNew(),this.changed()}catch(err){this.inform(err)}return result;
},Morph.prototype.isTouching=function(otherMorph){var data,oImg=this.overlappingImage(otherMorph);return!(!oImg.width||!oImg.height)&&(data=oImg.getContext("2d").getImageData(1,1,oImg.width,oImg.height).data,null!==detect(data,function(each){return 0!==each}))},Morph.prototype.overlappingImage=function(otherMorph){var fb=this.fullBounds(),otherFb=otherMorph.fullBounds(),oRect=fb.intersect(otherFb),oImg=newCanvas(oRect.extent()),ctx=oImg.getContext("2d");return oRect.width()<1||oRect.height()<1?newCanvas(new Point(1,1)):(ctx.drawImage(this.fullImage(),oRect.origin.x-fb.origin.x,oRect.origin.y-fb.origin.y),ctx.globalCompositeOperation="source-in",ctx.drawImage(otherMorph.fullImage(),otherFb.origin.x-oRect.origin.x,otherFb.origin.y-oRect.origin.y),
oImg)},ShadowMorph.prototype=new Morph,ShadowMorph.prototype.constructor=ShadowMorph,ShadowMorph.uber=Morph.prototype,ShadowMorph.prototype.topMorphAt=function(){return null},HandleMorph.prototype=new Morph,HandleMorph.prototype.constructor=HandleMorph,HandleMorph.uber=Morph.prototype,HandleMorph.prototype.init=function(target,minX,minY,insetX,insetY,type){var size=MorphicPreferences.handleSize;this.target=target||null,this.minExtent=new Point(minX||0,minY||0),this.inset=new Point(insetX||0,insetY||insetX||0),this.type=type||"resize",HandleMorph.uber.init.call(this),this.color=new Color(255,255,255),this.isDraggable=!1,this.noticesTransparentClick=!0,"movePivot"===this.type&&(size*=2),
this.setExtent(new Point(size,size))},HandleMorph.prototype.drawNew=function(){this.normalImage=newCanvas(this.extent()),this.highlightImage=newCanvas(this.extent()),"movePivot"===this.type?(this.drawCrosshairsOnCanvas(this.normalImage,.6),this.drawCrosshairsOnCanvas(this.highlightImage,.5)):(this.drawOnCanvas(this.normalImage,this.color,new Color(100,100,100)),this.drawOnCanvas(this.highlightImage,new Color(100,100,255),new Color(255,255,255))),this.image=this.normalImage,this.target&&("moveCenter"===this.type?this.setCenter(this.target.center()):"movePivot"===this.type?this.setCenter(this.target.rotationCenter()):this.setPosition(this.target.bottomRight().subtract(this.extent().add(this.inset))),
this.target.add(this),this.target.changed())},HandleMorph.prototype.drawCrosshairsOnCanvas=function(aCanvas,fract){var ctx=aCanvas.getContext("2d"),r=aCanvas.width/2;ctx.fillStyle="rgba(255, 255, 255, 0.5)",ctx.arc(r,r,.9*r,radians(0),radians(360),!1),ctx.fill(),ctx.strokeStyle="black",ctx.lineWidth=1,ctx.beginPath(),ctx.arc(r,r,r*fract,radians(0),radians(360),!1),ctx.stroke(),ctx.moveTo(0,r),ctx.lineTo(aCanvas.width,r),ctx.stroke(),ctx.moveTo(r,0),ctx.lineTo(r,aCanvas.height),ctx.stroke()},HandleMorph.prototype.drawOnCanvas=function(aCanvas,color,shadowColor){var p1,p11,p2,p22,i,context=aCanvas.getContext("2d"),isSquare=0===this.type.indexOf("move");if(context.lineWidth=1,
context.lineCap="round",context.strokeStyle=color.toString(),isSquare)for(p1=this.bottomLeft().subtract(this.position()),p11=p1.copy(),p2=this.topRight().subtract(this.position()),p22=p2.copy(),i=0;i<=this.height();i+=6)p11.y=p1.y-i,p22.y=p2.y-i,context.beginPath(),context.moveTo(p11.x,p11.y),context.lineTo(p22.x,p22.y),context.closePath(),context.stroke();for(p1=this.bottomLeft().subtract(this.position()),p11=p1.copy(),p2=this.topRight().subtract(this.position()),p22=p2.copy(),i=0;i<=this.width();i+=6)p11.x=p1.x+i,p22.x=p2.x+i,context.beginPath(),context.moveTo(p11.x,p11.y),context.lineTo(p22.x,p22.y),context.closePath(),context.stroke();if(context.strokeStyle=shadowColor.toString(),
isSquare)for(p1=this.bottomLeft().subtract(this.position()),p11=p1.copy(),p2=this.topRight().subtract(this.position()),p22=p2.copy(),i=-2;i<=this.height();i+=6)p11.y=p1.y-i,p22.y=p2.y-i,context.beginPath(),context.moveTo(p11.x,p11.y),context.lineTo(p22.x,p22.y),context.closePath(),context.stroke();for(p1=this.bottomLeft().subtract(this.position()),p11=p1.copy(),p2=this.topRight().subtract(this.position()),p22=p2.copy(),i=2;i<=this.width();i+=6)p11.x=p1.x+i,p22.x=p2.x+i,context.beginPath(),context.moveTo(p11.x,p11.y),context.lineTo(p22.x,p22.y),context.closePath(),context.stroke()},HandleMorph.prototype.step=null,HandleMorph.prototype.mouseDownLeft=function(pos){
var offset,world=this.root(),myself=this;return this.target?(offset=0===this.type.indexOf("move")?pos.subtract(this.center()):pos.subtract(this.bounds.origin),this.step=function(){var newPos,newExt;world.hand.mouseButton?(newPos=world.hand.bounds.origin.copy().subtract(offset),"resize"===this.type?(newExt=newPos.add(myself.extent().add(myself.inset)).subtract(myself.target.bounds.origin),newExt=newExt.max(myself.minExtent),myself.target.setExtent(newExt),myself.setPosition(myself.target.bottomRight().subtract(myself.extent().add(myself.inset)))):"moveCenter"===this.type?myself.target.setCenter(newPos):"movePivot"===this.type?(myself.target.setPivot(newPos),myself.setCenter(this.target.rotationCenter())):myself.target.setPosition(newPos.subtract(this.target.extent()).add(this.extent()))):this.step=null;
},void(this.target.step||(this.target.step=function(){nop()}))):null},HandleMorph.prototype.rootForGrab=function(){return this},HandleMorph.prototype.mouseEnter=function(){this.image=this.highlightImage,this.changed()},HandleMorph.prototype.mouseLeave=function(){this.image=this.normalImage,this.changed()},HandleMorph.prototype.attach=function(){var choices=this.overlappedMorphs(),menu=new MenuMorph(this,"choose target:"),myself=this;choices.forEach(function(each){menu.addItem(each.toString().slice(0,50),function(){myself.isDraggable=!1,myself.target=each,myself.drawNew(),myself.noticesTransparentClick=!0})}),choices.length>0&&menu.popUpAtHand(this.world())};var PenMorph;
PenMorph.prototype=new Morph,PenMorph.prototype.constructor=PenMorph,PenMorph.uber=Morph.prototype,PenMorph.prototype.init=function(){var size=4*MorphicPreferences.handleSize;this.isWarped=!1,this.heading=0,this.isDown=!0,this.size=1,this.wantsRedraw=!1,this.penPoint="tip",this.penBounds=null,HandleMorph.uber.init.call(this),this.setExtent(new Point(size,size))},PenMorph.prototype.changed=function(){if(this.isWarped===!1){var w=this.root();w instanceof WorldMorph&&w.broken.push(this.visibleBounds().spread()),this.parent&&this.parent.childChanged(this)}},PenMorph.prototype.drawNew=function(facing){var context,start,dest,left,right,len,direction=facing||this.heading;
return this.isWarped?void(this.wantsRedraw=!0):(this.image=newCanvas(this.extent()),context=this.image.getContext("2d"),len=this.width()/2,start=this.center().subtract(this.bounds.origin),"tip"===this.penPoint?(dest=start.distanceAngle(.75*len,direction-180),left=start.distanceAngle(len,direction+195),right=start.distanceAngle(len,direction-195)):(dest=start.distanceAngle(.75*len,direction),left=start.distanceAngle(.33*len,direction+230),right=start.distanceAngle(.33*len,direction-230)),this.penBounds=new Rectangle(Math.min(start.x,dest.x,left.x,right.x),Math.min(start.y,dest.y,left.y,right.y),Math.max(start.x,dest.x,left.x,right.x),Math.max(start.y,dest.y,left.y,right.y)),
context.fillStyle=this.color.toString(),context.beginPath(),context.moveTo(start.x,start.y),context.lineTo(left.x,left.y),context.lineTo(dest.x,dest.y),context.lineTo(right.x,right.y),context.closePath(),context.strokeStyle="white",context.lineWidth=3,context.stroke(),context.strokeStyle="black",context.lineWidth=1,context.stroke(),void context.fill())},PenMorph.prototype.setHeading=function(degrees){this.heading=(+degrees%360+360)%360,this.drawNew(),this.changed()},PenMorph.prototype.drawLine=function(start,dest){var context=this.parent.penTrails().getContext("2d"),from=start.subtract(this.parent.bounds.origin),to=dest.subtract(this.parent.bounds.origin);this.isDown&&(context.lineWidth=this.size,
context.strokeStyle=this.color.toString(),context.lineCap="round",context.lineJoin="round",context.beginPath(),context.moveTo(from.x,from.y),context.lineTo(to.x,to.y),context.stroke(),this.isWarped===!1&&this.world().broken.push(start.rectangle(dest).expandBy(Math.max(this.size/2,1)).intersect(this.parent.visibleBounds()).spread()))},PenMorph.prototype.turn=function(degrees){this.setHeading(this.heading+parseFloat(degrees))},PenMorph.prototype.forward=function(steps){var dest,start=this.center(),dist=parseFloat(steps);dest=dist>=0?this.position().distanceAngle(dist,this.heading):this.position().distanceAngle(Math.abs(dist),this.heading-180),this.setPosition(dest),
this.drawLine(start,this.center())},PenMorph.prototype.down=function(){this.isDown=!0},PenMorph.prototype.up=function(){this.isDown=!1},PenMorph.prototype.clear=function(){this.parent.drawNew(),this.parent.changed()},PenMorph.prototype.startWarp=function(){this.wantsRedraw=!1,this.isWarped=!0},PenMorph.prototype.endWarp=function(){this.isWarped=!1,this.wantsRedraw&&(this.drawNew(),this.wantsRedraw=!1),this.parent.changed()},PenMorph.prototype.warp=function(fun){this.startWarp(),fun.call(this),this.endWarp()},PenMorph.prototype.warpOp=function(selector,argsArray){this.startWarp(),this[selector].apply(this,argsArray),this.endWarp()},PenMorph.prototype.warpSierpinski=function(length,min){
this.warpOp("sierpinski",[length,min])},PenMorph.prototype.sierpinski=function(length,min){var i;if(length>min)for(i=0;i<3;i+=1)this.sierpinski(.5*length,min),this.turn(120),this.forward(length)},PenMorph.prototype.warpTree=function(level,length,angle){this.warpOp("tree",[level,length,angle])},PenMorph.prototype.tree=function(level,length,angle){level>0&&(this.size=level,this.forward(length),this.turn(angle),this.tree(level-1,.75*length,angle),this.turn(angle*-2),this.tree(level-1,.75*length,angle),this.turn(angle),this.forward(-length))};var ColorPaletteMorph;ColorPaletteMorph.prototype=new Morph,ColorPaletteMorph.prototype.constructor=ColorPaletteMorph,ColorPaletteMorph.uber=Morph.prototype,
ColorPaletteMorph.prototype.init=function(target,size){ColorPaletteMorph.uber.init.call(this),this.target=target,this.targetSetter="color",this.silentSetExtent(size),this.choice=null,this.drawNew()},ColorPaletteMorph.prototype.drawNew=function(){var context,ext,x,y,h,l;for(ext=this.extent(),this.image=newCanvas(this.extent()),context=this.image.getContext("2d"),this.choice=new Color,x=0;x<=ext.x;x+=1)for(h=360*x/ext.x,y=0;y<=ext.y;y+=1)l=100-y/ext.y*100,context.fillStyle="hsl("+h+",100%,"+l+"%)",context.fillRect(x,y,1,1)},ColorPaletteMorph.prototype.mouseMove=function(pos){this.choice=this.getPixelColor(pos),this.updateTarget()},ColorPaletteMorph.prototype.mouseDownLeft=function(pos){
this.choice=this.getPixelColor(pos),this.updateTarget()},ColorPaletteMorph.prototype.updateTarget=function(){this.target instanceof Morph&&null!==this.choice&&(this.target[this.targetSetter]instanceof Function?this.target[this.targetSetter](this.choice):(this.target[this.targetSetter]=this.choice,this.target.drawNew(),this.target.changed()))},ColorPaletteMorph.prototype.developersMenu=function(){var menu=ColorPaletteMorph.uber.developersMenu.call(this);return menu.addLine(),menu.addItem("set target","setTarget","choose another morph\nwhose color property\n will be controlled by this one"),menu},ColorPaletteMorph.prototype.setTarget=function(){var choices=this.overlappedMorphs(),menu=new MenuMorph(this,"choose target:"),myself=this;
choices.push(this.world()),choices.forEach(function(each){menu.addItem(each.toString().slice(0,50),function(){myself.target=each,myself.setTargetSetter()})}),1===choices.length?(this.target=choices[0],this.setTargetSetter()):choices.length>0&&menu.popUpAtHand(this.world())},ColorPaletteMorph.prototype.setTargetSetter=function(){var choices=this.target.colorSetters(),menu=new MenuMorph(this,"choose target property:"),myself=this;choices.forEach(function(each){menu.addItem(each,function(){myself.targetSetter=each})}),1===choices.length?this.targetSetter=choices[0]:choices.length>0&&menu.popUpAtHand(this.world())};var GrayPaletteMorph;GrayPaletteMorph.prototype=new ColorPaletteMorph,
GrayPaletteMorph.prototype.constructor=GrayPaletteMorph,GrayPaletteMorph.uber=ColorPaletteMorph.prototype,GrayPaletteMorph.prototype.drawNew=function(){var context,ext,gradient;ext=this.extent(),this.image=newCanvas(this.extent()),context=this.image.getContext("2d"),this.choice=new Color,gradient=context.createLinearGradient(0,0,ext.x,ext.y),gradient.addColorStop(0,"black"),gradient.addColorStop(1,"white"),context.fillStyle=gradient,context.fillRect(0,0,ext.x,ext.y)},ColorPickerMorph.prototype=new Morph,ColorPickerMorph.prototype.constructor=ColorPickerMorph,ColorPickerMorph.uber=Morph.prototype,ColorPickerMorph.prototype.init=function(defaultColor){this.choice=defaultColor,
ColorPickerMorph.uber.init.call(this),this.color=new Color(255,255,255),this.silentSetExtent(new Point(80,80)),this.drawNew()},ColorPickerMorph.prototype.drawNew=function(){ColorPickerMorph.uber.drawNew.call(this),this.buildSubmorphs()},ColorPickerMorph.prototype.buildSubmorphs=function(){var cpal,gpal,x,y;this.children.forEach(function(child){child.destroy()}),this.children=[],this.feedback=new Morph,this.feedback.color=this.choice,this.feedback.setExtent(new Point(20,20)),cpal=new ColorPaletteMorph(this.feedback,new Point(this.width(),50)),gpal=new GrayPaletteMorph(this.feedback,new Point(this.width(),5)),cpal.setPosition(this.bounds.origin),this.add(cpal),
gpal.setPosition(cpal.bottomLeft()),this.add(gpal),x=gpal.left()+Math.floor((gpal.width()-this.feedback.width())/2),y=gpal.bottom()+Math.floor((this.bottom()-gpal.bottom()-this.feedback.height())/2),this.feedback.setPosition(new Point(x,y)),this.add(this.feedback)},ColorPickerMorph.prototype.getChoice=function(){return this.feedback.color},ColorPickerMorph.prototype.rootForGrab=function(){return this};var BlinkerMorph;BlinkerMorph.prototype=new Morph,BlinkerMorph.prototype.constructor=BlinkerMorph,BlinkerMorph.uber=Morph.prototype,BlinkerMorph.prototype.init=function(rate){BlinkerMorph.uber.init.call(this),this.color=new Color(0,0,0),this.fps=rate||2,this.drawNew();
},BlinkerMorph.prototype.step=function(){this.toggleVisibility()};var CursorMorph;CursorMorph.prototype=new BlinkerMorph,CursorMorph.prototype.constructor=CursorMorph,CursorMorph.uber=BlinkerMorph.prototype,CursorMorph.prototype.viewPadding=1,CursorMorph.prototype.init=function(aStringOrTextMorph){var ls;this.keyDownEventUsed=!1,this.target=aStringOrTextMorph,this.originalContents=this.target.text,this.originalAlignment=this.target.alignment,this.slot=this.target.text.length,CursorMorph.uber.init.call(this),ls=fontHeight(this.target.fontSize),this.setExtent(new Point(Math.max(Math.floor(ls/20),1),ls)),this.drawNew(),this.image.getContext("2d").font=this.target.font(),
this.target instanceof TextMorph&&"left"!==this.target.alignment&&this.target.setAlignmentToLeft(),this.gotoSlot(this.slot),this.initializeClipboardHandler()},CursorMorph.prototype.initializeClipboardHandler=function(){var myself=this,wrrld=this.target.world();this.clipboardHandler=document.createElement("textarea"),this.clipboardHandler.style.position="absolute",this.clipboardHandler.style.top=window.outerHeight,this.clipboardHandler.style.right="101%",document.body.appendChild(this.clipboardHandler),this.clipboardHandler.value=this.target.selection(),this.clipboardHandler.focus(),this.clipboardHandler.select(),this.clipboardHandler.addEventListener("keypress",function(event){
myself.processKeyPress(event),this.value=myself.target.selection(),this.select()},!1),this.clipboardHandler.addEventListener("keydown",function(event){myself.processKeyDown(event),event.shiftKey&&(wrrld.currentKey=16),this.value=myself.target.selection(),this.select(),"U+0009"!==event.key&&"Tab"!==event.key||(myself.processKeyPress(event),event.preventDefault())},!1),this.clipboardHandler.addEventListener("keyup",function(event){wrrld.currentKey=null},!1),this.clipboardHandler.addEventListener("input",function(event){""===this.value&&(myself.gotoSlot(myself.target.selectionStartSlot()),myself.target.deleteSelection())},!1)},CursorMorph.prototype.processKeyPress=function(event){
return this.keyDownEventUsed?(this.keyDownEventUsed=!1,null):40===event.keyCode||40===event.charCode?(this.insert("("),null):37===event.keyCode||37===event.charCode?(this.insert("%"),null):(event.keyCode?event.ctrlKey&&!event.altKey?this.ctrl(event.keyCode,event.shiftKey):event.metaKey?this.cmd(event.keyCode,event.shiftKey):this.insert(String.fromCharCode(event.keyCode),event.shiftKey):event.charCode&&(event.ctrlKey&&!event.altKey?this.ctrl(event.charCode,event.shiftKey):event.metaKey?this.cmd(event.charCode,event.shiftKey):this.insert(String.fromCharCode(event.charCode),event.shiftKey)),void this.target.escalateEvent("reactToKeystroke",event))},CursorMorph.prototype.processKeyDown=function(event){
var shift=event.shiftKey,wordNavigation=event.ctrlKey||event.altKey,selecting=this.target.selection().length>0;switch(this.keyDownEventUsed=!1,event.ctrlKey&&!event.altKey&&(this.ctrl(event.keyCode,event.shiftKey),this.target.escalateEvent("reactToKeystroke",event)),event.metaKey&&(this.cmd(event.keyCode,event.shiftKey),this.target.escalateEvent("reactToKeystroke",event)),event.keyCode){case 37:!selecting||shift||wordNavigation?this.goLeft(shift,wordNavigation?this.slot-this.target.previousWordFrom(this.slot):1):(this.gotoSlot(Math.min(this.target.startMark,this.target.endMark)),this.target.clearSelection()),this.keyDownEventUsed=!0;break;case 39:!selecting||shift||wordNavigation?this.goRight(shift,wordNavigation?this.target.nextWordFrom(this.slot)-this.slot:1):(this.gotoSlot(Math.max(this.target.startMark,this.target.endMark)),
this.target.clearSelection()),this.keyDownEventUsed=!0;break;case 38:this.goUp(shift),this.keyDownEventUsed=!0;break;case 40:this.goDown(shift),this.keyDownEventUsed=!0;break;case 36:this.goHome(shift),this.keyDownEventUsed=!0;break;case 35:this.goEnd(shift),this.keyDownEventUsed=!0;break;case 46:this.deleteRight(),this.keyDownEventUsed=!0;break;case 8:this.deleteLeft(),this.keyDownEventUsed=!0;break;case 13:this.target instanceof StringMorph||shift?this.accept():this.insert("\n"),this.keyDownEventUsed=!0;break;case 27:this.cancel(),this.keyDownEventUsed=!0;break;default:nop()}this.target.escalateEvent("reactToKeystroke",event)},CursorMorph.prototype.gotoSlot=function(slot){
var right,left,length=this.target.text.length,pos=this.target.slotPosition(slot);this.slot=slot<0?0:slot>length?length:slot,this.parent&&this.target.isScrollable&&(right=this.parent.right()-this.viewPadding,left=this.parent.left()+this.viewPadding,pos.x>right&&(this.target.setLeft(this.target.left()+right-pos.x),pos.x=right),pos.x<left&&(left=Math.min(this.parent.left(),left),this.target.setLeft(this.target.left()+left-pos.x),pos.x=left),this.target.right()<right&&right-this.target.width()<left&&(pos.x+=right-this.target.right(),this.target.setRight(right))),this.show(),this.setPosition(pos),this.parent&&this.parent.parent instanceof ScrollFrameMorph&&this.target.isScrollable&&this.parent.parent.scrollCursorIntoView(this);
},CursorMorph.prototype.goLeft=function(shift,howMany){this.updateSelection(shift),this.gotoSlot(this.slot-(howMany||1)),this.updateSelection(shift)},CursorMorph.prototype.goRight=function(shift,howMany){this.updateSelection(shift),this.gotoSlot(this.slot+(howMany||1)),this.updateSelection(shift)},CursorMorph.prototype.goUp=function(shift){this.updateSelection(shift),this.gotoSlot(this.target.upFrom(this.slot)),this.updateSelection(shift)},CursorMorph.prototype.goDown=function(shift){this.updateSelection(shift),this.gotoSlot(this.target.downFrom(this.slot)),this.updateSelection(shift)},CursorMorph.prototype.goHome=function(shift){this.updateSelection(shift),this.gotoSlot(this.target.startOfLine(this.slot)),
this.updateSelection(shift)},CursorMorph.prototype.goEnd=function(shift){this.updateSelection(shift),this.gotoSlot(this.target.endOfLine(this.slot)),this.updateSelection(shift)},CursorMorph.prototype.gotoPos=function(aPoint){this.gotoSlot(this.target.slotAt(aPoint)),this.show()},CursorMorph.prototype.updateSelection=function(shift){shift?isNil(this.target.endMark)&&isNil(this.target.startMark)?(this.target.startMark=this.slot,this.target.endMark=this.slot):this.target.endMark!==this.slot&&(this.target.endMark=this.slot,this.target.drawNew(),this.target.changed()):this.target.clearSelection()},CursorMorph.prototype.accept=function(){var world=this.root();world&&world.stopEditing(),
this.escalateEvent("accept",this)},CursorMorph.prototype.cancel=function(){var world=this.root();this.undo(),world&&world.stopEditing(),this.escalateEvent("cancel",this)},CursorMorph.prototype.undo=function(){this.target.text=this.originalContents,this.target.changed(),this.target.drawNew(),this.target.changed(),this.gotoSlot(0)},CursorMorph.prototype.insert=function(aChar,shiftKey){var text;return"\t"===aChar?(this.target.escalateEvent("reactToEdit",this.target),shiftKey?this.target.backTab(this.target):this.target.tab(this.target)):void(this.target.isNumeric&&isNaN(parseFloat(aChar))&&!contains(["-","."],aChar)||(""!==this.target.selection()&&(this.gotoSlot(this.target.selectionStartSlot()),
this.target.deleteSelection()),text=this.target.text,text=text.slice(0,this.slot)+aChar+text.slice(this.slot),this.target.text=text,this.target.drawNew(),this.target.changed(),this.goRight(!1,aChar.length)))},CursorMorph.prototype.ctrl=function(aChar,shiftKey){64===aChar||65===aChar&&shiftKey?this.insert("@"):65===aChar?this.target.selectAll():90===aChar?this.undo():123===aChar?this.insert("{"):125===aChar?this.insert("}"):91===aChar?this.insert("["):93===aChar?this.insert("]"):isNil(this.target.receiver)||(68===aChar?this.target.doIt():73===aChar?this.target.inspectIt():80===aChar&&this.target.showIt())},CursorMorph.prototype.cmd=function(aChar,shiftKey){64===aChar||65===aChar&&shiftKey?this.insert("@"):65===aChar?this.target.selectAll():90===aChar?this.undo():isNil(this.target.receiver)||(68===aChar?this.target.doIt():73===aChar?this.target.inspectIt():80===aChar&&this.target.showIt());
},CursorMorph.prototype.deleteRight=function(){var text;""!==this.target.selection()?(this.gotoSlot(this.target.selectionStartSlot()),this.target.deleteSelection()):(text=this.target.text,this.target.changed(),text=text.slice(0,this.slot)+text.slice(this.slot+1),this.target.text=text,this.target.drawNew())},CursorMorph.prototype.deleteLeft=function(){var text;return this.target.selection()?(this.gotoSlot(this.target.selectionStartSlot()),this.target.deleteSelection()):(text=this.target.text,this.target.changed(),this.target.text=text.substring(0,this.slot-1)+text.substr(this.slot),this.target.drawNew(),void this.goLeft())},CursorMorph.prototype.destroy=function(){
this.target.alignment!==this.originalAlignment&&(this.target.alignment=this.originalAlignment,this.target.drawNew(),this.target.changed()),this.destroyClipboardHandler(),CursorMorph.uber.destroy.call(this)},CursorMorph.prototype.destroyClipboardHandler=function(){var each,i,nodes=document.body.children;if(this.clipboardHandler)for(i=0;i<nodes.length;i+=1)each=nodes[i],each===this.clipboardHandler&&(document.body.removeChild(this.clipboardHandler),this.clipboardHandler=null)},CursorMorph.prototype.inspectKeyEvent=function(event){this.inform("Key pressed: "+String.fromCharCode(event.charCode)+"\n------------------------\ncharCode: "+event.charCode.toString()+"\nkeyCode: "+event.keyCode.toString()+"\nshiftKey: "+event.shiftKey.toString()+"\naltKey: "+event.altKey.toString()+"\nctrlKey: "+event.ctrlKey.toString()+"\ncmdKey: "+event.metaKey.toString());
};var BoxMorph;BoxMorph.prototype=new Morph,BoxMorph.prototype.constructor=BoxMorph,BoxMorph.uber=Morph.prototype,BoxMorph.prototype.init=function(edge,border,borderColor){this.edge=edge||4,this.border=border||(0===border?0:2),this.borderColor=borderColor||new Color,BoxMorph.uber.init.call(this)},BoxMorph.prototype.drawNew=function(){var context;return this.image=newCanvas(this.extent()),context=this.image.getContext("2d"),0===this.edge&&0===this.border?(BoxMorph.uber.drawNew.call(this),null):(context.fillStyle=this.color.toString(),context.beginPath(),this.outlinePath(context,Math.max(this.edge-this.border,0),this.border),context.closePath(),context.fill(),void(this.border>0&&(context.lineWidth=this.border,
context.strokeStyle=this.borderColor.toString(),context.beginPath(),this.outlinePath(context,this.edge,this.border/2),context.closePath(),context.stroke())))},BoxMorph.prototype.outlinePath=function(context,radius,inset){var offset=radius+inset,w=this.width(),h=this.height();context.arc(offset,offset,radius,radians(-180),radians(-90),!1),context.arc(w-offset,offset,radius,radians(-90),radians(-0),!1),context.arc(w-offset,h-offset,radius,radians(0),radians(90),!1),context.arc(offset,h-offset,radius,radians(90),radians(180),!1)},BoxMorph.prototype.developersMenu=function(){var menu=BoxMorph.uber.developersMenu.call(this);return menu.addLine(),menu.addItem("border width...",function(){
this.prompt(menu.title+"\nborder\nwidth:",this.setBorderWidth,this,this.border.toString(),null,0,100,!0)},"set the border's\nline size"),menu.addItem("border color...",function(){this.pickColor(menu.title+"\nborder color:",this.setBorderColor,this,this.borderColor)},"set the border's\nline color"),menu.addItem("corner size...",function(){this.prompt(menu.title+"\ncorner\nsize:",this.setCornerSize,this,this.edge.toString(),null,0,100,!0)},"set the corner's\nradius"),menu},BoxMorph.prototype.setBorderWidth=function(size){var newSize;"number"==typeof size?this.border=Math.max(size,0):(newSize=parseFloat(size),isNaN(newSize)||(this.border=Math.max(newSize,0))),this.drawNew(),
this.changed()},BoxMorph.prototype.setBorderColor=function(color){color&&(this.borderColor=color,this.drawNew(),this.changed())},BoxMorph.prototype.setCornerSize=function(size){var newSize;"number"==typeof size?this.edge=Math.max(size,0):(newSize=parseFloat(size),isNaN(newSize)||(this.edge=Math.max(newSize,0))),this.drawNew(),this.changed()},BoxMorph.prototype.colorSetters=function(){return["color","borderColor"]},BoxMorph.prototype.numericalSetters=function(){var list=BoxMorph.uber.numericalSetters.call(this);return list.push("setBorderWidth","setCornerSize"),list};var SpeechBubbleMorph;SpeechBubbleMorph.prototype=new BoxMorph,SpeechBubbleMorph.prototype.constructor=SpeechBubbleMorph,
SpeechBubbleMorph.uber=BoxMorph.prototype,SpeechBubbleMorph.prototype.init=function(contents,color,edge,border,borderColor,padding,isThought){this.isPointingRight=!0,this.contents=contents||"",this.padding=padding||0,this.isThought=isThought||!1,this.isClickable=!1,SpeechBubbleMorph.uber.init.call(this,edge||6,border||(0===border?0:1),borderColor||new Color(140,140,140)),this.color=color||new Color(230,230,230),this.drawNew()},SpeechBubbleMorph.prototype.popUp=function(world,pos,isClickable){this.drawNew(),this.setPosition(pos.subtract(new Point(0,this.height()))),this.addShadow(new Point(2,2),80),this.keepWithin(world),world.add(this),this.fullChanged(),world.hand.destroyTemporaries(),
world.hand.temporaries.push(this),isClickable?this.isClickable=!0:this.mouseEnter=function(){this.destroy()}},SpeechBubbleMorph.prototype.drawNew=function(){this.contentsMorph&&this.contentsMorph.destroy(),this.contents instanceof Morph?this.contentsMorph=this.contents:isString(this.contents)?this.contentsMorph=new TextMorph(this.contents,MorphicPreferences.bubbleHelpFontSize,null,!1,!0,"center"):this.contents instanceof HTMLCanvasElement?(this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(this.contents.width),this.contentsMorph.silentSetHeight(this.contents.height),this.contentsMorph.image=this.contents):this.contentsMorph=new TextMorph(this.contents.toString(),MorphicPreferences.bubbleHelpFontSize,null,!1,!0,"center"),
this.add(this.contentsMorph),this.silentSetWidth(this.contentsMorph.width()+(this.padding?2*this.padding:2*this.edge)),this.silentSetHeight(this.contentsMorph.height()+this.edge+2*this.border+2*this.padding+2),SpeechBubbleMorph.uber.drawNew.call(this),this.contentsMorph.setPosition(this.position().add(new Point(this.padding||this.edge,this.border+this.padding+1)))},SpeechBubbleMorph.prototype.outlinePath=function(context,radius,inset){function circle(x,y,r){context.moveTo(x+r,y),context.arc(x,y,r,radians(0),radians(360))}var rad,offset=radius+inset,w=this.width(),h=this.height();context.arc(offset,offset,radius,radians(-180),radians(-90),!1),context.arc(w-offset,offset,radius,radians(-90),radians(-0),!1),
context.arc(w-offset,h-offset-radius,radius,radians(0),radians(90),!1),this.isThought||(this.isPointingRight?(context.lineTo(offset+radius,h-offset),context.lineTo(radius/2+inset,h-inset)):(context.lineTo(w-(radius/2+inset),h-inset),context.lineTo(w-(offset+radius),h-offset))),context.arc(offset,h-offset-radius,radius,radians(90),radians(180),!1),this.isThought===!0&&(context.lineTo(inset,offset),this.isPointingRight?(rad=radius/4,circle(rad+inset,h-rad-inset,rad),rad=radius/3.2,circle(2*rad+inset,h-rad-2*inset,rad),rad=radius/2.8,circle(3*rad+2*inset,h-rad-4*inset,rad)):(rad=radius/4,circle(w-(rad+inset),h-rad-inset,rad),rad=radius/3.2,circle(w-(2*rad+inset),h-rad-2*inset,rad),
rad=radius/2.8,circle(w-(3*rad+2*inset),h-rad-4*inset,rad)))},SpeechBubbleMorph.prototype.shadowImage=function(off,color){var fb,img,outline,sha,ctx,offset=off||new Point(7,7),clr=color||new Color(0,0,0);return fb=this.extent(),img=this.image,outline=newCanvas(fb),ctx=outline.getContext("2d"),ctx.drawImage(img,0,0),ctx.globalCompositeOperation="destination-out",ctx.drawImage(img,-offset.x,-offset.y),sha=newCanvas(fb),ctx=sha.getContext("2d"),ctx.drawImage(outline,0,0),ctx.globalCompositeOperation="source-atop",ctx.fillStyle=clr.toString(),ctx.fillRect(0,0,fb.x,fb.y),sha},SpeechBubbleMorph.prototype.shadowImageBlurred=function(off,color){var fb,img,sha,ctx,offset=off||new Point(7,7),blur=this.shadowBlur,clr=color||new Color(0,0,0);
return fb=this.extent().add(2*blur),img=this.image,sha=newCanvas(fb),ctx=sha.getContext("2d"),ctx.shadowOffsetX=offset.x,ctx.shadowOffsetY=offset.y,ctx.shadowBlur=blur,ctx.shadowColor=clr.toString(),ctx.drawImage(img,blur-offset.x,blur-offset.y),ctx.shadowOffsetX=0,ctx.shadowOffsetY=0,ctx.shadowBlur=0,ctx.globalCompositeOperation="destination-out",ctx.drawImage(img,blur-offset.x,blur-offset.y),sha},SpeechBubbleMorph.prototype.fixLayout=function(){this.removeShadow(),this.drawNew(),this.addShadow(new Point(2,2),80)};var CircleBoxMorph;CircleBoxMorph.prototype=new Morph,CircleBoxMorph.prototype.constructor=CircleBoxMorph,CircleBoxMorph.uber=Morph.prototype,CircleBoxMorph.prototype.init=function(orientation){
CircleBoxMorph.uber.init.call(this),this.orientation=orientation,this.autoOrient=!0,this.setExtent(new Point(20,100))},CircleBoxMorph.prototype.autoOrientation=function(){this.height()>this.width()?this.orientation="vertical":this.orientation="horizontal"},CircleBoxMorph.prototype.drawNew=function(){var radius,center1,center2,rect,points,x,y,context,ext,myself=this;this.autoOrient&&this.autoOrientation(),this.image=newCanvas(this.extent()),context=this.image.getContext("2d"),"vertical"===this.orientation?(radius=this.width()/2,x=this.center().x,center1=new Point(x,this.top()+radius),center2=new Point(x,this.bottom()-radius),rect=this.bounds.origin.add(new Point(0,radius)).corner(this.bounds.corner.subtract(new Point(0,radius)))):(radius=this.height()/2,
y=this.center().y,center1=new Point(this.left()+radius,y),center2=new Point(this.right()-radius,y),rect=this.bounds.origin.add(new Point(radius,0)).corner(this.bounds.corner.subtract(new Point(radius,0)))),points=[center1.subtract(this.bounds.origin),center2.subtract(this.bounds.origin)],points.forEach(function(center){context.fillStyle=myself.color.toString(),context.beginPath(),context.arc(center.x,center.y,radius,0,2*Math.PI,!1),context.closePath(),context.fill()}),rect=rect.translateBy(this.bounds.origin.neg()),ext=rect.extent(),ext.x>0&&ext.y>0&&context.fillRect(rect.origin.x,rect.origin.y,rect.width(),rect.height())},CircleBoxMorph.prototype.developersMenu=function(){
var menu=CircleBoxMorph.uber.developersMenu.call(this);return menu.addLine(),"vertical"===this.orientation?menu.addItem("horizontal...","toggleOrientation","toggle the\norientation"):menu.addItem("vertical...","toggleOrientation","toggle the\norientation"),menu},CircleBoxMorph.prototype.toggleOrientation=function(){var center=this.center();this.changed(),"vertical"===this.orientation?this.orientation="horizontal":this.orientation="vertical",this.silentSetExtent(new Point(this.height(),this.width())),this.setCenter(center),this.drawNew(),this.changed()};var SliderButtonMorph;SliderButtonMorph.prototype=new CircleBoxMorph,SliderButtonMorph.prototype.constructor=SliderButtonMorph,
SliderButtonMorph.uber=CircleBoxMorph.prototype,SliderButtonMorph.prototype.init=function(orientation){this.color=new Color(80,80,80),this.highlightColor=new Color(90,90,140),this.pressColor=new Color(80,80,160),this.is3D=!1,this.hasMiddleDip=!0,SliderButtonMorph.uber.init.call(this,orientation)},SliderButtonMorph.prototype.autoOrientation=nop,SliderButtonMorph.prototype.drawNew=function(){var colorBak=this.color.copy();SliderButtonMorph.uber.drawNew.call(this),!this.is3D&&MorphicPreferences.isFlat||this.drawEdges(),this.normalImage=this.image,this.color=this.highlightColor.copy(),SliderButtonMorph.uber.drawNew.call(this),!this.is3D&&MorphicPreferences.isFlat||this.drawEdges(),
this.highlightImage=this.image,this.color=this.pressColor.copy(),SliderButtonMorph.uber.drawNew.call(this),!this.is3D&&MorphicPreferences.isFlat||this.drawEdges(),this.pressImage=this.image,this.color=colorBak,this.image=this.normalImage},SliderButtonMorph.prototype.drawEdges=function(){var gradient,radius,context=this.image.getContext("2d"),w=this.width(),h=this.height();context.lineJoin="round",context.lineCap="round","vertical"===this.orientation?(context.lineWidth=w/3,gradient=context.createLinearGradient(0,0,context.lineWidth,0),gradient.addColorStop(0,"white"),gradient.addColorStop(1,this.color.toString()),context.strokeStyle=gradient,context.beginPath(),
context.moveTo(.5*context.lineWidth,w/2),context.lineTo(.5*context.lineWidth,h-w/2),context.stroke(),gradient=context.createLinearGradient(w-context.lineWidth,0,w,0),gradient.addColorStop(0,this.color.toString()),gradient.addColorStop(1,"black"),context.strokeStyle=gradient,context.beginPath(),context.moveTo(w-.5*context.lineWidth,w/2),context.lineTo(w-.5*context.lineWidth,h-w/2),context.stroke(),this.hasMiddleDip&&(gradient=context.createLinearGradient(context.lineWidth,0,w-context.lineWidth,0),radius=w/4,gradient.addColorStop(0,"black"),gradient.addColorStop(.35,this.color.toString()),gradient.addColorStop(.65,this.color.toString()),gradient.addColorStop(1,"white"),
context.fillStyle=gradient,context.beginPath(),context.arc(w/2,h/2,radius,radians(0),radians(360),!1),context.closePath(),context.fill())):"horizontal"===this.orientation&&(context.lineWidth=h/3,gradient=context.createLinearGradient(0,0,0,context.lineWidth),gradient.addColorStop(0,"white"),gradient.addColorStop(1,this.color.toString()),context.strokeStyle=gradient,context.beginPath(),context.moveTo(h/2,.5*context.lineWidth),context.lineTo(w-h/2,.5*context.lineWidth),context.stroke(),gradient=context.createLinearGradient(0,h-context.lineWidth,0,h),gradient.addColorStop(0,this.color.toString()),gradient.addColorStop(1,"black"),context.strokeStyle=gradient,context.beginPath(),
context.moveTo(h/2,h-.5*context.lineWidth),context.lineTo(w-h/2,h-.5*context.lineWidth),context.stroke(),this.hasMiddleDip&&(gradient=context.createLinearGradient(0,context.lineWidth,0,h-context.lineWidth),radius=h/4,gradient.addColorStop(0,"black"),gradient.addColorStop(.35,this.color.toString()),gradient.addColorStop(.65,this.color.toString()),gradient.addColorStop(1,"white"),context.fillStyle=gradient,context.beginPath(),context.arc(this.width()/2,this.height()/2,radius,radians(0),radians(360),!1),context.closePath(),context.fill()))},SliderButtonMorph.prototype.mouseEnter=function(){this.image=this.highlightImage,this.changed()},SliderButtonMorph.prototype.mouseLeave=function(){
this.image=this.normalImage,this.changed()},SliderButtonMorph.prototype.mouseDownLeft=function(pos){this.image=this.pressImage,this.changed(),this.escalateEvent("mouseDownLeft",pos)},SliderButtonMorph.prototype.mouseClickLeft=function(){this.image=this.highlightImage,this.changed()},SliderButtonMorph.prototype.mouseMove=function(){nop()},SliderMorph.prototype=new CircleBoxMorph,SliderMorph.prototype.constructor=SliderMorph,SliderMorph.uber=CircleBoxMorph.prototype,SliderMorph.prototype.init=function(start,stop,value,size,orientation,color){this.target=null,this.action=null,this.start=start,this.stop=stop,this.value=value,this.size=size,this.offset=null,this.button=new SliderButtonMorph,
this.button.isDraggable=!1,this.button.color=new Color(200,200,200),this.button.highlightColor=new Color(210,210,255),this.button.pressColor=new Color(180,180,255),SliderMorph.uber.init.call(this,orientation),this.add(this.button),this.alpha=.3,this.color=color||new Color(0,0,0),this.setExtent(new Point(20,100))},SliderMorph.prototype.autoOrientation=nop,SliderMorph.prototype.rangeSize=function(){return this.stop-this.start},SliderMorph.prototype.ratio=function(){return this.size/(this.rangeSize()+1)},SliderMorph.prototype.unitSize=function(){return"vertical"===this.orientation?(this.height()-this.button.height())/this.rangeSize():(this.width()-this.button.width())/this.rangeSize();
},SliderMorph.prototype.drawNew=function(){var bw,bh,posX,posY;SliderMorph.uber.drawNew.call(this),this.button.orientation=this.orientation,"vertical"===this.orientation?(bw=this.width()-2,bh=Math.max(bw,Math.round(this.height()*this.ratio())),this.button.silentSetExtent(new Point(bw,bh)),posX=1,posY=Math.min(Math.round((this.value-this.start)*this.unitSize()),this.height()-this.button.height())):(bh=this.height()-2,bw=Math.max(bh,Math.round(this.width()*this.ratio())),this.button.silentSetExtent(new Point(bw,bh)),posY=1,posX=Math.min(Math.round((this.value-this.start)*this.unitSize()),this.width()-this.button.width())),this.button.setPosition(new Point(posX,posY).add(this.bounds.origin)),
this.button.drawNew(),this.button.changed()},SliderMorph.prototype.updateValue=function(){var relPos;relPos="vertical"===this.orientation?this.button.top()-this.top():this.button.left()-this.left(),this.value=Math.round(relPos/this.unitSize()+this.start),this.updateTarget()},SliderMorph.prototype.updateTarget=function(){this.action&&("function"==typeof this.action?this.action.call(this.target,this.value):this.target[this.action](this.value))},SliderMorph.prototype.developersMenu=function(){var menu=SliderMorph.uber.developersMenu.call(this);return menu.addItem("show value...","showValue","display a dialog box\nshowing the selected number"),menu.addItem("floor...",function(){
this.prompt(menu.title+"\nfloor:",this.setStart,this,this.start.toString(),null,0,this.stop-this.size,!0)},"set the minimum value\nwhich can be selected"),menu.addItem("ceiling...",function(){this.prompt(menu.title+"\nceiling:",this.setStop,this,this.stop.toString(),null,this.start+this.size,100*this.size,!0)},"set the maximum value\nwhich can be selected"),menu.addItem("button size...",function(){this.prompt(menu.title+"\nbutton size:",this.setSize,this,this.size.toString(),null,1,this.stop-this.start,!0)},"set the range\ncovered by\nthe slider button"),menu.addLine(),menu.addItem("set target","setTarget","select another morph\nwhose numerical property\nwill be controlled by this one"),
menu},SliderMorph.prototype.showValue=function(){this.inform(this.value)},SliderMorph.prototype.userSetStart=function(num){this.start=Math.max(num,this.stop)},SliderMorph.prototype.setStart=function(num,noUpdate){var newStart;"number"==typeof num?this.start=Math.min(num,this.stop-this.size):(newStart=parseFloat(num),isNaN(newStart)||(this.start=Math.min(newStart,this.stop-this.size))),this.value=Math.max(this.value,this.start),noUpdate||this.updateTarget(),this.drawNew(),this.changed()},SliderMorph.prototype.setStop=function(num,noUpdate){var newStop;"number"==typeof num?this.stop=Math.max(num,this.start+this.size):(newStop=parseFloat(num),isNaN(newStop)||(this.stop=Math.max(newStop,this.start+this.size))),
this.value=Math.min(this.value,this.stop),noUpdate||this.updateTarget(),this.drawNew(),this.changed()},SliderMorph.prototype.setSize=function(num,noUpdate){var newSize;"number"==typeof num?this.size=Math.min(Math.max(num,1),this.stop-this.start):(newSize=parseFloat(num),isNaN(newSize)||(this.size=Math.min(Math.max(newSize,1),this.stop-this.start))),this.value=Math.min(this.value,this.stop-this.size),noUpdate||this.updateTarget(),this.drawNew(),this.changed()},SliderMorph.prototype.setTarget=function(){var choices=this.overlappedMorphs(),menu=new MenuMorph(this,"choose target:"),myself=this;choices.push(this.world()),choices.forEach(function(each){menu.addItem(each.toString().slice(0,50),function(){
myself.target=each,myself.setTargetSetter()})}),1===choices.length?(this.target=choices[0],this.setTargetSetter()):choices.length>0&&menu.popUpAtHand(this.world())},SliderMorph.prototype.setTargetSetter=function(){var choices=this.target.numericalSetters(),menu=new MenuMorph(this,"choose target property:"),myself=this;choices.forEach(function(each){menu.addItem(each,function(){myself.action=each})}),1===choices.length?this.action=choices[0]:choices.length>0&&menu.popUpAtHand(this.world())},SliderMorph.prototype.numericalSetters=function(){var list=SliderMorph.uber.numericalSetters.call(this);return list.push("setStart","setStop","setSize"),list},SliderMorph.prototype.step=null,
SliderMorph.prototype.mouseDownLeft=function(pos){var world,myself=this;this.button.bounds.containsPoint(pos)?this.offset=pos.subtract(this.button.bounds.origin):this.offset=new Point,world=this.root(),this.step=function(){var mousePos,newX,newY;world.hand.mouseButton?(mousePos=world.hand.bounds.origin,"vertical"===myself.orientation?(newX=myself.button.bounds.origin.x,newY=Math.max(Math.min(mousePos.y-myself.offset.y,myself.bottom()-myself.button.height()),myself.top())):(newY=myself.button.bounds.origin.y,newX=Math.max(Math.min(mousePos.x-myself.offset.x,myself.right()-myself.button.width()),myself.left())),myself.button.setPosition(new Point(newX,newY)),myself.updateValue()):this.step=null;
}};var MouseSensorMorph;MouseSensorMorph.prototype=new BoxMorph,MouseSensorMorph.prototype.constructor=MouseSensorMorph,MouseSensorMorph.uber=BoxMorph.prototype,MouseSensorMorph.prototype.init=function(edge,border,borderColor){MouseSensorMorph.uber.init.call(this),this.edge=edge||4,this.border=border||2,this.color=new Color(255,255,255),this.borderColor=borderColor||new Color,this.isTouched=!1,this.upStep=.05,this.downStep=.02,this.noticesTransparentClick=!1,this.drawNew()},MouseSensorMorph.prototype.touch=function(){var myself=this;this.isTouched||(this.isTouched=!0,this.alpha=.6,this.step=function(){myself.isTouched?myself.alpha<1&&(myself.alpha=myself.alpha+myself.upStep):myself.alpha>myself.downStep?myself.alpha=myself.alpha-myself.downStep:(myself.alpha=0,
myself.step=null),myself.changed()})},MouseSensorMorph.prototype.unTouch=function(){this.isTouched=!1},MouseSensorMorph.prototype.mouseEnter=function(){this.touch()},MouseSensorMorph.prototype.mouseLeave=function(){this.unTouch()},MouseSensorMorph.prototype.mouseDownLeft=function(){this.touch()},MouseSensorMorph.prototype.mouseClickLeft=function(){this.unTouch()};var ListMorph,TriggerMorph;InspectorMorph.prototype=new BoxMorph,InspectorMorph.prototype.constructor=InspectorMorph,InspectorMorph.uber=BoxMorph.prototype,InspectorMorph.prototype.init=function(target){this.target=target,this.currentProperty=null,this.showing="attributes",this.markOwnProperties=!1,this.hasUserEditedDetails=!1,
InspectorMorph.uber.init.call(this),this.silentSetExtent(new Point(20*MorphicPreferences.handleSize,20*MorphicPreferences.handleSize*2/3)),this.isDraggable=!0,this.border=1,this.edge=MorphicPreferences.isFlat?1:5,this.color=new Color(60,60,60),this.borderColor=new Color(95,95,95),this.fps=25,this.drawNew(),this.label=null,this.list=null,this.detail=null,this.work=null,this.buttonInspect=null,this.buttonClose=null,this.buttonSubset=null,this.buttonEdit=null,this.resizer=null,this.target&&this.buildPanes()},InspectorMorph.prototype.setTarget=function(target){this.target=target,this.currentProperty=null,this.buildPanes()},InspectorMorph.prototype.updateCurrentSelection=function(){
var val,txt,cnts,sel=this.list.selected,currentTxt=this.detail.contents.children[0],root=this.root();return root&&root.keyboardReceiver instanceof CursorMorph&&root.keyboardReceiver.target===currentTxt?void(this.hasUserEditedDetails=!0):void(isNil(sel)||this.hasUserEditedDetails||(val=this.target[sel],this.currentProperty=val,txt=isNil(val)?"NULL":isString(val)?val:val.toString(),currentTxt.text!==txt&&(cnts=new TextMorph(txt),cnts.isEditable=!0,cnts.enableSelecting(),cnts.setReceiver(this.target),this.detail.setContents(cnts))))},InspectorMorph.prototype.buildPanes=function(){var property,ctrl,ev,doubleClickAction,attribs=[],myself=this;this.children.forEach(function(m){
m!==this.work&&m.destroy()}),this.children=[],this.label=new TextMorph(this.target.toString()),this.label.fontSize=MorphicPreferences.menuFontSize,this.label.isBold=!0,this.label.color=new Color(255,255,255),this.label.drawNew(),this.add(this.label);for(property in this.target)property&&attribs.push(property);"attributes"===this.showing?attribs=attribs.filter(function(prop){return"function"!=typeof myself.target[prop]}):"methods"===this.showing&&(attribs=attribs.filter(function(prop){return"function"==typeof myself.target[prop]})),doubleClickAction=function(){var world,inspector;isObject(myself.currentProperty)&&(world=myself.world(),inspector=new InspectorMorph(myself.currentProperty),
inspector.setPosition(world.hand.position()),inspector.keepWithin(world),world.add(inspector),inspector.changed())},this.list=new ListMorph(this.target instanceof Array?attribs:attribs.sort(),null,this.markOwnProperties?[[new Color(0,0,180),function(element){return Object.prototype.hasOwnProperty.call(myself.target,element)}]]:null,doubleClickAction),this.list.action=function(){myself.hasUserEditedDetails=!1,myself.updateCurrentSelection()},this.list.hBar.alpha=.6,this.list.vBar.alpha=.6,this.list.contents.step=null,this.add(this.list),this.detail=new ScrollFrameMorph,this.detail.acceptsDrops=!1,this.detail.contents.acceptsDrops=!1,this.detail.isTextLineWrapping=!0,
this.detail.color=new Color(255,255,255),this.detail.hBar.alpha=.6,this.detail.vBar.alpha=.6,ctrl=new TextMorph(""),ctrl.isEditable=!0,ctrl.enableSelecting(),ctrl.setReceiver(this.target),this.detail.setContents(ctrl),this.add(this.detail),null===this.work&&(this.work=new ScrollFrameMorph,this.work.acceptsDrops=!1,this.work.contents.acceptsDrops=!1,this.work.isTextLineWrapping=!0,this.work.color=new Color(255,255,255),this.work.hBar.alpha=.6,this.work.vBar.alpha=.6,ev=new TextMorph(""),ev.isEditable=!0,ev.enableSelecting(),ev.setReceiver(this.target),this.work.setContents(ev)),this.add(this.work),this.buttonSubset=new TriggerMorph,this.buttonSubset.labelString="show...",
this.buttonSubset.action=function(){var menu;menu=new MenuMorph,menu.addItem("attributes",function(){myself.showing="attributes",myself.buildPanes()}),menu.addItem("methods",function(){myself.showing="methods",myself.buildPanes()}),menu.addItem("all",function(){myself.showing="all",myself.buildPanes()}),menu.addLine(),menu.addItem(myself.markOwnProperties?"un-mark own":"mark own",function(){myself.markOwnProperties=!myself.markOwnProperties,myself.buildPanes()},"highlight\n'own' properties"),menu.popUpAtHand(myself.world())},this.add(this.buttonSubset),this.buttonInspect=new TriggerMorph,this.buttonInspect.labelString="inspect...",this.buttonInspect.action=function(){
var menu,world,inspector;isObject(myself.currentProperty)?(menu=new MenuMorph,menu.addItem("in new inspector...",function(){world=myself.world(),inspector=new InspectorMorph(myself.currentProperty),inspector.setPosition(world.hand.position()),inspector.keepWithin(world),world.add(inspector),inspector.changed()}),menu.addItem("here...",function(){myself.setTarget(myself.currentProperty)}),menu.popUpAtHand(myself.world())):myself.inform((null===myself.currentProperty?"null":typeof myself.currentProperty)+"\nis not inspectable")},this.add(this.buttonInspect),this.buttonEdit=new TriggerMorph,this.buttonEdit.labelString="edit...",this.buttonEdit.action=function(){
var menu;menu=new MenuMorph(myself),menu.addItem("save","save","accept changes"),menu.addLine(),menu.addItem("add property...","addProperty"),menu.addItem("rename...","renameProperty"),menu.addItem("remove...","removeProperty"),menu.popUpAtHand(myself.world())},this.add(this.buttonEdit),this.buttonClose=new TriggerMorph,this.buttonClose.labelString="close",this.buttonClose.action=function(){myself.destroy()},this.add(this.buttonClose),this.resizer=new HandleMorph(this,150,100,this.edge,this.edge),this.fixLayout()},InspectorMorph.prototype.fixLayout=function(){var x,y,r,b,w,h;Morph.prototype.trackChanges=!1,x=this.left()+this.edge,y=this.top()+this.edge,r=this.right()-this.edge,
w=r-x,this.label.setPosition(new Point(x,y)),this.label.setWidth(w),this.label.height()>this.height()-50&&(this.silentSetHeight(this.label.height()+50),this.drawNew(),this.changed(),this.resizer.drawNew()),y=this.label.bottom()+2,w=Math.min(Math.floor(this.width()/3),this.list.listContents.width()),w-=this.edge,b=this.bottom()-2*this.edge-MorphicPreferences.handleSize,h=b-y,this.list.setPosition(new Point(x,y)),this.list.setExtent(new Point(w,h)),x=this.list.right()+this.edge,r=this.right()-this.edge,w=r-x,this.detail.setPosition(new Point(x,y)),this.detail.setExtent(new Point(w,2*h/3-this.edge)),y=this.detail.bottom()+this.edge,this.work.setPosition(new Point(x,y)),
this.work.setExtent(new Point(w,h/3)),x=this.list.left(),y=this.list.bottom()+this.edge,w=this.list.width(),h=MorphicPreferences.handleSize,this.buttonSubset.setPosition(new Point(x,y)),this.buttonSubset.setExtent(new Point(w,h)),x=this.detail.left(),w=this.detail.width()-this.edge-MorphicPreferences.handleSize,w=w/3-this.edge/3,this.buttonInspect.setPosition(new Point(x,y)),this.buttonInspect.setExtent(new Point(w,h)),x=this.buttonInspect.right()+this.edge,this.buttonEdit.setPosition(new Point(x,y)),this.buttonEdit.setExtent(new Point(w,h)),x=this.buttonEdit.right()+this.edge,r=this.detail.right()-this.edge-MorphicPreferences.handleSize,w=r-x,this.buttonClose.setPosition(new Point(x,y)),
this.buttonClose.setExtent(new Point(w,h)),Morph.prototype.trackChanges=!0,this.changed()},InspectorMorph.prototype.setExtent=function(aPoint){InspectorMorph.uber.setExtent.call(this,aPoint),this.fixLayout()},InspectorMorph.prototype.save=function(){var txt=this.detail.contents.children[0].text.toString(),prop=this.list.selected;try{this.target.evaluateString("this."+prop+" = "+txt),this.hasUserEditedDetails=!1,this.target.drawNew&&(this.target.changed(),this.target.drawNew(),this.target.changed())}catch(err){this.inform(err)}},InspectorMorph.prototype.addProperty=function(){var myself=this;this.prompt("new property name:",function(prop){prop&&(myself.target[prop]=null,
myself.buildPanes(),myself.target.drawNew&&(myself.target.changed(),myself.target.drawNew(),myself.target.changed()))},this,"property")},InspectorMorph.prototype.renameProperty=function(){var myself=this,propertyName=this.list.selected;this.prompt("property name:",function(prop){try{delete myself.target[propertyName],myself.target[prop]=myself.currentProperty}catch(err){myself.inform(err)}myself.buildPanes(),myself.target.drawNew&&(myself.target.changed(),myself.target.drawNew(),myself.target.changed())},this,propertyName)},InspectorMorph.prototype.removeProperty=function(){var prop=this.list.selected;try{delete this.target[prop],this.currentProperty=null,this.buildPanes(),
this.target.drawNew&&(this.target.changed(),this.target.drawNew(),this.target.changed())}catch(err){this.inform(err)}},InspectorMorph.prototype.step=function(){this.updateCurrentSelection();var lbl=this.target.toString();this.label.text!==lbl&&(this.label.text=lbl,this.label.drawNew(),this.fixLayout())},InspectorMorph.prototype.updateReferences=function(map){var active=this.list.activeIndex();InspectorMorph.uber.updateReferences.call(this,map),this.buildPanes(),this.list.activateIndex(active)};var MenuItemMorph;MenuMorph.prototype=new BoxMorph,MenuMorph.prototype.constructor=MenuMorph,MenuMorph.uber=BoxMorph.prototype,MenuMorph.prototype.init=function(target,title,environment,fontSize){
this.target=target,this.title=title||null,this.environment=environment||null,this.fontSize=fontSize||null,this.items=[],this.label=null,this.world=null,this.isListContents=!1,this.hasFocus=!1,this.selection=null,this.submenu=null,MenuMorph.uber.init.call(this),this.isDraggable=!1,this.border=null,this.edge=null},MenuMorph.prototype.addItem=function(labelString,action,hint,color,bold,italic,doubleClickAction,shortcut){this.items.push([localize(labelString||"close"),action||nop,hint,color,bold||!1,italic||!1,doubleClickAction,shortcut])},MenuMorph.prototype.addMenu=function(label,aMenu,indicator){this.addPair(label,aMenu,isNil(indicator)?"►":indicator)},MenuMorph.prototype.addPair=function(label,action,shortcut,hint){
this.addItem(label,action,hint,null,null,null,null,shortcut)},MenuMorph.prototype.addLine=function(width){this.items.push([0,width||1])},MenuMorph.prototype.createLabel=function(){var text;null!==this.label&&this.label.destroy(),text=new TextMorph(localize(this.title),this.fontSize||MorphicPreferences.menuFontSize,MorphicPreferences.menuFontName,!0,!1,"center"),text.alignment="center",text.color=new Color(255,255,255),text.backgroundColor=this.borderColor,text.drawNew(),this.label=new BoxMorph(3,0),MorphicPreferences.isFlat&&(this.label.edge=0),this.label.color=this.borderColor,this.label.borderColor=this.borderColor,this.label.setExtent(text.extent().add(4)),
this.label.drawNew(),this.label.add(text),this.label.text=text},MenuMorph.prototype.drawNew=function(){var item,fb,x,y,myself=this,isLine=!1;this.children.forEach(function(m){m.destroy()}),this.children=[],this.isListContents||(this.edge=MorphicPreferences.isFlat?0:5,this.border=MorphicPreferences.isFlat?1:2),this.color=new Color(255,255,255),this.borderColor=new Color(60,60,60),this.silentSetExtent(new Point(0,0)),y=2,x=this.left()+4,this.isListContents||(this.title?(this.createLabel(),this.label.setPosition(this.bounds.origin.add(4)),this.add(this.label),y=this.label.bottom()):y=this.top()+4),y+=1,this.items.forEach(function(tuple){isLine=!1,tuple instanceof StringFieldMorph||tuple instanceof ColorPickerMorph||tuple instanceof SliderMorph?item=tuple:0===tuple[0]?(isLine=!0,
item=new Morph,item.color=myself.borderColor,item.setHeight(tuple[1])):item=new MenuItemMorph(myself.target,tuple[1],tuple[0],myself.fontSize||MorphicPreferences.menuFontSize,MorphicPreferences.menuFontName,myself.environment,tuple[2],tuple[3],tuple[4],tuple[5],tuple[6],tuple[7]),isLine&&(y+=1),item.setPosition(new Point(x,y)),myself.add(item),y+=item.height(),isLine&&(y+=1)}),fb=this.fullBounds(),this.silentSetExtent(fb.extent().add(4)),this.adjustWidths(),MenuMorph.uber.drawNew.call(this)},MenuMorph.prototype.maxWidth=function(){var w=0;return this.parent instanceof FrameMorph&&this.parent.scrollFrame instanceof ScrollFrameMorph&&(w=this.parent.scrollFrame.width()),
this.children.forEach(function(item){item instanceof MenuItemMorph?w=Math.max(w,item.label.width()+8+(item.shortcut?item.shortcut.width()+4:0)):(item instanceof StringFieldMorph||item instanceof ColorPickerMorph||item instanceof SliderMorph)&&(w=Math.max(w,item.width()))}),this.label&&(w=Math.max(w,this.label.width())),w},MenuMorph.prototype.adjustWidths=function(){var isSelected,w=this.maxWidth(),myself=this;this.children.forEach(function(item){item.silentSetWidth(w),item instanceof MenuItemMorph?(item.fixLayout(),isSelected=item.image===item.pressImage,item.createBackgrounds(),isSelected&&(item.image=item.pressImage)):(item.drawNew(),item===myself.label&&item.text.setPosition(item.center().subtract(item.text.extent().floorDivideBy(2))));
})},MenuMorph.prototype.unselectAllItems=function(){this.children.forEach(function(item){item instanceof MenuItemMorph&&(item.image=item.normalImage)}),this.changed()},MenuMorph.prototype.popup=function(world,pos){this.drawNew(),this.setPosition(pos),this.addShadow(new Point(2,2),80),this.keepWithin(world),world.activeMenu&&world.activeMenu.destroy(),this.items.length<1&&!this.title||(world.add(this),world.activeMenu=this,this.world=world,this.fullChanged())},MenuMorph.prototype.popUpAtHand=function(world){var wrrld=world||this.world;this.popup(wrrld,wrrld.hand.position())},MenuMorph.prototype.popUpCenteredAtHand=function(world){var wrrld=world||this.world;this.drawNew(),
this.popup(wrrld,wrrld.hand.position().subtract(this.extent().floorDivideBy(2)))},MenuMorph.prototype.popUpCenteredInWorld=function(world){var wrrld=world||this.world;this.drawNew(),this.popup(wrrld,wrrld.center().subtract(this.extent().floorDivideBy(2)))},MenuMorph.prototype.closeRootMenu=function(){this.parent instanceof MenuMorph?this.parent.closeRootMenu():this.destroy()},MenuMorph.prototype.closeSubmenu=function(){this.submenu&&(this.submenu.destroy(),this.submenu=null,this.unselectAllItems())},MenuMorph.prototype.getFocus=function(){this.world.keyboardReceiver=this,this.selection=null,this.selectFirst(),this.hasFocus=!0},MenuMorph.prototype.processKeyDown=function(event){
switch(event.keyCode){case 13:case 32:return void(this.selection&&(this.selection.mouseClickLeft(),this.submenu&&this.submenu.getFocus()));case 27:return this.destroy();case 37:return this.leaveSubmenu();case 38:return this.selectUp();case 39:return this.enterSubmenu();case 40:return this.selectDown();default:nop()}},MenuMorph.prototype.processKeyUp=function(event){nop(event)},MenuMorph.prototype.processKeyPress=function(event){nop(event)},MenuMorph.prototype.selectFirst=function(){var i;for(i=0;i<this.children.length;i+=1)if(this.children[i]instanceof MenuItemMorph)return void this.select(this.children[i])},MenuMorph.prototype.selectUp=function(){var triggers,idx;
return triggers=this.children.filter(function(each){return each instanceof MenuItemMorph}),this.selection?(idx=triggers.indexOf(this.selection)-1,idx<0&&(idx=triggers.length-1),void this.select(triggers[idx])):void(triggers.length&&this.select(triggers[0]))},MenuMorph.prototype.selectDown=function(){var triggers,idx;return triggers=this.children.filter(function(each){return each instanceof MenuItemMorph}),this.selection?(idx=triggers.indexOf(this.selection)+1,idx>=triggers.length&&(idx=0),void this.select(triggers[idx])):void(triggers.length&&this.select(triggers[0]))},MenuMorph.prototype.enterSubmenu=function(){this.selection&&this.selection.action instanceof MenuMorph&&(this.selection.popUpSubmenu(),
this.submenu&&this.submenu.getFocus())},MenuMorph.prototype.leaveSubmenu=function(){var menu=this.parent;this.parent instanceof MenuMorph&&(menu.submenu=null,menu.hasFocus=!0,this.destroy(),menu.world.keyboardReceiver=menu)},MenuMorph.prototype.select=function(aMenuItem){this.unselectAllItems(),aMenuItem.image=aMenuItem.highlightImage,aMenuItem.changed(),this.selection=aMenuItem},MenuMorph.prototype.destroy=function(){this.hasFocus&&(this.world.keyboardReceiver=null),MenuMorph.uber.destroy.call(this)},StringMorph.prototype=new Morph,StringMorph.prototype.constructor=StringMorph,StringMorph.uber=Morph.prototype,StringMorph.prototype.init=function(text,fontSize,fontStyle,bold,italic,isNumeric,shadowOffset,shadowColor,color,fontName){
this.text=text||(""===text?"":"StringMorph"),this.fontSize=fontSize||12,this.fontName=fontName||MorphicPreferences.globalFontFamily,this.fontStyle=fontStyle||"sans-serif",this.isBold=bold||!1,this.isItalic=italic||!1,this.isEditable=!1,this.isNumeric=isNumeric||!1,this.isPassword=!1,this.shadowOffset=shadowOffset||new Point(0,0),this.shadowColor=shadowColor||null,this.isShowingBlanks=!1,this.blanksColor=new Color(180,140,140),this.isScrollable=!0,this.currentlySelecting=!1,this.startMark=0,this.endMark=0,this.markedTextColor=new Color(255,255,255),this.markedBackgoundColor=new Color(60,60,120),StringMorph.uber.init.call(this,!0),this.color=color||new Color(0,0,0),
this.noticesTransparentClick=!0,this.drawNew()},StringMorph.prototype.toString=function(){return"a "+(this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])+'("'+this.text.slice(0,30)+'...")'},StringMorph.prototype.password=function(letter,length){var i,ans="";for(i=0;i<length;i+=1)ans+=letter;return ans},StringMorph.prototype.font=function(){var font="";return this.isBold&&(font+="bold "),this.isItalic&&(font+="italic "),font+this.fontSize+"px "+(this.fontName?this.fontName+", ":"")+this.fontStyle},StringMorph.prototype.drawNew=function(){var context,width,start,stop,i,p,c,x,y,shadowOffset=this.shadowOffset||new Point,txt=this.isPassword?this.password("*",this.text.length):this.text;
for(this.image=newCanvas(),context=this.image.getContext("2d"),context.font=this.font(),width=Math.max(context.measureText(txt).width+Math.abs(shadowOffset.x),1),this.bounds.corner=this.bounds.origin.add(new Point(width,fontHeight(this.fontSize)+Math.abs(shadowOffset.y))),this.image.width=width,this.image.height=this.height(),context.font=this.font(),context.textAlign="left",context.textBaseline="bottom",this.shadowColor&&(x=Math.max(shadowOffset.x,0),y=Math.max(shadowOffset.y,0),context.fillStyle=this.shadowColor.toString(),context.fillText(txt,x,fontHeight(this.fontSize)+y)),x=Math.abs(Math.min(shadowOffset.x,0)),y=Math.abs(Math.min(shadowOffset.y,0)),context.fillStyle=this.color.toString(),
this.isShowingBlanks?this.renderWithBlanks(context,x,fontHeight(this.fontSize)+y):context.fillText(txt,x,fontHeight(this.fontSize)+y),start=Math.min(this.startMark,this.endMark),stop=Math.max(this.startMark,this.endMark),i=start;i<stop;i+=1)p=this.slotPosition(i).subtract(this.position()),c=txt.charAt(i),context.fillStyle=this.markedBackgoundColor.toString(),context.fillRect(p.x,p.y,context.measureText(c).width+1+x,fontHeight(this.fontSize)+y),context.fillStyle=this.markedTextColor.toString(),context.fillText(c,p.x+x,fontHeight(this.fontSize)+y);this.parent&&this.parent.fixLayout&&this.parent.fixLayout()},StringMorph.prototype.renderWithBlanks=function(context,startX,y){
function drawBlank(){context.drawImage(blank,x,0),x+=space}var space=context.measureText(" ").width,blank=newCanvas(new Point(space,this.height())),ctx=blank.getContext("2d"),words=this.text.split(" "),x=startX||0,isFirst=!0;ctx.fillStyle=this.blanksColor.toString(),ctx.arc(space/2,blank.height/2,space/2,radians(0),radians(360)),ctx.fill(),words.forEach(function(word){isFirst||drawBlank(),isFirst=!1,""!==word&&(context.fillText(word,x,y),x+=context.measureText(word).width)})},StringMorph.prototype.slotPosition=function(slot){var xOffset,x,y,idx,txt=this.isPassword?this.password("*",this.text.length):this.text,dest=Math.min(Math.max(slot,0),txt.length),context=this.image.getContext("2d");
for(xOffset=0,idx=0;idx<dest;idx+=1)xOffset+=context.measureText(txt[idx]).width;return this.pos=dest,x=this.left()+xOffset,y=this.top(),new Point(x,y)},StringMorph.prototype.slotAt=function(aPoint){for(var txt=this.isPassword?this.password("*",this.text.length):this.text,idx=0,charX=0,context=this.image.getContext("2d");aPoint.x-this.left()>charX;)if(charX+=context.measureText(txt[idx]).width,idx+=1,idx===txt.length&&context.measureText(txt).width-context.measureText(txt[idx-1]).width/2<aPoint.x-this.left())return idx;return aPoint.x-this.left()>charX-context.measureText(txt[idx-1]).width/2?idx:idx-1},StringMorph.prototype.upFrom=function(slot){return slot},
StringMorph.prototype.downFrom=function(slot){return slot},StringMorph.prototype.startOfLine=function(){return 0},StringMorph.prototype.endOfLine=function(){return this.text.length},StringMorph.prototype.previousWordFrom=function(aSlot){for(var index=aSlot-1;index>0&&!isWordChar(this.text[index]);)index-=1;for(;index>0&&isWordChar(this.text[index-1]);)index-=1;return index},StringMorph.prototype.nextWordFrom=function(aSlot){for(var index=aSlot;index<this.endOfLine()&&!isWordChar(this.text[index]);)index+=1;for(;index<this.endOfLine()&&isWordChar(this.text[index]);)index+=1;return index},StringMorph.prototype.rawHeight=function(){return this.height()/1.2},StringMorph.prototype.developersMenu=function(){
var menu=StringMorph.uber.developersMenu.call(this);return menu.addLine(),menu.addItem("edit","edit"),menu.addItem("font size...",function(){this.prompt(menu.title+"\nfont\nsize:",this.setFontSize,this,this.fontSize.toString(),null,6,500,!0)},"set this String's\nfont point size"),"serif"!==this.fontStyle&&menu.addItem("serif","setSerif"),"sans-serif"!==this.fontStyle&&menu.addItem("sans-serif","setSansSerif"),this.isBold?menu.addItem("normal weight","toggleWeight"):menu.addItem("bold","toggleWeight"),this.isItalic?menu.addItem("normal style","toggleItalic"):menu.addItem("italic","toggleItalic"),this.isShowingBlanks?menu.addItem("hide blanks","toggleShowBlanks"):menu.addItem("show blanks","toggleShowBlanks"),
this.isPassword?menu.addItem("show characters","toggleIsPassword"):menu.addItem("hide characters","toggleIsPassword"),menu},StringMorph.prototype.toggleIsDraggable=function(){this.isDraggable=!this.isDraggable,this.isDraggable?this.disableSelecting():this.enableSelecting()},StringMorph.prototype.toggleShowBlanks=function(){this.isShowingBlanks=!this.isShowingBlanks,this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.toggleWeight=function(){this.isBold=!this.isBold,this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.toggleItalic=function(){this.isItalic=!this.isItalic,this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.toggleIsPassword=function(){
this.isPassword=!this.isPassword,this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.setSerif=function(){this.fontStyle="serif",this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.setSansSerif=function(){this.fontStyle="sans-serif",this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.setFontSize=function(size){var newSize;"number"==typeof size?this.fontSize=Math.round(Math.min(Math.max(size,4),500)):(newSize=parseFloat(size),isNaN(newSize)||(this.fontSize=Math.round(Math.min(Math.max(newSize,4),500)))),this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.setText=function(size){this.text=Math.round(size).toString(),
this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.numericalSetters=function(){return["setLeft","setTop","setAlphaScaled","setFontSize","setText"]},StringMorph.prototype.edit=function(){this.root().edit(this)},StringMorph.prototype.selection=function(){var start,stop;return start=Math.min(this.startMark,this.endMark),stop=Math.max(this.startMark,this.endMark),this.text.slice(start,stop)},StringMorph.prototype.selectionStartSlot=function(){return Math.min(this.startMark,this.endMark)},StringMorph.prototype.clearSelection=function(){!this.currentlySelecting&&isNil(this.startMark)&&isNil(this.endMark)||(this.currentlySelecting=!1,this.startMark=null,
this.endMark=null,this.drawNew(),this.changed())},StringMorph.prototype.deleteSelection=function(){var start,stop,text;text=this.text,start=Math.min(this.startMark,this.endMark),stop=Math.max(this.startMark,this.endMark),this.text=text.slice(0,start)+text.slice(stop),this.changed(),this.clearSelection()},StringMorph.prototype.selectAll=function(){var cursor;this.isEditable&&(this.startMark=0,cursor=this.root().cursor,cursor&&cursor.gotoSlot(this.text.length),this.endMark=this.text.length,this.drawNew(),this.changed())},StringMorph.prototype.mouseDownLeft=function(pos){16===this.world().currentKey?this.shiftClick(pos):this.isEditable?this.clearSelection():this.escalateEvent("mouseDownLeft",pos);
},StringMorph.prototype.shiftClick=function(pos){var cursor=this.root().cursor;cursor&&(this.startMark||(this.startMark=cursor.slot),cursor.gotoPos(pos),this.endMark=cursor.slot,this.drawNew(),this.changed()),this.currentlySelecting=!1,this.escalateEvent("mouseDownLeft",pos)},StringMorph.prototype.mouseClickLeft=function(pos){var cursor;this.isEditable?(this.currentlySelecting||this.edit(),cursor=this.root().cursor,cursor&&cursor.gotoPos(pos),this.currentlySelecting=!0):this.escalateEvent("mouseClickLeft",pos)},StringMorph.prototype.mouseDoubleClick=function(pos){var slot=this.slotAt(pos);this.isEditable?(this.edit(),slot===this.text.length&&(slot-=1),this.text[slot]&&isWordChar(this.text[slot])?this.selectWordAt(slot):this.text[slot]?this.selectBetweenWordsAt(slot):this.selectAll()):this.escalateEvent("mouseDoubleClick",pos);
},StringMorph.prototype.selectWordAt=function(slot){var cursor=this.root().cursor;0===slot||isWordChar(this.text[slot-1])?(cursor.gotoSlot(this.previousWordFrom(slot)),this.startMark=cursor.slot,this.endMark=this.nextWordFrom(cursor.slot)):(cursor.gotoSlot(slot),this.startMark=slot,this.endMark=this.nextWordFrom(slot)),this.drawNew(),this.changed()},StringMorph.prototype.selectBetweenWordsAt=function(slot){var cursor=this.root().cursor;for(cursor.gotoSlot(this.nextWordFrom(this.previousWordFrom(slot))),this.startMark=cursor.slot,this.endMark=cursor.slot;this.endMark<this.text.length&&!isWordChar(this.text[this.endMark]);)this.endMark+=1;this.drawNew(),this.changed();
},StringMorph.prototype.enableSelecting=function(){this.mouseDownLeft=function(pos){var crs=this.root().cursor,already=!!crs&&crs.target===this;16===this.world().currentKey?this.shiftClick(pos):(this.clearSelection(),this.isEditable&&!this.isDraggable&&(this.edit(),this.root().cursor.gotoPos(pos),this.startMark=this.slotAt(pos),this.endMark=this.startMark,this.currentlySelecting=!0,already||this.escalateEvent("mouseDownLeft",pos)))},this.mouseMove=function(pos){if(this.isEditable&&this.currentlySelecting&&!this.isDraggable){var newMark=this.slotAt(pos);newMark!==this.endMark&&(this.endMark=newMark,this.drawNew(),this.changed())}}},StringMorph.prototype.disableSelecting=function(){
this.mouseDownLeft=StringMorph.prototype.mouseDownLeft,delete this.mouseMove},TextMorph.prototype=new Morph,TextMorph.prototype.constructor=TextMorph,TextMorph.uber=Morph.prototype,TextMorph.prototype.init=function(text,fontSize,fontStyle,bold,italic,alignment,width,fontName,shadowOffset,shadowColor){this.text=text||(""===text?text:"TextMorph"),this.words=[],this.lines=[],this.lineSlots=[],this.fontSize=fontSize||12,this.fontName=fontName||MorphicPreferences.globalFontFamily,this.fontStyle=fontStyle||"sans-serif",this.isBold=bold||!1,this.isItalic=italic||!1,this.alignment=alignment||"left",this.shadowOffset=shadowOffset||new Point(0,0),this.shadowColor=shadowColor||null,
this.maxWidth=width||0,this.maxLineWidth=0,this.backgroundColor=null,this.isEditable=!1,this.receiver=null,this.isScrollable=!0,this.currentlySelecting=!1,this.startMark=0,this.endMark=0,this.markedTextColor=new Color(255,255,255),this.markedBackgoundColor=new Color(60,60,120),TextMorph.uber.init.call(this),this.color=new Color(0,0,0),this.noticesTransparentClick=!0,this.drawNew()},TextMorph.prototype.toString=function(){return'a TextMorph("'+this.text.slice(0,30)+'...")'},TextMorph.prototype.font=StringMorph.prototype.font,TextMorph.prototype.parse=function(){var newline,w,myself=this,paragraphs=this.text.split("\n"),canvas=newCanvas(),context=canvas.getContext("2d"),oldline="",slot=0;
context.font=this.font(),this.maxLineWidth=0,this.lines=[],this.lineSlots=[0],this.words=[],paragraphs.forEach(function(p){myself.words=myself.words.concat(p.split(" ")),myself.words.push("\n")}),this.words.forEach(function(word){"\n"===word?(myself.lines.push(oldline),myself.lineSlots.push(slot),myself.maxLineWidth=Math.max(myself.maxLineWidth,context.measureText(oldline).width),oldline=""):(myself.maxWidth>0?(newline=oldline+word+" ",w=context.measureText(newline).width,w>myself.maxWidth?(myself.lines.push(oldline),myself.lineSlots.push(slot),myself.maxLineWidth=Math.max(myself.maxLineWidth,context.measureText(oldline).width),oldline=word+" "):oldline=newline):oldline=oldline+word+" ",
slot+=word.length+1)})},TextMorph.prototype.drawNew=function(){var context,height,i,line,width,shadowHeight,shadowWidth,offx,offy,x,y,start,stop,p,c;if(this.image=newCanvas(),context=this.image.getContext("2d"),context.font=this.font(),this.parse(),shadowWidth=Math.abs(this.shadowOffset.x),shadowHeight=Math.abs(this.shadowOffset.y),height=this.lines.length*(fontHeight(this.fontSize)+shadowHeight),0===this.maxWidth?this.bounds=this.bounds.origin.extent(new Point(this.maxLineWidth+shadowWidth,height)):this.bounds=this.bounds.origin.extent(new Point(this.maxWidth+shadowWidth,height)),this.image.width=this.width(),this.image.height=this.height(),context=this.image.getContext("2d"),
context.font=this.font(),context.textAlign="left",context.textBaseline="bottom",this.backgroundColor&&(context.fillStyle=this.backgroundColor.toString(),context.fillRect(0,0,this.width(),this.height())),this.shadowColor)for(offx=Math.max(this.shadowOffset.x,0),offy=Math.max(this.shadowOffset.y,0),context.fillStyle=this.shadowColor.toString(),i=0;i<this.lines.length;i+=1)line=this.lines[i],width=context.measureText(line).width+shadowWidth,x="right"===this.alignment?this.width()-width:"center"===this.alignment?(this.width()-width)/2:0,y=(i+1)*(fontHeight(this.fontSize)+shadowHeight)-shadowHeight,context.fillText(line,x+offx,y+offy);for(offx=Math.abs(Math.min(this.shadowOffset.x,0)),
offy=Math.abs(Math.min(this.shadowOffset.y,0)),context.fillStyle=this.color.toString(),i=0;i<this.lines.length;i+=1)line=this.lines[i],width=context.measureText(line).width+shadowWidth,x="right"===this.alignment?this.width()-width:"center"===this.alignment?(this.width()-width)/2:0,y=(i+1)*(fontHeight(this.fontSize)+shadowHeight)-shadowHeight,context.fillText(line,x+offx,y+offy);for(start=Math.min(this.startMark,this.endMark),stop=Math.max(this.startMark,this.endMark),i=start;i<stop;i+=1)p=this.slotPosition(i).subtract(this.position()),c=this.text.charAt(i),context.fillStyle=this.markedBackgoundColor.toString(),context.fillRect(p.x,p.y,context.measureText(c).width+1,fontHeight(this.fontSize)),
context.fillStyle=this.markedTextColor.toString(),context.fillText(c,p.x,p.y+fontHeight(this.fontSize));this.parent&&this.parent.layoutChanged&&this.parent.layoutChanged()},TextMorph.prototype.setExtent=function(aPoint){this.maxWidth=Math.max(aPoint.x,0),this.changed(),this.drawNew()},TextMorph.prototype.columnRow=function(slot){var row,col,idx=0;for(row=0;row<this.lines.length;row+=1)for(idx=this.lineSlots[row],col=0;col<this.lines[row].length;col+=1){if(idx===slot)return new Point(col,row);idx+=1}return new Point(this.lines[this.lines.length-1].length-1,this.lines.length-1)},TextMorph.prototype.slotPosition=function(slot){var yOffset,x,y,idx,colRow=this.columnRow(slot),context=this.image.getContext("2d"),shadowHeight=Math.abs(this.shadowOffset.y),xOffset=0;
for(yOffset=colRow.y*(fontHeight(this.fontSize)+shadowHeight),idx=0;idx<colRow.x;idx+=1)xOffset+=context.measureText(this.lines[colRow.y][idx]).width;return x=this.left()+xOffset,y=this.top()+yOffset,new Point(x,y)},TextMorph.prototype.slotAt=function(aPoint){for(var charX=0,row=0,col=0,shadowHeight=Math.abs(this.shadowOffset.y),context=this.image.getContext("2d");aPoint.y-this.top()>(fontHeight(this.fontSize)+shadowHeight)*row;)row+=1;for(row=Math.max(row,1);aPoint.x-this.left()>charX;)charX+=context.measureText(this.lines[row-1][col]).width,col+=1;return aPoint.x-this.left()>charX-context.measureText(this.lines[row-1][col]).width/2?this.lineSlots[Math.max(row-1,0)]+col:this.lineSlots[Math.max(row-1,0)]+col-1;
},TextMorph.prototype.upFrom=function(slot){var above,colRow=this.columnRow(slot);return colRow.y<1?slot:(above=this.lines[colRow.y-1],above.length<colRow.x-1?this.lineSlots[colRow.y-1]+above.length:this.lineSlots[colRow.y-1]+colRow.x)},TextMorph.prototype.downFrom=function(slot){var below,colRow=this.columnRow(slot);return colRow.y>this.lines.length-2?slot:(below=this.lines[colRow.y+1],below.length<colRow.x-1?this.lineSlots[colRow.y+1]+below.length:this.lineSlots[colRow.y+1]+colRow.x)},TextMorph.prototype.startOfLine=function(slot){return this.lineSlots[this.columnRow(slot).y]},TextMorph.prototype.endOfLine=function(slot){return this.startOfLine(slot)+this.lines[this.columnRow(slot).y].length-1;
},TextMorph.prototype.previousWordFrom=StringMorph.prototype.previousWordFrom,TextMorph.prototype.nextWordFrom=StringMorph.prototype.nextWordFrom,TextMorph.prototype.edit=StringMorph.prototype.edit,TextMorph.prototype.selection=StringMorph.prototype.selection,TextMorph.prototype.selectionStartSlot=StringMorph.prototype.selectionStartSlot,TextMorph.prototype.clearSelection=StringMorph.prototype.clearSelection,TextMorph.prototype.deleteSelection=StringMorph.prototype.deleteSelection,TextMorph.prototype.selectAll=StringMorph.prototype.selectAll,TextMorph.prototype.mouseDownLeft=StringMorph.prototype.mouseDownLeft,TextMorph.prototype.shiftClick=StringMorph.prototype.shiftClick,
TextMorph.prototype.mouseClickLeft=StringMorph.prototype.mouseClickLeft,TextMorph.prototype.mouseDoubleClick=StringMorph.prototype.mouseDoubleClick,TextMorph.prototype.selectWordAt=StringMorph.prototype.selectWordAt,TextMorph.prototype.selectBetweenWordsAt=StringMorph.prototype.selectBetweenWordsAt,TextMorph.prototype.enableSelecting=StringMorph.prototype.enableSelecting,TextMorph.prototype.disableSelecting=StringMorph.prototype.disableSelecting,TextMorph.prototype.selectAllAndEdit=function(){this.edit(),this.selectAll()},TextMorph.prototype.developersMenu=function(){var menu=TextMorph.uber.developersMenu.call(this);return menu.addLine(),menu.addItem("edit","edit"),
menu.addItem("font size...",function(){this.prompt(menu.title+"\nfont\nsize:",this.setFontSize,this,this.fontSize.toString(),null,6,100,!0)},"set this Text's\nfont point size"),"left"!==this.alignment&&menu.addItem("align left","setAlignmentToLeft"),"right"!==this.alignment&&menu.addItem("align right","setAlignmentToRight"),"center"!==this.alignment&&menu.addItem("align center","setAlignmentToCenter"),menu.addLine(),"serif"!==this.fontStyle&&menu.addItem("serif","setSerif"),"sans-serif"!==this.fontStyle&&menu.addItem("sans-serif","setSansSerif"),this.isBold?menu.addItem("normal weight","toggleWeight"):menu.addItem("bold","toggleWeight"),this.isItalic?menu.addItem("normal style","toggleItalic"):menu.addItem("italic","toggleItalic"),
menu},TextMorph.prototype.setAlignmentToLeft=function(){this.alignment="left",this.drawNew(),this.changed()},TextMorph.prototype.setAlignmentToRight=function(){this.alignment="right",this.drawNew(),this.changed()},TextMorph.prototype.setAlignmentToCenter=function(){this.alignment="center",this.drawNew(),this.changed()},TextMorph.prototype.toggleIsDraggable=StringMorph.prototype.toggleIsDraggable,TextMorph.prototype.toggleWeight=StringMorph.prototype.toggleWeight,TextMorph.prototype.toggleItalic=StringMorph.prototype.toggleItalic,TextMorph.prototype.setSerif=StringMorph.prototype.setSerif,TextMorph.prototype.setSansSerif=StringMorph.prototype.setSansSerif,TextMorph.prototype.setText=StringMorph.prototype.setText,
TextMorph.prototype.setFontSize=StringMorph.prototype.setFontSize,TextMorph.prototype.numericalSetters=StringMorph.prototype.numericalSetters,TextMorph.prototype.evaluationMenu=function(){var menu=new MenuMorph(this,null);return menu.addItem("do it","doIt","evaluate the\nselected expression"),menu.addItem("show it","showIt","evaluate the\nselected expression\nand show the result"),menu.addItem("inspect it","inspectIt","evaluate the\nselected expression\nand inspect the result"),menu.addLine(),menu.addItem("select all","selectAllAndEdit"),menu},TextMorph.prototype.setReceiver=function(obj){this.receiver=obj,this.customContextMenu=this.evaluationMenu()},TextMorph.prototype.doIt=function(){
this.receiver.evaluateString(this.selection()),this.edit()},TextMorph.prototype.showIt=function(){var result=this.receiver.evaluateString(this.selection());null!==result&&this.inform(result)},TextMorph.prototype.inspectIt=function(){var inspector,result=this.receiver.evaluateString(this.selection()),world=this.world();isObject(result)&&(inspector=new InspectorMorph(result),inspector.setPosition(world.hand.position()),inspector.keepWithin(world),world.add(inspector),inspector.changed())},TriggerMorph.prototype=new Morph,TriggerMorph.prototype.constructor=TriggerMorph,TriggerMorph.uber=Morph.prototype,TriggerMorph.prototype.init=function(target,action,labelString,fontSize,fontStyle,environment,hint,labelColor,labelBold,labelItalic,doubleClickAction){
this.target=target||null,this.action=action||null,this.doubleClickAction=doubleClickAction||null,this.environment=environment||null,this.labelString=labelString||null,this.label=null,this.hint=hint||null,this.schedule=null,this.fontSize=fontSize||MorphicPreferences.menuFontSize,this.fontStyle=fontStyle||"sans-serif",this.highlightColor=new Color(192,192,192),this.pressColor=new Color(128,128,128),this.labelColor=labelColor||new Color(0,0,0),this.labelBold=labelBold||!1,this.labelItalic=labelItalic||!1,TriggerMorph.uber.init.call(this),this.color=new Color(255,255,255),this.drawNew()},TriggerMorph.prototype.drawNew=function(){this.createBackgrounds(),null!==this.labelString&&this.createLabel();
},TriggerMorph.prototype.createBackgrounds=function(){var context,ext=this.extent();this.normalImage=newCanvas(ext),context=this.normalImage.getContext("2d"),context.fillStyle=this.color.toString(),context.fillRect(0,0,ext.x,ext.y),this.highlightImage=newCanvas(ext),context=this.highlightImage.getContext("2d"),context.fillStyle=this.highlightColor.toString(),context.fillRect(0,0,ext.x,ext.y),this.pressImage=newCanvas(ext),context=this.pressImage.getContext("2d"),context.fillStyle=this.pressColor.toString(),context.fillRect(0,0,ext.x,ext.y),this.image=this.normalImage},TriggerMorph.prototype.createLabel=function(){null!==this.label&&this.label.destroy(),this.label=new StringMorph(this.labelString,this.fontSize,this.fontStyle,this.labelBold,this.labelItalic,!1,null,null,this.labelColor),
this.label.setPosition(this.center().subtract(this.label.extent().floorDivideBy(2))),this.add(this.label)},TriggerMorph.prototype.trigger=function(){this.schedule&&(this.schedule.isActive=!1),"function"==typeof this.target?"function"==typeof this.action?this.target.call(this.environment,this.action.call(),this):this.target.call(this.environment,this.action,this):"function"==typeof this.action?this.action.call(this.target):this.target[this.action]()},TriggerMorph.prototype.triggerDoubleClick=function(){this.doubleClickAction&&(this.schedule&&(this.schedule.isActive=!1),"function"==typeof this.target?"function"==typeof this.doubleClickAction?this.target.call(this.environment,this.doubleClickAction.call(),this):this.target.call(this.environment,this.doubleClickAction,this):"function"==typeof this.doubleClickAction?this.doubleClickAction.call(this.target):this.target[this.doubleClickAction]());
},TriggerMorph.prototype.mouseEnter=function(){var contents=this.hint instanceof Function?this.hint():this.hint;this.image=this.highlightImage,this.changed(),contents&&this.bubbleHelp(contents)},TriggerMorph.prototype.mouseLeave=function(){this.image=this.normalImage,this.changed(),this.schedule&&(this.schedule.isActive=!1),this.hint&&this.world().hand.destroyTemporaries()},TriggerMorph.prototype.mouseDownLeft=function(){this.image=this.pressImage,this.changed()},TriggerMorph.prototype.mouseClickLeft=function(){this.image=this.highlightImage,this.changed(),this.trigger()},TriggerMorph.prototype.mouseDoubleClick=function(){this.triggerDoubleClick()},TriggerMorph.prototype.rootForGrab=function(){
return this.isDraggable?TriggerMorph.uber.rootForGrab.call(this):null},TriggerMorph.prototype.bubbleHelp=function(contents){var world=this.world(),myself=this;this.schedule=new Animation(nop,nop,0,500,nop,function(){myself.popUpbubbleHelp(contents)}),world.animations.push(this.schedule)},TriggerMorph.prototype.popUpbubbleHelp=function(contents){new SpeechBubbleMorph(localize(contents),null,null,1).popUp(this.world(),this.rightCenter().add(new Point(-8,0)))};var MenuItemMorph;MenuItemMorph.prototype=new TriggerMorph,MenuItemMorph.prototype.constructor=MenuItemMorph,MenuItemMorph.uber=TriggerMorph.prototype,MenuItemMorph.prototype.createLabel=function(){var w,h;
this.label&&this.label.destroy(),this.label=this.createLabelPart(this.labelString),this.add(this.label),w=this.label.width(),h=this.label.height(),this.shortcut&&this.shortcut.destroy(),this.shortcutString&&(this.shortcut=this.createLabelPart(this.shortcutString),w+=this.shortcut.width()+4,h=Math.max(h,this.shortcut.height()),this.add(this.shortcut)),this.silentSetExtent(new Point(w+8,h)),this.fixLayout()},MenuItemMorph.prototype.fixLayout=function(){var cntr=this.center();this.label.setCenter(cntr),this.label.setLeft(this.left()+4),this.shortcut&&(this.shortcut.setCenter(cntr),this.shortcut.setRight(this.right()-4))},MenuItemMorph.prototype.createLabelPart=function(source){
var part,icon,lbl;return isString(source)?this.createLabelString(source):source instanceof Array?(part=new Morph,part.alpha=0,icon=this.createIcon(source[0]),part.add(icon),lbl=this.createLabelString(source[1]),part.add(lbl),lbl.setCenter(icon.center()),lbl.setLeft(icon.right()+4),part.bounds=icon.bounds.merge(lbl.bounds),part.drawNew(),part):this.createIcon(source)},MenuItemMorph.prototype.createIcon=function(source){var src,icon=new Morph;return icon.image=source instanceof Morph?source.fullImage():source,source instanceof Morph&&source.getShadow()&&(src=icon.image,icon.image=newCanvas(source.fullBounds().extent().subtract(this.shadowBlur*(useBlurredShadows?1:2))),
icon.image.getContext("2d").drawImage(src,0,0)),icon.silentSetWidth(icon.image.width),icon.silentSetHeight(icon.image.height),icon},MenuItemMorph.prototype.createLabelString=function(string){var lbl=new TextMorph(string,this.fontSize,this.fontStyle,this.labelBold,this.labelItalic);return lbl.setColor(this.labelColor),lbl},MenuItemMorph.prototype.mouseEnter=function(){var menu=this.parentThatIsA(MenuMorph);this.isShowingSubmenu()||(menu&&menu.closeSubmenu(),this.isListItem()||(this.image=this.highlightImage,this.changed()),this.action instanceof MenuMorph?this.delaySubmenu():this.hint&&this.bubbleHelp(this.hint))},MenuItemMorph.prototype.mouseLeave=function(){
this.isListItem()||(this.isShowingSubmenu()?this.image=this.highlightImage:this.image=this.normalImage,this.changed()),this.schedule&&(this.schedule.isActive=!1),this.hint&&this.world().hand.destroyTemporaries()},MenuItemMorph.prototype.mouseDownLeft=function(pos){this.isListItem()&&(this.parent.unselectAllItems(),this.escalateEvent("mouseDownLeft",pos)),this.image=this.pressImage,this.changed()},MenuItemMorph.prototype.mouseMove=function(){this.isListItem()&&this.escalateEvent("mouseMove")},MenuItemMorph.prototype.mouseClickLeft=function(){this.action instanceof MenuMorph?this.popUpSubmenu():(this.isListItem()||(this.parent.closeRootMenu(),this.world().activeMenu=null),
this.trigger())},MenuItemMorph.prototype.isListItem=function(){return!!this.parent&&this.parent.isListContents},MenuItemMorph.prototype.isSelectedListItem=function(){return!!this.isListItem()&&this.image===this.pressImage},MenuItemMorph.prototype.isShowingSubmenu=function(){var menu=this.parentThatIsA(MenuMorph);return!!(menu&&this.action instanceof MenuMorph)&&menu.submenu===this.action},MenuItemMorph.prototype.delaySubmenu=function(){var world=this.world(),myself=this;this.schedule=new Animation(nop,nop,0,500,nop,function(){myself.popUpSubmenu()}),world.animations.push(this.schedule)},MenuItemMorph.prototype.popUpSubmenu=function(){var menu=this.parentThatIsA(MenuMorph);
this.action instanceof MenuMorph&&(this.action.drawNew(),this.action.setPosition(this.topRight().subtract(new Point(0,5))),this.action.addShadow(new Point(2,2),80),this.action.keepWithin(this.world()),this.action.items.length<1&&!this.action.title||(menu.add(this.action),menu.submenu=this.action,menu.submenu.world=menu.world,this.action.fullChanged()))},FrameMorph.prototype=new Morph,FrameMorph.prototype.constructor=FrameMorph,FrameMorph.uber=Morph.prototype,FrameMorph.prototype.init=function(aScrollFrame){this.scrollFrame=aScrollFrame||null,FrameMorph.uber.init.call(this),this.color=new Color(255,250,245),this.drawNew(),this.acceptsDrops=!0,this.scrollFrame&&(this.isDraggable=!1,
this.noticesTransparentClick=!1,this.alpha=0)},FrameMorph.prototype.fullBounds=function(){var shadow=this.getShadow();return null!==shadow?this.bounds.merge(shadow.bounds):this.bounds},FrameMorph.prototype.fullImage=function(){return this.image},FrameMorph.prototype.fullDrawOn=function(aCanvas,aRect){var rectangle,dirty;return this.isVisible?(rectangle=aRect||this.fullBounds(),dirty=this.bounds.intersect(rectangle),dirty.extent().gt(new Point(0,0))?(this.drawOn(aCanvas,dirty),void this.children.forEach(function(child){child instanceof ShadowMorph?child.fullDrawOn(aCanvas,rectangle):child.fullDrawOn(aCanvas,dirty)})):null):null},FrameMorph.prototype.topMorphAt=function(point){
var i,result;if(!this.isVisible||!this.bounds.containsPoint(point))return null;for(i=this.children.length-1;i>=0;i-=1)if(result=this.children[i].topMorphAt(point))return result;return this.noticesTransparentClick||!this.isTransparentAt(point)?this:null},FrameMorph.prototype.submorphBounds=function(){var result=null;return this.children.length>0&&(result=this.children[0].bounds,this.children.forEach(function(child){result=result.merge(child.fullBounds())})),result},FrameMorph.prototype.keepInScrollFrame=function(){return null===this.scrollFrame?null:(this.left()>this.scrollFrame.left()&&this.moveBy(new Point(this.scrollFrame.left()-this.left(),0)),this.right()<this.scrollFrame.right()&&this.moveBy(new Point(this.scrollFrame.right()-this.right(),0)),
this.top()>this.scrollFrame.top()&&this.moveBy(new Point(0,this.scrollFrame.top()-this.top())),void(this.bottom()<this.scrollFrame.bottom()&&this.moveBy(0,new Point(this.scrollFrame.bottom()-this.bottom(),0))))},FrameMorph.prototype.adjustBounds=function(){var subBounds,newBounds,myself=this;return null===this.scrollFrame?null:(subBounds=this.submorphBounds(),newBounds=subBounds&&!this.scrollFrame.isTextLineWrapping?subBounds.expandBy(this.scrollFrame.padding).growBy(this.scrollFrame.growth).merge(this.scrollFrame.bounds):this.scrollFrame.bounds.copy(),this.bounds.eq(newBounds)||(this.bounds=newBounds,this.drawNew(),this.keepInScrollFrame()),this.scrollFrame.isTextLineWrapping&&this.children.forEach(function(morph){
morph instanceof TextMorph&&(morph.setWidth(myself.width()),myself.setHeight(Math.max(morph.height(),myself.scrollFrame.height())))}),void this.scrollFrame.adjustScrollBars())},FrameMorph.prototype.reactToDropOf=function(){this.adjustBounds()},FrameMorph.prototype.reactToGrabOf=function(){this.adjustBounds()},FrameMorph.prototype.developersMenu=function(){var menu=FrameMorph.uber.developersMenu.call(this);return this.children.length>0&&(menu.addLine(),menu.addItem("move all inside...","keepAllSubmorphsWithin","keep all submorphs\nwithin and visible")),menu},FrameMorph.prototype.keepAllSubmorphsWithin=function(){var myself=this;this.children.forEach(function(m){
m.keepWithin(myself)})},ScrollFrameMorph.prototype=new FrameMorph,ScrollFrameMorph.prototype.constructor=ScrollFrameMorph,ScrollFrameMorph.uber=FrameMorph.prototype,ScrollFrameMorph.prototype.init=function(scroller,size,sliderColor){var myself=this;ScrollFrameMorph.uber.init.call(this),this.scrollBarSize=size||MorphicPreferences.scrollBarSize,this.autoScrollTrigger=null,this.enableAutoScrolling=!0,this.isScrollingByDragging=!0,this.hasVelocity=!0,this.padding=0,this.growth=0,this.isTextLineWrapping=!1,this.contents=scroller||new FrameMorph(this),this.add(this.contents),this.hBar=new SliderMorph(null,null,null,null,"horizontal",sliderColor),this.hBar.setHeight(this.scrollBarSize),
this.hBar.action=function(num){myself.contents.setPosition(new Point(myself.left()-num,myself.contents.position().y))},this.hBar.isDraggable=!1,this.add(this.hBar),this.vBar=new SliderMorph(null,null,null,null,"vertical",sliderColor),this.vBar.setWidth(this.scrollBarSize),this.vBar.action=function(num){myself.contents.setPosition(new Point(myself.contents.position().x,myself.top()-num))},this.vBar.isDraggable=!1,this.add(this.vBar),this.toolBar=null},ScrollFrameMorph.prototype.adjustScrollBars=function(){var hWidth=this.width()-this.scrollBarSize,vHeight=this.height()-this.scrollBarSize;this.changed(),this.contents.width()>this.width()+MorphicPreferences.scrollBarSize?(this.hBar.show(),
this.hBar.width()!==hWidth&&this.hBar.setWidth(hWidth),this.hBar.setPosition(new Point(this.left(),this.bottom()-this.hBar.height())),this.hBar.start=0,this.hBar.stop=this.contents.width()-this.width(),this.hBar.size=this.width()/this.contents.width()*this.hBar.stop,this.hBar.value=this.left()-this.contents.left(),this.hBar.drawNew()):this.hBar.hide(),this.contents.height()>this.height()+this.scrollBarSize?(this.vBar.show(),this.vBar.height()!==vHeight&&this.vBar.setHeight(vHeight),this.vBar.setPosition(new Point(this.right()-this.vBar.width(),this.top())),this.vBar.start=0,this.vBar.stop=this.contents.height()-this.height(),this.vBar.size=this.height()/this.contents.height()*this.vBar.stop,
this.vBar.value=this.top()-this.contents.top(),this.vBar.drawNew()):this.vBar.hide(),this.adjustToolBar()},ScrollFrameMorph.prototype.adjustToolBar=function(){var padding=3;this.toolBar&&(this.toolBar.setTop(this.top()+padding),this.toolBar.setRight((this.vBar.isVisible?this.vBar.left():this.right())-padding))},ScrollFrameMorph.prototype.addContents=function(aMorph){this.contents.add(aMorph),this.contents.adjustBounds()},ScrollFrameMorph.prototype.setContents=function(aMorph){this.contents.children.forEach(function(m){m.destroy()}),this.contents.children=[],aMorph.setPosition(this.position().add(this.padding+2)),this.addContents(aMorph)},ScrollFrameMorph.prototype.setExtent=function(aPoint){
this.isTextLineWrapping&&this.contents.setPosition(this.position().copy()),ScrollFrameMorph.uber.setExtent.call(this,aPoint),this.contents.adjustBounds()},ScrollFrameMorph.prototype.scrollX=function(steps){var newX,cl=this.contents.left(),l=this.left(),cw=this.contents.width(),r=this.right();newX=cl+steps,newX+cw<r&&(newX=r-cw),newX>l&&(newX=l),newX!==cl&&this.contents.setLeft(newX)},ScrollFrameMorph.prototype.scrollY=function(steps){var newY,ct=this.contents.top(),t=this.top(),ch=this.contents.height(),b=this.bottom();newY=ct+steps,newY+ch<b&&(newY=b-ch),newY>t&&(newY=t),newY!==ct&&this.contents.setTop(newY)},ScrollFrameMorph.prototype.step=nop,ScrollFrameMorph.prototype.mouseDownLeft=function(pos){
if(!this.isScrollingByDragging)return null;var world=this.root(),hand=world.hand,oldPos=pos,myself=this,deltaX=0,deltaY=0,friction=.8;this.step=function(){var newPos;if(hand.mouseButton&&0===hand.children.length&&myself.bounds.containsPoint(hand.bounds.origin)){if(hand.grabPosition&&hand.grabPosition.distanceTo(hand.position())<=MorphicPreferences.grabThreshold)return null;newPos=hand.bounds.origin,deltaX=newPos.x-oldPos.x,0!==deltaX&&myself.scrollX(deltaX),deltaY=newPos.y-oldPos.y,0!==deltaY&&myself.scrollY(deltaY),oldPos=newPos}else myself.hasVelocity?Math.abs(deltaX)<.5&&Math.abs(deltaY)<.5?myself.step=function(){nop()}:(deltaX*=friction,myself.scrollX(Math.round(deltaX)),
deltaY*=friction,myself.scrollY(Math.round(deltaY))):myself.step=function(){nop()};this.adjustScrollBars()}},ScrollFrameMorph.prototype.startAutoScrolling=function(){var hand,inner,pos,myself=this,inset=3*MorphicPreferences.scrollBarSize,world=this.world();return world?(hand=world.hand,this.autoScrollTrigger||(this.autoScrollTrigger=Date.now()),void(this.step=function(){pos=hand.bounds.origin,inner=myself.bounds.insetBy(inset),myself.bounds.containsPoint(pos)&&!inner.containsPoint(pos)&&hand.children.length>0?myself.autoScroll(pos):(myself.step=function(){nop()},myself.autoScrollTrigger=null)})):null},ScrollFrameMorph.prototype.autoScroll=function(pos){var inset,area;
return Date.now()-this.autoScrollTrigger<500?null:(inset=3*MorphicPreferences.scrollBarSize,area=this.topLeft().extent(new Point(this.width(),inset)),area.containsPoint(pos)&&this.scrollY(inset-(pos.y-this.top())),area=this.topLeft().extent(new Point(inset,this.height())),area.containsPoint(pos)&&this.scrollX(inset-(pos.x-this.left())),area=new Point(this.right()-inset,this.top()).extent(new Point(inset,this.height())),area.containsPoint(pos)&&this.scrollX(-(inset-(this.right()-pos.x))),area=new Point(this.left(),this.bottom()-inset).extent(new Point(this.width(),inset)),area.containsPoint(pos)&&this.scrollY(-(inset-(this.bottom()-pos.y))),void this.adjustScrollBars());
},ScrollFrameMorph.prototype.scrollCursorIntoView=function(morph){var txt=morph.target,offset=txt.position().subtract(this.contents.position()),ft=this.top()+this.padding,fb=this.bottom()-this.padding;this.contents.setExtent(txt.extent().add(offset).add(this.padding)),morph.top()<ft?(this.contents.setTop(this.contents.top()+ft-morph.top()),morph.setTop(ft)):morph.bottom()>fb&&(this.contents.setBottom(this.contents.bottom()+fb-morph.bottom()),morph.setBottom(fb)),this.adjustScrollBars()},ScrollFrameMorph.prototype.mouseScroll=function(y,x){y&&this.scrollY(y*MorphicPreferences.mouseScrollAmount),x&&this.scrollX(x*MorphicPreferences.mouseScrollAmount),this.adjustScrollBars();
},ScrollFrameMorph.prototype.updateReferences=function(map){var myself=this;ScrollFrameMorph.uber.updateReferences.call(this,map),this.hBar&&(this.hBar.action=function(num){myself.contents.setPosition(new Point(myself.left()-num,myself.contents.position().y))}),this.vBar&&(this.vBar.action=function(num){myself.contents.setPosition(new Point(myself.contents.position().x,myself.top()-num))})},ScrollFrameMorph.prototype.developersMenu=function(){var menu=ScrollFrameMorph.uber.developersMenu.call(this);return this.isTextLineWrapping?menu.addItem("auto line wrap off...","toggleTextLineWrapping","turn automatic\nline wrapping\noff"):menu.addItem("auto line wrap on...","toggleTextLineWrapping","enable automatic\nline wrapping"),
menu},ScrollFrameMorph.prototype.toggleTextLineWrapping=function(){this.isTextLineWrapping=!this.isTextLineWrapping},ListMorph.prototype=new ScrollFrameMorph,ListMorph.prototype.constructor=ListMorph,ListMorph.uber=ScrollFrameMorph.prototype,ListMorph.prototype.init=function(elements,labelGetter,format,doubleClickAction){ListMorph.uber.init.call(this),this.contents.acceptsDrops=!1,this.color=new Color(255,255,255),this.hBar.alpha=.6,this.vBar.alpha=.6,this.elements=elements||[],this.labelGetter=labelGetter,this.format=format,this.listContents=null,this.selected=null,this.active=null,this.action=null,this.doubleClickAction=doubleClickAction||null,this.acceptsDrops=!1,
this.buildListContents()},ListMorph.prototype.buildListContents=function(){var myself=this;this.listContents&&this.listContents.destroy(),this.listContents=new MenuMorph(this.select,null,this),0===this.elements.length&&(this.elements=["(empty)"]),this.elements.forEach(function(element){var color=null,bold=!1,italic=!1;myself.format.forEach(function(pair){pair[1].call(null,element)&&("bold"===pair[0]?bold=!0:"italic"===pair[0]?italic=!0:color=pair[0])}),myself.listContents.addItem(myself.labelGetter(element),element,null,color,bold,italic,myself.doubleClickAction)}),this.listContents.isListContents=!0,this.listContents.drawNew(),this.listContents.setPosition(this.contents.position()),
this.addContents(this.listContents)},ListMorph.prototype.select=function(item,trigger){isNil(item)||(this.selected=item,this.active=trigger,this.action&&this.action.call(null,item))},ListMorph.prototype.setExtent=function(aPoint){var lb=this.listContents.bounds,nb=this.bounds.origin.copy().corner(this.bounds.origin.add(aPoint));nb.right()>lb.right()&&nb.width()<=lb.width()&&this.listContents.setRight(nb.right()),nb.bottom()>lb.bottom()&&nb.height()<=lb.height()&&this.listContents.setBottom(nb.bottom()),ListMorph.uber.setExtent.call(this,aPoint)},ListMorph.prototype.activeIndex=function(){return this.listContents.children.indexOf(this.active)},ListMorph.prototype.activateIndex=function(idx){
var item=this.listContents.children[idx];item&&(item.image=item.pressImage,item.changed(),item.trigger())},StringFieldMorph.prototype=new FrameMorph,StringFieldMorph.prototype.constructor=StringFieldMorph,StringFieldMorph.uber=FrameMorph.prototype,StringFieldMorph.prototype.init=function(defaultContents,minWidth,fontSize,fontStyle,bold,italic,isNumeric){this.defaultContents=defaultContents,this.minWidth=minWidth,this.fontSize=fontSize,this.fontStyle=fontStyle,this.isBold=bold,this.isItalic=italic,this.isNumeric=isNumeric||!1,this.text=null,StringFieldMorph.uber.init.call(this),this.color=new Color(255,255,255),this.isEditable=!0,this.acceptsDrops=!1,this.drawNew();
},StringFieldMorph.prototype.drawNew=function(){var txt;txt=this.text?this.string():this.defaultContents,this.text=null,this.children.forEach(function(child){child.destroy()}),this.children=[],this.text=new StringMorph(txt,this.fontSize,this.fontStyle,this.isBold,this.isItalic,this.isNumeric),this.text.isNumeric=this.isNumeric,this.text.setPosition(this.bounds.origin.copy()),this.text.isEditable=this.isEditable,this.text.isDraggable=!1,this.text.enableSelecting(),this.silentSetExtent(new Point(Math.max(this.width(),this.minWidth),this.text.height())),StringFieldMorph.uber.drawNew.call(this),this.add(this.text)},StringFieldMorph.prototype.string=function(){return this.text.text;
},StringFieldMorph.prototype.mouseClickLeft=function(pos){this.isEditable?this.text.edit():this.escalateEvent("mouseClickLeft",pos)};var BouncerMorph;BouncerMorph.prototype=new Morph,BouncerMorph.prototype.constructor=BouncerMorph,BouncerMorph.uber=Morph.prototype,BouncerMorph.prototype.init=function(type,speed){BouncerMorph.uber.init.call(this),this.fps=50,this.isStopped=!1,this.type=type||"vertical","vertical"===this.type?this.direction="down":this.direction="right",this.speed=speed||1},BouncerMorph.prototype.moveUp=function(){this.moveBy(new Point(0,-this.speed))},BouncerMorph.prototype.moveDown=function(){this.moveBy(new Point(0,this.speed))},BouncerMorph.prototype.moveRight=function(){
this.moveBy(new Point(this.speed,0))},BouncerMorph.prototype.moveLeft=function(){this.moveBy(new Point(-this.speed,0))},BouncerMorph.prototype.step=function(){this.isStopped||("vertical"===this.type?("down"===this.direction?this.moveDown():this.moveUp(),this.fullBounds().top()<this.parent.top()&&"up"===this.direction&&(this.direction="down"),this.fullBounds().bottom()>this.parent.bottom()&&"down"===this.direction&&(this.direction="up")):"horizontal"===this.type&&("right"===this.direction?this.moveRight():this.moveLeft(),this.fullBounds().left()<this.parent.left()&&"left"===this.direction&&(this.direction="right"),this.fullBounds().right()>this.parent.right()&&"right"===this.direction&&(this.direction="left")));
},HandMorph.prototype=new Morph,HandMorph.prototype.constructor=HandMorph,HandMorph.uber=Morph.prototype,HandMorph.prototype.init=function(aWorld){HandMorph.uber.init.call(this,!0),this.bounds=new Rectangle,this.world=aWorld,this.mouseButton=null,this.mouseOverList=[],this.morphToGrab=null,this.grabPosition=null,this.grabOrigin=null,this.temporaries=[],this.touchHoldTimeout=null,this.contextMenuEnabled=!1},HandMorph.prototype.changed=function(){var b;null!==this.world&&(b=this.fullBounds(),b.extent().eq(new Point)||this.world.broken.push(b.spread()))},HandMorph.prototype.fullChanged=HandMorph.prototype.changed,HandMorph.prototype.morphAtPointer=function(){return this.world.topMorphAt(this.bounds.origin)||this.world;
},HandMorph.prototype.allMorphsAtPointer=function(){var morphs=this.world.allChildren(),myself=this;return morphs.filter(function(m){return m.isVisible&&m.visibleBounds().containsPoint(myself.bounds.origin)})},HandMorph.prototype.dropTargetFor=function(aMorph){for(var target=this.morphAtPointer();!target.wantsDropOf(aMorph);)target=target.parent;return target},HandMorph.prototype.grab=function(aMorph){var oldParent=aMorph.parent;return aMorph instanceof WorldMorph?null:void(0===this.children.length&&(this.world.stopEditing(),this.grabOrigin=aMorph.situation(),aMorph.addShadow(),aMorph.prepareToBeGrabbed&&aMorph.prepareToBeGrabbed(this),aMorph.cachedFullImage=aMorph.fullImageClassic(),
aMorph.cachedFullBounds=aMorph.fullBounds(),this.add(aMorph),this.changed(),oldParent&&oldParent.reactToGrabOf&&oldParent.reactToGrabOf(aMorph)))},HandMorph.prototype.drop=function(){var target,morphToDrop;0!==this.children.length&&(morphToDrop=this.children[0],target=this.dropTargetFor(morphToDrop),target=target.selectForEdit?target.selectForEdit():target,this.changed(),target.add(morphToDrop),morphToDrop.cachedFullImage=null,morphToDrop.cachedFullBounds=null,morphToDrop.changed(),morphToDrop.removeShadow(),this.children=[],this.setExtent(new Point),morphToDrop.justDropped&&morphToDrop.justDropped(this),target.reactToDropOf&&target.reactToDropOf(morphToDrop,this));
},HandMorph.prototype.processMouseDown=function(event){var morph,actualClick;if(this.destroyTemporaries(),this.contextMenuEnabled=!0,this.morphToGrab=null,this.grabPosition=null,0!==this.children.length)this.drop(),this.mouseButton=null;else{for(morph=this.morphAtPointer(),this.world.activeMenu&&(contains(morph.allParents(),this.world.activeMenu)?clearInterval(this.touchHoldTimeout):this.world.activeMenu.destroy()),this.world.activeHandle&&morph!==this.world.activeHandle&&this.world.activeHandle.destroy(),this.world.cursor&&morph!==this.world.cursor.target&&this.world.stopEditing(),morph.mouseMove||(this.morphToGrab=morph.rootForGrab(),this.grabPosition=this.bounds.origin.copy()),
2===event.button||event.ctrlKey?(this.mouseButton="right",actualClick="mouseDownRight"):(this.mouseButton="left",actualClick="mouseDownLeft");!morph[actualClick];)morph=morph.parent;morph[actualClick](this.bounds.origin)}},HandMorph.prototype.processTouchStart=function(event){var myself=this;MorphicPreferences.isTouchDevice=!0,clearInterval(this.touchHoldTimeout),1===event.touches.length&&(this.touchHoldTimeout=setInterval(function(){myself.processMouseDown({button:2}),myself.processMouseUp({button:2}),event.preventDefault(),clearInterval(myself.touchHoldTimeout)},400),this.processMouseMove(event.touches[0]),this.processMouseDown({button:0}),event.preventDefault());
},HandMorph.prototype.processTouchMove=function(event){if(MorphicPreferences.isTouchDevice=!0,1===event.touches.length){var touch=event.touches[0];this.processMouseMove(touch),clearInterval(this.touchHoldTimeout)}},HandMorph.prototype.processTouchEnd=function(event){MorphicPreferences.isTouchDevice=!0,clearInterval(this.touchHoldTimeout),nop(event),this.processMouseUp({button:0})},HandMorph.prototype.processMouseUp=function(){var context,contextMenu,expectedClick,morph=this.morphAtPointer();if(this.destroyTemporaries(),0!==this.children.length)this.drop();else{if("left"===this.mouseButton)expectedClick="mouseClickLeft";else if(expectedClick="mouseClickRight",
this.mouseButton&&this.contextMenuEnabled){for(context=morph,contextMenu=context.contextMenu();!contextMenu&&context.parent;)context=context.parent,contextMenu=context.contextMenu();contextMenu&&contextMenu.popUpAtHand(this.world)}for(;!morph[expectedClick];)morph=morph.parent;morph[expectedClick](this.bounds.origin)}this.mouseButton=null},HandMorph.prototype.processDoubleClick=function(){var morph=this.morphAtPointer();if(this.destroyTemporaries(),0!==this.children.length)this.drop();else{for(;morph&&!morph.mouseDoubleClick;)morph=morph.parent;morph&&morph.mouseDoubleClick(this.bounds.origin)}this.mouseButton=null},HandMorph.prototype.processMouseMove=function(event){
var pos,mouseOverNew,morph,topMorph,posInDocument=getDocumentPositionOf(this.world.worldCanvas),myself=this;pos=new Point(event.pageX-posInDocument.x,event.pageY-posInDocument.y),this.setPosition(pos),mouseOverNew=this.morphAtPointer().allParents(),!this.children.length&&this.mouseButton&&(topMorph=this.morphAtPointer(),morph=topMorph.rootForGrab(),topMorph.mouseMove&&(topMorph.mouseMove(pos,this.mouseButton),"right"===this.mouseButton&&(this.contextMenuEnabled=!1)),"left"===this.mouseButton&&this.morphToGrab&&this.grabPosition.distanceTo(this.bounds.origin)>MorphicPreferences.grabThreshold&&(this.setPosition(this.grabPosition),this.morphToGrab.isDraggable?(morph=this.morphToGrab.selectForEdit?this.morphToGrab.selectForEdit():this.morphToGrab,
this.grab(morph)):this.morphToGrab.isTemplate&&(morph=this.morphToGrab.fullCopy(),morph.isTemplate=!1,morph.isDraggable=!0,morph.reactToTemplateCopy&&morph.reactToTemplateCopy(),this.grab(morph),this.grabOrigin=this.morphToGrab.situation()),this.setPosition(pos))),this.mouseOverList.forEach(function(old){contains(mouseOverNew,old)||(old.mouseLeave&&old.mouseLeave(),old.mouseLeaveDragging&&myself.mouseButton&&old.mouseLeaveDragging())}),mouseOverNew.forEach(function(newMorph){contains(myself.mouseOverList,newMorph)||(newMorph.mouseEnter&&newMorph.mouseEnter(),newMorph.mouseEnterDragging&&myself.mouseButton&&newMorph.mouseEnterDragging()),myself.children.length>0&&newMorph instanceof ScrollFrameMorph&&newMorph.enableAutoScrolling&&newMorph.contents.allChildren().some(function(any){
return any.wantsDropOf(myself.children[0])})&&(newMorph.bounds.insetBy(3*MorphicPreferences.scrollBarSize).containsPoint(myself.bounds.origin)||newMorph.startAutoScrolling())}),this.mouseOverList=mouseOverNew},HandMorph.prototype.processMouseScroll=function(event){for(var morph=this.morphAtPointer();morph&&!morph.mouseScroll;)morph=morph.parent;morph&&morph.mouseScroll(event.detail/-3||(Object.prototype.hasOwnProperty.call(event,"wheelDeltaY")?event.wheelDeltaY/120:event.wheelDelta/120),event.wheelDeltaX/120||0)},HandMorph.prototype.processDrop=function(event){function readSVG(aFile){for(var pic=new Image,frd=new FileReader;!target.droppedSVG;)target=target.parent;
pic.onload=function(){target.droppedSVG(pic,aFile.name)},frd=new FileReader,frd.onloadend=function(e){pic.src=e.target.result},frd.readAsDataURL(aFile)}function readImage(aFile){for(var pic=new Image,frd=new FileReader;!target.droppedImage;)target=target.parent;pic.onload=function(){canvas=newCanvas(new Point(pic.width,pic.height),!0),canvas.getContext("2d").drawImage(pic,0,0),target.droppedImage(canvas,aFile.name)},frd=new FileReader,frd.onloadend=function(e){pic.src=e.target.result},frd.readAsDataURL(aFile)}function readAudio(aFile){for(var snd=new Audio,frd=new FileReader;!target.droppedAudio;)target=target.parent;frd.onloadend=function(e){snd.src=e.target.result,
target.droppedAudio(snd,aFile.name)},frd.readAsDataURL(aFile)}function readText(aFile){for(var frd=new FileReader;!target.droppedText;)target=target.parent;frd.onloadend=function(e){target.droppedText(e.target.result,aFile.name)},frd.readAsText(aFile)}function readBinary(aFile){for(var frd=new FileReader;!target.droppedBinary;)target=target.parent;frd.onloadend=function(e){target.droppedBinary(e.target.result,aFile.name)},frd.readAsArrayBuffer(aFile)}function readURL(url,callback){var request=new XMLHttpRequest;request.open("GET",url),request.onreadystatechange=function(){if(4===request.readyState){if(!request.responseText)throw new Error("unable to retrieve "+url);
callback(request.responseText)}},request.send()}function parseImgURL(html){var idx,c,iurl="",start=html.indexOf('<img src="');if(start===-1)return null;for(start+=10,idx=start;idx<html.length;idx+=1){if(c=html[idx],'"'===c)return iurl;iurl=iurl.concat(c)}return null}var file,suffix,src,canvas,i,files=event instanceof FileList?event:event.target.files||event.dataTransfer.files,url=event.dataTransfer?event.dataTransfer.getData("URL"):null,txt=event.dataTransfer?event.dataTransfer.getData("Text/HTML"):null,target=this.morphAtPointer(),img=new Image;if(files.length>0)for(i=0;i<files.length;i+=1)file=files[i],file.type.indexOf("svg")===-1||MorphicPreferences.rasterizeSVGs?0===file.type.indexOf("image")?readImage(file):0===file.type.indexOf("audio")?readAudio(file):0===file.type.indexOf("text")?readText(file):readBinary(file):readSVG(file);else if(url){
if(suffix=url.slice(url.lastIndexOf(".")+1).toLowerCase(),contains(["gif","png","jpg","jpeg","bmp"],suffix)){for(;!target.droppedImage;)target=target.parent;img=new Image,img.onload=function(){canvas=newCanvas(new Point(img.width,img.height),!0),canvas.getContext("2d").drawImage(img,0,0),target.droppedImage(canvas)},img.src=url}else if("svg"===suffix&&!MorphicPreferences.rasterizeSVGs){for(;!target.droppedSVG;)target=target.parent;readURL(url,function(txt){var pic=new Image;pic.onload=function(){target.droppedSVG(pic,url.slice(url.lastIndexOf("/")+1,url.lastIndexOf(".")))},pic.src="data:image/svg+xml;utf8,"+encodeURIComponent(txt)})}}else if(txt){for(;!target.droppedImage;)target=target.parent;
img=new Image,img.onload=function(){canvas=newCanvas(new Point(img.width,img.height),!0),canvas.getContext("2d").drawImage(img,0,0),target.droppedImage(canvas)},src=parseImgURL(txt),src&&(img.src=src)}},HandMorph.prototype.destroyTemporaries=function(){var myself=this;this.temporaries.forEach(function(morph){morph.isClickable&&morph.bounds.containsPoint(myself.position())||(morph.destroy(),myself.temporaries.splice(myself.temporaries.indexOf(morph),1))})},WorldMorph.prototype=new FrameMorph,WorldMorph.prototype.constructor=WorldMorph,WorldMorph.uber=FrameMorph.prototype,WorldMorph.prototype.init=function(aCanvas,fillPage){for(WorldMorph.uber.init.call(this),this.color=new Color(205,205,205),
this.alpha=1,this.bounds=new Rectangle(0,0,aCanvas.width,aCanvas.height),this.drawNew(),this.isVisible=!0,this.isDraggable=!1,this.currentKey=null,this.worldCanvas=aCanvas,this.noticesTransparentClick=!0,this.stamp=Date.now();this.stamp===Date.now();)nop();this.stamp=Date.now(),this.useFillPage=fillPage,void 0===this.useFillPage&&(this.useFillPage=!0),this.isDevMode=!1,this.broken=[],this.animations=[],this.hand=new HandMorph(this),this.keyboardReceiver=null,this.cursor=null,this.lastEditedText=null,this.activeMenu=null,this.activeHandle=null,this.virtualKeyboard=null,this.initEventListeners()},WorldMorph.prototype.brokenFor=function(aMorph){var fb=aMorph.fullBounds();
return this.broken.filter(function(rect){return rect.intersects(fb)})},WorldMorph.prototype.fullDrawOn=function(aCanvas,aRect){WorldMorph.uber.fullDrawOn.call(this,aCanvas,aRect),this.hand.fullDrawOn(aCanvas,aRect)},WorldMorph.prototype.updateBroken=function(){var myself=this;this.condenseDamages(),this.broken.forEach(function(rect){rect.extent().gt(new Point(0,0))&&myself.fullDrawOn(myself.worldCanvas,rect)}),this.broken=[]},WorldMorph.prototype.stepAnimations=function(){this.animations.forEach(function(anim){anim.step()}),this.animations=this.animations.filter(function(anim){return anim.isActive})},WorldMorph.prototype.condenseDamages=function(){function condense(src){
var hit,trgt=[];return src.forEach(function(rect){hit=detect(trgt,function(each){return each.isNearTo(rect,20)}),hit?hit.mergeWith(rect):trgt.push(rect)}),trgt}for(var again=!0,size=this.broken.length;again;)this.broken=condense(this.broken),again=this.broken.length<size,size=this.broken.length},WorldMorph.prototype.doOneCycle=function(){this.stepFrame(),this.stepAnimations(),this.updateBroken()},WorldMorph.prototype.fillPage=function(){var clientHeight=window.innerHeight,clientWidth=window.innerWidth,myself=this;clientHeight*=.8,clientWidth*=.6,this.worldCanvas.style.position="relative",this.worldCanvas.style.left="0px",this.worldCanvas.style.right="0px",document.documentElement.scrollTop&&(clientHeight=document.documentElement.clientHeight),
document.documentElement.scrollLeft&&(clientWidth=document.documentElement.clientWidth),this.worldCanvas.width!==clientWidth&&(this.worldCanvas.width=clientWidth,this.setWidth(clientWidth)),this.worldCanvas.height!==clientHeight&&(this.worldCanvas.height=clientHeight,this.setHeight(clientHeight)),this.children.forEach(function(child){child.reactToWorldResize&&child.reactToWorldResize(myself.bounds.copy())})},WorldMorph.prototype.getGlobalPixelColor=function(point){var clr=this.hand.morphAtPointer().getPixelColor(this.hand.position());return clr},WorldMorph.prototype.initVirtualKeyboard=function(){var myself=this;this.virtualKeyboard&&(document.body.removeChild(this.virtualKeyboard),
this.virtualKeyboard=null),MorphicPreferences.isTouchDevice&&MorphicPreferences.useVirtualKeyboard&&(this.virtualKeyboard=document.createElement("input"),this.virtualKeyboard.type="text",this.virtualKeyboard.style.color="transparent",this.virtualKeyboard.style.backgroundColor="transparent",this.virtualKeyboard.style.border="none",this.virtualKeyboard.style.outline="none",this.virtualKeyboard.style.position="absolute",this.virtualKeyboard.style.top="0px",this.virtualKeyboard.style.left="0px",this.virtualKeyboard.style.width="0px",this.virtualKeyboard.style.height="0px",this.virtualKeyboard.autocapitalize="none",document.body.appendChild(this.virtualKeyboard),this.virtualKeyboard.addEventListener("keydown",function(event){
myself.currentKey=event.keyCode,myself.keyboardReceiver&&myself.keyboardReceiver.processKeyDown(event),8===event.keyCode&&event.preventDefault(),9===event.keyCode&&(myself.keyboardReceiver&&myself.keyboardReceiver.processKeyPress(event),event.preventDefault())},!1),this.virtualKeyboard.addEventListener("keyup",function(event){myself.currentKey=null,myself.keyboardReceiver&&myself.keyboardReceiver.processKeyUp&&myself.keyboardReceiver.processKeyUp(event),event.preventDefault()},!1),this.virtualKeyboard.addEventListener("keypress",function(event){myself.keyboardReceiver&&myself.keyboardReceiver.processKeyPress(event),event.preventDefault()},!1))},WorldMorph.prototype.initEventListeners=function(){
var canvas=this.worldCanvas,myself=this;myself.useFillPage?myself.fillPage():this.changed(),canvas.addEventListener("mousedown",function(event){event.preventDefault(),canvas.focus(),myself.hand.processMouseDown(event)},!1),canvas.addEventListener("touchstart",function(event){myself.hand.processTouchStart(event)},!1),canvas.addEventListener("mouseup",function(event){event.preventDefault(),myself.hand.processMouseUp(event)},!1),canvas.addEventListener("dblclick",function(event){event.preventDefault(),myself.hand.processDoubleClick(event)},!1),canvas.addEventListener("touchend",function(event){myself.hand.processTouchEnd(event)},!1),canvas.addEventListener("mousemove",function(event){
myself.hand.processMouseMove(event)},!1),canvas.addEventListener("touchmove",function(event){myself.hand.processTouchMove(event)},!1),canvas.addEventListener("contextmenu",function(event){event.preventDefault()},!1),canvas.addEventListener("keydown",function(event){myself.currentKey=event.keyCode,myself.keyboardReceiver&&myself.keyboardReceiver.processKeyDown(event),8===event.keyCode&&event.preventDefault(),9===event.keyCode&&(myself.keyboardReceiver&&myself.keyboardReceiver.processKeyPress(event),event.preventDefault()),(event.ctrlKey&&!event.altKey||event.metaKey)&&86!==event.keyCode&&event.preventDefault()},!1),canvas.addEventListener("keyup",function(event){
myself.currentKey=null,myself.keyboardReceiver&&myself.keyboardReceiver.processKeyUp&&myself.keyboardReceiver.processKeyUp(event),event.preventDefault()},!1),canvas.addEventListener("keypress",function(event){myself.keyboardReceiver&&myself.keyboardReceiver.processKeyPress(event),event.preventDefault()},!1),canvas.addEventListener("mousewheel",function(event){myself.hand.processMouseScroll(event),event.preventDefault()},!1),canvas.addEventListener("DOMMouseScroll",function(event){myself.hand.processMouseScroll(event),event.preventDefault()},!1),document.body.addEventListener("paste",function(event){var txt=event.clipboardData.getData("Text");txt&&myself.cursor&&myself.cursor.insert(txt);
},!1),window.addEventListener("dragover",function(event){event.preventDefault()},!1),window.addEventListener("drop",function(event){myself.hand.processDrop(event),event.preventDefault()},!1),window.addEventListener("resize",function(){myself.useFillPage&&myself.fillPage()},!1)},WorldMorph.prototype.mouseDownLeft=nop,WorldMorph.prototype.mouseClickLeft=nop,WorldMorph.prototype.mouseDownRight=nop,WorldMorph.prototype.mouseClickRight=nop,WorldMorph.prototype.wantsDropOf=function(){return this.acceptsDrops},WorldMorph.prototype.droppedImage=function(){return null},WorldMorph.prototype.droppedSVG=function(){return null},WorldMorph.prototype.nextTab=function(editField){
var next=this.nextEntryField(editField);next&&(editField.clearSelection(),next.selectAll(),next.edit())},WorldMorph.prototype.previousTab=function(editField){var prev=this.previousEntryField(editField);prev&&(editField.clearSelection(),prev.selectAll(),prev.edit())},WorldMorph.prototype.contextMenu=function(){var menu;return menu=this.isDevMode?new MenuMorph(this,this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0]):new MenuMorph(this,"Morphic"),this.isDevMode&&(menu.addItem("demo...","userCreateMorph","sample morphs"),menu.addLine(),menu.addItem("hide all...","hideAll"),menu.addItem("show all...","showAllHiddens"),menu.addItem("move all inside...","keepAllSubmorphsWithin","keep all submorphs\nwithin and visible"),
menu.addItem("inspect...","inspect","open a window on\nall properties"),menu.addItem("screenshot...",function(){window.open(this.fullImageClassic().toDataURL())},"open a new window\nwith a picture of this morph"),menu.addLine(),menu.addItem("restore display","changed","redraw the\nscreen once"),menu.addItem("fill page...","fillPage","let the World automatically\nadjust to browser resizing"),useBlurredShadows?menu.addItem("sharp shadows...","toggleBlurredShadows","sharp drop shadows\nuse for old browsers"):menu.addItem("blurred shadows...","toggleBlurredShadows","blurry shades,\n use for new browsers"),menu.addItem("color...",function(){this.pickColor(menu.title+localize("\ncolor:"),this.setColor,this,this.color);
},"choose the World's\nbackground color"),MorphicPreferences===standardSettings?menu.addItem("touch screen settings","togglePreferences","bigger menu fonts\nand sliders"):menu.addItem("standard settings","togglePreferences","smaller menu fonts\nand sliders"),menu.addLine()),this.isDevMode?menu.addItem("user mode...","toggleDevMode","disable developers'\ncontext menus"):menu.addItem("development mode...","toggleDevMode"),menu.addItem("about morphic.js...","about"),menu},WorldMorph.prototype.userCreateMorph=function(){function create(aMorph){aMorph.isDraggable=!0,aMorph.pickUp(myself)}var menu,newMorph,myself=this;menu=new MenuMorph(this,"make a morph"),menu.addItem("rectangle",function(){
create(new Morph)}),menu.addItem("box",function(){create(new BoxMorph)}),menu.addItem("circle box",function(){create(new CircleBoxMorph)}),menu.addLine(),menu.addItem("slider",function(){create(new SliderMorph)}),menu.addItem("frame",function(){newMorph=new FrameMorph,newMorph.setExtent(new Point(350,250)),create(newMorph)}),menu.addItem("scroll frame",function(){newMorph=new ScrollFrameMorph,newMorph.contents.acceptsDrops=!0,newMorph.contents.adjustBounds(),newMorph.setExtent(new Point(350,250)),create(newMorph)}),menu.addItem("handle",function(){create(new HandleMorph)}),menu.addLine(),menu.addItem("string",function(){newMorph=new StringMorph("Hello, World!"),
newMorph.isEditable=!0,create(newMorph)}),menu.addItem("text",function(){newMorph=new TextMorph("Ich weiß nicht, was soll es bedeuten, dass ich so traurig bin, ein Märchen aus uralten Zeiten, das kommt mir nicht aus dem Sinn. Die Luft ist kühl und es dunkelt, und ruhig fließt der Rhein; der Gipfel des Berges funkelt im Abendsonnenschein. Die schönste Jungfrau sitzet dort oben wunderbar, ihr gold'nes Geschmeide blitzet, sie kämmt ihr goldenes Haar, sie kämmt es mit goldenem Kamme, und singt ein Lied dabei; das hat eine wundersame, gewalt'ge Melodei. Den Schiffer im kleinen Schiffe, ergreift es mit wildem Weh; er schaut nicht die Felsenriffe, er schaut nur hinauf in die Höh'. Ich glaube, die Wellen verschlingen am Ende Schiffer und Kahn, und das hat mit ihrem Singen, die Loreley getan."),
newMorph.isEditable=!0,newMorph.maxWidth=300,newMorph.drawNew(),create(newMorph)}),menu.addItem("speech bubble",function(){newMorph=new SpeechBubbleMorph("Hello, World!"),create(newMorph)}),menu.addLine(),menu.addItem("gray scale palette",function(){create(new GrayPaletteMorph)}),menu.addItem("color palette",function(){create(new ColorPaletteMorph)}),menu.addItem("color picker",function(){create(new ColorPickerMorph)}),menu.addLine(),menu.addItem("sensor demo",function(){newMorph=new MouseSensorMorph,newMorph.setColor(new Color(230,200,100)),newMorph.edge=35,newMorph.border=15,newMorph.borderColor=new Color(200,100,50),newMorph.alpha=.2,newMorph.setExtent(new Point(100,100)),
create(newMorph)}),menu.addItem("animation demo",function(){var foo,bar,baz,garply,fred;foo=new BouncerMorph,foo.setPosition(new Point(50,20)),foo.setExtent(new Point(300,200)),foo.alpha=.9,foo.speed=3,bar=new BouncerMorph,bar.setColor(new Color(50,50,50)),bar.setPosition(new Point(80,80)),bar.setExtent(new Point(80,250)),bar.type="horizontal",bar.direction="right",bar.alpha=.9,bar.speed=5,baz=new BouncerMorph,baz.setColor(new Color(20,20,20)),baz.setPosition(new Point(90,140)),baz.setExtent(new Point(40,30)),baz.type="horizontal",baz.direction="right",baz.speed=3,garply=new BouncerMorph,garply.setColor(new Color(200,20,20)),garply.setPosition(new Point(90,140)),
garply.setExtent(new Point(20,20)),garply.type="vertical",garply.direction="up",garply.speed=8,fred=new BouncerMorph,fred.setColor(new Color(20,200,20)),fred.setPosition(new Point(120,140)),fred.setExtent(new Point(20,20)),fred.type="vertical",fred.direction="down",fred.speed=4,bar.add(garply),bar.add(baz),foo.add(fred),foo.add(bar),create(foo)}),menu.addItem("pen",function(){create(new PenMorph)}),myself.customMorphs&&(menu.addLine(),myself.customMorphs().forEach(function(morph){menu.addItem(morph.toString(),function(){create(morph)})})),menu.popUpAtHand(this)},WorldMorph.prototype.toggleDevMode=function(){this.isDevMode=!this.isDevMode},WorldMorph.prototype.hideAll=function(){
this.children.forEach(function(child){child.hide()})},WorldMorph.prototype.showAllHiddens=function(){this.forAllChildren(function(child){child.isVisible||child.show()})},WorldMorph.prototype.about=function(){var module,versions="";for(module in modules)Object.prototype.hasOwnProperty.call(modules,module)&&(versions+="\n"+module+" ("+modules[module]+")");""!==versions&&(versions="\n\nmodules:\n\nmorphic ("+morphicVersion+")"+versions),this.inform("morphic.js\n\na lively Web GUI\ninspired by Squeak\n"+morphicVersion+"\n\nwritten by Jens Mönig\njens@moenig.org"+versions)},WorldMorph.prototype.edit=function(aStringOrTextMorph){var pos=getDocumentPositionOf(this.worldCanvas);
return aStringOrTextMorph.isEditable?(this.cursor&&this.cursor.destroy(),this.cursor=new CursorMorph(aStringOrTextMorph),aStringOrTextMorph.parent.add(this.cursor),this.keyboardReceiver=this.cursor,this.initVirtualKeyboard(),MorphicPreferences.isTouchDevice&&MorphicPreferences.useVirtualKeyboard&&(this.virtualKeyboard.style.top=this.cursor.top()+pos.y+"px",this.virtualKeyboard.style.left=this.cursor.left()+pos.x+"px",this.virtualKeyboard.focus()),MorphicPreferences.useSliderForInput&&(aStringOrTextMorph.parentThatIsA(MenuMorph)||this.slide(aStringOrTextMorph)),this.lastEditedText!==aStringOrTextMorph&&aStringOrTextMorph.escalateEvent("freshTextEdit",aStringOrTextMorph),
void(this.lastEditedText=aStringOrTextMorph)):null},WorldMorph.prototype.slide=function(aStringOrTextMorph){var menu,slider,val=parseFloat(aStringOrTextMorph.text);isNaN(val)&&(val=0),menu=new MenuMorph,slider=new SliderMorph(val-25,val+25,val,10,"horizontal"),slider.alpha=1,slider.color=new Color(225,225,225),slider.button.color=menu.borderColor,slider.button.highlightColor=slider.button.color.copy(),slider.button.highlightColor.b+=100,slider.button.pressColor=slider.button.color.copy(),slider.button.pressColor.b+=150,slider.silentSetHeight(MorphicPreferences.scrollBarSize),slider.silentSetWidth(10*MorphicPreferences.menuFontSize),slider.drawNew(),slider.action=function(num){
aStringOrTextMorph.changed(),aStringOrTextMorph.text=Math.round(num).toString(),aStringOrTextMorph.drawNew(),aStringOrTextMorph.changed(),aStringOrTextMorph.escalateEvent("reactToSliderEdit",aStringOrTextMorph)},menu.items.push(slider),menu.popup(this,aStringOrTextMorph.bottomLeft().add(new Point(0,5)))},WorldMorph.prototype.stopEditing=function(){this.cursor&&(this.cursor.target.escalateEvent("reactToEdit",this.cursor.target),this.cursor.target.clearSelection(),this.cursor.destroy(),this.cursor=null),this.keyboardReceiver&&this.keyboardReceiver.stopEditing&&this.keyboardReceiver.stopEditing(),this.keyboardReceiver=null,this.virtualKeyboard&&(this.virtualKeyboard.blur(),
document.body.removeChild(this.virtualKeyboard),this.virtualKeyboard=null),this.lastEditedText=null,this.worldCanvas.focus()},WorldMorph.prototype.toggleBlurredShadows=function(){useBlurredShadows=!useBlurredShadows},WorldMorph.prototype.togglePreferences=function(){MorphicPreferences=MorphicPreferences===standardSettings?touchScreenSettings:standardSettings},modules.widgets="2017-September-25";var PushButtonMorph,ToggleButtonMorph,TabMorph,ToggleMorph,ToggleElementMorph,DialogBoxMorph,AlignmentMorph,InputFieldMorph,PianoMenuMorph,PianoKeyMorph;PushButtonMorph.prototype=new TriggerMorph,PushButtonMorph.prototype.constructor=PushButtonMorph,PushButtonMorph.uber=TriggerMorph.prototype,
PushButtonMorph.prototype.fontSize=10,PushButtonMorph.prototype.fontStyle="sans-serif",PushButtonMorph.prototype.labelColor=new Color(0,0,0),PushButtonMorph.prototype.labelShadowColor=new Color(255,255,255),PushButtonMorph.prototype.labelShadowOffset=new Point(1,1),PushButtonMorph.prototype.color=new Color(220,220,220),PushButtonMorph.prototype.pressColor=new Color(115,180,240),PushButtonMorph.prototype.highlightColor=PushButtonMorph.prototype.pressColor.lighter(50),PushButtonMorph.prototype.outlineColor=new Color(30,30,30),PushButtonMorph.prototype.outlineGradient=!1,PushButtonMorph.prototype.contrast=60,PushButtonMorph.prototype.edge=2,PushButtonMorph.prototype.corner=5,
PushButtonMorph.prototype.outline=1.00001,PushButtonMorph.prototype.padding=3,PushButtonMorph.prototype.init=function(target,action,labelString,environment,hint,template){this.is3D=!1,this.target=target||null,this.action=action||null,this.environment=environment||null,this.labelString=labelString||null,this.label=null,this.labelMinExtent=new Point(0,0),this.hint=hint||null,this.template=template||null,this.isDisabled=!1,TriggerMorph.uber.init.call(this),this.color=PushButtonMorph.prototype.color,this.drawNew(),this.fixLayout()},PushButtonMorph.prototype.fixLayout=function(){if(null!==this.label){var padding=2*this.padding+2*this.outline+2*this.edge;this.setExtent(new Point(Math.max(this.label.width(),this.labelMinExtent.x)+padding,Math.max(this.label instanceof StringMorph?this.label.rawHeight():this.label.height(),this.labelMinExtent.y)+padding)),
this.label.setCenter(this.center())}},PushButtonMorph.prototype.mouseDownLeft=function(){PushButtonMorph.uber.mouseDownLeft.call(this),this.label&&this.label.setCenter(this.center().add(1))},PushButtonMorph.prototype.mouseClickLeft=function(){this.isDisabled||(PushButtonMorph.uber.mouseClickLeft.call(this),this.label&&this.label.setCenter(this.center()))},PushButtonMorph.prototype.mouseLeave=function(){PushButtonMorph.uber.mouseLeave.call(this),this.label&&this.label.setCenter(this.center())},PushButtonMorph.prototype.outlinePath=BoxMorph.prototype.outlinePath,PushButtonMorph.prototype.drawOutline=function(context){var outlineStyle,isFlat=MorphicPreferences.isFlat&&!this.is3D;
return!this.outline||isFlat?null:(this.outlineGradient?(outlineStyle=context.createLinearGradient(0,0,0,this.height()),outlineStyle.addColorStop(0,this.outlineColor.darker().toString()),outlineStyle.addColorStop(1,"white")):outlineStyle=this.outlineColor.toString(),context.fillStyle=outlineStyle,context.beginPath(),this.outlinePath(context,isFlat?0:this.corner,0),context.closePath(),void context.fill())},PushButtonMorph.prototype.drawBackground=function(context,color){var isFlat=MorphicPreferences.isFlat&&!this.is3D;context.fillStyle=color.toString(),context.beginPath(),this.outlinePath(context,isFlat?0:Math.max(this.corner-this.outline,0),this.outline),context.closePath(),
context.fill(),context.lineWidth=this.outline},PushButtonMorph.prototype.drawEdges=function(context,color,topColor,bottomColor){if(!MorphicPreferences.isFlat||this.is3D){var gradient,minInset=Math.max(this.corner,this.outline+this.edge),w=this.width(),h=this.height();gradient=context.createLinearGradient(0,this.outline,0,this.outline+this.edge),gradient.addColorStop(0,topColor.toString()),gradient.addColorStop(1,color.toString()),context.strokeStyle=gradient,context.lineCap="round",context.lineWidth=this.edge,context.beginPath(),context.moveTo(minInset,this.outline+this.edge/2),context.lineTo(w-minInset,this.outline+this.edge/2),context.stroke(),gradient=context.createRadialGradient(this.corner,this.corner,Math.max(this.corner-this.outline-this.edge,0),this.corner,this.corner,Math.max(this.corner-this.outline,0)),
gradient.addColorStop(0,color.toString()),gradient.addColorStop(1,topColor.toString()),context.strokeStyle=gradient,context.lineCap="round",context.lineWidth=this.edge,context.beginPath(),context.arc(this.corner,this.corner,Math.max(this.corner-this.outline-this.edge/2,0),radians(180),radians(270),!1),context.stroke(),gradient=context.createLinearGradient(this.outline,0,this.outline+this.edge,0),gradient.addColorStop(0,topColor.toString()),gradient.addColorStop(1,color.toString()),context.strokeStyle=gradient,context.lineCap="round",context.lineWidth=this.edge,context.beginPath(),context.moveTo(this.outline+this.edge/2,minInset),context.lineTo(this.outline+this.edge/2,h-minInset),
context.stroke(),gradient=context.createLinearGradient(0,h-this.outline,0,h-this.outline-this.edge),gradient.addColorStop(0,bottomColor.toString()),gradient.addColorStop(1,color.toString()),context.strokeStyle=gradient,context.lineCap="round",context.lineWidth=this.edge,context.beginPath(),context.moveTo(minInset,h-this.outline-this.edge/2),context.lineTo(w-minInset,h-this.outline-this.edge/2),context.stroke(),gradient=context.createRadialGradient(w-this.corner,h-this.corner,Math.max(this.corner-this.outline-this.edge,0),w-this.corner,h-this.corner,Math.max(this.corner-this.outline,0)),gradient.addColorStop(0,color.toString()),gradient.addColorStop(1,bottomColor.toString()),
context.strokeStyle=gradient,context.lineCap="round",context.lineWidth=this.edge,context.beginPath(),context.arc(w-this.corner,h-this.corner,Math.max(this.corner-this.outline-this.edge/2,0),radians(0),radians(90),!1),context.stroke(),gradient=context.createLinearGradient(w-this.outline,0,w-this.outline-this.edge,0),gradient.addColorStop(0,bottomColor.toString()),gradient.addColorStop(1,color.toString()),context.strokeStyle=gradient,context.lineCap="round",context.lineWidth=this.edge,context.beginPath(),context.moveTo(w-this.outline-this.edge/2,minInset),context.lineTo(w-this.outline-this.edge/2,h-minInset),context.stroke()}},PushButtonMorph.prototype.createBackgrounds=function(){
var context,ext=this.extent();return this.template?(this.image=this.template.image,this.normalImage=this.template.normalImage,this.highlightImage=this.template.highlightImage,this.pressImage=this.template.pressImage,null):(this.normalImage=newCanvas(ext),context=this.normalImage.getContext("2d"),this.drawOutline(context),this.drawBackground(context,this.color),this.drawEdges(context,this.color,this.color.lighter(this.contrast),this.color.darker(this.contrast)),this.highlightImage=newCanvas(ext),context=this.highlightImage.getContext("2d"),this.drawOutline(context),this.drawBackground(context,this.highlightColor),this.drawEdges(context,this.highlightColor,this.highlightColor.lighter(this.contrast),this.highlightColor.darker(this.contrast)),
this.pressImage=newCanvas(ext),context=this.pressImage.getContext("2d"),this.drawOutline(context),this.drawBackground(context,this.pressColor),this.drawEdges(context,this.pressColor,this.pressColor.darker(this.contrast),this.pressColor.lighter(this.contrast)),void(this.image=this.normalImage))},PushButtonMorph.prototype.createLabel=function(){var shading=!MorphicPreferences.isFlat||this.is3D;null!==this.label&&this.label.destroy(),this.labelString instanceof SymbolMorph?(this.label=this.labelString.fullCopy(),shading&&(this.label.shadowOffset=this.labelShadowOffset,this.label.shadowColor=this.labelShadowColor),this.label.color=this.labelColor,this.label.drawNew()):this.label=new StringMorph(localize(this.labelString),this.fontSize,this.fontStyle,!0,!1,!1,shading?this.labelShadowOffset:null,this.labelShadowColor,this.labelColor),
this.add(this.label)},PushButtonMorph.prototype.disable=function(){this.isDisabled=!0,this.forAllChildren(function(child){child.alpha=.3}),this.changed()},PushButtonMorph.prototype.enable=function(){this.isDisabled=!1,this.forAllChildren(function(child){child.alpha=1}),this.changed()},ToggleButtonMorph.prototype=new PushButtonMorph,ToggleButtonMorph.prototype.constructor=ToggleButtonMorph,ToggleButtonMorph.uber=PushButtonMorph.prototype,ToggleButtonMorph.prototype.contrast=30,ToggleButtonMorph.prototype.init=function(colors,target,action,labelString,query,environment,hint,template,minWidth,hasPreview,isPicture){this.state=!1,this.query=query||function(){return!0;
},this.minWidth=minWidth||null,this.hasPreview=hasPreview||!1,this.isPicture=isPicture||!1,this.trueStateLabel=null,ToggleButtonMorph.uber.init.call(this,target,action,labelString,environment,hint,template),colors&&(this.color=colors[0],this.highlightColor=colors[1],this.pressColor=colors[2]),this.refresh(),this.drawNew()},ToggleButtonMorph.prototype.mouseEnter=function(){var contents=this.hint instanceof Function?this.hint():this.hint;this.state||(this.image=this.highlightImage,this.changed()),contents&&this.bubbleHelp(contents)},ToggleButtonMorph.prototype.mouseLeave=function(){this.state||(this.image=this.normalImage,this.changed()),this.schedule&&(this.schedule.isActive=!1),
this.hint&&this.world().hand.destroyTemporaries()},ToggleButtonMorph.prototype.mouseDownLeft=function(){this.state||(this.image=this.pressImage,this.changed())},ToggleButtonMorph.prototype.mouseClickLeft=function(){this.state||(this.image=this.highlightImage,this.changed()),this.trigger()},ToggleButtonMorph.prototype.trigger=function(){ToggleButtonMorph.uber.trigger.call(this),this.refresh()},ToggleButtonMorph.prototype.refresh=function(){"function"==typeof this.query?this.state=this.query.call(this.target):this.state=this.target[this.query](),this.state?(this.image=this.pressImage,this.trueStateLabel&&(this.label.hide(),this.trueStateLabel.show())):(this.image=this.normalImage,
this.trueStateLabel&&(this.label.show(),this.trueStateLabel.hide())),this.changed()},ToggleButtonMorph.prototype.fixLayout=function(){if(null!==this.label){var lw=Math.max(this.label.width(),this.labelMinExtent.x),padding=2*this.padding+2*this.outline+2*this.edge;this.setExtent(new Point(this.minWidth?Math.max(this.minWidth,lw)+padding:lw+padding,Math.max(this.label instanceof StringMorph?this.label.rawHeight():this.label.height(),this.labelMinExtent.y)+padding)),this.label.setCenter(this.center()),this.trueStateLabel&&this.trueStateLabel.setCenter(this.center()),this.minWidth&&this.label.setLeft(this.left()+this.outline+this.edge+this.corner+this.padding)}},
ToggleButtonMorph.prototype.createBackgrounds=function(){var context,ext=this.extent();return this.template?(this.image=this.template.image,this.normalImage=this.template.normalImage,this.highlightImage=this.template.highlightImage,this.pressImage=this.template.pressImage,null):(this.normalImage=newCanvas(ext),context=this.normalImage.getContext("2d"),this.drawOutline(context),this.drawBackground(context,this.color),this.drawEdges(context,this.color,this.color.lighter(this.contrast),this.color.darker(this.contrast)),this.highlightImage=newCanvas(ext),context=this.highlightImage.getContext("2d"),this.drawOutline(context),this.drawBackground(context,this.highlightColor),
this.drawEdges(context,this.highlightColor,this.highlightColor.lighter(this.contrast),this.highlightColor.darker(this.contrast)),this.pressImage=newCanvas(ext),context=this.pressImage.getContext("2d"),this.drawOutline(context),this.drawBackground(context,this.pressColor),this.drawEdges(context,this.pressColor,this.pressColor.lighter(40),this.pressColor.darker(40)),void(this.image=this.normalImage))},ToggleButtonMorph.prototype.drawEdges=function(context,color,topColor,bottomColor){var gradient;if(ToggleButtonMorph.uber.drawEdges.call(this,context,color,topColor,bottomColor),this.hasPreview){if(MorphicPreferences.isFlat&&!this.is3D)return context.fillStyle=this.pressColor.toString(),
void context.fillRect(this.outline,this.outline,this.corner,this.height()-2*this.outline);gradient=context.createLinearGradient(0,0,this.corner,0),gradient.addColorStop(0,this.pressColor.lighter(40).toString()),gradient.addColorStop(1,this.pressColor.darker(40).toString()),context.fillStyle=gradient,context.beginPath(),this.previewPath(context,Math.max(this.corner-this.outline,0),this.outline),context.closePath(),context.fill()}},ToggleButtonMorph.prototype.previewPath=function(context,radius,inset){var offset=radius+inset,h=this.height();context.arc(offset,offset,radius,radians(-180),radians(-90),!1),context.arc(offset,h-offset,radius,radians(90),radians(180),!1);
},ToggleButtonMorph.prototype.createLabel=function(){var shading=!MorphicPreferences.isFlat||this.is3D,none=new Point;null!==this.label&&this.label.destroy(),null!==this.trueStateLabel&&this.trueStateLabel.destroy(),this.labelString instanceof Array&&2===this.labelString.length?this.labelString[0]instanceof SymbolMorph?(this.label=this.labelString[0].fullCopy(),this.trueStateLabel=this.labelString[1].fullCopy(),this.isPicture||(this.label.shadowOffset=shading?this.labelShadowOffset:none,this.label.shadowColor=this.labelShadowColor,this.label.color=this.labelColor,this.label.drawNew(),this.trueStateLabel.shadowOffset=shading?this.labelShadowOffset:none,this.trueStateLabel.shadowColor=this.labelShadowColor,
this.trueStateLabel.color=this.labelColor,this.trueStateLabel.drawNew())):this.labelString[0]instanceof Morph?(this.label=this.labelString[0].fullCopy(),this.trueStateLabel=this.labelString[1].fullCopy()):(this.label=new StringMorph(localize(this.labelString[0]),this.fontSize,this.fontStyle,!0,!1,!1,shading?this.labelShadowOffset:null,this.labelShadowColor,this.labelColor),this.trueStateLabel=new StringMorph(localize(this.labelString[1]),this.fontSize,this.fontStyle,!0,!1,!1,shading?this.labelShadowOffset:null,this.labelShadowColor,this.labelColor)):this.labelString instanceof SymbolMorph?(this.label=this.labelString.fullCopy(),this.isPicture||(this.label.shadowOffset=shading?this.labelShadowOffset:none,
this.label.shadowColor=this.labelShadowColor,this.label.color=this.labelColor,this.label.drawNew())):this.labelString instanceof Morph?this.label=this.labelString.fullCopy():this.label=new StringMorph(localize(this.labelString),this.fontSize,this.fontStyle,!0,!1,!1,shading?this.labelShadowOffset:none,this.labelShadowColor,this.labelColor),this.add(this.label),this.trueStateLabel&&this.add(this.trueStateLabel)},ToggleButtonMorph.prototype.hide=function(){this.isVisible=!1,this.changed()},ToggleButtonMorph.prototype.show=function(){this.isVisible=!0,this.changed()},TabMorph.prototype=new ToggleButtonMorph,TabMorph.prototype.constructor=TabMorph,TabMorph.uber=ToggleButtonMorph.prototype,
TabMorph.prototype.fixLayout=function(){null!==this.label&&(this.setExtent(new Point(this.label.width()+2*this.padding+3*this.corner+2*this.edge,(this.label instanceof StringMorph?this.label.rawHeight():this.label.height())+2*this.padding+this.edge)),this.label.setCenter(this.center()))},TabMorph.prototype.refresh=function(){this.state&&this.parent&&this.parent.add(this),TabMorph.uber.refresh.call(this)},TabMorph.prototype.drawBackground=function(context,color){var w=this.width(),h=this.height(),c=this.corner;context.fillStyle=color.toString(),context.beginPath(),context.moveTo(0,h),context.bezierCurveTo(c,h,c,0,2*c,0),context.lineTo(w-2*c,0),context.bezierCurveTo(w-c,0,w-c,h,w,h),
context.closePath(),context.fill()},TabMorph.prototype.drawOutline=function(){nop()},TabMorph.prototype.drawEdges=function(context,color,topColor,bottomColor){if(!MorphicPreferences.isFlat||this.is3D){var gradient,w=this.width(),h=this.height(),c=this.corner,e=this.edge,eh=e/2;nop(color),gradient=context.createLinearGradient(0,0,w,0),gradient.addColorStop(0,topColor.toString()),gradient.addColorStop(1,bottomColor.toString()),context.strokeStyle=gradient,context.lineCap="round",context.lineWidth=e,context.beginPath(),context.moveTo(0,h+eh),context.bezierCurveTo(c,h,c,0,2*c,eh),context.lineTo(w-2*c,eh),context.bezierCurveTo(w-c,0,w-c,h,w,h+eh),context.stroke()}
},ToggleMorph.prototype=new PushButtonMorph,ToggleMorph.prototype.constructor=ToggleMorph,ToggleMorph.uber=PushButtonMorph.prototype,ToggleMorph.prototype.init=function(style,target,action,labelString,query,environment,hint,template,element,builder){this.padding=1,style=style||"checkbox",this.corner="checkbox"===style?0:fontHeight(this.fontSize)/2+this.outline+this.padding,this.state=!1,this.query=query||function(){return!0},this.tick=null,this.captionString=labelString||null,this.labelAlignment="right",this.element=element||null,this.builder=builder||null,this.toggleElement=null,ToggleMorph.uber.init.call(this,target,action,"checkbox"===style?"✓":"●",environment,hint,template),
this.refresh(),this.drawNew()},ToggleMorph.prototype.fixLayout=function(){var y,padding=2*this.padding+2*this.outline;null!==this.tick&&(this.silentSetHeight(this.tick.rawHeight()+padding),this.silentSetWidth(this.tick.width()+padding),this.setExtent(new Point(Math.max(this.width(),this.height()),Math.max(this.width(),this.height()))),this.tick.setCenter(this.center())),this.state?this.tick.show():this.tick.hide(),this.toggleElement&&"right"===this.labelAlignment&&(y=this.top()+(this.height()-this.toggleElement.height())/2,this.toggleElement.setPosition(new Point(this.right()+padding,y))),null!==this.label&&(y=this.top()+(this.height()-this.label.height())/2,
"right"===this.labelAlignment?this.label.setPosition(new Point(this.toggleElement?this.toggleElement instanceof ToggleElementMorph?this.toggleElement.right():this.toggleElement.right()+padding:this.right()+padding,y)):this.label.setPosition(new Point(this.left()-this.label.width()-padding,y)))},ToggleMorph.prototype.createLabel=function(){var shading=!MorphicPreferences.isFlat||this.is3D;null===this.label&&this.captionString&&(this.label=new TextMorph(localize(this.captionString),this.fontSize,this.fontStyle,!0),this.add(this.label)),null===this.tick&&(this.tick=new StringMorph(localize(this.labelString),this.fontSize,this.fontStyle,!0,!1,!1,shading?new Point(1,1):null,new Color(240,240,240)),
this.add(this.tick)),null===this.toggleElement&&this.element&&(this.element instanceof Morph?this.toggleElement=new ToggleElementMorph(this.target,this.action,this.element,this.query,this.environment,this.hint,this.builder):this.element instanceof HTMLCanvasElement&&(this.toggleElement=new Morph,this.toggleElement.silentSetExtent(new Point(this.element.width,this.element.height)),this.toggleElement.image=this.element),this.add(this.toggleElement))},ToggleMorph.prototype.trigger=function(){ToggleMorph.uber.trigger.call(this),this.refresh()},ToggleMorph.prototype.refresh=function(){"function"==typeof this.query?this.state=this.query.call(this.target):this.state=this.target[this.query](),
this.state?this.tick.show():this.tick.hide(),this.toggleElement&&this.toggleElement.refresh&&this.toggleElement.refresh()},ToggleMorph.prototype.mouseDownLeft=function(){PushButtonMorph.uber.mouseDownLeft.call(this),this.tick&&this.tick.setCenter(this.center().add(1))},ToggleMorph.prototype.mouseClickLeft=function(){PushButtonMorph.uber.mouseClickLeft.call(this),this.tick&&this.tick.setCenter(this.center())},ToggleMorph.prototype.mouseLeave=function(){PushButtonMorph.uber.mouseLeave.call(this),this.tick&&this.tick.setCenter(this.center())},ToggleMorph.prototype.hide=ToggleButtonMorph.prototype.hide,ToggleMorph.prototype.show=ToggleButtonMorph.prototype.show,ToggleElementMorph.prototype=new TriggerMorph,
ToggleElementMorph.prototype.constructor=ToggleElementMorph,ToggleElementMorph.uber=TriggerMorph.prototype,ToggleElementMorph.prototype.contrast=50,ToggleElementMorph.prototype.shadowOffset=new Point(2,2),ToggleElementMorph.prototype.shadowAlpha=.6,ToggleElementMorph.prototype.fontSize=10,ToggleElementMorph.prototype.inactiveColor=new Color(180,180,180),ToggleElementMorph.prototype.init=function(target,action,element,query,environment,hint,builder,labelString){this.target=target||null,this.action=action||null,this.element=element,this.query=query||function(){return!0},this.environment=environment||null,this.hint=hint||null,this.builder=builder||"nop",this.captionString=labelString||null,
this.labelAlignment="right",this.state=!1,TriggerMorph.uber.init.call(this),this.color=element.color,this.createLabel()},ToggleElementMorph.prototype.createBackgrounds=function(){var shading=!MorphicPreferences.isFlat||this.is3D;this.color=this.element.color,this.element.removeShadow(),this.element[this.builder](),shading&&this.element.addShadow(this.shadowOffset,this.shadowAlpha),this.silentSetExtent(this.element.fullBounds().extent()),this.pressImage=this.element.fullImage(),this.element.removeShadow(),this.element.setColor(this.inactiveColor),this.element[this.builder](this.contrast),shading&&this.element.addShadow(this.shadowOffset,0),this.normalImage=this.element.fullImage(),
this.element.removeShadow(),this.element.setColor(this.color.lighter(this.contrast)),this.element[this.builder](this.contrast),shading&&this.element.addShadow(this.shadowOffset,this.shadowAlpha),this.highlightImage=this.element.fullImage(),this.element.removeShadow(),this.element.setColor(this.color),this.element[this.builder](),this.image=this.normalImage},ToggleElementMorph.prototype.setColor=function(aColor){this.element.setColor(aColor),this.createBackgrounds(),this.refresh()},ToggleElementMorph.prototype.createLabel=function(){var y;this.captionString&&(this.label=new StringMorph(this.captionString,this.fontSize,this.fontStyle,!0),this.add(this.label),y=this.top()+(this.height()-this.label.height())/2,
"right"===this.labelAlignment?this.label.setPosition(new Point(this.right(),y)):this.label.setPosition(new Point(this.left()-this.label.width(),y)))},ToggleElementMorph.prototype.trigger=ToggleButtonMorph.prototype.trigger,ToggleElementMorph.prototype.refresh=ToggleButtonMorph.prototype.refresh,ToggleElementMorph.prototype.mouseEnter=ToggleButtonMorph.prototype.mouseEnter,ToggleElementMorph.prototype.mouseLeave=ToggleButtonMorph.prototype.mouseLeave,ToggleElementMorph.prototype.mouseDownLeft=ToggleButtonMorph.prototype.mouseDownLeft,ToggleElementMorph.prototype.mouseClickLeft=ToggleButtonMorph.prototype.mouseClickLeft,DialogBoxMorph.prototype=new Morph,DialogBoxMorph.prototype.constructor=DialogBoxMorph,
DialogBoxMorph.uber=Morph.prototype,DialogBoxMorph.prototype.fontSize=12,DialogBoxMorph.prototype.titleFontSize=14,DialogBoxMorph.prototype.fontStyle="sans-serif",DialogBoxMorph.prototype.color=PushButtonMorph.prototype.color,DialogBoxMorph.prototype.titleTextColor=new Color(255,255,255),DialogBoxMorph.prototype.titleBarColor=PushButtonMorph.prototype.pressColor,DialogBoxMorph.prototype.contrast=40,DialogBoxMorph.prototype.corner=12,DialogBoxMorph.prototype.padding=14,DialogBoxMorph.prototype.titlePadding=6,DialogBoxMorph.prototype.buttonContrast=50,DialogBoxMorph.prototype.buttonFontSize=12,DialogBoxMorph.prototype.buttonCorner=12,DialogBoxMorph.prototype.buttonEdge=6,
DialogBoxMorph.prototype.buttonPadding=0,DialogBoxMorph.prototype.buttonOutline=3,DialogBoxMorph.prototype.buttonOutlineColor=PushButtonMorph.prototype.color,DialogBoxMorph.prototype.buttonOutlineGradient=!0,DialogBoxMorph.prototype.instances={},DialogBoxMorph.prototype.init=function(target,action,environment){this.is3D=!1,this.target=target||null,this.action=action||null,this.environment=environment||null,this.key=null,this.labelString=null,this.label=null,this.head=null,this.body=null,this.buttons=null,DialogBoxMorph.uber.init.call(this),this.isDraggable=!0,this.color=PushButtonMorph.prototype.color,this.createLabel(),this.createButtons(),this.setExtent(new Point(300,150));
},DialogBoxMorph.prototype.inform=function(title,textString,world,pic){var txt=new TextMorph(textString,this.fontSize,this.fontStyle,!0,!1,"center",null,null,MorphicPreferences.isFlat?null:new Point(1,1),new Color(255,255,255));this.key||(this.key="inform"+title+textString),this.labelString=title,this.createLabel(),pic&&this.setPicture(pic),textString&&this.addBody(txt),this.addButton("ok","OK"),this.drawNew(),this.fixLayout(),this.popUp(world)},DialogBoxMorph.prototype.askYesNo=function(title,textString,world,pic){var txt=new TextMorph(textString,this.fontSize,this.fontStyle,!0,!1,"center",null,null,MorphicPreferences.isFlat?null:new Point(1,1),new Color(255,255,255));
this.key||(this.key="decide"+title+textString),this.labelString=title,this.createLabel(),pic&&this.setPicture(pic),this.addBody(txt),this.addButton("ok","Yes"),this.addButton("cancel","No"),this.fixLayout(),this.drawNew(),this.fixLayout(),this.popUp(world)},DialogBoxMorph.prototype.prompt=function(title,defaultString,world,pic,choices,isReadOnly,isNumeric,sliderMin,sliderMax,sliderAction){var sld,head,txt=new InputFieldMorph(defaultString,isNumeric||!1,choices||null,!!choices&&(isReadOnly||!1));txt.setWidth(250),isNumeric?(pic&&(head=new AlignmentMorph("column",this.padding),pic.setPosition(head.position()),head.add(pic)),isNil(sliderMin)||isNil(sliderMax)||(sld=new SliderMorph(100*sliderMin,100*sliderMax,100*parseFloat(defaultString),(sliderMax-sliderMin)/10*100,"horizontal"),
sld.alpha=1,sld.color=this.color.lighter(50),sld.setHeight(.7*txt.height()),sld.setWidth(txt.width()),sld.action=function(num){sliderAction&&sliderAction(num/100),txt.setContents(num/100),txt.edit()},head||(head=new AlignmentMorph("column",this.padding)),head.add(sld)),head&&(head.fixLayout(),this.setPicture(head),head.fixLayout())):pic&&this.setPicture(pic),this.reactToChoice=function(inp){sld&&(sld.value=100*inp,sld.drawNew(),sld.changed()),sliderAction&&sliderAction(inp)},txt.reactToKeystroke=function(){var inp=txt.getValue();sld&&(inp=Math.max(inp,sliderMin),sld.value=100*inp,sld.drawNew(),sld.changed()),sliderAction&&sliderAction(inp)},this.labelString=title,
this.createLabel(),this.key||(this.key="prompt"+title+defaultString),this.addBody(txt),txt.drawNew(),this.addButton("ok","OK"),this.addButton("cancel","Cancel"),this.fixLayout(),this.drawNew(),this.fixLayout(),this.popUp(world)},DialogBoxMorph.prototype.promptCode=function(title,defaultString,world,pic,instructions){function remarkText(string){return new TextMorph(localize(string),10,null,!1,null,null,null,null,MorphicPreferences.isFlat?null:new Point(1,1),new Color(255,255,255))}var frame=new ScrollFrameMorph,text=new TextMorph(defaultString||""),bdy=new AlignmentMorph("column",this.padding),size=pic?Math.max(pic.width,400):400;this.getInput=function(){return text.text;
},frame.padding=6,frame.setWidth(size),frame.acceptsDrops=!1,frame.contents.acceptsDrops=!1,text.fontName="monospace",text.fontStyle="monospace",text.fontSize=11,text.setPosition(frame.topLeft().add(frame.padding)),text.enableSelecting(),text.isEditable=!0,frame.setHeight(size/4),frame.fixLayout=nop,frame.edge=InputFieldMorph.prototype.edge,frame.fontSize=InputFieldMorph.prototype.fontSize,frame.typeInPadding=InputFieldMorph.prototype.typeInPadding,frame.contrast=InputFieldMorph.prototype.contrast,frame.drawNew=InputFieldMorph.prototype.drawNew,frame.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,frame.addContents(text),text.drawNew(),pic&&this.setPicture(pic),
this.labelString=title,this.createLabel(),this.key||(this.key="promptCode"+title+defaultString),bdy.setColor(this.color),bdy.add(frame),instructions&&bdy.add(remarkText(instructions)),bdy.fixLayout(),this.addBody(bdy),frame.drawNew(),bdy.drawNew(),this.addButton("ok","OK"),this.addButton("cancel","Cancel"),this.fixLayout(),this.drawNew(),this.fixLayout(),this.popUp(world),text.edit()},DialogBoxMorph.prototype.promptVector=function(title,point,deflt,xLabel,yLabel,world,pic,msg){function labelText(string){return new TextMorph(localize(string),10,null,!1,null,null,null,null,MorphicPreferences.isFlat?null:new Point(1,1),new Color(255,255,255))}var vec=new AlignmentMorph("row",4),xInp=new InputFieldMorph(point.x.toString(),!0),yInp=new InputFieldMorph(point.y.toString(),!0),xCol=new AlignmentMorph("column",2),yCol=new AlignmentMorph("column",2),inp=new AlignmentMorph("column",2),bdy=new AlignmentMorph("column",this.padding);
inp.alignment="left",inp.setColor(this.color),bdy.setColor(this.color),xCol.alignment="left",xCol.setColor(this.color),yCol.alignment="left",yCol.setColor(this.color),xCol.add(labelText(xLabel)),xCol.add(xInp),yCol.add(labelText(yLabel)),yCol.add(yInp),vec.add(xCol),vec.add(yCol),inp.add(vec),msg&&bdy.add(labelText(msg)),bdy.add(inp),vec.fixLayout(),xCol.fixLayout(),yCol.fixLayout(),inp.fixLayout(),bdy.fixLayout(),this.labelString=title,this.createLabel(),pic&&this.setPicture(pic),this.addBody(bdy),vec.drawNew(),xCol.drawNew(),xInp.drawNew(),yCol.drawNew(),yInp.drawNew(),bdy.fixLayout(),this.addButton("ok","OK"),deflt instanceof Point&&this.addButton(function(){
xInp.setContents(deflt.x.toString()),yInp.setContents(deflt.y.toString())},"Default"),this.addButton("cancel","Cancel"),this.fixLayout(),this.drawNew(),this.fixLayout(),this.edit=function(){xInp.edit()},this.getInput=function(){return new Point(xInp.getValue(),yInp.getValue())},this.key||(this.key="vector"+title),this.popUp(world)},DialogBoxMorph.prototype.promptCredentials=function(title,purpose,tosURL,tosLabel,prvURL,prvLabel,checkBoxLabel,world,pic,msg){function labelText(string){return new TextMorph(localize(string),10,null,!1,null,null,null,null,MorphicPreferences.isFlat?null:new Point(1,1),new Color(255,255,255))}function linkButton(label,url){var btn=new PushButtonMorph(myself,function(){
window.open(url)},"  "+localize(label)+"  ");return btn.fontSize=10,btn.corner=myself.buttonCorner,btn.edge=myself.buttonEdge,btn.outline=myself.buttonOutline,btn.outlineColor=myself.buttonOutlineColor,btn.outlineGradient=myself.buttonOutlineGradient,btn.padding=myself.buttonPadding,btn.contrast=myself.buttonContrast,btn.drawNew(),btn.fixLayout(),btn}function age(){var month,birthday,today=(new Date).getFullYear()+(new Date).getMonth()/12,year=+byr.getValue()||0,monthName=bmn.getValue();return monthName instanceof Array&&(monthName=monthName[0]),isNaN(year)&&(year=0),month=["January","February","March","April","May","June","July","August","September","October","November","December"].indexOf(monthName),
isNaN(month)&&(month=0),birthday=year+month/12,today-birthday}function validInputs(){function indicate(morph,string){var bubble=new SpeechBubbleMorph(localize(string));bubble.isPointingRight=!1,bubble.drawNew(),bubble.popUp(world,morph.leftCenter().subtract(new Point(bubble.width()+2,0))),morph.edit&&morph.edit()}var checklist,empty,em=eml.getValue();if("login"===purpose?checklist=[usr,pw1]:"signup"===purpose?checklist=[usr,bmn,byr,eml]:"changePassword"===purpose?checklist=[opw,pw1,pw2]:"resetPassword"===purpose&&(checklist=[usr]),empty=detect(checklist,function(inp){return!inp.getValue()}))return indicate(empty,"please fill out\nthis field"),!1;if("signup"===purpose){
if(usr.getValue().length<4)return indicate(usr,"User name must be four\ncharacters or longer"),!1;if(em.indexOf(" ")>-1||em.indexOf("@")===-1||em.indexOf(".")===-1)return indicate(eml,"please provide a valid\nemail address"),!1}if("changePassword"===purpose){if(pw1.getValue().length<6)return indicate(pw1,"password must be six\ncharacters or longer"),!1;if(pw1.getValue()!==pw2.getValue())return indicate(pw2,"passwords do\nnot match"),!1}return!("signup"===purpose&&!agree)||(indicate(chk,"please agree to\nthe TOS"),!1)}var bmn,byr,emlLabel,chk,usr=new InputFieldMorph,eml=new InputFieldMorph,pw1=new InputFieldMorph,pw2=new InputFieldMorph,opw=new InputFieldMorph,agree=!1,dof=new AlignmentMorph("row",4),mCol=new AlignmentMorph("column",2),yCol=new AlignmentMorph("column",2),inp=new AlignmentMorph("column",2),lnk=new AlignmentMorph("row",4),bdy=new AlignmentMorph("column",this.padding),years={},currentYear=(new Date).getFullYear(),firstYear=currentYear-20,myself=this;
for(bmn=new InputFieldMorph(null,!1,{January:["January"],February:["February"],March:["March"],April:["April"],May:["May"],June:["June"],July:["July"],August:["August"],September:["September"],October:["October"],November:["November"],December:["December"]},!0),currentYear;currentYear>firstYear;currentYear-=1)years[currentYear.toString()+" "]=currentYear;years[firstYear+" "+localize("or before")]="< "+currentYear,byr=new InputFieldMorph(null,!1,years,!0),inp.alignment="left",inp.setColor(this.color),bdy.setColor(this.color),mCol.alignment="left",mCol.setColor(this.color),yCol.alignment="left",yCol.setColor(this.color),usr.setWidth(200),bmn.setWidth(100),byr.contents().minWidth=80,
byr.setWidth(80),eml.setWidth(200),pw1.setWidth(200),pw2.setWidth(200),opw.setWidth(200),pw1.contents().text.toggleIsPassword(),pw2.contents().text.toggleIsPassword(),opw.contents().text.toggleIsPassword(),"login"===purpose&&(inp.add(labelText("User name:")),inp.add(usr)),"signup"===purpose&&(inp.add(labelText("User name:")),inp.add(usr),mCol.add(labelText("Birth date:")),mCol.add(bmn),yCol.add(labelText("year:")),yCol.add(byr),dof.add(mCol),dof.add(yCol),inp.add(dof),emlLabel=labelText("foo"),inp.add(emlLabel),inp.add(eml)),"login"===purpose&&(inp.add(labelText("Password:")),inp.add(pw1)),"changePassword"===purpose&&(inp.add(labelText("Old password:")),inp.add(opw),
inp.add(labelText("New password:")),inp.add(pw1),inp.add(labelText("Repeat new password:")),inp.add(pw2)),"resetPassword"===purpose&&(inp.add(labelText("User name:")),inp.add(usr)),msg&&bdy.add(labelText(msg)),bdy.add(inp),(tosURL||prvURL)&&bdy.add(lnk),tosURL&&lnk.add(linkButton(tosLabel,tosURL)),prvURL&&lnk.add(linkButton(prvLabel,prvURL)),checkBoxLabel&&(chk=new ToggleMorph("checkbox",this,function(){agree=!agree},checkBoxLabel,function(){return agree}),chk.edge=this.buttonEdge/2,chk.outline=this.buttonOutline/2,chk.outlineColor=this.buttonOutlineColor,chk.outlineGradient=this.buttonOutlineGradient,chk.contrast=this.buttonContrast,chk.drawNew(),chk.fixLayout(),
bdy.add(chk)),dof.fixLayout(),mCol.fixLayout(),yCol.fixLayout(),inp.fixLayout(),lnk.fixLayout(),bdy.fixLayout(),this.labelString=title,this.createLabel(),pic&&this.setPicture(pic),this.addBody(bdy),usr.drawNew(),dof.drawNew(),mCol.drawNew(),bmn.drawNew(),yCol.drawNew(),byr.drawNew(),pw1.drawNew(),pw2.drawNew(),opw.drawNew(),eml.drawNew(),bdy.fixLayout(),this.addButton("ok","OK"),this.addButton("cancel","Cancel"),this.fixLayout(),this.drawNew(),this.fixLayout(),this.accept=function(){validInputs()&&DialogBoxMorph.prototype.accept.call(myself)},this.edit=function(){"changePassword"===purpose?opw.edit():usr.edit()},this.getInput=function(){return{username:usr.getValue(),
email:eml.getValue(),oldpassword:opw.getValue(),password:pw1.getValue(),choice:agree}},this.reactToChoice=function(){"signup"===purpose&&(emlLabel.changed(),emlLabel.text=age()<=13?"E-mail address of parent or guardian:":"E-mail address:",emlLabel.text=localize(emlLabel.text),emlLabel.drawNew(),emlLabel.changed())},this.reactToChoice(),this.key||(this.key="credentials"+title+purpose),this.popUp(world)},DialogBoxMorph.prototype.accept=function(){this.action&&("function"==typeof this.target?"function"==typeof this.action?this.target.call(this.environment,this.action.call()):this.target.call(this.environment,this.action):"function"==typeof this.action?this.action.call(this.target,this.getInput()):this.target[this.action](this.getInput())),
this.destroy()},DialogBoxMorph.prototype.withKey=function(key){return this.key=key,this},DialogBoxMorph.prototype.popUp=function(world){world&&(this.key&&(this.instances[world.stamp]?(this.instances[world.stamp][this.key]&&this.instances[world.stamp][this.key].destroy(),this.instances[world.stamp][this.key]=this):(this.instances[world.stamp]={},this.instances[world.stamp][this.key]=this)),world.add(this),world.keyboardReceiver=this,this.setCenter(world.center()),this.edit())},DialogBoxMorph.prototype.destroy=function(){DialogBoxMorph.uber.destroy.call(this),this.key&&delete this.instances[this.key]},DialogBoxMorph.prototype.ok=function(){this.accept()},DialogBoxMorph.prototype.cancel=function(){
this.destroy()},DialogBoxMorph.prototype.edit=function(){this.children.forEach(function(c){if(c.edit)return c.edit()})},DialogBoxMorph.prototype.getInput=function(){return this.body instanceof InputFieldMorph?this.body.getValue():null},DialogBoxMorph.prototype.justDropped=function(hand){hand.world.keyboardReceiver=this,this.edit()},DialogBoxMorph.prototype.destroy=function(){var world=this.world();world.keyboardReceiver=null,world.hand.destroyTemporaries(),DialogBoxMorph.uber.destroy.call(this)},DialogBoxMorph.prototype.normalizeSpaces=function(string){var i,c,ans="",flag=!1;for(i=0;i<string.length;i+=1)c=string[i]," "===c?flag&&(ans+=c,flag=!1):(ans+=c,flag=!0);
return ans.trim()},DialogBoxMorph.prototype.createLabel=function(){var shading=!MorphicPreferences.isFlat||this.is3D;this.label&&this.label.destroy(),this.labelString&&(this.label=new StringMorph(localize(this.labelString),this.titleFontSize,this.fontStyle,!0,!1,!1,shading?new Point(2,1):null,this.titleBarColor.darker(this.contrast)),this.label.color=this.titleTextColor,this.label.drawNew(),this.add(this.label))},DialogBoxMorph.prototype.createButtons=function(){this.buttons&&this.buttons.destroy(),this.buttons=new AlignmentMorph("row",this.padding),this.add(this.buttons)},DialogBoxMorph.prototype.addButton=function(action,label){var button=new PushButtonMorph(this,action||"ok","  "+localize(label||"OK")+"  ");
return button.fontSize=this.buttonFontSize,button.corner=this.buttonCorner,button.edge=this.buttonEdge,button.outline=this.buttonOutline,button.outlineColor=this.buttonOutlineColor,button.outlineGradient=this.buttonOutlineGradient,button.padding=this.buttonPadding,button.contrast=this.buttonContrast,button.drawNew(),button.fixLayout(),this.buttons.add(button),button},DialogBoxMorph.prototype.setPicture=function(aMorphOrCanvas){var morph;aMorphOrCanvas instanceof Morph?morph=aMorphOrCanvas:(morph=new Morph,morph.image=aMorphOrCanvas,morph.silentSetWidth(aMorphOrCanvas.width),morph.silentSetHeight(aMorphOrCanvas.height)),this.addHead(morph)},DialogBoxMorph.prototype.addHead=function(aMorph){
this.head&&this.head.destroy(),this.head=aMorph,this.add(this.head)},DialogBoxMorph.prototype.addBody=function(aMorph){this.body&&this.body.destroy(),this.body=aMorph,this.add(this.body)},DialogBoxMorph.prototype.addShadow=function(){nop()},DialogBoxMorph.prototype.removeShadow=function(){nop()},DialogBoxMorph.prototype.fixLayout=function(){var w,th=fontHeight(this.titleFontSize)+2*this.titlePadding;this.head&&(this.head.setPosition(this.position().add(new Point(this.padding,th+this.padding))),this.silentSetWidth(this.head.width()+2*this.padding),this.silentSetHeight(this.head.height()+2*this.padding+th)),this.body&&(this.head?(this.body.setPosition(this.head.bottomLeft().add(new Point(0,this.padding))),
this.silentSetWidth(Math.max(this.width(),this.body.width()+2*this.padding)),this.silentSetHeight(this.height()+this.body.height()+this.padding),w=this.width(),this.head.setLeft(this.left()+Math.round((w-this.head.width())/2)),this.body.setLeft(this.left()+Math.round((w-this.body.width())/2))):(this.body.setPosition(this.position().add(new Point(this.padding,th+this.padding))),this.silentSetWidth(this.body.width()+2*this.padding),this.silentSetHeight(this.body.height()+2*this.padding+th))),this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(th-this.label.height())/2)),this.buttons&&this.buttons.children.length>0&&(this.buttons.fixLayout(),
this.silentSetHeight(this.height()+this.buttons.height()+this.padding),this.silentSetWidth(Math.max(this.width(),this.buttons.width()+2*this.padding)),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding))},DialogBoxMorph.prototype.shadowImage=function(off,color){var fb,img,outline,sha,ctx,offset=off||new Point(7,7),clr=color||new Color(0,0,0);return fb=this.extent(),img=this.image,outline=newCanvas(fb),ctx=outline.getContext("2d"),ctx.drawImage(img,0,0),ctx.globalCompositeOperation="destination-out",ctx.drawImage(img,-offset.x,-offset.y),sha=newCanvas(fb),ctx=sha.getContext("2d"),ctx.drawImage(outline,0,0),ctx.globalCompositeOperation="source-atop",
ctx.fillStyle=clr.toString(),ctx.fillRect(0,0,fb.x,fb.y),sha},DialogBoxMorph.prototype.shadowImageBlurred=function(off,color){var fb,img,sha,ctx,offset=off||new Point(7,7),blur=this.shadowBlur,clr=color||new Color(0,0,0);return fb=this.extent().add(2*blur),img=this.image,sha=newCanvas(fb),ctx=sha.getContext("2d"),ctx.shadowOffsetX=offset.x,ctx.shadowOffsetY=offset.y,ctx.shadowBlur=blur,ctx.shadowColor=clr.toString(),ctx.drawImage(img,blur-offset.x,blur-offset.y),ctx.shadowOffsetX=0,ctx.shadowOffsetY=0,ctx.shadowBlur=0,ctx.globalCompositeOperation="destination-out",ctx.drawImage(img,blur-offset.x,blur-offset.y),sha},DialogBoxMorph.prototype.processKeyPress=function(){
nop()},DialogBoxMorph.prototype.processKeyDown=function(event){switch(event.keyCode){case 13:this.ok();break;case 27:this.cancel();break;default:nop()}},DialogBoxMorph.prototype.drawNew=function(){this.fullChanged(),Morph.prototype.trackChanges=!1,DialogBoxMorph.uber.removeShadow.call(this),this.fixLayout();var context,gradient,x,y,w=this.width(),h=this.height(),th=Math.floor(fontHeight(this.titleFontSize)+2*this.titlePadding),shift=this.corner/2,isFlat=MorphicPreferences.isFlat&&!this.is3D;return this.image=newCanvas(this.extent()),context=this.image.getContext("2d"),isFlat?context.fillStyle=this.titleBarColor.toString():(gradient=context.createLinearGradient(0,0,0,th),
gradient.addColorStop(0,this.titleBarColor.lighter(this.contrast/2).toString()),gradient.addColorStop(1,this.titleBarColor.darker(this.contrast).toString()),context.fillStyle=gradient),context.beginPath(),this.outlinePathTitle(context,isFlat?0:this.corner),context.closePath(),context.fill(),context.fillStyle=this.color.toString(),context.beginPath(),this.outlinePathBody(context,isFlat?0:this.corner),context.closePath(),context.fill(),isFlat?(DialogBoxMorph.uber.addShadow.call(this),Morph.prototype.trackChanges=!0,void this.fullChanged()):(gradient=context.createLinearGradient(0,h-this.corner,0,h),gradient.addColorStop(0,this.color.toString()),gradient.addColorStop(1,this.color.darker(this.contrast.toString())),
context.lineWidth=this.corner,context.lineCap="round",context.strokeStyle=gradient,context.beginPath(),context.moveTo(this.corner,h-shift),context.lineTo(this.corner+1,h-shift),context.stroke(),gradient=context.createLinearGradient(0,h-this.corner,0,h),gradient.addColorStop(0,this.color.toString()),gradient.addColorStop(1,this.color.darker(this.contrast.toString())),context.lineWidth=this.corner,context.lineCap="butt",context.strokeStyle=gradient,context.beginPath(),context.moveTo(this.corner,h-shift),context.lineTo(w-this.corner,h-shift),context.stroke(),gradient=context.createLinearGradient(w-this.corner,0,w,0),gradient.addColorStop(0,this.color.toString()),
gradient.addColorStop(1,this.color.darker(this.contrast).toString()),context.lineWidth=this.corner,context.lineCap="butt",context.strokeStyle=gradient,context.beginPath(),context.moveTo(w-shift,th),context.lineTo(w-shift,h-this.corner),context.stroke(),x=w-this.corner,y=h-this.corner,gradient=context.createRadialGradient(x,y,0,x,y,this.corner),gradient.addColorStop(0,this.color.toString()),gradient.addColorStop(1,this.color.darker(this.contrast.toString())),context.lineCap="butt",context.strokeStyle=gradient,context.beginPath(),context.arc(x,y,shift,radians(90),radians(0),!0),context.stroke(),gradient=context.createLinearGradient(0,0,this.corner,0),gradient.addColorStop(0,this.color.lighter(this.contrast).toString()),
gradient.addColorStop(1,this.color.toString()),context.lineCap="butt",context.strokeStyle=gradient,context.beginPath(),context.moveTo(shift,th),context.lineTo(shift,h-2*this.corner),context.stroke(),gradient=context.createLinearGradient(0,0,this.corner,0),gradient.addColorStop(0,this.color.lighter(this.contrast).toString()),gradient.addColorStop(1,this.color.toString()),context.lineCap="round",context.strokeStyle=gradient,context.beginPath(),context.moveTo(shift,h-2*this.corner),context.lineTo(shift,h-this.corner-shift),context.stroke(),DialogBoxMorph.uber.addShadow.call(this),Morph.prototype.trackChanges=!0,void this.fullChanged())},DialogBoxMorph.prototype.outlinePathTitle=function(context,radius){
var w=this.width(),h=Math.ceil(fontHeight(this.titleFontSize))+2*this.titlePadding;context.arc(radius,radius,radius,radians(-180),radians(-90),!1),context.arc(w-radius,radius,radius,radians(-90),radians(-0),!1),context.lineTo(w,h),context.lineTo(0,h)},DialogBoxMorph.prototype.outlinePathBody=function(context,radius){var w=this.width(),h=this.height(),th=Math.floor(fontHeight(this.titleFontSize))+2*this.titlePadding;context.moveTo(0,th),context.lineTo(w,th),context.arc(w-radius,h-radius,radius,radians(0),radians(90),!1),context.arc(radius,h-radius,radius,radians(90),radians(180),!1)},AlignmentMorph.prototype=new Morph,AlignmentMorph.prototype.constructor=AlignmentMorph,
AlignmentMorph.uber=Morph.prototype,AlignmentMorph.prototype.init=function(orientation,padding){this.orientation=orientation||"row",this.alignment="center",this.padding=padding||0,this.respectHiddens=!1,AlignmentMorph.uber.init.call(this)},AlignmentMorph.prototype.drawNew=function(){this.image=newCanvas(new Point(1,1)),this.fixLayout()},AlignmentMorph.prototype.fixLayout=function(){var newBounds,myself=this,last=null;return 0===this.children.length?null:(this.children.forEach(function(c){var lfb,cfb=c.fullBounds();(c.isVisible||myself.respectHiddens)&&(last?(lfb=last.fullBounds(),"row"===myself.orientation?c.setPosition(lfb.topRight().add(new Point(myself.padding,(lfb.height()-cfb.height())/2))):c.setPosition(lfb.bottomLeft().add(new Point("center"===myself.alignment?(lfb.width()-cfb.width())/2:0,myself.padding))),
cfb=c.fullBounds(),newBounds=newBounds.merge(cfb)):newBounds=cfb,last=c)}),void(this.bounds=newBounds))},InputFieldMorph.prototype=new Morph,InputFieldMorph.prototype.constructor=InputFieldMorph,InputFieldMorph.uber=Morph.prototype,InputFieldMorph.prototype.edge=2,InputFieldMorph.prototype.fontSize=12,InputFieldMorph.prototype.typeInPadding=2,InputFieldMorph.prototype.contrast=65,InputFieldMorph.prototype.init=function(text,isNumeric,choiceDict,isReadOnly){var contents=new StringFieldMorph(text||""),arrow=new ArrowMorph("down",0,Math.max(Math.floor(this.fontSize/6),1));this.choices=choiceDict||null,this.isReadOnly=isReadOnly||!1,this.isNumeric=isNumeric||!1,contents.alpha=0,
contents.fontSize=this.fontSize,contents.drawNew(),this.oldContentsExtent=contents.extent(),this.isNumeric=isNumeric||!1,InputFieldMorph.uber.init.call(this),this.color=new Color(255,255,255),this.add(contents),this.add(arrow),contents.isDraggable=!1,this.drawNew()},InputFieldMorph.prototype.contents=function(){return detect(this.children,function(child){return child instanceof StringFieldMorph})},InputFieldMorph.prototype.arrow=function(){return detect(this.children,function(child){return child instanceof ArrowMorph})},InputFieldMorph.prototype.setChoice=function(aStringOrFloat){this.setContents(aStringOrFloat),this.escalateEvent("reactToChoice",aStringOrFloat);
},InputFieldMorph.prototype.setContents=function(aStringOrFloat){var cnts=this.contents();return cnts.text.text=aStringOrFloat,void 0===aStringOrFloat?null:(null===aStringOrFloat?cnts.text.text="":aStringOrFloat.toString&&(cnts.text.text=aStringOrFloat.toString()),cnts.drawNew(),void cnts.changed())},InputFieldMorph.prototype.edit=function(){var c=this.contents();c.text.edit(),c.text.selectAll()},InputFieldMorph.prototype.setIsNumeric=function(bool){var value;this.isNumeric=bool,this.contents().isNumeric=bool,this.contents().text.isNumeric=bool,value=this.getValue(),this.isNumeric&&(value=parseFloat(value),isNaN(value)&&(value=null)),this.setContents(value)},
InputFieldMorph.prototype.dropDownMenu=function(){var key,choices=this.choices,menu=new MenuMorph(this.setChoice,null,this,this.fontSize);if(choices instanceof Function?choices=choices.call(this):isString(choices)&&(choices=this[choices]()),!choices)return null;if(menu.addItem(" ",null),choices instanceof Array)choices.forEach(function(choice){menu.addItem(choice[0],choice[1])});else for(key in choices)Object.prototype.hasOwnProperty.call(choices,key)&&("~"===key[0]?menu.addLine():menu.addItem(key,choices[key]));return menu.items.length>0?void menu.popUpAtHand(this.world()):null},InputFieldMorph.prototype.fixLayout=function(){var contents=this.contents(),arrow=this.arrow();
return contents?(contents.isNumeric=this.isNumeric,contents.isEditable=!this.isReadOnly,this.choices?(arrow.setSize(this.fontSize),arrow.show()):(arrow.setSize(0),arrow.hide()),this.silentSetHeight(contents.height()+2*this.edge+2*this.typeInPadding),this.silentSetWidth(Math.max(contents.minWidth+2*this.edge+2*this.typeInPadding,this.width())),contents.setWidth(this.width()-this.edge-this.typeInPadding-(this.choices?arrow.width()+this.typeInPadding:0)),contents.silentSetPosition(new Point(this.edge,this.edge).add(this.typeInPadding).add(this.position())),void arrow.silentSetPosition(new Point(this.right()-arrow.width()-this.edge,contents.top()))):null},InputFieldMorph.prototype.mouseClickLeft=function(pos){
this.arrow().bounds.containsPoint(pos)?this.dropDownMenu():this.isReadOnly?this.dropDownMenu():this.escalateEvent("mouseClickLeft",pos)},InputFieldMorph.prototype.getValue=function(){var num,contents=this.contents();return this.isNumeric&&(num=parseFloat(contents.text),!isNaN(num))?num:this.normalizeSpaces(contents.string())},InputFieldMorph.prototype.normalizeSpaces=DialogBoxMorph.prototype.normalizeSpaces,InputFieldMorph.prototype.drawNew=function(){var context,borderColor;this.fixLayout(),this.image=newCanvas(this.extent()),context=this.image.getContext("2d"),this.parent?(this.parent.color.eq(new Color(255,255,255))?this.color=this.parent.color.darker(.1*this.contrast):this.color=this.parent.color.lighter(.75*this.contrast),
borderColor=this.parent.color):borderColor=new Color(120,120,120),context.fillStyle=this.color.toString(),this.cachedClr=borderColor.toString(),this.cachedClrBright=borderColor.lighter(this.contrast).toString(),this.cachedClrDark=borderColor.darker(this.contrast).toString(),context.fillRect(this.edge,this.edge,this.width()-2*this.edge,this.height()-2*this.edge),this.drawRectBorder(context)},InputFieldMorph.prototype.drawRectBorder=function(context){var gradient,shift=.5*this.edge;MorphicPreferences.isFlat&&!this.is3D||(context.lineWidth=this.edge,context.lineJoin="round",context.lineCap="round",context.shadowOffsetY=shift,context.shadowBlur=4*this.edge,context.shadowColor=this.cachedClrDark,
gradient=context.createLinearGradient(0,0,0,this.edge),gradient.addColorStop(0,this.cachedClr),gradient.addColorStop(1,this.cachedClrDark),context.strokeStyle=gradient,context.beginPath(),context.moveTo(this.edge,shift),context.lineTo(this.width()-this.edge-shift,shift),context.stroke(),context.shadowOffsetY=0,gradient=context.createLinearGradient(0,0,this.edge,0),gradient.addColorStop(0,this.cachedClr),gradient.addColorStop(1,this.cachedClrDark),context.strokeStyle=gradient,context.beginPath(),context.moveTo(shift,this.edge),context.lineTo(shift,this.height()-this.edge-shift),context.stroke(),context.shadowOffsetX=0,context.shadowOffsetY=0,context.shadowBlur=0,
gradient=context.createLinearGradient(0,this.height()-this.edge,0,this.height()),gradient.addColorStop(0,this.cachedClrBright),gradient.addColorStop(1,this.cachedClr),context.strokeStyle=gradient,context.beginPath(),context.moveTo(this.edge,this.height()-shift),context.lineTo(this.width()-this.edge,this.height()-shift),context.stroke(),gradient=context.createLinearGradient(this.width()-this.edge,0,this.width(),0),gradient.addColorStop(0,this.cachedClrBright),gradient.addColorStop(1,this.cachedClr),context.strokeStyle=gradient,context.beginPath(),context.moveTo(this.width()-shift,this.edge),context.lineTo(this.width()-shift,this.height()-this.edge),context.stroke());
},PianoMenuMorph.prototype=new MenuMorph,PianoMenuMorph.prototype.constructor=PianoMenuMorph,PianoMenuMorph.uber=MenuMorph.prototype,PianoMenuMorph.prototype.init=function(target,environment,fontSize,soundType){var choices,key;this.soundType=soundType,PianoMenuMorph.uber.init.call(this,target,null,environment,fontSize),choices={"C (48)":48,"D (50)":50,"C# (49)":49,"E (52)":52,"Eb (51)":51,"F (53)":53,"G (55)":55,"F# (54)":54,"A (57)":57,"G# (56)":56,"B (59)":59,"Bb (58)":58,"C (60)":60,"D (62)":62,"C# (61)":61,"E (64)":64,"Eb (63)":63,"F (65)":65,"G (67)":67,"F# (66)":66,"A (69)":69,"G# (68)":68,"B (71)":71,"Bb (70)":70,"C (72)":72};for(key in choices)Object.prototype.hasOwnProperty.call(choices,key)&&this.addItem(key,choices[key]);
this.drawNew()},PianoMenuMorph.prototype.drawNew=function(){var item,fb,x,y,label,blackkey,key,keycolor,keywidth,keyheight,keyposition,myself=this;this.children.forEach(function(m){m.destroy()}),this.children=[],this.isListContents||(this.edge=MorphicPreferences.isFlat?0:5,this.border=MorphicPreferences.isFlat?1:2),this.color=new Color(255,255,255),this.borderColor=new Color(60,60,60),this.silentSetExtent(new Point(0,0)),x=this.left()+1,y=this.top()+1.5*this.fontSize+2,label=new StringMorph("",this.fontSize),this.items.forEach(function(tuple){blackkey=" "!==tuple[0][1],key=new BoxMorph(1,1),blackkey?(keycolor=new Color(0,0,0),keywidth=myself.fontSize,keyheight=2.5*myself.fontSize,
keyposition=new Point(x+2-2*myself.fontSize,y)):(keycolor=new Color(255,255,255),keywidth=1.5*myself.fontSize,keyheight=4*myself.fontSize,keyposition=new Point(x+1,y),x+=keywidth-1),key.setColor(keycolor),key.setWidth(keywidth),key.setHeight(keyheight),item=new PianoKeyMorph(myself.target,tuple[1],[key,tuple[0]],myself.fontSize||MorphicPreferences.menuFontSize,MorphicPreferences.menuFontName,myself.environment,tuple[2],tuple[3],tuple[4],tuple[5],tuple[6],label),item.setPosition(keyposition),myself.add(item)}),fb=this.fullBounds(),label.setPosition(new Point(fb.width()/2-this.fontSize,2)),this.add(label),fb=this.fullBounds(),this.silentSetExtent(fb.extent().add(2)),
MenuMorph.uber.drawNew.call(this)},PianoMenuMorph.prototype.select=function(aPianoKeyItem){this.unselectAllItems(),aPianoKeyItem.mouseEnter(),this.selection=aPianoKeyItem,this.world.keyboardReceiver=this,this.hasFocus=!0},PianoMenuMorph.prototype.unselectAllItems=function(){this.children.forEach(function(item){item instanceof MenuItemMorph&&item.mouseLeave()}),this.changed()},PianoMenuMorph.prototype.selectKey=function(midiNum){var key;isNil(midiNum)||(key=detect(this.children,function(each){return each.action===midiNum}),key?this.select(key):this.selectKey(48))},PianoMenuMorph.prototype.processKeyDown=function(event){switch(event.keyCode){case 13:case 32:return void(this.selection&&this.selection.mouseClickLeft());
case 27:return this.destroy();case 37:case 40:case 189:return this.selectDown();case 38:case 39:case 187:case 220:return this.selectUp();default:switch(event.key){case"C":return this.selectKey(48);case"c":return this.selectKey(60);case"D":return this.selectKey(50);case"d":return this.selectKey(62);case"E":return this.selectKey(52);case"e":return this.selectKey(64);case"F":return this.selectKey(53);case"f":return this.selectKey(65);case"G":return this.selectKey(55);case"g":return this.selectKey(67);case"A":return this.selectKey(57);case"a":return this.selectKey(69);case"B":case"H":return this.selectKey(59);case"b":case"h":return this.selectKey(71);default:nop();
}}},PianoMenuMorph.prototype.selectUp=function(){var next=48;this.selection&&(next=this.selection.action+1,next>72&&(next=48)),this.selectKey(next)},PianoMenuMorph.prototype.selectDown=function(){var next=48;this.selection&&(next=this.selection.action-1,next<48&&(next=72)),this.selectKey(next)},PianoMenuMorph.prototype.destroy=function(){this.children.forEach(function(key){key.note&&key.note.stop()}),PianoMenuMorph.uber.destroy.call(this)},PianoKeyMorph.prototype=new MenuItemMorph,PianoKeyMorph.prototype.constructor=PianoKeyMorph,PianoKeyMorph.uber=MenuItemMorph.prototype,PianoKeyMorph.prototype.init=function(target,action,labelString,fontSize,fontStyle,environment,hint,color,bold,italic,doubleClickAction,label){
this.note=new Note(action),PianoKeyMorph.uber.init.call(this,target,action,labelString,fontSize,fontStyle,environment,hint,color,bold,italic,doubleClickAction,label)},PianoKeyMorph.prototype.createLabel=function(){var icon;null!==this.label&&this.label.destroy(),this.label=new Morph,icon=this.createIcon(this.labelString[0]),this.label.add(icon),this.label.drawNew(),this.silentSetExtent(icon.extent()),this.label.bounds=this.position().extent(this.label.extent()),this.label.silentSetExtent(new Point(0,0)),this.add(this.label)},PianoKeyMorph.prototype.mouseEnter=function(){var piano=this.parentThatIsA(PianoMenuMorph),soundType=piano?piano.soundType:1,myself=this;
piano&&(piano.unselectAllItems(),piano.selection=this,piano.world.keyboardReceiver=piano,piano.hasFocus=!0),this.label.children[0].hide(),this.image=this.highlightImage,this.changed(),this.feedback.text=this.labelString[1],this.feedback.changed(),this.feedback.drawNew(),this.feedback.changed(),this.note.play(soundType),setTimeout(function(){myself.note.stop()},400)},PianoKeyMorph.prototype.mouseLeave=function(){this.note.stop(),this.label.children[0].show(),this.image=this.normalImage,this.changed()},modules.blocks="2017-November-16";var SyntaxElementMorph,BlockMorph,CommandBlockMorph,ReporterBlockMorph,ScriptsMorph,ArgMorph,CommandSlotMorph,CSlotMorph,InputSlotMorph,BooleanSlotMorph,ArrowMorph,ColorSlotMorph,HatBlockMorph,BlockHighlightMorph,MultiArgMorph,TemplateSlotMorph,FunctionSlotMorph,ReporterSlotMorph,RingMorph,RingCommandSlotMorph,RingReporterSlotMorph,CommentMorph,ArgLabelMorph,TextSlotMorph,ScriptFocusMorph;
SyntaxElementMorph.prototype=new Morph,SyntaxElementMorph.prototype.constructor=SyntaxElementMorph,SyntaxElementMorph.uber=Morph.prototype,SyntaxElementMorph.prototype.setScale=function(num){var scale=Math.min(Math.max(num,1),25);this.scale=scale,this.corner=3*scale,this.rounding=9*scale,this.edge=1.000001*scale,this.inset=6*scale,this.hatHeight=12*scale,this.hatWidth=70*scale,this.rfBorder=3*scale,this.minWidth=0,this.dent=8*scale,this.bottomPadding=3*scale,this.cSlotPadding=4*scale,this.typeInPadding=scale,this.labelPadding=4*scale,this.labelFontName="Verdana",this.labelFontStyle="sans-serif",this.fontSize=10*scale,this.embossing=new Point(-1*Math.max(scale/2,1),-1*Math.max(scale/2,1)),
this.labelWidth=450*scale,this.labelWordWrap=!0,this.dynamicInputLabels=!0,this.feedbackColor=new Color(255,255,255),this.feedbackMinHeight=5,this.minSnapDistance=20,this.reporterDropFeedbackPadding=10*scale,this.contrast=65,this.labelContrast=25,this.activeHighlight=new Color(153,255,213),this.errorHighlight=new Color(173,15,0),this.activeBlur=20,this.activeBorder=4,this.rfColor=new Color(120,120,120)},SyntaxElementMorph.prototype.setScale(1),SyntaxElementMorph.prototype.isCachingInputs=!1,SyntaxElementMorph.prototype.init=function(silently){this.cachedClr=null,this.cachedClrBright=null,this.cachedClrDark=null,this.cachedNormalColor=null,this.isStatic=!1,SyntaxElementMorph.uber.init.call(this,silently),
this.defaults=[],this.cachedInputs=null},SyntaxElementMorph.prototype.parts=function(){var nb=null;return this.nextBlock&&(nb=this.nextBlock()),this.children.filter(function(child){return!(child===nb||child instanceof ShadowMorph||child instanceof BlockHighlightMorph)})},SyntaxElementMorph.prototype.inputs=function(){return!isNil(this.cachedInputs)&&this.isCachingInputs||(this.cachedInputs=this.parts().filter(function(part){return part instanceof SyntaxElementMorph})),this.cachedInputs},SyntaxElementMorph.prototype.debugCachedInputs=function(){var realInputs,i;if(isNil(this.cachedInputs)||(realInputs=this.parts().filter(function(part){return part instanceof SyntaxElementMorph;
})),this.cachedInputs.length!==realInputs.length)throw new Error("cached inputs size do not match: "+this.constructor.name);for(i=0;i<realInputs.length;i+=1)if(this.cachedInputs[i]!==realInputs[i])throw new Error("cached input does not match: "+this.constructor.name+" #"+i+" "+this.cachedInputs[i].constructor.name+" != "+realInputs[i].constructor.name)},SyntaxElementMorph.prototype.allInputs=function(){var myself=this;return this.allChildren().slice(0).reverse().filter(function(child){return child instanceof ArgMorph||child instanceof ReporterBlockMorph&&child!==myself})},SyntaxElementMorph.prototype.allEmptySlots=function(){var empty=[];return this instanceof RingMorph||"reportJSFunction"===this.selector||this.children.forEach(function(morph){
morph.isEmptySlot&&morph.isEmptySlot()?empty.push(morph):morph.allEmptySlots&&(empty=empty.concat(morph.allEmptySlots()))}),empty},SyntaxElementMorph.prototype.tagExitBlocks=function(stopTag,isCommand){"doReport"===this.selector?this.partOfCustomCommand=isCommand:"doStopThis"===this.selector?this.exitTag=stopTag:this instanceof RingMorph||this.children.forEach(function(morph){morph.tagExitBlocks&&morph.tagExitBlocks(stopTag,isCommand)})},SyntaxElementMorph.prototype.replaceInput=function(oldArg,newArg){var scripts=this.parentThatIsA(ScriptsMorph),replacement=newArg,idx=this.children.indexOf(oldArg),i=0;return idx===-1&&newArg instanceof MultiArgMorph&&this.children.forEach(function(morph){
morph instanceof ArgLabelMorph&&morph.argMorph()===oldArg&&(idx=i),i+=1}),idx===-1||null===scripts?null:(oldArg.cachedSlotSpec&&(oldArg.cachedSlotSpec=null),newArg.cachedSlotSpec&&(newArg.cachedSlotSpec=null),this.startLayout(),newArg.parent&&newArg.parent.removeChild(newArg),oldArg instanceof MultiArgMorph&&(oldArg.inputs().forEach(function(inp){oldArg.replaceInput(inp,new InputSlotMorph)}),this.dynamicInputLabels&&(replacement=new ArgLabelMorph(newArg))),replacement.parent=this,this.children[idx]=replacement,oldArg instanceof ReporterBlockMorph&&(oldArg instanceof RingMorph&&!(oldArg instanceof RingMorph&&oldArg.contents())||(scripts.add(oldArg),oldArg.moveBy(replacement.extent()),
oldArg.fixBlockColor())),replacement instanceof MultiArgMorph||replacement instanceof ArgLabelMorph||replacement.constructor===CommandSlotMorph?(replacement.fixLayout(),this.fixLabelColor&&this.fixLabelColor()):(replacement.drawNew(),this.fixLayout()),this.cachedInputs=null,void this.endLayout())},SyntaxElementMorph.prototype.silentReplaceInput=function(oldArg,newArg){var replacement,i=this.children.indexOf(oldArg);i!==-1&&(oldArg.cachedSlotSpec&&(oldArg.cachedSlotSpec=null),newArg.cachedSlotSpec&&(newArg.cachedSlotSpec=null),newArg.parent&&newArg.parent.removeChild(newArg),replacement=oldArg instanceof MultiArgMorph&&this.dynamicInputLabels?new ArgLabelMorph(newArg):newArg,
replacement.parent=this,this.children[i]=replacement,replacement instanceof MultiArgMorph||replacement instanceof ArgLabelMorph||replacement.constructor===CommandSlotMorph?(replacement.fixLayout(),this.fixLabelColor&&this.fixLabelColor()):(replacement.drawNew(),this.fixLayout()),this.cachedInputs=null)},SyntaxElementMorph.prototype.revertToDefaultInput=function(arg,noValues){var def,idx=this.parts().indexOf(arg),inp=this.inputs().indexOf(arg),deflt=new InputSlotMorph;idx!==-1&&(this instanceof BlockMorph?(deflt=this.labelPart(this.parseSpec(this.blockSpec)[idx]),this.isCustomBlock&&(def=this.isGlobal?this.definition:this.scriptTarget().getMethod(this.blockSpec),
deflt instanceof InputSlotMorph&&deflt.setChoices.apply(deflt,def.inputOptionsOfIdx(inp)),(deflt instanceof InputSlotMorph||deflt instanceof BooleanSlotMorph)&&deflt.setContents(def.defaultValueOfInputIdx(inp)))):this instanceof MultiArgMorph?deflt=this.labelPart(this.slotSpec):this instanceof ReporterSlotMorph&&(deflt=this.emptySlot())),noValues||inp!==-1&&(deflt instanceof MultiArgMorph?(deflt.setContents(this.defaults),deflt.defaults=this.defaults):isNil(this.defaults[inp])||deflt.setContents(this.defaults[inp])),this.silentReplaceInput(arg,deflt),deflt instanceof MultiArgMorph?deflt.refresh():deflt instanceof RingMorph&&deflt.fixBlockColor(),this.cachedInputs=null;
},SyntaxElementMorph.prototype.isLocked=function(){return this.isStatic},SyntaxElementMorph.prototype.topBlock=function(){return this.parent&&this.parent.topBlock?this.parent.topBlock():this},SyntaxElementMorph.prototype.getVarNamesDict=function(){var rcvr,dict,block=this.parentThatIsA(BlockMorph),tempVars=[];return block?(rcvr=block.scriptTarget(),block.allParents().forEach(function(morph){morph instanceof PrototypeHatBlockMorph?(tempVars.push.apply(tempVars,morph.variableNames()),tempVars.push.apply(tempVars,morph.inputs()[0].inputFragmentNames())):morph instanceof BlockMorph&&morph.inputs().forEach(function(inp){inp instanceof TemplateSlotMorph?tempVars.push(inp.contents()):inp instanceof MultiArgMorph&&inp.children.forEach(function(m){
m instanceof TemplateSlotMorph&&tempVars.push(m.contents())})})}),rcvr?(dict=rcvr.variables.allNamesDict(),tempVars.forEach(function(name){dict[name]=name}),dict):{}):{}},SyntaxElementMorph.prototype.refactorVarInStack=function(oldName,newName,isScriptVar){if(!(this instanceof RingMorph&&contains(this.inputNames(),oldName)||!isScriptVar&&this.definesScriptVariable(oldName))&&("reportGetVar"===this.selector&&this.blockSpec===oldName&&(this.setSpec(newName),this.fullChanged(),this.fixLabelColor()),"getVarNamesDict"===this.choices&&this.contents().text===oldName&&this.setContents(newName),this instanceof CustomCommandBlockMorph&&this.definition.body&&isNil(this.definition.declarations[oldName])&&!contains(this.definition.variableNames,oldName)&&this.definition.body.expression.refactorVarInStack(oldName,newName),
this.inputs().forEach(function(input){input.refactorVarInStack(oldName,newName)}),this.nextBlock)){var nb=this.nextBlock();nb&&nb.refactorVarInStack(oldName,newName)}},SyntaxElementMorph.prototype.definesScriptVariable=function(name){return("doDeclareVariables"===this.selector||this.blockSpec&&this.blockSpec.match("%upvar"))&&detect(this.inputs()[0].allInputs(),function(input){return"reportGetVar"===input.selector&&input.blockSpec===name})},SyntaxElementMorph.prototype.selectForEdit=function(){var selected,scripts=this.parentThatIsA(ScriptsMorph),ide=this.parentThatIsA(IDE_Morph),rcvr=ide?ide.currentSprite:null;return scripts&&rcvr&&rcvr.inheritsAttribute("scripts")?(this.selectionID=!0,
rcvr.shadowAttribute("scripts"),selected=detect(rcvr.scripts.allChildren(),function(m){return m.selectionID}),delete this.selectionID,delete selected.selectionID,selected):this},SyntaxElementMorph.prototype.reactToGrabOf=function(grabbedMorph){var affected,topBlock=this.topBlock();grabbedMorph instanceof CommandBlockMorph&&(affected=this.parentThatIsA(CommandSlotMorph),affected&&(this.startLayout(),affected.fixLayout(),this.endLayout())),topBlock&&(topBlock.allComments().forEach(function(comment){comment.align(topBlock)}),topBlock.getHighlight()&&topBlock.addHighlight(topBlock.removeHighlight()))},SyntaxElementMorph.prototype.bright=function(){return this.color.lighter(this.contrast).toString();
},SyntaxElementMorph.prototype.dark=function(){return this.color.darker(this.contrast).toString()},SyntaxElementMorph.prototype.setColor=function(aColor,silently){aColor&&(this.color.eq(aColor)||(this.color=aColor,silently||this.drawNew(),this.children.forEach(function(child){silently&&!(child instanceof TemplateSlotMorph)||child instanceof BlockHighlightMorph||(child.drawNew(),child.changed())}),this.changed()))},SyntaxElementMorph.prototype.setLabelColor=function(textColor,shadowColor,shadowOffset){this.children.forEach(function(morph){morph instanceof StringMorph&&!morph.isProtectedLabel?(morph.shadowOffset=shadowOffset||morph.shadowOffset,morph.shadowColor=shadowColor||morph.shadowColor,
morph.setColor(textColor)):(morph instanceof MultiArgMorph||morph instanceof ArgLabelMorph||morph instanceof SymbolMorph&&!morph.isProtectedLabel||morph instanceof InputSlotMorph&&morph.isReadOnly)&&morph.setLabelColor(textColor,shadowColor,shadowOffset)})},SyntaxElementMorph.prototype.flash=function(){this.cachedNormalColor||(this.cachedNormalColor=this.color,this.setColor(this.activeHighlight))},SyntaxElementMorph.prototype.unflash=function(){if(this.cachedNormalColor){var clr=this.cachedNormalColor;this.cachedNormalColor=null,this.setColor(clr)}},SyntaxElementMorph.prototype.fixBlockColor=function(nearestBlock,isForced){this.children.forEach(function(morph){
morph instanceof SyntaxElementMorph&&morph.fixBlockColor(nearestBlock,isForced)})},SyntaxElementMorph.prototype.labelPart=function(spec){var part,tokens;if("%"===spec[0]&&spec.length>1&&("reportGetVar"!==this.selector||"%turtleOutline"===spec&&this.isObjInputFragment())){if(spec.length>5&&"%mult"===spec.slice(0,5))return part=new MultiArgMorph(spec.slice(5)),part.addInput(),part;switch(spec){case"%imgsource":part=new InputSlotMorph(null,!1,{"pen trails":["pen trails"],"stage image":["stage image"]},!0),part.setContents(["pen trails"]);break;case"%inputs":part=new MultiArgMorph("%s","with inputs"),part.isStatic=!1,part.canBeEmpty=!1;break;case"%scriptVars":part=new MultiArgMorph("%t",null,1,spec),
part.canBeEmpty=!1;break;case"%blockVars":part=new MultiArgMorph("%t","block variables",0,spec),part.canBeEmpty=!1;break;case"%parms":part=new MultiArgMorph("%t","Input Names:",0,spec),part.canBeEmpty=!1;break;case"%ringparms":part=new MultiArgMorph("%t","input names:",0,spec);break;case"%cmdRing":part=new RingMorph,part.color=SpriteMorph.prototype.blockColor.other,part.selector="reifyScript",part.setSpec("%rc %ringparms"),part.isDraggable=!0;break;case"%repRing":part=new RingMorph,part.color=SpriteMorph.prototype.blockColor.other,part.selector="reifyReporter",part.setSpec("%rr %ringparms"),part.isDraggable=!0,part.isStatic=!0;break;case"%predRing":part=new RingMorph(!0),
part.color=SpriteMorph.prototype.blockColor.other,part.selector="reifyPredicate",part.setSpec("%rp %ringparms"),part.isDraggable=!0,part.isStatic=!0;break;case"%words":part=new MultiArgMorph("%s",null,0),part.addInput(),part.addInput(),part.isStatic=!1;break;case"%exp":part=new MultiArgMorph("%s",null,0),part.addInput(),part.isStatic=!0,part.canBeEmpty=!1;break;case"%br":part=new Morph,part.setExtent(new Point(0,0)),part.isBlockLabelBreak=!0,part.getSpec=function(){return"%br"};break;case"%inputName":part=new ReporterBlockMorph,part.category="variables",part.color=SpriteMorph.prototype.blockColor.variables,part.setSpec(localize("Input name"));break;case"%s":part=new InputSlotMorph;
break;case"%anyUE":part=new InputSlotMorph,part.isUnevaluated=!0;break;case"%txt":part=new InputSlotMorph,part.minWidth=1.7*part.height(),part.fixLayout();break;case"%mlt":part=new TextSlotMorph,part.fixLayout();break;case"%code":part=new TextSlotMorph,part.contents().fontName="monospace",part.contents().fontStyle="monospace",part.fixLayout();break;case"%obj":part=new ArgMorph("object");break;case"%n":part=new InputSlotMorph(null,!0);break;case"%dir":part=new InputSlotMorph(null,!0,{"(90) right":90,"(-90) left":-90,"(0) up":"0","(180) down":180}),part.setContents(90);break;case"%note":part=new InputSlotMorph(null,!0,"pianoKeyboardMenu",!1);break;case"%inst":part=new InputSlotMorph(null,!0,{
"(1) sine":1,"(2) square":2,"(3) sawtooth":3,"(4) triangle":4}),part.setContents(1);break;case"%month":part=new InputSlotMorph(null,!1,{January:["January"],February:["February"],March:["March"],April:["April"],May:["May"],June:["June"],July:["July"],August:["August"],September:["September"],October:["October"],November:["November"],December:["December"]},!0);break;case"%interaction":part=new InputSlotMorph(null,!1,{clicked:["clicked"],pressed:["pressed"],dropped:["dropped"],"mouse-entered":["mouse-entered"],"mouse-departed":["mouse-departed"]},!0),part.isStatic=!0;break;case"%dates":part=new InputSlotMorph(null,!1,{year:["year"],month:["month"],date:["date"],
"day of week":["day of week"],hour:["hour"],minute:["minute"],second:["second"],"time in milliseconds":["time in milliseconds"]},!0),part.setContents(["date"]);break;case"%delim":part=new InputSlotMorph(null,!1,{letter:["letter"],whitespace:["whitespace"],line:["line"],tab:["tab"],cr:["cr"],csv:["csv"]},!1);break;case"%ida":part=new InputSlotMorph(null,!0,{1:1,last:["last"],"~":null,all:["all"]}),part.setContents(1);break;case"%idx":part=new InputSlotMorph(null,!0,{1:1,last:["last"],any:["any"]}),part.setContents(1);break;case"%spr":part=new InputSlotMorph(null,!1,"objectsMenu",!0);break;case"%col":part=new InputSlotMorph(null,!1,"collidablesMenu",!0);break;case"%dst":
part=new InputSlotMorph(null,!1,"distancesMenu",!0);break;case"%cln":part=new InputSlotMorph(null,!1,"clonablesMenu",!0);break;case"%get":part=new InputSlotMorph(null,!1,"gettablesMenu",!0),part.isStatic=!0;break;case"%cst":part=new InputSlotMorph(null,!1,"costumesMenu",!0);break;case"%eff":part=new InputSlotMorph(null,!1,{color:["color"],fisheye:["fisheye"],whirl:["whirl"],pixelate:["pixelate"],mosaic:["mosaic"],duplicate:["duplicate"],negative:["negative"],comic:["comic"],confetti:["confetti"],saturation:["saturation"],brightness:["brightness"],ghost:["ghost"]},!0),part.setContents(["ghost"]);break;case"%snd":part=new InputSlotMorph(null,!1,"soundsMenu",!0);
break;case"%key":part=new InputSlotMorph(null,!1,{"any key":["any key"],"up arrow":["up arrow"],"down arrow":["down arrow"],"right arrow":["right arrow"],"left arrow":["left arrow"],space:["space"],a:["a"],b:["b"],c:["c"],d:["d"],e:["e"],f:["f"],g:["g"],h:["h"],i:["i"],j:["j"],k:["k"],l:["l"],m:["m"],n:["n"],o:["o"],p:["p"],q:["q"],r:["r"],s:["s"],t:["t"],u:["u"],v:["v"],w:["w"],x:["x"],y:["y"],z:["z"],0:["0"],1:["1"],2:["2"],3:["3"],4:["4"],5:["5"],6:["6"],7:["7"],8:["8"],9:["9"]},!0),part.setContents(["space"]);break;case"%keyHat":part=this.labelPart("%key"),part.isStatic=!0;break;case"%msg":part=new InputSlotMorph(null,!1,"messagesMenu",!0);break;case"%msgHat":
part=new InputSlotMorph(null,!1,"messagesReceivedMenu",!0),part.isStatic=!0;break;case"%att":part=new InputSlotMorph(null,!1,"attributesMenu",!0);break;case"%fun":part=new InputSlotMorph(null,!1,{abs:["abs"],ceiling:["ceiling"],floor:["floor"],sqrt:["sqrt"],sin:["sin"],cos:["cos"],tan:["tan"],asin:["asin"],acos:["acos"],atan:["atan"],ln:["ln"],log:["log"],"e^":["e^"],"10^":["10^"]},!0),part.setContents(["sqrt"]);break;case"%txtfun":part=new InputSlotMorph(null,!1,{"encode URI":["encode URI"],"decode URI":["decode URI"],"encode URI component":["encode URI component"],"decode URI component":["decode URI component"],"XML escape":["XML escape"],"XML unescape":["XML unescape"],
"hex sha512 hash":["hex sha512 hash"]},!0),part.setContents(["encode URI"]);break;case"%stopChoices":part=new InputSlotMorph(null,!1,{all:["all"],"this script":["this script"],"this block":["this block"],"all but this script":["all but this script"],"other scripts in sprite":["other scripts in sprite"]},!0),part.setContents(["all"]),part.isStatic=!0;break;case"%typ":part=new InputSlotMorph(null,!1,"typesMenu",!0),part.setContents(["number"]);break;case"%mapValue":part=new InputSlotMorph(null,!1,{String:["String"],Number:["Number"],true:["true"],false:["false"]},!0),part.setContents(["String"]),part.isStatic=!0;break;case"%var":part=new InputSlotMorph(null,!1,"getVarNamesDict",!0),
part.isStatic=!0;break;case"%shd":part=new InputSlotMorph(null,!1,"shadowedVariablesMenu",!0);break;case"%lst":part=new InputSlotMorph(null,!1,{list1:"list1",list2:"list2",list3:"list3"},!0);break;case"%codeKind":part=new InputSlotMorph(null,!1,{code:["code"],header:["header"]},!0),part.setContents(["code"]);break;case"%l":part=new ArgMorph("list");break;case"%b":part=new BooleanSlotMorph;break;case"%boolUE":part=new BooleanSlotMorph,part.isUnevaluated=!0;break;case"%bool":part=new BooleanSlotMorph(!0),part.isStatic=!0;break;case"%cmd":part=new CommandSlotMorph;break;case"%rc":part=new RingCommandSlotMorph,part.isStatic=!0;break;case"%rr":part=new RingReporterSlotMorph,
part.isStatic=!0;break;case"%rp":part=new RingReporterSlotMorph(!0),part.isStatic=!0;break;case"%c":part=new CSlotMorph,part.isStatic=!0;break;case"%cs":part=new CSlotMorph;break;case"%cl":part=new CSlotMorph,part.isStatic=!0,part.isLambda=!0;break;case"%clr":part=new ColorSlotMorph,part.isStatic=!0;break;case"%t":part=new TemplateSlotMorph("a");break;case"%upvar":part=new TemplateSlotMorph("↑");break;case"%f":part=new FunctionSlotMorph;break;case"%r":part=new ReporterSlotMorph;break;case"%p":part=new ReporterSlotMorph(!0);break;case"%codeListPart":part=new InputSlotMorph(null,!1,{list:["list"],item:["item"],delimiter:["delimiter"]},!0);break;case"%codeListKind":
part=new InputSlotMorph(null,!1,{collection:["collection"],variables:["variables"],parameters:["parameters"]},!0);break;case"%turtle":part=new SymbolMorph("turtle"),part.size=1.2*this.fontSize,part.color=new Color(255,255,255),part.shadowColor=this.color.darker(this.labelContrast),part.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,part.drawNew();break;case"%turtleOutline":part=new SymbolMorph("turtleOutline"),part.size=this.fontSize,part.color=new Color(255,255,255),part.isProtectedLabel=!0,part.shadowColor=this.color.darker(this.labelContrast),part.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,part.drawNew();break;case"%clockwise":
part=new SymbolMorph("turnRight"),part.size=1.5*this.fontSize,part.color=new Color(255,255,255),part.isProtectedLabel=!1,part.shadowColor=this.color.darker(this.labelContrast),part.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,part.drawNew();break;case"%counterclockwise":part=new SymbolMorph("turnLeft"),part.size=1.5*this.fontSize,part.color=new Color(255,255,255),part.isProtectedLabel=!1,part.shadowColor=this.color.darker(this.labelContrast),part.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,part.drawNew();break;case"%greenflag":part=new SymbolMorph("flag"),part.size=1.5*this.fontSize,part.color=new Color(0,200,0),part.isProtectedLabel=!0,
part.shadowColor=this.color.darker(this.labelContrast),part.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,part.drawNew();break;case"%stop":part=new SymbolMorph("octagon"),part.size=1.5*this.fontSize,part.color=new Color(200,0,0),part.isProtectedLabel=!0,part.shadowColor=this.color.darker(this.labelContrast),part.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,part.drawNew();break;case"%pause":part=new SymbolMorph("pause"),part.size=this.fontSize,part.color=new Color(255,220,0),part.isProtectedLabel=!0,part.shadowColor=this.color.darker(this.labelContrast),part.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,part.drawNew();
break;default:nop()}}else"$"===spec[0]&&spec.length>1&&"reportGetVar"!==this.selector?(tokens=spec.slice(1).split("-"),contains(SymbolMorph.prototype.names,tokens[0])?(part=new SymbolMorph(tokens[0]),part.size=this.fontSize*(+tokens[1]||1.2)):(part=new StringMorph(tokens[0]),part.fontName=this.labelFontName,part.fontStyle=this.labelFontStyle,part.fontSize=this.fontSize*(+tokens[1]||1)),part.color=new Color(0===+tokens[2]?0:+tokens[2]||255,0===+tokens[3]?0:+tokens[3]||255,0===+tokens[4]?0:+tokens[4]||255),part.isProtectedLabel=tokens.length>2,part.shadowColor=this.color.darker(this.labelContrast),part.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,
part.drawNew()):part=new StringMorph(spec,this.fontSize,this.labelFontStyle,!0,!1,!1,MorphicPreferences.isFlat?new Point:this.embossing,this.color.darker(this.labelContrast),new Color(255,255,255),this.labelFontName);return part},SyntaxElementMorph.prototype.isObjInputFragment=function(){return"reportGetVar"===this.selector&&"%t"===this.getSlotSpec()&&"%obj"===this.parent.fragment.type},SyntaxElementMorph.prototype.fixLayout=function(silently){var nb,y,blockHeight,affected,bottomCorrection,parts=this.parts(),myself=this,x=0,lineHeight=0,maxX=0,blockWidth=this.minWidth,l=[],lines=[],space=this.isPrototype?1:Math.floor(fontHeight(this.fontSize)/3),ico=this.isCustomBlock&&!this.isGlobal?this.methodIconExtent().x+space:0,initialExtent=this.extent();
if(blockWidth+=this instanceof MultiArgMorph&&"%c"!==this.slotSpec?this.arrows().width():this instanceof ReporterBlockMorph?2*this.rounding+2*this.edge:4*this.corner+2*this.edge+3*this.inset+this.dent,this.nextBlock&&(nb=this.nextBlock()),parts.forEach(function(part){part instanceof CSlotMorph||"%c"===part.slotSpec?l.length>0?(lines.push(l),lines.push([part]),l=[],x=0):lines.push([part]):part instanceof BlockHighlightMorph?nop():(part.isVisible&&(x+=part.fullBounds().width()+space),(x>myself.labelWidth||part.isBlockLabelBreak)&&l.length>0&&(lines.push(l),l=[],x=part.fullBounds().width()+space),l.push(part),part.isBlockLabelBreak&&(x=0))}),l.length>0&&lines.push(l),
this instanceof CommandBlockMorph?(y=this.top()+this.corner+this.edge,this instanceof HatBlockMorph&&(y+=this.hatHeight)):this instanceof ReporterBlockMorph?y=this.top()+2*this.edge:(this instanceof MultiArgMorph||this instanceof ArgLabelMorph)&&(y=this.top()),lines.forEach(function(line){x=myself.left()+ico+myself.edge+myself.labelPadding,myself instanceof RingMorph?x=myself.left()+space:myself.isPredicate?x=myself.left()+ico+myself.rounding:(myself instanceof MultiArgMorph||myself instanceof ArgLabelMorph)&&(x=myself.left()),y+=lineHeight,lineHeight=0,line.forEach(function(part){part instanceof CSlotMorph?(x-=myself.labelPadding,myself.isPredicate&&(x=myself.left()+ico+myself.rounding),
part.setColor(myself.color),part.setPosition(new Point(x,y)),lineHeight=part.height()):(part.setPosition(new Point(x,y)),part.isBlockLabelBreak||("%c"===part.slotSpec?x+=part.width():part.isVisible&&(x+=part.fullBounds().width()+space)),maxX=Math.max(maxX,x),lineHeight=Math.max(lineHeight,part instanceof StringMorph?part.rawHeight():part.height()))}),line.forEach(function(part){part.moveBy(new Point(0,Math.floor((lineHeight-part.height())/2)))})}),y+=lineHeight,this.children.some(function(any){return any instanceof CSlotMorph})&&(bottomCorrection=this.bottomPadding,this instanceof ReporterBlockMorph&&!this.isPredicate&&(bottomCorrection=Math.max(this.bottomPadding,this.rounding-this.bottomPadding)),
y+=bottomCorrection),this instanceof CommandBlockMorph?blockHeight=y-this.top()+2*this.corner:this instanceof ReporterBlockMorph?blockHeight=y-this.top()+2*this.edge:(this instanceof MultiArgMorph||this instanceof ArgLabelMorph)&&(blockHeight=y-this.top()),this.isPredicate?blockWidth=Math.max(blockWidth,maxX-this.left()+this.rounding):this instanceof MultiArgMorph||this instanceof ArgLabelMorph?blockWidth=Math.max(blockWidth,maxX-this.left()-space):(blockWidth=Math.max(blockWidth,maxX-this.left()+this.labelPadding-this.edge),parts[parts.length-1]instanceof MultiArgMorph&&1===lines.length&&(blockWidth-=space),this instanceof HatBlockMorph&&(blockWidth=Math.max(blockWidth,1.5*this.hatWidth))),
this.silentSetExtent(new Point(blockWidth,blockHeight)),parts.forEach(function(part){part instanceof CSlotMorph&&(myself.isPredicate?part.setWidth(blockWidth-ico-2*myself.rounding):part.setWidth(blockWidth-myself.edge-ico))}),silently||this.drawNew(),nb&&nb.setPosition(new Point(this.left(),this.bottom()-this.corner)),this instanceof CommandBlockMorph){if(this.height()!==initialExtent.y&&(affected=this.parentThatIsA(CommandSlotMorph),affected&&affected.fixLayout()),this.width()!==initialExtent.x&&(affected=this.parentThatIsAnyOf([ReporterBlockMorph,CommandSlotMorph,RingCommandSlotMorph]),affected&&affected.fixLayout()),affected)return}else if(this instanceof ReporterBlockMorph&&this.parent&&this.parent.fixLayout)return this.parent.fixLayout();
this.fixHighlight()},SyntaxElementMorph.prototype.fixHighlight=function(){var top=this.topBlock();top.getHighlight&&top.getHighlight()&&top.addHighlight(top.removeHighlight())},SyntaxElementMorph.prototype.methodIconExtent=function(){var ico=1.2*this.fontSize;return this.isCustomBlock&&!this.isGlobal?new Point(.66*ico,ico):new Point(0,0)},SyntaxElementMorph.prototype.evaluate=function(){return null},SyntaxElementMorph.prototype.isEmptySlot=function(){return!1},SyntaxElementMorph.prototype.showBubble=function(value,exportPic,target){var bubble,txt,img,morphToShow,isClickable=!1,ide=this.parentThatIsA(IDE_Morph),anchor=this,pos=this.rightCenter().add(new Point(2,0)),sf=this.parentThatIsA(ScrollFrameMorph),wrrld=this.world();
return void 0!==value&&wrrld?(value instanceof ListWatcherMorph?(morphToShow=value,morphToShow.update(!0),morphToShow.step=value.update,morphToShow.isDraggable=!1,morphToShow.expand(this.parentThatIsA(ScrollFrameMorph).extent()),isClickable=!0):value instanceof TableFrameMorph?(morphToShow=value,morphToShow.isDraggable=!1,morphToShow.expand(this.parentThatIsA(ScrollFrameMorph).extent()),isClickable=!0):value instanceof Morph?isSnapObject(value)?(img=value.thumbnail(new Point(40,40)),morphToShow=new Morph,morphToShow.silentSetWidth(img.width),morphToShow.silentSetHeight(img.height),morphToShow.image=img,morphToShow.version=value.version,morphToShow.step=function(){
this.version!==value.version&&(img=value.thumbnail(new Point(40,40)),this.image=img,this.version=value.version,this.changed())}):(img=value.fullImage(),morphToShow=new Morph,morphToShow.silentSetWidth(img.width),morphToShow.silentSetHeight(img.height),morphToShow.image=img):value instanceof Costume?(img=value.thumbnail(new Point(40,40)),morphToShow=new Morph,morphToShow.silentSetWidth(img.width),morphToShow.silentSetHeight(img.height),morphToShow.image=img):value instanceof Sound?morphToShow=new SymbolMorph("notes",30):value instanceof Context?(img=value.image(),morphToShow=new Morph,morphToShow.silentSetWidth(img.width),morphToShow.silentSetHeight(img.height),
morphToShow.image=img):"boolean"==typeof value?morphToShow=SpriteMorph.prototype.booleanMorph.call(null,value):isString(value)?(txt=value.length>500?value.slice(0,500)+"...":value,morphToShow=new TextMorph(txt,this.fontSize)):null===value?morphToShow=new TextMorph("",this.fontSize):0===value?morphToShow=new TextMorph("0",this.fontSize):value.toString&&(morphToShow=new TextMorph(value.toString(),this.fontSize)),ide&&ide.currentSprite!==target&&(target instanceof StageMorph?anchor=ide.corral.stageIcon:(target.isTemporary&&(target=detect(target.allExemplars(),function(each){return!each.isTemporary})),anchor=detect(ide.corral.frame.contents.children,function(icon){
return icon.object===target})),pos=anchor.center()),bubble=new SpeechBubbleMorph(morphToShow,null,Math.max(this.rounding-2,6),0),bubble.popUp(wrrld,pos,isClickable),exportPic&&this.exportPictureWithResult(bubble),void(anchor instanceof SpriteIconMorph?bubble.keepWithin(ide.corral):sf&&bubble.keepWithin(sf))):null},SyntaxElementMorph.prototype.exportPictureWithResult=function(aBubble){var ide=this.parentThatIsA(IDE_Morph),scr=this.fullImage(),bub=aBubble.fullImageClassic(),taller=Math.max(0,bub.height-scr.height),pic=newCanvas(new Point(scr.width+bub.width+2,scr.height+taller)),ctx=pic.getContext("2d");ctx.drawImage(scr,0,pic.height-scr.height),ctx.drawImage(bub,scr.width+2,0),
ide.saveCanvasAs(pic,(ide.projectName||localize("untitled"))+" "+localize("script pic"))},SyntaxElementMorph.prototype.mappedCode=function(definitions){var result=this.evaluate();return result instanceof BlockMorph?result.mappedCode(definitions):result},SyntaxElementMorph.prototype.startLayout=function(){this.topBlock().fullChanged(),Morph.prototype.trackChanges=!1},SyntaxElementMorph.prototype.endLayout=function(){Morph.prototype.trackChanges=!0,this.topBlock().fullChanged()},BlockMorph.prototype=new SyntaxElementMorph,BlockMorph.prototype.constructor=BlockMorph,BlockMorph.uber=SyntaxElementMorph.prototype,BlockMorph.prototype.isCachingInputs=!0,BlockMorph.prototype.zebraContrast=40,
BlockMorph.prototype.snapSound=null,BlockMorph.prototype.toggleSnapSound=function(){null!==this.snapSound?this.snapSound=null:(BlockMorph.prototype.snapSound=document.createElement("audio"),BlockMorph.prototype.snapSound.src="click.wav"),CommentMorph.prototype.snapSound=BlockMorph.prototype.snapSound},BlockMorph.prototype.init=function(silently){this.selector=null,this.blockSpec="",this.comment=null,this.instantiationSpec=null,this.category=null,this.isCorpse=!1,BlockMorph.uber.init.call(this,silently),this.color=new Color(0,17,173),this.cachedInputs=null},BlockMorph.prototype.scriptTarget=function(){var ide,scripts=this.parentThatIsA(ScriptsMorph);if(scripts)return scripts.scriptTarget();
if(ide=this.parentThatIsA(IDE_Morph))return ide.currentSprite;throw new Error("script target cannot be found for orphaned block")},BlockMorph.prototype.toString=function(){return"a "+(this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])+' ("'+this.blockSpec.slice(0,30)+'...")'},BlockMorph.prototype.parseSpec=function(spec){function addWord(w){"%"===w[0]&&w.length>1?(""!==word&&(result.push(word),word=""),result.push(w)):""!==word?word+=" "+w:word=w}var words,result=[],word="";return words=isString(spec)?spec.split(" "):[],0===words.length&&(words=[spec]),this.labelWordWrap?words:(words.forEach(function(each){addWord(each)}),""!==word&&result.push(word),
result)},BlockMorph.prototype.setSpec=function(spec,silently,definition){var part,myself=this,inputIdx=-1;spec&&(this.parts().forEach(function(part){part.destroy()}),this.isPrototype&&this.add(this.placeHolder()),this.parseSpec(spec).forEach(function(word){"%"===word[0]&&(inputIdx+=1),part=myself.labelPart(word),isNil(part)||(myself.add(part),part instanceof CommandSlotMorph||part instanceof StringMorph||part.drawNew(),part instanceof RingMorph&&part.fixBlockColor(),(part instanceof MultiArgMorph||part.constructor===CommandSlotMorph||part.constructor===RingCommandSlotMorph)&&part.fixLayout(),myself.isPrototype&&myself.add(myself.placeHolder()),part instanceof InputSlotMorph&&myself.isCustomBlock&&part.setChoices.apply(part,(definition||myself.definition).inputOptionsOfIdx(inputIdx)));
}),this.blockSpec=spec,this.fixLayout(silently),this.cachedInputs=null)},BlockMorph.prototype.userSetSpec=function(spec){var tb=this.topBlock();tb.fullChanged(),this.setSpec(spec),tb.fullChanged()},BlockMorph.prototype.buildSpec=function(){var myself=this;this.blockSpec="",this.parts().forEach(function(part){part instanceof StringMorph?myself.blockSpec+=part.text:part instanceof ArgMorph?myself.blockSpec+=part.getSpec():part.isBlockLabelBreak?myself.blockSpec+=part.getSpec():myself.blockSpec+="[undefined]",myself.blockSpec+=" "}),this.blockSpec=this.blockSpec.trim()},BlockMorph.prototype.rebuild=function(contrast){this.setSpec(this.blockSpec),contrast&&this.inputs().forEach(function(input){
input instanceof ReporterBlockMorph&&(input.setColor(input.color.lighter(contrast)),input.setSpec(input.blockSpec))})},BlockMorph.prototype.userMenu=function(){function addOption(label,toggle,test,onHint,offHint){var on="☑ ",off="☐ ";menu.addItem((test?on:off)+localize(label),toggle,test?onHint:offHint)}function renameVar(){var blck=myself.fullCopy();blck.addShadow(),new DialogBoxMorph(myself,myself.userSetSpec,myself).prompt("Variable name",myself.blockSpec,world,blck.fullImage(),InputSlotMorph.prototype.getVarNamesDict.call(myself))}var alternatives,field,rcvr,top,menu=new MenuMorph(this),world=this.world(),myself=this,shiftClicked=16===world.currentKey,proc=this.activeProcess(),vNames=proc&&proc.context&&proc.context.outerContext?proc.context.outerContext.variables.names():[];
return menu.addItem("help...","showHelp"),shiftClicked&&(top=this.topBlock(),top instanceof ReporterBlockMorph&&menu.addItem("script pic with result...",function(){top.exportResultPic()},"open a new window\nwith a picture of both\nthis script and its result",new Color(100,0,0))),this.isTemplate?(this.parent instanceof SyntaxElementMorph?"reportGetVar"===this.selector&&(menu.addLine(),menu.addItem("rename...",function(){myself.refactorThisVar(!0)},"rename only\nthis reporter"),menu.addItem("rename all...","refactorThisVar","rename all blocks that\naccess this variable")):("reportGetVar"===this.selector?(rcvr=this.scriptTarget(),this.isInheritedVariable(!1)?addOption("inherited",function(){
rcvr.toggleInheritedVariable(myself.blockSpec)},!0,"uncheck to\ndisinherit",null):(this.isInheritedVariable(!0)&&addOption("inherited",function(){rcvr.toggleInheritedVariable(myself.blockSpec)},!1,null,localize("check to inherit\nfrom")+" "+rcvr.exemplar.name),addOption("transient","toggleTransientVariable",myself.isTransientVariable(),"uncheck to save contents\nin the project","check to prevent contents\nfrom being saved"),menu.addLine(),menu.addItem("rename...",function(){myself.refactorThisVar(!0)},"rename only\nthis reporter"),menu.addItem("rename all...","refactorThisVar","rename all blocks that\naccess this variable"))):"evaluateCustomBlock"!==this.selector&&menu.addItem("hide","hidePrimitive"),
StageMorph.prototype.enableInheritance&&(rcvr=this.scriptTarget(),field={xPosition:"x position",yPosition:"y position",direction:"direction",getScale:"size",getCostumeIdx:"costume #"}[this.selector],field&&rcvr&&rcvr.exemplar&&(menu.addLine(),addOption("inherited",function(){rcvr.toggleInheritanceForAttribute(field)},rcvr.inheritsAttribute(field),"uncheck to\ndisinherit",localize("check to inherit\nfrom")+" "+rcvr.exemplar.name))),StageMorph.prototype.enableCodeMapping&&(menu.addLine(),menu.addItem("header mapping...","mapToHeader"),menu.addItem("code mapping...","mapToCode"))),menu):(menu.addLine(),"reportGetVar"===this.selector?menu.addItem("rename...",renameVar,"rename only\nthis reporter"):SpriteMorph.prototype.blockAlternatives[this.selector]?menu.addItem("relabel...",function(){
myself.relabel(SpriteMorph.prototype.blockAlternatives[myself.selector])}):this.isCustomBlock&&this.alternatives&&(alternatives=this.alternatives(),alternatives.length>0&&menu.addItem("relabel...",function(){myself.relabel(alternatives)})),menu.addItem("duplicate",function(){var dup=myself.fullCopy(),ide=myself.parentThatIsA(IDE_Morph),blockEditor=myself.parentThatIsA(BlockEditorMorph);dup.pickUp(world),!ide&&blockEditor&&(ide=blockEditor.target.parentThatIsA(IDE_Morph)),ide&&(world.hand.grabOrigin={origin:ide.palette,position:ide.palette.center()})},"make a copy\nand pick it up"),this instanceof CommandBlockMorph&&this.nextBlock()&&menu.addItem((proc?this.fullCopy():this).thumbnail(.5,60),function(){
var cpy=myself.fullCopy(),nb=cpy.nextBlock(),ide=myself.parentThatIsA(IDE_Morph),blockEditor=myself.parentThatIsA(BlockEditorMorph);nb&&nb.destroy(),cpy.pickUp(world),!ide&&blockEditor&&(ide=blockEditor.target.parentThatIsA(IDE_Morph)),ide&&(world.hand.grabOrigin={origin:ide.palette,position:ide.palette.center()})},"only duplicate this block"),menu.addItem("delete","userDestroy"),menu.addItem("script pic...",function(){var ide=myself.parentThatIsA(IDE_Morph)||myself.parentThatIsA(BlockEditorMorph).target.parentThatIsA(IDE_Morph);ide.saveCanvasAs(myself.topBlock().scriptPic(),(ide.projectName||localize("untitled"))+" "+localize("script pic"))},"open a new window\nwith a picture of this script"),
shiftClicked&&menu.addItem("download script",function(){var ide=myself.parentThatIsA(IDE_Morph),blockEditor=myself.parentThatIsA(BlockEditorMorph);!ide&&blockEditor&&(ide=blockEditor.target.parentThatIsA(IDE_Morph)),ide&&ide.saveXMLAs(ide.serializer.serialize(myself),myself.selector+" script",!1)},"download this script\nas an XML file",new Color(100,0,0)),proc?(vNames.length&&(menu.addLine(),vNames.forEach(function(vn){menu.addItem(vn+"...",function(){proc.doShowVar(vn)})})),proc.homeContext.variables.names().forEach(function(vn){contains(vNames,vn)||menu.addItem(vn+"...",function(){proc.doShowVar(vn)})}),menu):this.parent.parentThatIsA(RingMorph)?(menu.addLine(),
menu.addItem("unringify","unringify"),top=this.topBlock(),!(this instanceof ReporterBlockMorph)&&top instanceof HatBlockMorph||menu.addItem("ringify","ringify"),menu):this.parent instanceof ReporterSlotMorph||this.parent instanceof CommandSlotMorph||this instanceof HatBlockMorph||this instanceof CommandBlockMorph&&this.topBlock()instanceof HatBlockMorph?menu:(menu.addLine(),menu.addItem("ringify","ringify"),StageMorph.prototype.enableCodeMapping&&(menu.addLine(),menu.addItem("header mapping...","mapToHeader"),menu.addItem("code mapping...","mapToCode")),menu))},BlockMorph.prototype.developersMenu=function(){var menu=BlockMorph.uber.developersMenu.call(this);return menu.addLine(),
menu.addItem("delete block","deleteBlock"),menu.addItem("spec...",function(){new DialogBoxMorph(this,this.userSetSpec,this).prompt(menu.title+"\nspec",this.blockSpec,this.world())}),menu},BlockMorph.prototype.hidePrimitive=function(){var dict,cat,ide=this.parentThatIsA(IDE_Morph);ide&&(StageMorph.prototype.hiddenPrimitives[this.selector]=!0,dict={doWarp:"control",reifyScript:"operators",reifyReporter:"operators",reifyPredicate:"operators",doDeclareVariables:"variables"},cat=dict[this.selector]||this.category,"lists"===cat&&(cat="variables"),ide.flushBlocksCache(cat),ide.refreshPalette())},BlockMorph.prototype.isInheritedVariable=function(shadowedOnly){return!!(this.isTemplate&&"reportGetVar"===this.selector&&this.parent instanceof FrameMorph)&&contains(this.scriptTarget().inheritedVariableNames(shadowedOnly),this.blockSpec);
},BlockMorph.prototype.isTransientVariable=function(){var varFrame=this.scriptTarget().variables.silentFind(this.blockSpec);return!!varFrame&&varFrame.vars[this.blockSpec].isTransient},BlockMorph.prototype.toggleTransientVariable=function(){var varFrame=this.scriptTarget().variables.silentFind(this.blockSpec);varFrame&&(varFrame.vars[this.blockSpec].isTransient=!varFrame.vars[this.blockSpec].isTransient)},BlockMorph.prototype.deleteBlock=function(){var tobefixed,isindef,scripts=this.parentThatIsA(ScriptsMorph),nb=this.nextBlock?this.nextBlock():null;scripts&&(nb&&scripts.add(nb),this.inputs().forEach(function(inp){inp instanceof BlockMorph&&scripts.add(inp)})),
this instanceof ReporterBlockMorph&&(this.parent instanceof BlockMorph||this.parent instanceof MultiArgMorph||this.parent instanceof ReporterSlotMorph)?this.parent.revertToDefaultInput(this):this.parent&&this.parent.fixLayout?tobefixed=this.parentThatIsA(ArgMorph):isindef=!0,this.destroy(),isindef&&(this.isCorpse=!0),tobefixed&&tobefixed.fixLayout()},BlockMorph.prototype.ringify=function(){var ring,top,center,target=this.selectForEdit();if(target!==this)return this.ringify.call(target);if(ring=new RingMorph,top=this.topBlock(),center=top.fullBounds().center(),null===this.parent)return null;if(top.fullChanged(),this.parent instanceof SyntaxElementMorph){if(this instanceof ReporterBlockMorph)this.parent.silentReplaceInput(this,ring),
ring.embed(this);else if(top){if(top instanceof HatBlockMorph)return;top.parent.add(ring),ring.embed(top),ring.setCenter(center)}}else this.parent.add(ring),ring.embed(this),ring.setCenter(center);this.fixBlockColor(null,!0),top.fullChanged()},BlockMorph.prototype.unringify=function(){var ring,top,center,scripts,block,target=this.selectForEdit();return target!==this?this.unringify.call(target):(ring=this.parent.parentThatIsA(RingMorph),top=this.topBlock(),scripts=this.parentThatIsA(ScriptsMorph),null===ring?null:(block=ring.contents(),center=ring.center(),top.fullChanged(),ring.parent instanceof SyntaxElementMorph?block instanceof ReporterBlockMorph?ring.parent.silentReplaceInput(ring,block):scripts&&(scripts.add(block),
block.setFullCenter(center),block.moveBy(20),ring.parent.revertToDefaultInput(ring)):(ring.parent.add(block),block.setFullCenter(center),ring.destroy()),this.fixBlockColor(null,!0),void top.fullChanged()))},BlockMorph.prototype.relabel=function(alternativeSelectors){var menu,oldInputs,myself,target=this.selectForEdit();return target!==this?this.relabel.call(target,alternativeSelectors):(menu=new MenuMorph(this),oldInputs=this.inputs(),myself=this,alternativeSelectors.forEach(function(sel){var block=SpriteMorph.prototype.blockForSelector(sel);block.restoreInputs(oldInputs),block.fixBlockColor(null,!0),block.addShadow(new Point(3,3)),menu.addItem(block,function(){
myself.setSelector(sel)})}),void menu.popup(this.world(),this.bottomLeft().subtract(new Point(8,this instanceof CommandBlockMorph?this.corner:0))))},BlockMorph.prototype.setSelector=function(aSelector){var surplus,info,oldInputs=this.inputs(),scripts=this.parentThatIsA(ScriptsMorph);info=SpriteMorph.prototype.blocks[aSelector],this.setCategory(info.category),this.selector=aSelector,this.setSpec(localize(info.spec)),surplus=this.restoreInputs(oldInputs),this.fixLabelColor(),scripts&&surplus.length&&surplus.forEach(function(blk){blk.moveBy(10),scripts.add(blk)})},BlockMorph.prototype.restoreInputs=function(oldInputs){var old,nb,i=0,leftOver=[],myself=this;for(this.inputs().forEach(function(inp){
old=oldInputs[i],old instanceof ReporterBlockMorph?myself.silentReplaceInput(inp,old.fullCopy()):old&&inp instanceof InputSlotMorph?old.contents&&inp.setContents(old.contents().text):old instanceof CSlotMorph&&inp instanceof CSlotMorph&&(nb=old.nestedBlock(),nb&&inp.nestedBlock(nb.fullCopy())),i+=1}),i;i<oldInputs.length;i+=1)old=oldInputs[i],old instanceof ReporterBlockMorph?leftOver.push(old):old instanceof CommandSlotMorph&&(nb=old.nestedBlock(),nb&&leftOver.push(nb));return this.cachedInputs=null,leftOver},BlockMorph.prototype.showHelp=function(){var blockEditor,help,comment,block,ctx,myself=this,ide=this.parentThatIsA(IDE_Morph),pic=new Image,spec=this.isCustomBlock?this.definition.helpSpec():this.selector;
ide||(blockEditor=this.parentThatIsA(BlockEditorMorph),blockEditor&&(ide=blockEditor.target.parentThatIsA(IDE_Morph))),pic.onload=function(){help=newCanvas(new Point(pic.width,pic.height),!0),ctx=help.getContext("2d"),ctx.drawImage(pic,0,0),(new DialogBoxMorph).inform("Help",null,myself.world(),help)},this.isCustomBlock&&this.definition.comment?(block=this.fullCopy(),block.addShadow(),comment=this.definition.comment.fullCopy(),comment.contents.parse(),help="",comment.contents.lines.forEach(function(line){help=help+"\n"+line}),(new DialogBoxMorph).inform("Help",help.substr(1),myself.world(),block.fullImage())):pic.src=ide.resourceURL("help",spec+".png")},BlockMorph.prototype.mapToHeader=function(){
var help,pic,key="reify"===this.selector.substr(0,5)?"reify":this.selector,block=this.codeDefinitionHeader(),myself=this;block.addShadow(new Point(3,3)),pic=block.fullImageClassic(),help=this.isCustomBlock?"Enter code that corresponds to the block's definition. Use the formal parameter\nnames as shown and <body> to reference the definition body's generated text code.":"Enter code that corresponds to the block's definition. Choose your own\nformal parameter names (ignoring the ones shown).",new DialogBoxMorph(this,function(code){"evaluateCustomBlock"===key?myself.definition.codeHeader=code:StageMorph.prototype.codeHeaders[key]=code},this).promptCode("Header mapping","evaluateCustomBlock"===key?this.definition.codeHeader||"":StageMorph.prototype.codeHeaders[key]||"",this.world(),pic,help);
},BlockMorph.prototype.mapToCode=function(){var pic,key="reify"===this.selector.substr(0,5)?"reify":this.selector,block=this.codeMappingHeader(),myself=this;block.addShadow(new Point(3,3)),pic=block.fullImageClassic(),new DialogBoxMorph(this,function(code){"evaluateCustomBlock"===key?myself.definition.codeMapping=code:StageMorph.prototype.codeMappings[key]=code},this).promptCode("Code mapping","evaluateCustomBlock"===key?this.definition.codeMapping||"":StageMorph.prototype.codeMappings[key]||"",this.world(),pic,"Enter code that corresponds to the block's operation (usually a single\nfunction invocation). Use <#n> to reference actual arguments as shown.")},BlockMorph.prototype.mapHeader=function(aString,key){
var sel=key||"reify"===this.selector.substr(0,5)?"reify":this.selector;aString&&(this.isCustomBlock?this.definition.codeHeader=aString:StageMorph.prototype.codeHeaders[sel]=aString)},BlockMorph.prototype.mapCode=function(aString,key){var sel=key||"reify"===this.selector.substr(0,5)?"reify":this.selector;aString&&(this.isCustomBlock?this.definition.codeMapping=aString:StageMorph.prototype.codeMappings[sel]=aString)},BlockMorph.prototype.mappedCode=function(definitions){var code,codeLines,header,headers,headerLines,body,bodyLines,key="reify"===this.selector.substr(0,5)?"reify":this.selector,count=1,defKey=this.isCustomBlock?this.definition.spec:key,defs=definitions||{},parts=[];
return code="reportGetVar"===key?this.blockSpec:this.isCustomBlock?this.definition.codeMapping||"":StageMorph.prototype.codeMappings[key]||"","reportGetVar"===key||defs.hasOwnProperty(defKey)||(defs[defKey]=null,this.isCustomBlock?(header=this.definition.codeHeader||"",header.indexOf("<body")!==-1&&(body="",this.definition.body&&(body=this.definition.body.expression.mappedCode(defs)),bodyLines=body.split("\n"),headerLines=header.split("\n"),headerLines.forEach(function(headerLine,idx){var indent,prefix="";0===headerLine.trimLeft().indexOf("<body")&&(indent=headerLine.indexOf("<body"),prefix=headerLine.slice(0,indent)),headerLines[idx]=headerLine.replace(new RegExp("<body>"),bodyLines.join("\n"+prefix)),
headerLines[idx]=headerLines[idx].replace(new RegExp("<body>","g"),bodyLines.join("\n"))}),header=headerLines.join("\n")),defs[defKey]=header):defs[defKey]=StageMorph.prototype.codeHeaders[defKey]),codeLines=code.split("\n"),this.inputs().forEach(function(input){parts.push(input.mappedCode(defs).toString())}),parts.forEach(function(part){var partLines=part.split("\n"),placeHolder="<#"+count+">",rx=new RegExp(placeHolder,"g");codeLines.forEach(function(codeLine,idx){var indent,prefix="";0===codeLine.trimLeft().indexOf(placeHolder)&&(indent=codeLine.indexOf(placeHolder),prefix=codeLine.slice(0,indent)),codeLines[idx]=codeLine.replace(new RegExp(placeHolder),partLines.join("\n"+prefix)),
codeLines[idx]=codeLines[idx].replace(rx,partLines.join("\n"))}),count+=1}),code=codeLines.join("\n"),this.nextBlock&&this.nextBlock()&&(code+="\n"+this.nextBlock().mappedCode(defs)),!definitions&&(headers=[],Object.keys(defs).forEach(function(each){defs[each]&&headers.push(defs[each])}),headers.length)?headers.join("\n\n")+"\n\n"+code:code},BlockMorph.prototype.codeDefinitionHeader=function(){var block=this.isCustomBlock?new PrototypeHatBlockMorph(this.definition):SpriteMorph.prototype.blockForSelector(this.selector),hat=new HatBlockMorph,count=1;return this.isCustomBlock?block:(block.inputs().forEach(function(input){var part=new TemplateSlotMorph("#"+count);
block.silentReplaceInput(input,part),count+=1}),block.isPrototype=!0,hat.setCategory("control"),hat.setSpec("%s"),hat.silentReplaceInput(hat.inputs()[0],block),"control"===this.category&&hat.alternateBlockColor(),hat)},BlockMorph.prototype.codeMappingHeader=function(){var block=this.isCustomBlock?this.definition.blockInstance():SpriteMorph.prototype.blockForSelector(this.selector),hat=new HatBlockMorph,count=1;return block.inputs().forEach(function(input){var part=new TemplateSlotMorph("<#"+count+">");block.silentReplaceInput(input,part),count+=1}),block.isPrototype=!0,hat.setCategory("control"),hat.setSpec("%s"),hat.silentReplaceInput(hat.inputs()[0],block),
"control"===this.category&&hat.alternateBlockColor(),hat},BlockMorph.prototype.refactorThisVar=function(justTheTemplate){function renameVarTo(newName){this.parent instanceof SyntaxElementMorph?this.parentThatIsA(BlockEditorMorph)?this.doRefactorBlockParameter(oldName,newName,justTheTemplate):this.parentThatIsA(RingMorph)?this.doRefactorRingParameter(oldName,newName,justTheTemplate):this.doRefactorScriptVar(oldName,newName,justTheTemplate):receiver.hasSpriteVariable(oldName)?this.doRefactorSpriteVar(oldName,newName,justTheTemplate):this.doRefactorGlobalVar(oldName,newName,justTheTemplate)}var receiver=this.scriptTarget(),oldName=this.instantiationSpec||this.blockSpec,cpy=this.fullCopy();
cpy.addShadow(),new DialogBoxMorph(this,renameVarTo,this).prompt("Variable name",oldName,this.world(),cpy.fullImage(),InputSlotMorph.prototype.getVarNamesDict.call(this))},BlockMorph.prototype.varExistsError=function(ide,where){ide.inform("Variable exists","A variable with this name already exists "+(where||"in this context")+".")},BlockMorph.prototype.doRefactorBlockParameter=function(oldName,newName,justTheTemplate){var fragMorph=this.parentThatIsA(BlockInputFragmentMorph),fragment=fragMorph.fragment.copy(),definer=fragMorph.parent,editor=this.parentThatIsA(BlockEditorMorph),scripts=editor.body.contents;return definer.anyChild(function(any){return any.blockSpec===newName;
})?void this.varExistsError(editor.target.parentThatIsA(IDE_Morph)):(fragment.labelString=newName,fragMorph.updateBlockLabel(fragment),void(justTheTemplate||scripts.children.forEach(function(script){script.refactorVarInStack(oldName,newName)})))},BlockMorph.prototype.doRefactorRingParameter=function(oldName,newName,justTheTemplate){var ring=this.parentThatIsA(RingMorph),script=ring.contents(),tb=this.topBlock();return contains(ring.inputNames(),newName)?void this.varExistsError(this.parentThatIsA(IDE_Morph)):(tb.fullChanged(),this.setSpec(newName),justTheTemplate?void tb.fullChanged():(script&&script.refactorVarInStack(oldName,newName),void tb.fullChanged()));
},BlockMorph.prototype.doRefactorScriptVar=function(oldName,newName,justTheTemplate){var receiver,ide,definer=this.parentThatIsA(CommandBlockMorph);return definer.definesScriptVariable(newName)?(receiver=this.scriptTarget(),ide=receiver.parentThatIsA(IDE_Morph),void this.varExistsError(ide)):(this.userSetSpec(newName),void(justTheTemplate||definer.refactorVarInStack(oldName,newName,!0)))},BlockMorph.prototype.doRefactorSpriteVar=function(oldName,newName,justTheTemplate){var oldValue,newWatcher,receiver=this.scriptTarget(),ide=receiver.parentThatIsA(IDE_Morph),oldWatcher=receiver.findVariableWatcher(oldName);return receiver.hasSpriteVariable(newName)?void this.varExistsError(ide):isNil(ide.globalVariables.vars[newName])?(oldValue=receiver.variables.getVar(oldName),
receiver.deleteVariable(oldName),receiver.addVariable(newName,!1),receiver.variables.setVar(newName,oldValue),oldWatcher&&oldWatcher.isVisible&&(newWatcher=receiver.toggleVariableWatcher(newName,!1),newWatcher.setPosition(oldWatcher.position())),justTheTemplate||(receiver.refactorVariableInstances(oldName,newName,!1),receiver.customBlocks.forEach(function(eachBlock){eachBlock.body.expression.refactorVarInStack(oldName,newName)})),ide.flushBlocksCache("variables"),void ide.refreshPalette()):void this.varExistsError(ide,"as a global variable")},BlockMorph.prototype.doRefactorGlobalVar=function(oldName,newName,justTheTemplate){var oldValue,newWatcher,receiver=this.scriptTarget(),ide=receiver.parentThatIsA(IDE_Morph),stage=ide?ide.stage:null,oldWatcher=receiver.findVariableWatcher(oldName);
return isNil(ide.globalVariables.vars[newName])?detect(stage.children,function(any){return any instanceof SpriteMorph&&any.hasSpriteVariable(newName)})?void this.varExistsError(ide,"as a sprite local variable"):(oldValue=ide.globalVariables.getVar(oldName),stage.deleteVariable(oldName),stage.addVariable(newName,!0),ide.globalVariables.setVar(newName,oldValue),oldWatcher&&oldWatcher.isVisible&&(newWatcher=receiver.toggleVariableWatcher(newName,!0),newWatcher.setPosition(oldWatcher.position())),justTheTemplate||(stage.refactorVariableInstances(oldName,newName,!0),stage.globalBlocks.forEach(function(eachBlock){eachBlock.body.expression.refactorVarInStack(oldName,newName);
}),stage.forAllChildren(function(child){child instanceof SpriteMorph&&(child.refactorVariableInstances(oldName,newName,!0),child.customBlocks.forEach(function(eachBlock){eachBlock.body.expression.refactorVarInStack(oldName,newName)}))})),ide.flushBlocksCache("variables"),void ide.refreshPalette()):void this.varExistsError(ide)},BlockMorph.prototype.eraseHoles=function(context){var gradient,rightX,myself=this,isRing=this instanceof RingMorph,shift=.5*this.edge,holes=this.parts().filter(function(part){return part.isHole});this.isPredicate&&holes.length>0&&(rightX=this.width()-this.rounding,context.clearRect(rightX,0,this.width(),this.height()),gradient=context.createLinearGradient(rightX-this.edge,0,this.width(),0),
gradient.addColorStop(0,this.color.toString()),gradient.addColorStop(1,this.dark()),context.lineWidth=this.edge,context.lineJoin="round",context.lineCap="round",context.strokeStyle=gradient,context.beginPath(),context.moveTo(rightX-shift,this.edge+shift),context.lineTo(rightX-shift,this.height()-this.edge-shift),context.stroke()),holes.forEach(function(hole){var w=hole.width(),h=Math.floor(hole.height())-2;context.clearRect(hole.bounds.origin.x-myself.bounds.origin.x+1,hole.bounds.origin.y-myself.bounds.origin.y+1,isRing?w-2:w+1,h)})},BlockMorph.prototype.addHighlight=function(oldHighlight){var highlight,isHidden=!this.isVisible;return isHidden&&this.show(),highlight=this.highlight(oldHighlight?oldHighlight.color:this.activeHighlight,this.activeBlur,this.activeBorder),
this.addBack(highlight),this.fullChanged(),isHidden&&this.hide(),highlight},BlockMorph.prototype.addErrorHighlight=function(){var highlight,isHidden=!this.isVisible;return isHidden&&this.show(),this.removeHighlight(),highlight=this.highlight(this.errorHighlight,this.activeBlur,this.activeBorder),this.addBack(highlight),this.fullChanged(),isHidden&&this.hide(),highlight},BlockMorph.prototype.removeHighlight=function(){var highlight=this.getHighlight();return null!==highlight&&(this.fullChanged(),this.removeChild(highlight)),highlight},BlockMorph.prototype.toggleHighlight=function(){this.getHighlight()?this.removeHighlight():this.addHighlight()},BlockMorph.prototype.highlight=function(color,blur,border){
var highlight=new BlockHighlightMorph,fb=this.fullBounds(),edge=useBlurredShadows&&!MorphicPreferences.isFlat?blur:border;return highlight.setExtent(fb.extent().add(2*edge)),highlight.color=color,highlight.image=useBlurredShadows&&!MorphicPreferences.isFlat?this.highlightImageBlurred(color,blur):this.highlightImage(color,border),highlight.setPosition(fb.origin.subtract(new Point(edge,edge))),highlight},BlockMorph.prototype.highlightImage=function(color,border){var fb,img,hi,ctx,out;return fb=this.fullBounds().extent(),img=this.fullImage(),hi=newCanvas(fb.add(2*border)),ctx=hi.getContext("2d"),ctx.drawImage(img,0,0),ctx.drawImage(img,border,0),ctx.drawImage(img,2*border,0),
ctx.drawImage(img,2*border,border),ctx.drawImage(img,2*border,2*border),ctx.drawImage(img,border,2*border),ctx.drawImage(img,0,2*border),ctx.drawImage(img,0,border),ctx.globalCompositeOperation="destination-out",ctx.drawImage(img,border,border),out=newCanvas(fb.add(2*border)),ctx=out.getContext("2d"),ctx.drawImage(hi,0,0),ctx.globalCompositeOperation="source-atop",ctx.fillStyle=color.toString(),ctx.fillRect(0,0,out.width,out.height),out},BlockMorph.prototype.highlightImageBlurred=function(color,blur){var fb,img,hi,ctx;return fb=this.fullBounds().extent(),img=this.fullImage(),hi=newCanvas(fb.add(2*blur)),ctx=hi.getContext("2d"),ctx.shadowBlur=blur,ctx.shadowColor=color.toString(),
ctx.drawImage(img,blur,blur),ctx.shadowBlur=0,ctx.globalCompositeOperation="destination-out",ctx.drawImage(img,blur,blur),hi},BlockMorph.prototype.getHighlight=function(){var highlights;return highlights=this.children.slice(0).reverse().filter(function(child){return child instanceof BlockHighlightMorph}),0!==highlights.length?highlights[0]:null},BlockMorph.prototype.outline=function(color,border){var highlight=new BlockHighlightMorph,fb=this.fullBounds(),edge=border;return highlight.setExtent(fb.extent().add(2*edge)),highlight.color=color,highlight.image=this.highlightImage(color,border),highlight.setPosition(fb.origin.subtract(new Point(edge,edge))),highlight;
},BlockMorph.prototype.fixBlockColor=function(nearestBlock,isForced){var clr,cslot,nearest=nearestBlock;if(this.zebraContrast||isForced){if(!this.zebraContrast&&isForced)return this.forceNormalColoring(!0);nearest||this.parent&&(this.isPrototype?nearest=null:this instanceof ReporterBlockMorph?nearest=this.parent.parentThatIsA(BlockMorph):(cslot=this.parentThatIsA(CommandSlotMorph),cslot&&(nearest=cslot.parentThatIsA(BlockMorph)))),nearest?nearest.category===this.category?nearest.color.eq(this.color)&&this.alternateBlockColor():this.category&&!this.color.eq(SpriteMorph.prototype.blockColor[this.category])&&this.alternateBlockColor():(clr=SpriteMorph.prototype.blockColor[this.category],
this.color.eq(clr)||this.alternateBlockColor()),isForced&&this.fixChildrensBlockColor(!0)}},BlockMorph.prototype.forceNormalColoring=function(silently){var clr=SpriteMorph.prototype.blockColor[this.category];this.setColor(clr,silently),this.setLabelColor(new Color(255,255,255),clr.darker(this.labelContrast),new Point(-1,-1)),this.fixChildrensBlockColor(!0)},BlockMorph.prototype.alternateBlockColor=function(){var clr=SpriteMorph.prototype.blockColor[this.category];this.color.eq(clr)?this.setColor(this.zebraContrast<0?clr.darker(Math.abs(this.zebraContrast)):clr.lighter(this.zebraContrast),this.hasLabels()):this.setColor(clr,this.hasLabels()),this.fixLabelColor(),
this.fixChildrensBlockColor(!0)},BlockMorph.prototype.ghost=function(){this.setColor(SpriteMorph.prototype.blockColor[this.category].lighter(35))},BlockMorph.prototype.fixLabelColor=function(){if(this.zebraContrast>0&&this.category){var clr=SpriteMorph.prototype.blockColor[this.category];this.color.eq(clr)?this.setLabelColor(new Color(255,255,255),clr.darker(this.labelContrast),MorphicPreferences.isFlat?null:new Point(-1,-1)):this.setLabelColor(new Color(0,0,0),clr.lighter(this.zebraContrast).lighter(2*this.labelContrast),MorphicPreferences.isFlat?null:new Point(1,1))}},BlockMorph.prototype.fixChildrensBlockColor=function(isForced){var myself=this;this.children.forEach(function(morph){
morph instanceof CommandBlockMorph?morph.fixBlockColor(null,isForced):morph instanceof SyntaxElementMorph&&(morph.fixBlockColor(myself,isForced),morph instanceof BooleanSlotMorph&&morph.drawNew())})},BlockMorph.prototype.setCategory=function(aString){this.category=aString,this.startLayout(),this.fixBlockColor(),this.endLayout()},BlockMorph.prototype.hasLabels=function(){return this.children.some(function(any){return any instanceof StringMorph})},BlockMorph.prototype.fullCopy=function(){var ans=BlockMorph.uber.fullCopy.call(this);return ans.removeHighlight(),ans.isDraggable=!0,this.instantiationSpec&&ans.setSpec(this.instantiationSpec),ans.allChildren().filter(function(block){
return block instanceof SyntaxElementMorph&&(block.cachedInputs=null,block.isCustomBlock&&block.initializeVariables()),!isNil(block.comment)}).forEach(function(block){var cmnt=block.comment.fullCopy();block.comment=cmnt,cmnt.block=block}),ans.cachedInputs=null,ans},BlockMorph.prototype.reactToTemplateCopy=function(){this.forceNormalColoring()},BlockMorph.prototype.hasBlockVars=function(){return this.anyChild(function(any){return any.isCustomBlock&&any.isGlobal&&any.definition.variableNames.length})},BlockMorph.prototype.mouseClickLeft=function(){var stage,top=this.topBlock(),receiver=top.scriptTarget(),shiftClicked=16===this.world().currentKey;return shiftClicked&&!this.isTemplate?this.selectForEdit().focus():top instanceof PrototypeHatBlockMorph?top.mouseClickLeft():void(receiver&&(stage=receiver.parentThatIsA(StageMorph),
stage&&stage.threads.toggleProcess(top,receiver)))},BlockMorph.prototype.focus=function(){var focus,scripts=this.parentThatIsA(ScriptsMorph),world=this.world();scripts&&ScriptsMorph.prototype.enableKeyboard&&(scripts.focus&&scripts.focus.stopEditing(),world.stopEditing(),focus=new ScriptFocusMorph(scripts,this),scripts.focus=focus,focus.getFocus(world),this instanceof HatBlockMorph&&focus.nextCommand())},BlockMorph.prototype.activeProcess=function(){var stage,top=this.topBlock(),receiver=top.scriptTarget();return top instanceof PrototypeHatBlockMorph?null:receiver&&(stage=receiver.parentThatIsA(StageMorph))?stage.threads.findProcess(top,receiver):null},BlockMorph.prototype.thumbnail=function(scale,clipWidth){
var ext,trgt,ctx,gradient,nb=this.nextBlock(),fadeout=12;return nb&&(nb.isVisible=!1),ext=this.fullBounds().extent(),trgt=newCanvas(new Point(clipWidth?Math.min(ext.x*scale,clipWidth):ext.x*scale,ext.y*scale)),ctx=trgt.getContext("2d"),ctx.scale(scale,scale),ctx.drawImage(this.fullImage(),0,0),clipWidth&&ext.x*scale>clipWidth&&(gradient=ctx.createLinearGradient(trgt.width/scale-fadeout,0,trgt.width/scale,0),gradient.addColorStop(0,"transparent"),gradient.addColorStop(1,"black"),ctx.globalCompositeOperation="destination-out",ctx.fillStyle=gradient,ctx.fillRect(trgt.width/scale-fadeout,0,trgt.width/scale,trgt.height/scale)),nb&&(nb.isVisible=!0),trgt},BlockMorph.prototype.scriptPic=function(){
var scr=this.fullImage(),fb=this.stackFullBounds(),pic=newCanvas(fb.extent()),ctx=pic.getContext("2d");return this.allComments().forEach(function(comment){ctx.drawImage(comment.fullImageClassic(),comment.fullBounds().left()-fb.left(),comment.top()-fb.top())}),ctx.drawImage(scr,0,0),pic},BlockMorph.prototype.drawMethodIcon=function(context){var ext=this.methodIconExtent(),w=ext.x,h=ext.y,r=w/2,x=this.edge+this.labelPadding,y=this.edge,isNormal=this.color===SpriteMorph.prototype.blockColor[this.category];this.isPredicate&&(x=this.rounding),this instanceof CommandBlockMorph&&(y+=this.corner),context.fillStyle=isNormal?this.cachedClrBright:this.cachedClrDark,context.beginPath(),
context.arc(x+r,y+r,r,radians(-210),radians(30),!1),context.lineTo(x+r,y+h),context.closePath(),context.fill(),context.fillStyle=this.cachedClr,context.beginPath(),context.arc(x+r,y+r,.4*r,radians(0),radians(360),!1),context.closePath(),context.fill()},BlockMorph.prototype.rootForGrab=function(){return this},BlockMorph.prototype.wantsDropOf=function(aMorph){return(aMorph instanceof ArgMorph||aMorph instanceof StringMorph||aMorph instanceof TextMorph)&&!this.isTemplate},BlockMorph.prototype.reactToDropOf=function(droppedMorph){droppedMorph.isDraggable=!1,droppedMorph instanceof InputSlotMorph?droppedMorph.drawNew():droppedMorph instanceof MultiArgMorph&&droppedMorph.fixLayout(),
this.fixLayout(),this.buildSpec()},BlockMorph.prototype.situation=function(){if(!(this.parent instanceof TemplateSlotMorph)){var scripts=this.parentThatIsA(ScriptsMorph);if(scripts)return{origin:scripts,position:this.position().subtract(scripts.position())}}return BlockMorph.uber.situation.call(this)},BlockMorph.prototype.prepareToBeGrabbed=function(hand){var myself=this;this.allComments().forEach(function(comment){comment.startFollowing(myself,hand.world)})},BlockMorph.prototype.justDropped=function(){this.alpha=1,this.allComments().forEach(function(comment){comment.stopFollowing()})},BlockMorph.prototype.allComments=function(){return this.allChildren().filter(function(block){
return!isNil(block.comment)}).map(function(block){return block.comment})},BlockMorph.prototype.destroy=function(justThis){justThis?isNil(this.comment)||this.comment.destroy():this.allComments().forEach(function(comment){comment.destroy()}),BlockMorph.uber.destroy.call(this)},BlockMorph.prototype.stackHeight=function(){var fb=this.fullBounds(),commentsBottom=Math.max(this.allComments().map(function(comment){return comment.bottom()}))||this.bottom();return Math.max(fb.bottom(),commentsBottom)-fb.top()},BlockMorph.prototype.stackFullBounds=function(){var fb=this.fullBounds();return this.allComments().forEach(function(comment){fb.mergeWith(comment.bounds)}),fb},BlockMorph.prototype.stackWidth=function(){
var fb=this.fullBounds(),commentsRight=Math.max(this.allComments().map(function(comment){return comment.right()}))||this.right();return Math.max(fb.right(),commentsRight)-fb.left()},BlockMorph.prototype.snap=function(){var receiver,stage,ide,top=this.topBlock();top.allComments().forEach(function(comment){comment.align(top)}),this.getHighlight()&&this!==top&&this.removeHighlight(),top.getHighlight()&&top.addHighlight(top.removeHighlight()),"receiveCondition"===this.selector&&(receiver=top.scriptTarget(),receiver&&(stage=receiver.parentThatIsA(StageMorph),stage&&(stage.enableCustomHatBlocks=!0,stage.threads.pauseCustomHatBlocks=!1,ide=stage.parentThatIsA(IDE_Morph),
ide&&ide.controlBar.stopButton.refresh())))},CommandBlockMorph.prototype=new BlockMorph,CommandBlockMorph.prototype.constructor=CommandBlockMorph,CommandBlockMorph.uber=BlockMorph.prototype,CommandBlockMorph.prototype.init=function(silently){CommandBlockMorph.uber.init.call(this,silently),this.setExtent(new Point(200,100),silently),this.partOfCustomCommand=!1,this.exitTag=null},CommandBlockMorph.prototype.blockSequence=function(){var nb=this.nextBlock(),result=[this];return nb&&(result=result.concat(nb.blockSequence())),result},CommandBlockMorph.prototype.bottomBlock=function(){return this.nextBlock()?this.nextBlock().bottomBlock():this},CommandBlockMorph.prototype.nextBlock=function(block){
if(!block)return detect(this.children,function(child){return child instanceof CommandBlockMorph&&!child.isPrototype});var nb=this.nextBlock(),affected=this.parentThatIsA(CommandSlotMorph);this.add(block),nb&&block.bottomBlock().nextBlock(nb),block.setPosition(new Point(this.left(),this.bottom()-this.corner)),affected&&affected.fixLayout()},CommandBlockMorph.prototype.topAttachPoint=function(){return new Point(this.dentCenter(),this.top())},CommandBlockMorph.prototype.bottomAttachPoint=function(){return new Point(this.dentCenter(),this.bottom())},CommandBlockMorph.prototype.wrapAttachPoint=function(){var cslot=detect(this.inputs(),function(each){return each instanceof CSlotMorph;
});return cslot&&!cslot.nestedBlock()?new Point(cslot.left()+2*cslot.inset+cslot.corner,cslot.top()+2*cslot.corner):null},CommandBlockMorph.prototype.dentLeft=function(){return this.left()+this.corner+this.inset},CommandBlockMorph.prototype.dentCenter=function(){return this.dentLeft()+this.corner+.5*this.dent},CommandBlockMorph.prototype.attachTargets=function(){var tp,answer=[];return this instanceof HatBlockMorph||(tp=this.topAttachPoint(),this.parent instanceof SyntaxElementMorph||answer.push({point:tp,element:this,loc:"top",type:"block"}),!ScriptsMorph.prototype.enableNestedAutoWrapping&&this.parentThatIsA(CommandSlotMorph)||answer.push({point:tp,element:this,
loc:"wrap",type:"block"})),this.isStop()||answer.push({point:this.bottomAttachPoint(),element:this,loc:"bottom",type:"block"}),answer},CommandBlockMorph.prototype.allAttachTargets=function(newParent){var topBlocks,myself=this,target=newParent||this.parent,answer=[];return this instanceof HatBlockMorph&&newParent.rejectsHats?answer:(topBlocks=target.children.filter(function(child){return child!==myself&&child instanceof SyntaxElementMorph&&!child.isTemplate}),topBlocks.forEach(function(block){block.forAllChildren(function(child){child.attachTargets&&child.attachTargets().forEach(function(at){answer.push(at)})})}),answer)},CommandBlockMorph.prototype.closestAttachTarget=function(newParent){
var dist,wrap,target=newParent||this.parent,bottomBlock=this.bottomBlock(),answer=null,thresh=Math.max(2*this.corner+this.dent,this.minSnapDistance),ref=[],minDist=1e3;return this instanceof HatBlockMorph||(ref.push({point:this.topAttachPoint(),loc:"top"}),wrap=this.wrapAttachPoint(),wrap&&ref.push({point:wrap,loc:"wrap"})),bottomBlock.isStop()||ref.push({point:bottomBlock.bottomAttachPoint(),loc:"bottom"}),this.allAttachTargets(target).forEach(function(eachTarget){ref.forEach(function(eachRef){("wrap"===eachRef.loc&&"wrap"===eachTarget.loc||eachRef.loc!==eachTarget.loc&&"wrap"!==eachRef.loc&&"wrap"!==eachTarget.loc)&&(dist=eachRef.point.distanceTo(eachTarget.point),
dist<thresh&&dist<minDist&&(minDist=dist,answer=eachTarget))})}),answer},CommandBlockMorph.prototype.snap=function(hand){var before,next,offsetY,cslot,affected,target=this.closestAttachTarget(),scripts=this.parentThatIsA(ScriptsMorph);return scripts.clearDropInfo(),scripts.lastDroppedBlock=this,null===target?(this.startLayout(),this.fixBlockColor(),this.endLayout(),CommandBlockMorph.uber.snap.call(this),void(hand&&scripts.recordDrop(hand.grabOrigin))):(scripts.lastDropTarget=target,this.startLayout(),"bottom"===target.loc?("slot"===target.type?(this.removeHighlight(),scripts.lastNextBlock=target.element.nestedBlock(),target.element.nestedBlock(this)):(scripts.lastNextBlock=target.element.nextBlock(),
target.element.nextBlock(this)),this.isStop()&&(next=this.nextBlock(),next&&(scripts.add(next),next.moveBy(this.extent().floorDivideBy(2)),affected=this.parentThatIsA(CommandSlotMorph),affected&&affected.fixLayout()))):"top"===target.loc?(target.element.removeHighlight(),offsetY=this.bottomBlock().bottom()-this.bottom(),this.setBottom(target.element.top()+this.corner-offsetY),this.setLeft(target.element.left()),this.bottomBlock().nextBlock(target.element)):"wrap"===target.loc&&(cslot=detect(this.inputs(),function(each){return each instanceof CSlotMorph}),before=target.element.parent,scripts.lastWrapParent=before,this.moveBy(target.point.subtract(cslot.slotAttachPoint())),
cslot.nestedBlock(target.element),before instanceof CommandBlockMorph?before.nextBlock(this):before instanceof CommandSlotMorph&&before.nestedBlock(this),target.element.blockSequence().forEach(function(cmd){cmd.fixBlockColor()})),this.fixBlockColor(),this.endLayout(),CommandBlockMorph.uber.snap.call(this),hand&&scripts.recordDrop(hand.grabOrigin),void(this.snapSound&&this.snapSound.play()))},CommandBlockMorph.prototype.isStop=function(){return["doStopThis","doStop","doStopBlock","doStopAll","doForever","doReport","removeClone"].indexOf(this.selector)>-1},CommandBlockMorph.prototype.userDestroy=function(){var target=this.selectForEdit();if(target!==this)return this.userDestroy.call(target);
if(this.nextBlock())return void this.userDestroyJustThis();var scripts=this.parentThatIsA(ScriptsMorph),ide=this.parentThatIsA(IDE_Morph),parent=this.parentThatIsA(SyntaxElementMorph),cslot=this.parentThatIsA(CSlotMorph);scripts&&(scripts.clearDropInfo(),scripts.lastDroppedBlock=this,scripts.recordDrop(this.situation()),scripts.dropRecord.action="delete"),ide?ide.removeBlock(this):this.destroy(),cslot&&cslot.fixLayout(),parent&&parent.reactToGrabOf(this)},CommandBlockMorph.prototype.userDestroyJustThis=function(){var pb,above,scripts=this.parentThatIsA(ScriptsMorph),ide=this.parentThatIsA(IDE_Morph),cs=this.parentThatIsA(CommandSlotMorph),nb=this.nextBlock(),parent=this.parentThatIsA(SyntaxElementMorph),cslot=this.parentThatIsA(CSlotMorph);
scripts&&(scripts.clearDropInfo(),scripts.lastDroppedBlock=this,scripts.recordDrop(this.situation()),scripts.dropRecord.lastNextBlock=nb,scripts.dropRecord.action="delete"),this.topBlock().fullChanged(),this.parent&&(pb=this.parent.parentThatIsA(CommandBlockMorph)),pb&&pb.nextBlock()===this?above=pb:cs&&cs.nestedBlock()===this&&(above=cs),ide?ide.removeBlock(this,!0):this.destroy(!0),nb?above instanceof CommandSlotMorph?above.nestedBlock(nb):above instanceof CommandBlockMorph?above.nextBlock(nb):scripts.add(nb):cslot&&cslot.fixLayout(),parent&&parent.reactToGrabOf(this)},CommandBlockMorph.prototype.drawNew=function(){var context;this.cachedClr=this.color.toString(),
this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),context=this.image.getContext("2d"),context.fillStyle=this.cachedClr,this.drawTop(context),this.drawBody(context),this.drawBottom(context),MorphicPreferences.isFlat?nop():(this.drawTopDentEdge(context,0,0),this.drawBottomDentEdge(context,0,this.height()-this.corner),this.drawLeftEdge(context),this.drawRightEdge(context),this.drawTopLeftEdge(context),this.drawBottomRightEdge(context)),this.isCustomBlock&&!this.isGlobal&&this.drawMethodIcon(context),this.eraseHoles(context)},CommandBlockMorph.prototype.drawBody=function(context){context.fillRect(0,Math.floor(this.corner),this.width(),this.height()-Math.floor(3*this.corner)+1);
},CommandBlockMorph.prototype.drawTop=function(context){context.beginPath(),context.arc(this.corner,this.corner,this.corner,radians(-180),radians(-90),!1),this.drawDent(context,0,0),context.arc(this.width()-this.corner,this.corner,this.corner,radians(-90),radians(-0),!1),context.closePath(),context.fill()},CommandBlockMorph.prototype.drawBottom=function(context){var y=this.height()-2*this.corner;context.beginPath(),context.arc(this.corner,y,this.corner,radians(180),radians(90),!0),this.isStop()||this.drawDent(context,0,this.height()-this.corner),context.arc(this.width()-this.corner,y,this.corner,radians(90),radians(0),!0),context.closePath(),context.fill()},CommandBlockMorph.prototype.drawDent=function(context,x,y){
var indent=x+2*this.corner+this.inset;context.lineTo(x+this.corner+this.inset,y),context.lineTo(indent,y+this.corner),context.lineTo(indent+this.dent,y+this.corner),context.lineTo(x+3*this.corner+this.inset+this.dent,y),context.lineTo(this.width()-this.corner,y)},CommandBlockMorph.prototype.drawTopDentEdge=function(context,x,y){var upperGradient,lowerGradient,leftGradient,lgx,shift=.5*this.edge,indent=x+2*this.corner+this.inset;context.lineWidth=this.edge,context.lineJoin="round",context.lineCap="round",upperGradient=context.createLinearGradient(0,y,0,y+this.edge),upperGradient.addColorStop(0,this.cachedClrBright),upperGradient.addColorStop(1,this.cachedClr),
context.strokeStyle=upperGradient,context.beginPath(),context.moveTo(this.corner,y+shift),context.lineTo(x+this.corner+this.inset,y+shift),context.stroke(),context.strokeStyle=upperGradient,context.beginPath(),context.moveTo(x+3*this.corner+this.inset+this.dent+shift,y+shift),context.lineTo(this.width()-this.corner,y+shift),context.stroke(),lgx=x+this.corner+this.inset,leftGradient=context.createLinearGradient(lgx-this.edge,y+this.edge,lgx,y),leftGradient.addColorStop(0,this.cachedClr),leftGradient.addColorStop(1,this.cachedClrBright),context.strokeStyle=leftGradient,context.beginPath(),context.moveTo(x+this.corner+this.inset,y+shift),context.lineTo(indent,y+this.corner+shift),
context.stroke(),lowerGradient=context.createLinearGradient(0,y+this.corner,0,y+this.corner+this.edge),lowerGradient.addColorStop(0,this.cachedClrBright),lowerGradient.addColorStop(1,this.cachedClr),context.strokeStyle=lowerGradient,context.beginPath(),context.moveTo(indent,y+this.corner+shift),context.lineTo(indent+this.dent,y+this.corner+shift),context.stroke()},CommandBlockMorph.prototype.drawBottomDentEdge=function(context,x,y){var upperGradient,lowerGradient,rightGradient,shift=.5*this.edge,indent=x+2*this.corner+this.inset;return context.lineWidth=this.edge,context.lineJoin="round",context.lineCap="round",upperGradient=context.createLinearGradient(0,y-this.edge,0,y),
upperGradient.addColorStop(0,this.cachedClr),upperGradient.addColorStop(1,this.cachedClrDark),context.strokeStyle=upperGradient,context.beginPath(),context.moveTo(this.corner,y-shift),this.isStop()?context.lineTo(this.width()-this.corner,y-shift):context.lineTo(x+this.corner+this.inset-shift,y-shift),context.stroke(),this.isStop()?null:(lowerGradient=context.createLinearGradient(0,y+this.corner-this.edge,0,y+this.corner),lowerGradient.addColorStop(0,this.cachedClr),lowerGradient.addColorStop(1,this.cachedClrDark),context.strokeStyle=lowerGradient,context.beginPath(),context.moveTo(indent+shift,y+this.corner-shift),context.lineTo(indent+this.dent,y+this.corner-shift),
context.stroke(),rightGradient=context.createLinearGradient(x+indent+this.dent-this.edge,y+this.corner-this.edge,x+indent+this.dent,y+this.corner),rightGradient.addColorStop(0,this.cachedClr),rightGradient.addColorStop(1,this.cachedClrDark),context.strokeStyle=rightGradient,context.beginPath(),context.moveTo(x+indent+this.dent,y+this.corner-shift),context.lineTo(x+3*this.corner+this.inset+this.dent,y-shift),context.stroke(),context.strokeStyle=upperGradient,context.beginPath(),context.moveTo(x+3*this.corner+this.inset+this.dent,y-shift),context.lineTo(this.width()-this.corner,y-shift),void context.stroke())},CommandBlockMorph.prototype.drawFlatBottomDentEdge=function(context){
this.isStop()||(context.fillStyle=this.color.darker(this.contrast/2).toString(),context.beginPath(),this.drawDent(context,0,this.height()-this.corner),context.closePath(),context.fill())},CommandBlockMorph.prototype.drawLeftEdge=function(context){var shift=.5*this.edge,gradient=context.createLinearGradient(0,0,this.edge,0);gradient.addColorStop(0,this.cachedClrBright),gradient.addColorStop(1,this.cachedClr),context.lineWidth=this.edge,context.lineJoin="round",context.lineCap="round",context.strokeStyle=gradient,context.beginPath(),context.moveTo(shift,this.corner),context.lineTo(shift,this.height()-2*this.corner-shift),context.stroke()},CommandBlockMorph.prototype.drawRightEdge=function(context){
var gradient,shift=.5*this.edge,x=this.width();gradient=context.createLinearGradient(x-this.edge,0,x,0),gradient.addColorStop(0,this.cachedClr),gradient.addColorStop(1,this.cachedClrDark),context.lineWidth=this.edge,context.lineJoin="round",context.lineCap="round",context.strokeStyle=gradient,context.beginPath(),context.moveTo(x-shift,this.corner+shift),context.lineTo(x-shift,this.height()-2*this.corner),context.stroke()},CommandBlockMorph.prototype.drawTopLeftEdge=function(context){var gradient,shift=.5*this.edge;gradient=context.createRadialGradient(this.corner,this.corner,this.corner,this.corner,this.corner,this.corner-this.edge),gradient.addColorStop(0,this.cachedClrBright),
gradient.addColorStop(1,this.cachedClr),context.lineWidth=this.edge,context.lineJoin="round",context.lineCap="round",context.strokeStyle=gradient,context.beginPath(),context.arc(this.corner,this.corner,this.corner-shift,radians(-180),radians(-90),!1),context.stroke()},CommandBlockMorph.prototype.drawBottomRightEdge=function(context){var gradient,shift=.5*this.edge,x=this.width()-this.corner,y=this.height()-2*this.corner;gradient=context.createRadialGradient(x,y,this.corner,x,y,this.corner-this.edge),gradient.addColorStop(0,this.cachedClrDark),gradient.addColorStop(1,this.cachedClr),context.lineWidth=this.edge,context.lineJoin="round",context.lineCap="round",context.strokeStyle=gradient,
context.beginPath(),context.arc(x,y,this.corner-shift,radians(90),radians(0),!0),context.stroke()},HatBlockMorph.prototype=new CommandBlockMorph,HatBlockMorph.prototype.constructor=HatBlockMorph,HatBlockMorph.uber=CommandBlockMorph.prototype,HatBlockMorph.prototype.init=function(){HatBlockMorph.uber.init.call(this,!0),this.setExtent(new Point(300,150))},HatBlockMorph.prototype.blockSequence=function(){var result=HatBlockMorph.uber.blockSequence.call(this);return result.shift(),result},HatBlockMorph.prototype.drawTop=function(context){var s=this.hatWidth,h=this.hatHeight,r=(4*h*h+s*s)/(8*h),a=degrees(4*Math.atan(2*h/s)),sa=a/2,sp=Math.min(1.7*s,this.width()-this.corner);
context.beginPath(),context.moveTo(0,h+this.corner),context.arc(s/2,r,r,radians(-sa-90),radians(-90),!1),context.bezierCurveTo(s,0,s,h,sp,h),context.arc(this.width()-this.corner,h+this.corner,this.corner,radians(-90),radians(-0),!1),context.closePath(),context.fill()},HatBlockMorph.prototype.drawBody=function(context){context.fillRect(0,this.hatHeight+Math.floor(this.corner)-1,this.width(),this.height()-Math.floor(3*this.corner)-this.hatHeight+2)},HatBlockMorph.prototype.drawLeftEdge=function(context){var shift=.5*this.edge,gradient=context.createLinearGradient(0,0,this.edge,0);gradient.addColorStop(0,this.cachedClrBright),gradient.addColorStop(1,this.cachedClr),
context.lineWidth=this.edge,context.lineJoin="round",context.lineCap="round",context.strokeStyle=gradient,context.beginPath(),context.moveTo(shift,this.hatHeight+shift),context.lineTo(shift,this.height()-2*this.corner-shift),context.stroke()},HatBlockMorph.prototype.drawRightEdge=function(context){var gradient,shift=.5*this.edge,x=this.width();gradient=context.createLinearGradient(x-this.edge,0,x,0),gradient.addColorStop(0,this.cachedClr),gradient.addColorStop(1,this.cachedClrDark),context.lineWidth=this.edge,context.lineJoin="round",context.lineCap="round",context.strokeStyle=gradient,context.beginPath(),context.moveTo(x-shift,this.corner+this.hatHeight+shift),
context.lineTo(x-shift,this.height()-2*this.corner),context.stroke()},HatBlockMorph.prototype.drawTopDentEdge=function(){return null},HatBlockMorph.prototype.drawTopLeftEdge=function(context){var gradient,shift=.5*this.edge,s=this.hatWidth,h=this.hatHeight,r=(4*h*h+s*s)/(8*h),a=degrees(4*Math.atan(2*h/s)),sa=a/2,sp=Math.min(1.7*s,this.width()-this.corner);gradient=context.createRadialGradient(s/2,r,r-this.edge,s/2,r,r),gradient.addColorStop(1,this.cachedClrBright),gradient.addColorStop(0,this.cachedClr),context.lineWidth=this.edge,context.lineJoin="round",context.lineCap="round",context.strokeStyle=gradient,context.beginPath(),context.arc(Math.round(s/2),r,r-shift,radians(-sa-90),radians(-90),!1),
context.moveTo(s/2,shift),context.bezierCurveTo(s,shift,s,h+shift,sp,h+shift),context.lineTo(this.width()-this.corner,h+shift),context.stroke()},ReporterBlockMorph.prototype=new BlockMorph,ReporterBlockMorph.prototype.constructor=ReporterBlockMorph,ReporterBlockMorph.uber=BlockMorph.prototype,ReporterBlockMorph.prototype.init=function(isPredicate,silently){ReporterBlockMorph.uber.init.call(this,silently),this.isPredicate=isPredicate||!1,this.setExtent(new Point(200,80),silently),this.cachedSlotSpec=null},ReporterBlockMorph.prototype.snap=function(hand){var nb,target,scripts=this.parent;return this.cachedSlotSpec=null,scripts instanceof ScriptsMorph?(scripts.clearDropInfo(),
scripts.lastDroppedBlock=this,target=scripts.closestInput(this,hand),null!==target&&(scripts.lastReplacedInput=target,scripts.lastDropTarget=target.parent,target instanceof MultiArgMorph?(scripts.lastPreservedBlocks=target.inputs(),scripts.lastReplacedInput=target.fullCopy()):target instanceof CommandSlotMorph&&(scripts.lastReplacedInput=target,nb=target.nestedBlock(),nb&&(nb=nb.fullCopy(),scripts.add(nb),nb.moveBy(nb.extent()),nb.fixBlockColor(),scripts.lastPreservedBlocks=[nb])),target.parent.replaceInput(target,this),this.snapSound&&this.snapSound.play()),this.startLayout(),this.fixBlockColor(),this.endLayout(),ReporterBlockMorph.uber.snap.call(this),void(hand&&scripts.recordDrop(hand.grabOrigin))):null;
},ReporterBlockMorph.prototype.prepareToBeGrabbed=function(handMorph){var oldPos=this.position();nop(handMorph),(this.parent instanceof BlockMorph||this.parent instanceof MultiArgMorph||this.parent instanceof ReporterSlotMorph)&&(this.parent.revertToDefaultInput(this),this.setPosition(oldPos)),ReporterBlockMorph.uber.prepareToBeGrabbed.call(this,handMorph),this.alpha=.85,this.cachedSlotSpec=null},ReporterBlockMorph.prototype.blockSequence=function(){return this},ReporterBlockMorph.prototype.isUnevaluated=function(){var spec=this.getSlotSpec();return"%anyUE"===spec||"%boolUE"===spec||"%f"===spec},ReporterBlockMorph.prototype.isLocked=function(){return this.isStatic||"%t"===this.getSlotSpec();
},ReporterBlockMorph.prototype.getSlotSpec=function(){return this.cachedSlotSpec||(this.cachedSlotSpec=this.determineSlotSpec()),this.cachedSlotSpec},ReporterBlockMorph.prototype.determineSlotSpec=function(){var parts,idx;return this.parent instanceof BlockMorph&&(parts=this.parent.parts().filter(function(part){return!(part instanceof BlockHighlightMorph)}),idx=parts.indexOf(this),idx!==-1&&this.parent.blockSpec)?this.parseSpec(this.parent.blockSpec)[idx]:this.parent instanceof MultiArgMorph?this.parent.slotSpec:this.parent instanceof TemplateSlotMorph?this.parent.getSpec():null},ReporterBlockMorph.prototype.mouseClickLeft=function(pos){var label;return this.parent instanceof BlockInputFragmentMorph?this.parent.mouseClickLeft():void(this.parent instanceof TemplateSlotMorph?(label=this.parent.parent&&this.parent.parent.parent&&this.parent.parent.parent instanceof RingMorph?"Input name":"%blockVars"===this.parent.parent.elementSpec?"Block variable name":"Script variable name",
new DialogBoxMorph(this,this.userSetSpec,this).prompt(label,this.blockSpec,this.world())):ReporterBlockMorph.uber.mouseClickLeft.call(this,pos))},ReporterBlockMorph.prototype.exportResultPic=function(){var stage,top=this.topBlock(),receiver=top.scriptTarget();top===this&&receiver&&(stage=receiver.parentThatIsA(StageMorph),stage&&(stage.threads.stopProcess(top),stage.threads.startProcess(top,receiver,!1,!0)))},ReporterBlockMorph.prototype.userDestroy=function(){var target=this.selectForEdit();if(target!==this)return this.userDestroy.call(target);var scripts=this.parentThatIsA(ScriptsMorph);scripts&&(scripts.clearDropInfo(),scripts.lastDroppedBlock=this,scripts.recordDrop(this.situation()),
scripts.dropRecord.action="delete"),this.topBlock().fullChanged(),this.prepareToBeGrabbed(this.world().hand),this.destroy()},ReporterBlockMorph.prototype.drawNew=function(){var context;this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),context=this.image.getContext("2d"),context.fillStyle=this.cachedClr,this.isPredicate?this.drawDiamond(context):this.drawRounded(context),this.isCustomBlock&&!this.isGlobal&&this.drawMethodIcon(context),this.eraseHoles(context)},ReporterBlockMorph.prototype.drawRounded=function(context){var gradient,h=this.height(),r=Math.min(this.rounding,h/2),w=this.width(),shift=this.edge/2;
context.fillStyle=this.cachedClr,context.beginPath(),context.arc(r,r,r,radians(-180),radians(-90),!1),context.arc(w-r,r,r,radians(-90),radians(-0),!1),context.arc(w-r,h-r,r,radians(0),radians(90),!1),context.arc(r,h-r,r,radians(90),radians(180),!1),context.closePath(),context.fill(),MorphicPreferences.isFlat||(context.lineWidth=this.edge,context.lineJoin="round",context.lineCap="round",gradient=context.createRadialGradient(r,h-r,r-this.edge,r,h-r,r+this.edge),gradient.addColorStop(0,this.cachedClr),gradient.addColorStop(1,this.cachedClrBright),context.strokeStyle=gradient,context.beginPath(),context.arc(r,h-r,r-shift,radians(90),radians(180),!1),context.stroke(),
gradient=context.createRadialGradient(w-r,r,r-this.edge,w-r,r,r+this.edge),gradient.addColorStop(0,this.cachedClr),gradient.addColorStop(1,this.cachedClrDark),context.strokeStyle=gradient,context.beginPath(),context.arc(w-r,r,r-shift,radians(-90),radians(0),!1),context.stroke(),gradient=context.createLinearGradient(0,0,0,this.edge),gradient.addColorStop(0,this.cachedClrBright),gradient.addColorStop(1,this.cachedClr),context.strokeStyle=gradient,context.beginPath(),context.moveTo(r-shift,shift),context.lineTo(w-r+shift,shift),context.stroke(),gradient=context.createRadialGradient(r,r,r-this.edge,r,r,r),gradient.addColorStop(0,this.cachedClr),gradient.addColorStop(1,this.cachedClrBright),
context.strokeStyle=gradient,context.beginPath(),context.arc(r,r,r-shift,radians(180),radians(270),!1),context.stroke(),gradient=context.createRadialGradient(w-r,h-r,r-this.edge,w-r,h-r,r),gradient.addColorStop(0,this.cachedClr),gradient.addColorStop(1,this.cachedClrDark),context.strokeStyle=gradient,context.beginPath(),context.arc(w-r,h-r,r-shift,radians(0),radians(90),!1),context.stroke(),gradient=context.createLinearGradient(0,h-this.edge,0,h),gradient.addColorStop(0,this.cachedClr),gradient.addColorStop(1,this.cachedClrDark),context.strokeStyle=gradient,context.beginPath(),context.moveTo(r-shift,h-shift),context.lineTo(w-r+shift,h-shift),context.stroke(),
gradient=context.createLinearGradient(0,0,this.edge,0),gradient.addColorStop(0,this.cachedClrBright),gradient.addColorStop(1,this.cachedClr),context.strokeStyle=gradient,context.beginPath(),context.moveTo(shift,r),context.lineTo(shift,h-r),context.stroke(),gradient=context.createLinearGradient(w-this.edge,0,w,0),gradient.addColorStop(0,this.cachedClr),gradient.addColorStop(1,this.cachedClrDark),context.strokeStyle=gradient,context.beginPath(),context.moveTo(w-shift,r+shift),context.lineTo(w-shift,h-r),context.stroke())},ReporterBlockMorph.prototype.drawDiamond=function(context){var gradient,w=this.width(),h=this.height(),h2=Math.floor(h/2),r=this.rounding,shift=this.edge/2;
context.fillStyle=this.cachedClr,context.beginPath(),context.moveTo(0,h2),context.lineTo(r,0),context.lineTo(w-r,0),context.lineTo(w,h2),context.lineTo(w-r,h),context.lineTo(r,h),context.closePath(),context.fill(),MorphicPreferences.isFlat||(context.lineWidth=this.edge,context.lineJoin="round",context.lineCap="round",gradient=context.createLinearGradient(-r,0,r,0),gradient.addColorStop(1,this.cachedClr),gradient.addColorStop(0,this.cachedClrBright),context.strokeStyle=gradient,context.beginPath(),context.moveTo(shift,h2),context.lineTo(r,h-shift),context.closePath(),context.stroke(),gradient=context.createLinearGradient(w-r,0,w+r,0),gradient.addColorStop(0,this.cachedClr),
gradient.addColorStop(1,this.cachedClrDark),context.strokeStyle=gradient,context.beginPath(),context.moveTo(w-shift,h2),context.lineTo(w-r,shift),context.closePath(),context.stroke(),gradient=context.createLinearGradient(0,0,r,0),gradient.addColorStop(0,this.cachedClrBright),gradient.addColorStop(1,this.cachedClr),context.strokeStyle=gradient,context.beginPath(),context.moveTo(shift,h2),context.lineTo(r,shift),context.closePath(),context.stroke(),gradient=context.createLinearGradient(0,0,0,this.edge),gradient.addColorStop(0,this.cachedClrBright),gradient.addColorStop(1,this.cachedClr),context.strokeStyle=gradient,context.beginPath(),context.moveTo(r,shift),context.lineTo(w-r,shift),
context.closePath(),context.stroke(),gradient=context.createLinearGradient(w-r,0,w,0),gradient.addColorStop(0,this.cachedClr),gradient.addColorStop(1,this.cachedClrDark),context.strokeStyle=gradient,context.beginPath(),context.moveTo(w-r,h-shift),context.lineTo(w-shift,h2),context.closePath(),context.stroke(),gradient=context.createLinearGradient(0,h-this.edge,0,h),gradient.addColorStop(0,this.cachedClr),gradient.addColorStop(1,this.cachedClrDark),context.strokeStyle=gradient,context.beginPath(),context.moveTo(r+shift,h-shift),context.lineTo(w-r-shift,h-shift),context.closePath(),context.stroke())},RingMorph.prototype=new ReporterBlockMorph,RingMorph.prototype.constructor=RingMorph,
RingMorph.uber=ReporterBlockMorph.prototype,RingMorph.prototype.isCachingInputs=!1,RingMorph.prototype.init=function(){RingMorph.uber.init.call(this),this.category="other",this.alpha=RingMorph.prototype.alpha,this.contrast=RingMorph.prototype.contrast,this.setExtent(new Point(200,80))},RingMorph.prototype.rootForGrab=function(){return this.isDraggable?this:BlockMorph.uber.rootForGrab.call(this)},RingMorph.prototype.embed=function(aBlock,inputNames){var slot;this.color=SpriteMorph.prototype.blockColor.other,this.isDraggable=!0,aBlock instanceof CommandBlockMorph?(this.isStatic=!1,this.setSpec("%rc %ringparms"),this.selector="reifyScript",slot=this.parts()[0],slot.nestedBlock(aBlock)):aBlock.isPredicate?(this.isStatic=!0,
this.setSpec("%rp %ringparms"),this.selector="reifyPredicate",slot=this.parts()[0],slot.silentReplaceInput(slot.contents(),aBlock)):aBlock instanceof BooleanSlotMorph?(this.isStatic=!1,this.setSpec("%rp %ringparms"),this.selector="reifyPredicate",slot=this.parts()[0],slot.silentReplaceInput(slot.contents(),aBlock)):(this.isStatic=!1,this.setSpec("%rr %ringparms"),this.selector="reifyReporter",slot=this.parts()[0],slot.silentReplaceInput(slot.contents(),aBlock)),slot=this.parts()[1],inputNames&&inputNames.forEach(function(name){slot.addInput(name)}),this.fixBlockColor(null,!0)},RingMorph.prototype.vanishForSimilar=function(){var slot=this.parts()[0],block=slot.nestedBlock();
return block&&this.parent instanceof SyntaxElementMorph?this.parent instanceof RingReporterSlotMorph||this.parent instanceof RingCommandSlotMorph?null:void(("reportGetVar"===block.selector||"reportJSFunction"===block.selector||block instanceof RingMorph)&&this.parent.silentReplaceInput(this,block)):null},RingMorph.prototype.contents=function(){return this.parts()[0].nestedBlock()},RingMorph.prototype.inputNames=function(){return this.parts()[1].evaluate()},RingMorph.prototype.dataType=function(){switch(this.selector){case"reifyScript":return"command";case"reifyPredicate":return"predicate";default:return"reporter"}},RingMorph.prototype.fixBlockColor=function(nearest,isForced){
var slot=this.parts()[0];RingMorph.uber.fixBlockColor.call(this,nearest,isForced),slot.fixLayout()},ScriptsMorph.prototype=new FrameMorph,ScriptsMorph.prototype.constructor=ScriptsMorph,ScriptsMorph.uber=FrameMorph.prototype,ScriptsMorph.prototype.cleanUpMargin=20,ScriptsMorph.prototype.cleanUpSpacing=15,ScriptsMorph.prototype.isPreferringEmptySlots=!0;ScriptsMorph.prototype.enableKeyboard=!0;ScriptsMorph.prototype.enableNestedAutoWrapping=!0,ScriptsMorph.prototype.init=function(){this.feedbackColor=SyntaxElementMorph.prototype.feedbackColor,this.feedbackMorph=new BoxMorph,this.rejectsHats=!1,this.lastDroppedBlock=null,this.lastReplacedInput=null,this.lastDropTarget=null,
this.lastPreservedBlocks=null,this.lastNextBlock=null,this.lastWrapParent=null,this.focus=null,ScriptsMorph.uber.init.call(this),this.setColor(new Color(70,70,70)),this.noticesTransparentClick=!0,this.isAnimating=!1,this.dropRecord=null,this.recordDrop()},ScriptsMorph.prototype.fullCopy=function(){var child,cpy=new ScriptsMorph,pos=this.position();return this.focus&&this.focus.stopEditing(),this.children.forEach(function(morph){morph.block||(child=morph.fullCopy(),cpy.add(child),child.setPosition(morph.position().subtract(pos)),child instanceof BlockMorph&&child.allComments().forEach(function(comment){comment.align(child)}))}),cpy.adjustBounds(),cpy},ScriptsMorph.prototype.step=function(){
var block,world=this.world(),hand=world.hand;return this.feedbackMorph.parent&&(this.feedbackMorph.destroy(),this.feedbackMorph.parent=null),this.focus&&(!world.keyboardReceiver||world.keyboardReceiver instanceof StageMorph)&&this.focus.getFocus(world),0===hand.children.length?null:this.bounds.containsPoint(hand.bounds.origin)?(block=hand.children[0],(block instanceof BlockMorph||block instanceof CommentMorph)&&contains(hand.morphAtPointer().allParents(),this)?void(block instanceof CommentMorph?this.showCommentDropFeedback(block,hand):block instanceof ReporterBlockMorph?this.showReporterDropFeedback(block,hand):this.showCommandDropFeedback(block)):null):null},
ScriptsMorph.prototype.showReporterDropFeedback=function(block,hand){var target=this.closestInput(block,hand);return null===target?null:(this.feedbackMorph.bounds=target.fullBounds().expandBy(Math.max(2*block.edge,block.reporterDropFeedbackPadding)),this.feedbackMorph.edge=SyntaxElementMorph.prototype.rounding,this.feedbackMorph.border=Math.max(SyntaxElementMorph.prototype.edge,3),this.add(this.feedbackMorph),target instanceof MultiArgMorph?(this.feedbackMorph.color=SpriteMorph.prototype.blockColor.lists.copy(),this.feedbackMorph.borderColor=SpriteMorph.prototype.blockColor.lists):(this.feedbackMorph.color=this.feedbackColor.copy(),this.feedbackMorph.borderColor=this.feedbackColor),
this.feedbackMorph.color.a=.5,this.feedbackMorph.drawNew(),void this.feedbackMorph.changed())},ScriptsMorph.prototype.showCommandDropFeedback=function(block){var y,target;return(target=block.closestAttachTarget(this))?"wrap"===target.loc?void this.showCSlotWrapFeedback(block,target.element):(this.add(this.feedbackMorph),this.feedbackMorph.border=0,this.feedbackMorph.edge=0,this.feedbackMorph.alpha=1,this.feedbackMorph.setExtent(new Point(target.element.width(),Math.max(SyntaxElementMorph.prototype.corner,SyntaxElementMorph.prototype.feedbackMinHeight))),this.feedbackMorph.color=this.feedbackColor,this.feedbackMorph.drawNew(),this.feedbackMorph.changed(),y=target.point.y,
"bottom"===target.loc&&("block"===target.type?target.element.nextBlock()&&(y-=SyntaxElementMorph.prototype.corner):"slot"===target.type&&target.element.nestedBlock()&&(y-=SyntaxElementMorph.prototype.corner)),void this.feedbackMorph.setPosition(new Point(target.element.left(),y))):null},ScriptsMorph.prototype.showCommentDropFeedback=function(comment,hand){var target=this.closestBlock(comment,hand);return target?(this.feedbackMorph.bounds=target.bounds.expandBy(Math.max(2*BlockMorph.prototype.edge,BlockMorph.prototype.reporterDropFeedbackPadding)),this.feedbackMorph.edge=SyntaxElementMorph.prototype.rounding,this.feedbackMorph.border=Math.max(SyntaxElementMorph.prototype.edge,3),
this.add(this.feedbackMorph),this.feedbackMorph.color=comment.color.copy(),this.feedbackMorph.color.a=.25,this.feedbackMorph.borderColor=comment.titleBar.color,this.feedbackMorph.drawNew(),void this.feedbackMorph.changed()):null},ScriptsMorph.prototype.showCSlotWrapFeedback=function(srcBlock,trgBlock){var clr;this.feedbackMorph.bounds=trgBlock.fullBounds().expandBy(BlockMorph.prototype.corner),this.feedbackMorph.edge=SyntaxElementMorph.prototype.corner,this.feedbackMorph.border=Math.max(SyntaxElementMorph.prototype.edge,3),this.add(this.feedbackMorph),clr=srcBlock.color.lighter(40),this.feedbackMorph.color=clr.copy(),this.feedbackMorph.color.a=.1,this.feedbackMorph.borderColor=clr,
this.feedbackMorph.drawNew(),this.feedbackMorph.changed()},ScriptsMorph.prototype.closestInput=function(reporter,hand){function touchingVariadicArrowsIfAny(inp,point){return!(inp instanceof MultiArgMorph)||(point?inp.arrows().bounds.containsPoint(point):inp.arrows().bounds.intersects(fb))}var handPos,target,all,fb=reporter.fullBoundsNoShadow(),stacks=this.children.filter(function(child){return child instanceof BlockMorph&&child.fullBounds().intersects(fb)}),blackList=reporter.allInputs();if(all=[],stacks.forEach(function(stack){all=all.concat(stack.allInputs())}),0===all.length)return null;if(this.isPreferringEmptySlots){if(hand&&(handPos=hand.position(),target=detect(all,function(input){
return(input instanceof InputSlotMorph||input instanceof ArgMorph&&!(input instanceof CommandSlotMorph)&&!(input instanceof MultiArgMorph)||input instanceof RingMorph&&!input.contents()||input.isEmptySlot())&&!input.isLocked()&&input.bounds.containsPoint(handPos)&&!contains(blackList,input)})))return target;if(target=detect(all,function(input){return(input instanceof InputSlotMorph||input instanceof ArgMorph||input instanceof RingMorph&&!input.contents()||input.isEmptySlot())&&!input.isLocked()&&input.bounds.intersects(fb)&&!contains(blackList,input)&&touchingVariadicArrowsIfAny(input)}))return target}return hand&&(handPos=hand.position(),target=detect(all,function(input){
return input!==reporter&&!input.isLocked()&&input.bounds.containsPoint(handPos)&&!(input.parent instanceof PrototypeHatBlockMorph)&&!contains(blackList,input)}))?target:detect(all,function(input){return input!==reporter&&!input.isLocked()&&input.fullBounds().intersects(fb)&&!(input.parent instanceof PrototypeHatBlockMorph)&&!contains(blackList,input)})},ScriptsMorph.prototype.closestBlock=function(comment,hand){var handPos,target,all,fb=comment.bounds,stacks=this.children.filter(function(child){return child instanceof BlockMorph&&child.fullBounds().intersects(fb)});return all=[],stacks.forEach(function(stack){all=all.concat(stack.allChildren().slice(0).reverse().filter(function(child){
return child instanceof BlockMorph&&!child.isTemplate}))}),0===all.length?null:hand&&(handPos=hand.position(),target=detect(all,function(block){return!block.comment&&!block.isPrototype&&block.bounds.containsPoint(handPos)}))?target:detect(all,function(block){return!block.comment&&!block.isPrototype&&block.bounds.intersects(fb)})},ScriptsMorph.prototype.userMenu=function(){function addOption(label,toggle,test,onHint,offHint){var on="☑ ",off="☐ ";menu.addItem((test?on:off)+localize(label),toggle,test?onHint:offHint)}var blockEditor,hasUndropQueue,menu=new MenuMorph(this),ide=this.parentThatIsA(IDE_Morph),shiftClicked=16===this.world().currentKey,myself=this,obj=this.scriptTarget(),stage=obj.parentThatIsA(StageMorph);
return ide||(blockEditor=this.parentThatIsA(BlockEditorMorph),blockEditor&&(ide=blockEditor.target.parentThatIsA(IDE_Morph))),this.dropRecord&&(this.dropRecord.lastRecord&&(hasUndropQueue=!0,menu.addPair([new SymbolMorph("turnBack",MorphicPreferences.menuFontSize),localize("undrop")],"undrop","^Z","undo the last\nblock drop\nin this pane")),this.dropRecord.nextRecord&&(hasUndropQueue=!0,menu.addPair([new SymbolMorph("turnForward",MorphicPreferences.menuFontSize),localize("redrop")],"redrop","^Y","redo the last undone\nblock drop\nin this pane")),hasUndropQueue&&(shiftClicked&&menu.addItem("clear undrop queue",function(){myself.dropRecord=null,myself.clearDropInfo(),
myself.recordDrop()},"forget recorded block drops\non this pane",new Color(100,0,0)),menu.addLine())),menu.addItem("clean up","cleanUp","arrange scripts\nvertically"),menu.addItem("add comment","addComment"),menu.addItem("scripts pic...","exportScriptsPicture","open a new window\nwith a picture of all scripts"),ide&&(menu.addLine(),!blockEditor&&obj.exemplar&&addOption("inherited",function(){obj.toggleInheritanceForAttribute("scripts")},obj.inheritsAttribute("scripts"),"uncheck to\ndisinherit",localize("check to inherit\nfrom")+" "+obj.exemplar.name),menu.addItem("make a block...",function(){new BlockDialogMorph(null,function(definition){""!==definition.spec&&(definition.isGlobal?stage.globalBlocks.push(definition):obj.customBlocks.push(definition),
ide.flushPaletteCache(),ide.refreshPalette(),new BlockEditorMorph(definition,obj).popUp())},myself).prompt("Make a block",null,myself.world())})),menu},ScriptsMorph.prototype.cleanUp=function(){var target=this.selectForEdit(),origin=target.topLeft(),y=target.cleanUpMargin;target.children.sort(function(a,b){return a instanceof PrototypeHatBlockMorph?0:a.top()-b.top()}).forEach(function(child){child instanceof CommentMorph&&child.block||(child.setPosition(origin.add(new Point(target.cleanUpMargin,y))),child instanceof BlockMorph&&child.allComments().forEach(function(comment){comment.align(child,!0)}),y+=child.stackHeight()+target.cleanUpSpacing)}),target.parent&&target.setPosition(target.parent.topLeft()),
target.adjustBounds()},ScriptsMorph.prototype.exportScriptsPicture=function(){var pic=this.scriptsPicture(),ide=this.world().children[0];pic&&ide.saveCanvasAs(pic,(ide.projectName||localize("untitled"))+" "+localize("script pic"))},ScriptsMorph.prototype.scriptsPicture=function(){var boundingBox,pic,ctx;if(0!==this.children.length)return boundingBox=this.children[0].fullBounds(),this.children.forEach(function(child){child.isVisible&&(boundingBox=boundingBox.merge(child.fullBounds()))}),pic=newCanvas(boundingBox.extent()),ctx=pic.getContext("2d"),this.children.forEach(function(child){var pos=child.fullBounds().origin;child.isVisible&&ctx.drawImage(child.fullImageClassic(),pos.x-boundingBox.origin.x,pos.y-boundingBox.origin.y);
}),pic},ScriptsMorph.prototype.addComment=function(){var ide=this.parentThatIsA(IDE_Morph),blockEditor=this.parentThatIsA(BlockEditorMorph),world=this.world();(new CommentMorph).pickUp(world),!ide&&blockEditor&&(ide=blockEditor.target.parentThatIsA(IDE_Morph)),ide&&(world.hand.grabOrigin={origin:ide.palette,position:ide.palette.center()})},ScriptsMorph.prototype.undrop=function(){var myself=this;this.isAnimating||this.dropRecord&&this.dropRecord.lastRecord&&(this.dropRecord.situation||(this.dropRecord.situation=this.dropRecord.lastDroppedBlock.situation()),this.isAnimating=!0,this.dropRecord.lastDroppedBlock.slideBackTo(this.dropRecord.lastOrigin,null,this.recoverLastDrop(),function(){
myself.updateToolbar(),myself.isAnimating=!1}),this.dropRecord=this.dropRecord.lastRecord)},ScriptsMorph.prototype.redrop=function(){var myself=this;this.isAnimating||this.dropRecord&&this.dropRecord.nextRecord&&(this.dropRecord=this.dropRecord.nextRecord,"delete"===this.dropRecord.action?(this.recoverLastDrop(!0),this.dropRecord.lastDroppedBlock.destroy(),this.updateToolbar()):(this.isAnimating=!0,this.dropRecord.lastDroppedBlock.slideBackTo(this.dropRecord.situation,null,this.recoverLastDrop(!0),function(){myself.updateToolbar(),myself.isAnimating=!1})))},ScriptsMorph.prototype.recoverLastDrop=function(forRedrop){var dropped,onBeforeDrop,parent,rec=this.dropRecord;
if(!rec||!rec.lastDroppedBlock)throw new Error("nothing to undrop");if(dropped=rec.lastDroppedBlock,parent=dropped.parent,dropped instanceof CommandBlockMorph){if(rec.lastNextBlock&&("delete"===rec.action?forRedrop&&this.add(rec.lastNextBlock):this.add(rec.lastNextBlock)),rec.lastDropTarget)if("bottom"===rec.lastDropTarget.loc)"slot"===rec.lastDropTarget.type?rec.lastNextBlock&&rec.lastDropTarget.element.nestedBlock(rec.lastNextBlock):rec.lastNextBlock&&rec.lastDropTarget.element.nextBlock(rec.lastNextBlock);else if("top"===rec.lastDropTarget.loc)this.add(rec.lastDropTarget.element);else if("wrap"===rec.lastDropTarget.loc){var cslot=detect(rec.lastDroppedBlock.inputs(),function(each){
return each instanceof CSlotMorph});rec.lastWrapParent instanceof CommandBlockMorph?forRedrop?onBeforeDrop=function(){cslot.nestedBlock(rec.lastDropTarget.element)}:rec.lastWrapParent.nextBlock(rec.lastDropTarget.element):rec.lastWrapParent instanceof CommandSlotMorph?forRedrop?onBeforeDrop=function(){cslot.nestedBlock(rec.lastDropTarget.element)}:rec.lastWrapParent.nestedBlock(rec.lastDropTarget.element):this.add(rec.lastDropTarget.element),rec.lastDropTarget.element.blockSequence().forEach(function(cmd){cmd.fixBlockColor()}),cslot.fixLayout()}}else if(dropped instanceof ReporterBlockMorph)rec.lastDropTarget&&(rec.lastDropTarget.replaceInput(rec.lastDroppedBlock,rec.lastReplacedInput),
rec.lastDropTarget.fixBlockColor(null,!0),rec.lastPreservedBlocks&&rec.lastPreservedBlocks.forEach(function(morph){morph.destroy()}));else{if(!(dropped instanceof CommentMorph))throw new Error("unsupported action for "+dropped);forRedrop&&rec.lastDropTarget&&(onBeforeDrop=function(){rec.lastDropTarget.element.comment=dropped,dropped.block=rec.lastDropTarget.element,dropped.align()})}return this.clearDropInfo(),dropped.prepareToBeGrabbed(this.world().hand),dropped instanceof CommentMorph&&dropped.removeShadow(),this.add(dropped),parent.reactToGrabOf(dropped),dropped instanceof ReporterBlockMorph&&parent instanceof BlockMorph&&parent.changed(),"delete"===rec.action&&(forRedrop&&rec.lastNextBlock&&(parent instanceof CommandBlockMorph?parent.nextBlock(rec.lastNextBlock):parent instanceof CommandSlotMorph&&parent.nestedBlock(rec.lastNextBlock)),
forRedrop||dropped.moveBy(new Point(-100,-20))),onBeforeDrop},ScriptsMorph.prototype.clearDropInfo=function(){this.lastDroppedBlock=null,this.lastReplacedInput=null,this.lastDropTarget=null,this.lastPreservedBlocks=null,this.lastNextBlock=null,this.lastWrapParent=null},ScriptsMorph.prototype.recordDrop=function(lastGrabOrigin){var record={lastDroppedBlock:this.lastDroppedBlock,lastReplacedInput:this.lastReplacedInput,lastDropTarget:this.lastDropTarget,lastPreservedBlocks:this.lastPreservedBlocks,lastNextBlock:this.lastNextBlock,lastWrapParent:this.lastWrapParent,lastOrigin:lastGrabOrigin,action:null,situation:null,lastRecord:this.dropRecord,nextRecord:null};this.dropRecord&&(this.dropRecord.nextRecord=record),
this.dropRecord=record,this.updateToolbar()},ScriptsMorph.prototype.addToolbar=function(){var toolBar=new AlignmentMorph,myself=this,shade=new Color(140,140,140);return toolBar.respectHiddens=!0,toolBar.undoButton=new PushButtonMorph(this,"undrop",new SymbolMorph("turnBack",12)),toolBar.undoButton.alpha=.2,toolBar.undoButton.padding=2,toolBar.undoButton.labelShadowColor=shade,toolBar.undoButton.drawNew(),toolBar.undoButton.fixLayout(),toolBar.add(toolBar.undoButton),toolBar.redoButton=new PushButtonMorph(this,"redrop",new SymbolMorph("turnForward",12)),toolBar.redoButton.alpha=.2,toolBar.redoButton.padding=2,toolBar.redoButton.labelShadowColor=shade,toolBar.redoButton.drawNew(),
toolBar.redoButton.fixLayout(),toolBar.add(toolBar.redoButton),toolBar.keyboardButton=new ToggleButtonMorph(null,this,"toggleKeyboardEntry",[new SymbolMorph("keyboard",12),new SymbolMorph("keyboardFilled",12)],function(){return!isNil(myself.focus)}),toolBar.keyboardButton.alpha=.2,toolBar.keyboardButton.padding=2,toolBar.keyboardButton.hint="use the keyboard\nto enter blocks",toolBar.keyboardButton.labelShadowColor=shade,toolBar.keyboardButton.drawNew(),toolBar.keyboardButton.fixLayout(),toolBar.add(toolBar.keyboardButton),toolBar},ScriptsMorph.prototype.updateToolbar=function(){var sf=this.parentThatIsA(ScrollFrameMorph);sf&&(sf.toolBar||(sf.toolBar=this.addToolbar(),
sf.add(sf.toolBar)),this.enableKeyboard?(sf.toolBar.keyboardButton.show(),sf.toolBar.keyboardButton.refresh()):sf.toolBar.keyboardButton.hide(),this.dropRecord&&(this.dropRecord.lastRecord?sf.toolBar.undoButton.isVisible||sf.toolBar.undoButton.show():sf.toolBar.undoButton.isVisible&&sf.toolBar.undoButton.hide(),this.dropRecord.nextRecord?sf.toolBar.redoButton.isVisible||(sf.toolBar.redoButton.show(),sf.toolBar.undoButton.mouseLeave()):sf.toolBar.redoButton.isVisible&&sf.toolBar.redoButton.hide()),detect(sf.toolBar.children,function(each){return each.isVisible})&&(sf.toolBar.fixLayout(),sf.adjustToolBar()))},ScriptsMorph.prototype.sortedElements=function(){var scripts=this.children.filter(function(each){
return!(each instanceof CommentMorph)||!each.block});return scripts.sort(function(a,b){return a instanceof PrototypeHatBlockMorph?0:a.top()-b.top()}),scripts},ScriptsMorph.prototype.fixMultiArgs=function(){var oldFlag=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,this.forAllChildren(function(morph){morph instanceof MultiArgMorph&&morph.fixLayout()}),Morph.prototype.trackChanges=oldFlag},ScriptsMorph.prototype.wantsDropOf=function(aMorph){return aMorph instanceof HatBlockMorph?!this.rejectsHats:aMorph instanceof SyntaxElementMorph||aMorph instanceof CommentMorph},ScriptsMorph.prototype.reactToDropOf=function(droppedMorph,hand){(droppedMorph instanceof BlockMorph||droppedMorph instanceof CommentMorph)&&droppedMorph.snap(hand),
this.adjustBounds()},ScriptsMorph.prototype.mouseClickLeft=function(pos){var shiftClicked=16===this.world().currentKey;return shiftClicked?this.edit(pos):void(this.focus&&this.focus.stopEditing())},ScriptsMorph.prototype.selectForEdit=function(){var ide=this.parentThatIsA(IDE_Morph),rcvr=ide?ide.currentSprite:null;return rcvr&&rcvr.inheritsAttribute("scripts")?(this.feedbackMorph.destroy(),rcvr.shadowAttribute("scripts"),rcvr.scripts):this},ScriptsMorph.prototype.edit=function(pos){var target,world=this.world();this.focus&&this.focus.stopEditing(),world.stopEditing(),ScriptsMorph.prototype.enableKeyboard&&(target=this.selectForEdit(),target.focus=new ScriptFocusMorph(target,target,pos),
target.focus.getFocus(world))},ScriptsMorph.prototype.toggleKeyboardEntry=function(){var target,sorted,world=this.world();return this.focus?void this.focus.stopEditing():(world.stopEditing(),void(ScriptsMorph.prototype.enableKeyboard&&(target=this.selectForEdit(),target.focus=new ScriptFocusMorph(target,target,target.position()),target.focus.getFocus(world),sorted=target.focus.sortedScripts(),sorted.length?(target.focus.element=sorted[0],target.focus.element instanceof HatBlockMorph&&target.focus.nextCommand()):target.focus.moveBy(new Point(50,50)),target.focus.fixLayout())))},ScriptsMorph.prototype.scriptTarget=function(){var editor=this.parentThatIsA(IDE_Morph);
if(editor)return editor.currentSprite;if(editor=this.parentThatIsA(BlockEditorMorph))return editor.target;throw new Error("script target bannot be found for orphaned scripts")},ArgMorph.prototype=new SyntaxElementMorph,ArgMorph.prototype.constructor=ArgMorph,ArgMorph.uber=SyntaxElementMorph.prototype,ArgMorph.prototype.init=function(type,silently){this.type=type||null,this.isHole=!1,ArgMorph.uber.init.call(this,silently),this.color=new Color(0,17,173),this.setExtent(new Point(50,50),silently)},ArgMorph.prototype.executeOnSliderEdit=!1,ArgMorph.prototype.reactToSliderEdit=function(){var block,top,receiver,stage;if(this.executeOnSliderEdit&&(block=this.parentThatIsA(BlockMorph))){
if(top=block.topBlock(),receiver=top.scriptTarget(),top instanceof PrototypeHatBlockMorph)return;receiver&&(stage=receiver.parentThatIsA(StageMorph),stage&&(stage.isThreadSafe||Process.prototype.enableSingleStepping)?stage.threads.startProcess(top,receiver,stage.isThreadSafe):top.mouseClickLeft())}},ArgMorph.prototype.justDropped=function(){this instanceof CommandSlotMorph||(this.drawNew(),this.changed())},ArgMorph.prototype.getSpec=function(){return"%s"},ArgMorph.prototype.drawNew=function(){"list"===this.type?(this.image=this.listIcon(),this.silentSetExtent(new Point(this.image.width,this.image.height))):"object"===this.type?(this.image=this.objectIcon(),this.silentSetExtent(new Point(this.image.width,this.image.height))):ArgMorph.uber.drawNew.call(this);
},ArgMorph.prototype.listIcon=function(){var source,icon,context,ratio,frame=new Morph,first=new CellMorph,second=new CellMorph;return frame.color=new Color(255,255,255),second.setPosition(first.bottomLeft().add(new Point(0,this.fontSize/3))),first.add(second),first.setPosition(frame.position().add(this.fontSize)),frame.add(first),frame.bounds.corner=second.bounds.corner.add(this.fontSize),frame.drawNew(),source=frame.fullImage(),ratio=(this.fontSize+this.edge)/source.height,icon=newCanvas(new Point(Math.ceil(source.width*ratio)+1,Math.ceil(source.height*ratio)+1)),context=icon.getContext("2d"),context.fillStyle="black",context.fillRect(0,0,icon.width,icon.height),
context.scale(ratio,ratio),context.drawImage(source,1/ratio,1/ratio),icon},ArgMorph.prototype.objectIcon=function(){return this.labelPart("%turtle").image},ArgMorph.prototype.isEmptySlot=function(){return null!==this.type},CommandSlotMorph.prototype=new ArgMorph,CommandSlotMorph.prototype.constructor=CommandSlotMorph,CommandSlotMorph.uber=ArgMorph.prototype,CommandSlotMorph.prototype.init=function(silently){CommandSlotMorph.uber.init.call(this,null,!0),this.color=new Color(0,17,173),this.setExtent(new Point(230,4*this.corner+this.cSlotPadding),silently)},CommandSlotMorph.prototype.getSpec=function(){return"%cmd"},CommandSlotMorph.prototype.topBlock=function(){
return this.parent.topBlock?this.parent.topBlock():this.nestedBlock()},CommandSlotMorph.prototype.nestedBlock=function(block){if(!block)return detect(this.children,function(child){return child instanceof CommandBlockMorph});var nb=this.nestedBlock();this.add(block),nb&&block.bottomBlock().nextBlock(nb),this.fixLayout()},CommandSlotMorph.prototype.slotAttachPoint=function(){return new Point(this.dentCenter(),this.top()+2*this.corner)},CommandSlotMorph.prototype.dentLeft=function(){return this.left()+this.corner+2*this.inset},CommandSlotMorph.prototype.dentCenter=function(){return this.dentLeft()+this.corner+.5*this.dent},CommandSlotMorph.prototype.attachTargets=function(){
var answer=[];return answer.push({point:this.slotAttachPoint(),element:this,loc:"bottom",type:"slot"}),answer},CommandSlotMorph.prototype.fixLayout=function(){var nb=this.nestedBlock();this.parent&&(this.color.eq(this.parent.color)||this.setColor(this.parent.color)),nb?(nb.setPosition(new Point(this.left()+this.edge+this.rfBorder,this.top()+this.edge+this.rfBorder)),this.setWidth(nb.fullBounds().width()+2*(this.edge+this.rfBorder)),this.setHeight(nb.fullBounds().height()+this.edge+2*this.rfBorder-(this.corner-this.edge))):(this.setHeight(4*this.corner),this.setWidth(4*this.corner+this.inset+this.dent)),this.parent.fixLayout&&this.parent.fixLayout()},CommandSlotMorph.prototype.evaluate=function(){
return this.nestedBlock()},CommandSlotMorph.prototype.isEmptySlot=function(){return!this.isStatic&&null===this.nestedBlock()},CommandSlotMorph.prototype.attach=function(){var choices=this.overlappedMorphs(),menu=new MenuMorph(this,"choose new parent:"),myself=this;choices.forEach(function(each){menu.addItem(each.toString().slice(0,50),function(){each.add(myself),myself.isDraggable=!1,each.fixLayout&&each.fixLayout()})}),choices.length>0&&menu.popUpAtHand(this.world())},CommandSlotMorph.prototype.drawNew=function(){var context;this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),
context=this.image.getContext("2d"),context.fillStyle=this.cachedClr,context.fillRect(0,0,this.width(),this.height()),context.fillStyle=this.rfColor.toString(),this.drawFlat(context),MorphicPreferences.isFlat||this.drawEdges(context)},CommandSlotMorph.prototype.drawFlat=function(context){var isFilled=null!==this.nestedBlock(),ins=isFilled?this.inset:this.inset/2,dent=isFilled?this.dent:this.dent/2,indent=2*this.corner+ins,edge=this.edge,rf=isFilled?this.rfBorder:0,y=this.height()-this.corner-edge;context.beginPath(),context.arc(this.corner+edge,this.corner+edge,this.corner,radians(-180),radians(-90),!1),context.lineTo(this.corner+ins+edge+2*rf,edge),context.lineTo(indent+edge+2*rf,this.corner+edge),
context.lineTo(indent+edge+2*rf+(dent-2*rf),this.corner+edge),context.lineTo(indent+edge+2*rf+(dent-2*rf)+this.corner,edge),context.lineTo(this.width()-this.corner-edge,edge),context.arc(this.width()-this.corner-edge,this.corner+edge,this.corner,radians(-90),radians(-0),!1),context.arc(this.width()-this.corner-edge,y,this.corner,radians(0),radians(90),!1),context.arc(this.corner+edge,y,this.corner,radians(90),radians(180),!1),context.closePath(),context.fill()},CommandSlotMorph.prototype.drawEdges=function(context){var gradient,upperGradient,lowerGradient,rightGradient,isFilled=null!==this.nestedBlock(),ins=isFilled?this.inset:this.inset/2,dent=isFilled?this.dent:this.dent/2,indent=2*this.corner+ins,edge=this.edge,rf=isFilled?this.rfBorder:0,shift=.5*this.edge;
context.lineWidth=this.edge,context.lineJoin="round",context.lineCap="round",gradient=context.createLinearGradient(0,this.height(),0,this.height()-this.edge),gradient.addColorStop(0,this.cachedClr),gradient.addColorStop(1,this.cachedClrBright),context.strokeStyle=gradient,context.beginPath(),context.moveTo(this.corner+edge,this.height()-shift),context.lineTo(this.width()-this.corner-edge,this.height()-shift),context.stroke(),gradient=context.createRadialGradient(this.width()-(this.corner+edge),this.height()-(this.corner+edge),this.corner,this.width()-(this.corner+edge),this.height()-(this.corner+edge),this.corner+edge),gradient.addColorStop(0,this.cachedClrBright),
gradient.addColorStop(1,this.cachedClr),context.strokeStyle=gradient,context.beginPath(),context.arc(this.width()-(this.corner+edge),this.height()-(this.corner+edge),this.corner+shift,radians(0),radians(90),!1),context.stroke(),gradient=context.createLinearGradient(this.width(),0,this.width()-this.edge,0),gradient.addColorStop(0,this.cachedClr),gradient.addColorStop(1,this.cachedClrBright),context.strokeStyle=gradient,context.beginPath(),context.moveTo(this.width()-shift,this.height()-this.corner-this.edge),context.lineTo(this.width()-shift,edge+this.corner),context.stroke(),context.shadowOffsetY=shift,context.shadowBlur=this.edge,context.shadowColor=this.rfColor.darker(80).toString(),
gradient=context.createLinearGradient(0,0,edge,0),gradient.addColorStop(0,this.cachedClr),gradient.addColorStop(1,this.cachedClrDark),context.strokeStyle=gradient,context.beginPath(),context.moveTo(shift,edge+this.corner),context.lineTo(shift,this.height()-edge-this.corner),context.stroke(),gradient=context.createRadialGradient(this.corner+edge,this.corner+edge,this.corner,this.corner+edge,this.corner+edge,this.corner+edge),gradient.addColorStop(0,this.cachedClrDark),gradient.addColorStop(1,this.cachedClr),context.strokeStyle=gradient,context.beginPath(),context.arc(this.corner+edge,this.corner+edge,this.corner+shift,radians(-180),radians(-90),!1),context.stroke(),
upperGradient=context.createLinearGradient(0,0,0,this.edge),upperGradient.addColorStop(0,this.cachedClr),upperGradient.addColorStop(1,this.cachedClrDark),context.strokeStyle=upperGradient,context.beginPath(),context.moveTo(this.corner+edge,shift),context.lineTo(this.corner+ins+edge+2*rf-shift,shift),context.stroke(),lowerGradient=context.createLinearGradient(0,this.corner,0,this.corner+edge),lowerGradient.addColorStop(0,this.cachedClr),lowerGradient.addColorStop(1,this.cachedClrDark),context.strokeStyle=lowerGradient,context.beginPath(),context.moveTo(indent+edge+2*rf+shift,this.corner+shift),context.lineTo(indent+edge+2*rf+(dent-2*rf),this.corner+shift),context.stroke(),
rightGradient=context.createLinearGradient(indent+edge+2*rf+(dent-2*rf)-shift,this.corner,indent+edge+2*rf+(dent-2*rf)+.7*shift,this.corner+shift+.7*shift),rightGradient.addColorStop(0,this.cachedClr),rightGradient.addColorStop(1,this.cachedClrDark),context.strokeStyle=rightGradient,context.beginPath(),context.moveTo(indent+edge+2*rf+(dent-2*rf),this.corner+shift),context.lineTo(indent+edge+2*rf+(dent-2*rf)+this.corner,shift),context.stroke(),context.strokeStyle=upperGradient,context.beginPath(),context.moveTo(indent+edge+2*rf+(dent-2*rf)+this.corner,shift),context.lineTo(this.width()-this.corner-edge,shift),context.stroke()},RingCommandSlotMorph.prototype=new CommandSlotMorph,
RingCommandSlotMorph.prototype.constructor=RingCommandSlotMorph,RingCommandSlotMorph.uber=CommandSlotMorph.prototype,RingCommandSlotMorph.prototype.rfBorder=0,RingCommandSlotMorph.prototype.edge=RingMorph.prototype.edge,RingCommandSlotMorph.prototype.init=function(silently){RingCommandSlotMorph.uber.init.call(this,silently),this.isHole=!0,this.noticesTransparentClick=!0,this.color=new Color(0,17,173),this.alpha=RingMorph.prototype.alpha,this.contrast=RingMorph.prototype.contrast},RingCommandSlotMorph.prototype.getSpec=function(){return"%rc"},RingCommandSlotMorph.prototype.drawNew=function(){var context;this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),
this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),context=this.image.getContext("2d"),context.fillStyle=this.cachedClr,this.drawFlat(context),MorphicPreferences.isFlat||this.drawEdges(context)},RingCommandSlotMorph.prototype.drawFlat=function(context){var isFilled=null!==this.nestedBlock(),ins=isFilled?this.inset:this.inset/2,dent=isFilled?this.dent:this.dent/2,indent=2*this.corner+ins,edge=this.edge,w=this.width(),h=this.height(),rf=isFilled?this.rfBorder:0,y=h-this.corner-edge;context.beginPath(),context.moveTo(0,h/2),context.lineTo(edge,h/2),context.arc(this.corner+edge,this.corner+edge,this.corner,radians(-180),radians(-90),!1),context.lineTo(this.corner+ins+edge+2*rf,edge),
context.lineTo(indent+edge+2*rf,this.corner+edge),context.lineTo(indent+edge+2*rf+(dent-2*rf),this.corner+edge),context.lineTo(indent+edge+2*rf+(dent-2*rf)+this.corner,edge),context.lineTo(this.width()-this.corner-edge,edge),context.arc(w-this.corner-edge,this.corner+edge,this.corner,radians(-90),radians(-0),!1),context.lineTo(w-this.edge,h/2),context.lineTo(w,h/2),context.lineTo(w,0),context.lineTo(0,0),context.closePath(),context.fill(),context.beginPath(),context.moveTo(w,h/2),context.lineTo(w-edge,h/2),context.arc(this.width()-this.corner-edge,y,this.corner,radians(0),radians(90),!1),context.arc(this.corner+edge,y,this.corner,radians(90),radians(180),!1),
context.lineTo(edge,h/2),context.lineTo(0,h/2),context.lineTo(0,h),context.lineTo(w,h),context.closePath(),context.fill()},CSlotMorph.prototype=new CommandSlotMorph,CSlotMorph.prototype.constructor=CSlotMorph,CSlotMorph.uber=CommandSlotMorph.prototype,CSlotMorph.prototype.init=function(silently){CommandSlotMorph.uber.init.call(this,null,!0),this.isHole=!0,this.isLambda=!1,this.color=new Color(0,17,173),this.setExtent(new Point(230,4*this.corner+this.cSlotPadding),silently)},CSlotMorph.prototype.getSpec=function(){return"%c"},CSlotMorph.prototype.mappedCode=function(definitions){var code=StageMorph.prototype.codeMappings.reify||"<#1>",codeLines=code.split("\n"),nested=this.nestedBlock(),part=nested?nested.mappedCode(definitions):"",partLines=part.toString().split("\n"),rx=new RegExp("<#1>","g");
return codeLines.forEach(function(codeLine,idx){var indent,prefix="";0===codeLine.trimLeft().indexOf("<#1>")&&(indent=codeLine.indexOf("<#1>"),prefix=codeLine.slice(0,indent)),codeLines[idx]=codeLine.replace(new RegExp("<#1>"),partLines.join("\n"+prefix)),codeLines[idx]=codeLines[idx].replace(rx,partLines.join("\n"))}),codeLines.join("\n")},CSlotMorph.prototype.fixLayout=function(){var nb=this.nestedBlock();nb?(nb.setPosition(new Point(this.left()+this.inset,this.top()+this.corner)),this.setHeight(nb.fullBounds().height()+this.corner),this.setWidth(nb.fullBounds().width()+2*this.cSlotPadding)):(this.setHeight(4*this.corner+this.cSlotPadding),this.setWidth(4*this.corner+2*this.inset+this.dent+2*this.cSlotPadding)),
this.parent.fixLayout&&this.parent.fixLayout()},CSlotMorph.prototype.drawNew=function(){var context;this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),context=this.image.getContext("2d"),context.fillStyle=this.cachedClr,this.drawFlat(context),MorphicPreferences.isFlat||(this.drawTopRightEdge(context),this.drawTopEdge(context,this.inset,this.corner),this.drawTopLeftEdge(context),this.drawBottomEdge(context),this.drawRightEdge(context))},CSlotMorph.prototype.drawFlat=function(context){context.beginPath(),context.moveTo(0,0),context.lineTo(this.width(),0),context.arc(this.width()-this.corner,0,this.corner,radians(90),radians(0),!0),
context.lineTo(this.width()-this.corner,this.corner),context.lineTo(2*this.inset+3*this.corner+this.dent,this.corner),context.lineTo(2*this.inset+2*this.corner+this.dent,2*this.corner),context.lineTo(2*this.inset+2*this.corner,2*this.corner),context.lineTo(2*this.inset+this.corner,this.corner),context.lineTo(this.inset+this.corner,this.corner),context.arc(this.inset+this.corner,2*this.corner,this.corner,radians(270),radians(180),!0),context.lineTo(this.inset,this.height()-2*this.corner),context.arc(this.inset+this.corner,this.height()-2*this.corner,this.corner,radians(180),radians(90),!0),context.lineTo(this.width()-this.corner,this.height()-this.corner),context.arc(this.width()-this.corner,this.height(),this.corner,radians(-90),radians(-0),!1),
context.lineTo(0,this.height()),context.closePath(),context.fill()},CSlotMorph.prototype.drawTopRightEdge=function(context){var gradient,shift=.5*this.edge,x=this.width()-this.corner,y=0;gradient=context.createRadialGradient(x,y,this.corner,x,y,this.corner-this.edge),gradient.addColorStop(0,this.cachedClrDark),gradient.addColorStop(1,this.cachedClr),context.lineWidth=this.edge,context.lineJoin="round",context.lineCap="round",context.strokeStyle=gradient,context.beginPath(),context.arc(x,y,this.corner-shift,radians(90),radians(0),!0),context.stroke()},CSlotMorph.prototype.drawTopEdge=function(context,x,y){var upperGradient,lowerGradient,rightGradient,shift=.5*this.edge,indent=x+2*this.corner+this.inset;
context.lineWidth=this.edge,context.lineJoin="round",context.lineCap="round",upperGradient=context.createLinearGradient(0,y-this.edge,0,y),upperGradient.addColorStop(0,this.cachedClr),upperGradient.addColorStop(1,this.cachedClrDark),context.strokeStyle=upperGradient,context.beginPath(),context.moveTo(x+this.corner,y-shift),context.lineTo(x+this.corner+this.inset-shift,y-shift),context.stroke(),lowerGradient=context.createLinearGradient(0,y+this.corner-this.edge,0,y+this.corner),lowerGradient.addColorStop(0,this.cachedClr),lowerGradient.addColorStop(1,this.cachedClrDark),context.strokeStyle=lowerGradient,context.beginPath(),context.moveTo(indent+shift,y+this.corner-shift),
context.lineTo(indent+this.dent,y+this.corner-shift),context.stroke(),rightGradient=context.createLinearGradient(x+this.inset+2*this.corner+this.dent-shift,y+this.corner-shift-shift,x+this.inset+2*this.corner+this.dent+.7*shift,y+this.corner-shift+.7*shift),rightGradient.addColorStop(0,this.cachedClr),rightGradient.addColorStop(1,this.cachedClrDark),context.strokeStyle=rightGradient,context.beginPath(),context.moveTo(x+this.inset+2*this.corner+this.dent,y+this.corner-shift),context.lineTo(x+3*this.corner+this.inset+this.dent,y-shift),context.stroke(),context.strokeStyle=upperGradient,context.beginPath(),context.moveTo(x+3*this.corner+this.inset+this.dent,y-shift),
context.lineTo(this.width()-this.corner,y-shift),context.stroke()},CSlotMorph.prototype.drawTopLeftEdge=function(context){var gradient,shift=.5*this.edge;gradient=context.createRadialGradient(this.corner+this.inset,2*this.corner,this.corner,this.corner+this.inset,2*this.corner,this.corner+this.edge),gradient.addColorStop(0,this.cachedClrDark),gradient.addColorStop(1,this.cachedClr),context.lineWidth=this.edge,context.lineJoin="round",context.lineCap="round",context.strokeStyle=gradient,context.beginPath(),context.arc(this.corner+this.inset,2*this.corner,this.corner+shift,radians(-180),radians(-90),!1),context.stroke()},CSlotMorph.prototype.drawRightEdge=function(context){
var gradient,shift=.5*this.edge,x=this.inset;gradient=context.createLinearGradient(x-this.edge,0,x,0),gradient.addColorStop(0,this.cachedClr),gradient.addColorStop(1,this.cachedClrDark),context.lineWidth=this.edge,context.lineJoin="round",context.lineCap="round",context.strokeStyle=gradient,context.beginPath(),context.moveTo(x-shift,2*this.corner),context.lineTo(x-shift,this.height()-2*this.corner),context.stroke()},CSlotMorph.prototype.drawBottomEdge=function(context){var gradient,upperGradient,shift=.5*this.edge;context.lineWidth=this.edge,context.lineJoin="round",context.lineCap="round",upperGradient=context.createRadialGradient(this.corner+this.inset,this.height()-2*this.corner,this.corner,this.corner+this.inset,this.height()-2*this.corner,this.corner+this.edge),
upperGradient.addColorStop(0,this.cachedClrBright),upperGradient.addColorStop(1,this.cachedClr),context.strokeStyle=upperGradient,context.beginPath(),context.arc(this.corner+this.inset,this.height()-2*this.corner,this.corner+shift,radians(180),radians(90),!0),context.stroke(),gradient=context.createLinearGradient(0,this.height()-this.corner,0,this.height()-this.corner+this.edge),gradient.addColorStop(0,this.cachedClrBright),gradient.addColorStop(1,this.cachedClr),context.strokeStyle=gradient,context.beginPath(),context.moveTo(this.inset+this.corner,this.height()-this.corner+shift),context.lineTo(this.width()-this.corner,this.height()-this.corner+shift),context.stroke();
},InputSlotMorph.prototype=new ArgMorph,InputSlotMorph.prototype.constructor=InputSlotMorph,InputSlotMorph.uber=ArgMorph.prototype,InputSlotMorph.prototype.init=function(text,isNumeric,choiceDict,isReadOnly){var contents=new StringMorph(""),arrow=new ArrowMorph("down",0,Math.max(Math.floor(this.fontSize/6),1));contents.fontSize=this.fontSize,contents.isShowingBlanks=!0,contents.drawNew(),this.isUnevaluated=!1,this.choices=choiceDict||null,this.oldContentsExtent=contents.extent(),this.isNumeric=isNumeric||!1,this.isReadOnly=isReadOnly||!1,this.minWidth=0,this.constant=null,InputSlotMorph.uber.init.call(this,null,!0),this.color=new Color(255,255,255),this.add(contents),
this.add(arrow),contents.isEditable=!0,contents.isDraggable=!1,contents.enableSelecting(),this.setContents(text)},InputSlotMorph.prototype.getSpec=function(){return this.isNumeric?"%n":"%s"},InputSlotMorph.prototype.contents=function(){return detect(this.children,function(child){return child instanceof StringMorph})},InputSlotMorph.prototype.arrow=function(){return detect(this.children,function(child){return child instanceof ArrowMorph})},InputSlotMorph.prototype.setContents=function(aStringOrFloat){var cnts=this.contents(),dta=aStringOrFloat,isConstant=dta instanceof Array;if(isConstant)dta=localize(dta[0]),cnts.isItalic=!this.isReadOnly;else if(cnts.isItalic=!1,
!isNil(this.choices)&&this.choices[dta]instanceof Array)return this.setContents(this.choices[dta]);cnts.text=dta,isNil(dta)?cnts.text="":dta.toString&&(cnts.text=dta.toString()),cnts.drawNew(),this.isReadOnly&&this.parent instanceof BlockMorph&&this.parent.fixLabelColor(),this.constant=isConstant?aStringOrFloat:null},InputSlotMorph.prototype.userSetContents=function(aStringOrFloat){this.selectForEdit().setContents(aStringOrFloat)},InputSlotMorph.prototype.dropDownMenu=function(enableKeyboard){var menu=this.menuFromDict(this.choices,null,enableKeyboard);menu&&menu.items.length>0&&(enableKeyboard?(menu.popup(this.world(),this.bottomLeft()),menu.getFocus()):menu.popUpAtHand(this.world()));
},InputSlotMorph.prototype.menuFromDict=function(choices,noEmptyOption,enableKeyboard){var key,menu=new MenuMorph(this.userSetContents,null,this,this.fontSize);if(choices instanceof Function)choices=choices.call(this);else if(isString(choices)&&(choices=this[choices](enableKeyboard),!choices))return;noEmptyOption||menu.addItem(" ",null);for(key in choices)Object.prototype.hasOwnProperty.call(choices,key)&&("~"===key[0]?menu.addLine():choices[key]instanceof Object&&!(choices[key]instanceof Array)&&"function"!=typeof choices[key]?menu.addMenu(key,this.menuFromDict(choices[key],!0)):menu.addItem(key,choices[key]));return menu},InputSlotMorph.prototype.messagesMenu=function(){
var dict={},rcvr=this.parentThatIsA(BlockMorph).scriptTarget(),stage=rcvr.parentThatIsA(StageMorph),myself=this,allNames=[];return stage.children.concat(stage).forEach(function(morph){isSnapObject(morph)&&(allNames=allNames.concat(morph.allMessageNames()))}),allNames.forEach(function(name){dict[name]=name}),allNames.length>0&&(dict["~"]=null),dict["new..."]=function(){new DialogBoxMorph(myself,myself.setContents,myself).prompt("Message name",null,myself.world())},dict},InputSlotMorph.prototype.messagesReceivedMenu=function(){var dict={"any message":["any message"]},rcvr=this.parentThatIsA(BlockMorph).scriptTarget(),stage=rcvr.parentThatIsA(StageMorph),myself=this,allNames=[];
return stage.children.concat(stage).forEach(function(morph){isSnapObject(morph)&&(allNames=allNames.concat(morph.allMessageNames()))}),allNames.forEach(function(name){dict[name]=name}),dict["~"]=null,dict["new..."]=function(){new DialogBoxMorph(myself,myself.setContents,myself).prompt("Message name",null,myself.world())},dict},InputSlotMorph.prototype.collidablesMenu=function(){var dict={"mouse-pointer":["mouse-pointer"],edge:["edge"],"pen trails":["pen trails"]},rcvr=this.parentThatIsA(BlockMorph).scriptTarget(),stage=rcvr.parentThatIsA(StageMorph),allNames=[];return stage.children.forEach(function(morph){morph instanceof SpriteMorph&&!morph.isTemporary&&morph.name!==rcvr.name&&(allNames=allNames.concat(morph.name));
}),allNames.length>0&&(dict["~"]=null,allNames.forEach(function(name){dict[name]=name})),dict},InputSlotMorph.prototype.distancesMenu=function(){var dict={"mouse-pointer":["mouse-pointer"]},rcvr=this.parentThatIsA(BlockMorph).scriptTarget(),stage=rcvr.parentThatIsA(StageMorph),allNames=[];return stage.children.forEach(function(morph){morph instanceof SpriteMorph&&!morph.isTemporary&&morph.name!==rcvr.name&&(allNames=allNames.concat(morph.name))}),allNames.length>0&&(dict["~"]=null,allNames.forEach(function(name){dict[name]=name})),dict},InputSlotMorph.prototype.clonablesMenu=function(){var dict={},rcvr=this.parentThatIsA(BlockMorph).scriptTarget(),stage=rcvr.parentThatIsA(StageMorph),allNames=[];
return rcvr instanceof SpriteMorph&&(dict.myself=["myself"]),stage.children.forEach(function(morph){morph instanceof SpriteMorph&&!morph.isTemporary&&(allNames=allNames.concat(morph.name))}),allNames.length>0&&(dict["~"]=null,allNames.forEach(function(name){dict[name]=name})),dict},InputSlotMorph.prototype.objectsMenu=function(){var rcvr=this.parentThatIsA(BlockMorph).scriptTarget(),stage=rcvr.parentThatIsA(StageMorph),dict={},allNames=[];return dict[stage.name]=stage.name,stage.children.forEach(function(morph){morph instanceof SpriteMorph&&!morph.isTemporary&&allNames.push(morph.name)}),allNames.length>0&&(dict["~"]=null,allNames.forEach(function(name){dict[name]=name;
})),dict},InputSlotMorph.prototype.typesMenu=function(){var dict={number:["number"],text:["text"],Boolean:["Boolean"],list:["list"]};return SpriteMorph.prototype.enableFirstClass&&(dict.sprite=["sprite"]),dict.costume=["costume"],dict.sound=["sound"],dict.command=["command"],dict.reporter=["reporter"],dict.predicate=["predicate"],dict},InputSlotMorph.prototype.gettablesMenu=function(){var dict={neighbors:["neighbors"],self:["self"],"other sprites":["other sprites"],clones:["clones"],"other clones":["other clones"]};return SpriteMorph.prototype.enableNesting&&(dict.parts=["parts"],dict.anchor=["anchor"]),dict.stage=["stage"],StageMorph.prototype.enableInheritance&&(dict.children=["children"],
dict.parent=["parent"],this.world().isDevMode&&(dict["temporary?"]=["temporary?"])),dict.name=["name"],dict.costumes=["costumes"],dict.sounds=["sounds"],dict["dangling?"]=["dangling?"],dict["rotation x"]=["rotation x"],dict["rotation y"]=["rotation y"],dict["center x"]=["center x"],dict["center y"]=["center y"],dict},InputSlotMorph.prototype.attributesMenu=function(){var obj,block=this.parentThatIsA(BlockMorph),objName=block.inputs()[1].evaluate(),rcvr=block.scriptTarget(),stage=rcvr.parentThatIsA(StageMorph),dict={},varNames=[];return(obj=objName===stage.name?stage:detect(stage.children,function(morph){return morph.name===objName}))?(dict=obj instanceof SpriteMorph?{
"x position":["x position"],"y position":["y position"],direction:["direction"],"costume #":["costume #"],"costume name":["costume name"],size:["size"]}:{"costume #":["costume #"],"costume name":["costume name"]},varNames=obj.variables.names(),varNames.length>0&&(dict["~"]=null,varNames.forEach(function(name){dict[name]=name})),dict):dict},InputSlotMorph.prototype.costumesMenu=function(){var dict,rcvr=this.parentThatIsA(BlockMorph).scriptTarget(),allNames=[];return dict=rcvr instanceof SpriteMorph?{Turtle:["Turtle"]}:{Empty:["Empty"]},rcvr.costumes.asArray().forEach(function(costume){allNames=allNames.concat(costume.name)}),allNames.length>0&&(dict["~"]=null,
allNames.forEach(function(name){dict[name]=name})),dict},InputSlotMorph.prototype.soundsMenu=function(){var rcvr=this.parentThatIsA(BlockMorph).scriptTarget(),allNames=[],dict={};return rcvr.sounds.asArray().forEach(function(sound){allNames=allNames.concat(sound.name)}),allNames.length>0&&allNames.forEach(function(name){dict[name]=name}),dict},InputSlotMorph.prototype.shadowedVariablesMenu=function(){var vars,attribs,rcvr,block=this.parentThatIsA(BlockMorph),dict={};return block?(rcvr=block.scriptTarget(),this.parentThatIsA(RingMorph)?(vars=rcvr.variables.names(),vars.forEach(function(name){dict[name]=name}),attribs=rcvr.attributes,attribs.forEach(function(name){
dict[name]=[name]})):rcvr&&rcvr.exemplar&&(vars=rcvr.inheritedVariableNames(!0),vars.forEach(function(name){dict[name]=name}),attribs=rcvr.shadowedAttributes(),attribs.forEach(function(name){dict[name]=[name]})),dict):dict},InputSlotMorph.prototype.pianoKeyboardMenu=function(){var menu,block,instrument;block=this.parentThatIsA(BlockMorph),block&&(instrument=block.scriptTarget().instrument),menu=new PianoMenuMorph(this.setContents,this,this.fontSize,instrument),menu.popup(this.world(),new Point(this.right()-menu.width()/2,this.bottom())),menu.selectKey(this.evaluate())},InputSlotMorph.prototype.setChoices=function(dict,readonly){var cnts=this.contents();this.choices=dict,
this.isReadOnly=readonly||!1,this.parent instanceof BlockMorph&&(this.parent.fixLabelColor(),readonly||(cnts.shadowOffset=new Point,cnts.shadowColor=null,cnts.setColor(new Color(0,0,0)))),this.fixLayout()},InputSlotMorph.prototype.fixLayout=function(){var width,height,arrowWidth,contents=this.contents(),arrow=this.arrow();contents.isNumeric=this.isNumeric,contents.isEditable=!this.isReadOnly,this.isReadOnly?(contents.disableSelecting(),contents.color=new Color(254,254,254)):(contents.enableSelecting(),contents.color=new Color(0,0,0)),this.choices?(arrow.setSize(this.fontSize),arrow.show()):arrow.hide(),arrowWidth=arrow.isVisible?arrow.width():0,height=contents.height()+2*this.edge,
width=this.isNumeric?contents.width()+Math.floor(.5*arrowWidth)+height+2*this.typeInPadding:Math.max(contents.width()+arrowWidth+2*this.edge+2*this.typeInPadding,contents.rawHeight?contents.rawHeight()+arrowWidth:fontHeight(contents.fontSize)/1.3+arrowWidth,this.minWidth),this.setExtent(new Point(width,height)),this.isNumeric?contents.setPosition(new Point(Math.floor(height/2),this.edge).add(new Point(this.typeInPadding,0)).add(this.position())):contents.setPosition(new Point(this.edge,this.edge).add(new Point(this.typeInPadding,0)).add(this.position())),arrow.isVisible&&arrow.setPosition(new Point(this.right()-arrowWidth-this.edge,contents.top())),this.parent&&this.parent.fixLayout&&(this.world()?(this.startLayout(),
this.parent.fixLayout(),this.endLayout()):this.parent.fixLayout())},InputSlotMorph.prototype.mouseDownLeft=function(pos){var world;this.isReadOnly||this.arrow().bounds.containsPoint(pos)?this.escalateEvent("mouseDownLeft",pos):(world=this.world(),world&&world.stopEditing(),this.selectForEdit().contents().edit())},InputSlotMorph.prototype.mouseClickLeft=function(pos){this.arrow().bounds.containsPoint(pos)?this.dropDownMenu():this.isReadOnly?this.dropDownMenu():this.contents().edit()},InputSlotMorph.prototype.reactToKeystroke=function(){var cnts;this.constant&&(cnts=this.contents(),this.constant=null,cnts.isItalic=!1,cnts.drawNew())},InputSlotMorph.prototype.reactToEdit=function(){
this.contents().clearSelection()},InputSlotMorph.prototype.freshTextEdit=function(aStringOrTextMorph){this.onNextStep=function(){aStringOrTextMorph.selectAll()}},InputSlotMorph.prototype.userMenu=function(){var menu=new MenuMorph(this);return StageMorph.prototype.enableCodeMapping?(this.isNumeric?menu.addItem("code number mapping...","mapNumberToCode"):menu.addItem("code string mapping...","mapStringToCode"),menu):this.parent.userMenu()},InputSlotMorph.prototype.mapStringToCode=function(){new DialogBoxMorph(this,function(code){StageMorph.prototype.codeMappings.string=code},this).promptCode("Code mapping - String <#1>",StageMorph.prototype.codeMappings.string||"",this.world());
},InputSlotMorph.prototype.mapNumberToCode=function(){new DialogBoxMorph(this,function(code){StageMorph.prototype.codeMappings.number=code},this).promptCode("Code mapping - Number <#1>",StageMorph.prototype.codeMappings.number||"",this.world())},InputSlotMorph.prototype.mappedCode=function(){var code,block=this.parentThatIsA(BlockMorph),val=this.evaluate();return this.isNumeric?(code=StageMorph.prototype.codeMappings.number||"<#1>",code.replace(/<#1>/g,val)):isNaN(parseFloat(val))&&isString(val)?block&&contains(["doSetVar","doChangeVar","doShowVar","doHideVar"],block.selector)?val:(code=StageMorph.prototype.codeMappings.string||"<#1>",code.replace(/<#1>/g,val)):val;
},InputSlotMorph.prototype.evaluate=function(){var num,contents=this.contents();return this.constant?this.constant:this.isNumeric&&(num=parseFloat(contents.text||"0"),!isNaN(num))?num:contents.text},InputSlotMorph.prototype.isEmptySlot=function(){return""===this.contents().text},InputSlotMorph.prototype.flash=function(){this.cachedNormalColor||(this.cachedNormalColor=this.color,this.color=this.activeHighlight,this.drawNew(),this.changed())},InputSlotMorph.prototype.unflash=function(){if(this.cachedNormalColor){var clr=this.cachedNormalColor;this.cachedNormalColor=null,this.color=clr,this.drawNew(),this.changed()}},InputSlotMorph.prototype.drawNew=function(){var context,borderColor,r;
this.image=newCanvas(this.extent()),context=this.image.getContext("2d"),borderColor=this.cachedNormalColor?this.color:this.parent?this.parent.color:new Color(120,120,120),context.fillStyle=this.color.toString(),this.isReadOnly&&!this.cachedNormalColor&&(context.fillStyle=borderColor.darker().toString()),this.cachedClr=borderColor.toString(),this.cachedClrBright=borderColor.lighter(this.contrast).toString(),this.cachedClrDark=borderColor.darker(this.contrast).toString(),this.isNumeric?(r=(this.height()-2*this.edge)/2,context.beginPath(),context.arc(r+this.edge,r+this.edge,r,radians(90),radians(-90),!1),context.arc(this.width()-r-this.edge,r+this.edge,r,radians(-90),radians(90),!1),
context.closePath(),context.fill(),MorphicPreferences.isFlat||this.drawRoundBorder(context)):(context.fillRect(this.edge,this.edge,this.width()-2*this.edge,this.height()-2*this.edge),MorphicPreferences.isFlat||this.drawRectBorder(context))},InputSlotMorph.prototype.drawRectBorder=function(context){var gradient,shift=.5*this.edge;context.lineWidth=this.edge,context.lineJoin="round",context.lineCap="round",context.shadowOffsetY=shift,context.shadowBlur=this.edge,context.shadowColor=this.color.darker(80).toString(),gradient=context.createLinearGradient(0,0,0,this.edge),gradient.addColorStop(0,this.cachedClr),gradient.addColorStop(1,this.cachedClrDark),context.strokeStyle=gradient,
context.beginPath(),context.moveTo(this.edge,shift),context.lineTo(this.width()-this.edge-shift,shift),context.stroke(),context.shadowOffsetY=0,gradient=context.createLinearGradient(0,0,this.edge,0),gradient.addColorStop(0,this.cachedClr),gradient.addColorStop(1,this.cachedClrDark),context.strokeStyle=gradient,context.beginPath(),context.moveTo(shift,this.edge),context.lineTo(shift,this.height()-this.edge-shift),context.stroke(),context.shadowOffsetX=0,context.shadowOffsetY=0,context.shadowBlur=0,gradient=context.createLinearGradient(0,this.height()-this.edge,0,this.height()),gradient.addColorStop(0,this.cachedClrBright),gradient.addColorStop(1,this.cachedClr),
context.strokeStyle=gradient,context.beginPath(),context.moveTo(this.edge,this.height()-shift),context.lineTo(this.width()-this.edge,this.height()-shift),context.stroke(),gradient=context.createLinearGradient(this.width()-this.edge,0,this.width(),0),gradient.addColorStop(0,this.cachedClrBright),gradient.addColorStop(1,this.cachedClr),context.strokeStyle=gradient,context.beginPath(),context.moveTo(this.width()-shift,this.edge),context.lineTo(this.width()-shift,this.height()-this.edge),context.stroke()},InputSlotMorph.prototype.drawRoundBorder=function(context){var start,end,gradient,shift=.5*this.edge,r=(this.height()-2*this.edge)/2;context.lineWidth=this.edge,
context.lineJoin="round",context.lineCap="round",start=r+this.edge,end=this.width()-r-this.edge,end>start&&(context.shadowOffsetX=shift,context.shadowOffsetY=shift,context.shadowBlur=this.edge,context.shadowColor=this.color.darker(80).toString(),gradient=context.createLinearGradient(0,0,0,this.edge),gradient.addColorStop(0,this.cachedClr),gradient.addColorStop(1,this.cachedClrDark),context.strokeStyle=gradient,context.beginPath(),context.moveTo(start,shift),context.lineTo(end,shift),context.stroke(),context.shadowOffsetX=0,context.shadowOffsetY=0,context.shadowBlur=0),gradient=context.createLinearGradient(0,this.height()-this.edge,0,this.height()),gradient.addColorStop(0,this.cachedClrBright),
gradient.addColorStop(1,this.cachedClr),context.strokeStyle=gradient,context.beginPath(),context.moveTo(r+this.edge,this.height()-shift),context.lineTo(this.width()-r-this.edge,this.height()-shift),context.stroke(),r=this.height()/2,context.shadowOffsetX=shift,context.shadowOffsetY=shift,context.shadowBlur=this.edge,context.shadowColor=this.color.darker(80).toString(),gradient=context.createRadialGradient(r,r,r-this.edge,r,r,r),gradient.addColorStop(1,this.cachedClr),gradient.addColorStop(0,this.cachedClrDark),context.strokeStyle=gradient,context.beginPath(),context.arc(r,r,r-shift,radians(180),radians(270),!1),context.stroke(),context.shadowOffsetX=0,context.shadowOffsetY=0,
context.shadowBlur=0,gradient=context.createRadialGradient(this.width()-r,r,r-this.edge,this.width()-r,r,r),gradient.addColorStop(1,this.cachedClr),gradient.addColorStop(0,this.cachedClrBright),context.strokeStyle=gradient,context.beginPath(),context.arc(this.width()-r,r,r-shift,radians(0),radians(90),!1),context.stroke()},TemplateSlotMorph.prototype=new ArgMorph,TemplateSlotMorph.prototype.constructor=TemplateSlotMorph,TemplateSlotMorph.uber=ArgMorph.prototype,TemplateSlotMorph.prototype.init=function(name){var template=new ReporterBlockMorph;this.labelString=name||"",template.isDraggable=!1,template.isTemplate=!0,void 0!==modules.objects?(template.color=SpriteMorph.prototype.blockColor.variables,
template.category="variables"):(template.color=new Color(243,118,29),template.category=null),template.setSpec(this.labelString),template.selector="reportGetVar",TemplateSlotMorph.uber.init.call(this),this.add(template),this.fixLayout(),this.isDraggable=!1,this.isStatic=!0},TemplateSlotMorph.prototype.getSpec=function(){return"%t"},TemplateSlotMorph.prototype.template=function(){return this.children[0]},TemplateSlotMorph.prototype.contents=function(){return this.template().blockSpec},TemplateSlotMorph.prototype.setContents=function(aString){var tmp=this.template();tmp.setSpec(aString),tmp.fixBlockColor(),tmp.fixLabelColor()},TemplateSlotMorph.prototype.evaluate=function(){
return this.contents()},TemplateSlotMorph.prototype.fixLayout=function(){var template=this.template();this.setExtent(template.extent().add(2*this.edge+2)),template.setPosition(this.position().add(this.edge+1)),this.parent&&this.parent.fixLayout&&this.parent.fixLayout()},TemplateSlotMorph.prototype.wantsDropOf=function(aMorph){return"reportGetVar"===aMorph.selector},TemplateSlotMorph.prototype.reactToDropOf=function(droppedMorph){"reportGetVar"===droppedMorph.selector&&droppedMorph.destroy()},TemplateSlotMorph.prototype.drawNew=function(){var context;this.parent instanceof Morph&&(this.color=this.parent.color.copy()),this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),
this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),context=this.image.getContext("2d"),context.fillStyle=this.cachedClr,this.drawRounded(context)},TemplateSlotMorph.prototype.drawRounded=ReporterBlockMorph.prototype.drawRounded,TemplateSlotMorph.prototype.flash=function(){this.template().flash()},TemplateSlotMorph.prototype.unflash=function(){this.template().unflash()},BooleanSlotMorph.prototype=new ArgMorph,BooleanSlotMorph.prototype.constructor=BooleanSlotMorph,BooleanSlotMorph.uber=ArgMorph.prototype,BooleanSlotMorph.prototype.isTernary=!0,BooleanSlotMorph.prototype.init=function(initialValue){this.value="boolean"==typeof initialValue?initialValue:null,
this.isUnevaluated=!1,BooleanSlotMorph.uber.init.call(this)},BooleanSlotMorph.prototype.getSpec=function(){return this.isUnevaluated?"%boolUE":"%b"},BooleanSlotMorph.prototype.evaluate=function(){return this.value},BooleanSlotMorph.prototype.isEmptySlot=function(){return null===this.value},BooleanSlotMorph.prototype.isBinary=function(){return!this.isTernary&&isNil(this.parentThatIsA(RingMorph))&&!isNil(this.parentThatIsA(ScriptsMorph))},BooleanSlotMorph.prototype.setContents=function(boolOrNull,silently){this.value="boolean"==typeof boolOrNull?boolOrNull:null,silently||(this.drawNew(),this.changed())},BooleanSlotMorph.prototype.toggleValue=function(){var ide,target=this.selectForEdit();
if(target!==this)return this.toggleValue.call(target);if(ide=this.parentThatIsA(IDE_Morph),this.isStatic||this.isBinary())this.setContents(!this.value,!0);else switch(this.value){case!0:this.value=!1;break;case!1:this.value=null;break;default:this.value=!0}return ide&&!ide.isAnimating?(this.drawNew(),void this.changed()):(this.drawNew(3),this.changed(),void this.nextSteps([function(){this.drawNew(2),this.changed()},function(){this.drawNew(1),this.changed()},function(){this.drawNew(),this.changed()}]))},BooleanSlotMorph.prototype.mouseClickLeft=function(){this.toggleValue(),isNil(this.value)||this.reactToSliderEdit()},BooleanSlotMorph.prototype.mouseEnter=function(){
if(!this.isStatic){if(this.value===!1&&!this.isBinary()){var oldValue=this.value;return this.value=null,this.drawNew(3),this.changed(),void(this.value=oldValue)}this.drawNew(1),this.changed()}},BooleanSlotMorph.prototype.mouseLeave=function(){this.isStatic||(this.drawNew(),this.changed())},BooleanSlotMorph.prototype.userMenu=function(){var menu=new MenuMorph(this);return StageMorph.prototype.enableCodeMapping?(this.evaluate()===!0?menu.addItem("code true mapping...","mapTrueToCode"):menu.addItem("code false mapping...","mapFalseToCode"),menu):this.parent.userMenu()},BooleanSlotMorph.prototype.mapTrueToCode=function(){new DialogBoxMorph(this,function(code){StageMorph.prototype.codeMappings.true=code;
},this).promptCode("Code mapping - true",StageMorph.prototype.codeMappings.true||"true",this.world())},BooleanSlotMorph.prototype.mapFalseToCode=function(){new DialogBoxMorph(this,function(code){StageMorph.prototype.codeMappings.false=code},this).promptCode("Code mapping - false",StageMorph.prototype.codeMappings.false||"false",this.world())},BooleanSlotMorph.prototype.mappedCode=function(){return this.evaluate()===!0?StageMorph.prototype.codeMappings.boolTrue||"true":StageMorph.prototype.codeMappings.boolFalse||"false"},BooleanSlotMorph.prototype.drawNew=function(progress){var context,h,textLabel=this.isStatic?this.textLabel():null;textLabel?(h=textLabel.height+3*this.edge,
this.silentSetExtent(new Point(textLabel.width+1.5*h+2*this.edge,h))):this.silentSetExtent(new Point(2*(this.fontSize+2*this.edge),this.fontSize+2*this.edge)),this.cachedNormalColor||(this.color=this.parent?this.parent.color:new Color(200,200,200)),this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),context=this.image.getContext("2d"),this.drawDiamond(context,progress),this.drawLabel(context,textLabel),this.drawKnob(context,progress)},BooleanSlotMorph.prototype.drawDiamond=function(context,progress){var gradient,w=this.width(),h=this.height(),r=h/2,w2=w/2,shift=this.edge/2;if(this.cachedNormalColor)context.fillStyle=this.color.toString();else switch(this.value){
case!0:context.fillStyle="rgb(0, 200, 0)";break;case!1:context.fillStyle="rgb(200, 0, 0)";break;default:context.fillStyle=this.color.darker(25).toString()}progress&&!this.isEmptySlot()?(context.fillStyle="rgb(0, 200, 0)",context.beginPath(),context.moveTo(0,r),context.lineTo(r,0),context.lineTo(w2,0),context.lineTo(w2,h),context.lineTo(r,h),context.closePath(),context.fill(),context.fillStyle="rgb(200, 0, 0)",context.beginPath(),context.moveTo(w2,0),context.lineTo(w-r,0),context.lineTo(w,r),context.lineTo(w-r,h),context.lineTo(w2,h),context.closePath(),context.fill()):(context.beginPath(),context.moveTo(0,r),context.lineTo(r,0),context.lineTo(w-r,0),context.lineTo(w,r),
context.lineTo(w-r,h),context.lineTo(r,h),context.closePath(),context.fill()),MorphicPreferences.isFlat||(context.lineWidth=this.edge,context.lineJoin="round",context.lineCap="round",context.shadowOffsetX=shift,context.shadowBlur=shift,context.shadowColor="black",gradient=context.createLinearGradient(0,r,.6*this.edge,r+.6*this.edge),gradient.addColorStop(1,this.cachedClrDark),gradient.addColorStop(0,this.cachedClr),context.strokeStyle=gradient,context.beginPath(),context.moveTo(shift,r),context.lineTo(r,shift),context.closePath(),context.stroke(),context.shadowOffsetX=0,context.shadowOffsetY=shift,context.shadowBlur=this.edge,gradient=context.createLinearGradient(0,0,0,this.edge),
gradient.addColorStop(1,this.cachedClrDark),gradient.addColorStop(0,this.cachedClr),context.strokeStyle=gradient,context.beginPath(),context.moveTo(r,shift),context.lineTo(w-r,shift),context.closePath(),context.stroke(),context.shadowOffsetY=0,context.shadowBlur=0,gradient=context.createLinearGradient(w-r-.6*this.edge,h-.6*this.edge,w-r,h),gradient.addColorStop(1,this.cachedClr),gradient.addColorStop(0,this.cachedClrBright),context.strokeStyle=gradient,context.beginPath(),context.moveTo(w-r,h-shift),context.lineTo(w-shift,r),context.closePath(),context.stroke(),gradient=context.createLinearGradient(0,h-this.edge,0,h),gradient.addColorStop(1,this.cachedClr),gradient.addColorStop(0,this.cachedClrBright),
context.strokeStyle=gradient,context.beginPath(),context.moveTo(r,h-shift),context.lineTo(w-r-shift,h-shift),context.closePath(),context.stroke())},BooleanSlotMorph.prototype.drawLabel=function(context,textLabel){var x,w=this.width(),r=this.height()/2-this.edge,r2=r/2,shift=this.edge/2,y=this.height()/2;if(!this.isEmptySlot()){if(textLabel)return y=(this.height()-textLabel.height)/2,x=this.value?this.height()/2:this.width()-this.height()/2-textLabel.width,MorphicPreferences.isFlat||(context.shadowOffsetX=-shift,context.shadowOffsetY=-shift,context.shadowBlur=shift,context.shadowColor=this.value?"rgb(0, 100, 0)":"rgb(100, 0, 0)"),void context.drawImage(textLabel,x,y);
x=r+2*this.edge+shift,MorphicPreferences.isFlat||(context.shadowOffsetX=-shift,context.shadowOffsetY=-shift,context.shadowBlur=shift,context.shadowColor="rgb(0, 100, 0)"),context.strokeStyle="white",context.lineWidth=this.edge+shift,context.lineCap="round",context.lineJoin="miter",context.beginPath(),context.moveTo(x-r2,y),context.lineTo(x,y+r2),context.lineTo(x+r2,r2+this.edge),context.stroke(),x=w-y-2*this.edge,MorphicPreferences.isFlat||(context.shadowOffsetX=-shift,context.shadowOffsetY=-shift,context.shadowBlur=shift,context.shadowColor="rgb(100, 0, 0)"),context.strokeStyle="white",context.lineWidth=this.edge,context.lineCap="butt",context.beginPath(),context.moveTo(x-r2,y-r2),
context.lineTo(x+r2,y+r2),context.moveTo(x-r2,y+r2),context.lineTo(x+r2,y-r2),context.stroke()}},BooleanSlotMorph.prototype.drawKnob=function(context,progress){var gradient,x,w=this.width(),r=this.height()/2,shift=this.edge/2,slideStep=(this.width()-this.height())/4*(progress||0),y=r,outline=PushButtonMorph.prototype.outline/2,outlineColor=PushButtonMorph.prototype.outlineColor,color=PushButtonMorph.prototype.color,contrast=PushButtonMorph.prototype.contrast,topColor=color.lighter(contrast),bottomColor=color.darker(contrast);switch(this.value){case!1:x=r+slideStep,MorphicPreferences.isFlat||(context.shadowOffsetX=shift,context.shadowOffsetY=0,context.shadowBlur=shift,
context.shadowColor="black");break;case!0:x=w-r-slideStep,MorphicPreferences.isFlat||(context.shadowOffsetX=0,context.shadowOffsetY=0,context.shadowBlur=0);break;default:if(!progress)return;x=r,MorphicPreferences.isFlat||(context.shadowOffsetX=shift,context.shadowOffsetY=0,context.shadowBlur=shift,context.shadowColor="black"),context.globalAlpha=.2*((progress||0)+1)}context.fillStyle=color.toString(),context.beginPath(),context.arc(x,y,r,radians(0),radians(360)),context.closePath(),context.fill(),MorphicPreferences.isFlat||(context.shadowOffsetX=0,context.shadowBlur=0,context.shadowColor="black",context.lineWidth=outline,context.strokeStyle=outlineColor.toString(),
context.beginPath(),context.arc(x,y,r-outline/2,radians(0),radians(360)),context.stroke(),gradient=context.createRadialGradient(x,y,r-outline-this.edge,x,y,r-outline),gradient.addColorStop(1,topColor.toString()),gradient.addColorStop(0,color.toString()),context.strokeStyle=gradient,context.lineCap="round",context.lineWidth=this.edge,context.beginPath(),context.arc(x,y,r-outline-this.edge/2,radians(180),radians(270),!1),context.stroke(),gradient=context.createRadialGradient(x,y,r-outline-this.edge,x,y,r-outline),gradient.addColorStop(1,bottomColor.toString()),gradient.addColorStop(0,color.toString()),context.strokeStyle=gradient,context.lineCap="round",context.lineWidth=this.edge,
context.beginPath(),context.arc(x,y,r-outline-this.edge/2,radians(0),radians(90),!1),context.stroke())},BooleanSlotMorph.prototype.textLabel=function(){if(this.isEmptySlot())return null;var t,f,img,lbl,x,y;return t=new StringMorph(localize("true"),this.fontSize,null,!0,null,null,null,null,new Color(255,255,255)).image,f=new StringMorph(localize("false"),this.fontSize,null,!0,null,null,null,null,new Color(255,255,255)).image,img=newCanvas(new Point(Math.max(t.width,f.width),Math.max(t.height,f.height))),lbl=this.value?t:f,x=(img.width-lbl.width)/2,y=(img.height-lbl.height)/2,img.getContext("2d").drawImage(lbl,x,y),img},ArrowMorph.prototype=new Morph,ArrowMorph.prototype.constructor=ArrowMorph,
ArrowMorph.uber=Morph.prototype,ArrowMorph.prototype.init=function(direction,size,padding,color){this.direction=direction||"down",this.size=size||(0===size?0:50),this.padding=padding||0,ArrowMorph.uber.init.call(this,!0),this.color=color||new Color(0,0,0),this.setExtent(new Point(this.size,this.size))},ArrowMorph.prototype.setSize=function(size){var min=Math.max(size,1);this.size=size,this.setExtent(new Point(min,min))},ArrowMorph.prototype.drawNew=function(){this.image=newCanvas(this.extent());var context=this.image.getContext("2d"),pad=this.padding,h=this.height(),h2=Math.floor(h/2),w=this.width(),w2=Math.floor(w/2);context.fillStyle=this.color.toString(),context.beginPath(),
"down"===this.direction?(context.moveTo(pad,h2),context.lineTo(w-pad,h2),context.lineTo(w2,h-pad)):"up"===this.direction?(context.moveTo(pad,h2),context.lineTo(w-pad,h2),context.lineTo(w2,pad)):"left"===this.direction?(context.moveTo(pad,h2),context.lineTo(w2,pad),context.lineTo(w2,h-pad)):(context.moveTo(w2,pad),context.lineTo(w-pad,h2),context.lineTo(w2,h-pad)),context.closePath(),context.fill()},TextSlotMorph.prototype=new InputSlotMorph,TextSlotMorph.prototype.constructor=TextSlotMorph,TextSlotMorph.uber=InputSlotMorph.prototype,TextSlotMorph.prototype.init=function(text,isNumeric,choiceDict,isReadOnly){var contents=new TextMorph(""),arrow=new ArrowMorph("down",0,Math.max(Math.floor(this.fontSize/6),1));
contents.fontSize=this.fontSize,contents.drawNew(),this.isUnevaluated=!1,this.choices=choiceDict||null,this.oldContentsExtent=contents.extent(),this.isNumeric=isNumeric||!1,this.isReadOnly=isReadOnly||!1,this.minWidth=0,this.constant=null,InputSlotMorph.uber.init.call(this,null,null,null,null,!0),this.color=new Color(255,255,255),this.add(contents),this.add(arrow),contents.isEditable=!0,contents.isDraggable=!1,contents.enableSelecting(),this.setContents(text)},TextSlotMorph.prototype.getSpec=function(){return this.isNumeric?"%mln":"%mlt"},TextSlotMorph.prototype.contents=function(){return detect(this.children,function(child){return child instanceof TextMorph});
},TextSlotMorph.prototype.layoutChanged=function(){this.fixLayout()},ColorSlotMorph.prototype=new ArgMorph,ColorSlotMorph.prototype.constructor=ColorSlotMorph,ColorSlotMorph.uber=ArgMorph.prototype,ColorSlotMorph.prototype.init=function(clr){ColorSlotMorph.uber.init.call(this,null,!0),this.setColor(clr||new Color(145,26,68))},ColorSlotMorph.prototype.getSpec=function(){return"%clr"},ColorSlotMorph.prototype.getUserColor=function(){var myself=this,world=this.world(),hand=world.hand,posInDocument=getDocumentPositionOf(world.worldCanvas),mouseMoveBak=hand.processMouseMove,mouseDownBak=hand.processMouseDown,mouseUpBak=hand.processMouseUp,pal=new ColorPaletteMorph(null,new Point(16*this.fontSize,10*this.fontSize));
world.add(pal),pal.setPosition(this.bottomLeft().add(new Point(0,this.edge))),hand.processMouseMove=function(event){var clr=world.getGlobalPixelColor(hand.position());hand.setPosition(new Point(event.pageX-posInDocument.x,event.pageY-posInDocument.y)),clr.a&&myself.setColor(clr)},hand.processMouseDown=nop,hand.processMouseUp=function(){pal.destroy(),hand.processMouseMove=mouseMoveBak,hand.processMouseDown=mouseDownBak,hand.processMouseUp=mouseUpBak}},ColorSlotMorph.prototype.mouseClickLeft=function(){this.selectForEdit().getUserColor()},ColorSlotMorph.prototype.evaluate=function(){return this.color},ColorSlotMorph.prototype.drawNew=function(){var context,borderColor,side;
side=this.fontSize+2*this.edge+2*this.typeInPadding,this.silentSetExtent(new Point(side,side)),this.image=newCanvas(this.extent()),context=this.image.getContext("2d"),borderColor=this.parent?this.parent.color:new Color(120,120,120),context.fillStyle=this.color.toString(),this.cachedClr=borderColor.toString(),this.cachedClrBright=borderColor.lighter(this.contrast).toString(),this.cachedClrDark=borderColor.darker(this.contrast).toString(),context.fillRect(this.edge,this.edge,this.width()-2*this.edge,this.height()-2*this.edge),MorphicPreferences.isFlat||this.drawRectBorder(context)},ColorSlotMorph.prototype.drawRectBorder=InputSlotMorph.prototype.drawRectBorder,
BlockHighlightMorph.prototype=new Morph,BlockHighlightMorph.prototype.constructor=BlockHighlightMorph,BlockHighlightMorph.uber=Morph.prototype,BlockHighlightMorph.prototype.readout=function(){return this.children.length?this.children[0]:null},BlockHighlightMorph.prototype.updateReadout=function(){var readout=this.readout(),inset=useBlurredShadows&&!MorphicPreferences.isFlat?.4*SyntaxElementMorph.prototype.activeBlur:SyntaxElementMorph.prototype.activeBorder*-2;return this.threadCount<2?void(readout&&readout.destroy()):(readout?(readout.contents=this.threadCount.toString(),readout.fullChanged(),readout.drawNew(),readout.fullChanged()):(readout=new SpeechBubbleMorph(this.threadCount.toString(),this.color,null,null,this.color.darker(),null,1),
this.add(readout)),void readout.setPosition(this.position().add(inset)))},MultiArgMorph.prototype=new ArgMorph,MultiArgMorph.prototype.constructor=MultiArgMorph,MultiArgMorph.uber=ArgMorph.prototype,MultiArgMorph.prototype.init=function(slotSpec,labelTxt,min,eSpec,arrowColor,labelColor,shadowColor,shadowOffset,isTransparent){var label,leftArrow,rightArrow,i,arrows=new FrameMorph;for(this.slotSpec=slotSpec||"%s",this.labelText=localize(labelTxt||""),this.minInputs=min||0,this.elementSpec=eSpec||null,this.labelColor=labelColor||null,this.shadowColor=shadowColor||null,this.shadowOffset=shadowOffset||null,this.canBeEmpty=!0,MultiArgMorph.uber.init.call(this,null,!0),
this.alpha=isTransparent===!1?1:0,arrows.alpha=isTransparent===!1?1:0,arrows.noticesTransparentClick=!0,this.noticesTransparentclick=!0,label=this.labelPart(this.labelText),this.add(label),label.hide(),leftArrow=new ArrowMorph("left",this.fontSize,Math.max(Math.floor(this.fontSize/6),1),arrowColor),rightArrow=new ArrowMorph("right",this.fontSize,Math.max(Math.floor(this.fontSize/6),1),arrowColor),arrows.add(leftArrow),arrows.add(rightArrow),arrows.drawNew(),arrows.acceptsDrops=!1,this.add(arrows),i=0;i<this.minInputs;i+=1)this.addInput()},MultiArgMorph.prototype.label=function(){return this.children[0]},MultiArgMorph.prototype.arrows=function(){return this.children[this.children.length-1];
},MultiArgMorph.prototype.getSpec=function(){return"%mult"+this.slotSpec};MultiArgMorph.prototype.setContents=function(anArray){var i,inputs=this.inputs();for(i=0;i<anArray.length;i+=1)null!==anArray[i]&&inputs[i]&&inputs[i].setContents(anArray[i])};MultiArgMorph.prototype.hide=function(){this.isVisible=!1,this.changed()},MultiArgMorph.prototype.show=function(){this.isVisible=!0,this.changed()},MultiArgMorph.prototype.setLabelColor=function(textColor,shadowColor,shadowOffset){this.textColor=textColor,this.shadowColor=shadowColor,this.shadowOffset=shadowOffset,MultiArgMorph.uber.setLabelColor.call(this,textColor,shadowColor,shadowOffset)},MultiArgMorph.prototype.fixLayout=function(){
if("%t"===this.slotSpec&&(this.isStatic=!0),this.parent){var shadowColor,shadowOffset,label=this.label();this.color=this.parent.color,shadowColor=this.shadowColor||this.parent.color.darker(this.labelContrast),shadowOffset=this.shadowOffset||label.shadowOffset,this.arrows().color=this.color,""!==this.labelText&&(label.shadowColor.eq(shadowColor)||(label.shadowColor=shadowColor,label.shadowOffset=shadowOffset,label.drawNew()))}this.fixArrowsLayout(),MultiArgMorph.uber.fixLayout.call(this),this.parent&&this.parent.fixLayout()},MultiArgMorph.prototype.fixArrowsLayout=function(){var label=this.label(),arrows=this.arrows(),leftArrow=arrows.children[0],rightArrow=arrows.children[1],dim=new Point(rightArrow.width()/2,rightArrow.height());
this.inputs().length<this.minInputs+1?(label.hide(),leftArrow.hide(),rightArrow.setPosition(arrows.position().subtract(new Point(dim.x,0))),arrows.setExtent(dim)):(""!==this.labelText&&label.show(),leftArrow.show(),rightArrow.setPosition(leftArrow.topCenter()),arrows.bounds.corner=rightArrow.bottomRight().copy()),arrows.drawNew()},MultiArgMorph.prototype.refresh=function(){this.inputs().forEach(function(input){input.drawNew()})},MultiArgMorph.prototype.drawNew=function(){MultiArgMorph.uber.drawNew.call(this),this.refresh()},MultiArgMorph.prototype.addInput=function(contents){var i,name,newPart=this.labelPart(this.slotSpec),idx=this.children.length-1;if(contents)newPart.setContents(contents);else if("%scriptVars"===this.elementSpec||"%blockVars"===this.elementSpec){
for(name="",i=idx;i>0;)name=String.fromCharCode(97+(i-1)%26)+name,i=Math.floor((i-1)/26);newPart.setContents(name)}else contains(["%parms","%ringparms"],this.elementSpec)&&newPart.setContents("#"+idx);newPart.parent=this,this.children.splice(idx,0,newPart),newPart.drawNew(),this.fixLayout()},MultiArgMorph.prototype.removeInput=function(){var oldPart,scripts;this.children.length>1&&(oldPart=this.children[this.children.length-2],this.removeChild(oldPart),oldPart instanceof BlockMorph&&(scripts=this.parentThatIsA(ScriptsMorph),scripts&&scripts.add(oldPart))),this.fixLayout()},MultiArgMorph.prototype.mouseClickLeft=function(pos){if(!this.parentThatIsA(ScriptsMorph))return void this.escalateEvent("mouseClickLeft",pos);
var i,target=this.selectForEdit(),arrows=target.arrows(),leftArrow=arrows.children[0],rightArrow=arrows.children[1],repetition=16===target.world().currentKey?3:1;if(target.startLayout(),rightArrow.bounds.containsPoint(pos))for(i=0;i<repetition;i+=1)rightArrow.isVisible&&target.addInput();else if(leftArrow.bounds.containsPoint(pos))for(i=0;i<repetition;i+=1)leftArrow.isVisible&&target.removeInput();else target.escalateEvent("mouseClickLeft",pos);target.endLayout()},MultiArgMorph.prototype.userMenu=function(){var menu=new MenuMorph(this),block=this.parentThatIsA(BlockMorph),key="",myself=this;return StageMorph.prototype.enableCodeMapping?(block&&(block instanceof RingMorph?key="parms_":"doDeclareVariables"===block.selector&&(key="tempvars_")),
menu.addItem("code list mapping...",function(){myself.mapCodeList(key)}),menu.addItem("code item mapping...",function(){myself.mapCodeItem(key)}),menu.addItem("code delimiter mapping...",function(){myself.mapCodeDelimiter(key)}),menu):this.parent.userMenu()},MultiArgMorph.prototype.mapCodeDelimiter=function(key){this.mapToCode(key+"delim","list item delimiter")},MultiArgMorph.prototype.mapCodeList=function(key){this.mapToCode(key+"list","list contents <#1>")},MultiArgMorph.prototype.mapCodeItem=function(key){this.mapToCode(key+"item","list item <#1>")},MultiArgMorph.prototype.mapToCode=function(key,label){new DialogBoxMorph(this,function(code){StageMorph.prototype.codeMappings[key]=code;
},this).promptCode("Code mapping - "+label,StageMorph.prototype.codeMappings[key]||"",this.world())},MultiArgMorph.prototype.mappedCode=function(definitions){var code,itemCode,delim,block=this.parentThatIsA(BlockMorph),key="",items="",count=0,parts=[];return block&&(block instanceof RingMorph?key="parms_":"doDeclareVariables"===block.selector&&(key="tempvars_")),code=StageMorph.prototype.codeMappings[key+"list"]||"<#1>",itemCode=StageMorph.prototype.codeMappings[key+"item"]||"<#1>",delim=StageMorph.prototype.codeMappings[key+"delim"]||" ",this.inputs().forEach(function(input){parts.push(itemCode.replace(/<#1>/g,input.mappedCode(definitions)))}),parts.forEach(function(part){
count&&(items+=delim),items+=part,count+=1}),code=code.replace(/<#1>/g,items)},MultiArgMorph.prototype.evaluate=function(){var result=[];return this.inputs().forEach(function(slot){result.push(slot.evaluate())}),result},MultiArgMorph.prototype.isEmptySlot=function(){return!!this.canBeEmpty&&0===this.inputs().length},ArgLabelMorph.prototype=new ArgMorph,ArgLabelMorph.prototype.constructor=ArgLabelMorph,ArgLabelMorph.uber=ArgMorph.prototype,ArgLabelMorph.prototype.init=function(argMorph,labelTxt){var label;this.labelText=localize(labelTxt||"input list:"),ArgLabelMorph.uber.init.call(this,null,!0),this.isStatic=!0,this.alpha=0,this.noticesTransparentclick=!0,label=this.labelPart(this.labelText),
this.add(label),this.add(argMorph)},ArgLabelMorph.prototype.label=function(){return this.children[0]},ArgLabelMorph.prototype.argMorph=function(){return this.children[1]},ArgLabelMorph.prototype.fixLayout=function(){var shadowColor,shadowOffset,label=this.label();this.parent&&(this.color=this.parent.color,shadowOffset=label.shadowOffset||new Point,shadowColor=shadowOffset.x<0?this.parent.color.darker(this.labelContrast):this.parent.color.lighter(this.labelContrast),""!==this.labelText&&(label.shadowColor.eq(shadowColor)||(label.shadowColor=shadowColor,label.shadowOffset=shadowOffset,label.drawNew()))),ArgLabelMorph.uber.fixLayout.call(this),this.parent&&this.parent.fixLayout();
},ArgLabelMorph.prototype.refresh=function(){this.inputs().forEach(function(input){input.drawNew()})},ArgLabelMorph.prototype.drawNew=function(){ArgLabelMorph.uber.drawNew.call(this),this.refresh()},ArgLabelMorph.prototype.setLabelColor=function(textColor,shadowColor,shadowOffset){if(""!==this.labelText){var label=this.label();label.color=textColor,label.shadowColor=shadowColor,label.shadowOffset=shadowOffset,label.drawNew()}},ArgLabelMorph.prototype.reactToGrabOf=function(){this.parent instanceof SyntaxElementMorph&&this.parent.revertToDefaultInput(this)},ArgLabelMorph.prototype.evaluate=function(){return this.argMorph().evaluate()},ArgLabelMorph.prototype.isEmptySlot=function(){
return!1},FunctionSlotMorph.prototype=new ArgMorph,FunctionSlotMorph.prototype.constructor=FunctionSlotMorph,FunctionSlotMorph.uber=ArgMorph.prototype,FunctionSlotMorph.prototype.init=function(isPredicate,silently){FunctionSlotMorph.uber.init.call(this,null,!0),this.isPredicate=isPredicate||!1,this.color=this.rfColor,this.setExtent(new Point(2*(this.fontSize+2*this.edge),this.fontSize+2*this.edge),silently)},FunctionSlotMorph.prototype.getSpec=function(){return"%f"},FunctionSlotMorph.prototype.drawNew=function(){var context,borderColor;this.image=newCanvas(this.extent()),context=this.image.getContext("2d"),borderColor=this.parent?this.parent.color:new Color(120,120,120),
this.cachedClr=borderColor.toString(),this.cachedClrBright=borderColor.lighter(this.contrast).toString(),this.cachedClrDark=borderColor.darker(this.contrast).toString(),this.isPredicate?this.drawDiamond(context):this.drawRounded(context)},FunctionSlotMorph.prototype.drawRounded=function(context){var gradient,h=this.height(),r=Math.min(this.rounding,h/2),w=this.width(),shift=this.edge/2;context.fillStyle=this.color.toString(),context.beginPath(),context.arc(r,r,r,radians(-180),radians(-90),!1),context.arc(w-r,r,r,radians(-90),radians(-0),!1),context.arc(w-r,h-r,r,radians(0),radians(90),!1),context.arc(r,h-r,r,radians(90),radians(180),!1),context.closePath(),context.fill(),
MorphicPreferences.isFlat||(context.lineWidth=this.edge,context.lineJoin="round",context.lineCap="round",context.strokeStyle=this.cachedClr,context.beginPath(),context.arc(r,h-r,r-shift,radians(90),radians(180),!1),context.stroke(),context.strokeStyle=this.cachedClr,context.beginPath(),context.arc(w-r,r,r-shift,radians(-90),radians(0),!1),context.stroke(),context.shadowOffsetX=shift,context.shadowOffsetY=shift,context.shadowBlur=this.edge,context.shadowColor=this.color.darker(80).toString(),gradient=context.createLinearGradient(0,0,0,this.edge),gradient.addColorStop(1,this.cachedClrDark),gradient.addColorStop(0,this.cachedClr),context.strokeStyle=gradient,context.beginPath(),
context.moveTo(r-shift,shift),context.lineTo(w-r+shift,shift),context.stroke(),gradient=context.createRadialGradient(r,r,r-this.edge,r,r,r),gradient.addColorStop(1,this.cachedClr),gradient.addColorStop(0,this.cachedClrDark),context.strokeStyle=gradient,context.beginPath(),context.arc(r,r,r-shift,radians(180),radians(270),!1),context.stroke(),gradient=context.createLinearGradient(0,0,this.edge,0),gradient.addColorStop(1,this.cachedClrDark),gradient.addColorStop(0,this.cachedClr),context.strokeStyle=gradient,context.beginPath(),context.moveTo(shift,r),context.lineTo(shift,h-r),context.stroke(),context.shadowOffsetX=0,context.shadowOffsetY=0,context.shadowBlur=0,
gradient=context.createRadialGradient(w-r,h-r,r-this.edge,w-r,h-r,r),gradient.addColorStop(1,this.cachedClr),gradient.addColorStop(0,this.cachedClrBright),context.strokeStyle=gradient,context.beginPath(),context.arc(w-r,h-r,r-shift,radians(0),radians(90),!1),context.stroke(),gradient=context.createLinearGradient(0,h-this.edge,0,h),gradient.addColorStop(1,this.cachedClr),gradient.addColorStop(0,this.cachedClrBright),context.strokeStyle=gradient,context.beginPath(),context.moveTo(r-shift,h-shift),context.lineTo(w-r+shift,h-shift),context.stroke(),gradient=context.createLinearGradient(w-this.edge,0,w,0),gradient.addColorStop(1,this.cachedClr),gradient.addColorStop(0,this.cachedClrBright),
context.strokeStyle=gradient,context.beginPath(),context.moveTo(w-shift,r+shift),context.lineTo(w-shift,h-r),context.stroke())},FunctionSlotMorph.prototype.drawDiamond=function(context){var gradient,w=this.width(),h=this.height(),h2=Math.floor(h/2),r=Math.min(this.rounding,h2),shift=this.edge/2;context.fillStyle=this.color.toString(),context.beginPath(),context.moveTo(0,h2),context.lineTo(r,0),context.lineTo(w-r,0),context.lineTo(w,h2),context.lineTo(w-r,h),context.lineTo(r,h),context.closePath(),context.fill(),MorphicPreferences.isFlat||(context.lineWidth=this.edge,context.lineJoin="round",context.lineCap="round",context.strokeStyle=this.cachedClr,context.beginPath(),
context.moveTo(shift,h2),context.lineTo(r,h-shift),context.stroke(),context.strokeStyle=this.cachedClr,context.beginPath(),context.moveTo(w-shift,h2),context.lineTo(w-r,shift),context.stroke(),context.shadowOffsetX=shift,context.shadowOffsetY=shift,context.shadowBlur=this.edge,context.shadowColor=this.color.darker(80).toString(),gradient=context.createLinearGradient(0,0,r,0),gradient.addColorStop(1,this.cachedClrDark),gradient.addColorStop(0,this.cachedClr),context.strokeStyle=gradient,context.beginPath(),context.moveTo(shift,h2),context.lineTo(r,shift),context.stroke(),gradient=context.createLinearGradient(0,0,0,this.edge),gradient.addColorStop(1,this.cachedClrDark),
gradient.addColorStop(0,this.cachedClr),context.strokeStyle=gradient,context.beginPath(),context.moveTo(r,shift),context.lineTo(w-r,shift),context.stroke(),context.shadowOffsetX=0,context.shadowOffsetY=0,context.shadowBlur=0,gradient=context.createLinearGradient(w-r,0,w,0),gradient.addColorStop(1,this.cachedClr),gradient.addColorStop(0,this.cachedClrBright),context.strokeStyle=gradient,context.beginPath(),context.moveTo(w-r,h-shift),context.lineTo(w-shift,h2),context.stroke(),gradient=context.createLinearGradient(0,h-this.edge,0,h),gradient.addColorStop(1,this.cachedClr),gradient.addColorStop(0,this.cachedClrBright),context.strokeStyle=gradient,context.beginPath(),
context.moveTo(r+shift,h-shift),context.lineTo(w-r-shift,h-shift),context.stroke())},ReporterSlotMorph.prototype=new FunctionSlotMorph,ReporterSlotMorph.prototype.constructor=ReporterSlotMorph,ReporterSlotMorph.uber=FunctionSlotMorph.prototype,ReporterSlotMorph.prototype.init=function(isPredicate){ReporterSlotMorph.uber.init.call(this,isPredicate,!0),this.add(this.emptySlot()),this.fixLayout()},ReporterSlotMorph.prototype.emptySlot=function(){var empty=new ArgMorph,shrink=2*this.rfBorder+2*this.edge;return empty.color=this.rfColor,empty.alpha=0,empty.setExtent(new Point(2*(this.fontSize+2*this.edge)-shrink,this.fontSize+2*this.edge-shrink)),empty},ReporterSlotMorph.prototype.getSpec=function(){
return"%r"},ReporterSlotMorph.prototype.contents=function(){return this.children[0]},ReporterSlotMorph.prototype.nestedBlock=function(){var contents=this.contents();return contents instanceof ReporterBlockMorph?contents:null},ReporterSlotMorph.prototype.evaluate=function(){return this.nestedBlock()},ReporterSlotMorph.prototype.isEmptySlot=function(){return null===this.nestedBlock()},ReporterSlotMorph.prototype.fixLayout=function(){var contents=this.contents();this.setExtent(contents.extent().add(2*this.edge+2*this.rfBorder)),contents.setCenter(this.center()),this.parent&&this.parent.fixLayout&&this.parent.fixLayout()},RingReporterSlotMorph.prototype=new ReporterSlotMorph,
RingReporterSlotMorph.prototype.constructor=RingReporterSlotMorph,RingReporterSlotMorph.uber=ReporterSlotMorph.prototype,RingReporterSlotMorph.prototype.rfBorder=RingCommandSlotMorph.prototype.rfBorder,RingReporterSlotMorph.prototype.edge=RingCommandSlotMorph.prototype.edge,RingReporterSlotMorph.prototype.init=function(isPredicate){RingReporterSlotMorph.uber.init.call(this,isPredicate,!0),this.alpha=RingMorph.prototype.alpha,this.contrast=RingMorph.prototype.contrast,this.isHole=!0},RingReporterSlotMorph.prototype.getSpec=function(){return"%rr"},RingReporterSlotMorph.prototype.replaceInput=function(source,target){RingReporterSlotMorph.uber.replaceInput.call(this,source,target),
this.parent instanceof RingMorph&&this.parent.vanishForSimilar()},RingReporterSlotMorph.prototype.drawRounded=function(context){var gradient,h=this.height(),r=Math.min(this.rounding,h/2),w=this.width(),shift=this.edge/2;context.fillStyle=this.cachedClr,context.beginPath(),context.moveTo(0,h/2),context.arc(r,r,r,radians(-180),radians(-90),!1),context.arc(w-r,r,r,radians(-90),radians(-0),!1),context.lineTo(w,h/2),context.lineTo(w,0),context.lineTo(0,0),context.closePath(),context.fill(),context.beginPath(),context.moveTo(w,h/2),context.arc(w-r,h-r,r,radians(0),radians(90),!1),context.arc(r,h-r,r,radians(90),radians(180),!1),context.lineTo(0,h/2),context.lineTo(0,h),
context.lineTo(w,h),context.closePath(),context.fill(),MorphicPreferences.isFlat||(context.lineWidth=this.edge,context.lineJoin="round",context.lineCap="round",context.strokeStyle=this.cachedClr,context.beginPath(),context.arc(r,h-r,r-shift,radians(90),radians(180),!1),context.stroke(),context.strokeStyle=this.cachedClr,context.beginPath(),context.arc(w-r,r,r-shift,radians(-90),radians(0),!1),context.stroke(),context.shadowOffsetX=shift,context.shadowOffsetY=shift,context.shadowBlur=this.edge,context.shadowColor=this.color.darker(80).toString(),gradient=context.createLinearGradient(0,0,0,this.edge),gradient.addColorStop(1,this.cachedClrDark),gradient.addColorStop(0,this.cachedClr),
context.strokeStyle=gradient,context.beginPath(),context.moveTo(r-shift,shift),context.lineTo(w-r+shift,shift),context.stroke(),gradient=context.createRadialGradient(r,r,r-this.edge,r,r,r),gradient.addColorStop(1,this.cachedClr),gradient.addColorStop(0,this.cachedClrDark),context.strokeStyle=gradient,context.beginPath(),context.arc(r,r,r-shift,radians(180),radians(270),!1),context.stroke(),gradient=context.createLinearGradient(0,0,this.edge,0),gradient.addColorStop(1,this.cachedClrDark),gradient.addColorStop(0,this.cachedClr),context.strokeStyle=gradient,context.beginPath(),context.moveTo(shift,r),context.lineTo(shift,h-r),context.stroke(),context.shadowOffsetX=0,
context.shadowOffsetY=0,context.shadowBlur=0,gradient=context.createRadialGradient(w-r,h-r,r-this.edge,w-r,h-r,r),gradient.addColorStop(1,this.cachedClr),gradient.addColorStop(0,this.cachedClrBright),context.strokeStyle=gradient,context.beginPath(),context.arc(w-r,h-r,r-shift,radians(0),radians(90),!1),context.stroke(),gradient=context.createLinearGradient(0,h-this.edge,0,h),gradient.addColorStop(1,this.cachedClr),gradient.addColorStop(0,this.cachedClrBright),context.strokeStyle=gradient,context.beginPath(),context.moveTo(r-shift,h-shift),context.lineTo(w-r+shift,h-shift),context.stroke(),gradient=context.createLinearGradient(w-this.edge,0,w,0),gradient.addColorStop(1,this.cachedClr),
gradient.addColorStop(0,this.cachedClrBright),context.strokeStyle=gradient,context.beginPath(),context.moveTo(w-shift,r+shift),context.lineTo(w-shift,h-r),context.stroke())},RingReporterSlotMorph.prototype.drawDiamond=function(context){var gradient,w=this.width(),h=this.height(),h2=Math.floor(h/2),r=Math.min(this.rounding,h2),shift=this.edge/2;context.fillStyle=this.cachedClr,context.beginPath(),context.moveTo(0,0),context.lineTo(0,h2),context.lineTo(r,0),context.lineTo(w-r,0),context.lineTo(w,h2),context.lineTo(w,0),context.closePath(),context.fill(),context.moveTo(w,h2),context.lineTo(w-r,h),context.lineTo(r,h),context.lineTo(0,h2),context.lineTo(0,h),context.lineTo(w,h),
context.closePath(),context.fill(),MorphicPreferences.isFlat||(context.lineWidth=this.edge,context.lineJoin="round",context.lineCap="round",context.strokeStyle=this.cachedClr,context.beginPath(),context.moveTo(shift,h2),context.lineTo(r,h-shift),context.stroke(),context.strokeStyle=this.cachedClr,context.beginPath(),context.moveTo(w-shift,h2),context.lineTo(w-r,shift),context.stroke(),context.shadowOffsetX=shift,context.shadowOffsetY=shift,context.shadowBlur=this.edge,context.shadowColor=this.color.darker(80).toString(),gradient=context.createLinearGradient(0,0,r,0),gradient.addColorStop(1,this.cachedClrDark),gradient.addColorStop(0,this.cachedClr),context.strokeStyle=gradient,
context.beginPath(),context.moveTo(shift,h2),context.lineTo(r,shift),context.stroke(),gradient=context.createLinearGradient(0,0,0,this.edge),gradient.addColorStop(1,this.cachedClrDark),gradient.addColorStop(0,this.cachedClr),context.strokeStyle=gradient,context.beginPath(),context.moveTo(r,shift),context.lineTo(w-r,shift),context.stroke(),context.shadowOffsetX=0,context.shadowOffsetY=0,context.shadowBlur=0,gradient=context.createLinearGradient(w-r,0,w,0),gradient.addColorStop(1,this.cachedClr),gradient.addColorStop(0,this.cachedClrBright),context.strokeStyle=gradient,context.beginPath(),context.moveTo(w-r,h-shift),context.lineTo(w-shift,h2),context.stroke(),gradient=context.createLinearGradient(0,h-this.edge,0,h),
gradient.addColorStop(1,this.cachedClr),gradient.addColorStop(0,this.cachedClrBright),context.strokeStyle=gradient,context.beginPath(),context.moveTo(r+shift,h-shift),context.lineTo(w-r-shift,h-shift),context.stroke())},CommentMorph.prototype=new BoxMorph,CommentMorph.prototype.constructor=CommentMorph,CommentMorph.uber=BoxMorph.prototype,CommentMorph.prototype.refreshScale=function(){CommentMorph.prototype.fontSize=SyntaxElementMorph.prototype.fontSize,CommentMorph.prototype.padding=5*SyntaxElementMorph.prototype.scale,CommentMorph.prototype.rounding=8*SyntaxElementMorph.prototype.scale},CommentMorph.prototype.refreshScale(),CommentMorph.prototype.init=function(contents){
var myself=this,scale=SyntaxElementMorph.prototype.scale;this.block=null,this.stickyOffset=null,this.isCollapsed=!1,this.titleBar=new BoxMorph(this.rounding,1.000001*scale,new Color(255,255,180)),this.titleBar.color=new Color(255,255,180),this.titleBar.setHeight(fontHeight(this.fontSize)+this.padding),this.title=null,this.arrow=new ArrowMorph("down",this.fontSize),this.arrow.noticesTransparentClick=!0,this.arrow.mouseClickLeft=function(){myself.toggleExpand()},this.contents=new TextMorph(contents||localize("add comment here..."),this.fontSize),this.contents.isEditable=!0,this.contents.enableSelecting(),this.contents.maxWidth=90*scale,this.contents.drawNew(),this.handle=new HandleMorph(this.contents,80,2*this.fontSize,-2,-2),
this.handle.setExtent(new Point(11*scale,11*scale)),this.anchor=null,CommentMorph.uber.init.call(this,this.rounding,1.000001*scale,new Color(255,255,180)),this.color=new Color(255,255,220),this.isDraggable=!0,this.add(this.titleBar),this.add(this.arrow),this.add(this.contents),this.add(this.handle),this.fixLayout()},CommentMorph.prototype.fullCopy=function(){var cpy=new CommentMorph(this.contents.text);return cpy.isCollapsed=this.isCollapsed,cpy.setTextWidth(this.textWidth()),this.selectionID&&(cpy.selectionID=!0),cpy},CommentMorph.prototype.setTextWidth=function(pixels){this.contents.maxWidth=pixels,this.contents.drawNew(),this.fixLayout()},CommentMorph.prototype.textWidth=function(){
return this.contents.maxWidth},CommentMorph.prototype.text=function(){return this.contents.text},CommentMorph.prototype.toggleExpand=function(){this.isCollapsed=!this.isCollapsed,this.fixLayout(),this.align()},CommentMorph.prototype.layoutChanged=function(){this.fixLayout(),this.align()},CommentMorph.prototype.fixLayout=function(){var label,tw=this.contents.width()+2*this.padding,myself=this,oldFlag=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,this.title&&(this.title.destroy(),this.title=null),this.isCollapsed?(this.contents.hide(),this.title=new FrameMorph,this.title.alpha=0,this.title.acceptsDrops=!1,label=new StringMorph(this.contents.text,this.fontSize,null,!0),
label.rootForGrab=function(){return myself},this.title.add(label),this.title.setHeight(label.height()),this.title.setWidth(tw-this.arrow.width()-2*this.padding-this.rounding),this.add(this.title)):this.contents.show(),this.titleBar.setWidth(tw),this.contents.setLeft(this.titleBar.left()+this.padding),this.contents.setTop(this.titleBar.bottom()+this.padding),this.arrow.direction=this.isCollapsed?"right":"down",this.arrow.drawNew(),this.arrow.setCenter(this.titleBar.center()),this.arrow.setLeft(this.titleBar.left()+this.padding),this.title&&this.title.setPosition(this.arrow.topRight().add(new Point(this.padding,0))),Morph.prototype.trackChanges=oldFlag,this.changed(),
this.silentSetHeight(this.titleBar.height()+(this.isCollapsed?0:this.padding+this.contents.height()+this.padding)),this.silentSetWidth(this.titleBar.width()),this.drawNew(),this.handle.drawNew(),this.changed()},CommentMorph.prototype.userMenu=function(){var menu=new MenuMorph(this),myself=this;return menu.addItem("duplicate",function(){myself.fullCopy().pickUp(myself.world())},"make a copy\nand pick it up"),menu.addItem("delete","userDestroy"),menu.addItem("comment pic...",function(){var ide=myself.parentThatIsA(IDE_Morph);ide.saveCanvasAs(myself.fullImageClassic(),(ide.projectName||localize("untitled"))+" "+localize("comment pic"))},"open a new window\nwith a picture of this comment"),
menu},CommentMorph.prototype.userDestroy=function(){this.selectForEdit().destroy()},CommentMorph.prototype.hide=function(){this.isVisible=!1,this.changed()},CommentMorph.prototype.show=function(){this.isVisible=!0,this.changed()},CommentMorph.prototype.prepareToBeGrabbed=function(hand){this.block&&(this.block.comment=null,this.block=null),this.anchor&&(this.anchor.destroy(),this.anchor=null,this.removeShadow(),this.addShadow())},CommentMorph.prototype.selectForEdit=SyntaxElementMorph.prototype.selectForEdit,CommentMorph.prototype.snap=function(hand){var target,scripts=this.parent;return scripts instanceof ScriptsMorph?(scripts.clearDropInfo(),target=scripts.closestBlock(this,hand),
null!==target&&(target.comment=this,this.block=target,this.snapSound&&this.snapSound.play(),scripts.lastDropTarget={element:target}),this.align(),scripts.lastDroppedBlock=this,void(hand&&scripts.recordDrop(hand.grabOrigin))):null},CommentMorph.prototype.align=function(topBlock,ignoreLayer){if(this.block){var affectedBlocks,tp,bottom,rightMost,top=topBlock||this.block.topBlock(),scripts=top.parentThatIsA(ScriptsMorph);this.setTop(this.block.top()+this.block.corner),tp=this.top(),bottom=this.bottom(),affectedBlocks=top.allChildren().filter(function(child){return child instanceof BlockMorph&&child.bottom()>tp&&child.top()<bottom}),rightMost=Math.max.apply(null,affectedBlocks.map(function(block){
return block.right()})),this.setLeft(rightMost+5),!ignoreLayer&&scripts&&scripts.addBack(this),this.anchor||(this.anchor=new Morph,this.anchor.color=this.titleBar.color),this.anchor.silentSetPosition(new Point(this.block.right(),this.top()+this.edge)),this.anchor.bounds.corner=new Point(this.left(),this.top()+this.edge+1),this.anchor.drawNew(),this.addBack(this.anchor),this.anchor.changed()}},CommentMorph.prototype.startFollowing=function(topBlock,world){this.align(topBlock),world.add(this),this.addShadow(),this.stickyOffset=this.position().subtract(this.block.position()),this.step=function(){return this.block?void this.setPosition(this.block.position().add(this.stickyOffset)):void this.stopFollowing();
}},CommentMorph.prototype.stopFollowing=function(){this.removeShadow(),delete this.step},CommentMorph.prototype.destroy=function(){this.block&&(this.block.comment=null),CommentMorph.uber.destroy.call(this)},CommentMorph.prototype.stackHeight=function(){return this.height()},ScriptFocusMorph.prototype=new BoxMorph,ScriptFocusMorph.prototype.constructor=ScriptFocusMorph,ScriptFocusMorph.uber=BoxMorph.prototype,ScriptFocusMorph.prototype.init=function(editor,initialElement,position){this.editor=editor,this.element=initialElement,this.atEnd=!1,ScriptFocusMorph.uber.init.call(this),this.element instanceof ScriptsMorph&&this.setPosition(position)},ScriptFocusMorph.prototype.getFocus=function(world){
world||(world=this.world()),world&&world.keyboardReceiver!==this&&world.stopEditing(),world.keyboardReceiver=this,this.fixLayout(),this.editor.updateToolbar()},ScriptFocusMorph.prototype.fixLayout=function(){this.changed(),this.element instanceof CommandBlockMorph||this.element instanceof CommandSlotMorph||this.element instanceof ScriptsMorph?this.manifestStatement():this.manifestExpression(),this.editor.add(this),this.scrollIntoView(),this.changed()},ScriptFocusMorph.prototype.manifestStatement=function(){var newScript=this.element instanceof ScriptsMorph,y=this.element.top();this.border=0,this.edge=0,this.alpha=1,this.color=this.editor.feedbackColor,this.setExtent(new Point(newScript?SyntaxElementMorph.prototype.hatWidth:this.element.width(),Math.max(SyntaxElementMorph.prototype.corner,SyntaxElementMorph.prototype.feedbackMinHeight))),
this.element instanceof CommandSlotMorph?y+=SyntaxElementMorph.prototype.corner:this.atEnd&&(y=this.element.bottom()),newScript||this.setPosition(new Point(this.element.left(),y)),this.fps=2,this.show(),this.step=function(){this.toggleVisibility()}},ScriptFocusMorph.prototype.manifestExpression=function(){this.edge=SyntaxElementMorph.prototype.rounding,this.border=Math.max(SyntaxElementMorph.prototype.edge,3),this.color=this.editor.feedbackColor.copy(),this.color.a=.5,this.borderColor=this.editor.feedbackColor,this.bounds=this.element.fullBounds().expandBy(Math.max(2*SyntaxElementMorph.prototype.edge,SyntaxElementMorph.prototype.reporterDropFeedbackPadding)),
this.drawNew(),delete this.fps,delete this.step,this.show()},ScriptFocusMorph.prototype.trigger=function(){var current=this.element;return current instanceof MultiArgMorph?void(current.arrows().children[1].isVisible&&(current.addInput(),this.fixLayout())):current.parent instanceof TemplateSlotMorph?void current.mouseClickLeft():current instanceof BooleanSlotMorph?void current.toggleValue():void(current instanceof InputSlotMorph&&(current.isReadOnly?current.choices&&(current.dropDownMenu(!0),delete this.fps,delete this.step,this.hide()):(delete this.fps,delete this.step,this.hide(),this.world().onNextStep=function(){current.contents().edit(),current.contents().selectAll();
})))},ScriptFocusMorph.prototype.menu=function(){var current=this.element;current instanceof InputSlotMorph&&current.choices?(current.dropDownMenu(!0),delete this.fps,delete this.step,this.hide()):this.insertVariableGetter()},ScriptFocusMorph.prototype.deleteLastElement=function(){var current=this.element;current.parent instanceof ScriptsMorph?(this.atEnd||current instanceof ReporterBlockMorph)&&(current.destroy(),this.element=this.editor,this.atEnd=!1):current instanceof MultiArgMorph?current.arrows().children[0].isVisible&&current.removeInput():current instanceof BooleanSlotMorph?current.isStatic||current.setContents(null):current instanceof ReporterBlockMorph?current.isTemplate||(this.lastElement(),
current.prepareToBeGrabbed(),current.destroy()):current instanceof CommandBlockMorph&&(this.atEnd?(this.element=current.parent,current.userDestroy()):current.parent instanceof CommandBlockMorph&&current.parent.userDestroy()),this.editor.adjustBounds(),this.fixLayout()},ScriptFocusMorph.prototype.insertBlock=function(block){var pb,stage,ide,rcvr;block.isTemplate=!1,block.isDraggable=!0,block.snapSound&&block.snapSound.play(),this.element instanceof ScriptsMorph?(this.editor.add(block),this.element=block,block instanceof CommandBlockMorph?(block.setLeft(this.left()),block.isStop()?block.setTop(this.top()):(block.setBottom(this.top()),this.atEnd=!0)):(block.setCenter(this.center()),
block.setLeft(this.left()))):this.element instanceof CommandBlockMorph?this.atEnd?(this.element.nextBlock(block),this.element=block,this.fixLayout()):(pb=this.element.parent,pb instanceof ScriptsMorph?(block.setLeft(this.element.left()),block.setBottom(this.element.top()+this.element.corner),this.editor.add(block),block.nextBlock(this.element),this.fixLayout()):pb instanceof CommandSlotMorph?pb.nestedBlock(block):pb instanceof CommandBlockMorph&&pb.nextBlock(block)):this.element instanceof CommandSlotMorph?(this.element.nestedBlock(block),this.element=block,this.atEnd=!0):(pb=this.element.parent,pb instanceof ScriptsMorph?(this.editor.add(block),block.setPosition(this.element.position()),
this.element.destroy()):pb.replaceInput(this.element,block),this.element=block),block.fixBlockColor(),this.editor.adjustBounds(),this.fixLayout(),"receiveCondition"===block.selector&&(rcvr=this.editor.scriptTarget(),rcvr&&(stage=rcvr.parentThatIsA(StageMorph),stage&&(stage.enableCustomHatBlocks=!0,stage.threads.pauseCustomHatBlocks=!1,ide=stage.parentThatIsA(IDE_Morph),ide&&ide.controlBar.stopButton.refresh()))),block.inputs&&block.inputs().length&&(this.element=block,this.atEnd=!1,this.nextElement())},ScriptFocusMorph.prototype.insertVariableGetter=function(){var vars,types=this.blockTypes(),myself=this,menu=new MenuMorph;types&&contains(types,"reporter")&&(vars=InputSlotMorph.prototype.getVarNamesDict.call(this.element),
Object.keys(vars).forEach(function(vName){var block=SpriteMorph.prototype.variableBlock(vName);block.addShadow(new Point(3,3)),menu.addItem(block,function(){block.removeShadow(),myself.insertBlock(block)})}),menu.items.length>0&&(menu.popup(this.world(),this.element.bottomLeft()),menu.getFocus()))},ScriptFocusMorph.prototype.stopEditing=function(){this.editor.focus=null,this.editor.updateToolbar(),this.world().keyboardReceiver=null,this.destroy()},ScriptFocusMorph.prototype.lastElement=function(){var idx,items=this.items();return items.length?(this.atEnd?(this.element=items[items.length-1],this.atEnd=!1):(idx=items.indexOf(this.element)-1,idx<0&&(idx=items.length-1),
this.element=items[idx]),this.element instanceof CommandSlotMorph&&this.element.nestedBlock()?this.lastElement():this.element instanceof HatBlockMorph&&(items.length>1?this.lastElement():this.atEnd=!0),void this.fixLayout()):void this.shiftScript(new Point(-50,0))},ScriptFocusMorph.prototype.nextElement=function(){var idx,nb,items=this.items();return items.length?(idx=items.indexOf(this.element)+1,idx>=items.length&&(idx=0),this.atEnd=!1,this.element=items[idx],this.element instanceof CommandSlotMorph?(nb=this.element.nestedBlock(),nb&&(this.element=nb)):this.element instanceof HatBlockMorph&&(1===items.length?this.atEnd=!0:this.nextElement()),void this.fixLayout()):void this.shiftScript(new Point(50,0));
},ScriptFocusMorph.prototype.lastCommand=function(){var pb,cm=this.element.parentThatIsA(CommandBlockMorph);return cm?(this.element instanceof CommandBlockMorph?this.atEnd?this.atEnd=!1:(pb=cm.parent.parentThatIsA(CommandBlockMorph),pb?this.element=pb:(pb=cm.topBlock().bottomBlock(),pb&&(this.element=pb,this.atEnd=!0))):(this.element=cm,this.atEnd=!1),this.element instanceof HatBlockMorph&&!this.atEnd&&this.lastCommand(),void this.fixLayout()):void(this.element instanceof ScriptsMorph&&this.shiftScript(new Point(0,-50)))},ScriptFocusMorph.prototype.nextCommand=function(){var tb,nb,cs,cm=this.element;if(cm instanceof ScriptsMorph)return void this.shiftScript(new Point(0,50));
for(;!(cm instanceof CommandBlockMorph);)if(cm=cm.parent,cm instanceof ScriptsMorph)return;this.atEnd?(cs=cm.parentThatIsA(CommandSlotMorph),cs?(this.element=cs.parentThatIsA(CommandBlockMorph),this.atEnd=!1,this.nextCommand()):(tb=cm.topBlock().parentThatIsA(CommandBlockMorph),tb&&(this.element=tb,this.atEnd=!1,this.element instanceof HatBlockMorph&&this.nextCommand()))):(nb=cm.nextBlock(),nb?this.element=nb:(this.element=cm,this.atEnd=!0)),this.fixLayout()},ScriptFocusMorph.prototype.nextScript=function(){var idx,scripts=this.sortedScripts();if(!(scripts.length<1))return this.element instanceof ScriptsMorph&&(this.element=scripts[0]),idx=scripts.indexOf(this.element.topBlock())+1,
idx>=scripts.length&&(idx=0),this.element=scripts[idx],this.element.scrollIntoView(),this.atEnd=!1,this.element instanceof HatBlockMorph?this.nextElement():void this.fixLayout()},ScriptFocusMorph.prototype.lastScript=function(){var idx,scripts=this.sortedScripts();if(!(scripts.length<1))return this.element instanceof ScriptsMorph&&(this.element=scripts[0]),idx=scripts.indexOf(this.element.topBlock())-1,idx<0&&(idx=scripts.length-1),this.element=scripts[idx],this.element.scrollIntoView(),this.atEnd=!1,this.element instanceof HatBlockMorph?this.nextElement():void this.fixLayout()},ScriptFocusMorph.prototype.shiftScript=function(deltaPoint){var tb;this.element instanceof ScriptsMorph?this.moveBy(deltaPoint):(tb=this.element.topBlock(),
!tb||tb instanceof PrototypeHatBlockMorph||tb.moveBy(deltaPoint)),this.editor.adjustBounds(),this.fixLayout()},ScriptFocusMorph.prototype.newScript=function(){var pos=this.position();this.element instanceof ScriptsMorph||(pos=this.element.topBlock().fullBounds().bottomLeft().add(new Point(0,50))),this.setPosition(pos),this.element=this.editor,this.editor.adjustBounds(),this.fixLayout()},ScriptFocusMorph.prototype.runScript=function(){this.element instanceof ScriptsMorph||this.element.topBlock().mouseClickLeft()},ScriptFocusMorph.prototype.items=function(){if(this.element instanceof ScriptsMorph)return[];var script=this.element.topBlock();return script.allChildren().filter(function(each){
return each instanceof SyntaxElementMorph&&!(each instanceof TemplateSlotMorph)&&(!each.isStatic||each.choices||each instanceof BooleanSlotMorph||each instanceof RingMorph||each instanceof MultiArgMorph||each instanceof CommandSlotMorph)})},ScriptFocusMorph.prototype.sortedScripts=function(){var scripts=this.editor.children.filter(function(each){return each instanceof BlockMorph});return scripts.sort(function(a,b){return a instanceof PrototypeHatBlockMorph?0:a.top()-b.top()}),scripts},ScriptFocusMorph.prototype.undrop=function(){this.editor.undrop()},ScriptFocusMorph.prototype.redrop=function(){this.editor.redrop()},ScriptFocusMorph.prototype.blockTypes=function(){
return this.element.isTemplate?null:this.element instanceof ScriptsMorph?["hat","command","reporter","predicate","ring"]:this.element instanceof HatBlockMorph||this.element instanceof CommandSlotMorph?["command"]:this.element instanceof CommandBlockMorph?this.atEnd&&this.element.isStop()?null:this.element.parent instanceof ScriptsMorph?["hat","command"]:["command"]:this.element instanceof ReporterBlockMorph?"%n"===this.element.getSlotSpec()?["reporter"]:["reporter","predicate","ring"]:"%n"===this.element.getSpec()?["reporter"]:this.element.isStatic?null:["reporter","predicate","ring"]},ScriptFocusMorph.prototype.processKeyDown=function(event){this.processKeyEvent(event,this.reactToKeyEvent);
},ScriptFocusMorph.prototype.processKeyUp=function(event){nop(event)},ScriptFocusMorph.prototype.processKeyPress=function(event){nop(event)},ScriptFocusMorph.prototype.processKeyEvent=function(event,action){var keyName,ctrl,shift;switch(this.world().hand.destroyTemporaries(),event.keyCode){case 8:keyName="backspace";break;case 9:keyName="tab";break;case 13:keyName="enter";break;case 16:case 17:case 18:return;case 27:keyName="esc";break;case 32:keyName="space";break;case 37:keyName="left arrow";break;case 39:keyName="right arrow";break;case 38:keyName="up arrow";break;case 40:keyName="down arrow";break;default:keyName=String.fromCharCode(event.keyCode||event.charCode);
}ctrl=event.ctrlKey||event.metaKey?"ctrl ":"",shift=event.shiftKey?"shift ":"",keyName=ctrl+shift+keyName,action.call(this,keyName)},ScriptFocusMorph.prototype.reactToKeyEvent=function(key){var types,vNames,evt=key.toLowerCase(),shift=50;switch(evt){case"esc":return this.stopEditing();case"enter":return this.trigger();case"shift enter":return this.newScript();case"ctrl shift enter":return this.runScript();case"space":return this.menu();case"left arrow":return this.lastElement();case"shift left arrow":return this.shiftScript(new Point(-shift,0));case"right arrow":return this.nextElement();case"shift right arrow":return this.shiftScript(new Point(shift,0));case"up arrow":
return this.lastCommand();case"shift up arrow":return this.shiftScript(new Point(0,-shift));case"down arrow":return this.nextCommand();case"shift down arrow":return this.shiftScript(new Point(0,shift));case"tab":return this.nextScript();case"shift tab":return this.lastScript();case"backspace":return this.deleteLastElement();case"ctrl z":return this.undrop();case"ctrl y":case"ctrl shift z":return this.redrop();case"ctrl [":return;default:types=this.blockTypes(),this.element instanceof ScriptsMorph||!types||!contains(types,"reporter")||(vNames=Object.keys(this.element.getVarNamesDict())),types&&(delete this.fps,delete this.step,this.show(),this.editor.scriptTarget().searchBlocks(key,types,vNames,this));
}},modules.threads="2017-December-01";var ThreadManager,Process,Context,VariableFrame;ThreadManager.prototype.pauseCustomHatBlocks=!1;var compteurGo=0;ThreadManager.prototype.toggleProcess=function(block,receiver){var active=this.findProcess(block,receiver);return compteur(),active?void active.stop():this.startProcess(block,receiver,null,null,null,!0)},ThreadManager.prototype.startProcess=function(block,receiver,isThreadSafe,exportResult,callback,isClicked,rightAway){var glow,newProc,top=block.topBlock(),active=this.findProcess(top,receiver);if(active){if(isThreadSafe)return active;active.stop(),this.removeTerminatedProcesses()}return newProc=new Process(top,receiver,callback,isClicked),
newProc.exportResult=exportResult,newProc.isClicked=isClicked||!1,glow=top.getHighlight(),glow?(glow.threadCount=this.processesForBlock(top).length+1,glow.updateReadout()):top.addHighlight(),this.processes.push(newProc),rightAway&&newProc.runStep(),newProc},ThreadManager.prototype.stopAll=function(excpt){this.processes.forEach(function(proc){proc!==excpt&&proc.stop()})},ThreadManager.prototype.stopAllForReceiver=function(rcvr,excpt){this.processes.forEach(function(proc){proc.homeContext.receiver===rcvr&&proc!==excpt&&(proc.stop(),rcvr.isTemporary&&(proc.isDead=!0))})},ThreadManager.prototype.stopAllForBlock=function(aTopBlock){this.processesForBlock(aTopBlock,!0).forEach(function(proc){
proc.stop()})},ThreadManager.prototype.stopProcess=function(block,receiver){var active=this.findProcess(block,receiver);active&&active.stop()},ThreadManager.prototype.pauseAll=function(stage){this.processes.forEach(function(proc){proc.pause()}),stage&&stage.pauseAllActiveSounds()},ThreadManager.prototype.isPaused=function(){return null!==detect(this.processes,function(proc){return proc.isPaused})},ThreadManager.prototype.resumeAll=function(stage){this.processes.forEach(function(proc){proc.resume()}),stage&&stage.resumeAllActiveSounds()},ThreadManager.prototype.step=function(){var isInterrupted;return Process.prototype.enableSingleStepping&&(this.processes.forEach(function(proc){
proc.isInterrupted?(proc.runStep(),isInterrupted=!0):proc.lastYield=Date.now()}),this.wantsToPause=Process.prototype.flashTime>.5,isInterrupted)?void(this.wantsToPause&&this.pauseAll()):(this.processes.forEach(function(proc){proc.homeContext.receiver.isPickedUp()||proc.isDead||proc.runStep()}),void this.removeTerminatedProcesses())},ThreadManager.prototype.removeTerminatedProcesses=function(){var count,remaining=[],myself=this;this.processes.forEach(function(proc){var result,glow;!proc.isRunning()&&!proc.errorFlag||proc.isDead?(proc.topBlock instanceof BlockMorph&&(proc.unflash(),count=myself.processesForBlock(proc.topBlock).length,count?(glow=proc.topBlock.getHighlight()||proc.topBlock.addHighlight(),
glow.threadCount=count,glow.updateReadout()):proc.topBlock.removeHighlight()),proc.prompter&&(proc.prompter.destroy(),proc.homeContext.receiver.stopTalking&&proc.homeContext.receiver.stopTalking()),(proc.topBlock instanceof ReporterBlockMorph||proc.isShowingResult)&&(result=proc.homeContext.inputs[0],proc.onComplete instanceof Function?proc.onComplete(result):result instanceof List?proc.topBlock.showBubble(result.isTable()?new TableFrameMorph(new TableMorph(result,10)):new ListWatcherMorph(result),proc.exportResult,proc.receiver):proc.topBlock.showBubble(result,proc.exportResult,proc.receiver))):remaining.push(proc)}),this.processes=remaining},ThreadManager.prototype.findProcess=function(block,receiver){
var top=block.topBlock();return detect(this.processes,function(each){return each.topBlock===top&&each.receiver===receiver})},ThreadManager.prototype.processesForBlock=function(block,only){var top=only?block:block.topBlock();return this.processes.filter(function(each){return each.topBlock===top&&each.isRunning()&&!each.isDead})},ThreadManager.prototype.doWhen=function(block,receiver,stopIt){if(!this.pauseCustomHatBlocks&&block&&!this.findProcess(block,receiver)){var world,pred=block.inputs()[0];if(block.removeHighlight()&&(world=block.world(),world&&world.hand.destroyTemporaries()),!stopIt)try{invoke(pred,null,receiver,50,"the predicate takes\ntoo long for a\ncustom hat block",!0)===!0&&this.startProcess(block,receiver,null,null,null,null,!0);
}catch(error){block.addErrorHighlight(),block.showBubble(error.name+"\n"+error.message)}}},ThreadManager.prototype.toggleSingleStepping=function(){Process.prototype.enableSingleStepping=!Process.prototype.enableSingleStepping,Process.prototype.enableSingleStepping||this.processes.forEach(function(proc){proc.isPaused||proc.unflash()})},Process.prototype={},Process.prototype.constructor=Process,Process.prototype.timeout=500,Process.prototype.isCatchingErrors=!0,Process.prototype.enableLiveCoding=!1,Process.prototype.enableSingleStepping=!1,Process.prototype.flashTime=0,Process.prototype.isRunning=function(){return null!==this.context&&!this.readyToTerminate},Process.prototype.runStep=function(deadline){
if(this.isPaused)return this.pauseStep();for(this.readyToYield=!1,this.isInterrupted=!1;!this.readyToYield&&!this.isInterrupted&&this.context&&Date.now()-this.lastYield<this.timeout;){if(this.isPaused)return this.pauseStep();if(deadline&&Date.now()>deadline)return void(this.isAtomic&&this.homeContext.receiver&&this.homeContext.receiver.endWarp&&this.homeContext.receiver.endWarp());this.evaluateContext()}if(this.lastYield=Date.now(),this.isFirstStep=!1,this.isAtomic&&this.homeContext.receiver&&this.homeContext.receiver.endWarp&&(this.homeContext.receiver.endWarp(),this.homeContext.receiver.startWarp()),this.readyToTerminate){for(;this.context;)this.popContext();
this.homeContext.receiver&&this.homeContext.receiver.endWarp&&this.homeContext.receiver.endWarp()}},Process.prototype.stop=function(){this.readyToYield=!0,this.readyToTerminate=!0,this.errorFlag=!1,this.context&&this.context.stopMusic()},Process.prototype.pause=function(){this.readyToTerminate||(this.isPaused=!0,this.flashPausedContext(),this.context&&this.context.startTime&&(this.pauseOffset=Date.now()-this.context.startTime))},Process.prototype.resume=function(){this.enableSingleStepping||this.unflash(),this.isPaused=!1,this.pauseOffset=null},Process.prototype.pauseStep=function(){this.lastYield=Date.now(),this.context&&this.context.startTime&&(this.context.startTime=this.lastYield-this.pauseOffset);
},Process.prototype.evaluateContext=function(){var exp=this.context.expression;return this.frameCount+=1,"exit"===this.context.tag&&this.expectReport(),exp instanceof Array?this.evaluateSequence(exp):exp instanceof MultiArgMorph?this.evaluateMultiSlot(exp,exp.inputs().length):exp instanceof ArgLabelMorph?this.evaluateArgLabel(exp):exp instanceof ArgMorph||exp.bindingID?this.evaluateInput(exp):exp instanceof BlockMorph?this.evaluateBlock(exp,exp.inputs().length):isString(exp)?this[exp].apply(this,this.context.inputs):void this.popContext()},Process.prototype.evaluateBlock=function(block,argCount){var selector=block.selector;if("reportOr"===selector||"reportAnd"===selector||"doReport"===selector)return this[selector](block);
var rcvr=this.context.receiver||this.receiver,inputs=this.context.inputs;if(argCount>inputs.length)this.evaluateNextInput(block);else{if(this.flashContext())return;if(this[selector]&&(rcvr=this),this.isCatchingErrors)try{this.returnValueToParentContext(rcvr[selector].apply(rcvr,inputs)),this.popContext()}catch(error){this.handleError(error,block)}else this.returnValueToParentContext(rcvr[selector].apply(rcvr,inputs)),this.popContext()}},Process.prototype.reportOr=function(block){var inputs=this.context.inputs;if(inputs.length<1)this.evaluateNextInput(block);else if(inputs[0]){if(this.flashContext())return;this.returnValueToParentContext(!0),this.popContext()}else if(inputs.length<2)this.evaluateNextInput(block);else{
if(this.flashContext())return;this.returnValueToParentContext(inputs[1]===!0),this.popContext()}},Process.prototype.reportAnd=function(block){var inputs=this.context.inputs;if(inputs.length<1)this.evaluateNextInput(block);else if(inputs[0])if(inputs.length<2)this.evaluateNextInput(block);else{if(this.flashContext())return;this.returnValueToParentContext(inputs[1]===!0),this.popContext()}else{if(this.flashContext())return;this.returnValueToParentContext(!1),this.popContext()}},Process.prototype.doReport=function(block){var outer=this.context.outerContext;if(!this.flashContext()){if(this.isClicked&&block.topBlock()===this.topBlock&&(this.isShowingResult=!0),this.context.expression.partOfCustomCommand)this.doStopCustomBlock(),
this.popContext();else{for(;this.context&&"exit"!==this.context.tag;)"doStopWarping"===this.context.expression?this.doStopWarping():this.popContext();this.context&&("expectReport"===this.context.expression?this.popContext():this.context.tag=null)}this.pushContext(block.inputs()[0],outer)}},Process.prototype.evaluateMultiSlot=function(multiSlot,argCount){var ans,inputs=this.context.inputs;if(multiSlot.bindingID){if(this.isCatchingErrors)try{ans=this.context.variables.getVar(multiSlot.bindingID)}catch(error){this.handleError(error,multiSlot)}else ans=this.context.variables.getVar(multiSlot.bindingID);this.returnValueToParentContext(ans),this.popContext()}else argCount>inputs.length?this.evaluateNextInput(multiSlot):(this.returnValueToParentContext(new List(inputs)),
this.popContext())},Process.prototype.evaluateArgLabel=function(argLabel){var inputs=this.context.inputs;inputs.length<1?this.evaluateNextInput(argLabel):(this.returnValueToParentContext(inputs[0]),this.popContext())},Process.prototype.evaluateInput=function(input){var ans;if(!this.flashContext()){if(input.bindingID)if(this.isCatchingErrors)try{ans=this.context.variables.getVar(input.bindingID)}catch(error){this.handleError(error,input)}else ans=this.context.variables.getVar(input.bindingID);else ans=input.evaluate(),ans&&(input.constructor===CommandSlotMorph||input.constructor===ReporterSlotMorph||input instanceof CSlotMorph&&(!input.isStatic||input.isLambda))&&(ans=this.reify(ans,new List));
this.returnValueToParentContext(ans),this.popContext()}},Process.prototype.evaluateSequence=function(arr){var pc=this.context.pc,outer=this.context.outerContext,isCustomBlock=this.context.isCustomBlock;pc===arr.length-1?(this.context=new Context(this.context.parentContext,arr[pc],this.context.outerContext,this.context.receiver),this.context.isCustomBlock=isCustomBlock):pc>=arr.length?this.popContext():(this.context.pc+=1,this.pushContext(arr[pc],outer))},Process.prototype.evaluateNextInput=function(element){var nxt=this.context.inputs.length,args=element.inputs(),exp=args[nxt],sel=this.context.expression.selector,outer=this.context.outerContext;exp.isUnevaluated&&(exp.isUnevaluated===!0||exp.isUnevaluated())?"reify"===sel||"reportScript"===sel?this.context.addInput(exp):this.context.addInput(this.reify(exp,new List)):this.pushContext(exp,outer);
},Process.prototype.doYield=function(){this.popContext(),this.isAtomic||(this.readyToYield=!0)},Process.prototype.expectReport=function(){this.handleError(new Error("reporter didn't report"))},Process.prototype.handleError=function(error,element){var m=element;this.stop(),this.errorFlag=!0,this.topBlock.addErrorHighlight(),(isNil(m)||isNil(m.world()))&&(m=this.topBlock),m.showBubble((m===element?"":"Inside: ")+error.name+"\n"+error.message,this.exportResult,this.receiver)},Process.prototype.errorObsolete=function(){throw new Error("a custom block definition is missing")},Process.prototype.reify=function(topBlock,parameterNames,isCustomBlock){var context=new Context(null,null,this.context?this.context.outerContext:null),i=0;
return topBlock?(context.expression=this.enableLiveCoding||this.enableSingleStepping?topBlock:topBlock.fullCopy(),context.expression.show(),isCustomBlock||parameterNames.length()||(context.expression.allEmptySlots().forEach(function(slot){i+=1,slot instanceof MultiArgMorph?slot.bindingID=["arguments"]:slot.bindingID=i}),context.emptySlots=i)):context.expression=this.enableLiveCoding||this.enableSingleStepping?[this.context.expression]:[this.context.expression.fullCopy()],context.inputs=parameterNames.asArray(),context.receiver=this.context?this.context.receiver:this.receiver,context.origin=context.receiver,context},Process.prototype.reportScript=function(parameterNames,topBlock){
return this.reify(topBlock,parameterNames)},Process.prototype.reifyScript=function(topBlock,parameterNames){return this.reify(topBlock,parameterNames)},Process.prototype.reifyReporter=function(topBlock,parameterNames){return this.reify(topBlock,parameterNames)},Process.prototype.reifyPredicate=function(topBlock,parameterNames){return this.reify(topBlock,parameterNames)},Process.prototype.reportJSFunction=function(parmNames,body){return Function.apply(null,parmNames.asArray().concat([body]))},Process.prototype.doRun=function(context,args){return this.evaluate(context,args,!0)},Process.prototype.evaluate=function(context,args,isCommand){if(!context)return null;if(context instanceof Function)return context.apply(this.blockReceiver(),args.asArray().concat([this]));
if(context.isContinuation)return this.runContinuation(context,args);if(!(context instanceof Context))throw new Error("expecting a ring but getting "+context);var exit,runnable,i,value,outer=new Context(null,null,context.outerContext),caller=this.context.parentContext,parms=args.asArray();if(outer.receiver||(outer.receiver=context.receiver),runnable=new Context(this.context.parentContext,context.expression,outer,context.receiver),this.context.parentContext=runnable,context.expression instanceof ReporterBlockMorph&&(this.readyToYield=Date.now()-this.lastYield>this.timeout),parms.length>0){for(i=0;i<context.inputs.length;i+=1)value=0,isNil(parms[i])||(value=parms[i]),
outer.variables.addVar(context.inputs[i],value);if(0===context.inputs.length)if(outer.variables.addVar(["arguments"],args),1===parms.length)for(i=1;i<=context.emptySlots;i+=1)outer.variables.addVar(i,parms[0]);else if(parms.length===context.emptySlots)for(i=1;i<=parms.length;i+=1)outer.variables.addVar(i,parms[i-1]);else if(1!==context.emptySlots)throw new Error(localize("expecting")+" "+context.emptySlots+" "+localize("input(s), but getting")+" "+parms.length)}runnable.expression instanceof CommandBlockMorph&&(runnable.expression=runnable.expression.blockSequence(),isCommand||(caller?caller.tag="exit":(exit=new Context(runnable.parentContext,"expectReport",outer,outer.receiver),
exit.tag="exit",runnable.parentContext=exit)))},Process.prototype.fork=function(context,args){var proc=new Process,stage=this.homeContext.receiver.parentThatIsA(StageMorph);proc.instrument=this.instrument,proc.receiver=this.receiver,proc.initializeFor(context,args,this.enableSingleStepping),stage.threads.processes.push(proc)},Process.prototype.initializeFor=function(context,args,ignoreExit){if(context.isContinuation)throw new Error("continuations cannot be forked");if(!(context instanceof Context))throw new Error("expecting a ring but getting "+context);var i,value,exit,outer=new Context(null,null,context.outerContext),runnable=new Context(null,context.expression,outer),parms=args.asArray();
if(this.context=context.receiver,parms.length>0){for(i=0;i<context.inputs.length;i+=1)value=0,isNil(parms[i])||(value=parms[i]),outer.variables.addVar(context.inputs[i],value);if(0===context.inputs.length)if(outer.variables.addVar(["arguments"],args),1===parms.length)for(i=1;i<=context.emptySlots;i+=1)outer.variables.addVar(i,parms[0]);else if(parms.length===context.emptySlots)for(i=1;i<=parms.length;i+=1)outer.variables.addVar(i,parms[i-1]);else if(1!==context.emptySlots)throw new Error(localize("expecting")+" "+context.emptySlots+" "+localize("input(s), but getting")+" "+parms.length)}runnable.expression instanceof CommandBlockMorph&&(runnable.expression=runnable.expression.blockSequence(),
ignoreExit||(exit=new Context(runnable.parentContext,"expectReport",outer,outer.receiver),exit.tag="exit",runnable.parentContext=exit)),this.homeContext=new Context,this.homeContext.receiver=context.outerContext.receiver,this.topBlock=context.expression,this.context=runnable},Process.prototype.doStopBlock=function(){var target=this.context.expression.exitTag;if(isNil(target))return this.doStopCustomBlock();for(;this.context&&(isNil(this.context.tag)||this.context.tag>target);)"doStopWarping"===this.context.expression?this.doStopWarping():this.popContext();this.pushContext()},Process.prototype.doStopCustomBlock=function(){for(;this.context&&!this.context.isCustomBlock;)"doStopWarping"===this.context.expression?this.doStopWarping():this.popContext();
},Process.prototype.doCallCC=function(aContext,isReporter){this.evaluate(aContext,new List([this.context.continuation()]),!isReporter)},Process.prototype.reportCallCC=function(aContext){this.doCallCC(aContext,!0)},Process.prototype.runContinuation=function(aContext,args){var parms=args.asArray();return"expectReport"===aContext.expression&&parms.length?(this.stop(),void(this.homeContext.inputs[0]=parms[0])):(this.context.parentContext=aContext.copyForContinuationCall(),void(1===parms.length&&this.context.parentContext.outerContext.variables.addVar(1,parms[0])))},Process.prototype.evaluateCustomBlock=function(){var runnable,exit,i,value,outer,caller=this.context.parentContext,block=this.context.expression,method=block.isGlobal?block.definition:this.blockReceiver().getMethod(block.semanticSpec),context=method.body,declarations=method.declarations,args=new List(this.context.inputs),parms=args.asArray();
if(!context)return null;if(this.procedureCount+=1,outer=new Context,outer.receiver=this.context.receiver,outer.variables.parentFrame=block.variables,method.variableNames.length?block.variables.parentFrame=outer.receiver?outer.receiver.variables:null:outer.variables.parentFrame=outer.receiver?outer.receiver.variables:null,runnable=new Context(this.context.parentContext,context.expression,outer,outer.receiver),runnable.isCustomBlock=!0,this.context.parentContext=runnable,parms.length>0)for(i=0;i<context.inputs.length;i+=1)value=0,isNil(parms[i])||(value=parms[i]),outer.variables.addVar(context.inputs[i],value),"%upvar"===declarations[context.inputs[i]][0]&&(this.context.outerContext.variables.vars[value]=outer.variables.vars[context.inputs[i]]);
"command"!==method.type?(caller?caller.tag="exit":(exit=new Context(runnable.parentContext,"expectReport",outer,outer.receiver),exit.tag="exit",runnable.parentContext=exit),this.readyToYield=Date.now()-this.lastYield>this.timeout):(runnable.expression.tagExitBlocks(this.procedureCount,!0),caller&&!caller.tag&&(caller.tag=this.procedureCount),!this.isAtomic&&method.isDirectlyRecursive()&&(this.readyToYield=!0)),runnable.expression=runnable.expression.blockSequence()},Process.prototype.doDeclareVariables=function(varNames){var varFrame=this.context.outerContext.variables;varNames.asArray().forEach(function(name){varFrame.addVar(name)})},Process.prototype.doSetVar=function(varName,value){
var rcvr,varFrame=this.context.variables,name=varName;return name instanceof Context?(rcvr=this.blockReceiver(),"reportGetVar"===name.expression.selector?void name.variables.setVar(name.expression.blockSpec,value,rcvr):void this.doSet(name,value)):void varFrame.setVar(name,value,this.blockReceiver())},Process.prototype.doChangeVar=function(varName,value){var varFrame=this.context.variables,name=varName;return name instanceof Context&&"reportGetVar"===name.expression.selector?void name.variables.changeVar(name.expression.blockSpec,value,this.blockReceiver()):void varFrame.changeVar(name,value,this.blockReceiver())},Process.prototype.reportGetVar=function(){return this.context.variables.getVar(this.context.expression.blockSpec);
},Process.prototype.doShowVar=function(varName){var stage,watcher,target,label,others,isGlobal,varFrame=this.context.variables,name=varName;if(name instanceof Context){if("reportGetVar"!==name.expression.selector)return void this.doChangePrimitiveVisibility(name.expression,!1);name=name.expression.blockSpec}if(this.homeContext.receiver&&(stage=this.homeContext.receiver.parentThatIsA(StageMorph))){if(target=varFrame.silentFind(name),!target)return;if(watcher=detect(stage.children,function(morph){return morph instanceof WatcherMorph&&morph.target===target&&morph.getter===name}),null!==watcher)return watcher.show(),void watcher.fixLayout();isGlobal=contains(this.homeContext.receiver.globalVariables().names(),varName),
label=isGlobal||target.owner?name:name+" "+localize("(temporary)"),watcher=new WatcherMorph(label,SpriteMorph.prototype.blockColor.variables,target,name),watcher.setPosition(stage.position().add(10)),others=stage.watchers(watcher.left()),others.length>0&&watcher.setTop(others[others.length-1].bottom()),stage.add(watcher),watcher.fixLayout()}},Process.prototype.doHideVar=function(varName){var stage,watcher,target,varFrame=this.context.variables,name=varName;if(name instanceof Context){if("reportGetVar"!==name.expression.selector)return void this.doChangePrimitiveVisibility(name.expression,!0);name=name.expression.blockSpec}return name?void(this.homeContext.receiver&&(stage=this.homeContext.receiver.parentThatIsA(StageMorph),
stage&&(target=varFrame.find(name),watcher=detect(stage.children,function(morph){return morph instanceof WatcherMorph&&morph.target===target&&morph.getter===name}),null!==watcher&&(watcher.isTemporary()?watcher.destroy():watcher.hide())))):void this.doRemoveTemporaries()},Process.prototype.doRemoveTemporaries=function(){var stage;this.homeContext.receiver&&(stage=this.homeContext.receiver.parentThatIsA(StageMorph),stage&&stage.watchers().forEach(function(watcher){watcher.isTemporary()&&watcher.destroy()}))},Process.prototype.doChangePrimitiveVisibility=function(aBlock,hideIt){var dict,cat,ide=this.homeContext.receiver.parentThatIsA(IDE_Morph);ide&&"evaluateCustomBlock"!==aBlock.selector&&(hideIt?StageMorph.prototype.hiddenPrimitives[aBlock.selector]=!0:delete StageMorph.prototype.hiddenPrimitives[aBlock.selector],
dict={doWarp:"control",reifyScript:"operators",reifyReporter:"operators",reifyPredicate:"operators",doDeclareVariables:"variables"},cat=dict[this.selector]||this.category,"lists"===cat&&(cat="variables"),ide.flushBlocksCache(cat),ide.refreshPalette())},Process.prototype.doDeleteAttr=function(attrName){var name=attrName,rcvr=this.blockReceiver();if(name instanceof Context){if("reportGetVar"!==name.expression.selector)return name={xPosition:"x position",yPosition:"y position",direction:"direction",getCostumeIdx:"costume #",size:"size"}[name.expression.selector],void(isNil(name)||rcvr.inheritAttribute(name));name=name.expression.blockSpec}return name instanceof Array?rcvr.inheritAttribute(this.inputOption(name)):void(contains(rcvr.inheritedVariableNames(!0),name)&&rcvr.deleteVariable(name));
},Process.prototype.doTellTo=function(sprite,context,args){this.doRun(this.reportAttributeOf(context,sprite),args)},Process.prototype.reportAskFor=function(sprite,context,args){this.evaluate(this.reportAttributeOf(context,sprite),args)},Process.prototype.reportNewList=function(elements){return elements},Process.prototype.reportCONS=function(car,cdr){return this.assertType(cdr,"list"),(new List).cons(car,cdr)},Process.prototype.reportCDR=function(list){return this.assertType(list,"list"),list.cdr()},Process.prototype.doAddToList=function(element,list){this.assertType(list,"list"),list.type&&this.assertType(element,list.type),list.add(element)},Process.prototype.doDeleteFromList=function(index,list){
var idx=index;if(this.assertType(list,"list"),"all"===this.inputOption(index))return list.clear();if(""===index)return null;if("last"===this.inputOption(index))idx=list.length();else if(isNaN(+this.inputOption(index)))return null;list.remove(idx)},Process.prototype.doInsertInList=function(element,index,list){var idx=index;return this.assertType(list,"list"),list.type&&this.assertType(element,list.type),""===index?null:("any"===this.inputOption(index)&&(idx=this.reportRandom(1,list.length()+1)),"last"===this.inputOption(index)&&(idx=list.length()+1),void list.add(element,idx))},Process.prototype.doReplaceInList=function(index,list,element){var idx=index;return this.assertType(list,"list"),
list.type&&this.assertType(element,list.type),""===index?null:("any"===this.inputOption(index)&&(idx=this.reportRandom(1,list.length())),"last"===this.inputOption(index)&&(idx=list.length()),void list.put(element,idx))},Process.prototype.reportListItem=function(index,list){var idx=index;return this.assertType(list,"list"),""===index?"":("any"===this.inputOption(index)&&(idx=this.reportRandom(1,list.length())),"last"===this.inputOption(index)&&(idx=list.length()),list.at(idx))},Process.prototype.reportListLength=function(list){return this.assertType(list,"list"),list.length()},Process.prototype.reportListContainsItem=function(list,element){return this.assertType(list,"list"),
list.contains(element)},Process.prototype.doShowTable=function(list){this.assertType(list,"list"),new TableDialogMorph(list).popUp(this.blockReceiver().world())},Process.prototype.doIf=function(){var args=this.context.inputs,outer=this.context.outerContext,isCustomBlock=this.context.isCustomBlock;this.popContext(),args[0]&&args[1]&&(this.pushContext(args[1].blockSequence(),outer),this.context.isCustomBlock=isCustomBlock),this.pushContext()},Process.prototype.doIfElse=function(){var args=this.context.inputs,outer=this.context.outerContext,isCustomBlock=this.context.isCustomBlock;this.popContext(),args[0]?args[1]&&this.pushContext(args[1].blockSequence(),outer):args[2]?this.pushContext(args[2].blockSequence(),outer):this.pushContext("doYield"),
this.context&&(this.context.isCustomBlock=isCustomBlock),this.pushContext()},Process.prototype.doStop=function(){this.stop()},Process.prototype.doStopAll=function(){var stage,ide;this.homeContext.receiver&&(stage=this.homeContext.receiver.parentThatIsA(StageMorph),stage&&(stage.threads.resumeAll(stage),stage.keysPressed={},stage.threads.stopAll(),stage.stopAllActiveSounds(),stage.children.forEach(function(morph){morph.stopTalking&&morph.stopTalking()}),stage.removeAllClones()),ide=stage.parentThatIsA(IDE_Morph),ide&&ide.controlBar.pauseButton.refresh())},Process.prototype.doStopThis=function(choice){switch(this.inputOption(choice)){case"all":this.doStopAll();break;
case"this script":this.doStop();break;case"this block":this.doStopBlock();break;default:this.doStopOthers(choice)}},Process.prototype.doStopOthers=function(choice){var stage;if(this.homeContext.receiver&&(stage=this.homeContext.receiver.parentThatIsA(StageMorph)))switch(this.inputOption(choice)){case"all but this script":stage.threads.stopAll(this);break;case"other scripts in sprite":stage.threads.stopAllForReceiver(this.homeContext.receiver,this);break;default:nop()}},Process.prototype.doWarp=function(body){var stage,outer=this.context.outerContext,isCustomBlock=this.context.isCustomBlock;this.popContext(),body&&(this.homeContext.receiver&&(this.homeContext.receiver.startWarp&&this.homeContext.receiver.startWarp(),
stage=this.homeContext.receiver.parentThatIsA(StageMorph),stage&&(stage.fps=0)),this.pushContext("doYield"),this.context.isCustomBlock=isCustomBlock,this.isAtomic||this.pushContext("doStopWarping"),this.pushContext(body.blockSequence(),outer),this.isAtomic=!0),this.pushContext()},Process.prototype.doStopWarping=function(){var stage;this.popContext(),this.isAtomic=!1,this.homeContext.receiver&&(this.homeContext.receiver.endWarp&&this.homeContext.receiver.endWarp(),stage=this.homeContext.receiver.parentThatIsA(StageMorph),stage&&(stage.fps=stage.frameRate))},Process.prototype.reportIsFastTracking=function(){var ide;return!(!this.homeContext.receiver||!(ide=this.homeContext.receiver.parentThatIsA(IDE_Morph)))&&ide.stage.isFastTracked;
},Process.prototype.doSetFastTracking=function(bool){var ide;this.reportIsA(bool,"Boolean")&&this.homeContext.receiver&&(ide=this.homeContext.receiver.parentThatIsA(IDE_Morph),ide&&(bool?ide.startFastTracking():ide.stopFastTracking()))},Process.prototype.doPauseAll=function(){var stage,ide;this.homeContext.receiver&&(stage=this.homeContext.receiver.parentThatIsA(StageMorph),stage&&stage.threads.pauseAll(stage),ide=stage.parentThatIsA(IDE_Morph),ide&&ide.controlBar.pauseButton.refresh())},Process.prototype.doForever=function(body){this.context.inputs=[],this.pushContext("doYield"),body&&this.pushContext(body.blockSequence()),this.pushContext()},Process.prototype.doRepeat=function(counter,body){
var block=this.context.expression,outer=this.context.outerContext,isCustomBlock=this.context.isCustomBlock;return counter<1?null:(this.popContext(),this.pushContext(block,outer),this.context.isCustomBlock=isCustomBlock,this.context.addInput(counter-1),this.pushContext("doYield"),body&&this.pushContext(body.blockSequence()),void this.pushContext())},Process.prototype.doUntil=function(goalCondition,body){return goalCondition?(this.popContext(),this.pushContext("doYield"),null):(this.context.inputs=[],this.pushContext("doYield"),body&&this.pushContext(body.blockSequence()),void this.pushContext())},Process.prototype.doWaitUntil=function(goalCondition){return goalCondition?(this.popContext(),
this.pushContext("doYield"),null):(this.context.inputs=[],this.pushContext("doYield"),void this.pushContext())},Process.prototype.reportMap=function(reporter,list){var next;if(list.isLinked){if(this.context.inputs.length<3&&(this.context.addInput(new List),this.context.inputs[2].isLinked=!0,this.context.addInput(this.context.inputs[2]),this.context.addInput(list)),0===this.context.inputs[4].length())return this.context.inputs[3].rest=list.cons(this.context.inputs[5]),void this.returnValueToParentContext(this.context.inputs[2].cdr());this.context.inputs.length>5&&(this.context.inputs[3].rest=list.cons(this.context.inputs[5]),this.context.inputs[3]=this.context.inputs[3].rest,
this.context.inputs.splice(5)),next=this.context.inputs[4].at(1),this.context.inputs[4]=this.context.inputs[4].cdr(),this.pushContext(),this.evaluate(reporter,new List([next]))}else{if(this.context.inputs.length-2===list.length())return void this.returnValueToParentContext(new List(this.context.inputs.slice(2)));next=list.at(this.context.inputs.length-1),this.pushContext(),this.evaluate(reporter,new List([next]))}},Process.prototype.doForEach=function(upvar,list,script){isNil(this.context.inputs[3])&&(this.context.inputs[3]=1);var index=this.context.inputs[3];this.context.outerContext.variables.addVar(upvar),this.context.outerContext.variables.setVar(upvar,list.at(index)),
index>list.length()||(this.context.inputs[3]+=1,this.pushContext("doYield"),this.pushContext(),this.evaluate(script,new List,!0))},Process.prototype.doWait=function(secs){return this.context.startTime||(this.context.startTime=Date.now()),Date.now()-this.context.startTime>=1e3*secs?(this.isAtomic||0!==secs||(this.readyToYield=!0),null):(this.pushContext("doYield"),void this.pushContext())},Process.prototype.doGlide=function(secs,endX,endY){return this.context.startTime||(this.context.startTime=Date.now(),this.context.startValue=new Point(this.blockReceiver().xPosition(),this.blockReceiver().yPosition())),Date.now()-this.context.startTime>=1e3*secs?(this.blockReceiver().gotoXY(endX,endY),
null):(this.blockReceiver().glide(1e3*secs,endX,endY,Date.now()-this.context.startTime,this.context.startValue),this.pushContext("doYield"),void this.pushContext())},Process.prototype.doSayFor=function(data,secs){return this.context.startTime||(this.context.startTime=Date.now(),this.blockReceiver().bubble(data)),Date.now()-this.context.startTime>=1e3*secs?(this.blockReceiver().stopTalking(),null):(this.pushContext("doYield"),void this.pushContext())},Process.prototype.doThinkFor=function(data,secs){return this.context.startTime||(this.context.startTime=Date.now(),this.blockReceiver().doThink(data)),Date.now()-this.context.startTime>=1e3*secs?(this.blockReceiver().stopTalking(),
null):(this.pushContext("doYield"),void this.pushContext())},Process.prototype.blockReceiver=function(){return this.context?this.context.receiver||this.homeContext.receiver:this.homeContext.receiver||this.receiver},Process.prototype.doPlaySoundUntilDone=function(name){var sprite=this.blockReceiver();return null===this.context.activeAudio&&(this.context.activeAudio=sprite.playSound(name)),this.context.activeAudio.ended||this.context.activeAudio.terminated?null:(this.pushContext("doYield"),void this.pushContext())},Process.prototype.doStopAllSounds=function(){var stage=this.homeContext.receiver.parentThatIsA(StageMorph);stage&&(stage.threads.processes.forEach(function(thread){
thread.context&&(thread.context.stopMusic(),thread.context.activeAudio&&thread.popContext())}),stage.stopAllActiveSounds())},Process.prototype.doAsk=function(data){var activePrompter,stage=this.homeContext.receiver.parentThatIsA(StageMorph),rcvr=this.blockReceiver(),isStage=rcvr instanceof StageMorph,isHiddenSprite=rcvr instanceof SpriteMorph&&!rcvr.isVisible;if(stage.keysPressed={},this.prompter){if(this.prompter.isDone)return stage.lastAnswer=this.prompter.inputField.getValue(),this.prompter.destroy(),this.prompter=null,isStage||rcvr.stopTalking(),null}else activePrompter=detect(stage.children,function(morph){return morph instanceof StagePrompterMorph}),activePrompter||(isStage||isHiddenSprite||rcvr.bubble(data,!1,!0),
this.prompter=new StagePrompterMorph(isStage||isHiddenSprite?data:null),stage.scale<1?this.prompter.setWidth(stage.width()-10):this.prompter.setWidth(stage.dimensions.x-20),this.prompter.fixLayout(),this.prompter.setCenter(stage.center()),this.prompter.setBottom(stage.bottom()-this.prompter.border),stage.add(this.prompter),this.prompter.inputField.edit(),stage.changed());this.pushContext("doYield"),this.pushContext()},Process.prototype.reportLastAnswer=function(){return this.homeContext.receiver.parentThatIsA(StageMorph).lastAnswer},Process.prototype.reportURL=function(url){var response;if(this.httpRequest){if(4===this.httpRequest.readyState)return response=this.httpRequest.responseText,
this.httpRequest=null,response}else(url.indexOf("//")<0||url.indexOf("//")>8)&&(url="file:"===location.protocol?"https://"+url:location.protocol+"//"+url),this.httpRequest=new XMLHttpRequest,this.httpRequest.open("GET",url,!0),this.httpRequest.send(null);this.pushContext("doYield"),this.pushContext()},Process.prototype.doBroadcast=function(message){var thisObj,trg,rcvrs,stage=this.homeContext.receiver.parentThatIsA(StageMorph),msg=message,myself=this,procs=[];if(message instanceof List&&2===message.length())if(thisObj=this.blockReceiver(),msg=message.at(1),trg=message.at(2),isSnapObject(trg))rcvrs=[trg];else if(isString(trg))rcvrs=trg===stage.name?[stage]:[this.getOtherObject(trg,thisObj,stage)];else{
if(!(trg instanceof List))return;rcvrs=trg.itemsArray().map(function(each){return myself.getOtherObject(each,thisObj,stage)})}else rcvrs=stage.children.concat(stage);return""!==msg&&(stage.lastMessage=message,rcvrs.forEach(function(morph){isSnapObject(morph)&&morph.allHatBlocksFor(msg).forEach(function(block){procs.push(stage.threads.startProcess(block,morph,stage.isThreadSafe))})})),procs},Process.prototype.doBroadcastAndWait=function(message){return this.context.activeSends||(this.context.activeSends=this.doBroadcast(message)),this.context.activeSends=this.context.activeSends.filter(function(proc){return proc.isRunning()}),0===this.context.activeSends.length?null:(this.pushContext("doYield"),
void this.pushContext())},Process.prototype.getLastMessage=function(){var stage;return this.homeContext.receiver&&(stage=this.homeContext.receiver.parentThatIsA(StageMorph))?stage.getLastMessage():""},Process.prototype.reportIsA=function(thing,typeString){return this.reportTypeOf(thing)===this.inputOption(typeString)},Process.prototype.assertType=function(thing,typeString){var thingType=this.reportTypeOf(thing);if(thingType===typeString)return!0;if(typeString instanceof Array&&contains(typeString,thingType))return!0;throw new Error("expecting "+typeString+" but getting "+thingType)},Process.prototype.assertAlive=function(thing){if(thing&&thing.isCorpse)throw new Error("cannot operate on a deleted sprite");
},Process.prototype.reportTypeOf=function(thing){var exp;return null===thing||void 0===thing?"nothing":thing===!0||thing===!1?"Boolean":isNaN(+thing)?isString(thing)?"text":thing instanceof List?"list":thing instanceof SpriteMorph?"sprite":thing instanceof StageMorph?"stage":thing instanceof Costume?"costume":thing instanceof Sound?"sound":thing instanceof Context?thing.expression instanceof RingMorph?thing.expression.dataType():thing.expression instanceof ReporterBlockMorph?thing.expression.isPredicate?"predicate":"reporter":thing.expression instanceof Array?(exp=thing.expression[thing.pc||0],exp.isPredicate?"predicate":exp instanceof RingMorph?exp.dataType():exp instanceof ReporterBlockMorph?"reporter":exp instanceof CommandBlockMorph?"command":"reporter"):thing.expression instanceof CommandBlockMorph?"command":"reporter":"undefined":"number";
},Process.prototype.reportSum=function(a,b){return+a+ +b},Process.prototype.reportDifference=function(a,b){return+a-+b},Process.prototype.reportProduct=function(a,b){return+a*+b},Process.prototype.reportQuotient=function(a,b){return+a/+b},Process.prototype.reportModulus=function(a,b){var x=+a,y=+b;return(x%y+y)%y},Process.prototype.reportRandom=function(min,max){var floor=+min,ceil=+max;return floor%1!==0||ceil%1!==0?Math.random()*(ceil-floor)+floor:Math.floor(Math.random()*(ceil-floor+1))+floor},Process.prototype.reportLessThan=function(a,b){var x=+a,y=+b;return(isNaN(x)||isNaN(y))&&(x=a,y=b),x<y},Process.prototype.reportNot=function(bool){return!bool},Process.prototype.reportGreaterThan=function(a,b){
var x=+a,y=+b;return(isNaN(x)||isNaN(y))&&(x=a,y=b),x>y},Process.prototype.reportEquals=function(a,b){return snapEquals(a,b)},Process.prototype.reportIsIdentical=function(a,b){function clear(){Object.prototype.hasOwnProperty.call(a,tag)&&delete a[tag],Object.prototype.hasOwnProperty.call(b,tag)&&delete b[tag]}var tag="idTag";return this.isImmutable(a)||this.isImmutable(b)?snapEquals(a,b):(clear(),a[tag]=Date.now(),b[tag]===a[tag]?(clear(),!0):(clear(),!1))},Process.prototype.isImmutable=function(obj){var type=this.reportTypeOf(obj);return"nothing"===type||"Boolean"===type||"text"===type||"number"===type||"undefined"===type},Process.prototype.reportBoolean=function(bool){
return bool},Process.prototype.reportRound=function(n){return Math.round(+n)},Process.prototype.reportMonadic=function(fname,n){var x=+n,result=0;switch(this.inputOption(fname)){case"abs":result=Math.abs(x);break;case"ceiling":result=Math.ceil(x);break;case"floor":result=Math.floor(x);break;case"sqrt":result=Math.sqrt(x);break;case"sin":result=Math.sin(radians(x));break;case"cos":result=Math.cos(radians(x));break;case"tan":result=Math.tan(radians(x));break;case"asin":result=degrees(Math.asin(x));break;case"acos":result=degrees(Math.acos(x));break;case"atan":result=degrees(Math.atan(x));break;case"ln":result=Math.log(x);break;case"log":result=Math.log(x)/Math.LN10;
break;case"e^":result=Math.exp(x);break;case"10^":result=Math.pow(10,x);break;default:nop()}return result},Process.prototype.reportTextFunction=function(fname,string){var x=(isNil(string)?"":string).toString(),result="";switch(this.inputOption(fname)){case"encode URI":result=encodeURI(x);break;case"decode URI":result=decodeURI(x);break;case"encode URI component":result=encodeURIComponent(x);break;case"decode URI component":result=decodeURIComponent(x);break;case"XML escape":result=(new XML_Element).escape(x);break;case"XML unescape":result=(new XML_Element).unescape(x);break;case"hex sha512 hash":result=hex_sha512(x);break;default:nop()}return result},Process.prototype.reportJoin=function(a,b){
var x=(isNil(a)?"":a).toString(),y=(isNil(b)?"":b).toString();return x.concat(y)},Process.prototype.reportJoinWords=function(aList){return aList instanceof List?aList.asText():(aList||"").toString()},Process.prototype.reportLetter=function(idx,string){if(string instanceof List)return"";var i=+(idx||0),str=isNil(string)?"":string.toString();return str[i-1]||""},Process.prototype.reportStringSize=function(data){return data instanceof List?data.length():isNil(data)?0:data.toString().length},Process.prototype.reportUnicode=function(string){var str=(string||"").toString()[0];return str?str.charCodeAt(0):0},Process.prototype.reportUnicodeAsLetter=function(num){var code=+(num||0);
return String.fromCharCode(code)},Process.prototype.reportTextSplit=function(string,delimiter){var str,del,types=["text","number"],strType=this.reportTypeOf(string),delType=this.reportTypeOf(this.inputOption(delimiter));if(!contains(types,strType))throw new Error("expecting text instead of a "+strType);if(!contains(types,delType))throw new Error("expecting a text delimiter instead of a "+delType);switch(str=isNil(string)?"":string.toString(),this.inputOption(delimiter)){case"line":del=/\r\n|[\n\v\f\r\x85\u2028\u2029]/;break;case"tab":del="\t";break;case"cr":del="\r";break;case"whitespace":str=str.trim(),del=/\s+/;break;case"letter":del="";break;case"csv":return this.parseCSV(string);
default:del=isNil(delimiter)?"":delimiter.toString()}return new List(str.split(del))},Process.prototype.parseCSV=function(string){var re_valid=/^\s*(?:'[^'\\]*(?:\\[\S\s][^'\\]*)*'|"[^"\\]*(?:\\[\S\s][^"\\]*)*"|[^,'"\s\\]*(?:\s+[^,'"\s\\]+)*)\s*(?:,\s*(?:'[^'\\]*(?:\\[\S\s][^'\\]*)*'|"[^"\\]*(?:\\[\S\s][^"\\]*)*"|[^,'"\s\\]*(?:\s+[^,'"\s\\]+)*)\s*)*$/,re_value=/(?!\s*$)\s*(?:'([^'\\]*(?:\\[\S\s][^'\\]*)*)'|"([^"\\]*(?:\\[\S\s][^"\\]*)*)"|([^,'"\s\\]*(?:\s+[^,'"\s\\]+)*))\s*(?:,|$)/g,a=[];return re_valid.test(string)?(string.replace(re_value,function(m0,m1,m2,m3){return void 0!==m1?a.push(m1.replace(/\\'/g,"'")):void 0!==m2?a.push(m2.replace(/\\"/g,'"')):void 0!==m3&&a.push(m3),
""}),/,\s*$/.test(string)&&a.push(""),new List(a)):new List},Process.prototype.alert=function(data){var world;this.homeContext.receiver&&(world=this.homeContext.receiver.world(),world.isDevMode&&alert("Snap! "+data.asArray()))},Process.prototype.log=function(data){var world;this.homeContext.receiver&&(world=this.homeContext.receiver.world(),world.isDevMode)},Process.prototype.getOtherObject=function(name,thisObj,stageObj){if(isSnapObject(name))return name;var stage=isNil(stageObj)?thisObj.parentThatIsA(StageMorph):stageObj,thatObj=null;return stage&&(thatObj=detect(stage.children,function(morph){return morph.name===name}),thatObj||(thatObj=detect(stage.world().hand.children,function(morph){
return morph instanceof SpriteMorph&&morph.name===name}))),thatObj},Process.prototype.getObjectsNamed=function(name,thisObj,stageObj){function check(obj){return obj instanceof SpriteMorph&&obj.isTemporary?obj.cloneOriginName===name:obj.name===name}var stage=isNil(stageObj)?thisObj.parentThatIsA(StageMorph):stageObj,those=[];return stage&&(those=stage.children.filter(check),those.length||(those=stage.world().hand.children.filter(check))),those},Process.prototype.doFaceTowards=function(name){var thatObj,thisObj=this.blockReceiver();if(thisObj)if("mouse-pointer"===this.inputOption(name))thisObj.faceToXY(this.reportMouseX(),this.reportMouseY());else{if(name instanceof List)return void thisObj.faceToXY(name.at(1),name.at(2));
thatObj=this.getOtherObject(name,this.homeContext.receiver),thatObj&&thisObj.faceToXY(thatObj.xPosition(),thatObj.yPosition())}},Process.prototype.doGotoObject=function(name){var thatObj,thisObj=this.blockReceiver();if(thisObj)if("mouse-pointer"===this.inputOption(name))thisObj.gotoXY(this.reportMouseX(),this.reportMouseY());else{if(name instanceof List)return void thisObj.gotoXY(name.at(1),name.at(2));thatObj=this.getOtherObject(name,this.homeContext.receiver),thatObj&&thisObj.gotoXY(thatObj.xPosition(),thatObj.yPosition())}},Process.prototype.createClone=function(name){var thatObj,thisObj=this.blockReceiver();name&&thisObj&&("myself"===this.inputOption(name)?thisObj.createClone(!this.isFirstStep):(thatObj=this.getOtherObject(name,thisObj),
thatObj&&thatObj.createClone(!this.isFirstStep)))},Process.prototype.newClone=function(name){var thatObj,thisObj=this.blockReceiver();if(name&&thisObj){if("myself"===this.inputOption(name))return thisObj.newClone(!this.isFirstStep);if(thatObj=this.getOtherObject(name,thisObj))return thatObj.newClone(!this.isFirstStep)}},Process.prototype.reportTouchingObject=function(name){var thisObj=this.blockReceiver();return!!thisObj&&this.objectTouchingObject(thisObj,name)},Process.prototype.objectTouchingObject=function(thisObj,name){var those,stage,box,mouse,myself=this;if("mouse-pointer"===this.inputOption(name)){if(mouse=thisObj.world().hand.position(),thisObj.bounds.containsPoint(mouse)&&!thisObj.isTransparentAt(mouse))return!0;
}else if(stage=thisObj.parentThatIsA(StageMorph)){if("edge"===this.inputOption(name)&&(box=thisObj.bounds,!thisObj.costume&&thisObj.penBounds&&(box=thisObj.penBounds.translateBy(thisObj.position())),!stage.bounds.containsRectangle(box)))return!0;if("pen trails"===this.inputOption(name)&&thisObj.isTouching(stage.penTrailsMorph()))return!0;if(isSnapObject(name))return thisObj.isTouching(name);if(those=name instanceof List?name.itemsArray():this.getObjectsNamed(name,thisObj,stage),those.some(function(any){return thisObj.isTouching(any)}))return!0}return thisObj.parts.some(function(any){return myself.objectTouchingObject(any,name)})},Process.prototype.reportTouchingColor=function(aColor){
var stage,thisObj=this.blockReceiver();return!(!thisObj||!(stage=thisObj.parentThatIsA(StageMorph)))&&(!!thisObj.isTouching(stage.colorFiltered(aColor,thisObj))||thisObj.parts.some(function(any){return any.isTouching(stage.colorFiltered(aColor,any))}))},Process.prototype.reportColorIsTouchingColor=function(color1,color2){var stage,thisObj=this.blockReceiver();return!(!thisObj||!(stage=thisObj.parentThatIsA(StageMorph)))&&(!!thisObj.colorFiltered(color1).isTouching(stage.colorFiltered(color2,thisObj))||thisObj.parts.some(function(any){return any.colorFiltered(color1).isTouching(stage.colorFiltered(color2,any))}))},Process.prototype.reportDistanceTo=function(name){
var thatObj,stage,rc,point,thisObj=this.blockReceiver();if(thisObj){if(rc=thisObj.rotationCenter(),point=rc,"mouse-pointer"===this.inputOption(name))point=thisObj.world().hand.position();else if(name instanceof List)return new Point(thisObj.xPosition(),thisObj.yPosition()).distanceTo(new Point(name.at(1),name.at(2)));return stage=thisObj.parentThatIsA(StageMorph),thatObj=this.getOtherObject(name,thisObj,stage),thatObj&&(point=thatObj.rotationCenter()),rc.distanceTo(point)/stage.scale}return 0},Process.prototype.reportAttributeOf=function(attribute,name){var thatObj,stage,thisObj=this.blockReceiver();if(thisObj&&(this.assertAlive(thisObj),stage=thisObj.parentThatIsA(StageMorph),
thatObj=stage.name===name?stage:this.getOtherObject(name,thisObj,stage))){if(this.assertAlive(thatObj),attribute instanceof Context)return this.reportContextFor(attribute,thatObj);if(isString(attribute))return thatObj.variables.getVar(attribute);switch(this.inputOption(attribute)){case"x position":return thatObj.xPosition?thatObj.xPosition():"";case"y position":return thatObj.yPosition?thatObj.yPosition():"";case"direction":return thatObj.direction?thatObj.direction():"";case"costume #":return thatObj.getCostumeIdx();case"costume name":return thatObj.costume?thatObj.costume.name:localize(thatObj instanceof SpriteMorph?"Turtle":"Empty");case"size":return thatObj.getScale?thatObj.getScale():"";
}}return""},Process.prototype.reportGet=function(query){var neighborhood,stage,objName,thisObj=this.blockReceiver();if(thisObj)switch(this.inputOption(query)){case"self":return thisObj;case"other sprites":return stage=thisObj.parentThatIsA(StageMorph),new List(stage.children.filter(function(each){return each instanceof SpriteMorph&&each!==thisObj}));case"parts":return new List(thisObj.parts||[]);case"anchor":return thisObj.anchor||"";case"parent":return thisObj.exemplar||"";case"children":return new List(thisObj.specimens?thisObj.specimens():[]);case"temporary?":return thisObj.isTemporary||!1;case"clones":return stage=thisObj.parentThatIsA(StageMorph),objName=thisObj.name||thisObj.cloneOriginName,
new List(stage.children.filter(function(each){return each.isTemporary&&each!==thisObj&&each.cloneOriginName===objName}));case"other clones":return thisObj.isTemporary?this.reportGet(["clones"]):new List;case"neighbors":return stage=thisObj.parentThatIsA(StageMorph),neighborhood=thisObj.bounds.expandBy(new Point(thisObj.width(),thisObj.height())),new List(stage.children.filter(function(each){return each instanceof SpriteMorph&&each!==thisObj&&each.bounds.intersects(neighborhood)}));case"dangling?":return!thisObj.rotatesWithAnchor;case"rotation x":return thisObj.xPosition();case"rotation y":return thisObj.yPosition();case"center x":return thisObj.xCenter();case"center y":
return thisObj.yCenter();case"name":return thisObj.name;case"stage":return thisObj.parentThatIsA(StageMorph);case"costumes":return thisObj.reportCostumes();case"sounds":return thisObj.sounds}return""},Process.prototype.doSet=function(attribute,value){var name,rcvr;if(attribute instanceof Context){if(rcvr=this.blockReceiver(),this.assertAlive(rcvr),!(attribute instanceof Context)||"reportGet"!==attribute.expression.selector)throw new Error(localize("unsupported attribute"));switch(name=attribute.expression.inputs()[0].evaluate(),name instanceof Array&&(name=name[0]),name){case"anchor":if(this.assertType(rcvr,"sprite"),value instanceof SpriteMorph){if(!rcvr.enableNesting||contains(rcvr.allParts(),value))throw new Error(localize("unable to nest\n(disabled or circular?)"));
value.attachPart(rcvr)}else rcvr.detachFromAnchor();break;case"parent":this.assertType(rcvr,"sprite"),value=value instanceof SpriteMorph?value:null,rcvr.setExemplar(value);break;case"temporary?":this.assertType(rcvr,"sprite"),this.assertType(value,"Boolean"),rcvr.world().isDevMode&&(value?rcvr.release():rcvr.perpetuate());break;case"dangling?":this.assertType(rcvr,"sprite"),this.assertType(value,"Boolean"),rcvr.rotatesWithAnchor=!value,rcvr.version=Date.now();break;case"rotation x":this.assertType(rcvr,"sprite"),this.assertType(value,"number"),rcvr.setRotationX(value);break;case"rotation y":this.assertType(rcvr,"sprite"),this.assertType(value,"number"),rcvr.setRotationY(value);
break;default:throw new Error('"'+localize(name)+'" '+localize("is read-only"))}}},Process.prototype.reportContextFor=function(context,otherObj){var result=copy(context);return result.receiver=otherObj,result.outerContext&&(result.outerContext=copy(result.outerContext),result.outerContext.variables=copy(result.outerContext.variables),result.outerContext.receiver=otherObj,result.outerContext.variables.parentFrame=otherObj.variables),result},Process.prototype.reportMouseX=function(){var stage,world;return this.homeContext.receiver&&(stage=this.homeContext.receiver.parentThatIsA(StageMorph),stage&&(world=stage.world()))?(world.hand.position().x-stage.center().x)/stage.scale:0;
},Process.prototype.reportMouseY=function(){var stage,world;return this.homeContext.receiver&&(stage=this.homeContext.receiver.parentThatIsA(StageMorph),stage&&(world=stage.world()))?(stage.center().y-world.hand.position().y)/stage.scale:0},Process.prototype.reportMouseDown=function(){var world;return!(!this.homeContext.receiver||!(world=this.homeContext.receiver.world()))&&"left"===world.hand.mouseButton},Process.prototype.reportKeyPressed=function(keyString){var stage;return!(!this.homeContext.receiver||!(stage=this.homeContext.receiver.parentThatIsA(StageMorph)))&&("any key"===this.inputOption(keyString)?Object.keys(stage.keysPressed).length>0:void 0!==stage.keysPressed[keyString]);
},Process.prototype.doResetTimer=function(){var stage;this.homeContext.receiver&&(stage=this.homeContext.receiver.parentThatIsA(StageMorph),stage&&stage.resetTimer())},Process.prototype.reportTimer=function(){var stage;return this.homeContext.receiver&&(stage=this.homeContext.receiver.parentThatIsA(StageMorph))?stage.getTimer():0},Process.prototype.reportDate=function(datefn){var currDate,func,result,inputFn=this.inputOption(datefn),dateMap={year:"getFullYear",month:"getMonth",date:"getDate","day of week":"getDay",hour:"getHours",minute:"getMinutes",second:"getSeconds","time in milliseconds":"getTime"};return dateMap[inputFn]?(currDate=new Date,func=dateMap[inputFn],
result=currDate[func](),"month"!==inputFn&&"day of week"!==inputFn||(result+=1),result):""},Process.prototype.doMapCodeOrHeader=function(aContext,anOption,aString){if("code"===this.inputOption(anOption))return this.doMapCode(aContext,aString);if("header"===this.inputOption(anOption))return this.doMapHeader(aContext,aString);throw new Error(" '"+anOption+"'\nis not a valid option")},Process.prototype.doMapHeader=function(aContext,aString){if(aContext instanceof Context&&aContext.expression instanceof SyntaxElementMorph)return aContext.expression.mapHeader(aString||"")},Process.prototype.doMapCode=function(aContext,aString){if(aContext instanceof Context&&aContext.expression instanceof SyntaxElementMorph)return aContext.expression.mapCode(aString||"");
},Process.prototype.doMapValueCode=function(type,aString){var tp=this.inputOption(type);switch(tp){case"String":StageMorph.prototype.codeMappings.string=aString||"<#1>";break;case"Number":StageMorph.prototype.codeMappings.number=aString||"<#1>";break;case"true":StageMorph.prototype.codeMappings.boolTrue=aString||"true";break;case"false":StageMorph.prototype.codeMappings.boolFalse=aString||"true";break;default:throw new Error(localize("unsupported data type")+" "+tp)}},Process.prototype.doMapListCode=function(part,kind,aString){var key1="",key2="delim";"parameters"===this.inputOption(kind)?key1="parms_":"variables"===this.inputOption(kind)&&(key1="tempvars_"),
"list"===this.inputOption(part)?key2="list":"item"===this.inputOption(part)&&(key2="item"),StageMorph.prototype.codeMappings[key1+key2]=aString||""},Process.prototype.reportMappedCode=function(aContext){return aContext instanceof Context&&aContext.expression instanceof SyntaxElementMorph?aContext.expression.mappedCode():""},Process.prototype.doRest=function(beats){var tempo=this.reportTempo();this.doWait(60/tempo*beats)},Process.prototype.reportTempo=function(){var stage;return this.homeContext.receiver&&(stage=this.homeContext.receiver.parentThatIsA(StageMorph))?stage.getTempo():0},Process.prototype.doChangeTempo=function(delta){var stage;this.homeContext.receiver&&(stage=this.homeContext.receiver.parentThatIsA(StageMorph),
stage&&stage.changeTempo(delta))},Process.prototype.doSetTempo=function(bpm){var stage;this.homeContext.receiver&&(stage=this.homeContext.receiver.parentThatIsA(StageMorph),stage&&stage.setTempo(bpm))},Process.prototype.doPlayNote=function(pitch,beats){var tempo=this.reportTempo();this.doPlayNoteForSecs(parseFloat(pitch||"0"),60/tempo*parseFloat(beats||"0"))},Process.prototype.doPlayNoteForSecs=function(pitch,secs){return this.context.startTime||(this.context.startTime=Date.now(),this.context.activeNote=new Note(pitch),this.context.activeNote.play(this.instrument)),Date.now()-this.context.startTime>=1e3*secs?(this.context.activeNote&&(this.context.activeNote.stop(),
this.context.activeNote=null),null):(this.pushContext("doYield"),void this.pushContext())},Process.prototype.doSetInstrument=function(num){this.instrument=+num,this.receiver.instrument=+num},Process.prototype.inputOption=function(dta){return dta instanceof Array?dta[0]:dta},Process.prototype.pushContext=function(expression,outerContext){this.context=new Context(this.context,expression,outerContext||(this.context?this.context.outerContext:null),this.context?this.context.receiver:this.homeContext.receiver)},Process.prototype.popContext=function(){this.context&&this.context.stopMusic(),this.context=this.context?this.context.parentContext:null},Process.prototype.returnValueToParentContext=function(value){
if(void 0!==value){var target=this.context?this.context.parentContext||this.homeContext:this.homeContext;target.addInput(value)}},Process.prototype.reportStackSize=function(){return this.context?this.context.stackSize():0},Process.prototype.reportFrameCount=function(){return this.frameCount},Process.prototype.flashContext=function(){var expr=this.context.expression;return!(!(this.enableSingleStepping&&!this.isAtomic&&expr instanceof SyntaxElementMorph)||expr instanceof CommandSlotMorph||this.context.isFlashing||!expr.world()||expr instanceof ColorSlotMorph)&&(this.unflash(),expr.flash(),this.context.isFlashing=!0,this.flashingContext=this.context,this.flashTime>0&&this.flashTime<=.5?(this.pushContext("doIdle"),
this.context.addInput(this.flashTime)):this.pushContext("doInterrupt"),!0)},Process.prototype.flashPausedContext=function(){var flashable=this.context?this.context.lastFlashable():null;flashable&&(this.unflash(),flashable.expression.flash(),flashable.isFlashing=!0,this.flashingContext=flashable)},Process.prototype.doInterrupt=function(){this.popContext(),this.isAtomic||(this.isInterrupted=!0)},Process.prototype.doIdle=function(secs){return this.context.startTime||(this.context.startTime=Date.now()),Date.now()-this.context.startTime<1e3*secs?void this.pushContext("doInterrupt"):void this.popContext()},Process.prototype.unflash=function(){this.flashingContext&&(this.flashingContext.expression.unflash(),
this.flashingContext.isFlashing=!1,this.flashingContext=null)},Context.prototype.toString=function(){var expr=this.expression;return expr instanceof Array&&expr.length>0&&(expr="["+expr[0]+"]"),"Context >> "+expr+" "+this.variables},Context.prototype.image=function(){var block,cont,ring=new RingMorph;return this.expression instanceof Morph?(block=this.expression.fullCopy(),this.isContinuation&&(cont=detect(block.allInputs(),function(inp){return 1===inp.bindingID}),cont&&block.revertToDefaultInput(cont,!0)),ring.embed(block,this.inputs),ring.fullImage()):this.expression instanceof Array?(block=this.expression[this.pc].fullCopy(),block instanceof RingMorph&&!block.contents()?block.fullImage():(ring.embed(block,this.isContinuation?[]:this.inputs),
ring.fullImage())):(ring.color=SpriteMorph.prototype.blockColor.other,ring.setSpec("%rc %ringparms"),this.isContinuation||this.inputs.forEach(function(inp){ring.parts()[1].addInput(inp)}),ring.fullImage())},Context.prototype.continuation=function(){var cont;if(this.expression instanceof Array)cont=this;else{if(!this.parentContext)return cont=new Context(null,"expectReport"),cont.isContinuation=!0,cont;cont=this.parentContext}return cont=cont.copyForContinuation(),cont.tag=null,cont.isContinuation=!0,cont},Context.prototype.copyForContinuation=function(){var cpy=copy(this),cur=cpy,isReporter=!(this.expression instanceof Array||isString(this.expression));if(isReporter)for(cur.prepareContinuationForBinding();cur.parentContext;)cur.parentContext=copy(cur.parentContext),
cur=cur.parentContext,cur.inputs=[];return cpy},Context.prototype.copyForContinuationCall=function(){var cpy=copy(this),cur=cpy,isReporter=!(this.expression instanceof Array||isString(this.expression));if(isReporter)for(this.expression=this.expression.fullCopy(),this.inputs=[];cur.parentContext;)cur.parentContext=copy(cur.parentContext),cur=cur.parentContext,cur.inputs=[];return cpy},Context.prototype.prepareContinuationForBinding=function(){var slot,pos=this.inputs.length;this.expression=this.expression.fullCopy(),slot=this.expression.inputs()[pos],slot&&(this.inputs=[],slot.bindingID=1,this.emptySlots=1)},Context.prototype.addInput=function(input){this.inputs.push(input);
},Context.prototype.stopMusic=function(){this.activeNote&&(this.activeNote.stop(),this.activeNote=null)},Context.prototype.lastFlashable=function(){return this.expression instanceof SyntaxElementMorph&&!(this.expression instanceof CommandSlotMorph)?this:this.parentContext?this.parentContext.lastFlashable():null},Context.prototype.stackSize=function(){return this.parentContext?1+this.parentContext.stackSize():1},Variable.prototype.toString=function(){return"a "+(this.isTransient?"transient ":"")+"Variable ["+this.value+"]"},Variable.prototype.copy=function(){return new Variable(this.value,this.isTransient)},VariableFrame.prototype.toString=function(){return"a VariableFrame {"+this.names()+"}";
},VariableFrame.prototype.copy=function(){var frame=new VariableFrame(this.parentFrame),myself=this;return this.names().forEach(function(vName){frame.addVar(vName,myself.getVar(vName))}),frame};VariableFrame.prototype.deepCopy=function(){var frame;return frame=new VariableFrame(this.parentFrame?this.parentFrame.deepCopy():this.parentFrame),frame.vars=copy(this.vars),frame};VariableFrame.prototype.find=function(name){var frame=this.silentFind(name);if(frame)return frame;throw new Error(localize("a variable of name '")+name+localize("'\ndoes not exist in this context"))},VariableFrame.prototype.silentFind=function(name){return void 0!==this.vars[name]?this:this.parentFrame?this.parentFrame.silentFind(name):null;
},VariableFrame.prototype.setVar=function(name,value,sender){var frame=this.find(name);frame&&(sender instanceof SpriteMorph&&frame.owner instanceof SpriteMorph&&sender!==frame.owner?sender.shadowVar(name,value):frame.vars[name].value=value)},VariableFrame.prototype.changeVar=function(name,delta,sender){var value,newValue,frame=this.find(name);frame&&(value=parseFloat(frame.vars[name].value),newValue=isNaN(value)?delta:value+parseFloat(delta),sender instanceof SpriteMorph&&frame.owner instanceof SpriteMorph&&sender!==frame.owner?sender.shadowVar(name,newValue):frame.vars[name].value=newValue)},VariableFrame.prototype.getVar=function(name){var value,frame=this.silentFind(name);
if(frame)return value=frame.vars[name].value,0===value?0:value!==!1&&(""===value?"":value||0);if("number"==typeof name)return"";throw new Error(localize("a variable of name '")+name+localize("'\ndoes not exist in this context"))},VariableFrame.prototype.addVar=function(name,value){this.vars[name]=new Variable(0===value?0:value!==!1&&(""===value?"":value||0))},VariableFrame.prototype.deleteVar=function(name){var frame=this.find(name);frame&&delete frame.vars[name]},VariableFrame.prototype.names=function(){var each,names=[];for(each in this.vars)Object.prototype.hasOwnProperty.call(this.vars,each)&&names.push(each);return names},VariableFrame.prototype.allNamesDict=function(){
function addKeysToDict(srcDict,trgtDict){var eachKey;for(eachKey in srcDict)Object.prototype.hasOwnProperty.call(srcDict,eachKey)&&(trgtDict[eachKey]=eachKey)}for(var dict={},current=this;current;)addKeysToDict(current.vars,dict),current=current.parentFrame;return dict},VariableFrame.prototype.allNames=function(){var each,answer=[],dict=this.allNamesDict();for(each in dict)Object.prototype.hasOwnProperty.call(dict,each)&&answer.push(each);return answer},modules.objects="2017-December-12";var SpriteMorph,StageMorph,SpriteBubbleMorph,Costume,SVG_Costume,CostumeEditorMorph,Sound,Note,CellMorph,WatcherMorph,StagePrompterMorph,Note,SpriteHighlightMorph;SpriteMorph.prototype=new PenMorph,
SpriteMorph.prototype.constructor=SpriteMorph,SpriteMorph.uber=PenMorph.prototype,SpriteMorph.prototype.attributes=["x position","y position","direction","size","costumes","costume #","sounds","scripts"],SpriteMorph.prototype.categories=["motion","control","looks","sensing","sound","operators","pen","variables","lists","other"],SpriteMorph.prototype.blockColor={motion:new Color(74,108,212),looks:new Color(143,86,227),sound:new Color(207,74,217),pen:new Color(0,161,120),control:new Color(230,168,34),sensing:new Color(4,148,220),operators:new Color(98,194,19),variables:new Color(243,118,29),lists:new Color(217,77,17),other:new Color(150,150,150)},SpriteMorph.prototype.paletteColor=new Color(55,55,55),
SpriteMorph.prototype.paletteTextColor=new Color(230,230,230),SpriteMorph.prototype.sliderColor=SpriteMorph.prototype.paletteColor.lighter(30),SpriteMorph.prototype.isCachingPrimitives=!0,SpriteMorph.prototype.enableNesting=!0,SpriteMorph.prototype.enableFirstClass=!0,SpriteMorph.prototype.useFlatLineEnds=!1,SpriteMorph.prototype.highlightColor=new Color(250,200,130),SpriteMorph.prototype.highlightBorder=8,SpriteMorph.prototype.bubbleColor=new Color(255,255,255),SpriteMorph.prototype.bubbleFontSize=14,SpriteMorph.prototype.bubbleFontIsBold=!0,SpriteMorph.prototype.bubbleCorner=10,SpriteMorph.prototype.bubbleBorder=3,SpriteMorph.prototype.bubbleBorderColor=new Color(190,190,190),
SpriteMorph.prototype.bubbleMaxTextWidth=130,SpriteMorph.prototype.initBlocks=function(){SpriteMorph.prototype.blocks={forward:{only:SpriteMorph,type:"command",category:"motion",spec:"move %n steps",defaults:[10]},turn:{only:SpriteMorph,type:"command",category:"motion",spec:"turn %clockwise %n degrees",defaults:[15]},turnLeft:{only:SpriteMorph,type:"command",category:"motion",spec:"turn %counterclockwise %n degrees",defaults:[15]},setHeading:{only:SpriteMorph,type:"command",category:"motion",spec:"point in direction %dir"},doFaceTowards:{only:SpriteMorph,type:"command",category:"motion",spec:"point towards %dst"},gotoXY:{only:SpriteMorph,type:"command",category:"motion",
spec:"go to x: %n y: %n",defaults:[0,0]},doGotoObject:{only:SpriteMorph,type:"command",category:"motion",spec:"go to %dst"},doGlide:{only:SpriteMorph,type:"command",category:"motion",spec:"glide %n secs to x: %n y: %n",defaults:[1,0,0]},changeXPosition:{only:SpriteMorph,type:"command",category:"motion",spec:"change x by %n",defaults:[10]},setXPosition:{only:SpriteMorph,type:"command",category:"motion",spec:"set x to %n",defaults:[0]},changeYPosition:{only:SpriteMorph,type:"command",category:"motion",spec:"change y by %n",defaults:[10]},setYPosition:{only:SpriteMorph,type:"command",category:"motion",spec:"set y to %n",defaults:[0]},bounceOffEdge:{only:SpriteMorph,
type:"command",category:"motion",spec:"if on edge, bounce"},xPosition:{only:SpriteMorph,type:"reporter",category:"motion",spec:"x position"},yPosition:{only:SpriteMorph,type:"reporter",category:"motion",spec:"y position"},direction:{only:SpriteMorph,type:"reporter",category:"motion",spec:"direction"},doSwitchToCostume:{type:"command",category:"looks",spec:"switch to costume %cst"},doWearNextCostume:{type:"command",category:"looks",spec:"next costume"},getCostumeIdx:{type:"reporter",category:"looks",spec:"costume #"},doSayFor:{only:SpriteMorph,type:"command",category:"looks",spec:"say %s for %n secs",defaults:[localize("Hello!"),2]},bubble:{only:SpriteMorph,type:"command",
category:"looks",spec:"say %s",defaults:[localize("Hello!")]},doThinkFor:{only:SpriteMorph,type:"command",category:"looks",spec:"think %s for %n secs",defaults:[localize("Hmm..."),2]},doThink:{only:SpriteMorph,type:"command",category:"looks",spec:"think %s",defaults:[localize("Hmm...")]},changeEffect:{type:"command",category:"looks",spec:"change %eff effect by %n",defaults:[null,25]},setEffect:{type:"command",category:"looks",spec:"set %eff effect to %n",defaults:[null,0]},clearEffects:{type:"command",category:"looks",spec:"clear graphic effects"},changeScale:{only:SpriteMorph,type:"command",category:"looks",spec:"change size by %n",defaults:[10]},setScale:{only:SpriteMorph,
type:"command",category:"looks",spec:"set size to %n %",defaults:[100]},getScale:{only:SpriteMorph,type:"reporter",category:"looks",spec:"size"},show:{only:SpriteMorph,type:"command",category:"looks",spec:"show"},hide:{only:SpriteMorph,type:"command",category:"looks",spec:"hide"},comeToFront:{only:SpriteMorph,type:"command",category:"looks",spec:"go to front"},goBack:{only:SpriteMorph,type:"command",category:"looks",spec:"go back %n layers",defaults:[1]},doScreenshot:{type:"command",category:"looks",spec:"save %imgsource as costume named %s",defaults:[["pen trails"],localize("screenshot")]},reportCostumes:{dev:!0,type:"reporter",category:"looks",spec:"wardrobe"
},alert:{dev:!0,type:"command",category:"looks",spec:"alert %mult%s"},log:{dev:!0,type:"command",category:"looks",spec:"console log %mult%s"},playSound:{type:"command",category:"sound",spec:"play sound %snd"},doPlaySoundUntilDone:{type:"command",category:"sound",spec:"play sound %snd until done"},doStopAllSounds:{type:"command",category:"sound",spec:"stop all sounds"},doRest:{type:"command",category:"sound",spec:"rest for %n beats",defaults:[.2]},doPlayNote:{type:"command",category:"sound",spec:"play note %note for %n beats",defaults:[60,.5]},doSetInstrument:{type:"command",category:"sound",spec:"set instrument to %inst",defaults:[1]},doChangeTempo:{type:"command",
category:"sound",spec:"change tempo by %n",defaults:[20]},doSetTempo:{type:"command",category:"sound",spec:"set tempo to %n bpm",defaults:[60]},getTempo:{type:"reporter",category:"sound",spec:"tempo"},reportSounds:{dev:!0,type:"reporter",category:"sound",spec:"jukebox"},clear:{type:"command",category:"pen",spec:"clear"},down:{only:SpriteMorph,type:"command",category:"pen",spec:"pen down"},up:{only:SpriteMorph,type:"command",category:"pen",spec:"pen up"},setColor:{only:SpriteMorph,type:"command",category:"pen",spec:"set pen color to %clr"},changeHue:{only:SpriteMorph,type:"command",category:"pen",spec:"change pen color by %n",defaults:[10]},setHue:{only:SpriteMorph,
type:"command",category:"pen",spec:"set pen color to %n",defaults:[0]},changeBrightness:{only:SpriteMorph,type:"command",category:"pen",spec:"change pen shade by %n",defaults:[10]},setBrightness:{only:SpriteMorph,type:"command",category:"pen",spec:"set pen shade to %n",defaults:[100]},changeSize:{only:SpriteMorph,type:"command",category:"pen",spec:"change pen size by %n",defaults:[1]},setSize:{only:SpriteMorph,type:"command",category:"pen",spec:"set pen size to %n",defaults:[1]},doStamp:{only:SpriteMorph,type:"command",category:"pen",spec:"stamp"},floodFill:{only:SpriteMorph,type:"command",category:"pen",spec:"fill"},reportPenTrailsAsCostume:{type:"reporter",
category:"pen",spec:"pen trails"},receiveGo:{type:"hat",category:"control",spec:"when %greenflag clicked"},receiveKey:{type:"hat",category:"control",spec:"when %keyHat key pressed"},receiveInteraction:{type:"hat",category:"control",spec:"when I am %interaction",defaults:["clicked"]},receiveMessage:{type:"hat",category:"control",spec:"when I receive %msgHat"},receiveCondition:{type:"hat",category:"control",spec:"when %b"},doBroadcast:{type:"command",category:"control",spec:"broadcast %msg"},doBroadcastAndWait:{type:"command",category:"control",spec:"broadcast %msg and wait"},getLastMessage:{type:"reporter",category:"control",spec:"message"},doWait:{type:"command",
category:"control",spec:"wait %n secs",defaults:[1]},doWaitUntil:{type:"command",category:"control",spec:"wait until %b"},doForever:{type:"command",category:"control",spec:"forever %c"},doRepeat:{type:"command",category:"control",spec:"repeat %n %c",defaults:[10]},doUntil:{type:"command",category:"control",spec:"repeat until %b %c"},doIf:{type:"command",category:"control",spec:"if %b %c"},doIfElse:{type:"command",category:"control",spec:"if %b %c else %c"},doStopThis:{type:"command",category:"control",spec:"stop %stopChoices"},doRun:{type:"command",category:"control",spec:"run %cmdRing %inputs"},fork:{type:"command",category:"control",spec:"launch %cmdRing %inputs"
},evaluate:{type:"reporter",category:"control",spec:"call %repRing %inputs"},doReport:{type:"command",category:"control",spec:"report %s"},doCallCC:{type:"command",category:"control",spec:"run %cmdRing w/continuation"},reportCallCC:{type:"reporter",category:"control",spec:"call %cmdRing w/continuation"},doWarp:{type:"command",category:"other",spec:"warp %c"},doTellTo:{dev:!0,type:"command",category:"control",spec:"tell %spr to %cmdRing %inputs"},reportAskFor:{dev:!0,type:"reporter",category:"control",spec:"ask %spr for %repRing %inputs"},receiveOnClone:{type:"hat",category:"control",spec:"when I start as a clone"},createClone:{type:"command",category:"control",
spec:"create a clone of %cln"},newClone:{type:"reporter",category:"control",spec:"a new clone of %cln",defaults:[["myself"]]},removeClone:{type:"command",category:"control",spec:"delete this clone"},doPauseAll:{type:"command",category:"control",spec:"pause all %pause"},reportTouchingObject:{only:SpriteMorph,type:"predicate",category:"sensing",spec:"touching %col ?"},reportTouchingColor:{only:SpriteMorph,type:"predicate",category:"sensing",spec:"touching %clr ?"},reportColorIsTouchingColor:{only:SpriteMorph,type:"predicate",category:"sensing",spec:"color %clr is touching %clr ?"},colorFiltered:{dev:!0,type:"reporter",category:"sensing",spec:"filtered for %clr"
},reportStackSize:{dev:!0,type:"reporter",category:"sensing",spec:"stack size"},reportFrameCount:{dev:!0,type:"reporter",category:"sensing",spec:"frames"},reportThreadCount:{dev:!0,type:"reporter",category:"sensing",spec:"processes"},doAsk:{type:"command",category:"sensing",spec:"ask %s and wait",defaults:[localize("what's your name?")]},reportLastAnswer:{dev:!0,type:"reporter",category:"sensing",spec:"answer"},getLastAnswer:{type:"reporter",category:"sensing",spec:"answer"},reportMouseX:{type:"reporter",category:"sensing",spec:"mouse x"},reportMouseY:{type:"reporter",category:"sensing",spec:"mouse y"},reportMouseDown:{type:"predicate",category:"sensing",spec:"mouse down?"
},reportKeyPressed:{type:"predicate",category:"sensing",spec:"key %key pressed?"},reportDistanceTo:{type:"reporter",category:"sensing",spec:"distance to %dst"},doResetTimer:{type:"command",category:"sensing",spec:"reset timer"},reportTimer:{dev:!0,type:"reporter",category:"sensing",spec:"timer"},getTimer:{type:"reporter",category:"sensing",spec:"timer"},reportAttributeOf:{type:"reporter",category:"sensing",spec:"%att of %spr",defaults:[["costume #"]]},reportURL:{type:"reporter",category:"sensing",spec:"url %s",defaults:["snap.berkeley.edu"]},reportIsFastTracking:{type:"predicate",category:"sensing",spec:"turbo mode?"},doSetFastTracking:{type:"command",category:"sensing",
spec:"set turbo mode to %b"},reportDate:{type:"reporter",category:"sensing",spec:"current %dates"},reportGet:{type:"reporter",category:"sensing",spec:"my %get",defaults:[["neighbors"]]},reifyScript:{type:"ring",category:"other",spec:"%rc %ringparms",alias:"command ring lambda"},reifyReporter:{type:"ring",category:"other",spec:"%rr %ringparms",alias:"reporter ring lambda"},reifyPredicate:{type:"ring",category:"other",spec:"%rp %ringparms",alias:"predicate ring lambda"},reportSum:{type:"reporter",category:"operators",spec:"%n + %n"},reportDifference:{type:"reporter",category:"operators",spec:"%n − %n",alias:"-"},reportProduct:{type:"reporter",category:"operators",
spec:"%n × %n",alias:"*"},reportQuotient:{type:"reporter",category:"operators",spec:"%n / %n"},reportRound:{type:"reporter",category:"operators",spec:"round %n"},reportMonadic:{type:"reporter",category:"operators",spec:"%fun of %n",defaults:[null,10]},reportModulus:{type:"reporter",category:"operators",spec:"%n mod %n"},reportRandom:{type:"reporter",category:"operators",spec:"pick random %n to %n",defaults:[1,10]},reportLessThan:{type:"predicate",category:"operators",spec:"%s < %s"},reportEquals:{type:"predicate",category:"operators",spec:"%s = %s"},reportGreaterThan:{type:"predicate",category:"operators",spec:"%s > %s"},reportAnd:{type:"predicate",category:"operators",
spec:"%b and %b"},reportOr:{type:"predicate",category:"operators",spec:"%b or %b"},reportNot:{type:"predicate",category:"operators",spec:"not %b"},reportBoolean:{type:"predicate",category:"operators",spec:"%bool",alias:"true boolean"},reportFalse:{type:"predicate",category:"operators",spec:"%bool",defaults:[!1],alias:"false boolean"},reportJoinWords:{type:"reporter",category:"operators",spec:"join %words",defaults:[localize("hello")+" ",localize("world")]},reportLetter:{type:"reporter",category:"operators",spec:"letter %n of %s",defaults:[1,localize("world")]},reportStringSize:{type:"reporter",category:"operators",spec:"length of %s",defaults:[localize("world")]
},reportUnicode:{type:"reporter",category:"operators",spec:"unicode of %s",defaults:["a"]},reportUnicodeAsLetter:{type:"reporter",category:"operators",spec:"unicode %n as letter",defaults:[65]},reportIsA:{type:"predicate",category:"operators",spec:"is %s a %typ ?",defaults:[5]},reportIsIdentical:{type:"predicate",category:"operators",spec:"is %s identical to %s ?"},reportTextSplit:{type:"reporter",category:"operators",spec:"split %s by %delim",defaults:[localize("hello")+" "+localize("world")," "]},reportJSFunction:{type:"reporter",category:"operators",spec:"JavaScript function ( %mult%s ) { %code }"},reportTypeOf:{dev:!0,type:"reporter",category:"operators",
spec:"type of %s",defaults:[5]},reportTextFunction:{dev:!0,type:"reporter",category:"operators",spec:"%txtfun of %s",defaults:[null,"Abelson & Sussman"]},doSetVar:{type:"command",category:"variables",spec:"set %var to %s",defaults:[null,0]},doChangeVar:{type:"command",category:"variables",spec:"change %var by %n",defaults:[null,1]},doShowVar:{type:"command",category:"variables",spec:"show variable %var"},doHideVar:{type:"command",category:"variables",spec:"hide variable %var"},doDeclareVariables:{type:"command",category:"other",spec:"script variables %scriptVars"},doDeleteAttr:{type:"command",category:"variables",spec:"inherit %shd"},reportNewList:{type:"reporter",
category:"lists",spec:"list %exp"},reportCONS:{type:"reporter",category:"lists",spec:"%s in front of %l"},reportListItem:{type:"reporter",category:"lists",spec:"item %idx of %l",defaults:[1]},reportCDR:{type:"reporter",category:"lists",spec:"all but first of %l"},reportListLength:{type:"reporter",category:"lists",spec:"length of %l"},reportListContainsItem:{type:"predicate",category:"lists",spec:"%l contains %s",defaults:[null,localize("thing")]},doAddToList:{type:"command",category:"lists",spec:"add %s to %l",defaults:[localize("thing")]},doDeleteFromList:{type:"command",category:"lists",spec:"delete %ida of %l",defaults:[1]},doInsertInList:{type:"command",category:"lists",
spec:"insert %s at %idx of %l",defaults:[localize("thing"),1]},doReplaceInList:{type:"command",category:"lists",spec:"replace item %idx of %l with %s",defaults:[1,null,localize("thing")]},reportMap:{dev:!0,type:"reporter",category:"lists",spec:"map %repRing over %l"},doForEach:{dev:!0,type:"command",category:"lists",spec:"for %upvar in %l %cl",defaults:[localize("each item")]},doShowTable:{dev:!0,type:"command",category:"lists",spec:"show table %l"},doMapCodeOrHeader:{type:"command",category:"other",spec:"map %cmdRing to %codeKind %code"},doMapValueCode:{type:"command",category:"other",spec:"map %mapValue to code %code",defaults:[["String"],"<#1>"]},doMapListCode:{
type:"command",category:"other",spec:"map %codeListPart of %codeListKind to code %code"},reportMappedCode:{type:"reporter",category:"other",spec:"code of %cmdRing"}}},SpriteMorph.prototype.initBlocks(),SpriteMorph.prototype.initBlockMigrations=function(){SpriteMorph.prototype.blockMigrations={doStopAll:{selector:"doStopThis",inputs:[["all"]]},doStop:{selector:"doStopThis",inputs:[["this script"]]},doStopBlock:{selector:"doStopThis",inputs:[["this block"]]},doStopOthers:{selector:"doStopThis",inputs:[["all"]],offset:0},receiveClick:{selector:"receiveInteraction",inputs:[["clicked"]]},reportTrue:{selector:"reportBoolean",inputs:[!0]},reportFalse:{selector:"reportBoolean",
inputs:[!1]},reportCostumes:{selector:"reportGet",inputs:[["costumes"]]},reportSounds:{selector:"reportGet",inputs:[["sounds"]]},doMapStringCode:{selector:"doMapValueCode",inputs:[["String"],"<#1>"],offset:1}}},SpriteMorph.prototype.initBlockMigrations(),SpriteMorph.prototype.blockAlternatives={turn:["turnLeft"],turnLeft:["turn"],changeXPosition:["changeYPosition","setXPosition","setYPosition"],setXPosition:["setYPosition","changeXPosition","changeYPosition"],changeYPosition:["changeXPosition","setYPosition","setXPosition"],setYPosition:["setXPosition","changeYPosition","changeXPosition"],xPosition:["yPosition"],yPosition:["xPosition"],doSayFor:["doThinkFor","bubble","doThink","doAsk"],
doThinkFor:["doSayFor","doThink","bubble","doAsk"],bubble:["doThink","doAsk","doSayFor","doThinkFor"],doThink:["bubble","doAsk","doSayFor","doThinkFor"],show:["hide"],hide:["show"],changeEffect:["setEffect"],setEffect:["changeEffect"],changeScale:["setScale"],setScale:["changeScale"],playSound:["doPlaySoundUntilDone"],doPlaySoundUntilDone:["playSound"],doChangeTempo:["doSetTempo"],doSetTempo:["doChangeTempo"],clear:["down","up","doStamp"],down:["up","clear","doStamp"],up:["down","clear","doStamp"],doStamp:["clear","down","up"],changeHue:["setHue","changeBrightness","setBrightness"],setHue:["changeHue","changeBrightness","setBrightness"],changeBrightness:["setBrightness","setHue","changeHue"],
setBrightness:["changeBrightness","setHue","changeHue"],changeSize:["setSize"],setSize:["changeSize"],doBroadcast:["doBroadcastAndWait"],doBroadcastAndWait:["doBroadcast"],doIf:["doIfElse","doUntil"],doIfElse:["doIf","doUntil"],doRepeat:["doUntil"],doUntil:["doRepeat","doIf"],doAsk:["bubble","doThink","doSayFor","doThinkFor"],getLastAnswer:["getTimer"],getTimer:["getLastAnswer"],reportMouseX:["reportMouseY"],reportMouseY:["reportMouseX"],reportSum:["reportDifference","reportProduct","reportQuotient"],reportDifference:["reportSum","reportProduct","reportQuotient"],reportProduct:["reportDifference","reportSum","reportQuotient"],reportQuotient:["reportDifference","reportProduct","reportSum"],
reportLessThan:["reportEquals","reportGreaterThan"],reportEquals:["reportLessThan","reportGreaterThan"],reportGreaterThan:["reportEquals","reportLessThan"],reportAnd:["reportOr"],reportOr:["reportAnd"],doSetVar:["doChangeVar"],doChangeVar:["doSetVar"],doShowVar:["doHideVar"],doHideVar:["doShowVar"]},SpriteMorph.prototype.init=function(globals){this.name=localize("Sprite"),this.instrument=null,this.variables=new VariableFrame(globals||null,this),this.scripts=new ScriptsMorph,this.customBlocks=[],this.costumes=new List,this.costumes.type="costume",this.costume=null,this.sounds=new List,this.sounds.type="sound",this.normalExtent=new Point(60,60),this.scale=1,this.rotationStyle=1,
this.version=Date.now(),this.isTemporary=!1,this.isCorpse=!1,this.cloneOriginName="",this.inheritedMethodsCache=[],this.parts=[],this.anchor=null,this.nestingScale=1,this.rotatesWithAnchor=!0,this.layers=null,this.blocksCache={},this.paletteCache={},this.rotationOffset=new Point,this.idx=0,this.wasWarped=!1,this.graphicsValues={color:0,fisheye:0,whirl:0,pixelate:0,mosaic:0,duplicate:0,negative:0,comic:0,confetti:0,saturation:0,brightness:0},this.exemplar=null,this.instances=[],this.cachedPropagation=!1,this.inheritedAttributes=[],SpriteMorph.uber.init.call(this),this.isDraggable=!0,this.isDown=!1,this.heading=90,this.changed(),this.drawNew(),this.changed()},SpriteMorph.prototype.fullCopy=function(forClone){
var cb,effect,c=SpriteMorph.uber.fullCopy.call(this),myself=this,arr=[];c.instances=[],c.stopTalking(),c.color=this.color.copy(),c.blocksCache={},c.paletteCache={},arr=[],this.inheritedAttributes.forEach(function(att){arr.push(att)}),c.inheritedAttributes=arr,forClone?(c.exemplar=this,c.customBlocks=[],c.variables=new VariableFrame(null,c),c.variables.parentFrame=this.variables,c.inheritedVariableNames().forEach(function(name){c.shadowVar(name,c.variables.getVar(name))}),this.addSpecimen(c),this.cachedPropagation=!1,["scripts","costumes","sounds"].forEach(function(att){contains(c.inheritedAttributes,att)||c.inheritedAttributes.push(att)})):(c.variables=this.variables.copy(),
c.variables.owner=c,c.scripts=this.scripts.fullCopy(),c.customBlocks=[],this.customBlocks.forEach(function(def){cb=def.copyAndBindTo(c),c.customBlocks.push(cb),c.allBlockInstances(def).forEach(function(block){block.definition=cb})}),arr=[],this.costumes.asArray().forEach(function(costume){var cst=forClone?costume:costume.copy();arr.push(cst),costume===myself.costume&&(c.costume=cst)}),c.costumes=new List(arr),arr=[],this.sounds.asArray().forEach(function(sound){var snd=forClone?sound:sound.copy();arr.push(snd)}),c.sounds=new List(arr),arr=[]),c.nestingScale=1,c.rotatesWithAnchor=!0,c.anchor=null,c.parts=[],this.parts.forEach(function(part){var dp=part.fullCopy(forClone);
dp.nestingScale=part.nestingScale,dp.rotatesWithAnchor=part.rotatesWithAnchor,c.attachPart(dp)}),c.graphicsValues={};for(effect in this.graphicsValues)this.graphicsValues.hasOwnProperty(effect)&&(c.graphicsValues[effect]=this.graphicsValues[effect]);return c},SpriteMorph.prototype.appearIn=function(ide){this.isTemporary||(this.name=ide.newSpriteName(this.name),ide.corral.addSprite(this),ide.sprites.add(this)),ide.stage.add(this),this.parts.forEach(function(part){part.appearIn(ide)})},SpriteMorph.prototype.setName=function(string){this.name=string||this.name,this.version=Date.now()},SpriteMorph.prototype.drawNew=function(){var currentCenter,facing,isFlipped,isLoadingCostume,cst,pic,stageScale,newX,origin,shift,corner,costumeExtent,ctx,handle,myself=this,corners=[];
if(this.isWarped)return void(this.wantsRedraw=!0);if(currentCenter=this.center(),isLoadingCostume=this.costume&&"function"==typeof this.costume.loaded,stageScale=this.parent instanceof StageMorph?this.parent.scale:1,facing=this.rotationStyle?this.heading:90,2===this.rotationStyle&&(facing=90,(this.heading>180&&this.heading<360||this.heading<0&&this.heading>-180)&&(isFlipped=!0)),this.costume&&!isLoadingCostume)pic=isFlipped?this.costume.flipped():this.costume,corners=pic.bounds().corners().map(function(point){return point.rotateBy(radians(facing-90),myself.costume.center())}),origin=corners[0],corner=corners[0],corners.forEach(function(point){origin=origin.min(point),
corner=corner.max(point)}),costumeExtent=origin.corner(corner).extent().multiplyBy(this.scale*stageScale),shift=new Point(0,0).rotateBy(radians(-(facing-90)),pic.center()).subtract(origin),this.image=newCanvas(costumeExtent,!0),this.silentSetExtent(costumeExtent),ctx=this.image.getContext("2d"),ctx.scale(this.scale*stageScale,this.scale*stageScale),ctx.translate(shift.x,shift.y),ctx.rotate(radians(facing-90)),ctx.drawImage(pic.contents,0,0),this.image=this.applyGraphicsEffects(this.image),this.setCenter(currentCenter,!0),this.rotationOffset=shift.translateBy(pic.rotationCenter).rotateBy(radians(-(facing-90)),shift).scaleBy(this.scale*stageScale);else if(facing=isFlipped?-90:facing,
newX=Math.min(Math.max(this.normalExtent.x*this.scale*stageScale,5),1e3),this.silentSetExtent(new Point(newX,newX)),this.image=newCanvas(this.extent(),!0),this.setCenter(currentCenter,!0),SpriteMorph.uber.drawNew.call(this,facing),this.rotationOffset=this.extent().divideBy(2),this.image=this.applyGraphicsEffects(this.image),isLoadingCostume)return cst=this.costume,handle=setInterval(function(){myself.wearCostume(cst),clearInterval(handle)},100),myself.wearCostume(null);this.version=Date.now()},SpriteMorph.prototype.endWarp=function(){if(this.isWarped=!1,this.wantsRedraw){var x=this.xPosition(),y=this.yPosition();this.drawNew(),this.silentGotoXY(x,y,!0),this.wantsRedraw=!1;
}this.parent.changed()},SpriteMorph.prototype.rotationCenter=function(){return this.position().add(this.rotationOffset)},SpriteMorph.prototype.colorFiltered=function(aColor){var ctx,src,clr,i,dta,morph=new Morph,ext=this.extent();for(src=normalizeCanvas(this.image,!0).getContext("2d").getImageData(0,0,ext.x,ext.y),morph.image=newCanvas(ext,!0),morph.bounds=this.bounds.copy(),ctx=morph.image.getContext("2d"),dta=ctx.createImageData(ext.x,ext.y),i=0;i<ext.x*ext.y*4;i+=4)clr=new Color(src.data[i],src.data[i+1],src.data[i+2]),clr.eq(aColor)&&(dta.data[i]=src.data[i],dta.data[i+1]=src.data[i+1],dta.data[i+2]=src.data[i+2],dta.data[i+3]=255);return ctx.putImageData(dta,0,0),
morph},SpriteMorph.prototype.blockForSelector=function(selector,setDefaults){var migration,info,block,defaults,inputs,i;if(migration=this.blockMigrations[selector],info=this.blocks[migration?migration.selector:selector],!info)return null;if(block="command"===info.type?new CommandBlockMorph:"hat"===info.type?new HatBlockMorph:"ring"===info.type?new RingMorph:new ReporterBlockMorph("predicate"===info.type),block.color=this.blockColor[info.category],block.category=info.category,block.selector=migration?migration.selector:selector,contains(["reifyReporter","reifyPredicate"],block.selector)&&(block.isStatic=!0),block.setSpec(localize(info.spec)),setDefaults&&info.defaults||migration&&migration.inputs)if(defaults=migration?migration.inputs:info.defaults,
block.defaults=defaults,inputs=block.inputs(),inputs[0]instanceof MultiArgMorph)inputs[0].setContents(defaults),inputs[0].defaults=defaults;else for(i=0;i<defaults.length;i+=1)null!==defaults[i]&&inputs[i].setContents(defaults[i]);return block},SpriteMorph.prototype.variableBlock=function(varName){var block=new ReporterBlockMorph(!1);return block.selector="reportGetVar",block.color=this.blockColor.variables,block.category="variables",block.setSpec(varName),block.isDraggable=!0,block},SpriteMorph.prototype.blockTemplates=function(category){function block(selector,isGhosted){if(StageMorph.prototype.hiddenPrimitives[selector])return null;var newBlock=SpriteMorph.prototype.blockForSelector(selector,!0);
return newBlock.isTemplate=!0,isGhosted&&newBlock.ghost(),newBlock}function variableBlock(varName){var newBlock=SpriteMorph.prototype.variableBlock(varName);return newBlock.isDraggable=!1,newBlock.isTemplate=!0,contains(inheritedVars,varName)&&newBlock.ghost(),newBlock}function watcherToggle(selector){if(StageMorph.prototype.hiddenPrimitives[selector])return null;var info=SpriteMorph.prototype.blocks[selector];return new ToggleMorph("checkbox",this,function(){myself.toggleWatcher(selector,localize(info.spec),myself.blockColor[info.category])},null,function(){return myself.showingWatcher(selector)},null)}function variableWatcherToggle(varName){return new ToggleMorph("checkbox",this,function(){
myself.toggleVariableWatcher(varName)},null,function(){return myself.showingVariableWatcher(varName)},null)}function helpMenu(){var menu=new MenuMorph(this);return menu.addItem("help...","showHelp"),menu}function addVar(pair){var ide;pair&&(myself.isVariableNameInUse(pair[0],pair[1])?myself.inform("that name is already in use"):(ide=myself.parentThatIsA(IDE_Morph),myself.addVariable(pair[0],pair[1]),myself.showingVariableWatcher(pair[0])||myself.toggleVariableWatcher(pair[0],pair[1]),ide.flushBlocksCache("variables"),ide.refreshPalette()))}var varNames,button,txt,blocks=[],myself=this,cat=category||"motion",inheritedVars=this.inheritedVariableNames();return"motion"===cat?(blocks.push(block("forward")),
blocks.push(block("turn")),blocks.push(block("turnLeft")),blocks.push("-"),blocks.push(block("setHeading")),blocks.push(block("doFaceTowards")),blocks.push("-"),blocks.push(block("gotoXY")),blocks.push(block("doGotoObject")),blocks.push(block("doGlide")),blocks.push("-"),blocks.push(block("changeXPosition")),blocks.push(block("setXPosition")),blocks.push(block("changeYPosition")),blocks.push(block("setYPosition")),blocks.push("-"),blocks.push(block("bounceOffEdge")),blocks.push("-"),blocks.push(watcherToggle("xPosition")),blocks.push(block("xPosition",this.inheritsAttribute("x position"))),blocks.push(watcherToggle("yPosition")),blocks.push(block("yPosition",this.inheritsAttribute("y position"))),
blocks.push(watcherToggle("direction")),blocks.push(block("direction",this.inheritsAttribute("direction"))),blocks.push("="),blocks.push(this.makeBlockButton(cat))):"looks"===cat?(blocks.push(block("doSwitchToCostume")),blocks.push(block("doWearNextCostume")),blocks.push(watcherToggle("getCostumeIdx")),blocks.push(block("getCostumeIdx",this.inheritsAttribute("costume #"))),blocks.push("-"),blocks.push(block("doSayFor")),blocks.push(block("bubble")),blocks.push(block("doThinkFor")),blocks.push(block("doThink")),blocks.push("-"),blocks.push(block("changeEffect")),blocks.push(block("setEffect")),blocks.push(block("clearEffects")),blocks.push("-"),blocks.push(block("changeScale")),
blocks.push(block("setScale")),blocks.push(watcherToggle("getScale")),blocks.push(block("getScale",this.inheritsAttribute("size"))),blocks.push("-"),blocks.push(block("show")),blocks.push(block("hide")),blocks.push("-"),blocks.push(block("comeToFront")),blocks.push(block("goBack")),this.world().isDevMode&&(blocks.push("-"),txt=new TextMorph(localize("development mode \ndebugging primitives:")),txt.fontSize=9,txt.setColor(this.paletteTextColor),blocks.push(txt),blocks.push("-"),blocks.push(block("log")),blocks.push(block("alert")),blocks.push("-"),blocks.push(block("doScreenshot"))),blocks.push("="),blocks.push(this.makeBlockButton(cat))):"sound"===cat?(blocks.push(block("playSound")),
blocks.push(block("doPlaySoundUntilDone")),blocks.push(block("doStopAllSounds")),blocks.push("-"),blocks.push(block("doRest")),blocks.push(block("doPlayNote")),blocks.push(block("doSetInstrument")),blocks.push("-"),blocks.push(block("doChangeTempo")),blocks.push(block("doSetTempo")),blocks.push(watcherToggle("getTempo")),blocks.push(block("getTempo")),blocks.push("="),blocks.push(this.makeBlockButton(cat))):"pen"===cat?(blocks.push(block("clear")),blocks.push("-"),blocks.push(block("down")),blocks.push(block("up")),blocks.push("-"),blocks.push(block("setColor")),blocks.push(block("changeHue")),blocks.push(block("setHue")),blocks.push("-"),blocks.push(block("changeBrightness")),
blocks.push(block("setBrightness")),blocks.push("-"),blocks.push(block("changeSize")),blocks.push(block("setSize")),blocks.push("-"),blocks.push(block("doStamp")),blocks.push(block("floodFill")),blocks.push("-"),blocks.push(block("reportPenTrailsAsCostume")),blocks.push("="),blocks.push(this.makeBlockButton(cat))):"control"===cat?(blocks.push(block("receiveGo")),blocks.push(block("receiveKey")),blocks.push(block("receiveInteraction")),blocks.push(block("receiveCondition")),blocks.push(block("receiveMessage")),blocks.push("-"),blocks.push(block("doBroadcast")),blocks.push(block("doBroadcastAndWait")),blocks.push(watcherToggle("getLastMessage")),blocks.push(block("getLastMessage")),
blocks.push("-"),blocks.push(block("doWarp")),blocks.push("-"),blocks.push(block("doWait")),blocks.push(block("doWaitUntil")),blocks.push("-"),blocks.push(block("doForever")),blocks.push(block("doRepeat")),blocks.push(block("doUntil")),blocks.push("-"),blocks.push(block("doIf")),blocks.push(block("doIfElse")),blocks.push("-"),blocks.push(block("doReport")),blocks.push(block("doStopThis")),blocks.push("-"),blocks.push(block("doRun")),blocks.push(block("fork")),blocks.push(block("evaluate")),blocks.push("-"),blocks.push(block("doTellTo")),blocks.push(block("reportAskFor")),blocks.push("-"),blocks.push(block("doCallCC")),blocks.push(block("reportCallCC")),blocks.push("-"),
blocks.push(block("receiveOnClone")),blocks.push(block("createClone")),blocks.push(block("newClone")),blocks.push(block("removeClone")),blocks.push("-"),blocks.push(block("doPauseAll")),blocks.push("="),blocks.push(this.makeBlockButton(cat))):"sensing"===cat?(blocks.push(block("reportTouchingObject")),blocks.push(block("reportTouchingColor")),blocks.push(block("reportColorIsTouchingColor")),blocks.push("-"),blocks.push(block("doAsk")),blocks.push(watcherToggle("getLastAnswer")),blocks.push(block("getLastAnswer")),blocks.push("-"),blocks.push(watcherToggle("reportMouseX")),blocks.push(block("reportMouseX")),blocks.push(watcherToggle("reportMouseY")),blocks.push(block("reportMouseY")),
blocks.push(block("reportMouseDown")),blocks.push("-"),blocks.push(block("reportKeyPressed")),blocks.push("-"),blocks.push(block("reportDistanceTo")),blocks.push("-"),blocks.push(block("doResetTimer")),blocks.push(watcherToggle("getTimer")),blocks.push(block("getTimer")),blocks.push("-"),blocks.push(block("reportAttributeOf")),SpriteMorph.prototype.enableFirstClass&&blocks.push(block("reportGet")),blocks.push("-"),blocks.push(block("reportURL")),blocks.push("-"),blocks.push(block("reportIsFastTracking")),blocks.push(block("doSetFastTracking")),blocks.push("-"),blocks.push(block("reportDate")),this.world().isDevMode&&(blocks.push("-"),txt=new TextMorph(localize("development mode \ndebugging primitives:")),
txt.fontSize=9,txt.setColor(this.paletteTextColor),blocks.push(txt),blocks.push("-"),blocks.push(watcherToggle("reportThreadCount")),blocks.push(block("reportThreadCount")),blocks.push(block("colorFiltered")),blocks.push(block("reportStackSize")),blocks.push(block("reportFrameCount"))),blocks.push("="),blocks.push(this.makeBlockButton(cat))):"operators"===cat?(blocks.push(block("reifyScript")),blocks.push(block("reifyReporter")),blocks.push(block("reifyPredicate")),blocks.push("#"),blocks.push("-"),blocks.push(block("reportSum")),blocks.push(block("reportDifference")),blocks.push(block("reportProduct")),blocks.push(block("reportQuotient")),blocks.push("-"),blocks.push(block("reportModulus")),
blocks.push(block("reportRound")),blocks.push(block("reportMonadic")),blocks.push(block("reportRandom")),blocks.push("-"),blocks.push(block("reportLessThan")),blocks.push(block("reportEquals")),blocks.push(block("reportGreaterThan")),blocks.push("-"),blocks.push(block("reportAnd")),blocks.push(block("reportOr")),blocks.push(block("reportNot")),blocks.push(block("reportBoolean")),blocks.push("-"),blocks.push(block("reportJoinWords")),blocks.push(block("reportTextSplit")),blocks.push(block("reportLetter")),blocks.push(block("reportStringSize")),blocks.push("-"),blocks.push(block("reportUnicode")),blocks.push(block("reportUnicodeAsLetter")),blocks.push("-"),blocks.push(block("reportIsA")),
blocks.push(block("reportIsIdentical")),blocks.push("-"),blocks.push(block("reportJSFunction")),this.world().isDevMode&&(blocks.push("-"),txt=new TextMorph(localize("development mode \ndebugging primitives:")),txt.fontSize=9,txt.setColor(this.paletteTextColor),blocks.push(txt),blocks.push("-"),blocks.push(block("reportTypeOf")),blocks.push(block("reportTextFunction"))),blocks.push("="),blocks.push(this.makeBlockButton(cat))):"variables"===cat&&(button=new PushButtonMorph(null,function(){new VariableDialogMorph(null,addVar,myself).prompt("Variable name",null,myself.world())},"Make a variable"),button.userMenu=helpMenu,button.selector="addVariable",button.showHelp=BlockMorph.prototype.showHelp,
blocks.push(button),this.deletableVariableNames().length>0&&(button=new PushButtonMorph(null,function(){var menu=new MenuMorph(myself.deleteVariable,null,myself);myself.deletableVariableNames().forEach(function(name){menu.addItem(name,name)}),menu.popUpAtHand(myself.world())},"Delete a variable"),button.userMenu=helpMenu,button.selector="deleteVariable",button.showHelp=BlockMorph.prototype.showHelp,blocks.push(button)),blocks.push("-"),varNames=this.variables.allNames(),varNames.length>0&&(varNames.forEach(function(name){blocks.push(variableWatcherToggle(name)),blocks.push(variableBlock(name))}),blocks.push("-")),blocks.push(block("doSetVar")),blocks.push(block("doChangeVar")),
blocks.push(block("doShowVar")),blocks.push(block("doHideVar")),blocks.push(block("doDeclareVariables")),StageMorph.prototype.enableInheritance&&(blocks.push("-"),blocks.push(block("doDeleteAttr"))),blocks.push("="),blocks.push(block("reportNewList")),blocks.push("-"),blocks.push(block("reportCONS")),blocks.push(block("reportListItem")),blocks.push(block("reportCDR")),blocks.push("-"),blocks.push(block("reportListLength")),blocks.push(block("reportListContainsItem")),blocks.push("-"),blocks.push(block("doAddToList")),blocks.push(block("doDeleteFromList")),blocks.push(block("doInsertInList")),blocks.push(block("doReplaceInList")),this.world().isDevMode&&(blocks.push("-"),
txt=new TextMorph(localize("development mode \ndebugging primitives:")),txt.fontSize=9,txt.setColor(this.paletteTextColor),blocks.push(txt),blocks.push("-"),blocks.push(block("reportMap")),blocks.push("-"),blocks.push(block("doForEach")),blocks.push(block("doShowTable"))),blocks.push("="),StageMorph.prototype.enableCodeMapping&&(blocks.push(block("doMapCodeOrHeader")),blocks.push(block("doMapValueCode")),blocks.push(block("doMapListCode")),blocks.push("-"),blocks.push(block("reportMappedCode")),blocks.push("=")),blocks.push(this.makeBlockButton())),blocks},SpriteMorph.prototype.makeBlockButton=function(category){var button=new PushButtonMorph(this,"makeBlock","Make a block");
return button.userMenu=function(){var menu=new MenuMorph(this);return menu.addItem("help...","showHelp"),menu},button.selector="addCustomBlock",button.showHelp=BlockMorph.prototype.showHelp,button},SpriteMorph.prototype.makeBlock=function(){var dlg,ide=this.parentThatIsA(IDE_Morph),stage=this.parentThatIsA(StageMorph),category=ide.currentCategory,clr=SpriteMorph.prototype.blockColor[category],myself=this;dlg=new BlockDialogMorph(null,function(definition){""!==definition.spec&&(definition.isGlobal?stage.globalBlocks.push(definition):myself.customBlocks.push(definition),ide.flushPaletteCache(),ide.refreshPalette(),new BlockEditorMorph(definition,myself).popUp());
},myself),"variables"!==category&&(dlg.category=category,dlg.categories.children.forEach(function(each){each.refresh()}),dlg.types.children.forEach(function(each){each.setColor(clr),each.refresh()})),dlg.prompt("Make a block",null,myself.world())},SpriteMorph.prototype.palette=function(category){return this.paletteCache[category]||(this.paletteCache[category]=this.freshPalette(category)),this.paletteCache[category]},SpriteMorph.prototype.freshPalette=function(category){var blocks,searchButton,makeButton,palette=new ScrollFrameMorph(null,null,this.sliderColor),unit=SyntaxElementMorph.prototype.fontSize,x=0,y=5,ry=0,hideNextSpace=!1,myself=this,stage=this.parentThatIsA(StageMorph),oldFlag=Morph.prototype.trackChanges,shade=new Color(140,140,140);
return Morph.prototype.trackChanges=!1,palette.owner=this,palette.padding=unit/2,palette.color=this.paletteColor,palette.growth=new Point(0,MorphicPreferences.scrollBarSize),palette.toolBar=new AlignmentMorph("column"),searchButton=new PushButtonMorph(this,"searchBlocks",new SymbolMorph("magnifierOutline",16)),searchButton.alpha=.2,searchButton.padding=1,searchButton.hint=localize("find blocks")+"...",searchButton.labelShadowColor=shade,searchButton.drawNew(),searchButton.fixLayout(),palette.toolBar.add(searchButton),makeButton=new PushButtonMorph(this,"makeBlock",new SymbolMorph("cross",16)),makeButton.alpha=.2,makeButton.padding=1,makeButton.hint=localize("Make a block")+"...",
makeButton.labelShadowColor=shade,makeButton.drawNew(),makeButton.fixLayout(),palette.toolBar.add(makeButton),palette.toolBar.fixLayout(),palette.add(palette.toolBar),palette.userMenu=function(){function hasHiddenPrimitives(){var defs=SpriteMorph.prototype.blocks,hiddens=StageMorph.prototype.hiddenPrimitives;return Object.keys(hiddens).some(function(any){return!isNil(defs[any])&&(defs[any].category===category||contains(more[category]||[],any))})}function canHidePrimitives(){return palette.contents.children.some(function(any){return contains(Object.keys(SpriteMorph.prototype.blocks),any.selector)})}var menu=new MenuMorph,ide=this.parentThatIsA(IDE_Morph),more={
operators:["reifyScript","reifyReporter","reifyPredicate"],control:["doWarp"],variables:["doDeclareVariables","reportNewList","reportCONS","reportListItem","reportCDR","reportListLength","reportListContainsItem","doAddToList","doDeleteFromList","doInsertInList","doReplaceInList"]};return menu.addPair([new SymbolMorph("magnifyingGlass",MorphicPreferences.menuFontSize),localize("find blocks")+"..."],function(){myself.searchBlocks()},"^F"),canHidePrimitives()&&menu.addItem("hide primitives",function(){var defs=SpriteMorph.prototype.blocks;Object.keys(defs).forEach(function(sel){defs[sel].category===category&&(StageMorph.prototype.hiddenPrimitives[sel]=!0)}),(more[category]||[]).forEach(function(sel){
StageMorph.prototype.hiddenPrimitives[sel]=!0}),ide.flushBlocksCache(category),ide.refreshPalette()}),hasHiddenPrimitives()&&menu.addItem("show primitives",function(){var hiddens=StageMorph.prototype.hiddenPrimitives,defs=SpriteMorph.prototype.blocks;Object.keys(hiddens).forEach(function(sel){defs[sel]&&defs[sel].category===category&&delete StageMorph.prototype.hiddenPrimitives[sel]}),(more[category]||[]).forEach(function(sel){delete StageMorph.prototype.hiddenPrimitives[sel]}),ide.flushBlocksCache(category),ide.refreshPalette()}),menu},blocks=this.blocksCache[category],blocks||(blocks=this.blockTemplates(category),this.isCachingPrimitives&&(this.blocksCache[category]=blocks)),
blocks.forEach(function(block){if(null!==block)if("-"===block){if(hideNextSpace)return;y+=.8*unit,hideNextSpace=!0}else if("="===block){if(hideNextSpace)return;y+=1.6*unit,hideNextSpace=!0}else"#"===block?(x=0,y=ry):(hideNextSpace=!1,0===x&&(y+=.3*unit),block.setPosition(new Point(x,y)),palette.addContents(block),block instanceof ToggleMorph||block instanceof RingMorph?(x=block.right()+unit/2,ry=block.bottom()):(x=0,y+=block.height()))}),stage&&(y+=1.6*unit,stage.globalBlocks.forEach(function(definition){var block;(definition.category===category||"variables"===category&&contains(["lists","other"],definition.category))&&(block=definition.templateInstance(),y+=.3*unit,
block.setPosition(new Point(x,y)),palette.addContents(block),x=0,y+=block.height())})),y+=1.6*unit,this.customBlocks.forEach(function(definition){var block;(definition.category===category||"variables"===category&&contains(["lists","other"],definition.category))&&(block=definition.templateInstance(),y+=.3*unit,block.setPosition(new Point(x,y)),palette.addContents(block),x=0,y+=block.height())}),this.exemplar&&this.inheritedBlocks(!0).forEach(function(definition){var block;(definition.category===category||"variables"===category&&contains(["lists","other"],definition.category))&&(block=definition.templateInstance(),y+=.3*unit,block.setPosition(new Point(x,y)),palette.addContents(block),
block.ghost(),x=0,y+=block.height())}),palette.scrollX(palette.padding),palette.scrollY(palette.padding),Morph.prototype.trackChanges=oldFlag,palette},SpriteMorph.prototype.blocksMatching=function(searchString,strictly,types,varNames){function labelOf(aBlockSpec){var words=BlockMorph.prototype.parseSpec(aBlockSpec),filtered=words.filter(function(each){return 0!==each.indexOf("%")});return filtered.join(" ")}function fillDigits(anInt,totalDigits,fillChar){for(var ans=String(anInt);ans.length<totalDigits;)ans=fillChar+ans;return ans}function relevance(aBlockLabel,aSearchString){var atWord,lbl=" "+aBlockLabel,idx=lbl.indexOf(aSearchString);return idx===-1?-1:(atWord=" "===lbl.charAt(idx-1),
strictly&&!atWord?-1:(atWord?"1":"2")+fillDigits(idx,4,"0"))}function primitive(selector){var newBlock=SpriteMorph.prototype.blockForSelector(selector,!0);return newBlock.isTemplate=!0,newBlock}var blocksDict,reporterized,blocks=[],myself=this,search=searchString.toLowerCase(),stage=this.parentThatIsA(StageMorph);return types&&types.length||(types=["hat","command","reporter","predicate","ring"]),varNames||(varNames=[]),varNames.forEach(function(vName){var rel=relevance(labelOf(vName.toLowerCase()),search);rel!==-1&&blocks.push([myself.variableBlock(vName),rel+"1"])}),[this.customBlocks,stage.globalBlocks].forEach(function(blocksList){blocksList.forEach(function(definition){
if(contains(types,definition.type)){var spec=localize(definition.blockSpec()).toLowerCase(),rel=relevance(labelOf(spec),search);rel!==-1&&blocks.push([definition.templateInstance(),rel+"2"])}})}),blocksDict=SpriteMorph.prototype.blocks,Object.keys(blocksDict).forEach(function(selector){if(!StageMorph.prototype.hiddenPrimitives[selector]&&contains(types,blocksDict[selector].type)){var block=blocksDict[selector],spec=localize(block.alias||block.spec).toLowerCase(),rel=relevance(labelOf(spec),search);rel===-1||block.dev||block.only&&block.only!==myself.constructor||blocks.push([primitive(selector),rel+"3"])}}),contains(types,"reporter")&&(reporterized=this.reporterize(searchString),
reporterized&&blocks.push([reporterized,""])),blocks.sort(function(x,y){return x[1]<y[1]?-1:1}),blocks.map(function(each){return each[0]})},SpriteMorph.prototype.searchBlocks=function(searchString,types,varNames,scriptFocus){function showSelection(){focus&&focus.destroy(),selection&&scriptFocus&&(focus=selection.outline(MorphicPreferences.isFlat?new Color(150,200,255):new Color(255,255,255),2),searchPane.contents.add(focus),focus.scrollIntoView())}function show(blocks){var oldFlag=Morph.prototype.trackChanges,x=searchPane.contents.left()+5,y=searchBar.bottom()+unit;blocksList=blocks,selection=null,blocks.length&&scriptFocus&&(selection=blocks[0]),Morph.prototype.trackChanges=!1,
searchPane.contents.children=[searchPane.contents.children[0]],blocks.forEach(function(block){block.setPosition(new Point(x,y)),searchPane.addContents(block),y+=block.height(),y+=.3*unit}),Morph.prototype.trackChanges=oldFlag,showSelection(),searchPane.changed()}var selection,focus,myself=this,unit=SyntaxElementMorph.prototype.fontSize,ide=this.parentThatIsA(IDE_Morph),oldSearch="",searchBar=new InputFieldMorph(searchString||""),searchPane=ide.createPalette("forSearch"),blocksList=[];searchPane.owner=this,searchPane.color=myself.paletteColor,searchPane.contents.color=myself.paletteColor,searchPane.addContents(searchBar),searchBar.drawNew(),searchBar.setWidth(ide.logo.width()-30),
searchBar.contrast=90,searchBar.setPosition(searchPane.contents.topLeft().add(new Point(10,10))),searchBar.drawNew(),searchPane.accept=function(){var search;scriptFocus?(searchBar.cancel(),selection&&scriptFocus.insertBlock(selection)):(search=searchBar.getValue(),search.length>0&&show(myself.blocksMatching(search)))},searchPane.reactToKeystroke=function(evt){var search,idx,code=evt?evt.keyCode:0;switch(code){case 38:if(!scriptFocus||!selection)return;return idx=blocksList.indexOf(selection)-1,idx<0&&(idx=blocksList.length-1),selection=blocksList[idx],void showSelection();case 40:if(!scriptFocus||!selection)return;return idx=blocksList.indexOf(selection)+1,idx>=blocksList.length&&(idx=0),
selection=blocksList[idx],void showSelection();default:search=searchBar.getValue(),search!==oldSearch&&(oldSearch=search,show(myself.blocksMatching(search,search.length<2,types,varNames)))}},searchBar.cancel=function(){ide.refreshPalette(),ide.palette.adjustScrollBars()},ide.fixLayout("refreshPalette"),searchBar.edit(),searchString&&searchPane.reactToKeystroke()},SpriteMorph.prototype.reporterize=function(expressionString){function parseInfix(expression,operator,already){function format(value){return value instanceof Array||isNaN(+value)?value:+value}function nested(){for(var level=1,expr="";idx<expression.length;){switch(ch=expression[idx],idx+=1,ch){case"(":
level+=1;break;case")":if(level-=1,!level)return expr}expr+=ch}}for(var ch,inputs=["",""],idx=0;idx<expression.length;)switch(ch=expression[idx],idx+=1,ch){case" ":break;case"(":inputs[operator?1:0].length?inputs[operator?1:0]=[inputs[operator?1:0],parseInfix(nested())]:inputs[operator?1:0]=parseInfix(nested());break;case"-":case"+":case"*":case"/":case"%":case"=":case"<":case">":case"&":case"|":if(operator||inputs[0].length)if(operator){if(inputs[1].length)return parseInfix(expression.slice(idx),ch,[operator,already,format(inputs[1])]);inputs[1]=ch}else operator=ch,already=format(inputs[0]);else inputs[0]=ch;break;default:inputs[operator?1:0]+=ch}return operator?[operator,already,format(inputs[1])]:format(inputs[0]);
}function blockFromAST(ast){var block,selectors,monads,alias,key,sel,i,inps,off=1,reverseDict={};for(selectors={"+":"reportSum","-":"reportDifference","*":"reportProduct","/":"reportQuotient","%":"reportModulus","=":"reportEquals","<":"reportLessThan",">":"reportGreaterThan","&":"reportAnd","|":"reportOr",round:"reportRound",not:"reportNot"},monads=["abs","ceiling","floor","sqrt","sin","cos","tan","asin","acos","atan","ln","log","round","not"],alias={ceil:"ceiling","!":"not"},monads.concat(["true","false"]).forEach(function(word){reverseDict[localize(word).toLowerCase()]=word}),key=alias[ast[0]]||reverseDict[ast[0].toLowerCase()]||ast[0],contains(monads,key)?(sel=selectors[key],
sel?(block=SpriteMorph.prototype.blockForSelector(sel),inps=block.inputs()):(block=SpriteMorph.prototype.blockForSelector("reportMonadic"),inps=block.inputs(),inps[0].setContents([key]),off=0)):(block=SpriteMorph.prototype.blockForSelector(selectors[key]),inps=block.inputs()),i=1;i<ast.length;i+=1)ast[i]instanceof Array?block.silentReplaceInput(inps[i-off],blockFromAST(ast[i])):isString(ast[i])?contains(["true","false"],reverseDict[ast[i]]||ast[i])?block.silentReplaceInput(inps[i-off],SpriteMorph.prototype.blockForSelector("true"===(reverseDict[ast[i]]||ast[i])?"reportTrue":"reportFalse")):"_"!==ast[i]&&block.silentReplaceInput(inps[i-off],SpriteMorph.prototype.variableBlock(ast[i])):inps[i-off].setContents(ast[i]);
return block.isDraggable=!0,block.fixLayout(),block.fixBlockColor(null,!0),block}var ast;if(expressionString.length>100)return null;try{return ast=parseInfix(expressionString),ast instanceof Array?blockFromAST(ast):null}catch(error){return null}},SpriteMorph.prototype.addVariable=function(name,isGlobal){var ide=this.parentThatIsA(IDE_Morph);isGlobal?(this.globalVariables().addVar(name),ide&&ide.flushBlocksCache("variables")):(this.variables.addVar(name),this.blocksCache.variables=null)},SpriteMorph.prototype.deleteVariable=function(varName){var ide=this.parentThatIsA(IDE_Morph);contains(this.inheritedVariableNames(!0),varName)||this.deleteVariableWatcher(varName),
this.variables.deleteVar(varName),ide&&(ide.flushBlocksCache("variables"),ide.refreshPalette())},SpriteMorph.prototype.addCostume=function(costume){costume.name||(costume.name="costume"+(this.costumes.length()+1)),this.shadowAttribute("costumes"),this.costumes.add(costume)},SpriteMorph.prototype.wearCostume=function(costume,noShadow){var x=this.xPosition?this.xPosition():null,y=this.yPosition?this.yPosition():null,idx=isNil(costume)?null:this.costumes.asArray().indexOf(costume),isWarped=this.isWarped;isWarped&&this.endWarp(),this.changed(),this.costume=costume,this.drawNew(),this.changed(),isWarped&&this.startWarp(),null!==x&&this.silentGotoXY(x,y,!0),this.positionTalkBubble&&this.positionTalkBubble(),
this.version=Date.now(),noShadow||this.shadowAttribute("costume #"),this.specimens().forEach(function(instance){instance.cachedPropagation&&instance.inheritsAttribute("costume #")&&(null===idx?instance.wearCostume(null,!0):idx===-1?instance.wearCostume(costume,!0):instance.doSwitchToCostume(idx+1,!0))})},SpriteMorph.prototype.getCostumeIdx=function(){return this.inheritsAttribute("costume #")?this.exemplar.getCostumeIdx():this.costumes.asArray().indexOf(this.costume)+1},SpriteMorph.prototype.doWearNextCostume=function(){var idx,arr=this.costumes.asArray();arr.length>1&&(idx=arr.indexOf(this.costume),idx>-1&&(idx+=1,idx>arr.length-1&&(idx=0),this.wearCostume(arr[idx])));
},SpriteMorph.prototype.doWearPreviousCostume=function(){var idx,arr=this.costumes.asArray();arr.length>1&&(idx=arr.indexOf(this.costume),idx>-1&&(idx-=1,idx<0&&(idx=arr.length-1),this.wearCostume(arr[idx])))},SpriteMorph.prototype.doSwitchToCostume=function(id,noShadow){if(id instanceof Costume)return void this.wearCostume(id,noShadow);var num,costume,arr=this.costumes.asArray();if(contains([localize("Turtle"),localize("Empty")],id instanceof Array?id[0]:null))costume=null;else{if(id===-1)return void this.doWearPreviousCostume();costume=detect(arr,function(cst){return cst.name===id}),null===costume&&(num=parseFloat(id),costume=0===num?null:arr[num-1]||null)}
this.wearCostume(costume,noShadow)},SpriteMorph.prototype.reportCostumes=function(){return this.costumes},SpriteMorph.prototype.addSound=function(audio,name){this.shadowAttribute("sounds"),this.sounds.add(new Sound(audio,name))},SpriteMorph.prototype.playSound=function(name){var active,stage=this.parentThatIsA(StageMorph),sound=name instanceof Sound?name:detect(this.sounds.asArray(),function(s){return s.name===name});if(sound)return active=sound.play(),stage&&(stage.activeSounds.push(active),stage.activeSounds=stage.activeSounds.filter(function(aud){return!aud.ended&&!aud.terminated})),active},SpriteMorph.prototype.reportSounds=function(){return this.sounds},
SpriteMorph.prototype.userMenu=function(){var ide=this.parentThatIsA(IDE_Morph),menu=new MenuMorph(this);return ide&&ide.isAppMode?menu:(this.isTemporary||(menu.addItem("duplicate","duplicate"),StageMorph.prototype.enableInheritance&&(menu.addItem("clone","instantiate"),menu.addLine())),menu.addItem("delete","remove"),menu.addItem("move","moveCenter"),this.costume&&menu.addItem("pivot","moveRotationCenter","edit the costume's\nrotation center"),this.isTemporary?StageMorph.prototype.enableInheritance&&menu.addItem("edit","perpetuateAndEdit","make permanent and\nshow in the sprite corral"):menu.addItem("edit","edit"),menu.addLine(),this.anchor&&menu.addItem(localize("detach from")+" "+this.anchor.name,"detachFromAnchor"),
this.parts.length&&menu.addItem("detach all parts","detachAllParts"),menu.addItem("export...","exportSprite"),menu)},SpriteMorph.prototype.exportSprite=function(){if(!this.isTemporary){var ide=this.parentThatIsA(IDE_Morph);ide&&ide.exportSprite(this)}},SpriteMorph.prototype.edit=function(){var ide=this.parentThatIsA(IDE_Morph);ide&&!ide.isAppMode&&ide.selectSprite(this)},SpriteMorph.prototype.showOnStage=function(){var stage=this.parentThatIsA(StageMorph);stage&&(this.keepWithin(stage),stage.add(this)),this.show()},SpriteMorph.prototype.duplicate=function(){var ide=this.parentThatIsA(IDE_Morph);ide&&ide.duplicateSprite(this)},SpriteMorph.prototype.instantiate=function(){
var ide=this.parentThatIsA(IDE_Morph);ide&&ide.instantiateSprite(this)},SpriteMorph.prototype.remove=function(){var ide=this.parentThatIsA(IDE_Morph);ide&&ide.removeSprite(this)},SpriteMorph.prototype.createClone=function(immediately){var clone,stage=this.parentThatIsA(StageMorph);return stage&&stage.cloneCount<=5e3&&(clone=this.fullCopy(!0),clone.clonify(stage,immediately)),clone},SpriteMorph.prototype.newClone=function(immediately){var clone=this.createClone(immediately);if(isNil(clone))throw new Error("exceeding maximum number of clones");return clone},SpriteMorph.prototype.clonify=function(stage,immediately){var hats,myself=this;this.parts.forEach(function(part){
part.clonify(stage)}),stage.cloneCount+=1,this.cloneOriginName=this.isTemporary?this.cloneOriginName:this.name,this.isTemporary=!0,this.name="",stage.add(this),hats=this.allHatBlocksFor("__clone__init__"),hats.forEach(function(block){stage.threads.startProcess(block,myself,stage.isThreadSafe,null,null,null,immediately)}),this.endWarp()},SpriteMorph.prototype.initClone=function(hats){var stage=this.parentThatIsA(StageMorph),myself=this;stage&&(hats.forEach(function(block){stage.threads.startProcess(block,myself,stage.isThreadSafe)}),this.endWarp())},SpriteMorph.prototype.removeClone=function(){var exemplar=this.exemplar;this.isTemporary&&(this.parent.threads.stopAllForReceiver(this),
this.corpsify(),this.instances.forEach(function(child){child.isTemporary&&child.setExemplar(exemplar)}),this.destroy(),this.parent.cloneCount-=1)},SpriteMorph.prototype.perpetuate=function(){var stage=this.parentThatIsA(StageMorph),ide=this.parentThatIsA(IDE_Morph);this.exemplar&&this.exemplar.perpetuate(),this.isTemporary&&stage&&ide&&(this.isTemporary=!1,this.name=ide.newSpriteName(this.cloneOriginName),this.cloneOriginName="",stage.cloneCount-=1,ide.corral.addSprite(this),ide.sprites.add(this),this.parts.forEach(function(part){part.perpetuate()}))},SpriteMorph.prototype.perpetuateAndEdit=function(){var ide=this.parentThatIsA(IDE_Morph);ide&&(this.perpetuate(),
ide.selectSprite(this))},SpriteMorph.prototype.release=function(){var idx,stage=this.parentThatIsA(StageMorph),ide=this.parentThatIsA(IDE_Morph);!this.isTemporary&&this.exemplar&&stage&&ide&&(this.parts.forEach(function(part){part.release()}),this.instances.forEach(function(inst){inst.release()}),this.isTemporary=!0,this.name="",this.cloneOriginName=this.exemplar.name,stage.cloneCount+=1,idx=ide.sprites.asArray().indexOf(this)+1,stage.watchers().forEach(function(watcher){watcher.object()===this&&watcher.destroy()}),idx>0&&ide.sprites.remove(idx),ide.createCorral(),ide.fixLayout(),ide.currentSprite===this&&(ide.currentSprite=detect(stage.children,function(morph){
return morph instanceof SpriteMorph&&!morph.isTemporary})||this.stage),ide.selectSprite(ide.currentSprite))},SpriteMorph.prototype.corpsify=function(){this.isCorpse=!0,this.version=Date.now()},SpriteMorph.prototype.hide=function(){SpriteMorph.uber.hide.call(this),this.parts.forEach(function(part){part.hide()})},SpriteMorph.prototype.show=function(){SpriteMorph.uber.show.call(this),this.parts.forEach(function(part){part.show()})},SpriteMorph.prototype.setColor=function(aColor){var x=this.xPosition(),y=this.yPosition();this.color.eq(aColor)||(this.color=aColor.copy(),this.costume||(this.drawNew(),this.silentGotoXY(x,y)))},SpriteMorph.prototype.getHue=function(){
return 100*this.color.hsv()[0]},SpriteMorph.prototype.setHue=function(num){var hsv=this.color.hsv(),x=this.xPosition(),y=this.yPosition();hsv[0]=Math.max(Math.min(+num||0,100),0)/100,hsv[1]=1,this.color.set_hsv.apply(this.color,hsv),this.costume||(this.drawNew(),this.changed()),this.gotoXY(x,y)},SpriteMorph.prototype.changeHue=function(delta){this.setHue(this.getHue()+(+delta||0))},SpriteMorph.prototype.getBrightness=function(){return 100*this.color.hsv()[2]},SpriteMorph.prototype.setBrightness=function(num){var hsv=this.color.hsv(),x=this.xPosition(),y=this.yPosition();hsv[1]=1,hsv[2]=Math.max(Math.min(+num||0,100),0)/100,this.color.set_hsv.apply(this.color,hsv),
this.costume||(this.drawNew(),this.changed()),this.gotoXY(x,y)},SpriteMorph.prototype.changeBrightness=function(delta){this.setBrightness(this.getBrightness()+(+delta||0))},SpriteMorph.prototype.comeToFront=function(){this.parent&&(this.parent.add(this),this.changed())},SpriteMorph.prototype.goBack=function(layers){var layer,targetLayer,newLayer=+layers;return this.parent?(layer=this.parent.children.indexOf(this),this.parent.removeChild(this),targetLayer=Math.max(layer-newLayer,0),this.parent.children.splice(targetLayer,null,this),void this.parent.changed()):null},SpriteMorph.prototype.overlappingImage=function(otherSprite){var oRect=this.bounds.intersect(otherSprite.bounds),oImg=newCanvas(oRect.extent(),!0),ctx=oImg.getContext("2d");
return oRect.width()<1||oRect.height()<1?newCanvas(new Point(1,1),!0):(ctx.drawImage(this.image,this.left()-oRect.left(),this.top()-oRect.top()),ctx.globalCompositeOperation="source-in",ctx.drawImage(otherSprite.image,otherSprite.left()-oRect.left(),otherSprite.top()-oRect.top()),oImg)},SpriteMorph.prototype.doStamp=function(){var stage=this.parent,context=stage.penTrails().getContext("2d"),isWarped=this.isWarped,originalAlpha=context.globalAlpha;isWarped&&this.endWarp(),context.save(),context.scale(1/stage.scale,1/stage.scale),context.globalAlpha=this.alpha,context.drawImage(this.image,this.left()-stage.left(),this.top()-stage.top()),context.globalAlpha=originalAlpha,
context.restore(),this.changed(),isWarped&&this.startWarp()},SpriteMorph.prototype.clear=function(){this.parent.clearPenTrails()},SpriteMorph.prototype.setSize=function(size){isNaN(size)||(this.size=Math.min(Math.max(+size,1e-4),1e3))},SpriteMorph.prototype.changeSize=function(delta){this.setSize(this.size+(+delta||0))},SpriteMorph.prototype.getScale=function(){return this.inheritsAttribute("size")?this.exemplar.getScale():100*this.scale},SpriteMorph.prototype.setScale=function(percentage,noShadow){var realScale,growth,x=this.xPosition(),y=this.yPosition(),isWarped=this.isWarped;isWarped&&this.endWarp(),realScale=(+percentage||0)/100,growth=realScale/this.nestingScale,
this.nestingScale=realScale,this.scale=Math.max(realScale,.01),this.changed(),this.drawNew(),this.changed(),isWarped&&this.startWarp(),this.silentGotoXY(x,y,!0),this.positionTalkBubble(),this.parts.forEach(function(part){var xDist=part.xPosition()-x,yDist=part.yPosition()-y;part.setScale(100*part.scale*growth),part.silentGotoXY(x+xDist*growth,y+yDist*growth)}),noShadow||this.shadowAttribute("size"),this.instances.forEach(function(instance){instance.cachedPropagation&&instance.inheritsAttribute("size")&&instance.setScale(percentage,!0)})},SpriteMorph.prototype.changeScale=function(delta){this.setScale(this.getScale()+(+delta||0))},SpriteMorph.prototype.graphicsChanged=function(){
var myself=this;return Object.keys(this.graphicsValues).some(function(any){return myself.graphicsValues[any]<0||myself.graphicsValues[any]>0})},SpriteMorph.prototype.applyGraphicsEffects=function(canvas){function transform_fisheye(imagedata,value){var pixels,newImageData,newPixels,centerX,centerY,w,h,x,y,dx,dy,r,angle,srcX,srcY,i,srcI;for(w=imagedata.width,h=imagedata.height,pixels=imagedata.data,newImageData=ctx.createImageData(w,h),newPixels=newImageData.data,centerX=w/2,centerY=h/2,value=Math.max(0,(value+100)/100),y=0;y<h;y++)for(x=0;x<w;x++)dx=(x-centerX)/centerX,dy=(y-centerY)/centerY,r=Math.pow(Math.sqrt(dx*dx+dy*dy),value),r<=1?(angle=Math.atan2(dy,dx),
srcX=Math.floor(centerX+r*Math.cos(angle)*centerX),srcY=Math.floor(centerY+r*Math.sin(angle)*centerY)):(srcX=x,srcY=y),i=4*(y*w+x),srcI=4*(srcY*w+srcX),newPixels[i]=pixels[srcI],newPixels[i+1]=pixels[srcI+1],newPixels[i+2]=pixels[srcI+2],newPixels[i+3]=pixels[srcI+3];return newImageData}function transform_whirl(imagedata,value){var pixels,newImageData,newPixels,w,h,centerX,centerY,x,y,radius,scaleX,scaleY,whirlRadians,radiusSquared,dx,dy,d,factor,angle,srcX,srcY,i,srcI,sina,cosa;for(w=imagedata.width,h=imagedata.height,pixels=imagedata.data,newImageData=ctx.createImageData(w,h),newPixels=newImageData.data,centerX=w/2,centerY=h/2,radius=Math.min(centerX,centerY),
w<h?(scaleX=h/w,scaleY=1):(scaleX=1,scaleY=w/h),whirlRadians=-radians(value),radiusSquared=radius*radius,y=0;y<h;y++)for(x=0;x<w;x++)dx=scaleX*(x-centerX),dy=scaleY*(y-centerY),d=dx*dx+dy*dy,d<radiusSquared?(factor=1-Math.sqrt(d)/radius,angle=whirlRadians*(factor*factor),sina=Math.sin(angle),cosa=Math.cos(angle),srcX=Math.floor((cosa*dx-sina*dy)/scaleX+centerX),srcY=Math.floor((sina*dx+cosa*dy)/scaleY+centerY)):(srcX=x,srcY=y),i=4*(y*w+x),srcI=4*(srcY*w+srcX),newPixels[i]=pixels[srcI],newPixels[i+1]=pixels[srcI+1],newPixels[i+2]=pixels[srcI+2],newPixels[i+3]=pixels[srcI+3];return newImageData}function transform_pixelate(imagedata,value){var pixels,newImageData,newPixels,w,h,x,y,srcX,srcY,i,srcI;
for(w=imagedata.width,h=imagedata.height,pixels=imagedata.data,newImageData=ctx.createImageData(w,h),newPixels=newImageData.data,value=Math.floor(Math.abs(value/10)+1),y=0;y<h;y++)for(x=0;x<w;x++)srcX=Math.floor(x/value)*value,srcY=Math.floor(y/value)*value,i=4*(y*w+x),srcI=4*(srcY*w+srcX),newPixels[i]=pixels[srcI],newPixels[i+1]=pixels[srcI+1],newPixels[i+2]=pixels[srcI+2],newPixels[i+3]=pixels[srcI+3];return newImageData}function transform_mosaic(imagedata,value){var pixels,i,l,newImageData,newPixels,srcI;for(pixels=imagedata.data,newImageData=ctx.createImageData(imagedata.width,imagedata.height),newPixels=newImageData.data,value=Math.round((Math.abs(value)+10)/10),
value=Math.max(0,Math.min(value,Math.min(imagedata.width,imagedata.height))),i=0,l=pixels.length;i<l;i+=4)srcI=i*value%l,newPixels[i]=pixels[srcI],newPixels[i+1]=pixels[srcI+1],newPixels[i+2]=pixels[srcI+2],newPixels[i+3]=pixels[srcI+3];return newImageData}function transform_duplicate(imagedata,value){var pixels,i;for(pixels=imagedata.data,i=0;i<pixels.length;i+=4)pixels[i]=pixels[i*value],pixels[i+1]=pixels[i*value+1],pixels[i+2]=pixels[i*value+2],pixels[i+3]=pixels[i*value+3];return imagedata}function transform_HSV(imagedata,hueShift,saturationShift,brightnessShift){var pixels,index,l,r,g,b,max,min,span,h,s,v,i,f,p,q,t,newR,newG,newB;for(pixels=imagedata.data,
index=0,l=pixels.length;index<l;index+=4)r=pixels[index],g=pixels[index+1],b=pixels[index+2],max=Math.max(r,g,b),min=Math.min(r,g,b),span=max-min,0===span?h=s=0:(max===r?h=60*(g-b)/span:max===g?h=120+60*(b-r)/span:max===b&&(h=240+60*(r-g)/span),s=(max-min)/max),h<0&&(h+=360),v=max/255,h=(h+360*hueShift/200)%360,s=Math.max(0,Math.min(s+saturationShift/100,1)),v=Math.max(0,Math.min(v+brightnessShift/100,1)),i=Math.floor(h/60),f=h/60-i,p=v*(1-s),q=v*(1-s*f),t=v*(1-s*(1-f)),0===i||6===i?(newR=v,newG=t,newB=p):1===i?(newR=q,newG=v,newB=p):2===i?(newR=p,newG=v,newB=t):3===i?(newR=p,newG=q,newB=v):4===i?(newR=t,newG=p,newB=v):5===i&&(newR=v,newG=p,newB=q),pixels[index]=255*newR,
pixels[index+1]=255*newG,pixels[index+2]=255*newB;return imagedata}function transform_negative(imagedata,value){var pixels,i,l,rcom,gcom,bcom;for(pixels=imagedata.data,i=0,l=pixels.length;i<l;i+=4)rcom=255-pixels[i],gcom=255-pixels[i+1],bcom=255-pixels[i+2],pixels[i]<rcom?pixels[i]+=value:pixels[i]>rcom&&(pixels[i]-=value),pixels[i+1]<gcom?pixels[i+1]+=value:pixels[i+1]>gcom&&(pixels[i+1]-=value),pixels[i+2]<bcom?pixels[i+2]+=value:pixels[i+2]>bcom&&(pixels[i+2]-=value);return imagedata}function transform_comic(imagedata,value){var pixels,i,l;for(pixels=imagedata.data,i=0,l=pixels.length;i<l;i+=4)pixels[i]+=127*Math.sin(i*value)+128,pixels[i+1]+=127*Math.sin(i*value)+128,
pixels[i+2]+=127*Math.sin(i*value)+128;return imagedata}function transform_confetti(imagedata,value){var pixels,i,l;for(pixels=imagedata.data,i=0,l=pixels.length;i<l;i+=1)pixels[i]=127*Math.sin(value*pixels[i])+pixels[i];return imagedata}var ctx,imagedata;return this.graphicsChanged()&&(ctx=canvas.getContext("2d"),imagedata=ctx.getImageData(0,0,canvas.width,canvas.height),this.graphicsValues.fisheye&&(imagedata=transform_fisheye(imagedata,this.graphicsValues.fisheye)),this.graphicsValues.whirl&&(imagedata=transform_whirl(imagedata,this.graphicsValues.whirl)),this.graphicsValues.pixelate&&(imagedata=transform_pixelate(imagedata,this.graphicsValues.pixelate)),this.graphicsValues.mosaic&&(imagedata=transform_mosaic(imagedata,this.graphicsValues.mosaic)),
this.graphicsValues.duplicate&&(imagedata=transform_duplicate(imagedata,this.graphicsValues.duplicate)),(this.graphicsValues.color||this.graphicsValues.saturation||this.graphicsValues.brightness)&&(imagedata=transform_HSV(imagedata,this.graphicsValues.color,this.graphicsValues.saturation,this.graphicsValues.brightness)),this.graphicsValues.negative&&(imagedata=transform_negative(imagedata,this.graphicsValues.negative)),this.graphicsValues.comic&&(imagedata=transform_comic(imagedata,this.graphicsValues.comic)),this.graphicsValues.confetti&&(imagedata=transform_confetti(imagedata,this.graphicsValues.confetti)),ctx.putImageData(imagedata,0,0)),canvas},SpriteMorph.prototype.setEffect=function(effect,value){
var eff=effect instanceof Array?effect[0]:null;"ghost"===eff?this.alpha=1-Math.min(Math.max(+value||0,0),100)/100:this.graphicsValues[eff]=+value,this.drawNew(),this.changed()},SpriteMorph.prototype.getGhostEffect=function(){return 100*(1-this.alpha)},SpriteMorph.prototype.changeEffect=function(effect,value){var eff=effect instanceof Array?effect[0]:null;"ghost"===eff?this.setEffect(effect,this.getGhostEffect()+(+value||0)):this.setEffect(effect,+this.graphicsValues[eff]+ +value)},SpriteMorph.prototype.clearEffects=function(){var effect;for(effect in this.graphicsValues)this.graphicsValues.hasOwnProperty(effect)&&this.setEffect([effect],0);this.setEffect(["ghost"],0);
},SpriteMorph.prototype.stopTalking=function(){var bubble=this.talkBubble();bubble&&bubble.destroy()},SpriteMorph.prototype.doThink=function(data){this.bubble(data,!0)},SpriteMorph.prototype.bubble=function(data,isThought,isQuestion){var bubble,stage=this.parentThatIsA(StageMorph);this.stopTalking(),""===data||isNil(data)||(bubble=new SpriteBubbleMorph(data,stage,isThought,isQuestion),this.add(bubble),this.positionTalkBubble())},SpriteMorph.prototype.talkBubble=function(){return detect(this.children,function(morph){return morph instanceof SpeechBubbleMorph})},SpriteMorph.prototype.positionTalkBubble=function(){var stage=this.parentThatIsA(StageMorph),stageScale=stage?stage.scale:1,bubble=this.talkBubble(),middle=this.center().y;
if(!bubble)return null;for(bubble.show(),bubble.isPointingRight||(bubble.isPointingRight=!0,bubble.drawNew(),bubble.changed()),bubble.setLeft(this.right()),bubble.setBottom(this.top());!this.isTouching(bubble)&&bubble.bottom()<middle;)bubble.silentMoveBy(new Point(-1,1).scaleBy(stageScale));return stage?(bubble.right()>stage.right()&&(bubble.isPointingRight=!1,bubble.drawNew(),bubble.setRight(this.center().x)),bubble.keepWithin(stage),void bubble.changed()):null},SpriteMorph.prototype.prepareToBeGrabbed=function(hand){this.removeShadow(),this.recordLayers(),this.shadowAttribute("x position"),this.shadowAttribute("y position"),!this.bounds.containsPoint(hand.position())&&this.isCorrectingOutsideDrag()&&this.setCenter(hand.position()),
this.addShadow()},SpriteMorph.prototype.isCorrectingOutsideDrag=function(){return!this.parts.length},SpriteMorph.prototype.justDropped=function(){var stage=this.parentThatIsA(StageMorph),myself=this;stage&&(stage.enableCustomHatBlocks=!0),this.exemplar&&this.inheritedAttributes.forEach(function(att){contains(["direction","size","costume #"],att)&&myself.refreshInheritedAttribute(att)}),this.restoreLayers(),this.positionTalkBubble(),this.receiveUserInteraction("dropped")},SpriteMorph.prototype.drawLine=function(start,dest){var stagePos=this.parent.bounds.origin,stageScale=this.parent.scale,context=this.parent.penTrails().getContext("2d"),from=start.subtract(stagePos).divideBy(stageScale),to=dest.subtract(stagePos).divideBy(stageScale),damagedFrom=from.multiplyBy(stageScale).add(stagePos),damagedTo=to.multiplyBy(stageScale).add(stagePos),damaged=damagedFrom.rectangle(damagedTo).expandBy(Math.max(this.size*stageScale/2,1)).intersect(this.parent.visibleBounds()).spread();
this.isDown&&(context.lineWidth=this.size,context.strokeStyle=this.color.toString(),this.useFlatLineEnds?(context.lineCap="butt",context.lineJoin="miter"):(context.lineCap="round",context.lineJoin="round"),context.beginPath(),context.moveTo(from.x,from.y),context.lineTo(to.x,to.y),context.stroke(),this.isWarped===!1&&this.world().broken.push(damaged))},SpriteMorph.prototype.floodFill=function(){function read(p){var d=4*p;return[dta[d],dta[d+1],dta[d+2],dta[d+3]]}function check(p){return p[0]===src[0]&&p[1]===src[1]&&p[2]===src[2]&&p[3]===src[3]}if(this.parent.bounds.containsPoint(this.rotationCenter())){this.color.a>1&&(this.color.a=this.color.a/255);var current,src,layer=normalizeCanvas(this.parent.penTrails()),width=layer.width,height=layer.height,ctx=layer.getContext("2d"),img=ctx.getImageData(0,0,width,height),dta=img.data,stack=[Math.round(height/2-this.yPosition())*width+Math.round(this.xPosition()+width/2)];
if(src=read(stack[0]),src[0]!==Math.round(this.color.r)||src[1]!==Math.round(this.color.g)||src[2]!==Math.round(this.color.b)||src[3]!==Math.round(255*this.color.a)){for(;stack.length>0;)current=stack.pop(),check(read(current))&&(current%width>1&&(stack.push(current+1),stack.push(current-1)),current>0&&current<height*width&&(stack.push(current+width),stack.push(current-width))),dta[4*current]=Math.round(this.color.r),dta[4*current+1]=Math.round(this.color.g),dta[4*current+2]=Math.round(this.color.b),dta[4*current+3]=Math.round(255*this.color.a);ctx.putImageData(img,0,0),this.parent.changed()}}},SpriteMorph.prototype.reportPenTrailsAsCostume=function(){var cst=new Costume(this.parentThatIsA(StageMorph).trailsCanvas,this.newCostumeName(localize("Costume")));
return cst.shrinkWrap(),cst},SpriteMorph.prototype.moveBy=function(delta,justMe){var start=this.isDown&&!justMe&&this.parent?this.rotationCenter():null;SpriteMorph.uber.moveBy.call(this,delta),start&&this.drawLine(start,this.rotationCenter()),justMe||(this.parts.forEach(function(part){part.moveBy(delta)}),this.instances.forEach(function(instance){if(instance.cachedPropagation){var inheritsX=instance.inheritsAttribute("x position"),inheritsY=instance.inheritsAttribute("y position");inheritsX&&inheritsY?instance.moveBy(delta):inheritsX?instance.moveBy(new Point(delta.x,0)):inheritsY&&instance.moveBy(new Point(0,delta.y))}}))},SpriteMorph.prototype.silentMoveBy=function(delta,justMe){
SpriteMorph.uber.silentMoveBy.call(this,delta),!justMe&&this.parent instanceof HandMorph&&(this.parts.forEach(function(part){part.moveBy(delta)}),this.instances.forEach(function(instance){if(instance.cachedPropagation){var inheritsX=instance.inheritsAttribute("x position"),inheritsY=instance.inheritsAttribute("y position");inheritsX&&inheritsY?instance.moveBy(delta):inheritsX?instance.moveBy(new Point(delta.x,0)):inheritsY&&instance.moveBy(new Point(0,delta.y))}}))},SpriteMorph.prototype.rootForGrab=function(){return this.anchor?this.anchor.rootForGrab():SpriteMorph.uber.rootForGrab.call(this)},SpriteMorph.prototype.setCenter=function(aPoint,justMe){var delta=aPoint.subtract(this.center());
this.moveBy(delta,justMe)},SpriteMorph.prototype.nestingBounds=function(){var result=this.bounds;return!this.costume&&this.penBounds&&(result=this.penBounds.translateBy(this.position())),this.parts.forEach(function(part){part.isVisible&&(result=result.merge(part.nestingBounds()))}),result},SpriteMorph.prototype.setPosition=function(aPoint,justMe){var delta=aPoint.subtract(this.topLeft());0===delta.x&&0===delta.y||this.moveBy(delta,justMe)},SpriteMorph.prototype.forward=function(steps){var dest,dist=steps*this.parent.scale||0;dest=dist>=0?this.position().distanceAngle(dist,this.heading):this.position().distanceAngle(Math.abs(dist),this.heading-180),this.shadowAttribute("x position"),
this.shadowAttribute("y position"),this.setPosition(dest),this.positionTalkBubble()},SpriteMorph.prototype.setHeading=function(degrees,noShadow){var x=this.xPosition(),y=this.yPosition(),dir=isFinite(degrees)?+degrees:0,turn=dir-this.heading;this.rotationStyle?(this.changed(),SpriteMorph.uber.setHeading.call(this,dir),this.silentGotoXY(x,y,!0),this.positionTalkBubble()):this.heading=(+degrees%360+360)%360,this.parts.forEach(function(part){var pos=new Point(part.xPosition(),part.yPosition()),trg=pos.rotateBy(radians(turn),new Point(x,y));part.rotatesWithAnchor&&part.turn(turn),part.gotoXY(trg.x,trg.y)}),noShadow||this.shadowAttribute("direction"),this.instances.forEach(function(instance){
instance.cachedPropagation&&instance.inheritsAttribute("direction")&&instance.setHeading(degrees,!0)})},SpriteMorph.prototype.faceToXY=function(x,y){var deltaX=(x-this.xPosition())*this.parent.scale,deltaY=(y-this.yPosition())*this.parent.scale,angle=Math.abs(deltaX)<.001?deltaY<0?90:270:Math.round((deltaX>=0?0:180)-57.2957795131*Math.atan(deltaY/deltaX));this.setHeading(angle+90)},SpriteMorph.prototype.turn=function(degrees){this.setHeading(this.heading+(+degrees||0))},SpriteMorph.prototype.turnLeft=function(degrees){this.setHeading(this.heading-(+degrees||0))},SpriteMorph.prototype.xPosition=function(){if(this.inheritsAttribute("x position"))return this.exemplar.xPosition();
var stage=this.parentThatIsA(StageMorph);return!stage&&this.parent.grabOrigin&&(stage=this.parent.grabOrigin.origin),stage?(this.rotationCenter().x-stage.center().x)/stage.scale:this.rotationCenter().x},SpriteMorph.prototype.yPosition=function(){if(this.inheritsAttribute("y position"))return this.exemplar.yPosition();var stage=this.parentThatIsA(StageMorph);return!stage&&this.parent.grabOrigin&&(stage=this.parent.grabOrigin.origin),stage?(stage.center().y-this.rotationCenter().y)/stage.scale:this.rotationCenter().y},SpriteMorph.prototype.direction=function(){return this.inheritsAttribute("direction")?this.exemplar.direction():this.heading},SpriteMorph.prototype.penSize=function(){
return this.size},SpriteMorph.prototype.gotoXY=function(x,y,justMe,noShadow){var newX,newY,dest,stage=this.parentThatIsA(StageMorph);stage&&(noShadow||(this.shadowAttribute("x position"),this.shadowAttribute("y position")),x=isFinite(+x)?+x:0,y=isFinite(+y)?+y:0,newX=stage.center().x+x*stage.scale,newY=stage.center().y-y*stage.scale,dest=this.costume?new Point(newX,newY).subtract(this.rotationOffset):new Point(newX,newY).subtract(this.extent().divideBy(2)),this.setPosition(dest,justMe),this.positionTalkBubble())},SpriteMorph.prototype.silentGotoXY=function(x,y,justMe){var penState=this.isDown;this.isDown=!1,this.gotoXY(x,y,justMe,!0),this.isDown=penState},SpriteMorph.prototype.setXPosition=function(num){
this.shadowAttribute("x position"),this.gotoXY(+num||0,this.yPosition(),!1,!0)},SpriteMorph.prototype.changeXPosition=function(delta){this.setXPosition(this.xPosition()+(+delta||0))},SpriteMorph.prototype.setYPosition=function(num){this.shadowAttribute("y position"),this.gotoXY(this.xPosition(),+num||0,!1,!0)},SpriteMorph.prototype.changeYPosition=function(delta){this.setYPosition(this.yPosition()+(+delta||0))},SpriteMorph.prototype.glide=function(duration,endX,endY,elapsed,startPoint){var fraction,endPoint,rPos;endPoint=new Point(endX,endY),fraction=Math.max(Math.min(elapsed/duration,1),0),rPos=startPoint.add(endPoint.subtract(startPoint).multiplyBy(fraction)),
this.gotoXY(rPos.x,rPos.y)},SpriteMorph.prototype.bounceOffEdge=function(){var dirX,dirY,stage=this.parentThatIsA(StageMorph),fb=this.nestingBounds();return stage?stage.bounds.containsRectangle(fb)?null:(dirX=Math.cos(radians(this.heading-90)),dirY=-Math.sin(radians(this.heading-90)),fb.left()<stage.left()&&(dirX=Math.abs(dirX)),fb.right()>stage.right()&&(dirX=-Math.abs(dirX)),fb.top()<stage.top()&&(dirY=-Math.abs(dirY)),fb.bottom()>stage.bottom()&&(dirY=Math.abs(dirY)),this.shadowAttribute("x position"),this.shadowAttribute("y position"),this.shadowAttribute("direction"),this.setHeading(degrees(Math.atan2(-dirY,dirX))+90),this.setPosition(this.position().add(fb.amountToTranslateWithin(stage.bounds))),
void this.positionTalkBubble()):null},SpriteMorph.prototype.setRotationX=function(absoluteX){this.setRotationCenter(new Point(absoluteX,this.yPosition()))},SpriteMorph.prototype.setRotationY=function(absoluteY){this.setRotationCenter(new Point(this.xPosition(),absoluteY))},SpriteMorph.prototype.setRotationCenter=function(absoluteCoordinate){var delta,normal;if(!this.costume)throw new Error("setting the rotation center requires a costume");delta=absoluteCoordinate.subtract(new Point(this.xPosition(),this.yPosition())).divideBy(this.scale).rotateBy(radians(90-this.heading)),normal=this.costume.rotationCenter.add(new Point(delta.x,-delta.y)),this.costume.rotationCenter=normal,
this.drawNew()},SpriteMorph.prototype.moveRotationCenter=function(){this.world().activeHandle=new HandleMorph(this,null,null,null,null,"movePivot")},SpriteMorph.prototype.setPivot=function(worldCoordinate){var cntr,stage=this.parentThatIsA(StageMorph);stage&&(cntr=stage.center(),this.setRotationCenter(new Point((worldCoordinate.x-cntr.x)/stage.scale,(cntr.y-worldCoordinate.y)/stage.scale)))},SpriteMorph.prototype.xCenter=function(){var stage=this.parentThatIsA(StageMorph);return!stage&&this.parent.grabOrigin&&(stage=this.parent.grabOrigin.origin),stage?(this.center().x-stage.center().x)/stage.scale:this.center().x},SpriteMorph.prototype.yCenter=function(){var stage=this.parentThatIsA(StageMorph);
return!stage&&this.parent.grabOrigin&&(stage=this.parent.grabOrigin.origin),stage?(stage.center().y-this.center().y)/stage.scale:this.center().y},SpriteMorph.prototype.allMessageNames=function(){var msgs=[],all=this.scripts.children.slice();return this.customBlocks.forEach(function(def){def.body&&all.push(def.body.expression),def.scripts.forEach(function(scr){all.push(scr)})}),this.globalBlocks&&this.globalBlocks.forEach(function(def){def.body&&all.push(def.body.expression),def.scripts.forEach(function(scr){all.push(scr)})}),all.forEach(function(script){script.allChildren().forEach(function(morph){var txt;morph.selector&&contains(["receiveMessage","doBroadcast","doBroadcastAndWait"],morph.selector)&&(txt=morph.inputs()[0].evaluate(),
isString(txt)&&""!==txt&&(contains(msgs,txt)||msgs.push(txt)))})}),msgs},SpriteMorph.prototype.allHatBlocksFor=function(message){return"number"==typeof message&&(message=message.toString()),this.scripts.children.filter(function(morph){var event;if(morph.selector){if("receiveMessage"===morph.selector)return event=morph.inputs()[0].evaluate(),event===message||event instanceof Array&&"__shout__go__"!==message&&"__clone__init__"!==message;if("receiveGo"===morph.selector)return"__shout__go__"===message;if("receiveOnClone"===morph.selector)return"__clone__init__"===message}return!1})},SpriteMorph.prototype.allHatBlocksForKey=function(key){return this.scripts.children.filter(function(morph){
if(morph.selector&&"receiveKey"===morph.selector){var evt=morph.inputs()[0].evaluate()[0];return evt===key||"any key"===evt}return!1})},SpriteMorph.prototype.allHatBlocksForInteraction=function(interaction){return this.scripts.children.filter(function(morph){return!(!morph.selector||"receiveInteraction"!==morph.selector)&&morph.inputs()[0].evaluate()[0]===interaction})},SpriteMorph.prototype.allGenericHatBlocks=function(){return this.scripts.children.filter(function(morph){return!!morph.selector&&"receiveCondition"===morph.selector})},SpriteMorph.prototype.mouseClickLeft=function(){return this.receiveUserInteraction("clicked")},SpriteMorph.prototype.mouseEnter=function(){
return this.receiveUserInteraction("mouse-entered")},SpriteMorph.prototype.mouseDownLeft=function(){return this.receiveUserInteraction("pressed")},SpriteMorph.prototype.receiveUserInteraction=function(interaction){var hats,stage=this.parentThatIsA(StageMorph),procs=[],myself=this;if(stage)return hats=this.allHatBlocksForInteraction(interaction),hats.forEach(function(block){procs.push(stage.threads.startProcess(block,myself,stage.isThreadSafe))}),procs},SpriteMorph.prototype.mouseDoubleClick=function(){this.isTemporary||this.edit()},SpriteMorph.prototype.getTimer=function(){var stage=this.parentThatIsA(StageMorph);return stage?stage.getTimer():0},SpriteMorph.prototype.getTempo=function(){
var stage=this.parentThatIsA(StageMorph);return stage?stage.getTempo():0},SpriteMorph.prototype.getLastMessage=function(){var stage=this.parentThatIsA(StageMorph);return stage?stage.getLastMessage():""},SpriteMorph.prototype.getLastAnswer=function(){return this.parentThatIsA(StageMorph).lastAnswer},SpriteMorph.prototype.reportMouseX=function(){var stage=this.parentThatIsA(StageMorph);return stage?stage.reportMouseX():0},SpriteMorph.prototype.reportMouseY=function(){var stage=this.parentThatIsA(StageMorph);return stage?stage.reportMouseY():0},SpriteMorph.prototype.reportThreadCount=function(){var stage=this.parentThatIsA(StageMorph);return stage?stage.threads.processes.length:0;
},SpriteMorph.prototype.refactorVariableInstances=function(oldName,newName,isGlobal){isGlobal&&this.hasSpriteVariable(oldName)||this.scripts.children.forEach(function(child){child instanceof BlockMorph&&child.refactorVarInStack(oldName,newName)})},SpriteMorph.prototype.findVariableWatcher=function(varName){var stage=this.parentThatIsA(StageMorph),globals=this.globalVariables(),myself=this;return null===stage?null:detect(stage.children,function(morph){return morph instanceof WatcherMorph&&(morph.target===myself.variables||morph.target===globals)&&morph.getter===varName})},SpriteMorph.prototype.toggleVariableWatcher=function(varName,isGlobal){var watcher,others,stage=this.parentThatIsA(StageMorph),globals=this.globalVariables();
return null===stage?null:(watcher=this.findVariableWatcher(varName),null!==watcher?void(watcher.isVisible?watcher.hide():(watcher.show(),watcher.fixLayout(),watcher.keepWithin(stage))):(isNil(isGlobal)&&(isGlobal=contains(globals.names(),varName)),watcher=new WatcherMorph(varName,this.blockColor.variables,isGlobal?globals:this.variables,varName),watcher.setPosition(stage.position().add(10)),others=stage.watchers(watcher.left()),others.length>0&&watcher.setTop(others[others.length-1].bottom()),stage.add(watcher),watcher.fixLayout(),watcher.keepWithin(stage),watcher))},SpriteMorph.prototype.showingVariableWatcher=function(varName){var watcher,stage=this.parentThatIsA(StageMorph);
return null!==stage&&(watcher=this.findVariableWatcher(varName),!!watcher&&watcher.isVisible)},SpriteMorph.prototype.deleteVariableWatcher=function(varName){var watcher,stage=this.parentThatIsA(StageMorph);return null===stage?null:(watcher=this.findVariableWatcher(varName),void(null!==watcher&&watcher.destroy()))},SpriteMorph.prototype.toggleWatcher=function(selector,label,color){var watcher,others,stage=this.parentThatIsA(StageMorph);if(stage){if(watcher=this.watcherFor(stage,selector))return void(watcher.isVisible?watcher.hide():(watcher.show(),watcher.fixLayout(),watcher.keepWithin(stage)));watcher=new WatcherMorph(label,color,WatcherMorph.prototype.isGlobal(selector)?stage:this,selector),
watcher.setPosition(stage.position().add(10)),others=stage.watchers(watcher.left()),others.length>0&&watcher.setTop(others[others.length-1].bottom()),stage.add(watcher),watcher.fixLayout(),watcher.keepWithin(stage)}},SpriteMorph.prototype.showingWatcher=function(selector){var watcher,stage=this.parentThatIsA(StageMorph);return null!==stage&&(watcher=this.watcherFor(stage,selector),!!watcher&&watcher.isVisible)},SpriteMorph.prototype.watcherFor=function(stage,selector){var myself=this;return detect(stage.children,function(morph){return morph instanceof WatcherMorph&&morph.getter===selector&&morph.target===(morph.isGlobal(selector)?stage:myself)})},SpriteMorph.prototype.deleteAllBlockInstances=function(definition){
var stage,blocks=definition.isGlobal?this.allBlockInstances(definition):this.allIndependentInvocationsOf(definition.blockSpec());blocks.forEach(function(each){each.deleteBlock()}),definition.isGlobal?(stage=this.parentThatIsA(StageMorph),stage&&(stage.globalBlocks.forEach(function(def){def.purgeCorpses()}),stage.children.concat(stage).forEach(function(sprite){sprite.isSnapObject&&sprite.customBlocks.forEach(function(def){def.purgeCorpses()})}))):this.allSpecimens().concat(this).forEach(function(sprite){sprite.customBlocks.forEach(function(def){def.purgeCorpses()})})},SpriteMorph.prototype.allBlockInstances=function(definition){var stage,objects,inDefinitions,blocks=[];
return definition.isGlobal?(stage=this.parentThatIsA(StageMorph),objects=stage.children.filter(function(morph){return morph instanceof SpriteMorph}),objects.push(stage),objects.forEach(function(sprite){blocks=blocks.concat(sprite.allLocalBlockInstances(definition))}),inDefinitions=[],stage.globalBlocks.forEach(function(def){def.scripts.forEach(function(eachScript){eachScript.allChildren().forEach(function(c){c.isCustomBlock&&c.definition===definition&&inDefinitions.push(c)})}),def.body&&def.body.expression.allChildren().forEach(function(c){c.isCustomBlock&&c.definition===definition&&inDefinitions.push(c)})}),blocks.concat(inDefinitions)):this.allLocalBlockInstances(definition);
},SpriteMorph.prototype.allIndependentInvocationsOf=function(aSpec){var blocks;return this.exemplar&&this.exemplar.getMethod(aSpec)?[]:(blocks=this.allInvocationsOf(aSpec),this.instances.forEach(function(sprite){sprite.addAllInvocationsOf(aSpec,blocks)}),blocks)},SpriteMorph.prototype.allDependentInvocationsOf=function(aSpec){var blocks;return blocks=this.allInvocationsOf(aSpec),this.instances.forEach(function(sprite){sprite.addAllInvocationsOf(aSpec,blocks)}),blocks},SpriteMorph.prototype.allInvocationsOf=function(aSpec){var inScripts,inDefinitions,inBlockEditors,blocks;return inScripts=this.scripts.allChildren().filter(function(c){return c.isCustomBlock&&!c.isGlobal&&c.blockSpec===aSpec;
}),inDefinitions=[],this.customBlocks.forEach(function(def){def.scripts.forEach(function(eachScript){eachScript.allChildren().forEach(function(c){c.isCustomBlock&&!c.isGlobal&&c.blockSpec===aSpec&&inDefinitions.push(c)})}),def.body&&def.body.expression.allChildren().forEach(function(c){c.isCustomBlock&&!c.isGlobal&&c.blockSpec===aSpec&&inDefinitions.push(c)})}),inBlockEditors=this.allEditorBlockInstances(null,aSpec),blocks=inScripts.concat(inDefinitions).concat(inBlockEditors)},SpriteMorph.prototype.addAllInvocationsOf=function(aSpec,anArray){this.getLocalMethod(aSpec)||(this.allInvocationsOf(aSpec).forEach(function(block){anArray.push(block)}),this.instances.forEach(function(sprite){
sprite.addAllInvocationsOf(aSpec,anArray)}))},SpriteMorph.prototype.allLocalBlockInstances=function(definition){var inScripts,inDefinitions,inBlockEditors,inPalette,result;return inScripts=this.scripts.allChildren().filter(function(c){return c.isCustomBlock&&c.definition===definition}),inDefinitions=[],this.customBlocks.forEach(function(def){def.body&&def.body.expression.allChildren().forEach(function(c){c.isCustomBlock&&c.definition===definition&&inDefinitions.push(c)})}),inBlockEditors=this.allEditorBlockInstances(definition),inPalette=this.paletteBlockInstance(definition),result=inScripts.concat(inDefinitions).concat(inBlockEditors),inPalette&&result.push(inPalette),
result},SpriteMorph.prototype.allEditorBlockInstances=function(definition,spec){var inBlockEditors=[],world=this.world();return world?(this.world().children.forEach(function(morph){morph instanceof BlockEditorMorph&&morph.body.contents.allChildren().forEach(function(block){definition?block.isPrototype||block instanceof PrototypeHatBlockMorph||block.definition!==definition||inBlockEditors.push(block):!block.isCustomBlock||block.isGlobal||block.isPrototype||block instanceof PrototypeHatBlockMorph||block.blockSpec!==spec||inBlockEditors.push(block)})}),inBlockEditors):[]},SpriteMorph.prototype.paletteBlockInstance=function(definition){var ide=this.parentThatIsA(IDE_Morph);
return ide?detect(ide.palette.contents.children,function(block){return block.isCustomBlock&&block.definition===definition}):null},SpriteMorph.prototype.usesBlockInstance=function(definition,forRemoval,skipGlobals,skipBlocks){var inDefinitions,inScripts=detect(this.scripts.allChildren(),function(c){return c.isCustomBlock&&c.definition===definition});return!!inScripts||(!!(definition.isGlobal&&!skipGlobals&&(inDefinitions=[],this.parentThatIsA(StageMorph).globalBlocks.forEach(function(def){forRemoval&&definition===def||skipBlocks&&contains(skipBlocks,def)||def.body&&def.body.expression.allChildren().forEach(function(c){c.isCustomBlock&&c.definition===definition&&inDefinitions.push(c);
})}),inDefinitions.length>0))||(inDefinitions=[],this.customBlocks.forEach(function(def){def.body&&def.body.expression.allChildren().forEach(function(c){c.isCustomBlock&&c.definition===definition&&inDefinitions.push(c)})}),inDefinitions.length>0))},SpriteMorph.prototype.doubleDefinitionsFor=function(definition){var blockList,idx,stage,spec=definition.blockSpec();if(definition.isGlobal){if(stage=this.parentThatIsA(StageMorph),!stage)return[];blockList=stage.globalBlocks}else blockList=this.customBlocks;return idx=blockList.indexOf(definition),idx===-1?[]:blockList.filter(function(def,i){return def.blockSpec()===spec&&i!==idx})},SpriteMorph.prototype.replaceDoubleDefinitionsFor=function(definition){
var stage,ide,doubles=this.doubleDefinitionsFor(definition),myself=this;doubles.forEach(function(double){myself.allBlockInstances(double).forEach(function(block){block.definition=definition,block.refresh()})}),definition.isGlobal?(stage=this.parentThatIsA(StageMorph),stage.globalBlocks=stage.globalBlocks.filter(function(def){return!contains(doubles,def)})):this.customBlocks=this.customBlocks.filter(function(def){return!contains(doubles,def)}),ide=this.parentThatIsA(IDE_Morph),ide&&(ide.flushPaletteCache(),ide.refreshPalette())},SpriteMorph.prototype.chooseExemplar=function(){var menu,stage=this.parentThatIsA(StageMorph),myself=this,other=stage.children.filter(function(m){
return m instanceof SpriteMorph&&!m.isTemporary&&!contains(m.allExemplars(),myself)});menu=new MenuMorph(function(aSprite){myself.setExemplar(aSprite)},localize("current parent")+":\n"+(this.exemplar?this.exemplar.name:localize("none"))),other.forEach(function(eachSprite){menu.addItem(eachSprite.name,eachSprite)}),menu.addLine(),menu.addItem(localize("none"),null),menu.popUpAtHand(this.world())},SpriteMorph.prototype.setExemplar=function(another){var ide;this.emancipate(),this.exemplar=another,another?(this.variables.parentFrame=another.variables,another.addSpecimen(this)):this.variables.parentFrame=this.globalVariables(),this.isTemporary||(ide=this.parentThatIsA(IDE_Morph),
ide&&(ide.flushBlocksCache("variables"),ide.refreshPalette()))},SpriteMorph.prototype.prune=function(){this.instances.forEach(function(child){child.shadowAllAttributes(),child.shadowAllMethods(),child.shadowAllVars(),child.exemplar=null}),this.instances=[]},SpriteMorph.prototype.emancipate=function(){this.exemplar&&(this.isTemporary||(this.shadowAllAttributes(),this.shadowAllMethods(),this.shadowAllVars()),this.exemplar.removeSpecimen(this),this.exemplar=null)},SpriteMorph.prototype.allExemplars=function(){for(var all=[],current=this;!isNil(current);)all.push(current),current=current.exemplar;return all},SpriteMorph.prototype.specimens=function(){return this.instances;
},SpriteMorph.prototype.allSpecimens=function(){var all=this.instances.slice();return this.instances.forEach(function(child){all.push.apply(all,child.allSpecimens())}),all},SpriteMorph.prototype.addSpecimen=function(another){this.instances.push(another)},SpriteMorph.prototype.removeSpecimen=function(another){var idx=this.instances.indexOf(another);idx!==-1&&this.instances.splice(idx,1)},SpriteMorph.prototype.inheritsAttribute=function(aName){return!isNil(this.exemplar)&&contains(this.inheritedAttributes,aName)},SpriteMorph.prototype.updatePropagationCache=function(){var myself=this;this.cachedPropagation=!isNil(this.exemplar)&&detect(["x position","y position","direction","size","costume #"],function(att){
return contains(myself.inheritedAttributes,att)})},SpriteMorph.prototype.shadowedAttributes=function(){var inherited=this.inheritedAttributes;return this.attributes.filter(function(each){return!contains(inherited,each)})},SpriteMorph.prototype.shadowAllAttributes=function(){var myself=this;this.attributes.forEach(function(att){myself.shadowAttribute(att)})},SpriteMorph.prototype.shadowAttribute=function(aName){var ide,wardrobe,jukebox,pos,myself=this;this.inheritsAttribute(aName)&&(ide=this.parentThatIsA(IDE_Morph),this.inheritedAttributes=this.inheritedAttributes.filter(function(each){return each!==aName}),"costumes"===aName?(wardrobe=new List,this.costumes.asArray().forEach(function(costume){
var cst=costume.copy();wardrobe.add(cst),costume===myself.costume&&myself.wearCostume(cst)}),this.costumes=wardrobe,this.instances.forEach(function(obj){obj.inheritsAttribute("costumes")&&obj.refreshInheritedAttribute("costumes")})):"sounds"===aName?(jukebox=new List,this.sounds.asArray().forEach(function(sound){jukebox.add(sound.copy())}),this.sounds=jukebox,this.instances.forEach(function(obj){obj.inheritsAttribute("sounds")&&obj.refreshInheritedAttribute("sounds")})):"scripts"===aName?(ide.stage.threads.stopAllForReceiver(this),pos=this.scripts.position(),this.scripts=this.exemplar.scripts.fullCopy(),ide&&contains(ide.currentSprite.allExemplars(),this)&&(ide.createSpriteEditor(),
ide.fixLayout("selectSprite"),this.scripts.fixMultiArgs(),this.scripts.setPosition(pos),ide.spriteEditor.adjustScrollBars()),this.instances.forEach(function(obj){obj.inheritsAttribute("scripts")&&obj.refreshInheritedAttribute("scripts")})):(this.updatePropagationCache(),ide&&!this.isTemporary&&(ide.flushBlocksCache(),ide.refreshPalette())))},SpriteMorph.prototype.inheritAttribute=function(aName){var ide=this.parentThatIsA(IDE_Morph);this.exemplar&&contains(this.attributes,aName)&&(this.inheritsAttribute(aName)||(this.inheritedAttributes.push(aName),this.refreshInheritedAttribute(aName),ide&&(ide.flushBlocksCache(),ide.refreshPalette())))},SpriteMorph.prototype.refreshInheritedAttribute=function(aName){
var ide,idx;switch(aName){case"x position":case"y position":this.cachedPropagation=!0,this.gotoXY(this.xPosition(),this.yPosition(),!1,!0);break;case"direction":this.cachedPropagation=!0,this.setHeading(this.direction(),!0);break;case"size":this.cachedPropagation=!0,this.setScale(this.getScale(),!0);break;case"costume #":this.cachedPropagation=!0,this.doSwitchToCostume(this.getCostumeIdx(),!0);break;case"costumes":idx=this.getCostumeIdx(),this.costumes=this.exemplar.costumes,this.doSwitchToCostume(idx,!0),this.instances.forEach(function(sprite){sprite.inheritsAttribute("costumes")&&sprite.refreshInheritedAttribute("costumes")});break;case"sounds":this.sounds=this.exemplar.sounds,
this.instances.forEach(function(sprite){sprite.inheritsAttribute("sounds")&&sprite.refreshInheritedAttribute("sounds")});break;case"scripts":this.scripts=this.exemplar.scripts,ide=this.parentThatIsA(IDE_Morph),ide&&(ide.stage.threads.stopAllForReceiver(this),contains(ide.currentSprite.allExemplars(),this)&&(ide.createSpriteEditor(),ide.fixLayout("selectSprite"))),this.instances.forEach(function(sprite){sprite.inheritsAttribute("scripts")&&sprite.refreshInheritedAttribute("scripts")});break;default:nop()}},SpriteMorph.prototype.toggleInheritanceForAttribute=function(aName){this.inheritsAttribute(aName)?this.shadowAttribute(aName):this.inheritAttribute(aName)},
SpriteMorph.prototype.isVariableNameInUse=function(vName,isGlobal){return isGlobal?contains(this.variables.allNames(),vName):!!contains(this.variables.names(),vName)||contains(this.globalVariables().names(),vName)},SpriteMorph.prototype.globalVariables=function(){for(var current=this.variables.parentFrame;current.owner;)current=current.parentFrame;return current},SpriteMorph.prototype.shadowAllVars=function(){var myself=this;this.inheritedVariableNames().forEach(function(name){myself.shadowVar(name,myself.variables.getVar(name))})},SpriteMorph.prototype.shadowVar=function(name,value){var ide;this.variables.addVar(name,value),this.isTemporary||(ide=this.parentThatIsA(IDE_Morph),
ide&&(ide.flushBlocksCache("variables"),ide.refreshPalette()))},SpriteMorph.prototype.toggleInheritedVariable=function(vName){contains(this.inheritedVariableNames(!0),vName)?this.deleteVariable(vName):contains(this.inheritedVariableNames(),vName)&&this.shadowVar(vName,this.variables.getVar(vName))},SpriteMorph.prototype.inheritedVariableNames=function(shadowedOnly){function test(each){return shadowedOnly?contains(own,each):!contains(own,each)}for(var names=[],own=this.variables.names(),current=this.variables.parentFrame;current.owner instanceof SpriteMorph;)names.push.apply(names,current.names().filter(test)),current=current.parentFrame;return names},SpriteMorph.prototype.deletableVariableNames=function(){
var locals=this.variables.names(),inherited=this.inheritedVariableNames();return locals.concat(this.globalVariables().names().filter(function(each){return!contains(locals,each)&&!contains(inherited,each)}))};SpriteMorph.prototype.hasSpriteVariable=function(varName){return contains(this.variables.names(),varName)};SpriteMorph.prototype.getMethod=function(spec){return this.allBlocks()[spec]},SpriteMorph.prototype.getLocalMethod=function(spec){return this.ownBlocks()[spec]},SpriteMorph.prototype.ownBlocks=function(){var dict={};return this.customBlocks.forEach(function(def){dict[def.blockSpec()]=def}),dict},SpriteMorph.prototype.allBlocks=function(valuesOnly){var dict={};
return this.allExemplars().reverse().forEach(function(sprite){sprite.customBlocks.forEach(function(def){dict[def.blockSpec()]=def})}),valuesOnly?Object.keys(dict).map(function(key){return dict[key]}):dict},SpriteMorph.prototype.inheritedBlocks=function(valuesOnly){var dict={},own=Object.keys(this.ownBlocks()),others=this.allExemplars().reverse();return others.pop(),others.forEach(function(sprite){sprite.customBlocks.forEach(function(def){var spec=def.blockSpec();contains(own,spec)||(dict[spec]=def)})}),valuesOnly?Object.keys(dict).map(function(key){return dict[key]}):dict},SpriteMorph.prototype.shadowAllMethods=function(){var ide,myself=this;this.inheritedMethods().forEach(function(dup){
myself.customBlocks.push(dup)}),this.isTemporary||(ide=this.parentThatIsA(IDE_Morph),ide&&(ide.flushPaletteCache(),ide.refreshPalette()))},SpriteMorph.prototype.inheritedMethods=function(){var myself=this;return this.inheritedBlocks(!0).map(function(def){return def.copyAndBindTo(myself,!0)})},SpriteMorph.prototype.thumbnail=function(extentPoint){function xOut(style,alpha,width){var inset=Math.min(extentPoint.x,extentPoint.y)/10;ctx.strokeStyle=style,ctx.globalAlpha=alpha,ctx.compositeOperation="lighter",ctx.lineWidth=width||1,ctx.moveTo(inset,inset),ctx.lineTo(trg.width-inset,trg.height-inset),ctx.moveTo(inset,trg.height-inset),ctx.lineTo(trg.width-inset,inset),
ctx.stroke()}var src=this.image,scale=Math.min(extentPoint.x/src.width,extentPoint.y/src.height),xOffset=(extentPoint.x-src.width*scale)/2,yOffset=(extentPoint.y-src.height*scale)/2,trg=newCanvas(extentPoint),ctx=trg.getContext("2d");return ctx.save(),this.isCorpse&&(ctx.globalAlpha=.3),src.width&&src.height&&(ctx.scale(scale,scale),ctx.drawImage(src,Math.floor(xOffset/scale),Math.floor(yOffset/scale))),this.isCorpse&&(ctx.restore(),xOut("white",.8,6),xOut("black",.8,1)),trg},SpriteMorph.prototype.fullThumbnail=function(extentPoint){var thumb=this.thumbnail(extentPoint),ctx=thumb.getContext("2d"),ext=extentPoint.divideBy(3),i=0;for(ctx.restore(),this.anchor&&ctx.drawImage(this.anchor.thumbnail(ext),0,0),
i=0;i<3;i+=1)this.parts[i]&&ctx.drawImage(this.parts[i].thumbnail(ext),i*ext.x,extentPoint.y-ext.y);return thumb},SpriteMorph.prototype.booleanMorph=function(bool){var sym=new BooleanSlotMorph(bool);return sym.isStatic=!0,sym.drawNew(),sym},SpriteMorph.prototype.attachPart=function(aSprite){var v=Date.now();aSprite.anchor&&aSprite.anchor.detachPart(aSprite),this.parts.push(aSprite),this.version=v,aSprite.anchor=this,this.allParts().forEach(function(part){part.nestingScale=part.scale}),aSprite.version=v},SpriteMorph.prototype.detachPart=function(aSprite){var v,idx=this.parts.indexOf(aSprite);idx!==-1&&(v=Date.now(),this.parts.splice(idx,1),this.version=v,aSprite.anchor=null,
aSprite.version=v)},SpriteMorph.prototype.detachAllParts=function(){var v=Date.now();this.parts.forEach(function(part){part.anchor=null,part.version=v}),this.parts=[],this.version=v},SpriteMorph.prototype.detachFromAnchor=function(){this.anchor&&this.anchor.detachPart(this)},SpriteMorph.prototype.allParts=function(){var result=[this];return this.parts.forEach(function(part){result=result.concat(part.allParts())}),result},SpriteMorph.prototype.allAnchors=function(){var result=[this];return null!==this.anchor&&(result=result.concat(this.anchor.allAnchors())),result},SpriteMorph.prototype.recordLayers=function(){var stage=this.parentThatIsA(StageMorph);return stage?(this.layers=this.allParts(),
this.layers.forEach(function(part){var bubble=part.talkBubble();bubble&&bubble.hide()}),void this.layers.sort(function(x,y){return stage.children.indexOf(x)<stage.children.indexOf(y)?-1:1})):void(this.layerCache=null)},SpriteMorph.prototype.restoreLayers=function(){this.layers&&this.layers.length>1&&this.layers.forEach(function(sprite){sprite.comeToFront(),sprite.positionTalkBubble()}),this.layers=null},SpriteMorph.prototype.destroy=function(){this.anchor&&this.anchor.detachPart(this),this.emancipate(),this.isTemporary||this.prune(),SpriteMorph.uber.destroy.call(this)},SpriteMorph.prototype.flash=function(){var world=this.world(),myself=this;this.addHighlight(),
world.animations.push(new Animation(nop,nop,0,800,nop,function(){myself.removeHighlight()}))},SpriteMorph.prototype.addHighlight=function(oldHighlight){var highlight,isHidden=!this.isVisible;return isHidden&&this.show(),highlight=this.highlight(oldHighlight?oldHighlight.color:this.highlightColor,this.highlightBorder),this.addBack(highlight),this.fullChanged(),isHidden&&this.hide(),highlight},SpriteMorph.prototype.removeHighlight=function(){var highlight=this.getHighlight();return null!==highlight&&(this.fullChanged(),this.removeChild(highlight)),highlight},SpriteMorph.prototype.toggleHighlight=function(){this.getHighlight()?this.removeHighlight():this.addHighlight();
},SpriteMorph.prototype.highlight=function(color,border){var ctx,highlight=new SpriteHighlightMorph,fb=this.bounds,edge=border;return highlight.setExtent(fb.extent().add(2*edge)),highlight.color=color,highlight.image=this.highlightImage(color,border),ctx=highlight.image.getContext("2d"),ctx.drawImage(this.highlightImage(new Color(255,255,255),4),border-4,border-4),ctx.drawImage(this.highlightImage(new Color(50,50,50),2),border-2,border-2),ctx.drawImage(this.highlightImage(new Color(255,255,255),1),border-1,border-1),highlight.setPosition(fb.origin.subtract(new Point(edge,edge))),highlight},SpriteMorph.prototype.highlightImage=function(color,border){var fb,img,hi,ctx,out;
return fb=this.extent(),img=this.image,hi=newCanvas(fb.add(2*border)),ctx=hi.getContext("2d"),ctx.drawImage(img,0,0),ctx.drawImage(img,border,0),ctx.drawImage(img,2*border,0),ctx.drawImage(img,2*border,border),ctx.drawImage(img,2*border,2*border),ctx.drawImage(img,border,2*border),ctx.drawImage(img,0,2*border),ctx.drawImage(img,0,border),ctx.globalCompositeOperation="destination-out",ctx.drawImage(img,border,border),out=newCanvas(fb.add(2*border)),ctx=out.getContext("2d"),ctx.drawImage(hi,0,0),ctx.globalCompositeOperation="source-atop",ctx.fillStyle=color.toString(),ctx.fillRect(0,0,out.width,out.height),out},SpriteMorph.prototype.getHighlight=function(){var highlights;
return highlights=this.children.slice(0).reverse().filter(function(child){return child instanceof SpriteHighlightMorph}),0!==highlights.length?highlights[0]:null},SpriteMorph.prototype.mouseEnterDragging=function(){var obj;this.enableNesting&&(obj=this.world().hand.children[0],this.wantsDropOf(obj)&&this.addHighlight())},SpriteMorph.prototype.mouseLeave=function(){this.receiveUserInteraction("mouse-departed"),this.enableNesting&&this.removeHighlight()},SpriteMorph.prototype.wantsDropOf=function(morph){return this.enableNesting&&morph instanceof SpriteIconMorph&&!contains(morph.object.allParts(),this)},SpriteMorph.prototype.reactToDropOf=function(morph,hand){this.removeHighlight(),
this.attachPart(morph.object),this.world().add(morph),morph.slideBackTo(hand.grabOrigin)},SpriteMorph.prototype.newCostumeName=function(name,ignoredCostume){for(var ix=name.indexOf("("),stem=ix<0?name:name.substring(0,ix),count=1,newName=stem,all=this.costumes.asArray().filter(function(each){return each!==ignoredCostume}).map(function(each){return each.name});contains(all,newName);)count+=1,newName=stem+"("+count+")";return newName},SpriteMorph.prototype.doScreenshot=function(imgSource,data){var canvas,costume,stage=this.parentThatIsA(StageMorph);data=this.newCostumeName(data),void 0!==imgSource[0]&&("pen trails"===imgSource[0]?(canvas=stage.trailsCanvas,costume=new Costume(canvas,data).copy()):"stage image"===imgSource[0]&&(canvas=stage.fullImageClassic(),
costume=new Costume(canvas,data)),this.addCostume(costume))},SpriteHighlightMorph.prototype=new Morph,SpriteHighlightMorph.prototype.constructor=SpriteHighlightMorph,SpriteHighlightMorph.uber=Morph.prototype,StageMorph.prototype=new FrameMorph,StageMorph.prototype.constructor=StageMorph,StageMorph.uber=FrameMorph.prototype,StageMorph.prototype.dimensions=new Point(480,360),StageMorph.prototype.frameRate=0,StageMorph.prototype.isCachingPrimitives=SpriteMorph.prototype.isCachingPrimitives,StageMorph.prototype.sliderColor=SpriteMorph.prototype.sliderColor,StageMorph.prototype.paletteTextColor=SpriteMorph.prototype.paletteTextColor,StageMorph.prototype.hiddenPrimitives={},
StageMorph.prototype.codeMappings={},StageMorph.prototype.codeHeaders={},StageMorph.prototype.enableCodeMapping=!1,StageMorph.prototype.enableInheritance=!0,StageMorph.prototype.enableSublistIDs=!1,StageMorph.prototype.init=function(globals){this.name=localize("Stage"),this.instrument=null,this.threads=new ThreadManager,this.variables=new VariableFrame(globals||null,this),this.scripts=new ScriptsMorph,this.customBlocks=[],this.globalBlocks=[],this.costumes=new List,this.costume=null,this.sounds=new List,this.version=Date.now(),this.isFastTracked=!1,this.enableCustomHatBlocks=!0,this.cloneCount=0,this.timerStart=Date.now(),this.tempo=60,this.lastMessage="",this.watcherUpdateFrequency=2,
this.lastWatcherUpdate=Date.now(),this.scale=1,this.keysPressed={},this.blocksCache={},this.paletteCache={},this.lastAnswer="",this.activeSounds=[],this.trailsCanvas=null,this.isThreadSafe=!1,this.graphicsValues={color:0,fisheye:0,whirl:0,pixelate:0,mosaic:0,duplicate:0,negative:0,comic:0,confetti:0,saturation:0,brightness:0},StageMorph.uber.init.call(this),this.acceptsDrops=!1,this.setColor(new Color(255,255,255)),this.fps=this.frameRate},StageMorph.prototype.setScale=function(number){var relativePos,bubble,delta=number/this.scale,pos=this.position(),oldFlag=Morph.prototype.trackChanges,myself=this;1!==delta&&(Morph.prototype.trackChanges=!1,this.scale=number,
this.setExtent(this.dimensions.multiplyBy(number)),this.children.forEach(function(morph){relativePos=morph.position().subtract(pos),morph.drawNew(),morph.setPosition(relativePos.multiplyBy(delta).add(pos),!0),morph instanceof SpriteMorph?(bubble=morph.talkBubble(),bubble&&(bubble.setScale(number),morph.positionTalkBubble())):morph instanceof StagePrompterMorph&&(myself.scale<1?morph.setWidth(myself.width()-10):morph.setWidth(myself.dimensions.x-20),morph.fixLayout(),morph.setCenter(myself.center()),morph.setBottom(myself.bottom()))}),Morph.prototype.trackChanges=oldFlag,this.changed())},StageMorph.prototype.drawNew=function(){var ctx;StageMorph.uber.drawNew.call(this),
this.costume&&(ctx=this.image.getContext("2d"),ctx.scale(this.scale,this.scale),ctx.drawImage(this.costume.contents,(this.width()/this.scale-this.costume.width())/2,(this.height()/this.scale-this.costume.height())/2),this.image=this.applyGraphicsEffects(this.image)),this.version=Date.now()},StageMorph.prototype.drawOn=function(aCanvas,aRect){var rectangle,area,delta,src,context,w,h,sl,st,ws,hs;if(!this.isVisible)return null;if(rectangle=aRect||this.bounds,area=rectangle.intersect(this.bounds),area.extent().gt(new Point(0,0))){if(delta=this.position().neg(),src=area.copy().translateBy(delta),context=aCanvas.getContext("2d"),context.globalAlpha=this.alpha,sl=src.left(),
st=src.top(),w=Math.min(src.width(),this.image.width-sl),h=Math.min(src.height(),this.image.height-st),w<1||h<1)return null;context.drawImage(this.image,sl,st,w,h,area.left(),area.top(),w,h),ws=w/this.scale,hs=h/this.scale,context.save(),context.scale(this.scale,this.scale);try{context.drawImage(this.penTrails(),sl/this.scale,st/this.scale,ws,hs,area.left()/this.scale,area.top()/this.scale,ws,hs)}catch(err){context.restore(),context.drawImage(this.penTrails(),0,0,this.dimensions.x,this.dimensions.y,this.left(),this.top(),this.dimensions.x*this.scale,this.dimensions.y*this.scale)}context.restore()}},StageMorph.prototype.clearPenTrails=function(){this.trailsCanvas=newCanvas(this.dimensions),
this.changed()},StageMorph.prototype.penTrails=function(){return this.trailsCanvas||(this.trailsCanvas=newCanvas(this.dimensions)),this.trailsCanvas},StageMorph.prototype.penTrailsMorph=function(){var ctx,morph=new Morph,trails=this.penTrails();return morph.bounds=this.bounds.copy(),morph.image=newCanvas(this.extent()),ctx=morph.image.getContext("2d"),ctx.drawImage(trails,0,0,trails.width,trails.height,0,0,this.image.width,this.image.height),morph},StageMorph.prototype.colorFiltered=function(aColor,excludedSprite){var ctx,src,clr,i,dta,morph=new Morph,ext=this.extent(),img=this.thumbnail(ext,excludedSprite);for(src=normalizeCanvas(img,!0).getContext("2d").getImageData(0,0,ext.x,ext.y),
morph.bounds=this.bounds.copy(),morph.image=newCanvas(ext,!0),ctx=morph.image.getContext("2d"),dta=ctx.createImageData(ext.x,ext.y),i=0;i<ext.x*ext.y*4;i+=4)clr=new Color(src.data[i],src.data[i+1],src.data[i+2]),clr.eq(aColor)&&(dta.data[i]=src.data[i],dta.data[i+1]=src.data[i+1],dta.data[i+2]=src.data[i+2],dta.data[i+3]=255);return ctx.putImageData(dta,0,0),morph},StageMorph.prototype.getPixelColor=function(aPoint){var point,context,data;if(this.trailsCanvas)return point=aPoint.subtract(this.bounds.origin),context=this.trailsCanvas.getContext("2d"),data=context.getImageData(point.x,point.y,1,1),0===data.data[3]?StageMorph.uber.getPixelColor.call(this,aPoint):new Color(data.data[0],data.data[1],data.data[2],data.data[3]/255);
},StageMorph.prototype.watchers=function(leftPos){return this.children.filter(function(morph){return morph instanceof WatcherMorph&&(leftPos?morph.left()===leftPos:morph.isVisible)})},StageMorph.prototype.resetTimer=function(){this.timerStart=Date.now()},StageMorph.prototype.getTimer=function(){var elapsed=Math.floor((Date.now()-this.timerStart)/100);return elapsed/10},StageMorph.prototype.setTempo=function(bpm){this.tempo=Math.max(20,+bpm||0)},StageMorph.prototype.changeTempo=function(delta){this.setTempo(this.getTempo()+(+delta||0))},StageMorph.prototype.getTempo=function(){return+this.tempo},StageMorph.prototype.getLastMessage=function(){return this.lastMessage||"";
},StageMorph.prototype.reportMouseX=function(){var world=this.world();return world?(world.hand.position().x-this.center().x)/this.scale:0},StageMorph.prototype.reportMouseY=function(){var world=this.world();return world?(this.center().y-world.hand.position().y)/this.scale:0},StageMorph.prototype.wantsDropOf=function(aMorph){return aMorph instanceof SpriteMorph||aMorph instanceof WatcherMorph||aMorph instanceof ListWatcherMorph||aMorph instanceof SpriteIconMorph},StageMorph.prototype.reactToDropOf=function(morph,hand){morph instanceof SpriteIconMorph&&(morph.object.anchor&&morph.object.anchor.detachPart(morph.object),this.world().add(morph),morph.slideBackTo(hand.grabOrigin));
},StageMorph.prototype.step=function(){var current,elapsed,leftover,ide,world=this.world();if(null===world.keyboardReceiver&&(world.keyboardReceiver=this),null===world.currentKey&&(this.keyPressed=null),this.enableCustomHatBlocks&&this.stepGenericConditions(),this.isFastTracked&&this.threads.processes.length){for(this.children.forEach(function(morph){morph instanceof SpriteMorph&&(morph.wasWarped=morph.isWarped,morph.isWarped||morph.startWarp())});Date.now()-this.lastTime<17;)this.threads.step();this.children.forEach(function(morph){morph instanceof SpriteMorph&&(morph.wasWarped||morph.endWarp())}),this.changed()}else this.threads.step(),this.threads.wantsToPause&&(ide=this.parentThatIsA(IDE_Morph),
ide&&ide.controlBar.pauseButton.refresh());current=Date.now(),elapsed=current-this.lastWatcherUpdate,leftover=1e3/this.watcherUpdateFrequency-elapsed,leftover<1&&(this.watchers().forEach(function(w){w.update()}),this.lastWatcherUpdate=Date.now())},StageMorph.prototype.stepGenericConditions=function(stopAll){var ide,hatCount=0,myself=this;this.children.concat(this).forEach(function(morph){isSnapObject(morph)&&morph.allGenericHatBlocks().forEach(function(block){hatCount+=1,myself.threads.doWhen(block,morph,stopAll)})}),hatCount||(this.enableCustomHatBlocks=!1,ide=this.parentThatIsA(IDE_Morph),ide&&ide.controlBar.stopButton.refresh())},StageMorph.prototype.developersMenu=function(){
var myself=this,menu=StageMorph.uber.developersMenu.call(this);return menu.addItem("stop",function(){myself.threads.stopAll()},"terminate all running threads"),menu},StageMorph.prototype.processKeyDown=function(event){this.processKeyEvent(event,this.fireKeyEvent)},StageMorph.prototype.processKeyUp=function(event){this.processKeyEvent(event,this.removePressedKey)},StageMorph.prototype.processKeyEvent=function(event,action){var keyName;switch(event.keyCode){case 13:keyName="enter",event.ctrlKey||event.metaKey?keyName="ctrl enter":event.shiftKey&&(keyName="shift enter");break;case 27:keyName="esc";break;case 32:keyName="space";break;case 37:keyName="left arrow";break;
case 39:keyName="right arrow";break;case 38:keyName="up arrow";break;case 40:keyName="down arrow";break;default:keyName=String.fromCharCode(event.keyCode||event.charCode),(event.ctrlKey||event.metaKey)&&(keyName="ctrl "+(event.shiftKey?"shift ":"")+keyName)}action.call(this,keyName)},StageMorph.prototype.fireKeyEvent=function(key){var evt=key.toLowerCase(),procs=[],ide=this.parentThatIsA(IDE_Morph),myself=this;return this.keysPressed[evt]=!0,"ctrl enter"===evt?this.fireGreenFlagEvent():"shift enter"===evt?this.editScripts():"ctrl f"===evt?void(ide.isAppMode||ide.currentSprite.searchBlocks()):"ctrl z"===evt?void(ide.isAppMode||ide.currentSprite.scripts.undrop()):"ctrl shift z"===evt||"ctrl y"===evt?void(ide.isAppMode||ide.currentSprite.scripts.redrop()):"ctrl n"===evt?void(ide.isAppMode||ide.createNewProject()):"ctrl o"===evt?void(ide.isAppMode||ide.openProjectsBrowser()):"ctrl s"===evt?void(ide.isAppMode||ide.save()):"ctrl shift s"!==evt?"esc"===evt?this.fireStopAllEvent():(this.children.concat(this).forEach(function(morph){
isSnapObject(morph)&&morph.allHatBlocksForKey(evt).forEach(function(block){procs.push(myself.threads.startProcess(block,morph,myself.isThreadSafe))})}),procs):ide.isAppMode?void 0:ide.saveProjectsBrowser()},StageMorph.prototype.removePressedKey=function(key){delete this.keysPressed[key.toLowerCase()]},StageMorph.prototype.processKeyPress=function(event){nop(event)},StageMorph.prototype.inspectKeyEvent=CursorMorph.prototype.inspectKeyEvent,StageMorph.prototype.fireGreenFlagEvent=function(){compteur();var procs=[],ide=this.parentThatIsA(IDE_Morph),myself=this;return this.children.concat(this).forEach(function(morph){isSnapObject(morph)&&morph.allHatBlocksFor("__shout__go__").forEach(function(block){
procs.push(myself.threads.startProcess(block,morph,myself.isThreadSafe))})}),ide&&ide.controlBar.pauseButton.refresh(),procs},StageMorph.prototype.fireStopAllEvent=function(){var ide=this.parentThatIsA(IDE_Morph);this.threads.resumeAll(this.stage),this.keysPressed={},this.threads.stopAll(),this.stopAllActiveSounds(),this.children.forEach(function(morph){morph.stopTalking&&morph.stopTalking()}),this.removeAllClones(),ide&&ide.nextSteps([nop,function(){ide.controlBar.pauseButton.refresh()}])},StageMorph.prototype.removeAllClones=function(){var myself=this,clones=this.children.filter(function(morph){return morph instanceof SpriteMorph&&morph.isTemporary});clones.forEach(function(clone){
myself.threads.stopAllForReceiver(clone),clone.detachFromAnchor(),clone.corpsify(),clone.destroy()}),this.cloneCount=0},StageMorph.prototype.editScripts=function(){var scripts,sorted,ide=this.parentThatIsA(IDE_Morph);!ide.isAppMode&&ScriptsMorph.prototype.enableKeyboard&&(scripts=this.parentThatIsA(IDE_Morph).currentSprite.scripts.selectForEdit(),scripts.edit(scripts.position()),sorted=scripts.focus.sortedScripts(),sorted.length?(scripts.focus.element=sorted[0],scripts.focus.element instanceof HatBlockMorph&&scripts.focus.nextCommand()):scripts.focus.moveBy(new Point(50,50)),scripts.focus.fixLayout())},StageMorph.prototype.blockTemplates=function(category){function block(selector){
if(myself.hiddenPrimitives[selector])return null;var newBlock=SpriteMorph.prototype.blockForSelector(selector,!0);return newBlock.isTemplate=!0,newBlock}function variableBlock(varName){var newBlock=SpriteMorph.prototype.variableBlock(varName);return newBlock.isDraggable=!1,newBlock.isTemplate=!0,newBlock}function watcherToggle(selector){if(myself.hiddenPrimitives[selector])return null;var info=SpriteMorph.prototype.blocks[selector];return new ToggleMorph("checkbox",this,function(){myself.toggleWatcher(selector,localize(info.spec),myself.blockColor[info.category])},null,function(){return myself.showingWatcher(selector)},null)}function variableWatcherToggle(varName){
return new ToggleMorph("checkbox",this,function(){myself.toggleVariableWatcher(varName)},null,function(){return myself.showingVariableWatcher(varName)},null)}function addVar(pair){pair&&(myself.isVariableNameInUse(pair[0])?myself.inform("that name is already in use"):(myself.addVariable(pair[0],pair[1]),myself.toggleVariableWatcher(pair[0],pair[1]),myself.blocksCache[cat]=null,myself.paletteCache[cat]=null,myself.parentThatIsA(IDE_Morph).refreshPalette()))}var varNames,button,txt,blocks=[],myself=this,cat=category||"motion";return"motion"===cat?(txt=new TextMorph(localize("Stage selected:\nno motion primitives")),txt.fontSize=9,txt.setColor(this.paletteTextColor),
blocks.push(txt),blocks.push("="),blocks.push(this.makeBlockButton(cat))):"looks"===cat?(blocks.push(block("doSwitchToCostume")),blocks.push(block("doWearNextCostume")),blocks.push(watcherToggle("getCostumeIdx")),blocks.push(block("getCostumeIdx")),blocks.push("-"),blocks.push(block("changeEffect")),blocks.push(block("setEffect")),blocks.push(block("clearEffects")),blocks.push("-"),blocks.push(block("show")),blocks.push(block("hide")),this.world().isDevMode&&(blocks.push("-"),txt=new TextMorph(localize("development mode \ndebugging primitives:")),txt.fontSize=9,txt.setColor(this.paletteTextColor),blocks.push(txt),blocks.push("-"),blocks.push(block("log")),blocks.push(block("alert")),
blocks.push("-"),blocks.push(block("doScreenshot"))),blocks.push("="),blocks.push(this.makeBlockButton(cat))):"sound"===cat?(blocks.push(block("playSound")),blocks.push(block("doPlaySoundUntilDone")),blocks.push(block("doStopAllSounds")),blocks.push("-"),blocks.push(block("doRest")),blocks.push(block("doPlayNote")),blocks.push(block("doSetInstrument")),blocks.push("-"),blocks.push(block("doChangeTempo")),blocks.push(block("doSetTempo")),blocks.push(watcherToggle("getTempo")),blocks.push(block("getTempo")),blocks.push("="),blocks.push(this.makeBlockButton(cat))):"pen"===cat?(blocks.push(block("clear")),blocks.push(block("reportPenTrailsAsCostume")),blocks.push("="),
blocks.push(this.makeBlockButton(cat))):"control"===cat?(blocks.push(block("receiveGo")),blocks.push(block("receiveKey")),blocks.push(block("receiveInteraction")),blocks.push(block("receiveCondition")),blocks.push(block("receiveMessage")),blocks.push("-"),blocks.push(block("doBroadcast")),blocks.push(block("doBroadcastAndWait")),blocks.push(watcherToggle("getLastMessage")),blocks.push(block("getLastMessage")),blocks.push("-"),blocks.push(block("doWarp")),blocks.push("-"),blocks.push(block("doWait")),blocks.push(block("doWaitUntil")),blocks.push("-"),blocks.push(block("doForever")),blocks.push(block("doRepeat")),blocks.push(block("doUntil")),blocks.push("-"),blocks.push(block("doIf")),
blocks.push(block("doIfElse")),blocks.push("-"),blocks.push(block("doReport")),blocks.push(block("doStopThis")),blocks.push(block("doStopOthers")),blocks.push("-"),blocks.push(block("doRun")),blocks.push(block("fork")),blocks.push(block("evaluate")),blocks.push("-"),blocks.push(block("doTellTo")),blocks.push(block("reportAskFor")),blocks.push("-"),blocks.push(block("doCallCC")),blocks.push(block("reportCallCC")),blocks.push("-"),blocks.push(block("createClone")),blocks.push(block("newClone")),blocks.push("-"),blocks.push(block("doPauseAll")),blocks.push("="),blocks.push(this.makeBlockButton(cat))):"sensing"===cat?(blocks.push(block("doAsk")),blocks.push(watcherToggle("getLastAnswer")),
blocks.push(block("getLastAnswer")),blocks.push("-"),blocks.push(watcherToggle("reportMouseX")),blocks.push(block("reportMouseX")),blocks.push(watcherToggle("reportMouseY")),blocks.push(block("reportMouseY")),blocks.push(block("reportMouseDown")),blocks.push("-"),blocks.push(block("reportKeyPressed")),blocks.push("-"),blocks.push(block("doResetTimer")),blocks.push(watcherToggle("getTimer")),blocks.push(block("getTimer")),blocks.push("-"),blocks.push(block("reportAttributeOf")),SpriteMorph.prototype.enableFirstClass&&blocks.push(block("reportGet")),blocks.push("-"),blocks.push(block("reportURL")),blocks.push("-"),blocks.push(block("reportIsFastTracking")),blocks.push(block("doSetFastTracking")),
blocks.push("-"),blocks.push(block("reportDate")),this.world().isDevMode&&(blocks.push("-"),txt=new TextMorph(localize("development mode \ndebugging primitives:")),txt.fontSize=9,txt.setColor(this.paletteTextColor),blocks.push(txt),blocks.push("-"),blocks.push(watcherToggle("reportThreadCount")),blocks.push(block("reportThreadCount")),blocks.push(block("colorFiltered")),blocks.push(block("reportStackSize")),blocks.push(block("reportFrameCount"))),blocks.push("="),blocks.push(this.makeBlockButton(cat))):"operators"===cat?(blocks.push(block("reifyScript")),blocks.push(block("reifyReporter")),blocks.push(block("reifyPredicate")),blocks.push("#"),blocks.push("-"),
blocks.push(block("reportSum")),blocks.push(block("reportDifference")),blocks.push(block("reportProduct")),blocks.push(block("reportQuotient")),blocks.push("-"),blocks.push(block("reportModulus")),blocks.push(block("reportRound")),blocks.push(block("reportMonadic")),blocks.push(block("reportRandom")),blocks.push("-"),blocks.push(block("reportLessThan")),blocks.push(block("reportEquals")),blocks.push(block("reportGreaterThan")),blocks.push("-"),blocks.push(block("reportAnd")),blocks.push(block("reportOr")),blocks.push(block("reportNot")),blocks.push(block("reportBoolean")),blocks.push("-"),blocks.push(block("reportJoinWords")),blocks.push(block("reportTextSplit")),
blocks.push(block("reportLetter")),blocks.push(block("reportStringSize")),blocks.push("-"),blocks.push(block("reportUnicode")),blocks.push(block("reportUnicodeAsLetter")),blocks.push("-"),blocks.push(block("reportIsA")),blocks.push(block("reportIsIdentical")),blocks.push("-"),blocks.push(block("reportJSFunction")),this.world().isDevMode&&(blocks.push("-"),txt=new TextMorph("development mode \ndebugging primitives:"),txt.fontSize=9,txt.setColor(this.paletteTextColor),blocks.push(txt),blocks.push("-"),blocks.push(block("reportTypeOf")),blocks.push(block("reportTextFunction"))),blocks.push("="),blocks.push(this.makeBlockButton(cat))):"variables"===cat&&(button=new PushButtonMorph(null,function(){
new VariableDialogMorph(null,addVar,myself).prompt("Variable name",null,myself.world())},"Make a variable"),blocks.push(button),this.variables.allNames().length>0&&(button=new PushButtonMorph(null,function(){var menu=new MenuMorph(myself.deleteVariable,null,myself);myself.variables.allNames().forEach(function(name){menu.addItem(name,name)}),menu.popUpAtHand(myself.world())},"Delete a variable"),blocks.push(button)),blocks.push("-"),varNames=this.variables.allNames(),varNames.length>0&&(varNames.forEach(function(name){blocks.push(variableWatcherToggle(name)),blocks.push(variableBlock(name))}),blocks.push("-")),blocks.push(block("doSetVar")),blocks.push(block("doChangeVar")),
blocks.push(block("doShowVar")),blocks.push(block("doHideVar")),blocks.push(block("doDeclareVariables")),blocks.push("="),blocks.push(block("reportNewList")),blocks.push("-"),blocks.push(block("reportCONS")),blocks.push(block("reportListItem")),blocks.push(block("reportCDR")),blocks.push("-"),blocks.push(block("reportListLength")),blocks.push(block("reportListContainsItem")),blocks.push("-"),blocks.push(block("doAddToList")),blocks.push(block("doDeleteFromList")),blocks.push(block("doInsertInList")),blocks.push(block("doReplaceInList")),this.world().isDevMode&&(blocks.push("-"),txt=new TextMorph(localize("development mode \ndebugging primitives:")),txt.fontSize=9,
txt.setColor(this.paletteTextColor),blocks.push(txt),blocks.push("-"),blocks.push(block("reportMap")),blocks.push("-"),blocks.push(block("doForEach")),blocks.push(block("doShowTable"))),blocks.push("="),StageMorph.prototype.enableCodeMapping&&(blocks.push(block("doMapCodeOrHeader")),blocks.push(block("doMapValueCode")),blocks.push(block("doMapListCode")),blocks.push("-"),blocks.push(block("reportMappedCode")),blocks.push("=")),blocks.push(this.makeBlockButton())),blocks},StageMorph.prototype.clear=function(){this.clearPenTrails()},StageMorph.prototype.userMenu=function(){var ide=this.parentThatIsA(IDE_Morph),menu=new MenuMorph(this),myself=this;return ide&&ide.isAppMode?menu:(menu.addItem("edit","edit"),
menu.addItem("show all","showAll"),menu.addItem("pic...",function(){ide.saveCanvasAs(myself.fullImageClassic(),myself.name)},"open a new window\nwith a picture of the stage"),menu.addLine(),menu.addItem("pen trails",function(){var costume=ide.currentSprite.reportPenTrailsAsCostume().copy();ide.currentSprite.addCostume(costume),ide.currentSprite.wearCostume(costume),ide.hasChangedMedia=!0,ide.spriteBar.tabBar.tabTo("costumes")},ide.currentSprite instanceof SpriteMorph?"turn all pen trails and stamps\ninto a new costume for the\ncurrently selected sprite":"turn all pen trails and stamps\ninto a new background for the stage"),menu)},StageMorph.prototype.showAll=function(){
var myself=this;this.children.forEach(function(m){m instanceof SpriteMorph?m.anchor||(m.show(),m.keepWithin(myself)):(m.show(),m.keepWithin(myself),m.fixLayout&&m.fixLayout())})},StageMorph.prototype.edit=SpriteMorph.prototype.edit,StageMorph.prototype.thumbnail=function(extentPoint,excludedSprite){var fb,fimg,myself=this,src=this.image,scale=Math.min(extentPoint.x/src.width,extentPoint.y/src.height),trg=newCanvas(extentPoint),ctx=trg.getContext("2d");return ctx.scale(scale,scale),ctx.drawImage(src,0,0),ctx.drawImage(this.penTrails(),0,0,this.dimensions.x*this.scale,this.dimensions.y*this.scale),this.children.forEach(function(morph){morph.isVisible&&morph!==excludedSprite&&(fb=morph.fullBounds(),
fimg=morph.fullImage(),fimg.width&&fimg.height&&ctx.drawImage(morph.fullImage(),fb.origin.x-myself.bounds.origin.x,fb.origin.y-myself.bounds.origin.y))}),trg},StageMorph.prototype.hide=function(){this.isVisible=!1,this.changed()},StageMorph.prototype.show=function(){this.isVisible=!0,this.changed()},StageMorph.prototype.createClone=nop,StageMorph.prototype.newClone=nop,StageMorph.prototype.categories=SpriteMorph.prototype.categories,StageMorph.prototype.blockColor=SpriteMorph.prototype.blockColor,StageMorph.prototype.paletteColor=SpriteMorph.prototype.paletteColor,StageMorph.prototype.setName=SpriteMorph.prototype.setName,StageMorph.prototype.makeBlockButton=SpriteMorph.prototype.makeBlockButton,
StageMorph.prototype.makeBlock=SpriteMorph.prototype.makeBlock,StageMorph.prototype.palette=SpriteMorph.prototype.palette,StageMorph.prototype.freshPalette=SpriteMorph.prototype.freshPalette,StageMorph.prototype.blocksMatching=SpriteMorph.prototype.blocksMatching,StageMorph.prototype.searchBlocks=SpriteMorph.prototype.searchBlocks,StageMorph.prototype.reporterize=SpriteMorph.prototype.reporterize,StageMorph.prototype.showingWatcher=SpriteMorph.prototype.showingWatcher,StageMorph.prototype.addVariable=SpriteMorph.prototype.addVariable,StageMorph.prototype.deleteVariable=SpriteMorph.prototype.deleteVariable,StageMorph.prototype.doScreenshot=SpriteMorph.prototype.doScreenshot,
StageMorph.prototype.newCostumeName=SpriteMorph.prototype.newCostumeName,StageMorph.prototype.blockForSelector=SpriteMorph.prototype.blockForSelector,StageMorph.prototype.findVariableWatcher=SpriteMorph.prototype.findVariableWatcher,StageMorph.prototype.toggleVariableWatcher=SpriteMorph.prototype.toggleVariableWatcher,StageMorph.prototype.showingVariableWatcher=SpriteMorph.prototype.showingVariableWatcher,StageMorph.prototype.deleteVariableWatcher=SpriteMorph.prototype.deleteVariableWatcher,StageMorph.prototype.addCostume=SpriteMorph.prototype.addCostume,StageMorph.prototype.wearCostume=SpriteMorph.prototype.wearCostume,StageMorph.prototype.getCostumeIdx=SpriteMorph.prototype.getCostumeIdx,
StageMorph.prototype.doWearNextCostume=SpriteMorph.prototype.doWearNextCostume,StageMorph.prototype.doWearPreviousCostume=SpriteMorph.prototype.doWearPreviousCostume,StageMorph.prototype.doSwitchToCostume=SpriteMorph.prototype.doSwitchToCostume,StageMorph.prototype.reportCostumes=SpriteMorph.prototype.reportCostumes,StageMorph.prototype.graphicsChanged=SpriteMorph.prototype.graphicsChanged,StageMorph.prototype.applyGraphicsEffects=SpriteMorph.prototype.applyGraphicsEffects,StageMorph.prototype.setEffect=SpriteMorph.prototype.setEffect,StageMorph.prototype.getGhostEffect=SpriteMorph.prototype.getGhostEffect,StageMorph.prototype.changeEffect=SpriteMorph.prototype.changeEffect,
StageMorph.prototype.clearEffects=SpriteMorph.prototype.clearEffects,StageMorph.prototype.addSound=SpriteMorph.prototype.addSound,StageMorph.prototype.playSound=SpriteMorph.prototype.playSound,StageMorph.prototype.stopAllActiveSounds=function(){this.activeSounds.forEach(function(audio){audio.pause()}),this.activeSounds=[]},StageMorph.prototype.pauseAllActiveSounds=function(){this.activeSounds.forEach(function(audio){audio.pause()})},StageMorph.prototype.resumeAllActiveSounds=function(){this.activeSounds.forEach(function(audio){audio.play()})},StageMorph.prototype.reportSounds=SpriteMorph.prototype.reportSounds,StageMorph.prototype.toggleWatcher=SpriteMorph.prototype.toggleWatcher,
StageMorph.prototype.showingWatcher=SpriteMorph.prototype.showingWatcher,StageMorph.prototype.watcherFor=SpriteMorph.prototype.watcherFor,StageMorph.prototype.getLastAnswer=SpriteMorph.prototype.getLastAnswer,StageMorph.prototype.reportThreadCount=SpriteMorph.prototype.reportThreadCount,StageMorph.prototype.allMessageNames=SpriteMorph.prototype.allMessageNames,StageMorph.prototype.allHatBlocksFor=SpriteMorph.prototype.allHatBlocksFor,StageMorph.prototype.allHatBlocksForKey=SpriteMorph.prototype.allHatBlocksForKey,StageMorph.prototype.allHatBlocksForInteraction=SpriteMorph.prototype.allHatBlocksForInteraction,StageMorph.prototype.allGenericHatBlocks=SpriteMorph.prototype.allGenericHatBlocks,
StageMorph.prototype.mouseClickLeft=SpriteMorph.prototype.mouseClickLeft,StageMorph.prototype.mouseEnter=SpriteMorph.prototype.mouseEnter,StageMorph.prototype.mouseLeave=function(){this.receiveUserInteraction("mouse-departed")},StageMorph.prototype.mouseDownLeft=SpriteMorph.prototype.mouseDownLeft,StageMorph.prototype.receiveUserInteraction=SpriteMorph.prototype.receiveUserInteraction,StageMorph.prototype.deleteAllBlockInstances=SpriteMorph.prototype.deleteAllBlockInstances,StageMorph.prototype.allBlockInstances=SpriteMorph.prototype.allBlockInstances,StageMorph.prototype.allLocalBlockInstances=SpriteMorph.prototype.allLocalBlockInstances,StageMorph.prototype.allEditorBlockInstances=SpriteMorph.prototype.allEditorBlockInstances,
StageMorph.prototype.paletteBlockInstance=SpriteMorph.prototype.paletteBlockInstance,StageMorph.prototype.usesBlockInstance=SpriteMorph.prototype.usesBlockInstance,StageMorph.prototype.doubleDefinitionsFor=SpriteMorph.prototype.doubleDefinitionsFor,StageMorph.prototype.replaceDoubleDefinitionsFor=SpriteMorph.prototype.replaceDoubleDefinitionsFor,StageMorph.prototype.allInvocationsOf=SpriteMorph.prototype.allInvocationsOf,StageMorph.prototype.allIndependentInvocationsOf=SpriteMorph.prototype.allInvocationsOf,StageMorph.prototype.allDependentInvocationsOf=SpriteMorph.prototype.allInvocationsOf,StageMorph.prototype.specimens=function(){return[]},StageMorph.prototype.allSpecimens=function(){
return[]},StageMorph.prototype.shadowAttribute=nop,StageMorph.prototype.inheritsAttribute=function(){return!1},StageMorph.prototype.isVariableNameInUse=SpriteMorph.prototype.isVariableNameInUse,StageMorph.prototype.globalVariables=SpriteMorph.prototype.globalVariables,StageMorph.prototype.inheritedVariableNames=function(){return[]},StageMorph.prototype.getMethod=SpriteMorph.prototype.getMethod,StageMorph.prototype.getLocalMethod=SpriteMorph.prototype.getLocalMethod,StageMorph.prototype.ownBlocks=SpriteMorph.prototype.ownBlocks,StageMorph.prototype.allBlocks=function(valuesOnly){var dict=this.ownBlocks();return valuesOnly?Object.keys(dict).map(function(key){return dict[key];
}):dict},StageMorph.prototype.inheritedBlocks=function(){return[]},StageMorph.prototype.hasSpriteVariable=SpriteMorph.prototype.hasSpriteVariable,StageMorph.prototype.refactorVariableInstances=SpriteMorph.prototype.refactorVariableInstances,StageMorph.prototype.reportPenTrailsAsCostume=function(){return new Costume(this.trailsCanvas,this.newCostumeName(localize("Background")))},SpriteBubbleMorph.prototype=new SpeechBubbleMorph,SpriteBubbleMorph.prototype.constructor=SpriteBubbleMorph,SpriteBubbleMorph.uber=SpeechBubbleMorph.prototype,SpriteBubbleMorph.prototype.init=function(data,stage,isThought,isQuestion){var sprite=SpriteMorph.prototype;this.stage=stage,this.scale=stage?stage.scale:1,
this.data=data,this.isQuestion=isQuestion,SpriteBubbleMorph.uber.init.call(this,this.dataAsMorph(data),sprite.bubbleColor,null,null,isQuestion?sprite.blockColor.sensing:sprite.bubbleBorderColor,null,isThought)},SpriteBubbleMorph.prototype.dataAsMorph=function(data,toggle){var contents,isTable,isText,img,scaledImg,width,sprite=SpriteMorph.prototype;return data instanceof Morph?isSnapObject(data)?(img=data.thumbnail(new Point(40,40)),contents=new Morph,contents.silentSetWidth(img.width),contents.silentSetHeight(img.height),contents.image=img,contents.version=data.version,contents.step=function(){this.version!==data.version&&(img=data.thumbnail(new Point(40,40)),
this.image=img,this.version=data.version,this.changed())}):contents=data:isString(data)?(isText=!0,contents=new TextMorph(data,sprite.bubbleFontSize*this.scale,null,sprite.bubbleFontIsBold,!1,"center")):"boolean"==typeof data?(img=sprite.booleanMorph(data).fullImage(),contents=new Morph,contents.silentSetWidth(img.width),contents.silentSetHeight(img.height),contents.image=img):data instanceof Costume?(img=data.thumbnail(new Point(40,40)),contents=new Morph,contents.silentSetWidth(img.width),contents.silentSetHeight(img.height),contents.image=img):data instanceof Sound?contents=new SymbolMorph("notes",30):data instanceof HTMLCanvasElement?(contents=new Morph,contents.silentSetWidth(data.width),
contents.silentSetHeight(data.height),contents.image=data):data instanceof List?(isTable=toggle&&this.contentsMorph?this.contentsMorph instanceof ListWatcherMorph:data.isTable(),isTable?(contents=new TableFrameMorph(new TableMorph(data,10)),this.stage&&contents.expand(this.stage.extent().translateBy(-2*(this.edge+this.border+this.padding)))):(contents=new ListWatcherMorph(data),contents.update(!0),contents.step=contents.update,this.stage&&contents.expand(this.stage.extent().translateBy(-2*(this.edge+this.border+this.padding)))),contents.isDraggable=!1):data instanceof Context?(img=data.image(),contents=new Morph,contents.silentSetWidth(img.width),contents.silentSetHeight(img.height),
contents.image=img):contents=new TextMorph(data.toString(),sprite.bubbleFontSize*this.scale,null,sprite.bubbleFontIsBold,!1,"center"),contents instanceof TextMorph?(width=Math.max(contents.width(),2*sprite.bubbleCorner*this.scale),isText&&(width=Math.min(width,sprite.bubbleMaxTextWidth*this.scale)),contents.setWidth(width)):data instanceof List||(scaledImg=newCanvas(contents.extent().multiplyBy(this.scale)),scaledImg.getContext("2d").drawImage(contents.image,0,0,scaledImg.width,scaledImg.height),contents.image=scaledImg,contents.bounds=contents.bounds.scaleBy(this.scale)),contents},SpriteBubbleMorph.prototype.setScale=function(scale){this.scale=scale,this.changed(),
this.drawNew(),this.changed()},SpriteBubbleMorph.prototype.drawNew=function(toggle){var sprite=SpriteMorph.prototype;this.edge=sprite.bubbleCorner*this.scale,this.border=sprite.bubbleBorder*this.scale,this.padding=sprite.bubbleCorner/2*this.scale,this.contentsMorph&&this.contentsMorph.destroy(),this.contentsMorph=this.dataAsMorph(this.data,toggle),this.add(this.contentsMorph),this.silentSetWidth(this.contentsMorph.width()+(this.padding?2*this.padding:2*this.edge)),this.silentSetHeight(this.contentsMorph.height()+this.edge+2*this.border+2*this.padding+2),SpeechBubbleMorph.uber.drawNew.call(this),this.contentsMorph.setPosition(this.position().add(new Point(this.padding||this.edge,this.border+this.padding+1)));
},SpriteBubbleMorph.prototype.fixLayout=function(){var sprite=SpriteMorph.prototype;this.changed(),this.edge=sprite.bubbleCorner*this.scale,this.border=sprite.bubbleBorder*this.scale,this.padding=sprite.bubbleCorner/2*this.scale,this.silentSetWidth(this.contentsMorph.width()+(this.padding?2*this.padding:2*this.edge)),this.silentSetHeight(this.contentsMorph.height()+this.edge+2*this.border+2*this.padding+2),SpeechBubbleMorph.uber.drawNew.call(this),this.contentsMorph.setPosition(this.position().add(new Point(this.padding||this.edge,this.border+this.padding+1))),this.changed()},Costume.prototype.maxExtent=function(){return StageMorph.prototype.dimensions},Costume.prototype.toString=function(){
return"a Costume("+this.name+")"},Costume.prototype.extent=function(){return new Point(this.contents.width,this.contents.height)},Costume.prototype.center=function(){return this.extent().divideBy(2)},Costume.prototype.width=function(){return this.contents.width},Costume.prototype.height=function(){return this.contents.height},Costume.prototype.bounds=function(){return new Rectangle(0,0,this.width(),this.height())},Costume.prototype.shrinkWrap=function(){var bb=this.boundingBox(),ext=bb.extent(),pic=newCanvas(ext,!0),ctx=pic.getContext("2d");ctx.drawImage(this.contents,bb.origin.x,bb.origin.y,ext.x,ext.y,0,0,ext.x,ext.y),this.rotationCenter=this.rotationCenter.subtract(bb.origin),
this.contents=pic,this.version=Date.now()},Costume.prototype.canvasBoundingBox=function(pic){function getAlpha(x,y){return dta.data[y*w*4+4*x+3]}function getLeft(){for(col=0;col<=w;col+=1)for(row=0;row<=h;row+=1)if(getAlpha(col,row))return col;return 0}function getTop(){for(row=0;row<=h;row+=1)for(col=0;col<=w;col+=1)if(getAlpha(col,row))return row;return 0}function getRight(){for(col=w;col>=0;col-=1)for(row=h;row>=0;row-=1)if(getAlpha(col,row))return Math.min(col+1,w);return w}function getBottom(){for(row=h;row>=0;row-=1)for(col=w;col>=0;col-=1)if(getAlpha(col,row))return Math.min(row+1,h);return h}var row,col,w=pic.width,h=pic.height,ctx=pic.getContext("2d"),dta=ctx.getImageData(0,0,w,h);
return new Rectangle(getLeft(),getTop(),getRight(),getBottom())},Costume.prototype.boundingBox=function(){return this.canvasBoundingBox(this.contents)},Costume.prototype.copy=function(){var cpy,ctx,canvas=newCanvas(this.extent(),!0);return ctx=canvas.getContext("2d"),ctx.drawImage(this.contents,0,0),cpy=new Costume(canvas,this.name?copy(this.name):null),cpy.rotationCenter=this.rotationCenter.copy(),cpy},Costume.prototype.flipped=function(){var flipped,canvas=newCanvas(this.extent(),!0),ctx=canvas.getContext("2d");return ctx.translate(this.width(),0),ctx.scale(-1,1),ctx.drawImage(this.contents,0,0),flipped=new Costume(canvas,this.name,new Point(this.width()-this.rotationCenter.x,this.rotationCenter.y));
},Costume.prototype.edit=function(aWorld,anIDE,isnew,oncancel,onsubmit){var myself=this,editor=new PaintEditorMorph;editor.oncancel=oncancel||nop,editor.openIn(aWorld,isnew?newCanvas(StageMorph.prototype.dimensions,!0):this.contents,isnew?null:this.rotationCenter,function(img,rc){myself.contents=img,myself.rotationCenter=rc,myself.version=Date.now(),aWorld.changed(),anIDE&&(anIDE.currentSprite instanceof SpriteMorph&&myself.shrinkWrap(),anIDE.currentSprite.wearCostume(myself,!0),anIDE.hasChangedMedia=!0),(onsubmit||nop)()})},Costume.prototype.editRotationPointOnly=function(aWorld){var action,dialog,txt,editor=new CostumeEditorMorph(this);action=function(){editor.accept();
},dialog=new DialogBoxMorph(this,action),txt=new TextMorph(localize("click or drag crosshairs to move the rotation center"),dialog.fontSize,dialog.fontStyle,!0,!1,"center",null,null,new Point(1,1),new Color(255,255,255)),dialog.labelString="Costume Editor",dialog.createLabel(),dialog.setPicture(editor),dialog.addBody(txt),dialog.addButton("ok","Ok"),dialog.addButton("cancel","Cancel"),dialog.fixLayout(),dialog.drawNew(),dialog.fixLayout(),dialog.popUp(aWorld)},Costume.prototype.shrinkToFit=function(extentPoint){(extentPoint.x<this.width()||extentPoint.y<this.height())&&(this.contents=this.thumbnail(extentPoint))},Costume.prototype.thumbnail=function(extentPoint){
var src=this.contents,scale=Math.min(extentPoint.x/src.width,extentPoint.y/src.height),xOffset=(extentPoint.x-src.width*scale)/2,yOffset=(extentPoint.y-src.height*scale)/2,trg=newCanvas(extentPoint),ctx=trg.getContext("2d");return src&&src.width+src.height!==0?(ctx.scale(scale,scale),ctx.drawImage(src,Math.floor(xOffset/scale),Math.floor(yOffset/scale)),trg):trg},Costume.prototype.isTainted=function(){try{this.contents.getContext("2d").getImageData(0,0,this.contents.width,this.contents.height)}catch(err){return!0}return!1},SVG_Costume.prototype=new Costume;SVG_Costume.prototype.constructor=SVG_Costume;SVG_Costume.uber=Costume.prototype,SVG_Costume.prototype.toString=function(){
return"an SVG_Costume("+this.name+")"},SVG_Costume.prototype.copy=function(){var cpy,img=new Image;return img.src=this.contents.src,cpy=new SVG_Costume(img,this.name?copy(this.name):null),cpy.rotationCenter=this.rotationCenter.copy(),cpy},SVG_Costume.prototype.shrinkToFit=function(extentPoint){nop(extentPoint)},CostumeEditorMorph.prototype=new Morph,CostumeEditorMorph.prototype.constructor=CostumeEditorMorph,CostumeEditorMorph.uber=Morph.prototype,CostumeEditorMorph.prototype.size=Costume.prototype.maxExtent(),CostumeEditorMorph.prototype.init=function(costume){this.costume=costume||new Costume,this.rotationCenter=this.costume.rotationCenter.copy(),this.margin=new Point(0,0),
CostumeEditorMorph.uber.init.call(this),this.noticesTransparentClick=!0},CostumeEditorMorph.prototype.accept=function(){this.costume.rotationCenter=this.rotationCenter.copy(),this.costume.version=Date.now()},CostumeEditorMorph.prototype.drawNew=function(){var rp,ctx;this.margin=this.size.subtract(this.costume.extent()).divideBy(2),rp=this.rotationCenter.add(this.margin),this.silentSetExtent(this.size),this.image=newCanvas(this.extent()),this.cachedTexture||(this.cachedTexture=this.createTexture()),this.drawCachedTexture(),ctx=this.image.getContext("2d"),ctx.drawImage(this.costume.contents,this.margin.x,this.margin.y),ctx.globalAlpha=.5,ctx.fillStyle="white",ctx.beginPath(),
ctx.arc(rp.x,rp.y,20,radians(0),radians(360),!1),ctx.closePath(),ctx.fill(),ctx.stroke(),ctx.beginPath(),ctx.arc(rp.x,rp.y,10,radians(0),radians(360),!1),ctx.stroke(),ctx.beginPath(),ctx.moveTo(0,rp.y),ctx.lineTo(this.costume.width()+2*this.margin.x,rp.y),ctx.stroke(),ctx.beginPath(),ctx.moveTo(rp.x,0),ctx.lineTo(rp.x,this.costume.height()+2*this.margin.y),ctx.stroke()},CostumeEditorMorph.prototype.createTexture=function(){var size=5,texture=newCanvas(new Point(2*size,2*size)),ctx=texture.getContext("2d"),grey=new Color(230,230,230);return ctx.fillStyle="white",ctx.fillRect(0,0,2*size,2*size),ctx.fillStyle=grey.toString(),ctx.fillRect(0,0,size,size),ctx.fillRect(size,size,size,size),
texture},CostumeEditorMorph.prototype.mouseDownLeft=function(pos){this.rotationCenter=pos.subtract(this.position().add(this.margin)),this.drawNew(),this.changed()},CostumeEditorMorph.prototype.mouseMove=CostumeEditorMorph.prototype.mouseDownLeft,Sound.prototype.play=function(){var aud=document.createElement("audio");return aud.src=this.audio.src,aud.play(),aud},Sound.prototype.copy=function(){var cpy,snd=document.createElement("audio");return snd.src=this.audio.src,cpy=new Sound(snd,this.name?copy(this.name):null)},Sound.prototype.toDataURL=function(){return this.audio.src},Note.prototype.audioContext=null,Note.prototype.gainNode=null,Note.prototype.setupContext=function(){
if(!this.audioContext){var AudioContext=function(){var ctx=window.AudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext||window.webkitAudioContext;return ctx.prototype.createGain||(ctx.prototype.createGain=ctx.prototype.createGainNode),ctx}();if(!AudioContext)throw new Error("Web Audio API is not supported\nin this browser");Note.prototype.audioContext=new AudioContext,Note.prototype.gainNode=Note.prototype.audioContext.createGain(),Note.prototype.gainNode.gain.value=.25}},Note.prototype.play=function(type){this.oscillator=this.audioContext.createOscillator(),this.oscillator.start||(this.oscillator.start=this.oscillator.noteOn),this.oscillator.stop||(this.oscillator.stop=this.oscillator.noteOff),
this.oscillator.type=["sine","square","sawtooth","triangle"][(type||1)-1],this.oscillator.frequency.value=440*Math.pow(2,(this.pitch-69)/12),this.oscillator.connect(this.gainNode),this.gainNode.connect(this.audioContext.destination),this.oscillator.start(0)},Note.prototype.stop=function(){this.oscillator&&(this.oscillator.stop(0),this.oscillator=null)},CellMorph.prototype=new BoxMorph,CellMorph.prototype.constructor=CellMorph,CellMorph.uber=BoxMorph.prototype,CellMorph.prototype.init=function(contents,color,idx,parentCell){this.contents=0===contents?0:contents!==!1&&(contents||""),this.isEditable=!isNil(idx),this.idx=idx||null,this.parentCell=parentCell||null,
CellMorph.uber.init.call(this,SyntaxElementMorph.prototype.corner,1.000001,new Color(255,255,255)),this.color=color||new Color(255,140,0),this.isBig=!1,this.version=null,this.drawNew()},CellMorph.prototype.big=function(){this.isBig=!0,this.changed(),this.drawNew(),this.changed()},CellMorph.prototype.normal=function(){this.isBig=!1,this.changed(),this.drawNew(),this.changed()},CellMorph.prototype.isCircular=function(list){return!!this.parentCell&&(list instanceof List?this.contents===list||this.parentCell.isCircular(list):this.parentCell.isCircular(this.contents))},CellMorph.prototype.fixLayout=function(){var listwatcher;this.changed(),this.drawNew(),this.changed(),
this.parent&&this.parent.fixLayout?this.parent.fixLayout():(listwatcher=this.parentThatIsA(ListWatcherMorph),listwatcher&&listwatcher.fixLayout())},CellMorph.prototype.update=function(){isSnapObject(this.contents)&&this.version!==this.contents.version&&this.drawNew()},CellMorph.prototype.drawNew=function(toggle,type){var context,txt,img,fontSize=SyntaxElementMorph.prototype.fontSize,isSameList=this.contentsMorph instanceof ListWatcherMorph&&this.contentsMorph.list===this.contents,isSameTable=this.contentsMorph instanceof TableFrameMorph&&this.contentsMorph.tableMorph.table===this.contents;return this.isBig&&(fontSize*=1.5),(toggle||this.contentsMorph&&!isSameList&&!isSameTable)&&(this.contentsMorph.destroy(),
this.version=null),(toggle||!isSameList&&!isSameTable)&&(this.contents instanceof Morph?isSnapObject(this.contents)?(img=this.contents.thumbnail(new Point(40,40)),this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(img.width),this.contentsMorph.silentSetHeight(img.height),this.contentsMorph.image=img,this.version=this.contents.version):this.contentsMorph=this.contents:isString(this.contents)?(txt=this.contents.length>500?this.contents.slice(0,500)+"...":this.contents,this.contentsMorph=new TextMorph(txt,fontSize,null,!0,!1,"left"),this.isEditable&&(this.contentsMorph.isEditable=!0,this.contentsMorph.enableSelecting()),this.contentsMorph.setColor(new Color(255,255,255))):"boolean"==typeof this.contents?(img=SpriteMorph.prototype.booleanMorph.call(null,this.contents).fullImage(),
this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(img.width),this.contentsMorph.silentSetHeight(img.height),this.contentsMorph.image=img):this.contents instanceof HTMLCanvasElement?(this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(this.contents.width),this.contentsMorph.silentSetHeight(this.contents.height),this.contentsMorph.image=this.contents):this.contents instanceof Context?(img=this.contents.image(),this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(img.width),this.contentsMorph.silentSetHeight(img.height),this.contentsMorph.image=img):this.contents instanceof Costume?(img=this.contents.thumbnail(new Point(40,40)),
this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(img.width),this.contentsMorph.silentSetHeight(img.height),this.contentsMorph.image=img):this.contents instanceof Sound?this.contentsMorph=new SymbolMorph("notes",30):this.contents instanceof List?("table"===type||!toggle&&this.contents.isTable()?(this.contentsMorph=new TableFrameMorph(new TableMorph(this.contents,10)),this.contentsMorph.expand(new Point(200,150))):this.isCircular()?(this.contentsMorph=new TextMorph("(...)",fontSize,null,!1,!0,"center"),this.contentsMorph.setColor(new Color(255,255,255))):this.contentsMorph=new ListWatcherMorph(this.contents,this),this.contentsMorph.isDraggable=!1):(this.contentsMorph=new TextMorph(isNil(this.contents)?"":this.contents.toString(),fontSize,null,!0,!1,"center"),
this.isEditable&&(this.contentsMorph.isEditable=!0,this.contentsMorph.enableSelecting()),this.contentsMorph.setColor(new Color(255,255,255))),this.add(this.contentsMorph)),this.silentSetHeight(this.contentsMorph.height()+this.edge+2*this.border),this.silentSetWidth(Math.max(this.contentsMorph.width()+2*this.edge,this.contents instanceof Context||this.contents instanceof List?0:3.5*SyntaxElementMorph.prototype.fontSize)),this.image=newCanvas(this.extent()),context=this.image.getContext("2d"),0===this.edge&&0===this.border?(BoxMorph.uber.drawNew.call(this),null):(context.fillStyle=this.color.toString(),context.beginPath(),this.outlinePath(context,Math.max(this.edge-this.border,0),this.border),
context.closePath(),context.fill(),this.border>0&&!MorphicPreferences.isFlat&&(context.lineWidth=this.border,context.strokeStyle=this.borderColor.toString(),context.beginPath(),this.outlinePath(context,this.edge,this.border/2),context.closePath(),context.stroke(),context.shadowOffsetX=this.border,context.shadowOffsetY=this.border,context.shadowBlur=this.border,context.shadowColor=this.color.darker(80).toString(),this.drawShadow(context,this.edge,this.border/2)),void((toggle||!isSameList&&!isSameTable)&&this.contentsMorph.setCenter(this.center())))},CellMorph.prototype.drawShadow=function(context,radius,inset){var offset=radius+inset,w=this.width(),h=this.height();
context.beginPath(),context.moveTo(0,h-offset),context.lineTo(0,offset),context.stroke(),context.beginPath(),context.arc(offset,offset,radius,radians(-180),radians(-90),!1),context.stroke(),context.beginPath(),context.moveTo(offset,0),context.lineTo(w-offset,0),context.stroke()},CellMorph.prototype.layoutChanged=function(){var context,fontSize=SyntaxElementMorph.prototype.fontSize,listWatcher=this.parentThatIsA(ListWatcherMorph);return this.isBig&&(fontSize*=1.5),this.silentSetHeight(this.contentsMorph.height()+this.edge+2*this.border),this.silentSetWidth(Math.max(this.contentsMorph.width()+2*this.edge,this.contents instanceof Context||this.contents instanceof List?0:2*this.height())),
this.image=newCanvas(this.extent()),context=this.image.getContext("2d"),0===this.edge&&0===this.border?(BoxMorph.uber.drawNew.call(this),null):(context.fillStyle=this.color.toString(),context.beginPath(),this.outlinePath(context,Math.max(this.edge-this.border,0),this.border),context.closePath(),context.fill(),this.border>0&&!MorphicPreferences.isFlat&&(context.lineWidth=this.border,context.strokeStyle=this.borderColor.toString(),context.beginPath(),this.outlinePath(context,this.edge,this.border/2),context.closePath(),context.stroke(),context.shadowOffsetX=this.border,context.shadowOffsetY=this.border,context.shadowBlur=this.border,context.shadowColor=this.color.darker(80).toString(),
this.drawShadow(context,this.edge,this.border/2)),this.contentsMorph.setCenter(this.center()),void(listWatcher&&listWatcher.fixLayout()))},CellMorph.prototype.reactToEdit=function(textMorph){var listWatcher;isNil(this.idx)||(listWatcher=this.parentThatIsA(ListWatcherMorph),listWatcher&&listWatcher.list.put(textMorph.text,this.idx))},CellMorph.prototype.mouseClickLeft=function(pos){this.isEditable&&this.contentsMorph instanceof TextMorph?this.contentsMorph.selectAllAndEdit():this.escalateEvent("mouseClickLeft",pos)},CellMorph.prototype.mouseDoubleClick=function(pos){List.prototype.enableTables&&this.currentValue instanceof List?new TableDialogMorph(this.contents).popUp(this.world()):this.escalateEvent("mouseDoubleClick",pos);
},WatcherMorph.prototype=new BoxMorph,WatcherMorph.prototype.constructor=WatcherMorph,WatcherMorph.uber=BoxMorph.prototype,WatcherMorph.prototype.init=function(label,color,target,getter,isHidden){this.labelText=label||"",this.version=null,this.objName="",WatcherMorph.uber.init.call(this,SyntaxElementMorph.prototype.rounding,1.000001,new Color(120,120,120)),this.color=new Color(220,220,220),this.readoutColor=color,this.style="normal",this.target=target||null,this.getter=getter||null,this.currentValue=null,this.labelMorph=null,this.sliderMorph=null,this.cellMorph=null,this.isDraggable=!0,this.fixLayout(),this.update(),isHidden&&this.hide()},WatcherMorph.prototype.isTemporary=function(){
var stage=this.parentThatIsA(StageMorph);return this.target instanceof VariableFrame&&((!stage||this.target!==stage.variables.parentFrame)&&null===this.target.owner)},WatcherMorph.prototype.object=function(){return this.target instanceof VariableFrame?this.target.owner:this.target},WatcherMorph.prototype.isGlobal=function(selector){return contains(["getLastAnswer","getLastMessage","getTempo","getTimer","reportMouseX","reportMouseY","reportThreadCount"],selector)},WatcherMorph.prototype.setSliderMin=function(num,noUpdate){this.target instanceof VariableFrame&&(this.sliderMorph.setSize(1,noUpdate),this.sliderMorph.setStart(num,noUpdate),this.sliderMorph.setSize(this.sliderMorph.rangeSize()/5,noUpdate));
},WatcherMorph.prototype.setSliderMax=function(num,noUpdate){this.target instanceof VariableFrame&&(this.sliderMorph.setSize(1,noUpdate),this.sliderMorph.setStop(num,noUpdate),this.sliderMorph.setSize(this.sliderMorph.rangeSize()/5,noUpdate))},WatcherMorph.prototype.update=function(){var newValue,sprite,num,att,isGhosted=!1;if(this.target&&this.getter){if(this.updateLabel(),this.target instanceof VariableFrame)if(newValue=this.target.vars[this.getter]?this.target.vars[this.getter].value:void 0,void 0===newValue&&this.target.owner){if(sprite=this.target.owner,!contains(sprite.inheritedVariableNames(),this.getter))return void this.destroy();newValue=this.target.getVar(this.getter),
this.cellMorph.setColor(SpriteMorph.prototype.blockColor.variables.lighter(35))}else this.cellMorph.setColor(SpriteMorph.prototype.blockColor.variables);else newValue=this.target[this.getter](),att={xPosition:"x position",yPosition:"y position",direction:"direction",getCostumeIdx:"costume #",getScale:"size"}[this.getter],isGhosted=!!att&&this.target.inheritsAttribute(att);""===newValue||isNil(newValue)||(num=+newValue,"boolean"==typeof newValue||isNaN(num)||(newValue=Math.round(1e9*newValue)/1e9)),newValue!==this.currentValue&&(this.changed(),this.cellMorph.contents=newValue,isSnapObject(this.target)&&(isGhosted?this.cellMorph.setColor(this.readoutColor.lighter(35)):this.cellMorph.setColor(this.readoutColor)),
this.cellMorph.drawNew(),isNaN(newValue)||(this.sliderMorph.value=newValue,this.sliderMorph.drawNew()),this.fixLayout(),this.currentValue=newValue)}this.cellMorph.contentsMorph instanceof ListWatcherMorph?this.cellMorph.contentsMorph.update():isSnapObject(this.cellMorph.contents)&&this.cellMorph.update()},WatcherMorph.prototype.updateLabel=function(){var obj=this.object();obj&&!this.isGlobal(this.getter)&&obj.version!==this.version&&(this.objName=obj.name?obj.name+" ":" ",this.labelMorph&&(this.labelMorph.destroy(),this.labelMorph=null,this.fixLayout()))},WatcherMorph.prototype.fixLayout=function(){var isList,fontSize=SyntaxElementMorph.prototype.fontSize,myself=this;
return this.changed(),null===this.labelMorph&&(this.labelMorph=new StringMorph(this.objName+this.labelText,fontSize,null,!0,!1,!1,MorphicPreferences.isFlat?new Point:new Point(1,1),new Color(255,255,255)),this.add(this.labelMorph)),null===this.cellMorph&&(this.cellMorph=new CellMorph("",this.readoutColor),this.add(this.cellMorph)),null===this.sliderMorph&&(this.sliderMorph=new SliderMorph(0,100,0,20,"horizontal"),this.sliderMorph.alpha=1,this.sliderMorph.button.color=this.color.darker(),this.sliderMorph.color=this.color.lighter(60),this.sliderMorph.button.highlightColor=this.color.darker(),this.sliderMorph.button.highlightColor.b+=50,this.sliderMorph.button.pressColor=this.color.darker(),
this.sliderMorph.button.pressColor.b+=100,this.sliderMorph.setHeight(fontSize),this.sliderMorph.action=function(num){myself.target.setVar(myself.getter,Math.round(num),myself.target.owner)},this.add(this.sliderMorph)),isList=this.cellMorph.contents instanceof List,isList&&(this.style="normal"),"large"===this.style?(this.labelMorph.hide(),this.sliderMorph.hide(),this.cellMorph.big(),this.cellMorph.setPosition(this.position()),void this.setExtent(this.cellMorph.extent().subtract(1))):(this.labelMorph.show(),this.sliderMorph.show(),this.cellMorph.normal(),this.labelMorph.setPosition(this.position().add(new Point(this.edge,this.border+SyntaxElementMorph.prototype.typeInPadding))),
isList?this.cellMorph.setPosition(this.labelMorph.bottomLeft().add(new Point(0,SyntaxElementMorph.prototype.typeInPadding))):(this.cellMorph.setPosition(this.labelMorph.topRight().add(new Point(fontSize/3,0))),this.labelMorph.setTop(this.cellMorph.top()+(this.cellMorph.height()-this.labelMorph.height())/2)),"slider"===this.style?(this.sliderMorph.silentSetPosition(new Point(this.labelMorph.left(),this.cellMorph.bottom()+SyntaxElementMorph.prototype.typeInPadding)),this.sliderMorph.setWidth(this.cellMorph.right()-this.labelMorph.left()),this.silentSetHeight(this.cellMorph.height()+this.sliderMorph.height()+2*this.border+3*SyntaxElementMorph.prototype.typeInPadding)):(this.sliderMorph.hide(),
this.bounds.corner.y=this.cellMorph.bottom()+this.border+SyntaxElementMorph.prototype.typeInPadding),this.bounds.corner.x=Math.max(this.cellMorph.right(),this.labelMorph.right())+this.edge+SyntaxElementMorph.prototype.typeInPadding,this.drawNew(),void this.changed())},WatcherMorph.prototype.mouseDoubleClick=function(pos){List.prototype.enableTables&&this.currentValue instanceof List?new TableDialogMorph(this.currentValue).popUp(this.world()):this.escalateEvent("mouseDoubleClick",pos)},WatcherMorph.prototype.rootForGrab=function(){var ide=this.parentThatIsA(IDE_Morph);return ide&&ide.isAppMode?ide:this},WatcherMorph.prototype.userMenu=function(){function monitor(vName){
var stage=myself.parentThatIsA(StageMorph),varFrame=myself.currentValue.outerContext.variables;menu.addItem(vName+"...",function(){var others,watcher=detect(stage.children,function(morph){return morph instanceof WatcherMorph&&morph.target===varFrame&&morph.getter===vName});return null!==watcher?(watcher.show(),void watcher.fixLayout()):(watcher=new WatcherMorph(vName+" "+localize("(temporary)"),SpriteMorph.prototype.blockColor.variables,varFrame,vName),watcher.setPosition(stage.position().add(10)),others=stage.watchers(watcher.left()),others.length>0&&watcher.setTop(others[others.length-1].bottom()),stage.add(watcher),void watcher.fixLayout())})}var vNames,myself=this,ide=this.parentThatIsA(IDE_Morph),menu=new MenuMorph(this),on="●",off="○";
if(!ide||!ide.isAppMode)return menu.addItem(("normal"===this.style?on:off)+" "+localize("normal"),"styleNormal"),menu.addItem(("large"===this.style?on:off)+" "+localize("large"),"styleLarge"),this.target instanceof VariableFrame&&(menu.addItem(("slider"===this.style?on:off)+" "+localize("slider"),"styleSlider"),menu.addLine(),menu.addItem("slider min...","userSetSliderMin"),menu.addItem("slider max...","userSetSliderMax"),menu.addLine(),menu.addItem("import...",function(){var inp=document.createElement("input"),ide=myself.parentThatIsA(IDE_Morph);ide.filePicker&&(document.body.removeChild(ide.filePicker),ide.filePicker=null),inp.type="file",inp.style.color="transparent",
inp.style.backgroundColor="transparent",inp.style.border="none",inp.style.outline="none",inp.style.position="absolute",inp.style.top="0px",inp.style.left="0px",inp.style.width="0px",inp.style.height="0px",inp.style.display="none",inp.addEventListener("change",function(){function txtOnlyMsg(ftype){ide.inform("Unable to import",'Snap! can only import "text" files.\nYou selected a file of type "'+ftype+'".')}function readText(aFile){var frd=new FileReader;frd.onloadend=function(e){myself.target.setVar(myself.getter,e.target.result)},0===aFile.type.indexOf("text")?frd.readAsText(aFile):txtOnlyMsg(aFile.type)}var file;document.body.removeChild(inp),ide.filePicker=null,
inp.files.length>0&&(file=inp.files[inp.files.length-1],readText(file))},!1),document.body.appendChild(inp),ide.filePicker=inp,inp.click()}),isString(this.currentValue)||!isNaN(+this.currentValue)?menu.addItem("export...",function(){var ide=myself.parentThatIsA(IDE_Morph);ide.saveFileAs(myself.currentValue.toString(),"text/plain;charset=utf-8",myself.getter)}):this.currentValue instanceof Context&&(vNames=this.currentValue.outerContext.variables.names(),vNames.length&&(menu.addLine(),vNames.forEach(function(vName){monitor(vName)})))),menu},WatcherMorph.prototype.setStyle=function(style){this.style=style,this.fixLayout()},WatcherMorph.prototype.styleNormal=function(){
this.setStyle("normal")},WatcherMorph.prototype.styleLarge=function(){this.setStyle("large")},WatcherMorph.prototype.styleSlider=function(){this.setStyle("slider")},WatcherMorph.prototype.userSetSliderMin=function(){new DialogBoxMorph(this,this.setSliderMin,this).prompt("Slider minimum value",this.sliderMorph.start.toString(),this.world(),null,null,null,!0)},WatcherMorph.prototype.userSetSliderMax=function(){new DialogBoxMorph(this,this.setSliderMax,this).prompt("Slider maximum value",this.sliderMorph.stop.toString(),this.world(),null,null,null,!0)},WatcherMorph.prototype.drawNew=function(){var context,gradient;return this.image=newCanvas(this.extent()),context=this.image.getContext("2d"),
MorphicPreferences.isFlat||0===this.edge&&0===this.border?void BoxMorph.uber.drawNew.call(this):(gradient=context.createLinearGradient(0,0,0,this.height()),gradient.addColorStop(0,this.color.lighter().toString()),gradient.addColorStop(1,this.color.darker().toString()),context.fillStyle=gradient,context.beginPath(),this.outlinePath(context,Math.max(this.edge-this.border,0),this.border),context.closePath(),context.fill(),void(this.border>0&&(gradient=context.createLinearGradient(0,0,0,this.height()),gradient.addColorStop(0,this.borderColor.lighter().toString()),gradient.addColorStop(1,this.borderColor.darker().toString()),context.lineWidth=this.border,context.strokeStyle=gradient,
context.beginPath(),this.outlinePath(context,this.edge,this.border/2),context.closePath(),context.stroke())))},StagePrompterMorph.prototype=new BoxMorph,StagePrompterMorph.prototype.constructor=StagePrompterMorph,StagePrompterMorph.uber=BoxMorph.prototype,StagePrompterMorph.prototype.init=function(question){var myself=this;this.isDone=!1,question?this.label=new StringMorph(question,SpriteMorph.prototype.bubbleFontSize,null,SpriteMorph.prototype.bubbleFontIsBold,!1,"left"):this.label=null,this.inputField=new InputFieldMorph,this.button=new PushButtonMorph(null,function(){myself.accept()},"✓"),StagePrompterMorph.uber.init.call(this,SyntaxElementMorph.prototype.rounding,SpriteMorph.prototype.bubbleBorder,SpriteMorph.prototype.blockColor.sensing),
this.color=new Color(255,255,255),this.label&&this.add(this.label),this.add(this.inputField),this.add(this.button),this.setWidth(StageMorph.prototype.dimensions.x-20),this.fixLayout()},StagePrompterMorph.prototype.fixLayout=function(){var y=0;this.label&&(this.label.setPosition(new Point(this.left()+this.edge,this.top()+this.edge)),y=this.label.bottom()-this.top()),this.inputField.setPosition(new Point(this.left()+this.edge,this.top()+y+this.edge)),this.inputField.setWidth(this.width()-2*this.edge-this.button.width()-this.border),this.button.setCenter(this.inputField.center()),this.button.setLeft(this.inputField.right()+this.border),this.setHeight(this.inputField.bottom()-this.top()+this.edge);
},StagePrompterMorph.prototype.mouseClickLeft=function(){this.inputField.edit()},StagePrompterMorph.prototype.accept=function(){this.isDone=!0},modules.gui="2017-December-01";var IDE_Morph,ProjectDialogMorph,LibraryImportDialogMorph,SpriteIconMorph,CostumeIconMorph,TurtleIconMorph,WardrobeMorph,SoundIconMorph,JukeboxMorph,StageHandleMorph,PaletteHandleMorph,CamSnapshotDialogMorph;IDE_Morph.prototype=new Morph,IDE_Morph.prototype.constructor=IDE_Morph,IDE_Morph.uber=Morph.prototype,IDE_Morph.prototype.setDefaultDesign=function(){MorphicPreferences.isFlat=!1,SpriteMorph.prototype.paletteColor=new Color(55,55,55),SpriteMorph.prototype.paletteTextColor=new Color(230,230,230),
StageMorph.prototype.paletteTextColor=SpriteMorph.prototype.paletteTextColor,StageMorph.prototype.paletteColor=SpriteMorph.prototype.paletteColor,SpriteMorph.prototype.sliderColor=SpriteMorph.prototype.paletteColor.lighter(30),IDE_Morph.prototype.buttonContrast=30,IDE_Morph.prototype.backgroundColor=new Color(40,40,40),IDE_Morph.prototype.frameColor=SpriteMorph.prototype.paletteColor,IDE_Morph.prototype.groupColor=SpriteMorph.prototype.paletteColor.lighter(8),IDE_Morph.prototype.sliderColor=SpriteMorph.prototype.sliderColor,IDE_Morph.prototype.buttonLabelColor=new Color(255,255,255),IDE_Morph.prototype.tabColors=[IDE_Morph.prototype.groupColor.darker(40),IDE_Morph.prototype.groupColor.darker(60),IDE_Morph.prototype.groupColor],
IDE_Morph.prototype.rotationStyleColors=IDE_Morph.prototype.tabColors,IDE_Morph.prototype.appModeColor=new Color,IDE_Morph.prototype.scriptsPaneTexture=this.scriptsTexture(),IDE_Morph.prototype.padding=5,SpriteIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor,CostumeIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor,SoundIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor,TurtleIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor},IDE_Morph.prototype.setFlatDesign=function(){MorphicPreferences.isFlat=!0,SpriteMorph.prototype.paletteColor=new Color(255,255,255),SpriteMorph.prototype.paletteTextColor=new Color(70,70,70),
StageMorph.prototype.paletteTextColor=SpriteMorph.prototype.paletteTextColor,StageMorph.prototype.paletteColor=SpriteMorph.prototype.paletteColor,SpriteMorph.prototype.sliderColor=SpriteMorph.prototype.paletteColor,IDE_Morph.prototype.buttonContrast=30,IDE_Morph.prototype.backgroundColor=new Color(200,200,200),IDE_Morph.prototype.frameColor=new Color(255,255,255),IDE_Morph.prototype.groupColor=new Color(230,230,230),IDE_Morph.prototype.sliderColor=SpriteMorph.prototype.sliderColor,IDE_Morph.prototype.buttonLabelColor=new Color(70,70,70),IDE_Morph.prototype.tabColors=[IDE_Morph.prototype.groupColor.lighter(60),IDE_Morph.prototype.groupColor.darker(10),IDE_Morph.prototype.groupColor],
IDE_Morph.prototype.rotationStyleColors=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.groupColor.darker(10),IDE_Morph.prototype.groupColor.darker(30)],IDE_Morph.prototype.appModeColor=IDE_Morph.prototype.frameColor,IDE_Morph.prototype.scriptsPaneTexture=null,IDE_Morph.prototype.padding=1,SpriteIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor,CostumeIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor,SoundIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor,TurtleIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor},IDE_Morph.prototype.scriptsTexture=function(){var i,pic=newCanvas(new Point(100,100)),ctx=pic.getContext("2d");
for(i=0;i<100;i+=4)ctx.fillStyle=this.frameColor.toString(),ctx.fillRect(i,0,1,100),ctx.fillStyle=this.groupColor.lighter(6).toString(),ctx.fillRect(i+1,0,1,100),ctx.fillRect(i+3,0,1,100),ctx.fillStyle=this.groupColor.toString(),ctx.fillRect(i+2,0,1,100);return pic},IDE_Morph.prototype.setDefaultDesign(),IDE_Morph.prototype.init=function(isAutoFill){MorphicPreferences.globalFontFamily="Helvetica, Arial",this.userLanguage=null,this.projectsInURLs=!1,this.applySavedSettings(),this.cloudMsg=null,this.source="local",this.serializer=new SnapSerializer,this.globalVariables=new VariableFrame,this.currentSprite=new SpriteMorph(this.globalVariables),this.sprites=new List([this.currentSprite]),
this.currentCategory="motion",this.currentTab="scripts",this.projectName="Education nationale",this.projectNotes="",this.logoURL="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAYCAYAAACBbx+6AAAEJGlDQ1BJQ0MgUHJvZmlsZQAAOBGFVd9v21QUPolvUqQWPyBYR4eKxa9VU1u5GxqtxgZJk6XtShal6dgqJOQ6N4mpGwfb6baqT3uBNwb8AUDZAw9IPCENBmJ72fbAtElThyqqSUh76MQPISbtBVXhu3ZiJ1PEXPX6yznfOec7517bRD1fabWaGVWIlquunc8klZOnFpSeTYrSs9RLA9Sr6U4tkcvNEi7BFffO6+EdigjL7ZHu/k72I796i9zRiSJPwG4VHX0Z+AxRzNRrtksUvwf7+Gm3BtzzHPDTNgQCqwKXfZwSeNHHJz1OIT8JjtAq6xWtCLwGPLzYZi+3YV8DGMiT4VVuG7oiZpGzrZJhcs/hL49xtzH/Dy6bdfTsXYNY+5yluWO4D4neK/ZUvok/17X0HPBLsF+vuUlhfwX4j/rSfAJ4H1H0qZJ9dN7nR19frRTeBt4Fe9FwpwtN+2p1MXscGLHR9SXrmMgjONd1ZxKzpBeA71b4tNhj6JGoyFNp4GHgwUp9qplfmnFW5oTdy7NamcwCI49kv6fN5IAHgD+0rbyoBc3SOjczohbyS1drbq6pQdqumllRC/0ymTtej8gpbbuVwpQfyw66dqEZyxZKxtHpJn+tZnpnEdrYBbueF9qQn93S7HQGGHnYP7w6L+YGHNtd1FJitqPAR+hERCNOFi1i1alKO6RQnjKUxL1GNjwlMsiEhcPLYTEiT9ISbN15OY/jx4SMshe9LaJRpTvHr3C/ybFYP1PZAfwfYrPsMBtnE6SwN9ib7AhLwTrBDgUKcm06FSrTfSj187xPdVQWOk5Q8vxAfSiIUc7Z7xr6zY/+hpqwSyv0I0/QMTRb7RMgBxNodTfSPqdraz/sDjzKBrv4zu2+a2t0/HHzjd2Lbcc2sG7GtsL42K+xLfxtUgI7YHqKlqHK8HbCCXgjHT1cAdMlDetv4FnQ2lLasaOl6vmB0CMmwT/IPszSueHQqv6i/qluqF+oF9TfO2qEGTumJH0qfSv9KH0nfS/9TIp0Wboi/SRdlb6RLgU5u++9nyXYe69fYRPdil1o1WufNSdTTsp75BfllPy8/LI8G7AUuV8ek6fkvfDsCfbNDP0dvRh0CrNqTbV7LfEEGDQPJQadBtfGVMWEq3QWWdufk6ZSNsjG2PQjp3ZcnOWWing6noonSInvi0/Ex+IzAreevPhe+CawpgP1/pMTMDo64G0sTCXIM+KdOnFWRfQKdJvQzV1+Bt8OokmrdtY2yhVX2a+qrykJfMq4Ml3VR4cVzTQVz+UoNne4vcKLoyS+gyKO6EHe+75Fdt0Mbe5bRIf/wjvrVmhbqBN97RD1vxrahvBOfOYzoosH9bq94uejSOQGkVM6sN/7HelL4t10t9F4gPdVzydEOx83Gv+uNxo7XyL/FtFl8z9ZAHF4bBsrEwAAAAlwSFlzAAALEgAACxIB0t1+/AAAAwBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDUuMS4yIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpZUmVzb2x1dGlvbj4zNTk5LzUwPC90aWZmOllSZXNvbHV0aW9uPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICAgICA8dGlmZjpYUmVzb2x1dGlvbj4zNTk5LzUwPC90aWZmOlhSZXNvbHV0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIj4KICAgICAgICAgPHhtcDpDcmVhdGVEYXRlPjIwMTMtMDItMTRUMDA6Mjk6NTE8L3htcDpDcmVhdGVEYXRlPgogICAgICAgICA8eG1wOkNyZWF0b3JUb29sPkFkb2JlIEZpcmV3b3JrcyBDUzYgKE1hY2ludG9zaCk8L3htcDpDcmVhdG9yVG9vbD4KICAgICAgICAgPHhtcDpNb2RpZnlEYXRlPjIwMTMtMDItMTRUMDA6MzM6MjE8L3htcDpNb2RpZnlEYXRlPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KLdsGnQAACsBJREFUWAmdV2lwVUUWPt333rdkJYGXEFmMEIIChZJkkCVoMsgoS9XIJC9Y4wyLjCCWOhQzf2Z9iU6V5TJa45QOoiQgKENeWATcdfIYQtiSuADB0ZCENSSEJJCXvO3e7vn6PYK4QtlVd+s+fc7Xp79zTl8mpaRrtjLGyUMQjAkfXz00zbDTRCmtieicwTi7XWOUwRiRZVGTJPYmMfmfUNg4mL3sTKfS7ytjegGRII8U17T3AwLsWoC9Xqa53dJSOk6vSxtjEj3AJBUbOmXpQNkfEhFirBtY+7EehveUeDtLUkvrD8vPhWDlhrStHb70VFcUh4/pVCCh5se1y4DhGy/xqAo3PMlwqZUALF0G21KevpBz+VRaMh/a0SPhNbYTcjUaWc2WxS5GuBWycRuTlkgC+DGSiVlAf29qEk/ovCSOcUaekYs7vFEbSq9ql3VH36/zBmcpeN/Bi6vAtpa7VqYm8ue7/ErU8UQonFF+80P7Wq9lo/kVV7ams4WQ+22CkyX4A7SJdPanG399riU6FzbUCtxuUAWaf0gfKyPuPuplUQ83ljFbwsj04cSZk/oDZ0eu6OmmKG+laF7rmuuwsV3hiHaMmGNJ5pKWA99SDMP13bk8N7te+nYTFXyDq6c3pmVZEbkKvlmBuRdAnCeIzr+cuVgGv6XrOzqw/8CpYggalHNb17lWou/JWJdsFsSfvGlJ+8b2DUPjQ6ZVLsjQ4xPaFrnc0s/y2uLcY4/fEpDc1hfU+0PkaKvdNvH8gMLL9pivrEwruNMH9NVX+HriteFTpWX9Bd6cDcuHwZ81klm7MsOjz1BbvaUCUoFTOr6hjwpLDg01SXEOIyfXpy+UJGaRZE6bzooipjxl13hewGq/JOSo/FGR5t20TEZmuQ8sCZO2MiJYPHRGcGVA/Z5wmJbU7cjtzFteb9TfkBsNUCrF8kuJVVMZYsNHBZ6rgK8dPVdwczkncxIAd5Ow7Q1HhqzOXt7waUmJVxs/vlGWIi0V+Hy8urrALFzic4R6k14H2Nxvcbi1In0FiPKiILHopsWdG9RqVbvnvgM/90f0f8IFOzQmqiySGhf8JgCOGIm9m6srCq5re2PaYveO9Wx0v4jPGpbQ126Mp0YaJ8NXjw+8T/9F3QTQdS8RT9K/CjhsBj5My9xpaNoqzthtmADAsf7eiD4P7+21VTmPDCgaeBYWkj6tpCGLh+LbjdS2SNCfMIVZzEVcNtVW5X2s5Cbfe2iETeNZ8Zo5OCJIVve4DssP5RcYOg4L6TS20z5jfP1g0PEnyO9xjBuHa6puParmco2GCEk2kuJ1XXUAE2t6IcuW9SiFHMlxF8y+UBuodGN07HL0gvFt8Pyv8osaFtRsydkcG4vdgykNY7iQb0i973ioN9HPJeXC86kk+eDpRQ1/Zzb2oqGxZ6Djjl7L6OFMpswY1DXkpwu6PBozt+UX6a9izGYROwNQo4EnGa4bNK2o/pnaLblPCKEJCcLDox/Gci+IfLqrKcq9cHefCzzJBgNTrwalMbkO38e4Effv6cX12/OL6+bMmdNkVzLSYeuC/GC8zsTcg1zqRbBwF77fw+gfZMSaivr2HBzr5ia7SwrjVkvyDSGLrwyYxmTUGy4lzxLE1pI0ZlrMnAnQH+l6/OPKDnagH/w9gzp6NApYVbMCT6z6cMNYmp7C02HM3rYpaQietGbNcmNPVV6zya0iy+wvB7i5TIt7q8d5aVd+Sd3Y/W9MaMcmdSPy39m7JfelPVtv/WLf1pxjJLgH0wNMaoNqt+Ud3Lclb2/Nm5PO7t06sQOxXgk9ffBVOipVB+Te2leVs1ON7a+6/UvJHUsts68TFFkKoGmgQa0pZbMOQ0xWKlhEp9an3QG3LzjXLQ+hNzkQsGeiuzOX6hWTscjJLfheOqX4wD/IDPxG0xyPChFUoOfBS50QcWD8SpMGaqDF/OByNCCnF3+8CgzLQZrWoDAbIOJAhQugTxB2k1lZGZcej1CZorbS3YWd3A/5LMG1EORfmTNhcjcHWB4rkYwLQY9DQQfc/jRSXDrj/BZlXRWE0lJi00r2OQsLfTo88Bk8+ZglgvPhpWHS4g8oOfAMsQrzlxsXFigjw0II17SihtXg50rk/5OSeCVq5rsYC8AxIfUEsLiC1kU2NbWRxmvqCc/jtMJkrXfSR7Xe22pVn04lKItAeXLdkKVxDnZnX1D8kmtyn2lxg5OcApkNVCgtDyx5aGpATRpotVW52xFUB6FzBNBq0PO11CalDeAtFHQ2B8sYJwW/v3brpN1q/p33HqozdTYH3BUAj4uHqysyo/OPVI4Lz5hXk8LszjxUxbdVWuOkaXr3xaPRtHb6tSHDMLG0PyiPZS45v6nRy2zx/iFn0TfzvJcluKT0z7+/JvdsIC7ZsNjnQSnCNkfYzizbfdjW8TDnBehlQBf+WoWSIhH7p/ingtLOSdxSOP+TT03G0oSuPYy+bAS/nRi34I/sKcUNE/dX5Xx2R1F9hnA4X8K8AAl5BHTYLZg4Q660adG0ZgltVWIc3XCxX3jU6se5ZfhEuasmOd540O+nueja3G9qRTYuHxZcttgltlDYHFCUhqB5RVhmlabrCvw5NX+gMXAV3AZH5WZQJQfyz4SliSBi7ZBRJbsZYJ2SMXBYjtCleCq/uP4SvkdhzMUFLQf/TWQcA4s74POO79PVGRcfD/X20xGkH3V4ijYY2CHJelBQ6p9bXmW+9yvlsz8rOdCEyYMxBl3SH5baof9W5h1UE6YV1z2GatQbmx27pyWKhkjEXJRl7ziGntcaA0M/ECgoNoOOpmo9R3plXErY1EI9prMAGPbZtMi/NNKGSU67E/Sgb/vGGY3Pr/I6d57MnBrkGc1wDg4+Fa7KyI6hEkfIv6nvupfJUM+WikwH+rbItzNkS0Xae3IPpaj+671KS0uRW69PPr/o0AfTiureupY8whCnfyEPnL1gHUfobVF+2dWGEznyshtHvxOvDv39ifaIPcnJ57Z+MfyI9b8xW3Ewb+FkQTyh6ctTbt9sj+eSOoqWUTX3+YiqqwtRsAgHLylaym8ea0p+j8b6nCR1BL3OkDFQa6HBStQTHfXhnsjsw92Rpx1JupV47OW7F6Q43x95MZhjM7Q+k2u9xAQzLwQnvJnz8LtNav3IrUgRAw05OerC6FN1Stm2ZlhcWDfvZswqQDoaAf4hQNgECAY4v+gesSh4vOmdMfasg03q9Eb1GaTlLlP8lPLEetfv4JA/gpN7kXEEsoQOziLww8KkJN2pn6DuUOF7s7avzsm0h+TGeQub7Pon+cHwKMRkV0RKwwaMYV0L/HX4Qv9nsA0PX90G0KsnQJeVMu7xyH6IbFOXOuiP88hw67q028C5DdJKykX/8azZX4ZodkwROq78ZMI7BQC7KXNxxyNq4d1mhKfomqAbnGTvTmYC2bfDdqPIsPemRNRxgQ3qQV543u9MYK5AUHKnBRlN1iR0htxR9QhhHDy5dxyx7/1NAT2QyaU6XMcgxe4nKtKfQ/RPxg6/gB32Y4HOKFM4fMjIj6CcgVnFGvGS4YvPHb567o96v7z7X6fE92mCsBcV0dVIbPjkLE15tNubmnzRr1fYDZofjsQogC0DXHWqYjbskSoYK0biz6V+DTPUVkSPVN+w4T3vliWNlfAbeD8OlHR9VSmviBbAFaCY+v4/AzCl6siiSKoAAAAASUVORK5CYII=",
this.logo=null,this.controlBar=null,this.categories=null,this.palette=null,this.paletteHandle=null,this.spriteBar=null,this.spriteEditor=null,this.stage=null,this.stageHandle=null,this.corralBar=null,this.corral=null,this.isAutoFill=void 0===isAutoFill||isAutoFill,this.isAppMode=!1,this.isSmallStage=!1,this.filePicker=null,this.hasChangedMedia=!1,this.isAnimating=!0,this.paletteWidth=200,this.stageRatio=1,this.wasSingleStepping=!1,this.loadNewProject=!1,this.shield=null,this.savingPreferences=!0,IDE_Morph.uber.init.call(this),this.color=this.backgroundColor},IDE_Morph.prototype.openIn=function(world){function getURL(url){try{var request=new XMLHttpRequest;if(request.open("GET",url,!1),
request.send(),200===request.status)return request.responseText;throw new Error("unable to retrieve "+url)}catch(err){return myself.showMessage("unable to retrieve project"),""}}function applyFlags(dict){dict.editMode?myself.toggleAppMode(!1):myself.toggleAppMode(!0),dict.noRun||myself.runScripts(),dict.hideControls&&(myself.controlBar.hide(),window.onbeforeunload=nop),dict.noExitWarning&&(window.onbeforeunload=nop)}function interpretUrlAnchors(){var dict,idx;"#open:"===location.hash.substr(0,6)?(hash=location.hash.substr(6),("%"===hash.charAt(0)||hash.search(/\%(?:[0-9a-f]{2})/i)>-1)&&(hash=decodeURIComponent(hash)),contains(["project","blocks","sprites","snapdata"].map(function(each){
return hash.substr(0,8).indexOf(each)}),1)?this.droppedText(hash):this.droppedText(getURL(hash))):"#run:"===location.hash.substr(0,5)?(hash=location.hash.substr(5),idx=hash.indexOf("&"),idx>0&&(hash=hash.slice(0,idx)),("%"===hash.charAt(0)||hash.search(/\%(?:[0-9a-f]{2})/i)>-1)&&(hash=decodeURIComponent(hash)),"<project>"===hash.substr(0,8)?this.rawOpenProjectString(hash):this.rawOpenProjectString(getURL(hash)),applyFlags(SnapCloud.parseDict(location.hash.substr(5)))):"#present:"===location.hash.substr(0,9)?(this.shield=new Morph,this.shield.color=this.color,this.shield.setExtent(this.parent.extent()),this.parent.add(this.shield),myself.showMessage("Fetching project\nfrom the cloud..."),
dict=SnapCloud.parseDict(location.hash.substr(9)),dict.Username=dict.Username.toLowerCase(),SnapCloud.getPublicProject(SnapCloud.encodeDict(dict),function(projectData){var msg;myself.nextSteps([function(){msg=myself.showMessage("Opening project...")},function(){nop()},function(){0===projectData.indexOf("<snapdata")?myself.rawOpenCloudDataString(projectData):0===projectData.indexOf("<project")&&myself.rawOpenProjectString(projectData),myself.hasChangedMedia=!0},function(){myself.shield.destroy(),myself.shield=null,msg.destroy(),applyFlags(dict)}])},this.cloudError())):"#cloud:"===location.hash.substr(0,7)?(this.shield=new Morph,this.shield.alpha=0,this.shield.setExtent(this.parent.extent()),
this.parent.add(this.shield),myself.showMessage("Fetching project\nfrom the cloud..."),dict=SnapCloud.parseDict(location.hash.substr(7)),dict.Username=dict.Username.toLowerCase(),SnapCloud.getPublicProject(SnapCloud.encodeDict(dict),function(projectData){var msg;myself.nextSteps([function(){msg=myself.showMessage("Opening project...")},function(){nop()},function(){0===projectData.indexOf("<snapdata")?myself.rawOpenCloudDataString(projectData):0===projectData.indexOf("<project")&&myself.rawOpenProjectString(projectData),myself.hasChangedMedia=!0},function(){myself.shield.destroy(),myself.shield=null,msg.destroy(),myself.toggleAppMode(!1)}])},this.cloudError())):"#dl:"===location.hash.substr(0,4)?(myself.showMessage("Fetching project\nfrom the cloud..."),
dict=SnapCloud.parseDict(location.hash.substr(4)),dict.Username=dict.Username.toLowerCase(),SnapCloud.getPublicProject(SnapCloud.encodeDict(dict),function(projectData){myself.saveXMLAs(projectData,dict.ProjectName),myself.showMessage("Saved project\n"+dict.ProjectName,2)},this.cloudError())):"#lang:"===location.hash.substr(0,6)?(urlLanguage=location.hash.substr(6),this.setLanguage(urlLanguage),this.loadNewProject=!0):"#signup"===location.hash.substr(0,7)&&this.createCloudAccount(),this.loadNewProject=!1}var hash,usr,myself=this,urlLanguage=null;this.hasLocalStorage()&&(usr=localStorage["-snap-user"],usr&&(usr=SnapCloud.parseResponse(usr)[0],usr&&(SnapCloud.username=usr.username||null,
SnapCloud.password=usr.password||null,SnapCloud.username&&(this.source="cloud")))),this.buildPanes(),world.add(this),world.userMenu=this.userMenu,SnapCloud.message=function(string){var intervalHandle,m=new MenuMorph(null,string);m.popUpCenteredInWorld(world),intervalHandle=setInterval(function(){m.destroy(),clearInterval(intervalHandle)},2e3)},world.reactToDropOf=function(morph){morph instanceof DialogBoxMorph||(world.hand.grabOrigin?morph.slideBackTo(world.hand.grabOrigin):world.hand.grab(morph))},this.reactToWorldResize(world.bounds),this.userLanguage?(this.loadNewProject=!0,this.setLanguage(this.userLanguage,interpretUrlAnchors)):interpretUrlAnchors.call(this);
},IDE_Morph.prototype.buildPanes=function(){this.createLogo(),this.createControlBar(),this.createCategories(),this.createPalette(),this.createStage(),this.createSpriteBar(),this.createSpriteEditor(),this.createCorralBar(),this.createCorral()},IDE_Morph.prototype.createLogo=function(){var myself=this;this.logo&&this.logo.destroy(),this.logo=new Morph,this.logo.texture=this.logoURL,this.logo.drawNew=function(){this.image=newCanvas(this.extent());var context=this.image.getContext("2d"),gradient=context.createLinearGradient(0,0,this.width(),0);gradient.addColorStop(0,"black"),gradient.addColorStop(.5,myself.frameColor.toString()),context.fillStyle=MorphicPreferences.isFlat?myself.frameColor.toString():gradient,
context.fillRect(0,0,this.width(),this.height()),this.texture&&this.drawTexture(this.texture)},this.logo.drawCachedTexture=function(){var context=this.image.getContext("2d");context.drawImage(this.cachedTexture,5,Math.round((this.height()-this.cachedTexture.height)/2)),this.changed()},this.logo.mouseClickLeft=function(){myself.snapMenu()},this.logo.color=new Color,this.logo.setExtent(new Point(200,28)),this.add(this.logo)},IDE_Morph.prototype.createControlBar=function(){var button,slider,stopButton,pauseButton,startButton,projectButton,settingsButton,stageSizeButton,appModeButton,steppingButton,cloudButton,x,padding=5,colors=[this.groupColor,this.frameColor.darker(50),this.frameColor.darker(50)],myself=this;
this.controlBar&&this.controlBar.destroy(),this.controlBar=new Morph,this.controlBar.color=this.frameColor,this.controlBar.setHeight(this.logo.height()),this.controlBar.mouseClickLeft=function(){this.world().fillPage()},this.add(this.controlBar),button=new ToggleButtonMorph(null,myself,"toggleStageSize",[new SymbolMorph("smallStage",14),new SymbolMorph("normalStage",14)],function(){return myself.isSmallStage}),button.corner=12,button.color=colors[0],button.highlightColor=colors[1],button.pressColor=colors[2],button.labelMinExtent=new Point(36,18),button.padding=0,button.labelShadowOffset=new Point(-1,-1),button.labelShadowColor=colors[1],button.labelColor=this.buttonLabelColor,
button.contrast=this.buttonContrast,button.drawNew(),button.fixLayout(),button.refresh(),stageSizeButton=button,this.controlBar.add(stageSizeButton),this.controlBar.stageSizeButton=button,button=new ToggleButtonMorph(null,myself,"toggleAppMode",[new SymbolMorph("fullScreen",14),new SymbolMorph("normalScreen",14)],function(){return myself.isAppMode}),button.corner=12,button.color=colors[0],button.highlightColor=colors[1],button.pressColor=colors[2],button.labelMinExtent=new Point(36,18),button.padding=0,button.labelShadowOffset=new Point(-1,-1),button.labelShadowColor=colors[1],button.labelColor=this.buttonLabelColor,button.contrast=this.buttonContrast,button.drawNew(),
button.fixLayout(),button.refresh(),appModeButton=button,this.controlBar.add(appModeButton),this.controlBar.appModeButton=appModeButton,button=new ToggleButtonMorph(null,myself,"toggleSingleStepping",[new SymbolMorph("footprints",16),new SymbolMorph("footprints",16)],function(){return Process.prototype.enableSingleStepping}),button.corner=12,button.color=colors[0],button.highlightColor=colors[1],button.pressColor=new Color(153,255,213),button.labelMinExtent=new Point(36,18),button.padding=0,button.labelShadowOffset=new Point(-1,-1),button.labelShadowColor=colors[1],button.labelColor=this.buttonLabelColor,button.contrast=this.buttonContrast,button.drawNew(),button.hint="Visible stepping",
button.fixLayout(),button.refresh(),steppingButton=button,this.controlBar.add(steppingButton),this.controlBar.steppingButton=steppingButton,button=new ToggleButtonMorph(null,this,"stopAllScripts",[new SymbolMorph("octagon",14),new SymbolMorph("square",14)],function(){return!myself.stage||myself.stage.enableCustomHatBlocks&&myself.stage.threads.pauseCustomHatBlocks}),button.corner=12,button.color=colors[0],button.highlightColor=colors[1],button.pressColor=colors[2],button.labelMinExtent=new Point(36,18),button.padding=0,button.labelShadowOffset=new Point(-1,-1),button.labelShadowColor=colors[1],button.labelColor=new Color(200,0,0),button.contrast=this.buttonContrast,
button.drawNew(),button.fixLayout(),button.refresh(),stopButton=button,this.controlBar.add(stopButton),this.controlBar.stopButton=stopButton,button=new ToggleButtonMorph(null,this,"togglePauseResume",[new SymbolMorph("pause",12),new SymbolMorph("pointRight",14)],function(){return myself.isPaused()}),button.corner=12,button.color=colors[0],button.highlightColor=colors[1],button.pressColor=colors[2],button.labelMinExtent=new Point(36,18),button.padding=0,button.labelShadowOffset=new Point(-1,-1),button.labelShadowColor=colors[1],button.labelColor=new Color(255,220,0),button.contrast=this.buttonContrast,button.drawNew(),button.fixLayout(),button.refresh(),pauseButton=button,
this.controlBar.add(pauseButton),this.controlBar.pauseButton=pauseButton,button=new PushButtonMorph(this,"pressStart",new SymbolMorph("flag",14)),button.corner=12,button.color=colors[0],button.highlightColor=colors[1],button.pressColor=colors[2],button.labelMinExtent=new Point(36,18),button.padding=0,button.labelShadowOffset=new Point(-1,-1),button.labelShadowColor=colors[1],button.labelColor=new Color(0,200,0),button.contrast=this.buttonContrast,button.drawNew(),button.fixLayout(),startButton=button,this.controlBar.add(startButton),this.controlBar.startButton=startButton,slider=new SliderMorph(61,1,100*Process.prototype.flashTime+1,6,"horizontal"),slider.action=function(num){
Process.prototype.flashTime=(num-1)/100,myself.controlBar.refreshResumeSymbol()},slider.color=new Color(153,255,213),slider.alpha=.3,slider.setExtent(new Point(50,14)),this.controlBar.add(slider),this.controlBar.steppingSlider=slider,button=new PushButtonMorph(this,"projectMenu",new SymbolMorph("file",14)),button.corner=12,button.color=colors[0],button.highlightColor=colors[1],button.pressColor=colors[2],button.labelMinExtent=new Point(36,18),button.padding=0,button.labelShadowOffset=new Point(-1,-1),button.labelShadowColor=colors[1],button.labelColor=this.buttonLabelColor,button.contrast=this.buttonContrast,button.drawNew(),button.fixLayout(),projectButton=button,
this.controlBar.projectButton=projectButton,button=new PushButtonMorph(this,"settingsMenu",new SymbolMorph("gears",14)),button.corner=12,button.color=colors[0],button.highlightColor=colors[1],button.pressColor=colors[2],button.labelMinExtent=new Point(36,18),button.padding=0,button.labelShadowOffset=new Point(-1,-1),button.labelShadowColor=colors[1],button.labelColor=this.buttonLabelColor,button.contrast=this.buttonContrast,button.drawNew(),button.fixLayout(),settingsButton=button,this.controlBar.settingsButton=settingsButton,button=new PushButtonMorph(this,"cloudMenu",new SymbolMorph("cloud",11)),button.corner=12,button.color=colors[0],button.highlightColor=colors[1],
button.pressColor=colors[2],button.labelMinExtent=new Point(36,18),button.padding=0,button.labelShadowOffset=new Point(-1,-1),button.labelShadowColor=colors[1],button.labelColor=this.buttonLabelColor,button.contrast=this.buttonContrast,button.drawNew(),button.fixLayout(),cloudButton=button,this.controlBar.cloudButton=cloudButton,this.controlBar.fixLayout=function(){x=this.right()-padding,[stopButton,pauseButton,startButton].forEach(function(button){button.setCenter(myself.controlBar.center()),button.setRight(x),x-=button.width(),x-=padding}),x=Math.min(startButton.left()-(3*padding+2*stageSizeButton.width()),myself.right()-StageMorph.prototype.dimensions.x*(myself.isSmallStage?myself.stageRatio:1)),
[stageSizeButton,appModeButton].forEach(function(button){x+=padding,button.setCenter(myself.controlBar.center()),button.setLeft(x),x+=button.width()}),slider.setCenter(myself.controlBar.center()),slider.setRight(stageSizeButton.left()-padding),steppingButton.setCenter(myself.controlBar.center()),steppingButton.setRight(slider.left()-padding),settingsButton.setCenter(myself.controlBar.center()),settingsButton.setLeft(this.left()),cloudButton.setCenter(myself.controlBar.center()),cloudButton.setRight(settingsButton.left()-padding),projectButton.setCenter(myself.controlBar.center()),projectButton.setRight(cloudButton.left()-padding),this.refreshSlider(),this.updateLabel();
},this.controlBar.refreshSlider=function(){Process.prototype.enableSingleStepping&&!myself.isAppMode?(slider.drawNew(),slider.show()):slider.hide(),this.refreshResumeSymbol()},this.controlBar.refreshResumeSymbol=function(){var pauseSymbols;Process.prototype.enableSingleStepping&&Process.prototype.flashTime>.5?(myself.stage.threads.pauseAll(myself.stage),pauseSymbols=[new SymbolMorph("pause",12),new SymbolMorph("stepForward",14)]):pauseSymbols=[new SymbolMorph("pause",12),new SymbolMorph("pointRight",14)],pauseButton.labelString=pauseSymbols,pauseButton.createLabel(),pauseButton.fixLayout(),pauseButton.refresh()},this.controlBar.updateLabel=function(){var suffix=myself.world().isDevMode?" - "+localize("development mode"):"";
this.label&&this.label.destroy(),myself.isAppMode||(this.label=new StringMorph((myself.projectName||localize("untitled"))+suffix,14,"sans-serif",!0,!1,!1,MorphicPreferences.isFlat?null:new Point(2,1),myself.frameColor.darker(myself.buttonContrast)),this.label.color=myself.buttonLabelColor,this.label.drawNew(),this.add(this.label),this.label.setCenter(this.center()),this.label.setLeft(this.settingsButton.right()+padding))}},IDE_Morph.prototype.createCategories=function(){function addCategoryButton(category){var button,labelWidth=75,colors=[myself.frameColor,myself.frameColor.darker(50),SpriteMorph.prototype.blockColor[category]];return button=new ToggleButtonMorph(colors,myself,function(){
myself.currentCategory=category,myself.categories.children.forEach(function(each){each.refresh()}),myself.refreshPalette(!0)},category[0].toUpperCase().concat(category.slice(1)),function(){return myself.currentCategory===category},null,null,null,labelWidth,!0),button.corner=8,button.padding=0,button.labelShadowOffset=new Point(-1,-1),button.labelShadowColor=colors[1],button.labelColor=myself.buttonLabelColor,button.fixLayout(),button.refresh(),myself.categories.add(button),button}function fixCategoriesLayout(){var row,col,buttonWidth=myself.categories.children[0].width(),buttonHeight=myself.categories.children[0].height(),border=3,rows=Math.ceil(myself.categories.children.length/2),xPadding=(200-border-2*buttonWidth)/3,yPadding=2,l=myself.categories.left(),t=myself.categories.top(),i=0;
myself.categories.children.forEach(function(button){i+=1,row=Math.ceil(i/2),col=2-i%2,button.setPosition(new Point(l+(col*xPadding+(col-1)*buttonWidth),t+(row*yPadding+(row-1)*buttonHeight+border)))}),myself.categories.setHeight((rows+1)*yPadding+rows*buttonHeight+2*border)}var myself=this;this.categories&&this.categories.destroy(),this.categories=new Morph,this.categories.color=this.groupColor,this.categories.silentSetWidth(this.paletteWidth),SpriteMorph.prototype.categories.forEach(function(cat){contains(["lists","other"],cat)||addCategoryButton(cat)}),fixCategoriesLayout(),this.add(this.categories)},IDE_Morph.prototype.createPalette=function(forSearching){
var myself=this;return this.palette&&this.palette.destroy(),forSearching?this.palette=new ScrollFrameMorph(null,null,this.currentSprite.sliderColor):this.palette=this.currentSprite.palette(this.currentCategory),this.palette.isDraggable=!1,this.palette.acceptsDrops=!0,this.palette.enableAutoScrolling=!1,this.palette.contents.acceptsDrops=!1,this.palette.reactToDropOf=function(droppedMorph,hand){droppedMorph instanceof DialogBoxMorph?myself.world().add(droppedMorph):droppedMorph instanceof SpriteMorph?myself.removeSprite(droppedMorph):droppedMorph instanceof SpriteIconMorph?(droppedMorph.destroy(),myself.removeSprite(droppedMorph.object)):droppedMorph instanceof CostumeIconMorph?(myself.currentSprite.wearCostume(null),
droppedMorph.perish()):droppedMorph instanceof BlockMorph?(myself.stage.threads.stopAllForBlock(droppedMorph),hand&&hand.grabOrigin.origin instanceof ScriptsMorph&&(hand.grabOrigin.origin.clearDropInfo(),hand.grabOrigin.origin.lastDroppedBlock=droppedMorph,hand.grabOrigin.origin.recordDrop(hand.grabOrigin)),droppedMorph.perish()):droppedMorph.perish()},this.palette.contents.reactToDropOf=function(droppedMorph){droppedMorph instanceof BlockMorph&&droppedMorph.destroy()},this.palette.setWidth(this.logo.width()),this.add(this.palette),this.palette},IDE_Morph.prototype.createPaletteHandle=function(){this.paletteHandle&&this.paletteHandle.destroy(),this.paletteHandle=new PaletteHandleMorph(this.categories),
panel_Left=this,this.add(this.paletteHandle)},IDE_Morph.prototype.createStage=function(){this.stage&&this.stage.destroy(),StageMorph.prototype.frameRate=0,this.stage=new StageMorph(this.globalVariables),this.stage.setExtent(this.stage.dimensions),this.currentSprite instanceof SpriteMorph&&(this.currentSprite.setPosition(this.stage.center().subtract(this.currentSprite.extent().divideBy(2))),this.stage.add(this.currentSprite)),this.add(this.stage)},IDE_Morph.prototype.createStageHandle=function(){this.stageHandle&&this.stageHandle.destroy(),this.stageHandle=new StageHandleMorph(this.stage),this.add(this.stageHandle)},IDE_Morph.prototype.createSpriteBar=function(){
function addRotationStyleButton(rotationStyle){var button,colors=myself.rotationStyleColors;return button=new ToggleButtonMorph(colors,myself,function(){myself.currentSprite instanceof SpriteMorph&&(myself.currentSprite.rotationStyle=rotationStyle,myself.currentSprite.changed(),myself.currentSprite.drawNew(),myself.currentSprite.changed()),rotationStyleButtons.forEach(function(each){each.refresh()})},symbols[rotationStyle],function(){return myself.currentSprite instanceof SpriteMorph&&myself.currentSprite.rotationStyle===rotationStyle},null,localize(labels[rotationStyle])),button.corner=8,button.labelMinExtent=new Point(11,11),button.padding=0,button.labelShadowOffset=new Point(-1,-1),
button.labelShadowColor=colors[1],button.labelColor=myself.buttonLabelColor,button.fixLayout(),button.refresh(),rotationStyleButtons.push(button),button.setPosition(myself.spriteBar.position().add(2)),button.setTop(button.top()+(rotationStyleButtons.length-1)*(button.height()+2)),myself.spriteBar.add(button),myself.currentSprite instanceof StageMorph&&button.hide(),button}var nameField,padlock,thumbnail,tab,rotationStyleButtons=[],thumbSize=new Point(45,45),tabCorner=15,tabColors=this.tabColors,tabBar=new AlignmentMorph("row",2*-tabCorner),symbols=["→","↻","↔"],labels=["don't rotate","can rotate","only face left/right"],myself=this;this.spriteBar&&this.spriteBar.destroy(),
this.spriteBar=new Morph,this.spriteBar.color=this.frameColor,this.add(this.spriteBar),addRotationStyleButton(1),addRotationStyleButton(2),addRotationStyleButton(0),this.rotationStyleButtons=rotationStyleButtons,thumbnail=new Morph,thumbnail.setExtent(thumbSize),thumbnail.image=this.currentSprite.thumbnail(thumbSize),thumbnail.setPosition(rotationStyleButtons[0].topRight().add(new Point(5,3))),this.spriteBar.add(thumbnail),thumbnail.fps=3,thumbnail.step=function(){thumbnail.version!==myself.currentSprite.version&&(thumbnail.image=myself.currentSprite.thumbnail(thumbSize),thumbnail.changed(),thumbnail.version=myself.currentSprite.version)},nameField=new InputFieldMorph(this.currentSprite.name),
nameField.setWidth(100),nameField.contrast=90,nameField.setPosition(thumbnail.topRight().add(new Point(10,3))),this.spriteBar.add(nameField),nameField.drawNew(),nameField.accept=function(){var newName=nameField.getValue();myself.currentSprite.setName(myself.newSpriteName(newName,myself.currentSprite)),nameField.setContents(myself.currentSprite.name)},this.spriteBar.reactToEdit=nameField.accept,padlock=new ToggleMorph("checkbox",null,function(){myself.currentSprite.isDraggable=!myself.currentSprite.isDraggable},localize("draggable"),function(){return myself.currentSprite.isDraggable}),padlock.label.isBold=!1,padlock.label.setColor(this.buttonLabelColor),padlock.color=tabColors[2],
padlock.highlightColor=tabColors[0],padlock.pressColor=tabColors[1],padlock.tick.shadowOffset=MorphicPreferences.isFlat?new Point:new Point(-1,-1),padlock.tick.shadowColor=new Color,padlock.tick.color=this.buttonLabelColor,padlock.tick.isBold=!1,padlock.tick.drawNew(),padlock.setPosition(nameField.bottomLeft().add(2)),padlock.drawNew(),this.spriteBar.add(padlock),this.currentSprite instanceof StageMorph&&padlock.hide(),tabBar.tabTo=function(tabString){var active;myself.currentTab=tabString,this.children.forEach(function(each){each.refresh(),each.state&&(active=each)}),active.refresh(),myself.createSpriteEditor(),myself.fixLayout("tabEditor")},tab=new TabMorph(tabColors,null,function(){
tabBar.tabTo("scripts")},localize("Scripts"),function(){return"scripts"===myself.currentTab}),tab.padding=3,tab.corner=tabCorner,tab.edge=1,tab.labelShadowOffset=new Point(-1,-1),tab.labelShadowColor=tabColors[1],tab.labelColor=this.buttonLabelColor,tab.drawNew(),tab.fixLayout(),tabBar.add(tab),tab=new TabMorph(tabColors,null,function(){tabBar.tabTo("costumes")},localize(this.currentSprite instanceof SpriteMorph?"Costumes":"Backgrounds"),function(){return"costumes"===myself.currentTab}),tab.padding=3,tab.corner=tabCorner,tab.edge=1,tab.labelShadowOffset=new Point(-1,-1),tab.labelShadowColor=tabColors[1],tab.labelColor=this.buttonLabelColor,tab.drawNew(),tab.fixLayout(),
tabBar.add(tab),tab=new TabMorph(tabColors,null,function(){tabBar.tabTo("sounds")},localize("Sounds"),function(){return"sounds"===myself.currentTab}),tab.padding=3,tab.corner=tabCorner,tab.edge=1,tab.labelShadowOffset=new Point(-1,-1),tab.labelShadowColor=tabColors[1],tab.labelColor=this.buttonLabelColor,tab.drawNew(),tab.fixLayout(),tabBar.add(tab),tabBar.fixLayout(),tabBar.children.forEach(function(each){each.refresh()}),this.spriteBar.tabBar=tabBar,this.spriteBar.add(this.spriteBar.tabBar),this.spriteBar.fixLayout=function(){this.tabBar.setLeft(this.left()),this.tabBar.setBottom(this.bottom())}},IDE_Morph.prototype.createSpriteEditor=function(){var scripts=this.currentSprite.scripts,myself=this;
this.spriteEditor&&this.spriteEditor.destroy(),"scripts"===this.currentTab?(scripts.isDraggable=!1,scripts.color=this.groupColor,scripts.cachedTexture=this.scriptsPaneTexture,this.spriteEditor=new ScrollFrameMorph(scripts,null,this.sliderColor),this.spriteEditor.padding=10,this.spriteEditor.growth=50,this.spriteEditor.isDraggable=!1,this.spriteEditor.acceptsDrops=!1,this.spriteEditor.contents.acceptsDrops=!0,scripts.scrollFrame=this.spriteEditor,scripts.updateToolbar(),this.add(this.spriteEditor),this.spriteEditor.scrollX(this.spriteEditor.padding),this.spriteEditor.scrollY(this.spriteEditor.padding)):"costumes"===this.currentTab?(this.spriteEditor=new WardrobeMorph(this.currentSprite,this.sliderColor),
this.spriteEditor.color=this.groupColor,this.add(this.spriteEditor),this.spriteEditor.updateSelection(),this.spriteEditor.acceptsDrops=!1,this.spriteEditor.contents.acceptsDrops=!1):"sounds"===this.currentTab?(this.spriteEditor=new JukeboxMorph(this.currentSprite,this.sliderColor),this.spriteEditor.color=this.groupColor,this.add(this.spriteEditor),this.spriteEditor.updateSelection(),this.spriteEditor.acceptDrops=!1,this.spriteEditor.contents.acceptsDrops=!1):(this.spriteEditor=new Morph,this.spriteEditor.color=this.groupColor,this.spriteEditor.acceptsDrops=!0,this.spriteEditor.reactToDropOf=function(droppedMorph){droppedMorph instanceof DialogBoxMorph?myself.world().add(droppedMorph):droppedMorph instanceof SpriteMorph?myself.removeSprite(droppedMorph):droppedMorph.destroy();
},this.add(this.spriteEditor))},IDE_Morph.prototype.createCorralBar=function(){var newbutton,paintbutton,cambutton,padding=5,colors=[this.groupColor,this.frameColor.darker(50),this.frameColor.darker(50)];this.corralBar&&this.corralBar.destroy(),this.corralBar=new Morph,this.corralBar.color=this.frameColor,this.corralBar.setHeight(this.logo.height()),this.add(this.corralBar),newbutton=new PushButtonMorph(this,"addNewSprite",new SymbolMorph("turtle",14)),newbutton.corner=12,newbutton.color=colors[0],newbutton.highlightColor=colors[1],newbutton.pressColor=colors[2],newbutton.labelMinExtent=new Point(36,18),newbutton.padding=0,newbutton.labelShadowOffset=new Point(-1,-1),
newbutton.labelShadowColor=colors[1],newbutton.labelColor=this.buttonLabelColor,newbutton.contrast=this.buttonContrast,newbutton.drawNew(),newbutton.hint="add a new Turtle sprite",newbutton.fixLayout(),newbutton.setCenter(this.corralBar.center()),newbutton.setLeft(this.corralBar.left()+padding),this.corralBar.add(newbutton),paintbutton=new PushButtonMorph(this,"paintNewSprite",new SymbolMorph("brush",15)),paintbutton.corner=12,paintbutton.color=colors[0],paintbutton.highlightColor=colors[1],paintbutton.pressColor=colors[2],paintbutton.labelMinExtent=new Point(36,18),paintbutton.padding=0,paintbutton.labelShadowOffset=new Point(-1,-1),paintbutton.labelShadowColor=colors[1],
paintbutton.labelColor=this.buttonLabelColor,paintbutton.contrast=this.buttonContrast,paintbutton.drawNew(),paintbutton.hint="paint a new sprite",paintbutton.fixLayout(),paintbutton.setCenter(this.corralBar.center()),paintbutton.setLeft(this.corralBar.left()+padding+newbutton.width()+padding),this.corralBar.add(paintbutton),CamSnapshotDialogMorph.prototype.enableCamera&&(cambutton=new PushButtonMorph(this,"newCamSprite",new SymbolMorph("camera",15)),cambutton.corner=12,cambutton.color=colors[0],cambutton.highlightColor=colors[1],cambutton.pressColor=colors[2],cambutton.labelMinExtent=new Point(36,18),cambutton.padding=0,cambutton.labelShadowOffset=new Point(-1,-1),
cambutton.labelShadowColor=colors[1],cambutton.labelColor=this.buttonLabelColor,cambutton.contrast=this.buttonContrast,cambutton.drawNew(),cambutton.hint="take a camera snapshot and\nimport it as a new sprite",cambutton.fixLayout(),cambutton.setCenter(this.corralBar.center()),cambutton.setLeft(this.corralBar.left()+padding+newbutton.width()+padding+paintbutton.width()+padding),this.corralBar.add(cambutton),document.addEventListener("cameraDisabled",function(event){cambutton.disable(),cambutton.hint=CamSnapshotDialogMorph.prototype.notSupportedMessage}))},IDE_Morph.prototype.createCorral=function(){var frame,template,padding=5,myself=this;this.createStageHandle(),
this.createPaletteHandle(),this.corral&&this.corral.destroy(),this.corral=new Morph,this.corral.color=this.groupColor,this.add(this.corral),this.corral.stageIcon=new SpriteIconMorph(this.stage),this.corral.stageIcon.isDraggable=!1,this.corral.add(this.corral.stageIcon),frame=new ScrollFrameMorph(null,null,this.sliderColor),frame.acceptsDrops=!1,frame.contents.acceptsDrops=!1,frame.contents.wantsDropOf=function(morph){return morph instanceof SpriteIconMorph},frame.contents.reactToDropOf=function(spriteIcon){myself.corral.reactToDropOf(spriteIcon)},frame.alpha=0,this.sprites.asArray().forEach(function(morph){morph.isTemporary||(template=new SpriteIconMorph(morph,template),
frame.contents.add(template))}),this.corral.frame=frame,this.corral.add(frame),this.corral.fixLayout=function(){this.stageIcon.setCenter(this.center()),this.stageIcon.setLeft(this.left()+padding),this.frame.setLeft(this.stageIcon.right()+padding),this.frame.setExtent(new Point(this.right()-this.frame.left(),this.height())),this.arrangeIcons(),this.refresh()},this.corral.arrangeIcons=function(){var x=this.frame.left(),y=this.frame.top(),max=this.frame.right(),start=this.frame.left();this.frame.contents.children.forEach(function(icon){var w=icon.width();x+w>max&&(x=start,y+=icon.height()),icon.setPosition(new Point(x,y)),x+=w}),this.frame.contents.adjustBounds();
},this.corral.addSprite=function(sprite){this.frame.contents.add(new SpriteIconMorph(sprite)),this.fixLayout()},this.corral.refresh=function(){this.stageIcon.refresh(),this.frame.contents.children.forEach(function(icon){icon.refresh()})},this.corral.wantsDropOf=function(morph){return morph instanceof SpriteIconMorph},this.corral.reactToDropOf=function(spriteIcon){var idx=1,pos=spriteIcon.position();spriteIcon.destroy(),this.frame.contents.children.forEach(function(icon){(pos.gt(icon.position())||pos.y>icon.bottom())&&(idx+=1)}),myself.sprites.add(spriteIcon.object,idx),myself.createCorral(),myself.fixLayout()}},IDE_Morph.prototype.fixLayout=function(situation){
var maxPaletteWidth,padding=this.padding;Morph.prototype.trackChanges=!1,"refreshPalette"!==situation&&(this.controlBar.setPosition(this.logo.topRight()),this.controlBar.setWidth(this.right()-this.controlBar.left()),this.controlBar.fixLayout(),this.categories.setLeft(this.logo.left()),this.categories.setTop(this.logo.bottom()),this.categories.setWidth(this.paletteWidth)),this.palette.setLeft(this.logo.left()),this.palette.setTop(this.categories.bottom()),this.palette.setHeight(this.bottom()-this.palette.top()),this.palette.setWidth(this.paletteWidth),"refreshPalette"!==situation&&(this.isAppMode?(this.stage.setScale(Math.floor(10*Math.min((this.width()-2*padding)/this.stage.dimensions.x,(this.height()-2*this.controlBar.height()-2*padding)/this.stage.dimensions.y))/10),
this.stage.setCenter(this.center())):(this.stage.setScale(this.isSmallStage?this.stageRatio:1),this.stage.setTop(this.logo.bottom()+padding),this.stage.setRight(this.right()),maxPaletteWidth=Math.max(200,this.width()-this.stage.width()-this.spriteBar.tabBar.width()-2*this.padding),this.paletteWidth>maxPaletteWidth&&(this.paletteWidth=maxPaletteWidth,this.fixLayout()),this.stageHandle.fixLayout(),this.paletteHandle.fixLayout()),this.spriteBar.setLeft(this.paletteWidth+padding),this.spriteBar.setTop(this.logo.bottom()+padding),this.spriteBar.setExtent(new Point(Math.max(0,this.stage.left()-padding-this.spriteBar.left()),this.categories.bottom()-this.spriteBar.top()-padding)),
this.spriteBar.fixLayout(),this.spriteEditor.isVisible&&(this.spriteEditor.setPosition(this.spriteBar.bottomLeft()),this.spriteEditor.setExtent(new Point(this.spriteBar.width(),this.bottom()-this.spriteEditor.top()))),this.corralBar.setLeft(this.stage.left()),this.corralBar.setTop(this.stage.bottom()+padding),this.corralBar.setWidth(this.stage.width()),contains(["selectSprite","tabEditor"],situation)||(this.corral.setPosition(this.corralBar.bottomLeft()),this.corral.setWidth(this.stage.width()),this.corral.setHeight(this.bottom()-this.corral.top()),this.corral.fixLayout())),Morph.prototype.trackChanges=!0,this.changed()},IDE_Morph.prototype.setProjectName=function(string){
this.projectName=string.replace(/['"]/g,""),this.hasChangedMedia=!0,this.controlBar.updateLabel()},IDE_Morph.prototype.setExtent=function(point){var minExt,ext,maxWidth,minWidth,maxHeight,minRatio,maxRatio,padding=new Point(430,110);minExt=this.isAppMode?StageMorph.prototype.dimensions.add(this.controlBar.height()+10):this.stageRatio>1?padding.add(StageMorph.prototype.dimensions):padding.add(StageMorph.prototype.dimensions.multiplyBy(this.stageRatio)),ext=point.max(minExt),maxWidth=ext.x-(200+this.spriteBar.tabBar.width()+2*this.padding),minWidth=3*SpriteIconMorph.prototype.thumbSize.x,maxHeight=ext.y-3.5*SpriteIconMorph.prototype.thumbSize.y,minRatio=minWidth/this.stage.dimensions.x,
maxRatio=Math.min(maxWidth/this.stage.dimensions.x,maxHeight/this.stage.dimensions.y),this.stageRatio=Math.min(maxRatio,Math.max(minRatio,this.stageRatio)),IDE_Morph.uber.setExtent.call(this,ext),this.fixLayout()},IDE_Morph.prototype.reactToWorldResize=function(rect){this.isAutoFill&&(this.setPosition(rect.origin),this.setExtent(rect.extent())),this.filePicker&&(document.body.removeChild(this.filePicker),this.filePicker=null)},IDE_Morph.prototype.droppedImage=function(aCanvas,name){var costume=new Costume(aCanvas,this.currentSprite.newCostumeName(name?name.split(".")[0]:""));return costume.isTainted()?void this.inform("Unable to import this image","The picture you wish to import has been\ntainted by a restrictive cross-origin policy\nmaking it unusable for costumes in Snap!. \n\nTry downloading this picture first to your\ncomputer, and import it from there."):(this.currentSprite.addCostume(costume),
this.currentSprite.wearCostume(costume),this.spriteBar.tabBar.tabTo("costumes"),void(this.hasChangedMedia=!0))},IDE_Morph.prototype.droppedSVG=function(anImage,name){var costume=new SVG_Costume(anImage,name.split(".")[0]);this.currentSprite.addCostume(costume),this.currentSprite.wearCostume(costume),this.spriteBar.tabBar.tabTo("costumes"),this.hasChangedMedia=!0},IDE_Morph.prototype.droppedAudio=function(anAudio,name){this.currentSprite.addSound(anAudio,name.split(".")[0]),this.spriteBar.tabBar.tabTo("sounds"),this.hasChangedMedia=!0},IDE_Morph.prototype.droppedText=function(aString,name){var lbl=name?name.split(".")[0]:"";return 0===aString.indexOf("<project")?(location.hash="",
this.openProjectString(aString)):0===aString.indexOf("<snapdata")?(location.hash="",this.openCloudDataString(aString)):0===aString.indexOf("<blocks")?this.openBlocksString(aString,lbl,!0):0===aString.indexOf("<sprites")?this.openSpritesString(aString):0===aString.indexOf("<media")?this.openMediaString(aString):0===aString.indexOf("<script")?this.openScriptString(aString):void 0},IDE_Morph.prototype.droppedBinary=function(anArrayBuffer,name){function loadYPR(buffer,lbl){var reader=new sb.Reader,pname=lbl.split(".")[0];reader.onload=function(info){myself.droppedText((new sb.XMLWriter).write(pname,info))},reader.readYPR(new Uint8Array(buffer))}var ypr=document.getElementById("ypr"),myself=this,suffix=name.substring(name.length-3);
"ypr"===suffix.toLowerCase()&&(ypr?loadYPR(anArrayBuffer,name):(ypr=document.createElement("script"),ypr.id="ypr",ypr.onload=function(){loadYPR(anArrayBuffer,name)},document.head.appendChild(ypr),ypr.src="ypr.js"))},IDE_Morph.prototype.refreshPalette=function(shouldIgnorePosition){var oldTop=this.palette.contents.top();this.createPalette(),this.fixLayout("refreshPalette"),shouldIgnorePosition||this.palette.contents.setTop(oldTop)},IDE_Morph.prototype.pressStart=function(){16===this.world().currentKey?this.toggleFastTracking():(this.stage.threads.pauseCustomHatBlocks=!1,this.controlBar.stopButton.refresh(),this.runScripts())},IDE_Morph.prototype.toggleFastTracking=function(){
this.stage.isFastTracked?this.stopFastTracking():this.startFastTracking()},IDE_Morph.prototype.toggleVariableFrameRate=function(){StageMorph.prototype.frameRate?(StageMorph.prototype.frameRate=0,this.stage.fps=0):(StageMorph.prototype.frameRate=30,this.stage.fps=30)},IDE_Morph.prototype.toggleSingleStepping=function(){this.stage.threads.toggleSingleStepping(),this.controlBar.steppingButton.refresh(),this.controlBar.refreshSlider()},IDE_Morph.prototype.toggleCameraSupport=function(){CamSnapshotDialogMorph.prototype.enableCamera=!CamSnapshotDialogMorph.prototype.enableCamera,this.spriteBar.tabBar.tabTo(this.currentTab),this.createCorralBar(),this.fixLayout()},IDE_Morph.prototype.startFastTracking=function(){
this.stage.isFastTracked=!0,this.stage.fps=0,this.controlBar.startButton.labelString=new SymbolMorph("flash",14),this.controlBar.startButton.drawNew(),this.controlBar.startButton.fixLayout()},IDE_Morph.prototype.stopFastTracking=function(){this.stage.isFastTracked=!1,this.stage.fps=this.stage.frameRate,this.controlBar.startButton.labelString=new SymbolMorph("flag",14),this.controlBar.startButton.drawNew(),this.controlBar.startButton.fixLayout()},IDE_Morph.prototype.runScripts=function(){this.stage.fireGreenFlagEvent()},IDE_Morph.prototype.togglePauseResume=function(){this.stage.threads.isPaused()?this.stage.threads.resumeAll(this.stage):this.stage.threads.pauseAll(this.stage),
this.controlBar.pauseButton.refresh()},IDE_Morph.prototype.isPaused=function(){return!!this.stage&&this.stage.threads.isPaused()},IDE_Morph.prototype.stopAllScripts=function(){this.stage.enableCustomHatBlocks?this.stage.threads.pauseCustomHatBlocks=!this.stage.threads.pauseCustomHatBlocks:this.stage.threads.pauseCustomHatBlocks=!1,this.controlBar.stopButton.refresh(),this.stage.fireStopAllEvent()},IDE_Morph.prototype.selectSprite=function(sprite){this.currentSprite&&this.currentSprite.scripts.focus&&this.currentSprite.scripts.focus.stopEditing(),this.currentSprite=sprite,this.createPalette(),this.createSpriteBar(),this.createSpriteEditor(),this.corral.refresh(),
this.fixLayout("selectSprite"),this.currentSprite.scripts.fixMultiArgs()},IDE_Morph.prototype.toggleRetina=function(){isRetinaEnabled()?disableRetinaSupport():enableRetinaSupport(),this.world().fillPage(),IDE_Morph.prototype.scriptsPaneTexture=this.scriptsTexture(),this.stage.clearPenTrails(),this.drawNew(),this.refreshIDE()},IDE_Morph.prototype.defaultDesign=function(){this.setDefaultDesign(),this.refreshIDE(),this.removeSetting("design")},IDE_Morph.prototype.flatDesign=function(){this.setFlatDesign(),this.refreshIDE(),this.saveSetting("design","flat")},IDE_Morph.prototype.refreshIDE=function(){var projectData;if(Process.prototype.isCatchingErrors)try{projectData=this.serializer.serialize(this.stage);
}catch(err){this.showMessage("Serialization failed: "+err)}else projectData=this.serializer.serialize(this.stage);SpriteMorph.prototype.initBlocks(),this.buildPanes(),this.fixLayout(),this.loadNewProject?this.newProject():this.openProjectString(projectData)},IDE_Morph.prototype.applySavedSettings=function(){var design=this.getSetting("design"),zoom=this.getSetting("zoom"),language="fr",click=this.getSetting("click"),longform=this.getSetting("longform"),longurls=this.getSetting("longurls"),plainprototype=this.getSetting("plainprototype"),keyboard=this.getSetting("keyboard"),tables=this.getSetting("tables"),tableLines=this.getSetting("tableLines"),autoWrapping=this.getSetting("autowrapping");
"flat"===design?this.setFlatDesign():this.setDefaultDesign(),zoom&&(SyntaxElementMorph.prototype.setScale(Math.min(zoom,12)),CommentMorph.prototype.refreshScale(),SpriteMorph.prototype.initBlocks()),language&&"en"!==language?this.userLanguage=language:this.userLanguage=null,click&&!BlockMorph.prototype.snapSound&&BlockMorph.prototype.toggleSnapSound(),longform&&(InputSlotDialogMorph.prototype.isLaunchingExpanded=!0),longurls?this.projectsInURLs=!0:this.projectsInURLs=!1,"false"===keyboard?ScriptsMorph.prototype.enableKeyboard=!1:ScriptsMorph.prototype.enableKeyboard=!0,"false"===tables?List.prototype.enableTables=!1:List.prototype.enableTables=!0,tableLines?TableMorph.prototype.highContrast=!0:TableMorph.prototype.highContrast=!1,
"false"===autoWrapping?ScriptsMorph.prototype.enableNestedAutoWrapping=!1:ScriptsMorph.prototype.enableNestedAutoWrapping=!0,plainprototype&&(BlockLabelPlaceHolderMorph.prototype.plainLabel=!0)},IDE_Morph.prototype.saveSetting=function(key,value){this.savingPreferences&&this.hasLocalStorage()&&(localStorage["-snap-setting-"+key]=value)},IDE_Morph.prototype.getSetting=function(key){return this.hasLocalStorage()?localStorage["-snap-setting-"+key]:null},IDE_Morph.prototype.removeSetting=function(key){this.hasLocalStorage()&&delete localStorage["-snap-setting-"+key]},IDE_Morph.prototype.hasLocalStorage=function(){try{return!isNil(localStorage)}catch(err){return!1;
}},IDE_Morph.prototype.addNewSprite=function(){var sprite=new SpriteMorph(this.globalVariables),rnd=Process.prototype.reportRandom;sprite.name=this.newSpriteName(sprite.name),sprite.setCenter(this.stage.center()),this.stage.add(sprite),sprite.setHue(rnd.call(this,0,100)),sprite.setBrightness(rnd.call(this,50,100)),sprite.turn(rnd.call(this,1,360)),sprite.setXPosition(rnd.call(this,-220,220)),sprite.setYPosition(rnd.call(this,-160,160)),this.sprites.add(sprite),this.corral.addSprite(sprite),this.selectSprite(sprite)},IDE_Morph.prototype.paintNewSprite=function(){var sprite=new SpriteMorph(this.globalVariables),cos=new Costume,myself=this;sprite.name=this.newSpriteName(sprite.name),
sprite.setCenter(this.stage.center()),this.stage.add(sprite),this.sprites.add(sprite),this.corral.addSprite(sprite),this.selectSprite(sprite),cos.edit(this.world(),this,!0,function(){myself.removeSprite(sprite)},function(){sprite.addCostume(cos),sprite.wearCostume(cos)})},IDE_Morph.prototype.newCamSprite=function(){var camDialog,sprite=new SpriteMorph(this.globalVariables),myself=this;sprite.name=this.newSpriteName(sprite.name),sprite.setCenter(this.stage.center()),this.stage.add(sprite),this.sprites.add(sprite),this.corral.addSprite(sprite),this.selectSprite(sprite),camDialog=new CamSnapshotDialogMorph(this,sprite,function(){myself.removeSprite(sprite)},function(costume){
sprite.addCostume(costume),sprite.wearCostume(costume),this.close()}),camDialog.popUp(this.world())},IDE_Morph.prototype.duplicateSprite=function(sprite){var duplicate=sprite.fullCopy();duplicate.setPosition(this.world().hand.position()),duplicate.appearIn(this),duplicate.keepWithin(this.stage),this.selectSprite(duplicate)},IDE_Morph.prototype.instantiateSprite=function(sprite){var instance=sprite.fullCopy(!0),hats=instance.allHatBlocksFor("__clone__init__");instance.appearIn(this),hats.length?instance.initClone(hats):(instance.setPosition(this.world().hand.position()),instance.keepWithin(this.stage)),this.selectSprite(instance)},IDE_Morph.prototype.removeSprite=function(sprite){
var idx,myself=this;sprite.parts.forEach(function(part){myself.removeSprite(part)}),idx=this.sprites.asArray().indexOf(sprite)+1,this.stage.threads.stopAllForReceiver(sprite),sprite.corpsify(),sprite.destroy(),this.stage.watchers().forEach(function(watcher){watcher.object()===sprite&&watcher.destroy()}),idx>0&&this.sprites.remove(idx),this.createCorral(),this.fixLayout(),this.currentSprite=detect(this.stage.children,function(morph){return morph instanceof SpriteMorph&&!morph.isTemporary})||this.stage,this.selectSprite(this.currentSprite)},IDE_Morph.prototype.newSpriteName=function(name,ignoredSprite){for(var ix=name.indexOf("("),stem=ix<0?name:name.substring(0,ix),count=1,newName=stem,all=this.sprites.asArray().concat(this.stage).filter(function(each){
return each!==ignoredSprite}).map(function(each){return each.name});contains(all,newName);)count+=1,newName=stem+"("+count+")";return newName},IDE_Morph.prototype.removeBlock=function(aBlock,justThis){this.stage.threads.stopAllForBlock(aBlock),aBlock.destroy(justThis)},IDE_Morph.prototype.userMenu=function(){var menu=new MenuMorph(this);return menu},IDE_Morph.prototype.snapMenu=function(){var menu,myself=this,world=this.world();menu=new MenuMorph(this),menu.addItem("About...","aboutSnap"),menu.addLine(),menu.addItem("Reference manual",function(){var url=myself.resourceURL("help","SnapManual.pdf");window.open(url,"SnapReferenceManual")}),menu.addItem("Snap! website",function(){
window.open("http://snap.berkeley.edu/","SnapWebsite")}),menu.addItem("Download source",function(){window.open("http://snap.berkeley.edu/snapsource/snap.zip","SnapSource")}),world.isDevMode?(menu.addLine(),menu.addItem("Switch back to user mode","switchToUserMode","disable deep-Morphic\ncontext menus\nand show user-friendly ones",new Color(0,100,0))):16===world.currentKey&&(menu.addLine(),menu.addItem("Switch to dev mode","switchToDevMode","enable Morphic\ncontext menus\nand inspectors,\nnot user-friendly!",new Color(100,0,0))),menu.popup(world,this.logo.bottomLeft())},IDE_Morph.prototype.cloudMenu=function(){var menu,myself=this,world=this.world(),pos=this.controlBar.cloudButton.bottomLeft(),shiftClicked=16===world.currentKey;
menu=new MenuMorph(this),shiftClicked&&(menu.addItem("url...","setCloudURL",null,new Color(100,0,0)),menu.addLine()),SnapCloud.username?(menu.addItem(localize("Logout")+" "+SnapCloud.username,"logout"),menu.addItem("Change Password...","changeCloudPassword")):(menu.addItem("Login...","initializeCloud"),menu.addItem("Signup...","createCloudAccount"),menu.addItem("Reset Password...","resetCloudPassword")),shiftClicked&&(menu.addLine(),menu.addItem("export project media only...",function(){myself.projectName?myself.exportProjectMedia(myself.projectName):myself.prompt("Export Project As...",function(name){myself.exportProjectMedia(name)},null,"exportProject")},null,this.hasChangedMedia?new Color(100,0,0):new Color(0,100,0)),
menu.addItem("export project without media...",function(){myself.projectName?myself.exportProjectNoMedia(myself.projectName):myself.prompt("Export Project As...",function(name){myself.exportProjectNoMedia(name)},null,"exportProject")},null,new Color(100,0,0)),menu.addItem("export project as cloud data...",function(){myself.projectName?myself.exportProjectAsCloudData(myself.projectName):myself.prompt("Export Project As...",function(name){myself.exportProjectAsCloudData(name)},null,"exportProject")},null,new Color(100,0,0)),menu.addLine(),menu.addItem("open shared project from cloud...",function(){myself.prompt("Author name…",function(usr){myself.prompt("Project name...",function(prj){
var id="Username="+encodeURIComponent(usr.toLowerCase())+"&ProjectName="+encodeURIComponent(prj);myself.showMessage("Fetching project\nfrom the cloud..."),SnapCloud.getPublicProject(id,function(projectData){var msg;Process.prototype.isCatchingErrors||window.open("data:text/xml,"+projectData),myself.nextSteps([function(){msg=myself.showMessage("Opening project...")},function(){nop()},function(){myself.rawOpenCloudDataString(projectData)},function(){msg.destroy()}])},myself.cloudError())},null,"project")},null,"project")},null,new Color(100,0,0))),menu.popup(world,pos)},IDE_Morph.prototype.settingsMenu=function(){function addPreference(label,toggle,test,onHint,offHint,hide){
var on="☑ ",off="☐ ";hide&&!shiftClicked||menu.addItem((test?on:off)+localize(label),toggle,test?onHint:offHint,hide?new Color(100,0,0):null)}var menu,stage=this.stage,world=this.world(),myself=this,pos=this.controlBar.settingsButton.bottomLeft(),shiftClicked=16===world.currentKey;menu=new MenuMorph(this),menu.addItem("Language...","languageMenu"),menu.addItem("Zoom blocks...","userSetBlocksScale"),menu.addItem("Stage size...","userSetStageSize"),shiftClicked&&menu.addItem("Dragging threshold...","userSetDragThreshold","specify the distance the hand has to move\nbefore it picks up an object",new Color(100,0,0)),menu.addLine(),isRetinaSupported()&&addPreference("Retina display support","toggleRetina",isRetinaEnabled(),"uncheck for lower resolution,\nsaves computing resources","check for higher resolution,\nuses more computing resources"),
addPreference("Input sliders","toggleInputSliders",MorphicPreferences.useSliderForInput,"uncheck to disable\ninput sliders for\nentry fields","check to enable\ninput sliders for\nentry fields"),MorphicPreferences.useSliderForInput&&addPreference("Execute on slider change","toggleSliderExecute",ArgMorph.prototype.executeOnSliderEdit,"uncheck to suppress\nrunning scripts\nwhen moving the slider","check to run\nthe edited script\nwhen moving the slider"),addPreference("Turbo mode","toggleFastTracking",this.stage.isFastTracked,"uncheck to run scripts\nat normal speed","check to prioritize\nscript execution"),addPreference("Visible stepping","toggleSingleStepping",Process.prototype.enableSingleStepping,"uncheck to turn off\nvisible stepping","check to turn on\n visible stepping (slow)",!1),
addPreference("Ternary Boolean slots",function(){BooleanSlotMorph.prototype.isTernary=!BooleanSlotMorph.prototype.isTernary},BooleanSlotMorph.prototype.isTernary,"uncheck to limit\nBoolean slots to true / false","check to allow\nempty Boolean slots",!0),addPreference("Camera support","toggleCameraSupport",CamSnapshotDialogMorph.prototype.enableCamera,"uncheck to disable\ncamera support","check to enable\ncamera support",!0),menu.addLine(),addPreference("Blurred shadows","toggleBlurredShadows",useBlurredShadows,"uncheck to use solid drop\nshadows and highlights","check to use blurred drop\nshadows and highlights",!0),addPreference("Zebra coloring","toggleZebraColoring",BlockMorph.prototype.zebraContrast,"uncheck to disable alternating\ncolors for nested block","check to enable alternating\ncolors for nested blocks",!0),
addPreference("Dynamic input labels","toggleDynamicInputLabels",SyntaxElementMorph.prototype.dynamicInputLabels,"uncheck to disable dynamic\nlabels for variadic inputs","check to enable dynamic\nlabels for variadic inputs",!0),addPreference("Prefer empty slot drops","togglePreferEmptySlotDrops",ScriptsMorph.prototype.isPreferringEmptySlots,"uncheck to allow dropped\nreporters to kick out others","settings menu prefer empty slots hint",!0),addPreference("Long form input dialog","toggleLongFormInputDialog",InputSlotDialogMorph.prototype.isLaunchingExpanded,"uncheck to use the input\ndialog in short form","check to always show slot\ntypes in the input dialog"),addPreference("Plain prototype labels","togglePlainPrototypeLabels",BlockLabelPlaceHolderMorph.prototype.plainLabel,"uncheck to always show (+) symbols\nin block prototype labels","check to hide (+) symbols\nin block prototype labels"),
addPreference("Virtual keyboard","toggleVirtualKeyboard",MorphicPreferences.useVirtualKeyboard,"uncheck to disable\nvirtual keyboard support\nfor mobile devices","check to enable\nvirtual keyboard support\nfor mobile devices",!0),addPreference("Clicking sound",function(){BlockMorph.prototype.toggleSnapSound(),BlockMorph.prototype.snapSound?myself.saveSetting("click",!0):myself.removeSetting("click")},BlockMorph.prototype.snapSound,"uncheck to turn\nblock clicking\nsound off","check to turn\nblock clicking\nsound on"),addPreference("Animations",function(){myself.isAnimating=!myself.isAnimating},myself.isAnimating,"uncheck to disable\nIDE animations","check to enable\nIDE animations",!0),
addPreference("Cache Inputs",function(){BlockMorph.prototype.isCachingInputs=!BlockMorph.prototype.isCachingInputs},BlockMorph.prototype.isCachingInputs,"uncheck to stop caching\ninputs (for debugging the evaluator)","check to cache inputs\nboosts recursion",!0),addPreference("Rasterize SVGs",function(){MorphicPreferences.rasterizeSVGs=!MorphicPreferences.rasterizeSVGs},MorphicPreferences.rasterizeSVGs,"uncheck for smooth\nscaling of vector costumes","check to rasterize\nSVGs on import",!0),addPreference("Flat design",function(){return MorphicPreferences.isFlat?myself.defaultDesign():void myself.flatDesign()},MorphicPreferences.isFlat,"uncheck for default\nGUI design","check for alternative\nGUI design",!1),
addPreference("Nested auto-wrapping",function(){ScriptsMorph.prototype.enableNestedAutoWrapping=!ScriptsMorph.prototype.enableNestedAutoWrapping,ScriptsMorph.prototype.enableNestedAutoWrapping?myself.removeSetting("autowrapping"):myself.saveSetting("autowrapping",!1)},ScriptsMorph.prototype.enableNestedAutoWrapping,"uncheck to confine auto-wrapping\nto top-level block stacks","check to enable auto-wrapping\ninside nested block stacks",!0),addPreference("Project URLs",function(){myself.projectsInURLs=!myself.projectsInURLs,myself.projectsInURLs?myself.saveSetting("longurls",!0):myself.removeSetting("longurls")},myself.projectsInURLs,"uncheck to disable\nproject data in URLs","check to enable\nproject data in URLs",!0),
addPreference("Sprite Nesting",function(){SpriteMorph.prototype.enableNesting=!SpriteMorph.prototype.enableNesting},SpriteMorph.prototype.enableNesting,"uncheck to disable\nsprite composition","check to enable\nsprite composition",!0),addPreference("First-Class Sprites",function(){SpriteMorph.prototype.enableFirstClass=!SpriteMorph.prototype.enableFirstClass,myself.currentSprite.blocksCache.sensing=null,myself.currentSprite.paletteCache.sensing=null,myself.refreshPalette()},SpriteMorph.prototype.enableFirstClass,"uncheck to disable support\nfor first-class sprites","check to enable support\n for first-class sprite",!0),addPreference("Keyboard Editing",function(){
ScriptsMorph.prototype.enableKeyboard=!ScriptsMorph.prototype.enableKeyboard,myself.currentSprite.scripts.updateToolbar(),ScriptsMorph.prototype.enableKeyboard?myself.removeSetting("keyboard"):myself.saveSetting("keyboard",!1)},ScriptsMorph.prototype.enableKeyboard,"uncheck to disable\nkeyboard editing support","check to enable\nkeyboard editing support",!0),addPreference("Table support",function(){List.prototype.enableTables=!List.prototype.enableTables,List.prototype.enableTables?myself.removeSetting("tables"):myself.saveSetting("tables",!1)},List.prototype.enableTables,"uncheck to disable\nmulti-column list views","check for multi-column\nlist view support",!0),
List.prototype.enableTables&&addPreference("Table lines",function(){TableMorph.prototype.highContrast=!TableMorph.prototype.highContrast,TableMorph.prototype.highContrast?myself.saveSetting("tableLines",!0):myself.removeSetting("tableLines")},TableMorph.prototype.highContrast,"uncheck for less contrast\nmulti-column list views","check for higher contrast\ntable views",!0),addPreference("Live coding support",function(){Process.prototype.enableLiveCoding=!Process.prototype.enableLiveCoding},Process.prototype.enableLiveCoding,"EXPERIMENTAL! uncheck to disable live\ncustom control structures","EXPERIMENTAL! check to enable\n live custom control structures",!0),menu.addLine(),
addPreference("Thread safe scripts",function(){stage.isThreadSafe=!stage.isThreadSafe},this.stage.isThreadSafe,"uncheck to allow\nscript reentrance","check to disallow\nscript reentrance"),addPreference("Prefer smooth animations","toggleVariableFrameRate",StageMorph.prototype.frameRate,"uncheck for greater speed\nat variable frame rates","check for smooth, predictable\nanimations across computers",!0),addPreference("Flat line ends",function(){SpriteMorph.prototype.useFlatLineEnds=!SpriteMorph.prototype.useFlatLineEnds},SpriteMorph.prototype.useFlatLineEnds,"uncheck for round ends of lines","check for flat ends of lines"),addPreference("Codification support",function(){
StageMorph.prototype.enableCodeMapping=!StageMorph.prototype.enableCodeMapping,myself.currentSprite.blocksCache.variables=null,myself.currentSprite.paletteCache.variables=null,myself.refreshPalette()},StageMorph.prototype.enableCodeMapping,"uncheck to disable\nblock to text mapping features","check for block\nto text mapping features",!1),addPreference("Inheritance support",function(){StageMorph.prototype.enableInheritance=!StageMorph.prototype.enableInheritance,myself.currentSprite.blocksCache.variables=null,myself.currentSprite.paletteCache.variables=null,myself.refreshPalette()},StageMorph.prototype.enableInheritance,"uncheck to disable\nsprite inheritance features","check for sprite\ninheritance features",!1),
addPreference("Persist linked sublist IDs",function(){StageMorph.prototype.enableSublistIDs=!StageMorph.prototype.enableSublistIDs},StageMorph.prototype.enableSublistIDs,"uncheck to disable\nsaving linked sublist identities","check to enable\nsaving linked sublist identities",!0),menu.popup(world,pos)},IDE_Morph.prototype.projectMenu=function(){var menu,myself=this,world=this.world(),pos=this.controlBar.projectButton.bottomLeft(),graphicsName=this.currentSprite instanceof SpriteMorph?"Costumes":"Backgrounds",shiftClicked=16===world.currentKey;menu=new MenuMorph(this),menu.addItem("Project notes...","editProjectNotes"),menu.addLine(),menu.addPair("New","createNewProject","^N"),
menu.addPair("Open...","openProjectsBrowser","^O"),menu.addPair("Save","save","^S"),menu.addItem("Save As...","saveProjectsBrowser"),menu.addLine(),menu.addItem("Import...",function(){var inp=document.createElement("input");myself.filePicker&&(document.body.removeChild(myself.filePicker),myself.filePicker=null),inp.type="file",inp.style.color="transparent",inp.style.backgroundColor="transparent",inp.style.border="none",inp.style.outline="none",inp.style.position="absolute",inp.style.top="0px",inp.style.left="0px",inp.style.width="0px",inp.style.height="0px",inp.style.display="none",inp.addEventListener("change",function(){document.body.removeChild(inp),myself.filePicker=null,
world.hand.processDrop(inp.files)},!1),document.body.appendChild(inp),myself.filePicker=inp,inp.click()},"file menu import hint"),shiftClicked&&menu.addItem(localize("Export project...")+" "+localize("(in a new window)"),function(){myself.projectName?myself.exportProject(myself.projectName,shiftClicked):myself.prompt("Export Project As...",function(name){myself.exportProject(name,!1)},null,"exportProject")},"show project data as XML\nin a new browser window",new Color(100,0,0)),menu.addItem(shiftClicked?"Export project as plain text...":"Export project...",function(){myself.projectName?myself.exportProject(myself.projectName,shiftClicked):myself.prompt("Export Project As...",function(name){
myself.exportProject(name,shiftClicked)},null,"exportProject")},"save project data as XML\nto your downloads folder",shiftClicked?new Color(100,0,0):null),this.stage.globalBlocks.length&&(menu.addItem("Export blocks...",function(){myself.exportGlobalBlocks()},"show global custom block definitions as XML\nin a new browser window"),menu.addItem("Unused blocks...",function(){myself.removeUnusedBlocks()},"find unused global custom blocks\nand remove their definitions")),menu.addItem("Export summary...",function(){myself.exportProjectSummary()},"open a new browser browser window\n with a summary of this project"),shiftClicked&&(menu.addItem("Export summary with drop-shadows...",function(){
myself.exportProjectSummary(!0)},"open a new browser browser window\nwith a summary of this project\nwith drop-shadows on all pictures.\nnot supported by all browsers",new Color(100,0,0)),menu.addItem("Export all scripts as pic...",function(){myself.exportScriptsPicture()},"show a picture of all scripts\nand block definitions",new Color(100,0,0))),menu.addLine(),menu.addItem("Import tools",function(){myself.getURL(myself.resourceURL("tools.xml"),function(txt){myself.droppedText(txt,"tools")})},"load the official library of\npowerful blocks"),menu.addItem("Libraries...",function(){myself.getURL(myself.resourceURL("libraries","LIBRARIES"),function(txt){var libraries=myself.parseResourceFile(txt);
new LibraryImportDialogMorph(myself,libraries).popUp()})},"Select categories of additional blocks to add to this project."),menu.addItem(localize(graphicsName)+"...",function(){myself.importMedia(graphicsName)},"Select a costume from the media library"),menu.addItem(localize("Sounds")+"...",function(){myself.importMedia("Sounds")},"Select a sound from the media library"),menu.popup(world,pos)},IDE_Morph.prototype.resourceURL=function(){var args=Array.prototype.slice.call(arguments,0);return args.join("/")},IDE_Morph.prototype.getMediaList=function(dirname,callback){function alphabetically(x,y){return x.name.toLowerCase()<y.name.toLowerCase()?-1:1}var data,url=this.resourceURL(dirname,dirname.toUpperCase()),async=callback instanceof Function,myself=this;
return async?void this.getURL(url,function(txt){var data=myself.parseResourceFile(txt);data.sort(alphabetically),callback.call(this,data)}):(data=this.parseResourceFile(this.getURL(url)),data.sort(alphabetically),data)},IDE_Morph.prototype.parseResourceFile=function(text){var parts,items=[];return text.split("\n").map(function(line){return line.trim()}).filter(function(line){return line.length>0}).forEach(function(line){parts=line.split("\t").map(function(str){return str.trim()}),parts.length<2||items.push({fileName:parts[0],name:parts[1],description:parts.length>2?parts[2]:""})}),items},IDE_Morph.prototype.importMedia=function(folderName){var myself=this,msg=this.showMessage("Opening "+folderName+"...");
this.getMediaList(folderName,function(items){msg.destroy(),myself.popupMediaImportDialog(folderName,items)})},IDE_Morph.prototype.popupMediaImportDialog=function(folderName,items){var handle,dialog=(new DialogBoxMorph).withKey("import"+folderName),frame=new ScrollFrameMorph,selectedIcon=null,turtle=new SymbolMorph("turtle",60),myself=this,world=this.world();frame.acceptsDrops=!1,frame.contents.acceptsDrops=!1,frame.color=myself.groupColor,frame.fixLayout=nop,dialog.labelString=folderName,dialog.createLabel(),dialog.addBody(frame),dialog.addButton("ok","Import"),dialog.addButton("cancel","Cancel"),dialog.ok=function(){selectedIcon&&(selectedIcon.object instanceof Sound?myself.droppedAudio(selectedIcon.object.copy().audio,selectedIcon.labelString):selectedIcon.object instanceof SVG_Costume?myself.droppedSVG(selectedIcon.object.contents,selectedIcon.labelString):myself.droppedImage(selectedIcon.object.contents,selectedIcon.labelString));
},dialog.fixLayout=function(){var fp,fw,th=fontHeight(this.titleFontSize)+2*this.titlePadding,x=0,y=0;this.buttons.fixLayout(),this.body.setPosition(this.position().add(new Point(this.padding,th+this.padding))),this.body.setExtent(new Point(this.width()-2*this.padding,this.height()-3*this.padding-th-this.buttons.height())),fp=this.body.position(),fw=this.body.width(),frame.contents.children.forEach(function(icon){icon.setPosition(fp.add(new Point(x,y))),x+=icon.width(),x+icon.width()>fw&&(x=0,y+=icon.height())}),frame.contents.adjustBounds(),this.label.setCenter(this.center()),this.label.setTop(this.top()+(th-this.label.height())/2),this.buttons.setCenter(this.center()),
this.buttons.setBottom(this.bottom()-this.padding)},items.forEach(function(item){var cstTemplate,sndTemplate,icon,url=myself.resourceURL(folderName,item.fileName),img=new Image,suffix=url.slice(url.lastIndexOf(".")+1).toLowerCase(),isSVG="svg"===suffix&&!MorphicPreferences.rasterizeSVGs,isSound=contains(["wav","mp3"],suffix);isSound?sndTemplate=icon=new SoundIconMorph(new Sound(new Audio,item.name),sndTemplate):cstTemplate=icon=new CostumeIconMorph(new Costume(turtle.image,item.name),cstTemplate),icon.isDraggable=!1,icon.userMenu=nop,icon.action=function(){if(selectedIcon!==icon){var prevSelected=selectedIcon;selectedIcon=icon,prevSelected&&prevSelected.refresh();
}},icon.doubleClickAction=dialog.ok,icon.query=function(){return icon===selectedIcon},frame.addContents(icon),isSound?(icon.object.audio.onloadeddata=function(){icon.createThumbnail(),icon.fixLayout(),icon.refresh()},icon.object.audio.src=url,icon.object.audio.load()):isSVG?(img.onload=function(){icon.object=new SVG_Costume(img,item.name),icon.refresh()},myself.getURL(url,function(txt){img.src="data:image/svg+xml;base64,"+window.btoa(txt)})):(img.onload=function(){var canvas=newCanvas(new Point(img.width,img.height),!0);canvas.getContext("2d").drawImage(img,0,0),icon.object=new Costume(canvas,item.name),icon.refresh()},img.src=url)}),dialog.popUp(world),dialog.setExtent(new Point(400,300)),
dialog.setCenter(world.center()),dialog.drawNew(),handle=new HandleMorph(dialog,300,280,dialog.corner,dialog.corner)},IDE_Morph.prototype.aboutSnap=function(){var dlg,aboutTxt,noticeTxt,creditsTxt,translations,module,btn1,btn2,btn3,btn4,licenseBtn,translatorsBtn,versions="",world=this.world();aboutTxt="Snap! 4.1.1 - dev -\nBuild Your Own Blocks\n\nCopyright Ⓒ 2017 Jens Mönig and Brian Harvey\njens@moenig.org, bh@cs.berkeley.edu\n\nSnap! is developed by the University of California, Berkeley\n          with support from the National Science Foundation (NSF), MioSoft,          \nthe Communications Design Group (CDG) at SAP Labs, and the\nHuman Advancement Research Community (HARC) at YC Research.\nThe design of Snap! is influenced and inspired by Scratch,\nfrom the Lifelong Kindergarten group at the MIT Media Lab\n\nfor more information see http://snap.berkeley.edu\nand http://scratch.mit.edu",
noticeTxt=localize("License")+"\n\nSnap! is free software: you can redistribute it and/or modify\nit under the terms of the GNU Affero General Public License as\npublished by the Free Software Foundation, either version 3 of\nthe License, or (at your option) any later version.\n\nThis program is distributed in the hope that it will be useful,\nbut WITHOUT ANY WARRANTY; without even the implied warranty of\nMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\nGNU Affero General Public License for more details.\n\nYou should have received a copy of the\nGNU Affero General Public License along with this program.\nIf not, see http://www.gnu.org/licenses/\n\nWant to use Snap! but scared by the open-source license?\nGet in touch with us, we'll make it work.",
creditsTxt=localize("Contributors")+'\n\nNathan Dinsmore: Saving/Loading, Snap-Logo Design, \ncountless bugfixes and optimizations\nKartik Chandra: Paint Editor\nMichael Ball: Time/Date UI, Library Import Dialog,\ncountless bugfixes and optimizations\nBartosz Leper: Retina Display Support\nBernat Romagosa: Countless contributions\n"Ava" Yuan Yuan, Dylan Servilla: Graphic Effects\nKyle Hotchkiss: Block search design\nBrian Broll: Many bugfixes and optimizations\nIan Reynolds: UI Design, Event Bindings, Sound primitives\nIvan Motyashov: Initial Squeak Porting\nLucas Karahadian: Piano Keyboard Design\nDavide Della Casa: Morphic Optimizations\nAchal Dave: Web Audio\nJoe Otto: Morphic Testing and Debugging';
for(module in modules)Object.prototype.hasOwnProperty.call(modules,module)&&(versions+="\n"+module+" ("+modules[module]+")");""!==versions&&(versions=localize("current module versions:")+" \n\nmorphic ("+morphicVersion+")"+versions),translations=localize("Translations")+"\n"+SnapTranslator.credits(),dlg=new DialogBoxMorph,dlg.inform("About Snap",aboutTxt,world),btn1=dlg.buttons.children[0],translatorsBtn=dlg.addButton(function(){dlg.body.text=translations,dlg.body.drawNew(),btn1.show(),btn2.show(),btn3.hide(),btn4.hide(),licenseBtn.hide(),translatorsBtn.hide(),dlg.fixLayout(),dlg.drawNew(),dlg.setCenter(world.center())},"Translators..."),btn2=dlg.addButton(function(){
dlg.body.text=aboutTxt,dlg.body.drawNew(),btn1.show(),btn2.hide(),btn3.show(),btn4.show(),licenseBtn.show(),translatorsBtn.hide(),dlg.fixLayout(),dlg.drawNew(),dlg.setCenter(world.center())},"Back..."),btn2.hide(),licenseBtn=dlg.addButton(function(){dlg.body.text=noticeTxt,dlg.body.drawNew(),btn1.show(),btn2.show(),btn3.hide(),btn4.hide(),licenseBtn.hide(),translatorsBtn.hide(),dlg.fixLayout(),dlg.drawNew(),dlg.setCenter(world.center())},"License..."),btn3=dlg.addButton(function(){dlg.body.text=versions,dlg.body.drawNew(),btn1.show(),btn2.show(),btn3.hide(),btn4.hide(),licenseBtn.hide(),translatorsBtn.hide(),dlg.fixLayout(),dlg.drawNew(),dlg.setCenter(world.center());
},"Modules..."),btn4=dlg.addButton(function(){dlg.body.text=creditsTxt,dlg.body.drawNew(),btn1.show(),btn2.show(),translatorsBtn.show(),btn3.hide(),btn4.hide(),licenseBtn.hide(),dlg.fixLayout(),dlg.drawNew(),dlg.setCenter(world.center())},"Credits..."),translatorsBtn.hide(),dlg.fixLayout(),dlg.drawNew()},IDE_Morph.prototype.editProjectNotes=function(){var dialog=(new DialogBoxMorph).withKey("projectNotes"),frame=new ScrollFrameMorph,text=new TextMorph(this.projectNotes||""),ok=dialog.ok,myself=this,size=250,world=this.world();frame.padding=6,frame.setWidth(size),frame.acceptsDrops=!1,frame.contents.acceptsDrops=!1,text.setWidth(size-2*frame.padding),text.setPosition(frame.topLeft().add(frame.padding)),
text.enableSelecting(),text.isEditable=!0,frame.setHeight(size),frame.fixLayout=nop,frame.edge=InputFieldMorph.prototype.edge,frame.fontSize=InputFieldMorph.prototype.fontSize,frame.typeInPadding=InputFieldMorph.prototype.typeInPadding,frame.contrast=InputFieldMorph.prototype.contrast,frame.drawNew=InputFieldMorph.prototype.drawNew,frame.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,frame.addContents(text),text.drawNew(),dialog.ok=function(){myself.projectNotes=text.text,ok.call(this)},dialog.justDropped=function(){text.edit()},dialog.labelString="Project Notes",dialog.createLabel(),dialog.addBody(frame),frame.drawNew(),dialog.addButton("ok","OK"),dialog.addButton("cancel","Cancel"),
dialog.fixLayout(),dialog.drawNew(),dialog.popUp(world),dialog.setCenter(world.center()),text.edit()},IDE_Morph.prototype.newProject=function(){this.source=SnapCloud.username?"cloud":"local",this.stage&&this.stage.destroy(),"#lang:"!==location.hash.substr(0,6)&&(location.hash=""),this.globalVariables=new VariableFrame,this.currentSprite=new SpriteMorph(this.globalVariables),this.sprites=new List([this.currentSprite]),StageMorph.prototype.dimensions=new Point(480,360),StageMorph.prototype.hiddenPrimitives={},StageMorph.prototype.codeMappings={},StageMorph.prototype.codeHeaders={},StageMorph.prototype.enableCodeMapping=!1,StageMorph.prototype.enableInheritance=!0,
StageMorph.prototype.enableSublistIDs=!1,SpriteMorph.prototype.useFlatLineEnds=!1,Process.prototype.enableLiveCoding=!1,this.setProjectName(""),this.projectNotes="",this.createStage(),this.add(this.stage),this.createCorral(),this.selectSprite(this.stage.children[0]),this.fixLayout()},IDE_Morph.prototype.save=function(){"examples"===this.source&&(this.source="local"),this.projectName?"local"===this.source?this.saveProject(this.projectName):this.saveProjectToCloud(this.projectName):this.saveProjectsBrowser()},IDE_Morph.prototype.saveProject=function(name){var myself=this;this.nextSteps([function(){myself.showMessage("Saving...")},function(){myself.rawSaveProject(name);
}])},IDE_Morph.prototype.rawSaveProject=function(name){var str;if(name)if(this.setProjectName(name),Process.prototype.isCatchingErrors)try{localStorage["-snap-project-"+name]=str=this.serializer.serialize(this.stage),this.setURL("#open:"+str),this.showMessage("Saved!",1)}catch(err){this.showMessage("Save failed: "+err)}else localStorage["-snap-project-"+name]=str=this.serializer.serialize(this.stage),this.setURL("#open:"+str),this.showMessage("Saved!",1)},IDE_Morph.prototype.exportProject=function(name,plain){var menu,str,dataPrefix;if(name){this.setProjectName(name),dataPrefix="plain,";try{menu=this.showMessage("Exporting"),str=this.serializer.serialize(this.stage),
this.setURL("#open:"+dataPrefix+encodeURIComponent(str)),this.saveXMLAs(str,name),menu.destroy(),this.showMessage("Exported!",1)}catch(err){if(!Process.prototype.isCatchingErrors)throw err;this.showMessage("Export failed: "+err)}}},IDE_Morph.prototype.exportGlobalBlocks=function(){this.stage.globalBlocks.length>0?new BlockExportDialogMorph(this.serializer,this.stage.globalBlocks).popUp(this.world()):this.inform("Export blocks","this project doesn't have any\ncustom global blocks yet")},IDE_Morph.prototype.removeUnusedBlocks=function(){function scan(){return globalBlocks.filter(function(def){return!contains(unused,def)&&targets.every(function(each,trgIdx){return!each.usesBlockInstance(def,!0,trgIdx,unused);
})})}for(var found,targets=this.sprites.asArray().concat([this.stage]),globalBlocks=this.stage.globalBlocks,unused=[],isDone=!1;!isDone;)found=scan(),found.length?unused=unused.concat(found):isDone=!0;unused.length>0?new BlockRemovalDialogMorph(unused,this.stage).popUp(this.world()):this.inform("Remove unused blocks","there are currently no unused\nglobal custom blocks in this project")},IDE_Morph.prototype.exportSprite=function(sprite){var str=this.serializer.serialize(sprite.allParts());str='<sprites app="'+this.serializer.app+'" version="'+this.serializer.version+'">'+str+"</sprites>",this.saveXMLAs(str,sprite.name)},IDE_Morph.prototype.exportScriptsPicture=function(){
var pic,ctx,pics=[],padding=20,w=0,h=0,y=0;this.sprites.asArray().forEach(function(sprite){pics.push(sprite.image),pics.push(sprite.scripts.scriptsPicture()),sprite.customBlocks.forEach(function(def){pics.push(def.scriptsPicture())})}),pics.push(this.stage.image),pics.push(this.stage.scripts.scriptsPicture()),this.stage.customBlocks.forEach(function(def){pics.push(def.scriptsPicture())}),this.stage.globalBlocks.forEach(function(def){pics.push(def.scriptsPicture())}),pics=pics.filter(function(each){return!isNil(each)}),pics.forEach(function(each){w=Math.max(w,each.width),h+=each.height,h+=padding}),h-=padding,pic=newCanvas(new Point(w,h)),ctx=pic.getContext("2d"),
pics.forEach(function(each){ctx.drawImage(each,0,y),y+=padding,y+=each.height}),this.saveCanvasAs(pic,this.projectName||localize("Untitled"))},IDE_Morph.prototype.exportProjectSummary=function(useDropShadows){function addNode(tag,node,contents){return node||(node=body),new XML_Element(tag,contents,node)}function add(contents,tag,node){return tag||(tag="p"),node||(node=body),new XML_Element(tag,contents,node)}function addImage(canvas,node,inline){node||(node=body);var para=inline?null:addNode("p",node),pic=addNode("img",para||node);return pic.attributes.src=canvas.toDataURL(),pic}function addVariables(varFrame){var ul,names=varFrame.names().sort(),isFirst=!0;names.length&&(add(localize("Variables"),"h3"),
names.forEach(function(name){var watcher,listMorph,li,img;isFirst&&(ul=addNode("ul"),isFirst=!1),li=addNode("li",ul),watcher=new WatcherMorph(name,SpriteMorph.prototype.blockColor.variables,varFrame,name),listMorph=watcher.cellMorph.contentsMorph,listMorph instanceof ListWatcherMorph&&listMorph.expand(),img=addImage(watcher.fullImageClassic(),li),img.attributes.class="script"}))}function addBlocks(definitions){definitions.length&&(add(localize("Blocks"),"h3"),SpriteMorph.prototype.categories.forEach(function(category){var ul,isFirst=!0;definitions.forEach(function(def){var li,blockImg;def.category===category&&(isFirst&&(add(localize(category[0].toUpperCase().concat(category.slice(1))),"h4"),
ul=addNode("ul"),isFirst=!1),li=addNode("li",ul),blockImg=addImage(def.templateInstance().scriptPic(),li),blockImg.attributes.class="script",def.sortedElements().forEach(function(script){var defImg=addImage(script instanceof BlockMorph?script.scriptPic():script.fullImageClassic(),li);defImg.attributes.class="script"}))})}))}var html,head,meta,css,body,pname,notes,toc,globalVars,stage=this.stage;pname=this.projectName||localize("untitled"),html=new XML_Element("html"),html.attributes.lang=SnapTranslator.language,head=addNode("head",html),meta=addNode("meta",head),meta.attributes.charset="UTF-8",css=useDropShadows?"img {vertical-align: top;filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));-webkit-filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));-ms-filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));}.toc {vertical-align: middle;padding: 2px 1em 2px 1em;}":"img {vertical-align: top;}.toc {vertical-align: middle;padding: 2px 1em 2px 1em;}.sprite {border: 1px solid lightgray;}",
addNode("style",head,css),add(pname,"title",head),body=addNode("body",html),add(pname,"h1"),0===location.hash.indexOf("#present:")?(add(location.toString(),"a",body).attributes.href=location.toString(),addImage(stage.thumbnail(stage.dimensions)).attributes.class="sprite",add(this.serializer.app,"h4")):(add(this.serializer.app,"h4"),addImage(stage.thumbnail(stage.dimensions)).attributes.class="sprite"),notes=Process.prototype.reportTextSplit(this.projectNotes,"line"),notes.asArray().forEach(function(paragraph){add(paragraph)}),add(localize("Contents"),"h4"),toc=addNode("ul"),this.sprites.asArray().concat([stage]).forEach(function(sprite){var pic,ol,tocEntry=addNode("li",toc),scripts=sprite.scripts.sortedElements(),cl=sprite.costumes.length();
addNode("hr"),addImage(sprite.thumbnail(new Point(40,40)),tocEntry,!0).attributes.class="toc",add(sprite.name,"a",tocEntry).attributes.href="#"+sprite.name,add(sprite.name,"h2").attributes.id=sprite.name,pic=addImage(sprite.thumbnail(sprite.extent().divideBy(stage.scale))),pic.attributes.class="sprite",sprite instanceof SpriteMorph&&(sprite.exemplar&&(addImage(sprite.exemplar.thumbnail(new Point(40,40)),add(localize("Kind of")+" "+sprite.exemplar.name),!0).attributes.class="toc"),sprite.anchor&&(addImage(sprite.anchor.thumbnail(new Point(40,40)),add(localize("Part of")+" "+sprite.anchor.name),!0).attributes.class="toc"),sprite.parts.length&&(add(localize("Parts"),"h3"),
ol=addNode("ul"),sprite.parts.forEach(function(part){var li=addNode("li",ol,part.name);addImage(part.thumbnail(new Point(40,40)),li,!0).attributes.class="toc"}))),(cl>1||sprite.getCostumeIdx()!==cl)&&(add(localize("Costumes"),"h3"),ol=addNode("ol"),sprite.costumes.asArray().forEach(function(costume){var li=addNode("li",ol,costume.name);addImage(costume.thumbnail(new Point(40,40)),li,!0).attributes.class="toc"})),sprite.sounds.length()&&(add(localize("Sounds"),"h3"),ol=addNode("ol"),sprite.sounds.asArray().forEach(function(sound){add(sound.name,"li",ol)})),addVariables(sprite.variables),scripts.length&&(add(localize("Scripts"),"h3"),scripts.forEach(function(script){
var img=addImage(script instanceof BlockMorph?script.scriptPic():script.fullImageClassic());img.attributes.class="script"})),addBlocks(sprite.customBlocks)}),globalVars=stage.globalVariables(),(Object.keys(globalVars.vars).length||stage.globalBlocks.length)&&(addNode("hr"),add(localize("For all Sprites"),"a",addNode("li",toc)).attributes.href="#global",add(localize("For all Sprites"),"h2").attributes.id="global",addVariables(globalVars),addBlocks(stage.globalBlocks)),this.saveFileAs("<!DOCTYPE html>"+html.toString(),"text/html;charset=utf-8",pname)},IDE_Morph.prototype.openProjectString=function(str){var msg,myself=this;this.nextSteps([function(){msg=myself.showMessage("Opening project...");
},function(){nop()},function(){myself.rawOpenProjectString(str)},function(){msg.destroy()}])},IDE_Morph.prototype.rawOpenProjectString=function(str){if(this.toggleAppMode(!1),this.spriteBar.tabBar.tabTo("scripts"),StageMorph.prototype.hiddenPrimitives={},StageMorph.prototype.codeMappings={},StageMorph.prototype.codeHeaders={},StageMorph.prototype.enableCodeMapping=!1,StageMorph.prototype.enableInheritance=!0,StageMorph.prototype.enableSublistIDs=!1,Process.prototype.enableLiveCoding=!1,Process.prototype.isCatchingErrors)try{this.serializer.openProject(this.serializer.load(str,this),this)}catch(err){this.showMessage("Load failed: "+err)}else this.serializer.openProject(this.serializer.load(str,this),this);
this.stopFastTracking(),getSnapProjectScript=str,config.customSnapContext.trigger("rawDefinitionChange",[str]),importString=str,config.snapScript=str},IDE_Morph.prototype.openBlocksString=function(str,name,silently){var msg,myself=this;this.nextSteps([function(){msg=myself.showMessage("Opening blocks...")},function(){nop()},function(){myself.rawOpenBlocksString(str,name,silently)},function(){msg.destroy()}])},IDE_Morph.prototype.rawOpenBlocksString=function(str,name,silently){var blocks,myself=this;if(Process.prototype.isCatchingErrors)try{blocks=this.serializer.loadBlocks(str,myself.stage)}catch(err){this.showMessage("Load failed: "+err)}else blocks=this.serializer.loadBlocks(str,myself.stage);
silently?(blocks.forEach(function(def){def.receiver=myself.stage,myself.stage.globalBlocks.push(def),myself.stage.replaceDoubleDefinitionsFor(def)}),this.flushPaletteCache(),this.refreshPalette(),this.showMessage("Imported Blocks Module"+(name?": "+name:"")+".",2)):new BlockImportDialogMorph(blocks,this.stage,name).popUp()},IDE_Morph.prototype.openSpritesString=function(str){var msg,myself=this;this.nextSteps([function(){msg=myself.showMessage("Opening sprite...")},function(){nop()},function(){myself.rawOpenSpritesString(str)},function(){msg.destroy()}])},IDE_Morph.prototype.rawOpenSpritesString=function(str){if(Process.prototype.isCatchingErrors)try{this.serializer.loadSprites(str,this);
}catch(err){this.showMessage("Load failed: "+err)}else this.serializer.loadSprites(str,this)},IDE_Morph.prototype.openMediaString=function(str){if(Process.prototype.isCatchingErrors)try{this.serializer.loadMedia(str)}catch(err){this.showMessage("Load failed: "+err)}else this.serializer.loadMedia(str);this.showMessage("Imported Media Module.",2)},IDE_Morph.prototype.openScriptString=function(str){var msg,myself=this;this.nextSteps([function(){msg=myself.showMessage("Opening script...")},function(){nop()},function(){myself.rawOpenScriptString(str)},function(){msg.destroy()}])},IDE_Morph.prototype.rawOpenScriptString=function(str){var xml,script,scripts=this.currentSprite.scripts;
if(Process.prototype.isCatchingErrors)try{xml=this.serializer.parse(str,this.currentSprite),script=this.serializer.loadScript(xml,this.currentSprite)}catch(err){this.showMessage("Load failed: "+err)}else xml=this.serializer.loadScript(str,this.currentSprite),script=this.serializer.loadScript(xml,this.currentSprite);script.setPosition(this.world().hand.position()),scripts.add(script),scripts.adjustBounds(),scripts.lastDroppedBlock=script,scripts.recordDrop({origin:this.palette,position:this.palette.center()}),this.showMessage("Imported Script.",2)},IDE_Morph.prototype.openProject=function(name){var str;name&&(this.showMessage("opening project\n"+name),this.setProjectName(name),
str=localStorage["-snap-project-"+name],this.openProjectString(str),this.setURL("#open:"+str))},IDE_Morph.prototype.setURL=function(str){this.projectsInURLs&&(location.hash=str)},IDE_Morph.prototype.saveFileAs=function(contents,fileType,fileName){function dataURItoBlob(text,mimeType){var i,data=text,components=text.split(","),hasTypeStr=0===text.indexOf("data:");if(hasTypeStr&&components[0].indexOf("base64")>-1)for(text=atob(components[1]),data=new Uint8Array(text.length),i=text.length;i--;)data[i]=text.charCodeAt(i);return new Blob([data],{type:mimeType})}var fileExt,dialog,blobIsSupported=!1,world=this.world();fileExt=fileType.split("/")[1].split(";")[0],fileExt="."+("plain"===fileExt?"txt":fileExt);
try{blobIsSupported=!!new Blob}catch(e){}blobIsSupported?(contents instanceof Blob||(contents=dataURItoBlob(contents,fileType)),saveAs(contents,fileName+fileExt,!1)):(dialog=new DialogBoxMorph,dialog.inform(localize("Could not export")+" "+fileName,"unable to export text",world),dialog.fixLayout(),dialog.drawNew())},IDE_Morph.prototype.saveCanvasAs=function(canvas,fileName){this.saveFileAs(canvas.toDataURL(),"image/png",fileName)},IDE_Morph.prototype.saveXMLAs=function(xml,fileName){this.saveFileAs(xml,"text/xml;chartset=utf-8",fileName)},IDE_Morph.prototype.switchToUserMode=function(){var world=this.world();world.isDevMode=!1,Process.prototype.isCatchingErrors=!0,
this.controlBar.updateLabel(),this.isAutoFill=!0,this.isDraggable=!1,this.reactToWorldResize(world.bounds.copy()),this.siblings().forEach(function(morph){morph instanceof DialogBoxMorph?world.add(morph):morph.destroy()}),this.flushBlocksCache(),this.refreshPalette(),world.reactToDropOf=function(morph){morph instanceof DialogBoxMorph||(world.hand.grabOrigin?morph.slideBackTo(world.hand.grabOrigin):world.hand.grab(morph))},this.showMessage("entering user mode",1)},IDE_Morph.prototype.switchToDevMode=function(){var world=this.world();world.isDevMode=!0,Process.prototype.isCatchingErrors=!1,this.controlBar.updateLabel(),this.isAutoFill=!1,this.isDraggable=!0,this.setExtent(world.extent().subtract(100)),
this.setPosition(world.position().add(20)),this.flushBlocksCache(),this.refreshPalette(),delete world.reactToDropOf,this.showMessage("entering development mode.\n\nerror catching is turned off,\nuse the browser's web console\nto see error messages.")},IDE_Morph.prototype.flushBlocksCache=function(category){category?(this.stage.blocksCache[category]=null,this.stage.children.forEach(function(m){m instanceof SpriteMorph&&(m.blocksCache[category]=null)})):(this.stage.blocksCache={},this.stage.children.forEach(function(m){m instanceof SpriteMorph&&(m.blocksCache={})})),this.flushPaletteCache(category)},IDE_Morph.prototype.flushPaletteCache=function(category){category?(this.stage.paletteCache[category]=null,
this.stage.children.forEach(function(m){m instanceof SpriteMorph&&(m.paletteCache[category]=null)})):(this.stage.paletteCache={},this.stage.children.forEach(function(m){m instanceof SpriteMorph&&(m.paletteCache={})}))},IDE_Morph.prototype.toggleZebraColoring=function(){var scripts=[];BlockMorph.prototype.zebraContrast?BlockMorph.prototype.zebraContrast=0:BlockMorph.prototype.zebraContrast=40,this.stage.children.concat(this.stage).forEach(function(morph){isSnapObject(morph)&&(scripts=scripts.concat(morph.scripts.children.filter(function(morph){return morph instanceof BlockMorph})))}),scripts.forEach(function(topBlock){topBlock.fixBlockColor(null,!0)})},IDE_Morph.prototype.toggleDynamicInputLabels=function(){
var projectData;if(SyntaxElementMorph.prototype.dynamicInputLabels=!SyntaxElementMorph.prototype.dynamicInputLabels,Process.prototype.isCatchingErrors)try{projectData=this.serializer.serialize(this.stage)}catch(err){this.showMessage("Serialization failed: "+err)}else projectData=this.serializer.serialize(this.stage);SpriteMorph.prototype.initBlocks(),this.spriteBar.tabBar.tabTo("scripts"),this.createCategories(),this.createCorralBar(),this.openProjectString(projectData)},IDE_Morph.prototype.toggleBlurredShadows=function(){window.useBlurredShadows=!useBlurredShadows},IDE_Morph.prototype.toggleLongFormInputDialog=function(){InputSlotDialogMorph.prototype.isLaunchingExpanded=!InputSlotDialogMorph.prototype.isLaunchingExpanded,
InputSlotDialogMorph.prototype.isLaunchingExpanded?this.saveSetting("longform",!0):this.removeSetting("longform")},IDE_Morph.prototype.togglePlainPrototypeLabels=function(){BlockLabelPlaceHolderMorph.prototype.plainLabel=!BlockLabelPlaceHolderMorph.prototype.plainLabel,BlockLabelPlaceHolderMorph.prototype.plainLabel?this.saveSetting("plainprototype",!0):this.removeSetting("plainprototype")},IDE_Morph.prototype.togglePreferEmptySlotDrops=function(){ScriptsMorph.prototype.isPreferringEmptySlots=!ScriptsMorph.prototype.isPreferringEmptySlots},IDE_Morph.prototype.toggleVirtualKeyboard=function(){MorphicPreferences.useVirtualKeyboard=!MorphicPreferences.useVirtualKeyboard;
},IDE_Morph.prototype.toggleInputSliders=function(){MorphicPreferences.useSliderForInput=!MorphicPreferences.useSliderForInput},IDE_Morph.prototype.toggleSliderExecute=function(){ArgMorph.prototype.executeOnSliderEdit=!ArgMorph.prototype.executeOnSliderEdit},IDE_Morph.prototype.toggleAppMode=function(appMode){var world=this.world(),elements=[this.logo,this.controlBar.cloudButton,this.controlBar.projectButton,this.controlBar.settingsButton,this.controlBar.steppingButton,this.controlBar.stageSizeButton,this.paletteHandle,this.stageHandle,this.corral,this.corralBar,this.spriteEditor,this.spriteBar,this.palette,this.categories];this.isAppMode=isNil(appMode)?!this.isAppMode:appMode,
Morph.prototype.trackChanges=!1,this.isAppMode?(this.wasSingleStepping=Process.prototype.enableSingleStepping,this.wasSingleStepping&&this.toggleSingleStepping(),this.setColor(this.appModeColor),this.controlBar.setColor(this.color),this.controlBar.appModeButton.refresh(),elements.forEach(function(e){e.hide()}),world.children.forEach(function(morph){morph instanceof DialogBoxMorph&&morph.hide()}),world.keyboardReceiver instanceof ScriptFocusMorph&&world.keyboardReceiver.stopEditing()):(this.wasSingleStepping&&!Process.prototype.enableSingleStepping&&this.toggleSingleStepping(),this.setColor(this.backgroundColor),this.controlBar.setColor(this.frameColor),elements.forEach(function(e){
e.show()}),this.stage.setScale(1),world.children.forEach(function(morph){morph instanceof DialogBoxMorph&&morph.show()}),world.allChildren().filter(function(c){return c instanceof ScrollFrameMorph}).forEach(function(s){s.adjustScrollBars()}),this.currentSprite===this.stage&&this.spriteBar.children.forEach(function(child){child instanceof PushButtonMorph&&child.hide()}),this.currentSprite.scripts.updateToolbar()),this.setExtent(this.world().extent())},IDE_Morph.prototype.toggleStageSize=function(isSmall,forcedRatio){function toggle(){myself.isSmallStage=isNil(isSmall)?!myself.isSmallStage:isSmall}function zoomTo(targetRatio){myself.isSmallStage=!0,world.animations.push(new Animation(function(ratio){
myself.stageRatio=ratio,myself.setExtent(world.extent())},function(){return myself.stageRatio},targetRatio-myself.stageRatio,msecs,null,function(){myself.isSmallStage=1!==targetRatio,myself.controlBar.stageSizeButton.refresh()}))}var myself=this,smallRatio=forcedRatio||.5,msecs=this.isAnimating?100:0,world=this.world(),shiftClicked=16===world.currentKey,altClicked=18===world.currentKey;shiftClicked?(smallRatio=3*SpriteIconMorph.prototype.thumbSize.x/this.stage.dimensions.x,this.isSmallStage&&smallRatio!==this.stageRatio||toggle()):altClicked?(smallRatio=this.width()/2/this.stage.dimensions.x,this.isSmallStage&&smallRatio!==this.stageRatio||toggle()):toggle(),
zoomTo(this.isSmallStage?smallRatio:1)},IDE_Morph.prototype.setPaletteWidth=function(newWidth){var msecs=this.isAnimating?100:0,world=this.world(),myself=this;world.animations.push(new Animation(function(newWidth){myself.paletteWidth=newWidth,myself.setExtent(world.extent())},function(){return myself.paletteWidth},newWidth-myself.paletteWidth,msecs))},IDE_Morph.prototype.createNewProject=function(){var myself=this;this.confirm("Replace the current project with a new one?","New Project",function(){myself.newProject()})},IDE_Morph.prototype.openProjectsBrowser=function(){new ProjectDialogMorph(this,"open").popUp()},IDE_Morph.prototype.saveProjectsBrowser=function(){
"examples"===this.source&&(this.source="local"),new ProjectDialogMorph(this,"save").popUp()},IDE_Morph.prototype.languageMenu=function(){var menu=new MenuMorph(this),world=this.world(),pos=this.controlBar.settingsButton.bottomLeft(),myself=this;SnapTranslator.languages().forEach(function(lang){menu.addItem((SnapTranslator.language===lang?"✓ ":"    ")+SnapTranslator.languageName(lang),function(){myself.loadNewProject=!1,myself.setLanguage(lang)})}),menu.popup(world,pos)},IDE_Morph.prototype.setLanguage=function(lang,callback){"scriptPlaceHolder"!=getSnapProjectScript&&(importString=getSnapProjectScript),this.openDefaultProject(importString)},IDE_Morph.prototype.openDefaultProject=function(impString){
var str=impString;""!=impString&&this.openProjectString(str)},IDE_Morph.prototype.reflectLanguage=function(lang,callback){var projectData,urlBar=location.hash;if(SnapTranslator.language=lang,!this.loadNewProject)if(Process.prototype.isCatchingErrors)try{projectData=this.serializer.serialize(this.stage)}catch(err){this.showMessage("Serialization failed: "+err)}else projectData=this.serializer.serialize(this.stage);SpriteMorph.prototype.initBlocks(),this.spriteBar.tabBar.tabTo("scripts"),this.createCategories(),this.createCorralBar(),this.fixLayout(),this.loadNewProject?(this.newProject(),location.hash=urlBar):this.openProjectString(projectData),this.saveSetting("language",lang),
callback&&callback.call(this)},IDE_Morph.prototype.userSetBlocksScale=function(){var scrpt,blck,shield,sample,action,myself=this;scrpt=new CommandBlockMorph,scrpt.color=SpriteMorph.prototype.blockColor.motion,scrpt.setSpec(localize("build")),blck=new CommandBlockMorph,blck.color=SpriteMorph.prototype.blockColor.sound,blck.setSpec(localize("your own")),scrpt.nextBlock(blck),blck=new CommandBlockMorph,blck.color=SpriteMorph.prototype.blockColor.operators,blck.setSpec(localize("blocks")),scrpt.bottomBlock().nextBlock(blck),sample=new FrameMorph,sample.acceptsDrops=!1,sample.color=IDE_Morph.prototype.groupColor,sample.cachedTexture=this.scriptsPaneTexture,sample.setExtent(new Point(250,180)),
scrpt.setPosition(sample.position().add(10)),sample.add(scrpt),shield=new Morph,shield.alpha=0,shield.setExtent(sample.extent()),shield.setPosition(sample.position()),sample.add(shield),action=function(num){scrpt.blockSequence().forEach(function(block){block.setScale(num),block.drawNew(),block.setSpec(block.blockSpec)}),scrpt.changed()},new DialogBoxMorph(null,function(num){myself.setBlocksScale(Math.min(num,12))}).withKey("zoomBlocks").prompt("Zoom blocks",SyntaxElementMorph.prototype.scale.toString(),this.world(),sample,{"normal (1x)":1,"demo (1.2x)":1.2,"presentation (1.4x)":1.4,"big (2x)":2,"huge (4x)":4,"giant (8x)":8,"monstrous (10x)":10},!1,!0,1,12,action);
},IDE_Morph.prototype.setBlocksScale=function(num){var projectData;if(Process.prototype.isCatchingErrors)try{projectData=this.serializer.serialize(this.stage)}catch(err){this.showMessage("Serialization failed: "+err)}else projectData=this.serializer.serialize(this.stage);SyntaxElementMorph.prototype.setScale(num),CommentMorph.prototype.refreshScale(),SpriteMorph.prototype.initBlocks(),this.spriteBar.tabBar.tabTo("scripts"),this.createCategories(),this.createCorralBar(),this.fixLayout(),this.openProjectString(projectData),this.saveSetting("zoom",num)},IDE_Morph.prototype.userSetStageSize=function(){new DialogBoxMorph(this,this.setStageExtent,this).promptVector("Stage size",StageMorph.prototype.dimensions,new Point(480,360),"Stage width","Stage height",this.world(),null,null);
},IDE_Morph.prototype.setStageExtent=function(aPoint){function zoom(){myself.step=function(){var delta=ext.subtract(StageMorph.prototype.dimensions).divideBy(2);delta.abs().lt(new Point(5,5))?(StageMorph.prototype.dimensions=ext,delete myself.step):StageMorph.prototype.dimensions=StageMorph.prototype.dimensions.add(delta),myself.stage.setExtent(StageMorph.prototype.dimensions),myself.stage.clearPenTrails(),myself.fixLayout(),this.setExtent(world.extent())}}var myself=this,world=this.world(),ext=aPoint.max(new Point(240,180));this.stageRatio=1,this.isSmallStage=!1,this.controlBar.stageSizeButton.refresh(),this.setExtent(world.extent()),this.isAnimating?zoom():(StageMorph.prototype.dimensions=ext,
this.stage.setExtent(StageMorph.prototype.dimensions),this.stage.clearPenTrails(),this.fixLayout(),this.setExtent(world.extent()))},IDE_Morph.prototype.userSetDragThreshold=function(){new DialogBoxMorph(this,function(num){MorphicPreferences.grabThreshold=Math.min(Math.max(+num,0),200)},this).prompt("Dragging threshold",MorphicPreferences.grabThreshold.toString(),this.world(),null,null,null,!0)},IDE_Morph.prototype.initializeCloud=function(){var myself=this,world=this.world();new DialogBoxMorph(null,function(user){var str,pwh=hex_sha512(user.password);SnapCloud.login(user.username,pwh,function(){user.choice&&(str=SnapCloud.encodeDict({username:user.username,password:pwh
}),localStorage["-snap-user"]=str),myself.source="cloud",myself.showMessage("now connected.",2)},myself.cloudError())}).withKey("cloudlogin").promptCredentials("Sign in","login",null,null,null,null,"stay signed in on this computer\nuntil logging out",world,myself.cloudIcon(),myself.cloudMsg)},IDE_Morph.prototype.createCloudAccount=function(){var myself=this,world=this.world();new DialogBoxMorph(null,function(user){SnapCloud.signup(user.username,user.email,function(txt,title){(new DialogBoxMorph).inform(title,txt+".\n\nAn e-mail with your password\nhas been sent to the address provided",world,myself.cloudIcon(null,new Color(0,180,0)))},myself.cloudError())}).withKey("cloudsignup").promptCredentials("Sign up","signup","http://snap.berkeley.edu/tos.html","Terms of Service...","http://snap.berkeley.edu/privacy.html","Privacy...","I have read and agree\nto the Terms of Service",world,myself.cloudIcon(),myself.cloudMsg);
},IDE_Morph.prototype.resetCloudPassword=function(){var myself=this,world=this.world();new DialogBoxMorph(null,function(user){SnapCloud.resetPassword(user.username,function(txt,title){(new DialogBoxMorph).inform(title,txt+".\n\nAn e-mail with a link to\nreset your password\nhas been sent to the address provided",world,myself.cloudIcon(null,new Color(0,180,0)))},myself.cloudError())}).withKey("cloudresetpassword").promptCredentials("Reset password","resetPassword",null,null,null,null,null,world,myself.cloudIcon(),myself.cloudMsg)},IDE_Morph.prototype.changeCloudPassword=function(){var myself=this,world=this.world();new DialogBoxMorph(null,function(user){SnapCloud.changePassword(user.oldpassword,user.password,function(){
myself.logout(),myself.showMessage("password has been changed.",2)},myself.cloudError())}).withKey("cloudpassword").promptCredentials("Change Password","changePassword",null,null,null,null,null,world,myself.cloudIcon(),myself.cloudMsg)},IDE_Morph.prototype.logout=function(){var myself=this;delete localStorage["-snap-user"],SnapCloud.logout(function(){SnapCloud.clear(),myself.showMessage("disconnected.",2)},function(){SnapCloud.clear(),myself.showMessage("disconnected.",2)})},IDE_Morph.prototype.saveProjectToCloud=function(name){var myself=this;name&&(this.showMessage("Saving project\nto the cloud..."),this.setProjectName(name),SnapCloud.saveProject(this,function(){
myself.showMessage("saved.",2)},this.cloudError()))},IDE_Morph.prototype.exportProjectMedia=function(name){var menu,media;if(this.serializer.isCollectingMedia=!0,name){this.setProjectName(name);try{menu=this.showMessage("Exporting"),media=this.serializer.mediaXML(name),this.saveXMLAs(media,this.projectName+" media"),menu.destroy(),this.showMessage("Exported!",1)}catch(err){if(!Process.prototype.isCatchingErrors)throw err;this.serializer.isCollectingMedia=!1,this.showMessage("Export failed: "+err)}}this.serializer.isCollectingMedia=!1,this.serializer.flushMedia()},IDE_Morph.prototype.exportProjectNoMedia=function(name){var menu,str;if(this.serializer.isCollectingMedia=!0,
name)if(this.setProjectName(name),Process.prototype.isCatchingErrors)try{menu=this.showMessage("Exporting"),str=this.serializer.serialize(this.stage),this.saveXMLAs(str,this.projectName),menu.destroy(),this.showMessage("Exported!",1)}catch(err){this.serializer.isCollectingMedia=!1,this.showMessage("Export failed: "+err)}else menu=this.showMessage("Exporting"),str=this.serializer.serialize(this.stage),this.saveXMLAs(str,this.projectName),menu.destroy(),this.showMessage("Exported!",1);this.serializer.isCollectingMedia=!1,this.serializer.flushMedia()},IDE_Morph.prototype.exportProjectAsCloudData=function(name){var menu,str,media,dta;if(this.serializer.isCollectingMedia=!0,
name)if(this.setProjectName(name),Process.prototype.isCatchingErrors)try{menu=this.showMessage("Exporting"),str=this.serializer.serialize(this.stage),media=this.serializer.mediaXML(name),dta="<snapdata>"+str+media+"</snapdata>",this.saveXMLAs(str,this.projectName),menu.destroy(),this.showMessage("Exported!",1)}catch(err){this.serializer.isCollectingMedia=!1,this.showMessage("Export failed: "+err)}else menu=this.showMessage("Exporting"),str=this.serializer.serialize(this.stage),media=this.serializer.mediaXML(name),dta="<snapdata>"+str+media+"</snapdata>",this.saveXMLAs(str,this.projectName),menu.destroy(),this.showMessage("Exported!",1);this.serializer.isCollectingMedia=!1,
this.serializer.flushMedia()},IDE_Morph.prototype.cloudAcknowledge=function(){var myself=this;return function(responseText,url){nop(responseText),(new DialogBoxMorph).inform("Cloud Connection","Successfully connected to:\nhttp://"+url,myself.world(),myself.cloudIcon(null,new Color(0,180,0)))}},IDE_Morph.prototype.cloudResponse=function(){var myself=this;return function(responseText,url){var response=responseText;response.length>50&&(response=response.substring(0,50)+"..."),(new DialogBoxMorph).inform("Snap!Cloud","http://"+url+":\n\nresponds:\n"+response,myself.world(),myself.cloudIcon(null,new Color(0,180,0)))}},IDE_Morph.prototype.cloudError=function(){var myself=this;
return function(responseText,url){var response=responseText,explanation=null;return myself.shield&&(myself.shield.destroy(),myself.shield=null),explanation?void myself.showMessage(explanation):(response.length>50&&(response=response.substring(0,50)+"..."),void(new DialogBoxMorph).inform("Snap!Cloud",(url?url+"\n":"")+response,myself.world(),myself.cloudIcon(null,new Color(180,0,0))))}},IDE_Morph.prototype.cloudIcon=function(height,color){var clr=color||DialogBoxMorph.prototype.titleBarColor,isFlat=MorphicPreferences.isFlat,icon=new SymbolMorph(isFlat?"cloud":"cloudGradient",height||50,clr,isFlat?null:new Point(-1,-1),clr.darker(50));return isFlat||icon.addShadow(new Point(1,1),1,clr.lighter(95)),
icon},IDE_Morph.prototype.setCloudURL=function(){new DialogBoxMorph(null,function(url){SnapCloud.url=url}).withKey("cloudURL").prompt("Cloud URL",SnapCloud.url,this.world(),null,{"Snap!Cloud":"https://snap.apps.miosoft.com/SnapCloud"})},IDE_Morph.prototype.getURL=function(url,callback){var request=new XMLHttpRequest,async=callback instanceof Function,myself=this;try{if(request.open("GET",url,async),async&&(request.onreadystatechange=function(){if(4===request.readyState){if(!request.responseText)throw new Error("unable to retrieve "+url);callback.call(myself,request.responseText)}}),request.send(),!async){if(200===request.status)return request.responseText;throw new Error("unable to retrieve "+url);
}}catch(err){if(myself.showMessage(err.toString()),!async)return request.responseText;callback.call(this)}},IDE_Morph.prototype.showMessage=function(message,secs){var intervalHandle,m=new MenuMorph(null,message);return m.popUpCenteredInWorld(this.world()),secs&&(intervalHandle=setInterval(function(){m.destroy(),clearInterval(intervalHandle)},1e3*secs)),m},IDE_Morph.prototype.inform=function(title,message){(new DialogBoxMorph).inform(title,localize(message),this.world())},IDE_Morph.prototype.confirm=function(message,title,action){new DialogBoxMorph(null,action).askYesNo(title,localize(message),this.world())},IDE_Morph.prototype.prompt=function(message,callback,choices,key){
new DialogBoxMorph(null,callback).withKey(key).prompt(message,"",this.world(),null,choices)},ProjectDialogMorph.prototype=new DialogBoxMorph,ProjectDialogMorph.prototype.constructor=ProjectDialogMorph,ProjectDialogMorph.uber=DialogBoxMorph.prototype,ProjectDialogMorph.prototype.init=function(ide,task){var myself=this;this.ide=ide,this.task=task||"open",this.source=ide.source||"local",this.projectList=[],this.handle=null,this.srcBar=null,this.nameField=null,this.filterField=null,this.magnifyingGlass=null,this.listField=null,this.preview=null,this.notesText=null,this.notesField=null,this.deleteButton=null,this.shareButton=null,this.unshareButton=null,ProjectDialogMorph.uber.init.call(this,this,null,null),
this.labelString="save"===this.task?"Save Project":"Open Project",this.createLabel(),this.key="project"+task,this.buildContents(),this.onNextStep=function(){myself.setSource(myself.source)}},ProjectDialogMorph.prototype.buildContents=function(){var thumbnail,notification;this.addBody(new Morph),this.body.color=this.color,this.srcBar=new AlignmentMorph("column",this.padding/2),this.ide.cloudMsg&&(notification=new TextMorph(this.ide.cloudMsg,10,null,!1,null,null,null,null,new Point(1,1),new Color(255,255,255)),notification.refresh=nop,this.srcBar.add(notification)),this.addSourceButton("cloud",localize("Cloud"),"cloud"),this.addSourceButton("local",localize("Browser"),"storage"),
"open"===this.task&&(this.buildFilterField(),this.addSourceButton("examples",localize("Examples"),"poster")),this.srcBar.fixLayout(),this.body.add(this.srcBar),"save"===this.task&&(this.nameField=new InputFieldMorph(this.ide.projectName),this.body.add(this.nameField)),this.listField=new ListMorph([]),this.fixListFieldItemColors(),this.listField.fixLayout=nop,this.listField.edge=InputFieldMorph.prototype.edge,this.listField.fontSize=InputFieldMorph.prototype.fontSize,this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.listField.contrast=InputFieldMorph.prototype.contrast,this.listField.drawNew=InputFieldMorph.prototype.drawNew,this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,
this.body.add(this.listField),this.preview=new Morph,this.preview.fixLayout=nop,this.preview.edge=InputFieldMorph.prototype.edge,this.preview.fontSize=InputFieldMorph.prototype.fontSize,this.preview.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.preview.contrast=InputFieldMorph.prototype.contrast,this.preview.drawNew=function(){InputFieldMorph.prototype.drawNew.call(this),this.texture&&this.drawTexture(this.texture)},this.preview.drawCachedTexture=function(){var context=this.image.getContext("2d");context.drawImage(this.cachedTexture,this.edge,this.edge),this.changed()},this.preview.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.preview.setExtent(this.ide.serializer.thumbnailSize.add(2*this.preview.edge)),
this.body.add(this.preview),this.preview.drawNew(),"save"===this.task&&(thumbnail=this.ide.stage.thumbnail(SnapSerializer.prototype.thumbnailSize),this.preview.texture=null,this.preview.cachedTexture=thumbnail,this.preview.drawCachedTexture()),this.notesField=new ScrollFrameMorph,this.notesField.fixLayout=nop,this.notesField.edge=InputFieldMorph.prototype.edge,this.notesField.fontSize=InputFieldMorph.prototype.fontSize,this.notesField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.notesField.contrast=InputFieldMorph.prototype.contrast,this.notesField.drawNew=InputFieldMorph.prototype.drawNew,this.notesField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,
this.notesField.acceptsDrops=!1,this.notesField.contents.acceptsDrops=!1,"open"===this.task?this.notesText=new TextMorph(""):(this.notesText=new TextMorph(this.ide.projectNotes),this.notesText.isEditable=!0,this.notesText.enableSelecting()),this.notesField.isTextLineWrapping=!0,this.notesField.padding=3,this.notesField.setContents(this.notesText),this.notesField.setWidth(this.preview.width()),this.body.add(this.notesField),"open"===this.task?(this.addButton("openProject","Open"),this.action="openProject"):(this.addButton("saveProject","Save"),this.action="saveProject"),this.shareButton=this.addButton("shareProject","Share"),this.unshareButton=this.addButton("unshareProject","Unshare"),
this.shareButton.hide(),this.unshareButton.hide(),this.deleteButton=this.addButton("deleteProject","Delete"),this.addButton("cancel","Cancel"),notification?this.setExtent(new Point(455,335).add(notification.extent())):this.setExtent(new Point(455,335)),this.fixLayout()},ProjectDialogMorph.prototype.popUp=function(wrrld){var world=wrrld||this.ide.world();world&&(ProjectDialogMorph.uber.popUp.call(this,world),this.handle=new HandleMorph(this,350,300,this.corner,this.corner))},ProjectDialogMorph.prototype.addSourceButton=function(source,label,symbol){var button,myself=this,lbl1=new StringMorph(label,10,null,!0,null,null,new Point(1,1),new Color(255,255,255)),lbl2=new StringMorph(label,10,null,!0,null,null,new Point(-1,-1),this.titleBarColor.darker(50),new Color(255,255,255)),l1=new Morph,l2=new Morph;
lbl1.add(new SymbolMorph(symbol,24,this.titleBarColor.darker(20),new Point(1,1),this.titleBarColor.darker(50))),lbl1.children[0].setCenter(lbl1.center()),lbl1.children[0].setBottom(lbl1.top()-this.padding/2),l1.image=lbl1.fullImage(),l1.bounds=lbl1.fullBounds(),lbl2.add(new SymbolMorph(symbol,24,new Color(255,255,255),new Point(-1,-1),this.titleBarColor.darker(50))),lbl2.children[0].setCenter(lbl2.center()),lbl2.children[0].setBottom(lbl2.top()-this.padding/2),l2.image=lbl2.fullImage(),l2.bounds=lbl2.fullBounds(),button=new ToggleButtonMorph(null,myself,function(){myself.setSource(source)},[l1,l2],function(){return myself.source===source}),button.corner=this.buttonCorner,
button.edge=this.buttonEdge,button.outline=this.buttonOutline,button.outlineColor=this.buttonOutlineColor,button.outlineGradient=this.buttonOutlineGradient,button.labelMinExtent=new Point(60,0),button.padding=this.buttonPadding,button.contrast=this.buttonContrast,button.pressColor=this.titleBarColor.darker(20),button.drawNew(),button.fixLayout(),button.refresh(),this.srcBar.add(button)},ProjectDialogMorph.prototype.fixListFieldItemColors=function(){var myself=this;this.listField.contents.children[0].alpha=0,this.listField.contents.children[0].children.forEach(function(item){item.pressColor=myself.titleBarColor.darker(20),item.color=new Color(0,0,0,0),item.noticesTransparentClick=!0;
})},ProjectDialogMorph.prototype.buildFilterField=function(){var myself=this;this.filterField=new InputFieldMorph(""),this.magnifyingGlass=new SymbolMorph("magnifyingGlass",this.filterField.height(),this.titleBarColor.darker(50)),this.body.add(this.magnifyingGlass),this.body.add(this.filterField),this.filterField.reactToKeystroke=function(evt){var text=this.getValue();myself.listField.elements=myself.projectList.filter(function(aProject){var name,notes;return aProject.ProjectName?(name=aProject.ProjectName,notes=aProject.Notes):(name=aProject.name,notes=aProject.notes||""),name.toLowerCase().indexOf(text.toLowerCase())>-1||notes.toLowerCase().indexOf(text.toLowerCase())>-1;
}),0===myself.listField.elements.length&&myself.listField.elements.push("(no matches)"),myself.clearDetails(),myself.listField.buildListContents(),myself.fixListFieldItemColors(),myself.listField.adjustScrollBars(),myself.listField.scrollY(myself.listField.top()),myself.fixLayout()}},ProjectDialogMorph.prototype.setSource=function(source){var msg,myself=this;switch(this.source=source,this.srcBar.children.forEach(function(button){button.refresh()}),this.source){case"cloud":return msg=myself.ide.showMessage("Updating\nproject list..."),this.projectList=[],void SnapCloud.getProjectList(function(projectList){"cloud"===myself.source&&myself.installCloudProjectList(projectList),
msg.destroy()},function(err,lbl){msg.destroy(),myself.ide.cloudError().call(null,err,lbl)});case"examples":this.projectList=this.getExamplesProjectList();break;case"local":this.projectList=this.getLocalProjectList()}this.listField.destroy(),this.listField=new ListMorph(this.projectList,this.projectList.length>0?function(element){return element.name||element}:null,null,function(){myself.ok()}),this.fixListFieldItemColors(),this.listField.fixLayout=nop,this.listField.edge=InputFieldMorph.prototype.edge,this.listField.fontSize=InputFieldMorph.prototype.fontSize,this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.listField.contrast=InputFieldMorph.prototype.contrast,
this.listField.drawNew=InputFieldMorph.prototype.drawNew,this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,"local"===this.source?this.listField.action=function(item){var src,xml;void 0!==item&&(myself.nameField&&myself.nameField.setContents(item.name||""),"open"===myself.task&&(src=localStorage["-snap-project-"+item.name],src&&(xml=myself.ide.serializer.parse(src),myself.notesText.text=xml.childNamed("notes").contents||"",myself.notesText.drawNew(),myself.notesField.contents.adjustBounds(),myself.preview.texture=xml.childNamed("thumbnail").contents||null,myself.preview.cachedTexture=null,myself.preview.drawNew())),myself.edit())}:this.listField.action=function(item){
var src,xml;void 0!==item&&(myself.nameField&&myself.nameField.setContents(item.name||""),src=myself.ide.getURL(myself.ide.resourceURL("Examples",item.fileName)),xml=myself.ide.serializer.parse(src),myself.notesText.text=xml.childNamed("notes").contents||"",myself.notesText.drawNew(),myself.notesField.contents.adjustBounds(),myself.preview.texture=xml.childNamed("thumbnail").contents||null,myself.preview.cachedTexture=null,myself.preview.drawNew(),myself.edit())},this.body.add(this.listField),this.shareButton.hide(),this.unshareButton.hide(),"local"===this.source?this.deleteButton.show():this.deleteButton.hide(),this.buttons.fixLayout(),this.fixLayout(),"open"===this.task&&this.clearDetails();
},ProjectDialogMorph.prototype.getLocalProjectList=function(){var stored,name,dta,projects=[];for(stored in localStorage)Object.prototype.hasOwnProperty.call(localStorage,stored)&&"-snap-project-"===stored.substr(0,14)&&(name=stored.substr(14),dta={name:name,thumb:null,notes:null},projects.push(dta));return projects.sort(function(x,y){return x.name.toLowerCase()<y.name.toLowerCase()?-1:1}),projects},ProjectDialogMorph.prototype.getExamplesProjectList=function(){return this.ide.getMediaList("Examples")},ProjectDialogMorph.prototype.installCloudProjectList=function(pl){var myself=this;this.projectList=pl||[],this.projectList.sort(function(x,y){return x.ProjectName.toLowerCase()<y.ProjectName.toLowerCase()?-1:1;
}),this.listField.destroy(),this.listField=new ListMorph(this.projectList,this.projectList.length>0?function(element){return element.ProjectName||element}:null,[["bold",function(proj){return"true"===proj.Public}]],function(){myself.ok()}),this.fixListFieldItemColors(),this.listField.fixLayout=nop,this.listField.edge=InputFieldMorph.prototype.edge,this.listField.fontSize=InputFieldMorph.prototype.fontSize,this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.listField.contrast=InputFieldMorph.prototype.contrast,this.listField.drawNew=InputFieldMorph.prototype.drawNew,this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.listField.action=function(item){
void 0!==item&&(myself.nameField&&myself.nameField.setContents(item.ProjectName||""),"open"===myself.task&&(myself.notesText.text=item.Notes||"",myself.notesText.drawNew(),myself.notesField.contents.adjustBounds(),myself.preview.texture=item.Thumbnail||null,myself.preview.cachedTexture=null,myself.preview.drawNew(),new SpeechBubbleMorph(new TextMorph(localize("last changed")+"\n"+item.Updated,null,null,null,null,"center")).popUp(myself.world(),myself.preview.rightCenter().add(new Point(2,0)))),"true"===item.Public?(myself.shareButton.hide(),myself.unshareButton.show()):(myself.unshareButton.hide(),myself.shareButton.show()),myself.buttons.fixLayout(),myself.fixLayout(),
myself.edit())},this.body.add(this.listField),this.shareButton.show(),this.unshareButton.hide(),this.deleteButton.show(),this.buttons.fixLayout(),this.fixLayout(),"open"===this.task&&this.clearDetails()},ProjectDialogMorph.prototype.clearDetails=function(){this.notesText.text="",this.notesText.drawNew(),this.notesField.contents.adjustBounds(),this.preview.texture=null,this.preview.cachedTexture=null,this.preview.drawNew()},ProjectDialogMorph.prototype.openProject=function(){var src,proj=this.listField.selected;proj&&(this.ide.source=this.source,"cloud"===this.source?this.openCloudProject(proj):"examples"===this.source?(src=this.ide.getURL(this.ide.resourceURL("Examples",proj.fileName)),
this.ide.openProjectString(src),this.destroy()):(this.ide.openProject(proj.name),this.destroy()))},ProjectDialogMorph.prototype.openCloudProject=function(project){var myself=this;myself.ide.nextSteps([function(){myself.ide.showMessage("Fetching project\nfrom the cloud...")},function(){myself.rawOpenCloudProject(project)}])},ProjectDialogMorph.prototype.rawOpenCloudProject=function(proj){var myself=this;SnapCloud.reconnect(function(){SnapCloud.callService("getRawProject",function(response){SnapCloud.disconnect(),myself.ide.source="cloud",myself.ide.droppedText(response),"true"===proj.Public&&(location.hash="#present:Username="+encodeURIComponent(SnapCloud.username)+"&ProjectName="+encodeURIComponent(proj.ProjectName));
},myself.ide.cloudError(),[proj.ProjectName])},myself.ide.cloudError()),this.destroy()},ProjectDialogMorph.prototype.saveProject=function(){var name=this.nameField.contents().text.text,notes=this.notesText.text,myself=this;this.ide.projectNotes=notes||this.ide.projectNotes,name&&("cloud"===this.source?detect(this.projectList,function(item){return item.ProjectName===name})?this.ide.confirm(localize("Are you sure you want to replace")+'\n"'+name+'"?',"Replace Project",function(){myself.ide.setProjectName(name),myself.saveCloudProject()}):(this.ide.setProjectName(name),myself.saveCloudProject()):detect(this.projectList,function(item){return item.name===name})?this.ide.confirm(localize("Are you sure you want to replace")+'\n"'+name+'"?',"Replace Project",function(){
myself.ide.setProjectName(name),myself.ide.source="local",myself.ide.saveProject(name),myself.destroy()}):(this.ide.setProjectName(name),myself.ide.source="local",this.ide.saveProject(name),this.destroy()))},ProjectDialogMorph.prototype.saveCloudProject=function(){var myself=this;this.ide.showMessage("Saving project\nto the cloud..."),SnapCloud.saveProject(this.ide,function(){myself.ide.source="cloud",myself.ide.showMessage("saved.",2)},this.ide.cloudError()),this.destroy()},ProjectDialogMorph.prototype.deleteProject=function(){var proj,idx,name,myself=this;"cloud"===this.source?(proj=this.listField.selected,proj&&this.ide.confirm(localize("Are you sure you want to delete")+'\n"'+proj.ProjectName+'"?',"Delete Project",function(){
SnapCloud.reconnect(function(){SnapCloud.callService("deleteProject",function(){SnapCloud.disconnect(),myself.ide.hasChangedMedia=!0,idx=myself.projectList.indexOf(proj),myself.projectList.splice(idx,1),myself.installCloudProjectList(myself.projectList)},myself.ide.cloudError(),[proj.ProjectName])},myself.ide.cloudError())})):this.listField.selected&&(name=this.listField.selected.name,this.ide.confirm(localize("Are you sure you want to delete")+'\n"'+name+'"?',"Delete Project",function(){delete localStorage["-snap-project-"+name],myself.setSource(myself.source)}))},ProjectDialogMorph.prototype.shareProject=function(){var myself=this,ide=this.ide,proj=this.listField.selected,entry=this.listField.active;
proj&&this.ide.confirm(localize("Are you sure you want to publish")+'\n"'+proj.ProjectName+'"?',"Share Project",function(){myself.ide.showMessage("sharing\nproject..."),SnapCloud.reconnect(function(){if(SnapCloud.callService("publishProject",function(){SnapCloud.disconnect(),proj.Public="true",myself.unshareButton.show(),myself.shareButton.hide(),entry.label.isBold=!0,entry.label.drawNew(),entry.label.changed(),myself.buttons.fixLayout(),myself.drawNew(),myself.ide.showMessage("shared.",2)},myself.ide.cloudError(),[proj.ProjectName]),proj.ProjectName===ide.projectName){var usr=SnapCloud.username,projectId="Username="+encodeURIComponent(usr.toLowerCase())+"&ProjectName="+encodeURIComponent(proj.ProjectName);
location.hash="present:"+projectId}},myself.ide.cloudError())})},ProjectDialogMorph.prototype.unshareProject=function(){var myself=this,ide=this.ide,proj=this.listField.selected,entry=this.listField.active;proj&&this.ide.confirm(localize("Are you sure you want to unpublish")+'\n"'+proj.ProjectName+'"?',"Unshare Project",function(){myself.ide.showMessage("unsharing\nproject..."),SnapCloud.reconnect(function(){SnapCloud.callService("unpublishProject",function(){SnapCloud.disconnect(),proj.Public="false",myself.shareButton.show(),myself.unshareButton.hide(),entry.label.isBold=!1,entry.label.drawNew(),entry.label.changed(),myself.buttons.fixLayout(),myself.drawNew(),
myself.ide.showMessage("unshared.",2)},myself.ide.cloudError(),[proj.ProjectName]),proj.ProjectName===ide.projectName&&(location.hash="")},myself.ide.cloudError())})},ProjectDialogMorph.prototype.edit=function(){this.nameField?this.nameField.edit():this.filterField&&this.filterField.edit()},ProjectDialogMorph.prototype.fixLayout=function(){var th=fontHeight(this.titleFontSize)+2*this.titlePadding,thin=this.padding/2,inputField=this.nameField||this.filterField,oldFlag=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,this.buttons&&this.buttons.children.length>0&&this.buttons.fixLayout(),this.body&&(this.body.setPosition(this.position().add(new Point(this.padding,th+this.padding))),
this.body.setExtent(new Point(this.width()-2*this.padding,this.height()-3*this.padding-th-this.buttons.height())),this.srcBar.setPosition(this.body.position()),inputField.setWidth(this.body.width()-this.srcBar.width()-6*this.padding),inputField.setLeft(this.srcBar.right()+3*this.padding),inputField.setTop(this.srcBar.top()),inputField.drawNew(),this.listField.setLeft(this.srcBar.right()+this.padding),this.listField.setWidth(this.body.width()-this.srcBar.width()-this.preview.width()-this.padding-thin),this.listField.contents.children[0].adjustWidths(),this.listField.setTop(inputField.bottom()+this.padding),this.listField.setHeight(this.body.height()-inputField.height()-this.padding),
this.magnifyingGlass&&(this.magnifyingGlass.setTop(inputField.top()),this.magnifyingGlass.setLeft(this.listField.left())),this.preview.setRight(this.body.right()),this.preview.setTop(inputField.bottom()+this.padding),this.notesField.setTop(this.preview.bottom()+thin),this.notesField.setLeft(this.preview.left()),this.notesField.setHeight(this.body.bottom()-this.preview.bottom()-thin)),this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(th-this.label.height())/2)),this.buttons&&this.buttons.children.length>0&&(this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding)),Morph.prototype.trackChanges=oldFlag,
this.changed()},LibraryImportDialogMorph.prototype=new DialogBoxMorph,LibraryImportDialogMorph.prototype.constructor=LibraryImportDialogMorph,LibraryImportDialogMorph.uber=DialogBoxMorph.prototype,LibraryImportDialogMorph.prototype.init=function(ide,librariesData){LibraryImportDialogMorph.uber.init.call(this,this,null,null),this.ide=ide,this.key="importLibrary",this.librariesData=librariesData,this.libraryCache={},this.handle=null,this.listField=null,this.palette=null,this.notesText=null,this.notesField=null,this.labelString="Import library",this.createLabel(),this.buildContents()},LibraryImportDialogMorph.prototype.buildContents=function(){this.addBody(new Morph),
this.body.color=this.color,this.initializePalette(),this.initializeLibraryDescription(),this.installLibrariesList(),this.addButton("importLibrary","Import"),this.addButton("cancel","Cancel"),this.setExtent(new Point(460,455)),this.fixLayout()},LibraryImportDialogMorph.prototype.initializePalette=function(){this.palette&&this.palette.destroy(),this.palette=new ScrollFrameMorph(null,null,SpriteMorph.prototype.sliderColor),this.palette.color=SpriteMorph.prototype.paletteColor,this.palette.padding=4,this.palette.isDraggable=!1,this.palette.acceptsDrops=!1,this.palette.contents.acceptsDrops=!1,this.body.add(this.palette)},LibraryImportDialogMorph.prototype.initializeLibraryDescription=function(){
this.notesField&&this.notesField.destroy(),this.notesField=new ScrollFrameMorph,this.notesField.fixLayout=nop,this.notesField.edge=InputFieldMorph.prototype.edge,this.notesField.fontSize=InputFieldMorph.prototype.fontSize,this.notesField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.notesField.contrast=InputFieldMorph.prototype.contrast,this.notesField.drawNew=InputFieldMorph.prototype.drawNew,this.notesField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.notesField.acceptsDrops=!1,this.notesField.contents.acceptsDrops=!1,this.notesText=new TextMorph(""),this.notesField.isTextLineWrapping=!0,this.notesField.padding=3,this.notesField.setContents(this.notesText),
this.notesField.setHeight(100),this.body.add(this.notesField)},LibraryImportDialogMorph.prototype.installLibrariesList=function(){var myself=this;this.listField&&this.listField.destroy(),this.listField=new ListMorph(this.librariesData,function(element){return element.name},null,function(){myself.importLibrary()}),this.fixListFieldItemColors(),this.listField.fixLayout=nop,this.listField.edge=InputFieldMorph.prototype.edge,this.listField.fontSize=InputFieldMorph.prototype.fontSize,this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.listField.contrast=InputFieldMorph.prototype.contrast,this.listField.drawNew=InputFieldMorph.prototype.drawNew,
this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.listField.action=function(item){isNil(item)||(myself.notesText.text=item.description||"",myself.notesText.drawNew(),myself.notesField.contents.adjustBounds(),myself.hasCached(item.fileName)?myself.displayBlocks(item.fileName):(myself.showMessage(localize("Loading")+"\n"+localize(item.name)),myself.ide.getURL(myself.ide.resourceURL("libraries",item.fileName),function(libraryXML){myself.cacheLibrary(item.fileName,myself.ide.serializer.loadBlocks(libraryXML)),myself.displayBlocks(item.fileName)})))},this.listField.setWidth(200),this.body.add(this.listField),this.fixLayout()},LibraryImportDialogMorph.prototype.popUp=function(){
var world=this.ide.world();world&&(LibraryImportDialogMorph.uber.popUp.call(this,world),this.handle=new HandleMorph(this,300,300,this.corner,this.corner))},LibraryImportDialogMorph.prototype.fixListFieldItemColors=ProjectDialogMorph.prototype.fixListFieldItemColors,LibraryImportDialogMorph.prototype.clearDetails=ProjectDialogMorph.prototype.clearDetails,LibraryImportDialogMorph.prototype.fixLayout=function(){var titleHeight=fontHeight(this.titleFontSize)+2*this.titlePadding,thin=this.padding/2,oldFlag=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,this.body&&(this.body.setPosition(this.position().add(new Point(this.padding,titleHeight+this.padding))),
this.body.setExtent(new Point(this.width()-2*this.padding,this.height()-3*this.padding-titleHeight-this.buttons.height())),this.listField.setExtent(new Point(200,this.body.height())),this.notesField.setExtent(new Point(this.body.width()-this.listField.width()-thin,100)),this.palette.setExtent(new Point(this.notesField.width(),this.body.height()-this.notesField.height()-thin)),this.listField.contents.children[0].adjustWidths(),this.listField.setPosition(this.body.position()),this.palette.setPosition(this.listField.topRight().add(new Point(thin,0))),this.notesField.setPosition(this.palette.bottomLeft().add(new Point(0,thin)))),this.label&&(this.label.setCenter(this.center()),
this.label.setTop(this.top()+(titleHeight-this.label.height())/2)),this.buttons&&(this.buttons.fixLayout(),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding)),Morph.prototype.trackChanges=oldFlag,this.changed()},LibraryImportDialogMorph.prototype.hasCached=function(key){return this.libraryCache.hasOwnProperty(key)},LibraryImportDialogMorph.prototype.cacheLibrary=function(key,blocks){this.libraryCache[key]=blocks},LibraryImportDialogMorph.prototype.cachedLibrary=function(key){return this.libraryCache[key]},LibraryImportDialogMorph.prototype.importLibrary=function(){var blocks,ide=this.ide,selectedLibrary=this.listField.selected.fileName,libraryName=this.listField.selected.name;
this.hasCached(selectedLibrary)?(blocks=this.cachedLibrary(selectedLibrary),blocks.forEach(function(def){def.receiver=ide.stage,ide.stage.globalBlocks.push(def),ide.stage.replaceDoubleDefinitionsFor(def)}),ide.showMessage(localize("Imported")+" "+localize(libraryName),2)):(ide.showMessage(localize("Loading")+" "+localize(libraryName)),ide.getURL(ide.resourceURL("libraries",selectedLibrary),function(libraryText){ide.droppedText(libraryText,libraryName)})),this.destroy()},LibraryImportDialogMorph.prototype.displayBlocks=function(libraryKey){var x,y,blockImage,previousCategory,blockContainer,myself=this,padding=4,blocksList=this.cachedLibrary(libraryKey);blocksList.length&&(this.initializePalette(),
x=this.palette.left()+padding,y=this.palette.top(),SpriteMorph.prototype.categories.forEach(function(category){blocksList.forEach(function(definition){definition.category===category&&(category!==previousCategory&&(y+=padding),previousCategory=category,blockImage=definition.templateInstance().fullImage(),blockContainer=new Morph,blockContainer.setExtent(new Point(blockImage.width,blockImage.height)),blockContainer.image=blockImage,blockContainer.setPosition(new Point(x,y)),myself.palette.addContents(blockContainer),y+=blockContainer.fullBounds().height()+padding)})}),this.palette.scrollX(padding),this.palette.scrollY(padding),this.fixLayout())},LibraryImportDialogMorph.prototype.showMessage=function(msgText){
var msg=new MenuMorph(null,msgText);this.initializePalette(),this.fixLayout(),msg.popUpCenteredInWorld(this.palette.contents)},SpriteIconMorph.prototype=new ToggleButtonMorph,SpriteIconMorph.prototype.constructor=SpriteIconMorph,SpriteIconMorph.uber=ToggleButtonMorph.prototype,SpriteIconMorph.prototype.thumbSize=new Point(40,40),SpriteIconMorph.prototype.labelShadowOffset=null,SpriteIconMorph.prototype.labelShadowColor=null,SpriteIconMorph.prototype.labelColor=new Color(255,255,255),SpriteIconMorph.prototype.fontSize=9,SpriteIconMorph.prototype.init=function(aSprite,aTemplate){var colors,action,query,hover,myself=this;aTemplate||(colors=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor]),
action=function(){var ide=myself.parentThatIsA(IDE_Morph);ide&&ide.selectSprite(myself.object)},query=function(){var ide=myself.parentThatIsA(IDE_Morph);return!!ide&&ide.currentSprite===myself.object},hover=function(){return aSprite.exemplar?localize("parent")+":\n"+aSprite.exemplar.name:null},this.object=aSprite||new SpriteMorph,this.version=this.object.version,this.thumbnail=null,this.rotationButton=null,SpriteIconMorph.uber.init.call(this,colors,null,action,this.object.name,query,null,hover,aTemplate),this.isDraggable=!0,this.createThumbnail(),this.padding=2,this.corner=8,this.fixLayout(),this.fps=1},SpriteIconMorph.prototype.createThumbnail=function(){this.thumbnail&&this.thumbnail.destroy(),
this.thumbnail=new Morph,this.thumbnail.setExtent(this.thumbSize),this.object instanceof SpriteMorph?(this.thumbnail.image=this.object.fullThumbnail(this.thumbSize),this.createRotationButton()):this.thumbnail.image=this.object.thumbnail(this.thumbSize),this.add(this.thumbnail)},SpriteIconMorph.prototype.createLabel=function(){var txt;this.label&&this.label.destroy(),txt=new StringMorph(this.object.name,this.fontSize,this.fontStyle,!0,!1,!1,this.labelShadowOffset,this.labelShadowColor,this.labelColor),this.label=new FrameMorph,this.label.acceptsDrops=!1,this.label.alpha=0,this.label.setExtent(txt.extent()),txt.setPosition(this.label.position()),this.label.add(txt),
this.add(this.label)},SpriteIconMorph.prototype.createRotationButton=function(){var button,myself=this;this.rotationButton&&(this.rotationButton.destroy(),this.roationButton=null),this.object.anchor&&(button=new ToggleButtonMorph(null,null,function(){myself.object.rotatesWithAnchor=!myself.object.rotatesWithAnchor},["→","↻"],function(){return myself.object.rotatesWithAnchor}),button.corner=8,button.labelMinExtent=new Point(11,11),button.padding=0,button.pressColor=button.color,button.drawNew(),button.fixLayout(),button.refresh(),button.changed(),this.rotationButton=button,this.add(this.rotationButton))},SpriteIconMorph.prototype.step=function(){this.version!==this.object.version&&(this.createThumbnail(),
this.createLabel(),this.fixLayout(),this.version=this.object.version,this.refresh())},SpriteIconMorph.prototype.fixLayout=function(){return this.thumbnail&&this.label?(this.setWidth(this.thumbnail.width()+2*this.outline+2*this.edge+2*this.padding),this.setHeight(this.thumbnail.height()+2*this.outline+2*this.edge+3*this.padding+this.label.height()),this.thumbnail.setCenter(this.center()),this.thumbnail.setTop(this.top()+this.outline+this.edge+this.padding),this.rotationButton&&(this.rotationButton.setTop(this.top()),this.rotationButton.setRight(this.right())),this.label.setWidth(Math.min(this.label.children[0].width(),this.thumbnail.width())),this.label.setCenter(this.center()),
void this.label.setTop(this.thumbnail.bottom()+this.padding)):null},SpriteIconMorph.prototype.userMenu=function(){var menu=new MenuMorph(this),myself=this;return this.object instanceof StageMorph?(menu.addItem("pic...",function(){var ide=myself.parentThatIsA(IDE_Morph);ide.saveCanvasAs(myself.object.fullImageClassic(),this.object.name)},"open a new window\nwith a picture of the stage"),menu):this.object instanceof SpriteMorph?(menu.addItem("show","showSpriteOnStage"),menu.addLine(),menu.addItem("duplicate","duplicateSprite"),StageMorph.prototype.enableInheritance&&menu.addItem("clone","instantiateSprite"),menu.addItem("delete","removeSprite"),menu.addLine(),StageMorph.prototype.enableInheritance&&(menu.addItem("parent...","chooseExemplar"),
this.object.exemplar&&menu.addItem("release","releaseSprite","make temporary and\nhide in the sprite corral")),this.object.anchor&&menu.addItem(localize("detach from")+" "+this.object.anchor.name,function(){myself.object.detachFromAnchor()}),this.object.parts.length&&menu.addItem("detach all parts",function(){myself.object.detachAllParts()}),menu.addItem("export...","exportSprite"),menu):null};SpriteIconMorph.prototype.duplicateSprite=function(){var ide=this.parentThatIsA(IDE_Morph);ide&&ide.duplicateSprite(this.object)};SpriteIconMorph.prototype.instantiateSprite=function(){var ide=this.parentThatIsA(IDE_Morph);ide&&ide.instantiateSprite(this.object)},SpriteIconMorph.prototype.removeSprite=function(){
var ide=this.parentThatIsA(IDE_Morph);ide&&ide.removeSprite(this.object)},SpriteIconMorph.prototype.exportSprite=function(){this.object.exportSprite()},SpriteIconMorph.prototype.chooseExemplar=function(){this.object.chooseExemplar()},SpriteIconMorph.prototype.releaseSprite=function(){this.object.release()},SpriteIconMorph.prototype.showSpriteOnStage=function(){this.object.showOnStage()},SpriteIconMorph.prototype.mouseDoubleClick=function(){this.object instanceof SpriteMorph&&this.object.flash()},SpriteIconMorph.prototype.createBackgrounds=function(){var context,ext=this.extent();return this.template?(this.image=this.template.image,this.normalImage=this.template.normalImage,
this.highlightImage=this.template.highlightImage,this.pressImage=this.template.pressImage,null):(this.normalImage=newCanvas(ext),context=this.normalImage.getContext("2d"),this.drawBackground(context,this.color),this.highlightImage=newCanvas(ext),context=this.highlightImage.getContext("2d"),this.drawBackground(context,this.highlightColor),this.pressImage=newCanvas(ext),context=this.pressImage.getContext("2d"),this.drawOutline(context),this.drawBackground(context,this.pressColor),this.drawEdges(context,this.pressColor,this.pressColor.lighter(this.contrast),this.pressColor.darker(this.contrast)),void(this.image=this.normalImage))},SpriteIconMorph.prototype.prepareToBeGrabbed=function(){
var idx,ide=this.parentThatIsA(IDE_Morph);this.mouseClickLeft(),this.alpha=.85,ide&&(idx=ide.sprites.asArray().indexOf(this.object),ide.sprites.remove(idx+1),ide.createCorral(),ide.fixLayout())},SpriteIconMorph.prototype.justDropped=function(){this.alpha=1},SpriteIconMorph.prototype.wantsDropOf=function(morph){return morph instanceof BlockMorph||morph instanceof CostumeIconMorph||morph instanceof SoundIconMorph},SpriteIconMorph.prototype.reactToDropOf=function(morph,hand){morph instanceof BlockMorph?this.copyStack(morph):morph instanceof CostumeIconMorph?this.copyCostume(morph.object):morph instanceof SoundIconMorph&&this.copySound(morph.object),this.world().add(morph),
morph.slideBackTo(hand.grabOrigin)},SpriteIconMorph.prototype.copyStack=function(block){var sprite=this.object,dup=block.fullCopy(),y=Math.max(sprite.scripts.children.map(function(stack){return stack.fullBounds().bottom()}).concat([sprite.scripts.top()]));dup.setPosition(new Point(sprite.scripts.left()+20,y+20)),sprite.scripts.add(dup),dup.allComments().forEach(function(comment){comment.align(dup)}),sprite.scripts.adjustBounds(),dup.allChildren().forEach(function(morph){!morph.isCustomBlock||morph.isGlobal||sprite.getMethod(morph.blockSpec)||morph.deleteBlock()})},SpriteIconMorph.prototype.copyCostume=function(costume){var dup=costume.copy();dup.name=this.object.newCostumeName(dup.name),
this.object.addCostume(dup),this.object.wearCostume(dup)},SpriteIconMorph.prototype.copySound=function(sound){var dup=sound.copy();this.object.addSound(dup.audio,dup.name)},CostumeIconMorph.prototype=new ToggleButtonMorph,CostumeIconMorph.prototype.constructor=CostumeIconMorph,CostumeIconMorph.uber=ToggleButtonMorph.prototype,CostumeIconMorph.prototype.thumbSize=new Point(80,60),CostumeIconMorph.prototype.labelShadowOffset=null,CostumeIconMorph.prototype.labelShadowColor=null,CostumeIconMorph.prototype.labelColor=new Color(255,255,255),CostumeIconMorph.prototype.fontSize=9,CostumeIconMorph.prototype.init=function(aCostume,aTemplate){var colors,action,query,myself=this;
aTemplate||(colors=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor]),action=function(){var ide=myself.parentThatIsA(IDE_Morph),wardrobe=myself.parentThatIsA(WardrobeMorph);ide&&ide.currentSprite.wearCostume(myself.object),wardrobe&&wardrobe.updateSelection()},query=function(){var ide=myself.parentThatIsA(IDE_Morph);return!!ide&&ide.currentSprite.costume===myself.object},this.object=aCostume||new Costume,this.version=this.object.version,this.thumbnail=null,CostumeIconMorph.uber.init.call(this,colors,null,action,this.object.name,query,null,null,aTemplate),this.isDraggable=!0,this.createThumbnail(),this.padding=2,this.corner=8,
this.fixLayout(),this.fps=1},CostumeIconMorph.prototype.createThumbnail=function(){var txt;SpriteIconMorph.prototype.createThumbnail.call(this),this.object instanceof SVG_Costume&&(txt=new StringMorph("svg",.8*this.fontSize,this.fontStyle,!1,!1,!1,this.labelShadowOffset,this.labelShadowColor,this.labelColor),txt.setBottom(this.thumbnail.bottom()),this.thumbnail.add(txt))},CostumeIconMorph.prototype.createLabel=SpriteIconMorph.prototype.createLabel,CostumeIconMorph.prototype.step=SpriteIconMorph.prototype.step,CostumeIconMorph.prototype.fixLayout=SpriteIconMorph.prototype.fixLayout,CostumeIconMorph.prototype.userMenu=function(){var menu=new MenuMorph(this);return this.object instanceof Costume?(menu.addItem("edit","editCostume"),
16===this.world().currentKey&&menu.addItem("edit rotation point only...","editRotationPointOnly",null,new Color(100,0,0)),menu.addItem("rename","renameCostume"),menu.addLine(),menu.addItem("duplicate","duplicateCostume"),menu.addItem("delete","removeCostume"),menu.addLine(),menu.addItem("export","exportCostume"),menu):null},CostumeIconMorph.prototype.editCostume=function(){this.disinherit(),this.object instanceof SVG_Costume?this.object.editRotationPointOnly(this.world()):this.object.edit(this.world(),this.parentThatIsA(IDE_Morph),!1)},CostumeIconMorph.prototype.editRotationPointOnly=function(){var ide=this.parentThatIsA(IDE_Morph);this.object.editRotationPointOnly(this.world()),
ide.hasChangedMedia=!0},CostumeIconMorph.prototype.renameCostume=function(){this.disinherit();var costume=this.object,wardrobe=this.parentThatIsA(WardrobeMorph),ide=this.parentThatIsA(IDE_Morph);new DialogBoxMorph(null,function(answer){answer&&answer!==costume.name&&(costume.name=wardrobe.sprite.newCostumeName(answer,costume),costume.version=Date.now(),ide.hasChangedMedia=!0)}).prompt(this.currentSprite instanceof SpriteMorph?"rename costume":"rename background",costume.name,this.world())},CostumeIconMorph.prototype.duplicateCostume=function(){var wardrobe=this.parentThatIsA(WardrobeMorph),ide=this.parentThatIsA(IDE_Morph),newcos=this.object.copy();newcos.name=wardrobe.sprite.newCostumeName(newcos.name),
wardrobe.sprite.addCostume(newcos),wardrobe.updateList(),ide&&ide.currentSprite.wearCostume(newcos)},CostumeIconMorph.prototype.removeCostume=function(){var wardrobe=this.parentThatIsA(WardrobeMorph),idx=this.parent.children.indexOf(this),off=CamSnapshotDialogMorph.prototype.enableCamera?3:2,ide=this.parentThatIsA(IDE_Morph);wardrobe.removeCostumeAt(idx-off),ide.currentSprite.costume===this.object&&ide.currentSprite.wearCostume(null)},CostumeIconMorph.prototype.exportCostume=function(){var ide=this.parentThatIsA(IDE_Morph);this.object instanceof SVG_Costume?ide.saveFileAs(this.object.contents.src,"text/svg",this.object.name):ide.saveCanvasAs(this.object.contents,this.object.name);
},CostumeIconMorph.prototype.createBackgrounds=SpriteIconMorph.prototype.createBackgrounds,CostumeIconMorph.prototype.disinherit=function(){var wardrobe=this.parentThatIsA(WardrobeMorph),idx=this.parent.children.indexOf(this);wardrobe.sprite.inheritsAttribute("costumes")&&(wardrobe.sprite.shadowAttribute("costumes"),this.object=wardrobe.sprite.costumes.at(idx-2))},CostumeIconMorph.prototype.prepareToBeGrabbed=function(){this.disinherit(),this.mouseClickLeft(),this.removeCostume()},TurtleIconMorph.prototype=new ToggleButtonMorph,TurtleIconMorph.prototype.constructor=TurtleIconMorph,TurtleIconMorph.uber=ToggleButtonMorph.prototype,TurtleIconMorph.prototype.thumbSize=new Point(80,60),
TurtleIconMorph.prototype.labelShadowOffset=null,TurtleIconMorph.prototype.labelShadowColor=null,TurtleIconMorph.prototype.labelColor=new Color(255,255,255),TurtleIconMorph.prototype.fontSize=9,TurtleIconMorph.prototype.init=function(aSpriteOrStage,aTemplate){var colors,action,query,myself=this;aTemplate||(colors=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor]),action=function(){var ide=myself.parentThatIsA(IDE_Morph),wardrobe=myself.parentThatIsA(WardrobeMorph);ide&&ide.currentSprite.wearCostume(null),wardrobe&&wardrobe.updateSelection()},query=function(){var ide=myself.parentThatIsA(IDE_Morph);return!!ide&&null===ide.currentSprite.costume;
},this.object=aSpriteOrStage,this.version=this.object.version,this.thumbnail=null,TurtleIconMorph.uber.init.call(this,colors,null,action,"default",query,null,null,aTemplate),this.isDraggable=!1,this.createThumbnail(),this.padding=2,this.corner=8,this.fixLayout()},TurtleIconMorph.prototype.createThumbnail=function(){var isFlat=MorphicPreferences.isFlat;this.thumbnail&&this.thumbnail.destroy(),this.object instanceof SpriteMorph?this.thumbnail=new SymbolMorph("turtle",this.thumbSize.y,this.labelColor,isFlat?null:new Point(-1,-1),new Color(0,0,0)):this.thumbnail=new SymbolMorph("stage",this.thumbSize.y,this.labelColor,isFlat?null:new Point(-1,-1),new Color(0,0,0)),
this.add(this.thumbnail)},TurtleIconMorph.prototype.createLabel=function(){var txt;this.label&&this.label.destroy(),txt=new StringMorph(localize(this.object instanceof SpriteMorph?"Turtle":"Empty"),this.fontSize,this.fontStyle,!0,!1,!1,this.labelShadowOffset,this.labelShadowColor,this.labelColor),this.label=new FrameMorph,this.label.acceptsDrops=!1,this.label.alpha=0,this.label.setExtent(txt.extent()),txt.setPosition(this.label.position()),this.label.add(txt),this.add(this.label)},TurtleIconMorph.prototype.fixLayout=SpriteIconMorph.prototype.fixLayout,TurtleIconMorph.prototype.createBackgrounds=SpriteIconMorph.prototype.createBackgrounds,TurtleIconMorph.prototype.userMenu=function(){
var myself=this,menu=new MenuMorph(this,"pen"),on="●",off="○";return this.object instanceof StageMorph?null:(menu.addItem(("tip"===this.object.penPoint?on:off)+" "+localize("tip"),function(){myself.object.penPoint="tip",myself.object.changed(),myself.object.drawNew(),myself.object.changed()}),menu.addItem(("middle"===this.object.penPoint?on:off)+" "+localize("middle"),function(){myself.object.penPoint="middle",myself.object.changed(),myself.object.drawNew(),myself.object.changed()}),menu)},WardrobeMorph.prototype=new ScrollFrameMorph,WardrobeMorph.prototype.constructor=WardrobeMorph,WardrobeMorph.uber=ScrollFrameMorph.prototype,WardrobeMorph.prototype.init=function(aSprite,sliderColor){
this.sprite=aSprite||new SpriteMorph,this.costumesVersion=null,this.spriteVersion=null,WardrobeMorph.uber.init.call(this,null,null,sliderColor),this.fps=2,this.updateList()},WardrobeMorph.prototype.updateList=function(){var icon,template,txt,paintbutton,cambutton,myself=this,x=this.left()+5,y=this.top()+5,padding=4,toolsPadding=5,oldFlag=Morph.prototype.trackChanges,oldPos=this.contents.position();this.changed(),oldFlag=Morph.prototype.trackChanges,Morph.prototype.trackChanges=!1,this.contents.destroy(),this.contents=new FrameMorph(this),this.contents.acceptsDrops=!1,this.contents.reactToDropOf=function(icon){myself.reactToDropOf(icon)},this.addBack(this.contents),
icon=new TurtleIconMorph(this.sprite),icon.setPosition(new Point(x,y)),myself.addContents(icon),y=icon.bottom()+padding,paintbutton=new PushButtonMorph(this,"paintNew",new SymbolMorph("brush",15)),paintbutton.padding=0,paintbutton.corner=12,paintbutton.color=IDE_Morph.prototype.groupColor,paintbutton.highlightColor=IDE_Morph.prototype.frameColor.darker(50),paintbutton.pressColor=paintbutton.highlightColor,paintbutton.labelMinExtent=new Point(36,18),paintbutton.labelShadowOffset=new Point(-1,-1),paintbutton.labelShadowColor=paintbutton.highlightColor,paintbutton.labelColor=TurtleIconMorph.prototype.labelColor,paintbutton.contrast=this.buttonContrast,paintbutton.drawNew(),
paintbutton.hint="Paint a new costume",paintbutton.setPosition(new Point(x,y)),paintbutton.fixLayout(),paintbutton.setCenter(icon.center()),paintbutton.setLeft(icon.right()+4*padding),this.addContents(paintbutton),CamSnapshotDialogMorph.prototype.enableCamera&&(cambutton=new PushButtonMorph(this,"newFromCam",new SymbolMorph("camera",15)),cambutton.padding=0,cambutton.corner=12,cambutton.color=IDE_Morph.prototype.groupColor,cambutton.highlightColor=IDE_Morph.prototype.frameColor.darker(50),cambutton.pressColor=paintbutton.highlightColor,cambutton.labelMinExtent=new Point(36,18),cambutton.labelShadowOffset=new Point(-1,-1),cambutton.labelShadowColor=paintbutton.highlightColor,
cambutton.labelColor=TurtleIconMorph.prototype.labelColor,cambutton.contrast=this.buttonContrast,cambutton.drawNew(),cambutton.hint="Import a new costume from your webcam",cambutton.setPosition(new Point(x,y)),cambutton.fixLayout(),cambutton.setCenter(paintbutton.center()),cambutton.setLeft(paintbutton.right()+toolsPadding),this.addContents(cambutton),CamSnapshotDialogMorph.prototype.enabled||(cambutton.disable(),cambutton.hint=CamSnapshotDialogMorph.prototype.notSupportedMessage),document.addEventListener("cameraDisabled",function(){cambutton.disable(),cambutton.hint=CamSnapshotDialogMorph.prototype.notSupportedMessage})),txt=new TextMorph(localize("costumes tab help")),
txt.fontSize=9,txt.setColor(SpriteMorph.prototype.paletteTextColor),txt.setPosition(new Point(x,y)),this.addContents(txt),y=txt.bottom()+padding,this.sprite.costumes.asArray().forEach(function(costume){template=icon=new CostumeIconMorph(costume,template),icon.setPosition(new Point(x,y)),myself.addContents(icon),y=icon.bottom()+padding}),this.costumesVersion=this.sprite.costumes.lastChanged,this.contents.setPosition(oldPos),this.adjustScrollBars(),Morph.prototype.trackChanges=oldFlag,this.changed(),this.updateSelection()},WardrobeMorph.prototype.updateSelection=function(){this.contents.children.forEach(function(morph){morph.refresh&&morph.refresh()}),this.spriteVersion=this.sprite.version;
},WardrobeMorph.prototype.step=function(){this.costumesVersion!==this.sprite.costumes.lastChanged&&this.updateList(),this.spriteVersion!==this.sprite.version&&this.updateSelection()},WardrobeMorph.prototype.removeCostumeAt=function(idx){this.sprite.shadowAttribute("costumes"),this.sprite.costumes.remove(idx),this.updateList()},WardrobeMorph.prototype.paintNew=function(){var cos=new Costume(newCanvas(null,!0),this.sprite.newCostumeName(localize("Untitled"))),ide=this.parentThatIsA(IDE_Morph),myself=this;cos.edit(this.world(),ide,!0,null,function(){myself.sprite.shadowAttribute("costumes"),myself.sprite.addCostume(cos),myself.updateList(),ide&&ide.currentSprite.wearCostume(cos);
})},WardrobeMorph.prototype.newFromCam=function(){var camDialog,ide=this.parentThatIsA(IDE_Morph),myself=this,sprite=this.sprite;camDialog=new CamSnapshotDialogMorph(ide,sprite,nop,function(costume){sprite.addCostume(costume),sprite.wearCostume(costume),myself.updateList()}),camDialog.popUp(this.world())},WardrobeMorph.prototype.wantsDropOf=function(morph){return morph instanceof CostumeIconMorph},WardrobeMorph.prototype.reactToDropOf=function(icon){var idx=0,costume=icon.object,top=icon.top();icon.destroy(),this.contents.children.forEach(function(item){item instanceof CostumeIconMorph&&item.top()<top-4&&(idx+=1)}),this.sprite.shadowAttribute("costumes"),this.sprite.costumes.add(costume,idx+1),
this.updateList(),icon.mouseClickLeft()},SoundIconMorph.prototype=new ToggleButtonMorph,SoundIconMorph.prototype.constructor=SoundIconMorph,SoundIconMorph.uber=ToggleButtonMorph.prototype,SoundIconMorph.prototype.thumbSize=new Point(80,60),SoundIconMorph.prototype.labelShadowOffset=null,SoundIconMorph.prototype.labelShadowColor=null,SoundIconMorph.prototype.labelColor=new Color(255,255,255),SoundIconMorph.prototype.fontSize=9,SoundIconMorph.prototype.init=function(aSound,aTemplate){var colors,action,query;aTemplate||(colors=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor]),action=function(){nop()},query=function(){
return!1},this.object=aSound,this.version=this.object.version,this.thumbnail=null,SoundIconMorph.uber.init.call(this,colors,null,action,this.object.name,query,null,null,aTemplate),this.isDraggable=!0,this.createThumbnail(),this.padding=2,this.corner=8,this.fixLayout(),this.fps=1},SoundIconMorph.prototype.createThumbnail=function(){var label;this.thumbnail&&this.thumbnail.destroy(),this.thumbnail=new Morph,this.thumbnail.setExtent(this.thumbSize),this.add(this.thumbnail),label=new StringMorph(this.createInfo(),"16","",!0,!1,!1,this.labelShadowOffset,this.labelShadowColor,new Color(200,200,200)),this.thumbnail.add(label),label.setCenter(new Point(40,15)),this.button=new PushButtonMorph(this,"toggleAudioPlaying",this.object.previewAudio?"Stop":"Play"),
this.button.drawNew(),this.button.hint="Play sound",this.button.fixLayout(),this.thumbnail.add(this.button),this.button.setCenter(new Point(40,40))},SoundIconMorph.prototype.createInfo=function(){var dur=Math.round(this.object.audio.duration||0),mod=dur%60;return Math.floor(dur/60).toString()+":"+(mod<10?"0":"")+mod.toString()},SoundIconMorph.prototype.toggleAudioPlaying=function(){var myself=this;this.object.previewAudio?(this.button.labelString="Play",this.button.hint="Play sound",this.object.previewAudio.pause(),this.object.previewAudio.terminated=!0,this.object.previewAudio=null):(this.button.labelString="Stop",this.button.hint="Stop sound",this.object.previewAudio=this.object.play(),
this.object.previewAudio.addEventListener("ended",function(){myself.audioHasEnded()},!1)),this.button.createLabel()},SoundIconMorph.prototype.audioHasEnded=function(){this.button.trigger(),this.button.mouseLeave()},SoundIconMorph.prototype.createLabel=SpriteIconMorph.prototype.createLabel,SoundIconMorph.prototype.fixLayout=SpriteIconMorph.prototype.fixLayout,SoundIconMorph.prototype.userMenu=function(){var menu=new MenuMorph(this);return this.object instanceof Sound?(menu.addItem("rename","renameSound"),menu.addItem("delete","removeSound"),menu):null},SoundIconMorph.prototype.renameSound=function(){var sound=this.object,ide=this.parentThatIsA(IDE_Morph),myself=this;
this.disinherit(),new DialogBoxMorph(null,function(answer){answer&&answer!==sound.name&&(sound.name=answer,sound.version=Date.now(),myself.createLabel(),myself.fixLayout(),ide.hasChangedMedia=!0)}).prompt("rename sound",sound.name,this.world())},SoundIconMorph.prototype.removeSound=function(){var jukebox=this.parentThatIsA(JukeboxMorph),idx=this.parent.children.indexOf(this);jukebox.removeSound(idx)},SoundIconMorph.prototype.createBackgrounds=SpriteIconMorph.prototype.createBackgrounds,SoundIconMorph.prototype.createLabel=SpriteIconMorph.prototype.createLabel,SoundIconMorph.prototype.disinherit=function(){var jukebox=this.parentThatIsA(JukeboxMorph),idx=this.parent.children.indexOf(this);
jukebox.sprite.inheritsAttribute("sounds")&&(jukebox.sprite.shadowAttribute("sounds"),this.object=jukebox.sprite.sounds.at(idx))},SoundIconMorph.prototype.prepareToBeGrabbed=function(){this.disinherit(),this.removeSound()},JukeboxMorph.prototype=new ScrollFrameMorph,JukeboxMorph.prototype.constructor=JukeboxMorph,JukeboxMorph.uber=ScrollFrameMorph.prototype,JukeboxMorph.prototype.init=function(aSprite,sliderColor){this.sprite=aSprite||new SpriteMorph,this.soundsVersion=null,this.spriteVersion=null,JukeboxMorph.uber.init.call(this,null,null,sliderColor),this.acceptsDrops=!1,this.fps=2,this.updateList()},JukeboxMorph.prototype.updateList=function(){var icon,template,txt,myself=this,x=this.left()+5,y=this.top()+5,padding=4,oldFlag=Morph.prototype.trackChanges;
this.changed(),oldFlag=Morph.prototype.trackChanges,Morph.prototype.trackChanges=!1,this.contents.destroy(),this.contents=new FrameMorph(this),this.contents.acceptsDrops=!1,this.contents.reactToDropOf=function(icon){myself.reactToDropOf(icon)},this.addBack(this.contents),txt=new TextMorph(localize("import a sound from your computer\nby dragging it into here")),txt.fontSize=9,txt.setColor(SpriteMorph.prototype.paletteTextColor),txt.setPosition(new Point(x,y)),this.addContents(txt),y=txt.bottom()+padding,this.sprite.sounds.asArray().forEach(function(sound){template=icon=new SoundIconMorph(sound,template),icon.setPosition(new Point(x,y)),myself.addContents(icon),
y=icon.bottom()+padding}),this.soundsVersion=this.sprite.costumes.lastChanged,Morph.prototype.trackChanges=oldFlag,this.changed(),this.updateSelection()},JukeboxMorph.prototype.updateSelection=function(){this.contents.children.forEach(function(morph){morph.refresh&&morph.refresh()}),this.spriteVersion=this.sprite.version},JukeboxMorph.prototype.step=function(){this.soundsVersion!==this.sprite.sounds.lastChanged&&this.updateList(),this.spriteVersion!==this.sprite.version&&this.updateSelection()},JukeboxMorph.prototype.removeSound=function(idx){this.sprite.sounds.remove(idx),this.updateList()},JukeboxMorph.prototype.wantsDropOf=function(morph){return morph instanceof SoundIconMorph;
},JukeboxMorph.prototype.reactToDropOf=function(icon){var idx=0,costume=icon.object,top=icon.top();icon.destroy(),this.contents.children.forEach(function(item){item.top()<top-4&&(idx+=1)}),this.sprite.shadowAttribute("sounds"),this.sprite.sounds.add(costume,idx),this.updateList()},StageHandleMorph.prototype=new Morph,StageHandleMorph.prototype.constructor=StageHandleMorph,StageHandleMorph.uber=Morph.prototype,StageHandleMorph.prototype.init=function(target){this.target=target||null,HandleMorph.uber.init.call(this),this.color=MorphicPreferences.isFlat?IDE_Morph.prototype.groupColor:new Color(190,190,190),this.isDraggable=!1,this.noticesTransparentClick=!0,this.setExtent(new Point(12,50));
},StageHandleMorph.prototype.drawNew=function(){this.normalImage=newCanvas(this.extent()),this.highlightImage=newCanvas(this.extent()),this.drawOnCanvas(this.normalImage,this.color),this.drawOnCanvas(this.highlightImage,MorphicPreferences.isFlat?new Color(245,245,255):new Color(100,100,255),this.color),this.image=this.normalImage,this.fixLayout()},StageHandleMorph.prototype.drawOnCanvas=function(aCanvas,color,shadowColor){var x,y,i,context=aCanvas.getContext("2d"),l=aCanvas.height/8,w=aCanvas.width/6,r=w/2;for(context.lineWidth=w,context.lineCap="round",y=aCanvas.height/2,context.strokeStyle=color.toString(),x=aCanvas.width/12,i=0;i<3;i+=1)i>0&&(context.beginPath(),
context.moveTo(x,y-(l-r)),context.lineTo(x,y+(l-r)),context.stroke()),x+=2*w,l*=2;if(shadowColor)for(context.strokeStyle=shadowColor.toString(),x=aCanvas.width/12+w,l=aCanvas.height/8,i=0;i<3;i+=1)i>0&&(context.beginPath(),context.moveTo(x,y-(l-r)),context.lineTo(x,y+(l-r)),context.stroke()),x+=2*w,l*=2},StageHandleMorph.prototype.fixLayout=function(){if(this.target){var ide=this.target.parentThatIsA(IDE_Morph);this.setTop(this.target.top()+10),this.setRight(this.target.left()),ide&&ide.add(this)}},StageHandleMorph.prototype.step=null,StageHandleMorph.prototype.mouseDownLeft=function(pos){var world=this.world(),offset=this.right()-pos.x,myself=this,ide=this.target.parentThatIsA(IDE_Morph);
return this.target?(ide.isSmallStage=!0,ide.controlBar.stageSizeButton.refresh(),void(this.step=function(){var newPos,newWidth;world.hand.mouseButton?(newPos=world.hand.bounds.origin.x+offset,newWidth=myself.target.right()-newPos,ide.stageRatio=newWidth/myself.target.dimensions.x,ide.setExtent(world.extent())):(this.step=null,ide.isSmallStage=1!==ide.stageRatio,ide.controlBar.stageSizeButton.refresh())})):null},StageHandleMorph.prototype.mouseEnter=function(){this.image=this.highlightImage,this.changed()},StageHandleMorph.prototype.mouseLeave=function(){this.image=this.normalImage,this.changed()},StageHandleMorph.prototype.mouseDoubleClick=function(){this.target.parentThatIsA(IDE_Morph).toggleStageSize(!0,1);
},PaletteHandleMorph.prototype=new Morph,PaletteHandleMorph.prototype.constructor=PaletteHandleMorph,PaletteHandleMorph.uber=Morph.prototype,PaletteHandleMorph.prototype.init=function(target){this.target=target||null,HandleMorph.uber.init.call(this),this.color=MorphicPreferences.isFlat?new Color(255,255,255):new Color(190,190,190),this.isDraggable=!1,this.noticesTransparentClick=!0,this.setExtent(new Point(12,50))},PaletteHandleMorph.prototype.drawNew=StageHandleMorph.prototype.drawNew,PaletteHandleMorph.prototype.drawOnCanvas=StageHandleMorph.prototype.drawOnCanvas,PaletteHandleMorph.prototype.fixLayout=function(){if(this.target){var ide=this.target.parentThatIsA(IDE_Morph);
this.setTop(this.target.top()+10),this.setRight(this.target.right()),ide&&ide.add(this)}},PaletteHandleMorph.prototype.step=null,PaletteHandleMorph.prototype.mouseDownLeft=function(pos){var world=this.world(),offset=this.right()-pos.x,ide=this.target.parentThatIsA(IDE_Morph);return this.target?void(this.step=function(){var newPos;world.hand.mouseButton?(newPos=world.hand.bounds.origin.x+offset,ide.paletteWidth=Math.min(Math.max(200,newPos),ide.stageHandle.left()-ide.spriteBar.tabBar.width()),ide.setExtent(world.extent())):this.step=null}):null},PaletteHandleMorph.prototype.mouseEnter=StageHandleMorph.prototype.mouseEnter,PaletteHandleMorph.prototype.mouseLeave=StageHandleMorph.prototype.mouseLeave,
PaletteHandleMorph.prototype.mouseDoubleClick=function(){this.target.parentThatIsA(IDE_Morph).setPaletteWidth(200)},CamSnapshotDialogMorph.prototype=new DialogBoxMorph,CamSnapshotDialogMorph.prototype.constructor=CamSnapshotDialogMorph,CamSnapshotDialogMorph.uber=DialogBoxMorph.prototype,CamSnapshotDialogMorph.prototype.enableCamera=!0,CamSnapshotDialogMorph.prototype.enabled=!0,CamSnapshotDialogMorph.prototype.notSupportedMessage='Please make sure your web browser is up to date\nand your camera is properly configured. \n\nSome browsers also require you to access Snap!\nthrough HTTPS to use the camera.\n\nPlase replace the "http://" part of the address\nin your browser by "https://" and try again.',
CamSnapshotDialogMorph.prototype.init=function(ide,sprite,onCancel,onAccept){this.ide=ide,this.sprite=sprite,this.padding=10,this.oncancel=onCancel,this.accept=onAccept,this.videoElement=null,this.videoView=new Morph,CamSnapshotDialogMorph.uber.init.call(this),this.labelString="Camera",this.createLabel(),this.buildContents()},CamSnapshotDialogMorph.prototype.buildContents=function(){function noCameraSupport(){myself.disable(),myself.ide.inform("Camera not supported",CamSnapshotDialogMorph.prototype.notSupportedMessage),myself.videoElement&&myself.videoElement.remove(),myself.cancel()}var myself=this,stage=this.sprite.parentThatIsA(StageMorph);this.videoElement=document.createElement("video"),
this.videoElement.hidden=!0,this.videoElement.width=stage.dimensions.x,this.videoElement.height=stage.dimensions.y,document.body.appendChild(this.videoElement),navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&navigator.mediaDevices.getUserMedia({video:!0}).then(function(stream){myself.videoElement.srcObject=stream,myself.videoElement.play().catch(noCameraSupport),myself.videoElement.stream=stream}).catch(noCameraSupport),this.videoView.setExtent(stage.dimensions),this.videoView.image=newCanvas(stage.dimensions),this.videoView.drawOn=function(aCanvas){var clippingWidth,clippingHeight,context=aCanvas.getContext("2d"),videoWidth=myself.videoElement.videoWidth,videoHeight=myself.videoElement.videoHeight,w=stage.dimensions.x,h=stage.dimensions.y;
videoWidth&&(context.save(),context.translate(w,0),context.scale(-1,1),videoWidth/w>videoHeight/h?(clippingWidth=w*(videoHeight/h),clippingHeight=videoHeight):(clippingWidth=videoWidth,clippingHeight=h*(videoWidth/w)),context.drawImage(myself.videoElement,0,0,clippingWidth,clippingHeight,this.left()*-1,this.top(),w,h),context.restore())},this.videoView.step=function(){this.changed()},this.addBody(new AlignmentMorph("column",this.padding/2)),this.body.add(this.videoView),this.body.fixLayout(),this.addButton("ok","Save"),this.addButton("cancel","Cancel"),this.fixLayout(),this.drawNew()},CamSnapshotDialogMorph.prototype.ok=function(){this.accept(new Costume(this.videoView.fullImageClassic(),this.sprite.newCostumeName("camera")).flipped());
},CamSnapshotDialogMorph.prototype.disable=function(){CamSnapshotDialogMorph.prototype.enabled=!1,document.dispatchEvent(new Event("cameraDisabled"))},CamSnapshotDialogMorph.prototype.destroy=function(){this.oncancel.call(this),this.close()},CamSnapshotDialogMorph.prototype.close=function(){this.videoElement&&this.videoElement.stream&&(this.videoElement.stream.getTracks()[0].stop(),this.videoElement.remove()),CamSnapshotDialogMorph.uber.destroy.call(this)},modules.paint="2017-April-10";var PaintEditorMorph,PaintCanvasMorph,PaintColorPickerMorph;PaintEditorMorph.prototype=new DialogBoxMorph,PaintEditorMorph.prototype.constructor=PaintEditorMorph,PaintEditorMorph.uber=DialogBoxMorph.prototype,
PaintEditorMorph.prototype.padding=10,PaintEditorMorph.prototype.init=function(){this.paper=null,this.oncancel=null,PaintEditorMorph.uber.init.call(this),this.labelString="Paint Editor",this.createLabel(),this.buildContents()},PaintEditorMorph.prototype.buildContents=function(){var myself=this;this.paper=new PaintCanvasMorph(function(){return myself.shift}),this.paper.setExtent(StageMorph.prototype.dimensions),this.addBody(new AlignmentMorph("row",this.padding)),this.controls=new AlignmentMorph("column",this.padding/2),this.controls.alignment="left",this.edits=new AlignmentMorph("row",this.padding/2),this.buildEdits(),this.controls.add(this.edits),this.body.color=this.color,
this.body.add(this.controls),this.body.add(this.paper),this.toolbox=new BoxMorph,this.toolbox.color=SpriteMorph.prototype.paletteColor.lighter(8),this.toolbox.borderColor=this.toolbox.color.lighter(40),MorphicPreferences.isFlat&&(this.toolbox.edge=0),this.buildToolbox(),this.controls.add(this.toolbox),this.scaleBox=new AlignmentMorph("row",this.padding/2),this.buildScaleBox(),this.controls.add(this.scaleBox),this.propertiesControls={colorpicker:null,penSizeSlider:null,penSizeField:null,primaryColorButton:null,primaryColorViewer:null,constrain:null},this.populatePropertiesMenu(),this.addButton("ok","OK"),this.addButton("cancel","Cancel"),this.refreshToolButtons(),
this.fixLayout(),this.drawNew()},PaintEditorMorph.prototype.buildToolbox=function(){var tools={brush:"Paintbrush tool\n(free draw)",rectangle:"Stroked Rectangle\n(shift: square)",circle:"Stroked Ellipse\n(shift: circle)",eraser:"Eraser tool",crosshairs:"Set the rotation center",line:"Line tool\n(shift: vertical/horizontal)",rectangleSolid:"Filled Rectangle\n(shift: square)",circleSolid:"Filled Ellipse\n(shift: circle)",paintbucket:"Fill a region",pipette:"Pipette tool\n(pick a color anywhere)"},myself=this,left=this.toolbox.left(),top=this.toolbox.top(),padding=2,inset=5,x=0,y=0;Object.keys(tools).forEach(function(tool){var btn=myself.toolButton(tool,tools[tool]);
btn.setPosition(new Point(left+x,top+y)),x+=btn.width()+padding,"crosshairs"===tool&&(x=0,y+=btn.height()+padding,myself.paper.drawcrosshair()),myself.toolbox[tool]=btn,myself.toolbox.add(btn)}),this.toolbox.bounds=this.toolbox.fullBounds().expandBy(2*inset),this.toolbox.drawNew()},PaintEditorMorph.prototype.buildEdits=function(){var paper=this.paper;this.edits.add(this.pushButton("undo",function(){paper.undo()})),this.edits.add(this.pushButton("clear",function(){paper.clearCanvas()})),this.edits.fixLayout()},PaintEditorMorph.prototype.buildScaleBox=function(){var paper=this.paper;this.scaleBox.add(this.pushButton("grow",function(){paper.scale(.05,.05)})),this.scaleBox.add(this.pushButton("shrink",function(){
paper.scale(-.05,-.05)})),this.scaleBox.add(this.pushButton("flip ↔",function(){paper.scale(-2,0)})),this.scaleBox.add(this.pushButton("flip ↕",function(){paper.scale(0,-2)})),this.scaleBox.fixLayout()},PaintEditorMorph.prototype.openIn=function(world,oldim,oldrc,callback){this.oldim=oldim,this.callback=callback||nop,this.processKeyUp=function(){this.shift=!1,this.propertiesControls.constrain.refresh()},this.processKeyDown=function(){this.shift=16===this.world().currentKey,this.propertiesControls.constrain.refresh()},this.oldim&&(this.paper.automaticCrosshairs=isNil(oldrc),this.paper.centermerge(this.oldim,this.paper.paper),this.paper.rotationCenter=(oldrc||new Point(0,0)).add(new Point((this.paper.paper.width-this.oldim.width)/2,(this.paper.paper.height-this.oldim.height)/2)),
this.paper.drawNew()),this.key="paint",this.popUp(world)},PaintEditorMorph.prototype.fixLayout=function(){var oldFlag=Morph.prototype.trackChanges;this.changed(),oldFlag=Morph.prototype.trackChanges,Morph.prototype.trackChanges=!1,this.paper&&(this.paper.buildContents(),this.paper.drawNew()),this.controls&&this.controls.fixLayout(),this.body&&this.body.fixLayout(),PaintEditorMorph.uber.fixLayout.call(this),Morph.prototype.trackChanges=oldFlag,this.changed()},PaintEditorMorph.prototype.refreshToolButtons=function(){this.toolbox.children.forEach(function(toggle){toggle.refresh()})},PaintEditorMorph.prototype.ok=function(){this.paper.updateAutomaticCenter(),this.callback(this.paper.paper,this.paper.rotationCenter),
this.destroy()},PaintEditorMorph.prototype.cancel=function(){this.oncancel&&this.oncancel(),this.destroy()},PaintEditorMorph.prototype.populatePropertiesMenu=function(){var c=this.controls,myself=this,pc=this.propertiesControls,alpen=new AlignmentMorph("row",this.padding);pc.primaryColorViewer=new Morph,pc.primaryColorViewer.setExtent(new Point(180,50)),pc.primaryColorViewer.color=new Color(0,0,0),pc.colorpicker=new PaintColorPickerMorph(new Point(180,100),function(color){var i,j,ni=newCanvas(pc.primaryColorViewer.extent()),ctx=ni.getContext("2d");if(myself.paper.settings.primarycolor=color,"transparent"===color)for(i=0;i<180;i+=5)for(j=0;j<15;j+=5)ctx.fillStyle=(j+i)/5%2===0?"rgba(0, 0, 0, 0.2)":"rgba(0, 0, 0, 0.5)",
ctx.fillRect(i,j,5,5);else ctx.fillStyle=color.toString(),ctx.fillRect(0,0,180,15);ctx.strokeStyle="black",ctx.lineWidth=Math.min(myself.paper.settings.linewidth,20),ctx.beginPath(),ctx.lineCap="round",ctx.moveTo(20,30),ctx.lineTo(160,30),ctx.stroke(),pc.primaryColorViewer.image=ni,pc.primaryColorViewer.changed()}),pc.colorpicker.action(new Color(0,0,0)),pc.penSizeSlider=new SliderMorph(0,20,5,5),pc.penSizeSlider.orientation="horizontal",pc.penSizeSlider.setHeight(15),pc.penSizeSlider.setWidth(150),pc.penSizeSlider.action=function(num){pc.penSizeField&&pc.penSizeField.setContents(num),myself.paper.settings.linewidth=num,pc.colorpicker.action(myself.paper.settings.primarycolor);
},pc.penSizeField=new InputFieldMorph("5",!0,null,!1),pc.penSizeField.contents().minWidth=20,pc.penSizeField.setWidth(25),pc.penSizeField.accept=function(){var val=parseFloat(pc.penSizeField.getValue());pc.penSizeSlider.value=val,pc.penSizeSlider.drawNew(),pc.penSizeSlider.updateValue(),this.setContents(val),myself.paper.settings.linewidth=val,this.world().keyboardReceiver=myself,pc.colorpicker.action(myself.paper.settings.primarycolor)},alpen.add(pc.penSizeSlider),alpen.add(pc.penSizeField),alpen.color=myself.color,alpen.fixLayout(),pc.penSizeField.drawNew(),pc.constrain=new ToggleMorph("checkbox",this,function(){myself.shift=!myself.shift},"Constrain proportions of shapes?\n(you can also hold shift)",function(){
return myself.shift}),c.add(pc.colorpicker),c.add(pc.primaryColorViewer),c.add(new TextMorph(localize("Brush size"))),c.add(alpen),c.add(pc.constrain)},PaintEditorMorph.prototype.toolButton=function(icon,hint){var button,myself=this;return button=new ToggleButtonMorph(null,this,function(){myself.paper.currentTool=icon,myself.paper.toolChanged(icon),myself.refreshToolButtons(),"pipette"===icon&&myself.getUserColor()},new SymbolMorph(icon,18),function(){return myself.paper.currentTool===icon}),button.hint=hint,button.drawNew(),button.fixLayout(),button},PaintEditorMorph.prototype.pushButton=function(title,action,hint){return new PushButtonMorph(this,action,title,null,hint);
},PaintEditorMorph.prototype.getUserColor=function(){var myself=this,world=this.world(),hand=world.hand,posInDocument=getDocumentPositionOf(world.worldCanvas),mouseMoveBak=hand.processMouseMove,mouseDownBak=hand.processMouseDown,mouseUpBak=hand.processMouseUp;hand.processMouseMove=function(event){var color;hand.setPosition(new Point(event.pageX-posInDocument.x,event.pageY-posInDocument.y)),color=world.getGlobalPixelColor(hand.position()),color.a&&(color.a=255,myself.propertiesControls.colorpicker.action(color))},hand.processMouseDown=nop,hand.processMouseUp=function(){myself.paper.currentTool="brush",myself.paper.toolChanged("brush"),myself.refreshToolButtons(),
hand.processMouseMove=mouseMoveBak,hand.processMouseDown=mouseDownBak,hand.processMouseUp=mouseUpBak}},PaintColorPickerMorph.prototype=new Morph,PaintColorPickerMorph.prototype.constructor=PaintColorPickerMorph,PaintColorPickerMorph.uber=Morph.prototype,PaintColorPickerMorph.prototype.init=function(extent,action){this.setExtent(extent||new Point(200,100)),this.action=action||nop,this.drawNew()},PaintColorPickerMorph.prototype.drawNew=function(){var colorselection,r,x=0,y=0,can=newCanvas(this.extent()),ctx=can.getContext("2d");for(x=0;x<this.width();x+=1)for(y=0;y<this.height()-20;y+=1)ctx.fillStyle="hsl("+360*x/this.width()+",100%,"+100*y/(this.height()-20)+"%)",
ctx.fillRect(x,y,1,1);for(x=0;x<this.width();x+=1)r=Math.floor(255*x/this.width()),ctx.fillStyle="rgb("+r+", "+r+", "+r+")",ctx.fillRect(x,this.height()-20,1,10);for(colorselection=["black","white","gray"],x=0;x<colorselection.length;x+=1)ctx.fillStyle=colorselection[x],ctx.fillRect(x*this.width()/colorselection.length,this.height()-10,this.width()/colorselection.length,10);for(x=2*this.width()/3;x<this.width();x+=2)for(y=this.height()-10;y<this.height();y+=2)(x+y)/2%2===0&&(ctx.fillStyle="#DDD",ctx.fillRect(x,y,2,2));this.image=can},PaintColorPickerMorph.prototype.mouseDownLeft=function(pos){pos.subtract(this.position()).x>2*this.width()/3&&pos.subtract(this.position()).y>this.height()-10?this.action("transparent"):this.action(this.getPixelColor(pos));
},PaintColorPickerMorph.prototype.mouseMove=PaintColorPickerMorph.prototype.mouseDownLeft,PaintCanvasMorph.prototype=new Morph,PaintCanvasMorph.prototype.constructor=PaintCanvasMorph,PaintCanvasMorph.uber=Morph.prototype,PaintCanvasMorph.prototype.init=function(shift){this.rotationCenter=new Point(240,180),this.dragRect=null,this.previousDragPoint=null,this.currentTool="brush",this.dragRect=new Rectangle,this.mask=newCanvas(this.extent(),!0),this.paper=newCanvas(this.extent(),!0),this.erasermask=newCanvas(this.extent(),!0),this.background=newCanvas(this.extent()),this.settings={primarycolor:new Color(0,0,0,255),secondarycolor:new Color(0,0,0,255),linewidth:3},
this.brushBuffer=[],this.undoBuffer=[],this.isShiftPressed=shift||function(){var key=this.world().currentKey;return 16===key},this.automaticCrosshairs=!0,this.noticesTransparentClick=!0,this.buildContents()},PaintCanvasMorph.prototype.calculateCanvasCenter=function(canvas){var canvasBounds=Costume.prototype.canvasBoundingBox(canvas);return null===canvasBounds?null:new Point((canvasBounds.origin.x+canvasBounds.corner.x)/2,(canvasBounds.origin.y+canvasBounds.corner.y)/2)},PaintCanvasMorph.prototype.updateAutomaticCenter=function(){if(this.automaticCrosshairs){var rotationCenter=this.calculateCanvasCenter(this.paper);null!==rotationCenter&&(this.rotationCenter=rotationCenter);
}},PaintCanvasMorph.prototype.scale=function(x,y){this.updateAutomaticCenter(),this.mask=newCanvas(this.extent(),!0);var c=newCanvas(this.extent(),!0);c.getContext("2d").save(),c.getContext("2d").translate(this.rotationCenter.x,this.rotationCenter.y),c.getContext("2d").scale(1+x,1+y),c.getContext("2d").drawImage(this.paper,-this.rotationCenter.x,-this.rotationCenter.y),c.getContext("2d").restore(),this.paper=c,this.drawNew(),this.changed()},PaintCanvasMorph.prototype.cacheUndo=function(){var cachecan=newCanvas(this.extent(),!0);this.merge(this.paper,cachecan),this.undoBuffer.push(cachecan)},PaintCanvasMorph.prototype.undo=function(){this.undoBuffer.length>0&&(this.paper=newCanvas(this.extent(),!0),
this.mask.width=this.mask.width+1-1,this.merge(this.undoBuffer.pop(),this.paper),this.drawNew(),this.changed())},PaintCanvasMorph.prototype.merge=function(a,b){b.getContext("2d").drawImage(a,0,0)},PaintCanvasMorph.prototype.centermerge=function(a,b){b.getContext("2d").drawImage(a,(b.width-a.width)/2,(b.height-a.height)/2)},PaintCanvasMorph.prototype.clearCanvas=function(){this.buildContents(),this.drawNew(),this.changed()},PaintCanvasMorph.prototype.toolChanged=function(tool){this.mask=newCanvas(this.extent(),!0),"crosshairs"===tool&&(this.updateAutomaticCenter(),this.drawcrosshair()),this.drawNew(),this.changed()},PaintCanvasMorph.prototype.drawcrosshair=function(context){
var ctx=context||this.mask.getContext("2d"),rp=this.rotationCenter;ctx.lineWidth=1,ctx.strokeStyle="black",ctx.clearRect(0,0,this.mask.width,this.mask.height),ctx.globalAlpha=.5,ctx.fillStyle="white",ctx.beginPath(),ctx.arc(rp.x,rp.y,20,radians(0),radians(360),!1),ctx.closePath(),ctx.fill(),ctx.stroke(),ctx.beginPath(),ctx.arc(rp.x,rp.y,10,radians(0),radians(360),!1),ctx.stroke(),ctx.beginPath(),ctx.moveTo(0,rp.y),ctx.lineTo(this.mask.width,rp.y),ctx.stroke(),ctx.beginPath(),ctx.moveTo(rp.x,0),ctx.lineTo(rp.x,this.mask.height),ctx.stroke(),this.drawNew(),this.changed()},PaintCanvasMorph.prototype.floodfill=function(sourcepoint){var currentpoint,read,sourcecolor,checkpoint,width=this.paper.width,height=this.paper.height,ctx=this.paper.getContext("2d"),img=ctx.getImageData(0,0,width,height),data=img.data,stack=[Math.round(Math.round(sourcepoint.y)*width+sourcepoint.x)];
if(read=function(p){var d=4*p;return[data[d],data[d+1],data[d+2],data[d+3]]},sourcecolor=read(stack[0]),checkpoint=function(p){return p[0]===sourcecolor[0]&&p[1]===sourcecolor[1]&&p[2]===sourcecolor[2]&&p[3]===sourcecolor[3]},(0!==sourcecolor[3]||"transparent"!==this.settings.primarycolor)&&!(sourcecolor[0]===this.settings.primarycolor.r&&sourcecolor[1]===this.settings.primarycolor.g&&sourcecolor[2]===this.settings.primarycolor.b&&sourcecolor[3]===this.settings.primarycolor.a||0===sourcecolor[3]&&0===this.settings.primarycolor.a)){for(;stack.length>0;)currentpoint=stack.pop(),checkpoint(read(currentpoint))&&(currentpoint%width>1&&(stack.push(currentpoint+1),stack.push(currentpoint-1)),
currentpoint>0&&currentpoint<height*width&&(stack.push(currentpoint+width),stack.push(currentpoint-width))),"transparent"===this.settings.primarycolor?data[4*currentpoint+3]=0:(data[4*currentpoint]=this.settings.primarycolor.r,data[4*currentpoint+1]=this.settings.primarycolor.g,data[4*currentpoint+2]=this.settings.primarycolor.b,data[4*currentpoint+3]=255*this.settings.primarycolor.a);ctx.putImageData(img,0,0),this.drawNew(),this.changed()}},PaintCanvasMorph.prototype.mouseDownLeft=function(pos){return this.cacheUndo(),this.dragRect.origin=pos.subtract(this.bounds.origin),this.dragRect.corner=pos.subtract(this.bounds.origin),this.previousDragPoint=this.dragRect.corner.copy(),
"crosshairs"===this.currentTool?(this.rotationCenter=pos.subtract(this.bounds.origin),void this.drawcrosshair()):"paintbucket"===this.currentTool?this.floodfill(pos.subtract(this.bounds.origin)):void("transparent"===this.settings.primarycolor&&"crosshairs"!==this.currentTool&&(this.erasermask=newCanvas(this.extent(),!0),this.merge(this.paper,this.erasermask)))},PaintCanvasMorph.prototype.mouseMove=function(pos){function newW(){return Math.max(Math.abs(w),Math.abs(h))*(w/Math.abs(w))}function newH(){return Math.max(Math.abs(w),Math.abs(h))*(h/Math.abs(h))}if("paintbucket"!==this.currentTool){var i,relpos=pos.subtract(this.bounds.origin),mctx=this.mask.getContext("2d"),pctx=this.paper.getContext("2d"),x=this.dragRect.origin.x,y=this.dragRect.origin.y,p=relpos.x,q=relpos.y,w=(p-x)/2,h=(q-y)/2,width=this.paper.width;
switch(mctx.save(),this.brushBuffer.push([p,q]),mctx.lineWidth=this.settings.linewidth,mctx.clearRect(0,0,this.bounds.width(),this.bounds.height()),this.dragRect.corner=relpos.subtract(this.dragRect.origin),"transparent"===this.settings.primarycolor&&"crosshairs"!==this.currentTool?(this.merge(this.erasermask,this.mask),pctx.clearRect(0,0,this.bounds.width(),this.bounds.height()),mctx.globalCompositeOperation="destination-out"):(mctx.fillStyle=this.settings.primarycolor.toString(),mctx.strokeStyle=this.settings.primarycolor.toString()),this.currentTool){case"rectangle":this.isShiftPressed()?mctx.strokeRect(x,y,2*newW(),2*newH()):mctx.strokeRect(x,y,2*w,2*h);break;
case"rectangleSolid":this.isShiftPressed()?mctx.fillRect(x,y,2*newW(),2*newH()):mctx.fillRect(x,y,2*w,2*h);break;case"brush":for(mctx.lineCap="round",mctx.lineJoin="round",mctx.beginPath(),mctx.moveTo(this.brushBuffer[0][0],this.brushBuffer[0][1]),i=0;i<this.brushBuffer.length;i+=1)mctx.lineTo(this.brushBuffer[i][0],this.brushBuffer[i][1]);mctx.stroke();break;case"line":mctx.beginPath(),mctx.moveTo(x,y),this.isShiftPressed()?Math.abs(h)>Math.abs(w)?mctx.lineTo(x,q):mctx.lineTo(p,y):mctx.lineTo(p,q),mctx.stroke();break;case"circle":case"circleSolid":if(mctx.beginPath(),this.isShiftPressed())mctx.arc(x,y,new Point(x,y).distanceTo(new Point(p,q)),0,2*Math.PI,!1);else{
for(i=0;i<width;i+=1)mctx.lineTo(i,2*h*Math.sqrt(2-Math.pow((i-x)/(2*w),2))+y);for(i=width;i>0;i-=1)mctx.lineTo(i,-1*(2*h)*Math.sqrt(2-Math.pow((i-x)/(2*w),2))+y)}mctx.closePath(),"circleSolid"===this.currentTool?mctx.fill():"circle"===this.currentTool&&mctx.stroke();break;case"crosshairs":this.automaticCrosshairs=!1,this.rotationCenter=relpos.copy(),this.drawcrosshair(mctx);break;case"eraser":for(this.merge(this.paper,this.mask),mctx.save(),mctx.globalCompositeOperation="destination-out",mctx.beginPath(),mctx.moveTo(this.brushBuffer[0][0],this.brushBuffer[0][1]),i=0;i<this.brushBuffer.length;i+=1)mctx.lineTo(this.brushBuffer[i][0],this.brushBuffer[i][1]);mctx.stroke(),
mctx.restore(),this.paper=newCanvas(this.extent(),!0),this.merge(this.mask,this.paper);break;default:nop()}this.previousDragPoint=relpos,this.drawNew(),this.changed(),mctx.restore()}},PaintCanvasMorph.prototype.mouseClickLeft=function(){"crosshairs"!==this.currentTool&&this.merge(this.mask,this.paper),this.brushBuffer=[]},PaintCanvasMorph.prototype.mouseLeaveDragging=PaintCanvasMorph.prototype.mouseClickLeft,PaintCanvasMorph.prototype.buildContents=function(){this.background=newCanvas(this.extent()),this.paper=newCanvas(this.extent(),!0),this.mask=newCanvas(this.extent(),!0),this.erasermask=newCanvas(this.extent(),!0);var i,j,bkctx=this.background.getContext("2d");
for(i=0;i<this.background.width;i+=5)for(j=0;j<this.background.height;j+=5)(i+j)/5%2===1?bkctx.fillStyle="rgba(255, 255, 255, 1)":bkctx.fillStyle="rgba(255, 255, 255, 0.3)",bkctx.fillRect(i,j,5,5)},PaintCanvasMorph.prototype.drawNew=function(){var can=newCanvas(this.extent(),!0);this.merge(this.background,can),this.merge(this.paper,can),this.merge(this.mask,can),this.image=can,this.drawFrame()},PaintCanvasMorph.prototype.drawFrame=function(){var context,borderColor;context=this.image.getContext("2d"),this.parent?(this.color=this.parent.color.lighter(.75*this.contrast),borderColor=this.parent.color):borderColor=new Color(120,120,120),context.fillStyle=this.color.toString(),
this.cachedClr=borderColor.toString(),this.cachedClrBright=borderColor.lighter(this.contrast).toString(),this.cachedClrDark=borderColor.darker(this.contrast).toString(),this.drawRectBorder(context)},PaintCanvasMorph.prototype.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,PaintCanvasMorph.prototype.edge=InputFieldMorph.prototype.edge,PaintCanvasMorph.prototype.fontSize=InputFieldMorph.prototype.fontSize,PaintCanvasMorph.prototype.typeInPadding=InputFieldMorph.prototype.typeInPadding,PaintCanvasMorph.prototype.contrast=InputFieldMorph.prototype.contrast,modules.lists="2017-September-01";var List,ListWatcherMorph;List.prototype.enableTables=!1,List.prototype.toString=function(){
return"a List ["+this.length+" elements]"},List.prototype.changed=function(){this.lastChanged=Date.now()},List.prototype.cons=function(car,cdr){var answer=new List;if(!(cdr instanceof List||isNil(cdr)))throw new Error("cdr isn't a list: "+cdr);return answer.first=isNil(car)?null:car,answer.rest=cdr||null,answer.isLinked=!0,answer},List.prototype.cdr=function(){var result,i;if(this.isLinked)return this.rest||new List;if(this.contents.length<2)return new List;for(result=new List,i=this.contents.length;i>1;i-=1)result=this.cons(this.at(i),result);return result},List.prototype.add=function(element,index){var idx=index||this.length()+1,obj=isNil(element)?null:element;
this.becomeArray(),this.contents.splice(idx-1,0,obj),this.changed()},List.prototype.put=function(element,index){var data=0===element?0:element!==!1&&(element||null);this.becomeArray(),this.contents[index-1]=data,this.changed()},List.prototype.remove=function(index){this.becomeArray(),this.contents.splice(index-1,1),this.changed()},List.prototype.clear=function(){this.contents=[],this.first=null,this.rest=null,this.isLinked=!1,this.changed()},List.prototype.length=function(){if(this.isLinked){for(var pair=this,result=0;pair&&pair.isLinked;)result+=1,pair=pair.rest;return result+(pair?pair.contents.length:0)}return this.contents.length},List.prototype.at=function(index){
for(var value,idx=+index,pair=this;pair.isLinked;){if(!(idx>1))return pair.first;pair=pair.rest,idx-=1}return value=pair.contents[idx-1],isNil(value)?"":value},List.prototype.contains=function(element){for(var pair=this;pair.isLinked;){if(snapEquals(pair.first,element))return!0;pair=pair.rest}return pair.contents.some(function(any){return snapEquals(any,element)})},List.prototype.isTable=function(){return this.enableTables&&(this.length()>100||this.cols()>1)},List.prototype.get=function(col,row){var r,len,cols;return col?row?(r=this.at(row),r instanceof List?(len=r.length(),cols=this.cols(),col>len?null:1===cols&&len>1?[r]:col>=cols&&len>cols?new Variable(r.at(col)):r.at(col)):1===col&&row<=this.rows()?[r]:null):1===this.cols()?localize("items"):this.colName(col):row?row>this.rows()?null:this.rowName(row):[this.length()];
},List.prototype.rows=function(){return this.length()},List.prototype.cols=function(){var r=this.at(1);return r instanceof List?r.length():1},List.prototype.colName=function(col){return col>this.cols()?null:String.fromCharCode(64+(col%26||26)).repeat(Math.floor((col-1)/26)+1)},List.prototype.rowName=function(row){return row},List.prototype.columnNames=function(){return[]},List.prototype.version=function(startRow,rows){var r,i,l=Math.min(startRow+rows,this.length()),v=this.lastChanged;for(i=startRow;i<=l;i+=1)r=this.at(i),v=Math.max(v,r.lastChanged?r.lastChanged:0);return v},List.prototype.asArray=function(){return this.becomeArray(),this.contents},List.prototype.itemsArray=function(){
if(this.isLinked){for(var i,next=this,result=[];next&&next.isLinked;)result.push(next.first),next=next.rest;if(next)for(i=1;i<=next.contents.length;i+=1)result.push(next.at(i));return result}return this.contents},List.prototype.asText=function(){for(var length,element,i,result="",pair=this;pair.isLinked;)element=pair.first,element instanceof List?result=result.concat(element.asText()):(element=isNil(element)?"":element.toString(),result=result.concat(element)),pair=pair.rest;for(length=pair.length(),i=1;i<=length;i+=1)element=pair.at(i),element instanceof List?result=result.concat(element.asText()):(element=isNil(element)?"":element.toString(),result=result.concat(element));
return result},List.prototype.becomeArray=function(){this.isLinked&&(this.contents=this.itemsArray(),this.isLinked=!1,this.first=null,this.rest=null)},List.prototype.becomeLinked=function(){var i,stop,tail=this;if(!this.isLinked){for(stop=this.length(),i=0;i<stop;i+=1)tail.first=this.contents[i],i<stop-1&&(tail.rest=new List,tail.isLinked=!0,tail=tail.rest);this.contents=[],this.isLinked=!0}},List.prototype.equalTo=function(other){var i,j,loopcount,myself=this,it=other;if(!(other instanceof List))return!1;for(;myself.isLinked&&it.isLinked;){if(!snapEquals(myself.first,it.first))return!1;myself=myself.rest,it=it.rest}for(it.isLinked&&(i=it,it=myself,myself=i),
j=0;myself.isLinked;){if(!snapEquals(myself.first,it.contents[j]))return!1;myself=myself.rest,j+=1}if(i=0,myself.contents.length!==it.contents.length-j)return!1;for(loopcount=myself.contents.length;loopcount>0;){if(loopcount-=1,!snapEquals(myself.contents[i],it.contents[j]))return!1;i+=1,j+=1}return!0},ListWatcherMorph.prototype=new BoxMorph,ListWatcherMorph.prototype.constructor=ListWatcherMorph,ListWatcherMorph.uber=BoxMorph.prototype,ListWatcherMorph.prototype.cellColor=SpriteMorph.prototype.blockColor.lists,ListWatcherMorph.prototype.init=function(list,parentCell){var myself=this;this.list=list||new List,this.start=1,this.range=100,this.lastUpdated=Date.now(),
this.lastCell=null,this.parentCell=parentCell||null,this.label=new StringMorph(localize("length: ")+this.list.length(),SyntaxElementMorph.prototype.fontSize,null,!1,!1,!1,MorphicPreferences.isFlat?new Point:new Point(1,1),new Color(255,255,255)),this.label.mouseClickLeft=function(){myself.startIndexMenu()},this.frame=new ScrollFrameMorph(null,10),this.frame.alpha=0,this.frame.acceptsDrops=!1,this.frame.contents.acceptsDrops=!1,this.handle=new HandleMorph(this,80,70,3,3),this.handle.setExtent(new Point(13,13)),this.arrow=new ArrowMorph("down",SyntaxElementMorph.prototype.fontSize),this.arrow.mouseClickLeft=function(){myself.startIndexMenu()},this.arrow.setRight(this.handle.right()),
this.arrow.setBottom(this.handle.top()),this.handle.add(this.arrow),this.plusButton=new PushButtonMorph(this.list,"add","+"),this.plusButton.padding=0,this.plusButton.edge=0,this.plusButton.outlineColor=this.color,this.plusButton.drawNew(),this.plusButton.fixLayout(),ListWatcherMorph.uber.init.call(this,SyntaxElementMorph.prototype.rounding,1.000001,new Color(120,120,120)),this.color=new Color(220,220,220),this.isDraggable=!1,this.setExtent(new Point(80,70).multiplyBy(SyntaxElementMorph.prototype.scale)),this.add(this.label),this.add(this.frame),this.add(this.plusButton),this.add(this.handle),this.handle.drawNew(),this.update(),this.fixLayout()},ListWatcherMorph.prototype.update=function(anyway){
var i,idx,ceil,morphs,cell,cnts,label,button,max,starttime,maxtime=1e3;if(this.frame.contents.children.forEach(function(m){m instanceof CellMorph&&(m.contentsMorph instanceof ListWatcherMorph?m.contentsMorph.update():isSnapObject(m.contents)&&m.update())}),this.lastUpdated===this.list.lastChanged&&!anyway)return null;for(this.updateLength(!0),this.start=Math.max(Math.min(this.start,Math.floor((this.list.length()-1)/this.range)*this.range+1),1),max=Math.min(this.start+this.range-1,this.list.length()),ceil=Math.min(3*(max-this.start+1),this.frame.contents.children.length),i=0;i<ceil;i+=3)idx=this.start+i/3,cell=this.frame.contents.children[i],label=this.frame.contents.children[i+1],
button=this.frame.contents.children[i+2],cnts=this.list.at(idx),cell.contents!==cnts&&(cell.contents=cnts,cell.drawNew(),this.lastCell&&cell.setLeft(this.lastCell.left())),this.lastCell=cell,label.text!==idx.toString()&&(label.text=idx.toString(),label.drawNew()),button.action=idx;for(morphs=3*(max-this.start+1);this.frame.contents.children.length>morphs;)this.frame.contents.children[morphs].destroy();if(ceil=morphs,i=this.frame.contents.children.length,starttime=Date.now(),ceil>i+1)for(i;i<ceil;i+=3){if(Date.now()-starttime>maxtime)return this.fixLayout(),this.frame.contents.adjustBounds(),this.frame.contents.setLeft(this.frame.left()),null;idx=this.start+i/3,
label=new StringMorph(idx.toString(),SyntaxElementMorph.prototype.fontSize,null,!1,!1,!1,MorphicPreferences.isFlat?new Point:new Point(1,1),new Color(255,255,255)),cell=new CellMorph(this.list.at(idx),this.cellColor,idx,this.parentCell),button=new PushButtonMorph(this.list.remove,idx,"-",this.list),button.padding=1,button.edge=0,button.corner=1,button.outlineColor=this.color.darker(),button.drawNew(),button.fixLayout(),this.frame.contents.add(cell),this.lastCell?cell.setPosition(this.lastCell.bottomLeft()):cell.setTop(this.frame.contents.top()),this.lastCell=cell,label.setCenter(cell.center()),label.setRight(cell.left()-2),this.frame.contents.add(label),this.frame.contents.add(button);
}this.lastCell=null,this.fixLayout(),this.frame.contents.adjustBounds(),this.frame.contents.setLeft(this.frame.left()),this.updateLength(),this.lastUpdated=this.list.lastChanged},ListWatcherMorph.prototype.updateLength=function(notDone){this.label.text=localize("length: ")+this.list.length(),notDone?this.label.color=new Color(0,0,100):this.label.color=new Color(0,0,0),this.label.drawNew(),this.label.setCenter(this.center()),this.label.setBottom(this.bottom()-3)},ListWatcherMorph.prototype.startIndexMenu=function(){var i,range,myself=this,items=Math.ceil(this.list.length()/this.range),menu=new MenuMorph(function(idx){myself.setStartIndex(idx)},null,myself);for(menu.addItem("1...",1),
i=1;i<items;i+=1)range=100*i+1,menu.addItem(range+"...",range);menu.popUpAtHand(this.world())},ListWatcherMorph.prototype.setStartIndex=function(index){this.start=index,this.list.changed()},ListWatcherMorph.prototype.fixLayout=function(){this.label&&(Morph.prototype.trackChanges=!1,this.frame&&(this.arrangeCells(),this.frame.silentSetPosition(this.position().add(3)),this.frame.bounds.corner=this.bounds.corner.subtract(new Point(3,17)),this.frame.drawNew(),this.frame.contents.adjustBounds()),this.label.setCenter(this.center()),this.label.setBottom(this.bottom()-3),this.plusButton.setLeft(this.left()+3),this.plusButton.setBottom(this.bottom()-3),Morph.prototype.trackChanges=!0,
this.changed(),this.parent&&this.parent.fixLayout&&this.parent.fixLayout())},ListWatcherMorph.prototype.arrangeCells=function(){var i,cell,label,button,lastCell,end=this.frame.contents.children.length;for(i=0;i<end;i+=3)cell=this.frame.contents.children[i],label=this.frame.contents.children[i+1],button=this.frame.contents.children[i+2],lastCell&&cell.setTop(lastCell.bottom()),label&&(label.setTop(cell.center().y-label.height()/2),label.setRight(cell.left()-2)),button&&(button.setCenter(cell.center()),button.setLeft(cell.right()+2)),lastCell=cell;this.frame.contents.adjustBounds()},ListWatcherMorph.prototype.expand=function(maxExtent){var fe=this.frame.contents.extent(),ext=new Point(fe.x+6,fe.y+this.label.height()+6);
maxExtent&&(ext=ext.min(maxExtent)),this.setExtent(ext),this.handle.setRight(this.right()-3),this.handle.setBottom(this.bottom()-3)},ListWatcherMorph.prototype.userMenu=function(){if(!List.prototype.enableTables)return this.escalateEvent("userMenu");var menu=new MenuMorph(this),myself=this;return menu.addItem("table view...","showTableView"),menu.addLine(),menu.addItem("open in dialog...",function(){new TableDialogMorph(myself.list).popUp(myself.world())}),menu},ListWatcherMorph.prototype.showTableView=function(){var view=this.parentThatIsAnyOf([SpriteBubbleMorph,SpeechBubbleMorph,CellMorph]);view&&(view instanceof SpriteBubbleMorph?(view.changed(),view.drawNew(!0)):view instanceof SpeechBubbleMorph?(view.contents=new TableFrameMorph(new TableMorph(this.list,10)),
view.contents.expand(this.extent()),view.drawNew(!0)):(view.drawNew(!0,"table"),view.contentsMorph.expand(this.extent())),view.fixLayout())},ListWatcherMorph.prototype.mouseDoubleClick=function(pos){List.prototype.enableTables?new TableDialogMorph(this.list).popUp(this.world()):this.escalateEvent("mouseDoubleClick",pos)},ListWatcherMorph.prototype.show=function(){ListWatcherMorph.uber.show.call(this),this.frame.contents.adjustBounds()},ListWatcherMorph.prototype.drawNew=function(){WatcherMorph.prototype.drawNew.call(this),this.fixLayout()},modules.byob="2017-December-01";var CustomBlockDefinition,CustomCommandBlockMorph,CustomReporterBlockMorph,BlockDialogMorph,BlockEditorMorph,PrototypeHatBlockMorph,BlockLabelFragment,BlockLabelFragmentMorph,BlockInputFragmentMorph,BlockLabelPlaceHolderMorph,InputSlotDialogMorph,VariableDialogMorph,JaggedBlockMorph,BlockExportDialogMorph,BlockImportDialogMorph,BlockRemovalDialogMorph;
CustomBlockDefinition.prototype.blockInstance=function(){var block;return block="command"===this.type?new CustomCommandBlockMorph(this):new CustomReporterBlockMorph(this,"predicate"===this.type),block.isDraggable=!0,block},CustomBlockDefinition.prototype.templateInstance=function(){var block;return block=this.blockInstance(),block.refreshDefaults(this),block.isDraggable=!1,block.isTemplate=!0,block},CustomBlockDefinition.prototype.prototypeInstance=function(){var block,slot,myself=this;return block="command"===this.type?new CustomCommandBlockMorph(this,!0):new CustomReporterBlockMorph(this,"predicate"===this.type,!0),block.parts().forEach(function(part){part instanceof BlockInputFragmentMorph&&(slot=myself.declarations[part.fragment.labelString],
slot&&(part.fragment.type=slot[0],part.fragment.defaultValue=slot[1],part.fragment.options=slot[2],part.fragment.isReadOnly=slot[3]||!1))}),block},CustomBlockDefinition.prototype.copyAndBindTo=function(sprite,headerOnly){var c=copy(this);return delete c[XML_Serializer.prototype.idProperty],c.receiver=sprite,c.declarations=copy(this.declarations),headerOnly?(c.body=null,c):(c.body&&(c.body=Process.prototype.reify.call(null,this.body.expression,new List(this.inputNames())),c.body.outerContext=null),c)},CustomBlockDefinition.prototype.blockSpec=function(){var spec,myself=this,ans=[],parts=this.parseSpec(this.spec);return parts.forEach(function(part){spec="%"===part[0]&&part.length>1?myself.typeOf(part.slice(1)):"$nl"===part?"%br":part,
ans.push(spec),ans.push(" ")}),"".concat.apply("",ans).trim()},CustomBlockDefinition.prototype.helpSpec=function(){var ans=[],parts=this.parseSpec(this.spec);return parts.forEach(function(part){"%"!==part[0]&&ans.push(part)}),"".concat.apply("",ans).replace(/\?/g,"")},CustomBlockDefinition.prototype.typeOf=function(inputName){return this.declarations[inputName]?this.declarations[inputName][0]:"%s"},CustomBlockDefinition.prototype.defaultValueOf=function(inputName){return this.declarations[inputName]?this.declarations[inputName][1]:""},CustomBlockDefinition.prototype.defaultValueOfInputIdx=function(idx){var inputName=this.inputNames()[idx];return this.defaultValueOf(inputName);
},CustomBlockDefinition.prototype.dropDownMenuOfInputIdx=function(idx){var inputName=this.inputNames()[idx];return this.dropDownMenuOf(inputName)},CustomBlockDefinition.prototype.isReadOnlyInputIdx=function(idx){var inputName=this.inputNames()[idx];return this.isReadOnlyInput(inputName)},CustomBlockDefinition.prototype.inputOptionsOfIdx=function(idx){var inputName=this.inputNames()[idx];return this.inputOptionsOf(inputName)},CustomBlockDefinition.prototype.dropDownMenuOf=function(inputName){return this.declarations[inputName]&&this.declarations[inputName][2]?this.parseChoices(this.declarations[inputName][2]):null},CustomBlockDefinition.prototype.parseChoices=function(string){
var dict={},stack=[dict];return string.split("\n").forEach(function(line){var pair=line.split("=");"}"===pair[0]?(stack.pop(),dict=stack[stack.length-1]):"{"===pair[1]?(dict={},stack[stack.length-1][pair[0]]=dict,stack.push(dict)):dict[pair[0]]=isNil(pair[1])?pair[0]:pair[1]}),dict},CustomBlockDefinition.prototype.isReadOnlyInput=function(inputName){return this.declarations[inputName]&&this.declarations[inputName][3]===!0},CustomBlockDefinition.prototype.inputOptionsOf=function(inputName){return[this.dropDownMenuOf(inputName),this.isReadOnlyInput(inputName)]},CustomBlockDefinition.prototype.inputNames=function(){var vNames=[],parts=this.parseSpec(this.spec);return parts.forEach(function(part){
"%"===part[0]&&part.length>1&&vNames.push(part.slice(1))}),vNames},CustomBlockDefinition.prototype.parseSpec=function(spec){var i,c,parts=[],word="",quoted=!1;for(i=0;i<spec.length;i+=1)c=spec[i],"'"===c?quoted=!quoted:" "!==c||quoted?word=word.concat(c):(parts.push(word),word="");return parts.push(word),parts},CustomBlockDefinition.prototype.isDirectlyRecursive=function(){var myspec;return null!==this.cachedIsRecursive?this.cachedIsRecursive:(this.body?(myspec=this.blockSpec(),this.cachedIsRecursive=this.body.expression.anyChild(function(morph){return morph.isCustomBlock&&morph.blockSpec===myspec})):this.cachedIsRecursive=!1,this.cachedIsRecursive)},CustomBlockDefinition.prototype.localizedSpec=function(){
function isInput(str){return str.length>1&&"%"===str[0]}if(this.cachedTranslation)return this.cachedTranslation;var locParts,inputs,loc=this.translations[SnapTranslator.language],sem=this.blockSpec(),i=-1;return isNil(loc)?sem:(inputs=BlockMorph.prototype.parseSpec(sem).filter(function(str){return isInput(str)}),locParts=BlockMorph.prototype.parseSpec(loc),locParts.some(function(str){return isInput(str)})||locParts.filter(function(str){return"_"===str}).length!==inputs.length?this.cachedTranslation=sem:(locParts=locParts.map(function(str){return"_"===str?(i+=1,inputs[i]):str}),this.cachedTranslation=locParts.join(" ")),this.cachedTranslation)},CustomBlockDefinition.prototype.abstractBlockSpec=function(){
return BlockMorph.prototype.parseSpec(this.blockSpec()).map(function(str){return str.length>1&&"%"===str[0]?"_":str}).join(" ")},CustomBlockDefinition.prototype.translationsAsText=function(){var myself=this,txt="";return Object.keys(this.translations).forEach(function(lang){txt+=lang+":"+myself.translations[lang]+"\n"}),txt},CustomBlockDefinition.prototype.updateTranslations=function(text){var myself=this,lines=text.split("\n").filter(function(txt){return txt.length});this.translations={},lines.forEach(function(txt){var idx=txt.indexOf(":"),key=txt.slice(0,idx).trim(),val=txt.slice(idx+1).trim();idx&&(myself.translations[key]=val)})},CustomBlockDefinition.prototype.scriptsPicture=function(){
return this.scriptsModel().scriptsPicture()},CustomBlockDefinition.prototype.sortedElements=function(){return this.scriptsModel().sortedElements()},CustomBlockDefinition.prototype.scriptsModel=function(){var scripts,proto,block,comment,template;return scripts=new ScriptsMorph,scripts.cleanUpMargin=10,proto=new PrototypeHatBlockMorph(this),proto.setPosition(scripts.position().add(10)),null!==this.comment&&(comment=this.comment.fullCopy(),proto.comment=comment,comment.block=proto),null!==this.body&&proto.nextBlock(this.body.expression.fullCopy()),scripts.add(proto),proto.fixBlockColor(null,!0),this.scripts.forEach(function(element){block=element.fullCopy(),block.setPosition(scripts.position().add(element.position())),
scripts.add(block),block instanceof BlockMorph&&block.allComments().forEach(function(comment){comment.align(block)})}),proto.allComments().forEach(function(comment){comment.align(proto)}),template=proto.parts()[0],template.fixLayout(),template.forceNormalColoring(),template.fixBlockColor(proto,!0),scripts.fixMultiArgs(),scripts},CustomBlockDefinition.prototype.purgeCorpses=function(){this.body&&this.body.expression.isCorpse&&(this.body=null),this.scripts=this.scripts.filter(function(topBlock){return!topBlock.isCorpse})},CustomCommandBlockMorph.prototype=new CommandBlockMorph,CustomCommandBlockMorph.prototype.constructor=CustomCommandBlockMorph,CustomCommandBlockMorph.uber=CommandBlockMorph.prototype,
CustomCommandBlockMorph.prototype.isCustomBlock=!0,CustomCommandBlockMorph.prototype.init=function(definition,isProto){this.definition=definition,this.semanticSpec="",this.isGlobal=!!definition&&definition.isGlobal,this.isPrototype=isProto||!1,CustomCommandBlockMorph.uber.init.call(this,!0),this.category=definition.category,this.selector="evaluateCustomBlock",this.variables=null,this.initializeVariables(),definition&&this.refresh()},CustomCommandBlockMorph.prototype.initializeVariables=function(oldVars){var myself=this;this.variables=new VariableFrame,this.isGlobal&&this.definition.variableNames.forEach(function(name){var v=oldVars?oldVars[name]:null;myself.variables.addVar(name,v instanceof Variable?v.value:null);
})},CustomCommandBlockMorph.prototype.refresh=function(aDefinition,silently){var oldInputs,def=aDefinition||this.definition,newSpec=this.isPrototype?def.spec:def.localizedSpec();this.semanticSpec=def.blockSpec(),this.isGlobal||this.isPrototype||(this.definition=null),this.setCategory(def.category),this.blockSpec!==newSpec?(oldInputs=this.inputs(),this.zebraContrast?this.fixBlockColor():this.forceNormalColoring(),this.setSpec(newSpec,silently,def),this.fixLabelColor(),this.restoreInputs(oldInputs)):this.inputs().forEach(function(inp,i){inp instanceof InputSlotMorph&&inp.setChoices.apply(inp,def.inputOptionsOfIdx(i))}),this.cachedInputs=null,this.inputs().forEach(function(inp,idx){
inp instanceof TemplateSlotMorph&&"↑"===inp.contents()&&inp.setContents(def.inputNames()[idx])}),this.isGlobal&&this.initializeVariables(this.variables.vars),this.forceNormalColoring(),this.drawNew(),this.fixBlockColor(null,!0)},CustomCommandBlockMorph.prototype.restoreInputs=function(oldInputs){var old,i=0,myself=this;this.isPrototype||(this.cachedInputs=null,this.inputs().forEach(function(inp){old=oldInputs[i],old instanceof ReporterBlockMorph&&!(inp instanceof TemplateSlotMorph)?myself.silentReplaceInput(inp,old.fullCopy()):old instanceof InputSlotMorph&&inp instanceof InputSlotMorph?inp.setContents(old.evaluate()):old instanceof TemplateSlotMorph&&inp instanceof TemplateSlotMorph?inp.setContents(old.evaluate()):old instanceof CSlotMorph&&inp instanceof CSlotMorph&&inp.nestedBlock(old.evaluate()),
i+=1}),this.cachedInputs=null)},CustomCommandBlockMorph.prototype.refreshDefaults=function(definition){var inputs=this.inputs(),idx=0,myself=this;inputs.forEach(function(inp){(inp instanceof InputSlotMorph||inp instanceof BooleanSlotMorph)&&inp.setContents((definition||myself.definition).defaultValueOfInputIdx(idx)),idx+=1}),this.cachedInputs=null},CustomCommandBlockMorph.prototype.refreshPrototype=function(){var hat,protoSpec,words,newFrag,frags=[],myself=this,i=0;return this.isPrototype?(hat=this.parentThatIsA(PrototypeHatBlockMorph),this.parts().forEach(function(part){part.fragment.isDeleted||(part.fragment.type?frags.push(part.fragment):(words=myself.definition.parseSpec(part.fragment.labelString),
words.forEach(function(word){newFrag=part.fragment.copy(),newFrag.labelString=word,frags.push(newFrag)})))}),protoSpec=this.specFromFragments(),this instanceof CustomCommandBlockMorph&&("reporter"===hat.type||"predicate"===hat.type)?(myself=new CustomReporterBlockMorph(this.definition,"predicate"===hat.type,!0),hat.silentReplaceInput(this,myself)):this instanceof CustomReporterBlockMorph&&("command"===hat.type?(myself=new CustomCommandBlockMorph(this.definition,!0),hat.silentReplaceInput(this,myself)):(this.isPredicate="predicate"===hat.type,this.drawNew())),myself.setCategory(hat.blockCategory||"other"),hat.fixBlockColor(),myself.setSpec(protoSpec),myself.parts().forEach(function(part){
part instanceof BlockLabelPlaceHolderMorph||(frags[i]&&(part.fragment=frags[i]),i+=1)}),this.refreshPrototypeSlotTypes(),void hat.fixLayout()):null},CustomCommandBlockMorph.prototype.refreshPrototypeSlotTypes=function(){this.parts().forEach(function(part){part instanceof BlockInputFragmentMorph&&(part.template().instantiationSpec=part.contents(),part.setContents(part.fragment.defTemplateSpecFragment()))}),this.fixBlockColor(null,!0)},CustomCommandBlockMorph.prototype.inputFragmentNames=function(){var ans=[];return this.parts().forEach(function(part){!part.fragment.isDeleted&&part.fragment.type&&ans.push(part.fragment.labelString)}),ans},CustomCommandBlockMorph.prototype.upvarFragmentNames=function(){
var ans=[];return this.parts().forEach(function(part){part.fragment.isDeleted||"%upvar"!==part.fragment.type||ans.push(part.fragment.labelString)}),ans},CustomCommandBlockMorph.prototype.upvarFragmentName=function(idx){return this.upvarFragmentNames()[idx]||"↑"},CustomCommandBlockMorph.prototype.specFromFragments=function(){var ans="";return this.parts().forEach(function(part){part.fragment.isDeleted||(ans=ans+part.fragment.defSpecFragment()+" ")}),ans.trim()},CustomCommandBlockMorph.prototype.blockSpecFromFragments=function(){var ans="";return this.parts().forEach(function(part){part.fragment.isDeleted||(ans=ans+part.fragment.blockSpecFragment()+" ")}),ans.trim();
},CustomCommandBlockMorph.prototype.declarationsFromFragments=function(){var ans={};return this.parts().forEach(function(part){part instanceof BlockInputFragmentMorph&&(ans[part.fragment.labelString]=[part.fragment.type,part.fragment.defaultValue,part.fragment.options,part.fragment.isReadOnly])}),ans},CustomCommandBlockMorph.prototype.parseSpec=function(spec){return this.isPrototype?CustomBlockDefinition.prototype.parseSpec(spec):CustomCommandBlockMorph.uber.parseSpec.call(this,spec)},CustomCommandBlockMorph.prototype.mouseClickLeft=function(){return this.isPrototype?void this.edit():CustomCommandBlockMorph.uber.mouseClickLeft.call(this)},CustomCommandBlockMorph.prototype.edit=function(){
var editor,block,hat,rcvr,myself=this,def=this.definition;if(this.isPrototype)block=this.definition.blockInstance(),block.addShadow(),hat=this.parentThatIsA(PrototypeHatBlockMorph),new BlockDialogMorph(null,function(definition){definition&&(hat.blockCategory=definition.category,hat.type=definition.type,myself.refreshPrototype())},myself).openForChange("Change block",hat.blockCategory,hat.type,myself.world(),block.fullImage(),myself.isInUse());else{if(rcvr=this.scriptTarget(),!this.isGlobal){if(contains(Object.keys(rcvr.inheritedBlocks()),this.blockSpec))return void this.duplicateBlockDefinition();def=rcvr.getMethod(this.semanticSpec)}Morph.prototype.trackChanges=!1,
editor=new BlockEditorMorph(def,rcvr),editor.popUp(),Morph.prototype.trackChanges=!0,editor.changed()}},CustomCommandBlockMorph.prototype.labelPart=function(spec){var part;return this.isPrototype?("%"===spec[0]&&spec.length>1?part=new BlockInputFragmentMorph(spec.replace(/%/g,"")):(part=new BlockLabelFragmentMorph(spec),part.fontSize=this.fontSize,part.color=new Color(255,255,255),part.isBold=!0,part.shadowColor=this.color.darker(this.labelContrast),part.shadowOffset=this.embossing,part.drawNew()),part):CustomCommandBlockMorph.uber.labelPart.call(this,spec)},CustomCommandBlockMorph.prototype.placeHolder=function(){var part;return part=new BlockLabelPlaceHolderMorph,
part.fontSize=1.4*this.fontSize,part.color=new Color(45,45,45),part.drawNew(),part},CustomCommandBlockMorph.prototype.attachTargets=function(){return this.isPrototype?[]:CustomCommandBlockMorph.uber.attachTargets.call(this)},CustomCommandBlockMorph.prototype.isInUse=function(){var def=this.definition,rcvr=this.scriptTarget(),ide=rcvr.parentThatIsA(IDE_Morph);return def.isGlobal&&ide?ide.sprites.asArray().concat([ide.stage]).some(function(any,idx){return any.usesBlockInstance(def,!1,idx)}):rcvr.allDependentInvocationsOf(this.blockSpec).length>0},CustomCommandBlockMorph.prototype.userMenu=function(){function addOption(label,toggle,test,onHint,offHint){var on="☑ ",off="☐ ";
menu.addItem((test?on:off)+localize(label),toggle,test?onHint:offHint)}function monitor(vName){var stage=rcvr.parentThatIsA(StageMorph),varFrame=myself.variables;menu.addItem(vName+"...",function(){var others,watcher=detect(stage.children,function(morph){return morph instanceof WatcherMorph&&morph.target===varFrame&&morph.getter===vName});return null!==watcher?(watcher.show(),void watcher.fixLayout()):(watcher=new WatcherMorph(vName+" "+localize("(temporary)"),SpriteMorph.prototype.blockColor.variables,varFrame,vName),watcher.setPosition(stage.position().add(10)),others=stage.watchers(watcher.left()),others.length>0&&watcher.setTop(others[others.length-1].bottom()),
stage.add(watcher),void watcher.fixLayout())})}var menu,hat=this.parentThatIsA(PrototypeHatBlockMorph),rcvr=this.scriptTarget(),myself=this,shiftClicked=16===this.world().currentKey;return this.isPrototype?(menu=new MenuMorph(this),menu.addItem("script pic...",function(){var ide=this.world().children[0];ide.saveCanvasAs(this.topBlock().scriptPic(),(ide.projectName||localize("untitled"))+" "+localize("script pic"))},"open a new window\nwith a picture of this script"),menu.addItem("translations...",function(){hat.parentThatIsA(BlockEditorMorph).editTranslations()},"experimental -\nunder construction"),this.isGlobal&&(hat.inputs().length<2?menu.addItem("block variables...",function(){
hat.enableBlockVars()},"experimental -\nunder construction"):menu.addItem("remove block variables...",function(){hat.enableBlockVars(!1)},"experimental -\nunder construction"))):(menu=this.constructor.uber.userMenu.call(this),menu?menu.addLine():menu=new MenuMorph(this),shiftClicked&&menu.addItem("duplicate block definition...","duplicateBlockDefinition",null,new Color(100,0,0)),this.isTemplate?this.isGlobal?menu.addItem("delete block definition...","deleteBlockDefinition"):contains(Object.keys(rcvr.inheritedBlocks()),this.blockSpec)?addOption("inherited",function(){var ide=myself.parentThatIsA(IDE_Morph);rcvr.customBlocks.push(rcvr.getMethod(myself.blockSpec).copyAndBindTo(rcvr)),
ide&&(ide.flushPaletteCache(),ide.refreshPalette())},!0,"uncheck to\ndisinherit",null):rcvr.exemplar&&rcvr.exemplar.getMethod(this.blockSpec)?addOption("inherited","deleteBlockDefinition",!1,null,localize("check to inherit\nfrom")+" "+rcvr.exemplar.name):menu.addItem("delete block definition...","deleteBlockDefinition"):(this.isGlobal||contains(Object.keys(rcvr.ownBlocks()),this.blockSpec))&&menu.addItem("delete block definition...","deleteBlockDefinition"),this.variables.names().forEach(function(vName){monitor(vName)})),menu.addItem("edit...","edit"),menu},CustomCommandBlockMorph.prototype.exportBlockDefinition=function(){var xml=(new SnapSerializer).serialize(this.definition),ide=this.parentThatIsA(IDE_Morph);
ide.saveXMLAs(xml,this.spec)},CustomCommandBlockMorph.prototype.duplicateBlockDefinition=function(){var rcvr=this.scriptTarget(),ide=this.parentThatIsA(IDE_Morph),def=this.isGlobal?this.definition:rcvr.getMethod(this.blockSpec),dup=def.copyAndBindTo(rcvr);this.isGlobal?ide.stage.globalBlocks.push(dup):rcvr.customBlocks.push(dup),ide.flushPaletteCache(),ide.refreshPalette(),new BlockEditorMorph(dup,rcvr).popUp()},CustomCommandBlockMorph.prototype.deleteBlockDefinition=function(){var idx,stage,ide,method,block,rcvr=this.scriptTarget(),myself=this;return this.isPrototype?null:(method=this.isGlobal?this.definition:rcvr.getLocalMethod(this.blockSpec),block=method.blockInstance(),
block.addShadow(),void new DialogBoxMorph(this,function(){rcvr.deleteAllBlockInstances(method),method.isGlobal?(stage=rcvr.parentThatIsA(StageMorph),idx=stage.globalBlocks.indexOf(method),idx!==-1&&stage.globalBlocks.splice(idx,1)):(idx=rcvr.customBlocks.indexOf(method),idx!==-1&&rcvr.customBlocks.splice(idx,1),method=rcvr.getMethod(myself.blockSpec),method&&rcvr.allDependentInvocationsOf(myself.blockSpec).forEach(function(block){block.refresh(method)})),ide=rcvr.parentThatIsA(IDE_Morph),ide&&(ide.flushPaletteCache(),ide.refreshPalette())},this).askYesNo("Delete Custom Block",localize("block deletion dialog text"),myself.world(),block.fullImage()))},CustomCommandBlockMorph.prototype.relabel=function(alternatives){
var menu=new MenuMorph(this),oldInputs=this.inputs().map(function(each){return each.fullCopy()}),myself=this;alternatives.forEach(function(def){var block=def.blockInstance();block.restoreInputs(oldInputs),block.fixBlockColor(null,!0),block.addShadow(new Point(3,3)),menu.addItem(block,function(){myself.definition=def,myself.refresh()})}),menu.popup(this.world(),this.bottomLeft().subtract(new Point(8,this instanceof CommandBlockMorph?this.corner:0)))},CustomCommandBlockMorph.prototype.alternatives=function(){var rcvr=this.scriptTarget(),stage=rcvr.parentThatIsA(StageMorph),allDefs=rcvr.customBlocks.concat(stage.globalBlocks),type=this instanceof CommandBlockMorph?"command":this.isPredicate?"predicate":"reporter",myself=this;
return allDefs.filter(function(each){return each!==myself.definition&&each.type===type})},CustomReporterBlockMorph.prototype=new ReporterBlockMorph,CustomReporterBlockMorph.prototype.constructor=CustomReporterBlockMorph,CustomReporterBlockMorph.uber=ReporterBlockMorph.prototype,CustomReporterBlockMorph.prototype.isCustomBlock=!0,CustomReporterBlockMorph.prototype.init=function(definition,isPredicate,isProto){this.definition=definition,this.semanticSpec="",this.isGlobal=!!definition&&definition.isGlobal,this.isPrototype=isProto||!1,CustomReporterBlockMorph.uber.init.call(this,isPredicate,!0),this.category=definition.category,this.variables=new VariableFrame,this.initializeVariables(),
this.selector="evaluateCustomBlock",definition&&this.refresh()},CustomReporterBlockMorph.prototype.initializeVariables=CustomCommandBlockMorph.prototype.initializeVariables,CustomReporterBlockMorph.prototype.refresh=function(aDefinition){var def=aDefinition||this.definition;CustomCommandBlockMorph.prototype.refresh.call(this,aDefinition,!0),this.isPrototype||(this.isPredicate="predicate"===def.type),this.parent instanceof SyntaxElementMorph&&(this.parent.cachedInputs=null),this.drawNew()},CustomReporterBlockMorph.prototype.mouseClickLeft=function(){return this.isPrototype?void this.edit():CustomReporterBlockMorph.uber.mouseClickLeft.call(this)},CustomReporterBlockMorph.prototype.placeHolder=CustomCommandBlockMorph.prototype.placeHolder,
CustomReporterBlockMorph.prototype.parseSpec=CustomCommandBlockMorph.prototype.parseSpec,CustomReporterBlockMorph.prototype.edit=CustomCommandBlockMorph.prototype.edit,CustomReporterBlockMorph.prototype.labelPart=CustomCommandBlockMorph.prototype.labelPart,CustomReporterBlockMorph.prototype.upvarFragmentNames=CustomCommandBlockMorph.prototype.upvarFragmentNames,CustomReporterBlockMorph.prototype.upvarFragmentName=CustomCommandBlockMorph.prototype.upvarFragmentName,CustomReporterBlockMorph.prototype.inputFragmentNames=CustomCommandBlockMorph.prototype.inputFragmentNames,CustomReporterBlockMorph.prototype.specFromFragments=CustomCommandBlockMorph.prototype.specFromFragments,
CustomReporterBlockMorph.prototype.blockSpecFromFragments=CustomCommandBlockMorph.prototype.blockSpecFromFragments,CustomReporterBlockMorph.prototype.declarationsFromFragments=CustomCommandBlockMorph.prototype.declarationsFromFragments,CustomReporterBlockMorph.prototype.refreshPrototype=CustomCommandBlockMorph.prototype.refreshPrototype,CustomReporterBlockMorph.prototype.refreshPrototypeSlotTypes=CustomCommandBlockMorph.prototype.refreshPrototypeSlotTypes,CustomReporterBlockMorph.prototype.restoreInputs=CustomCommandBlockMorph.prototype.restoreInputs,CustomReporterBlockMorph.prototype.refreshDefaults=CustomCommandBlockMorph.prototype.refreshDefaults,CustomReporterBlockMorph.prototype.isInUse=CustomCommandBlockMorph.prototype.isInUse,
CustomReporterBlockMorph.prototype.userMenu=CustomCommandBlockMorph.prototype.userMenu,CustomReporterBlockMorph.prototype.duplicateBlockDefinition=CustomCommandBlockMorph.prototype.duplicateBlockDefinition,CustomReporterBlockMorph.prototype.deleteBlockDefinition=CustomCommandBlockMorph.prototype.deleteBlockDefinition,CustomReporterBlockMorph.prototype.bubbleHelp=CustomCommandBlockMorph.prototype.bubbleHelp,CustomReporterBlockMorph.prototype.popUpbubbleHelp=CustomCommandBlockMorph.prototype.popUpbubbleHelp,CustomReporterBlockMorph.prototype.relabel=CustomCommandBlockMorph.prototype.relabel,CustomReporterBlockMorph.prototype.alternatives=CustomCommandBlockMorph.prototype.alternatives,
JaggedBlockMorph.prototype=new ReporterBlockMorph,JaggedBlockMorph.prototype.constructor=JaggedBlockMorph,JaggedBlockMorph.uber=ReporterBlockMorph.prototype,JaggedBlockMorph.prototype.jag=5,JaggedBlockMorph.prototype.init=function(spec){JaggedBlockMorph.uber.init.call(this),spec&&this.setSpec(spec),"%cs"===spec&&(this.minWidth=25,this.fixLayout())},JaggedBlockMorph.prototype.drawNew=function(){var context;this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),context=this.image.getContext("2d"),context.fillStyle=this.cachedClr,this.drawBackground(context),MorphicPreferences.isFlat||this.drawEdges(context),
this.eraseHoles(context)},JaggedBlockMorph.prototype.drawBackground=function(context){var i,y,w=this.width(),h=this.height(),jags=Math.round(h/this.jag),delta=h/jags;for(context.fillStyle=this.cachedClr,context.beginPath(),context.moveTo(0,0),context.lineTo(w,0),y=0,i=0;i<jags;i+=1)y+=delta/2,context.lineTo(w-this.jag/2,y),y+=delta/2,context.lineTo(w,y);for(context.lineTo(0,h),y=h,i=0;i<jags;i+=1)y-=delta/2,context.lineTo(this.jag/2,y),y-=delta/2,context.lineTo(0,y);context.closePath(),context.fill()},JaggedBlockMorph.prototype.drawEdges=function(context){var gradient,i,y,w=this.width(),h=this.height(),jags=Math.round(h/this.jag),delta=h/jags,shift=this.edge/2;
for(context.lineWidth=this.edge,context.lineJoin="round",context.lineCap="round",gradient=context.createLinearGradient(0,0,0,this.edge),gradient.addColorStop(0,this.cachedClrBright),gradient.addColorStop(1,this.cachedClr),context.strokeStyle=gradient,context.beginPath(),context.moveTo(shift,shift),context.lineTo(w-shift,shift),context.stroke(),y=0,i=0;i<jags;i+=1)context.strokeStyle=this.cachedClrDark,context.beginPath(),context.moveTo(w-shift,y),y+=delta/2,context.lineTo(w-this.jag/2-shift,y),context.stroke(),y+=delta/2;for(gradient=context.createLinearGradient(0,h-this.edge,0,h),gradient.addColorStop(0,this.cachedClr),gradient.addColorStop(1,this.cachedClrDark),
context.strokeStyle=gradient,context.beginPath(),context.moveTo(w-shift,h-shift),context.lineTo(shift,h-shift),context.stroke(),y=h,i=0;i<jags;i+=1)context.strokeStyle=this.cachedClrBright,context.beginPath(),context.moveTo(shift,y),y-=delta/2,context.lineTo(this.jag/2+shift,y),context.stroke(),y-=delta/2},BlockDialogMorph.prototype=new DialogBoxMorph,BlockDialogMorph.prototype.constructor=BlockDialogMorph,BlockDialogMorph.uber=DialogBoxMorph.prototype,BlockDialogMorph.prototype.init=function(target,action,environment){this.blockType="command",this.category="other",this.isGlobal=!0,this.types=null,this.categories=null,BlockDialogMorph.uber.init.call(this,target,action,environment),
this.key="makeABlock",this.types=new AlignmentMorph("row",this.padding),this.add(this.types),this.scopes=new AlignmentMorph("row",this.padding),this.add(this.scopes),this.categories=new BoxMorph,this.categories.color=SpriteMorph.prototype.paletteColor.lighter(8),this.categories.borderColor=this.categories.color.lighter(40),this.createCategoryButtons(),this.fixCategoriesLayout(),this.add(this.categories),this.createTypeButtons(),this.creatpanel_LefteButtons(),this.fixLayout()},BlockDialogMorph.prototype.openForChange=function(title,category,type,world,pic,preventTypeChange){var clr=SpriteMorph.prototype.blockColor[category];this.key="changeABlock",this.category=category,
this.blockType=type,this.categories.children.forEach(function(each){each.refresh()}),this.types.children.forEach(function(each){each.setColor(clr),each.refresh()}),this.labelString=title,this.createLabel(),pic&&this.setPicture(pic),this.addButton("ok","OK"),this.addButton("cancel","Cancel"),preventTypeChange&&(this.types.destroy(),this.types=null),this.scopes.destroy(),this.scopes=null,this.fixLayout(),this.drawNew(),this.popUp(world)},BlockDialogMorph.prototype.createCategoryButtons=function(){var myself=this,oldFlag=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,SpriteMorph.prototype.categories.forEach(function(cat){myself.addCategoryButton(cat);
}),Morph.prototype.trackChanges=oldFlag},BlockDialogMorph.prototype.addCategoryButton=function(category){var button,labelWidth=75,myself=this,colors=[SpriteMorph.prototype.paletteColor,SpriteMorph.prototype.paletteColor.darker(50),SpriteMorph.prototype.blockColor[category]];return button=new ToggleButtonMorph(colors,this,function(){myself.category=category,myself.categories.children.forEach(function(each){each.refresh()}),myself.types&&myself.types.children.forEach(function(each){each.setColor(colors[2])}),myself.edit()},category[0].toUpperCase().concat(category.slice(1)),function(){return myself.category===category},null,null,null,labelWidth,!0),button.corner=8,
button.padding=0,button.labelShadowOffset=new Point(-1,-1),button.labelShadowColor=colors[1],button.labelColor=IDE_Morph.prototype.buttonLabelColor,button.contrast=this.buttonContrast,button.fixLayout(),button.refresh(),this.categories.add(button),button},BlockDialogMorph.prototype.fixCategoriesLayout=function(){var row,col,buttonWidth=this.categories.children[0].width(),buttonHeight=this.categories.children[0].height(),xPadding=15,yPadding=2,border=10,rows=Math.ceil(this.categories.children.length/2),l=this.categories.left(),t=this.categories.top(),i=0,oldFlag=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,this.categories.children.forEach(function(button){
i+=1,row=Math.ceil(i/2),col=2-i%2,button.setPosition(new Point(l+(col*xPadding+(col-1)*buttonWidth),t+(row*yPadding+(row-1)*buttonHeight+border)))}),MorphicPreferences.isFlat&&(this.categories.corner=0,this.categories.border=0,this.categories.edge=0),this.categories.setExtent(new Point(3*xPadding+2*buttonWidth,(rows+1)*yPadding+rows*buttonHeight+2*border)),Morph.prototype.trackChanges=oldFlag,this.categories.changed()},BlockDialogMorph.prototype.createTypeButtons=function(){var block,myself=this,clr=SpriteMorph.prototype.blockColor[this.category];block=new CommandBlockMorph,block.setColor(clr),block.setSpec(localize("Command")),this.addBlockTypeButton(function(){
myself.setType("command")},block,function(){return"command"===myself.blockType}),block=new ReporterBlockMorph,block.setColor(clr),block.setSpec(localize("Reporter")),this.addBlockTypeButton(function(){myself.setType("reporter")},block,function(){return"reporter"===myself.blockType}),block=new ReporterBlockMorph(!0),block.setColor(clr),block.setSpec(localize("Predicate")),this.addBlockTypeButton(function(){myself.setType("predicate")},block,function(){return"predicate"===myself.blockType})},BlockDialogMorph.prototype.addBlockTypeButton=function(action,element,query){var button=new ToggleElementMorph(this,action,element,query,null,null,"rebuild");return button.refresh(),
this.types.add(button),button},BlockDialogMorph.prototype.addTypeButton=function(action,label,query){var button=new ToggleMorph("radiobutton",this,action,label,query);return button.edge=this.buttonEdge/2,button.outline=this.buttonOutline/2,button.outlineColor=this.buttonOutlineColor,button.outlineGradient=this.buttonOutlineGradient,button.contrast=this.buttonContrast,button.drawNew(),button.fixLayout(),this.types.add(button),button},BlockDialogMorph.prototype.setType=function(blockType){this.blockType=blockType||this.blockType,this.types.children.forEach(function(c){c.refresh()}),this.edit()},BlockDialogMorph.prototype.creatpanel_LefteButtons=function(){var myself=this;
this.addScopeButton(function(){myself.setScope("global")},"for all sprites",function(){return myself.isGlobal}),this.addScopeButton(function(){myself.setScope("local")},"for this sprite only",function(){return!myself.isGlobal})},BlockDialogMorph.prototype.addScopeButton=function(action,label,query){var button=new ToggleMorph("radiobutton",this,action,label,query);return button.edge=this.buttonEdge/2,button.outline=this.buttonOutline/2,button.outlineColor=this.buttonOutlineColor,button.outlineGradient=this.buttonOutlineGradient,button.contrast=this.buttonContrast,button.drawNew(),button.fixLayout(),this.scopes.add(button),button},BlockDialogMorph.prototype.setScope=function(varType){
this.isGlobal="global"===varType,this.scopes.children.forEach(function(c){c.refresh()}),this.edit()},BlockDialogMorph.prototype.getInput=function(){var spec,def,body;return this.body instanceof InputFieldMorph&&(spec=this.normalizeSpaces(this.body.getValue())),def=new CustomBlockDefinition(spec),def.type=this.blockType,def.category=this.category,def.isGlobal=this.isGlobal,"reporter"!==def.type&&"predicate"!==def.type||(body=Process.prototype.reify.call(null,SpriteMorph.prototype.blockForSelector("doReport"),new List,!0),body.outerContext=null,def.body=body),def},BlockDialogMorph.prototype.fixLayout=function(){var th=fontHeight(this.titleFontSize)+2*this.titlePadding;
this.body?(this.body.setPosition(this.position().add(new Point(this.padding,th+this.padding))),this.silentSetWidth(this.body.width()+2*this.padding),this.silentSetHeight(this.body.height()+2*this.padding+th),this.categories&&(this.categories.setCenter(this.body.center()),this.categories.setTop(this.body.top()),this.body.setTop(this.categories.bottom()+this.padding),this.silentSetHeight(this.height()+this.categories.height()+this.padding))):this.head&&(this.types?(this.types.fixLayout(),this.silentSetWidth(Math.max(this.types.width(),this.head.width())+2*this.padding)):this.silentSetWidth(Math.max(this.categories.width(),this.head.width())+2*this.padding),this.head.setCenter(this.center()),
this.head.setTop(th+this.padding),this.silentSetHeight(this.head.height()+2*this.padding+th),this.categories&&(this.categories.setCenter(this.center()),this.categories.setTop(this.head.bottom()+this.padding),this.silentSetHeight(this.height()+this.categories.height()+this.padding))),this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(th-this.label.height())/2)),this.types&&(this.types.fixLayout(),this.silentSetHeight(this.height()+this.types.height()+this.padding),this.silentSetWidth(Math.max(this.width(),this.types.width()+2*this.padding)),this.types.setCenter(this.center()),this.body?this.types.setTop(this.body.bottom()+this.padding):this.categories&&this.types.setTop(this.categories.bottom()+this.padding)),
this.scopes&&(this.scopes.fixLayout(),this.silentSetHeight(this.height()+this.scopes.height()+this.padding/3),this.silentSetWidth(Math.max(this.width(),this.scopes.width()+2*this.padding)),this.scopes.setCenter(this.center()),this.types&&this.scopes.setTop(this.types.bottom()+this.padding/3)),this.buttons&&this.buttons.children.length>0&&(this.buttons.fixLayout(),this.silentSetHeight(this.height()+this.buttons.height()+this.padding),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding))},BlockDialogMorph.prototype.accept=function(){this.body instanceof InputFieldMorph&&""===this.normalizeSpaces(this.body.getValue())?this.edit():BlockDialogMorph.uber.accept.call(this);
},BlockEditorMorph.prototype=new DialogBoxMorph,BlockEditorMorph.prototype.constructor=BlockEditorMorph,BlockEditorMorph.uber=DialogBoxMorph.prototype,BlockEditorMorph.prototype.init=function(definition,target){var scripts,proto,scriptsFrame,block,comment,myself=this,isLive=Process.prototype.enableLiveCoding||Process.prototype.enableSingleStepping;this.definition=definition,this.translations=definition.translationsAsText(),this.handle=null,BlockEditorMorph.uber.init.call(this,target,function(){myself.updateDefinition()},target),this.key="editBlock"+definition.spec,this.labelString=this.definition.isGlobal?"Block Editor":"Method Editor",this.createLabel(),scripts=new ScriptsMorph,
scripts.rejectsHats=!0,scripts.isDraggable=!1,scripts.color=IDE_Morph.prototype.groupColor,scripts.cachedTexture=IDE_Morph.prototype.scriptsPaneTexture,scripts.cleanUpMargin=10,proto=new PrototypeHatBlockMorph(this.definition),proto.setPosition(scripts.position().add(10)),null!==definition.comment&&(comment=definition.comment.fullCopy(),proto.comment=comment,comment.block=proto),null!==definition.body&&proto.nextBlock(isLive?definition.body.expression:definition.body.expression.fullCopy()),scripts.add(proto),proto.fixBlockColor(null,!0),proto.drawNew(),this.definition.scripts.forEach(function(element){block=element.fullCopy(),block.setPosition(scripts.position().add(element.position())),
scripts.add(block),block instanceof BlockMorph&&block.allComments().forEach(function(comment){comment.align(block)})}),proto.allComments().forEach(function(comment){comment.align(proto)}),scriptsFrame=new ScrollFrameMorph(scripts),scriptsFrame.padding=10,scriptsFrame.growth=50,scriptsFrame.isDraggable=!1,scriptsFrame.acceptsDrops=!1,scriptsFrame.contents.acceptsDrops=!0,scripts.scrollFrame=scriptsFrame,scripts.updateToolbar(),this.addBody(scriptsFrame),this.addButton("ok","OK"),isLive||(this.addButton("updateDefinition","Apply"),this.addButton("cancel","Cancel")),this.setExtent(new Point(375,300)),this.fixLayout(),scripts.fixMultiArgs(),block=proto.parts()[0],
block.forceNormalColoring(),block.fixBlockColor(proto,!0)},BlockEditorMorph.prototype.popUp=function(){var world=this.target.world();world&&(BlockEditorMorph.uber.popUp.call(this,world),this.setInitialDimensions(),this.handle=new HandleMorph(this,280,220,this.corner,this.corner),world.keyboardReceiver=null)},BlockEditorMorph.prototype.justDropped=function(){nop()},BlockEditorMorph.prototype.accept=function(origin){origin instanceof CursorMorph||(this.action&&("function"==typeof this.target?"function"==typeof this.action?this.target.call(this.environment,this.action.call()):this.target.call(this.environment,this.action):"function"==typeof this.action?this.action.call(this.target,this.getInput()):this.target[this.action](this.getInput())),
this.close())},BlockEditorMorph.prototype.cancel=function(origin){origin instanceof CursorMorph||this.close()},BlockEditorMorph.prototype.close=function(){var doubles,block,myself=this;return this.definition.isGlobal&&(block=detect(this.body.contents.allChildren(),function(morph){return morph.definition&&!morph.definition.isGlobal}))?(block=block.definition.blockInstance(),block.addShadow(),void(new DialogBoxMorph).inform("Local Block(s) in Global Definition","This global block definition contains one or more\nlocal custom blocks which must be removed first.",myself.world(),block.fullImage())):(doubles=this.target.doubleDefinitionsFor(this.definition),doubles.length>0?(block=doubles[0].blockInstance(),
block.addShadow(),void new DialogBoxMorph(this,"consolidateDoubles",this).askYesNo("Same Named Blocks","Another custom block with this name exists.\nWould you like to replace it?",myself.world(),block.fullImage())):void this.destroy())},BlockEditorMorph.prototype.consolidateDoubles=function(){this.target.replaceDoubleDefinitionsFor(this.definition),this.destroy()},BlockEditorMorph.prototype.refreshAllBlockInstances=function(oldSpec){var def=this.definition,template=this.target.paletteBlockInstance(def);this.definition.isGlobal?this.target.allBlockInstances(this.definition).forEach(function(block){block.refresh()}):this.target.allDependentInvocationsOf(oldSpec).forEach(function(block){
block.refresh(def)}),template&&template.refreshDefaults()},BlockEditorMorph.prototype.updateDefinition=function(){var head,ide,element,oldSpec=this.definition.blockSpec(),pos=this.body.contents.position(),myself=this;this.definition.receiver=this.target,this.definition.spec=this.prototypeSpec(),this.definition.declarations=this.prototypeSlots(),this.definition.variableNames=this.variableNames(),this.definition.scripts=[],this.definition.updateTranslations(this.translations),this.definition.cachedTranslation=null,this.definition.editorDimensions=this.bounds.copy(),this.definition.cachedIsRecursive=null,this.body.contents.children.forEach(function(morph){morph instanceof PrototypeHatBlockMorph?head=morph:(morph instanceof BlockMorph||morph instanceof CommentMorph&&!morph.block)&&(element=morph.fullCopy(),
element.parent=null,element.setPosition(morph.position().subtract(pos)),myself.definition.scripts.push(element))}),head&&(this.definition.category!==head.blockCategory&&this.target.shadowAttribute("scripts"),this.definition.category=head.blockCategory,this.definition.type=head.type,head.comment?(this.definition.comment=head.comment.fullCopy(),this.definition.comment.block=!0):this.definition.comment=null),this.definition.body=this.context(head),this.refreshAllBlockInstances(oldSpec),ide=this.target.parentThatIsA(IDE_Morph),ide.flushPaletteCache(),ide.refreshPalette()},BlockEditorMorph.prototype.context=function(prototypeHat){var head,topBlock,stackFrame;return head=prototypeHat||detect(this.body.contents.children,function(c){
return c instanceof PrototypeHatBlockMorph}),topBlock=head.nextBlock(),null===topBlock?null:(topBlock.allChildren().forEach(function(c){c instanceof BlockMorph&&(c.cachedInputs=null)}),stackFrame=Process.prototype.reify.call(null,topBlock,new List(this.definition.inputNames()),!0),stackFrame.outerContext=null,stackFrame)},BlockEditorMorph.prototype.prototypeSpec=function(){return detect(this.body.contents.children,function(c){return c instanceof PrototypeHatBlockMorph}).parts()[0].specFromFragments()},BlockEditorMorph.prototype.prototypeSlots=function(){return detect(this.body.contents.children,function(c){return c instanceof PrototypeHatBlockMorph}).parts()[0].declarationsFromFragments();
},BlockEditorMorph.prototype.variableNames=function(){return detect(this.body.contents.children,function(c){return c instanceof PrototypeHatBlockMorph}).variableNames()},BlockEditorMorph.prototype.editTranslations=function(){var myself=this,block=this.definition.blockInstance();block.addShadow(new Point(3,3)),new DialogBoxMorph(myself,function(text){myself.translations=text},myself).promptCode("Custom Block Translations",myself.translations,myself.world(),block.fullImage(),myself.definition.abstractBlockSpec()+"\n\n"+localize('Enter one translation per line. use colon (":") as lang/spec delimiter\nand underscore ("_") as placeholder for an input, e.g.:\n\nen:say _ for _ secs'));
},BlockEditorMorph.prototype.setInitialDimensions=function(){var world=this.world(),mex=world.extent().subtract(new Point(this.padding,this.padding)),th=fontHeight(this.titleFontSize)+2*this.titlePadding,bh=this.buttons.height();return this.definition.editorDimensions?(this.setPosition(this.definition.editorDimensions.origin),this.setExtent(this.definition.editorDimensions.extent().min(mex)),void this.keepWithin(world)):(this.setExtent(this.body.contents.extent().add(new Point(this.padding,this.padding+th+bh)).min(mex)),void this.setCenter(this.world().center()))},BlockEditorMorph.prototype.fixLayout=function(){var th=fontHeight(this.titleFontSize)+2*this.titlePadding;
this.buttons&&this.buttons.children.length>0&&this.buttons.fixLayout(),this.body&&(this.body.setPosition(this.position().add(new Point(this.padding,th+this.padding))),this.body.setExtent(new Point(this.width()-2*this.padding,this.height()-3*this.padding-th-this.buttons.height()))),this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(th-this.label.height())/2)),this.buttons&&this.buttons.children.length>0&&(this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding))},PrototypeHatBlockMorph.prototype=new HatBlockMorph,PrototypeHatBlockMorph.prototype.constructor=PrototypeHatBlockMorph,PrototypeHatBlockMorph.uber=HatBlockMorph.prototype,
PrototypeHatBlockMorph.prototype.init=function(definition){var vars,proto=definition.prototypeInstance();this.definition=definition,this.blockCategory=definition?definition.category:null,this.type=definition?definition.type:null,HatBlockMorph.uber.init.call(this),this.color=SpriteMorph.prototype.blockColor.control,this.category="control",this.add(proto),definition.variableNames.length&&(vars=this.labelPart("%blockVars"),this.add(this.labelPart("%br")),this.add(vars),definition.variableNames.forEach(function(name){vars.addInput(name)})),proto.refreshPrototypeSlotTypes(),this.fixLayout(),proto.fixBlockColor(this,!0)},PrototypeHatBlockMorph.prototype.mouseClickLeft=function(){
return 16===this.world().currentKey?this.focus():void this.parts()[0].mouseClickLeft()},PrototypeHatBlockMorph.prototype.userMenu=function(){return this.parts()[0].userMenu()},PrototypeHatBlockMorph.prototype.fixBlockColor=function(nearestBlock,isForced){var nearest=this.parts()[0]||nearestBlock;if(this.zebraContrast||isForced){if(!this.zebraContrast&&isForced)return this.forceNormalColoring();nearest.category===this.category?nearest.color.eq(this.color)&&this.alternateBlockColor():this.category&&!this.color.eq(SpriteMorph.prototype.blockColor[this.category])&&this.alternateBlockColor(),isForced&&this.fixChildrensBlockColor(!0)}},PrototypeHatBlockMorph.prototype.variableNames=function(choice){
var parts=this.parts();return parts.length<3?[]:parts[2].evaluate()},PrototypeHatBlockMorph.prototype.enableBlockVars=function(choice){var prot=this.parts()[0];choice===!1?this.setSpec("%s",!0):this.setSpec("%s %br %blockVars",!0),this.replaceInput(this.parts()[0],prot),this.spec=null},BlockLabelFragment.prototype.defSpecFragment=function(){var pref=this.type?"%'":"";return this.isDeleted?"":pref+this.labelString+(this.type?"'":"")},BlockLabelFragment.prototype.defTemplateSpecFragment=function(){var suff="";return this.type?(this.isUpvar()?suff=" ↑":this.isMultipleInput()?suff="...":"%cs"===this.type?suff=" λ":"%b"===this.type?suff=" ?":"%l"===this.type?suff=" ︙":"%obj"===this.type?suff=" %turtleOutline":contains(["%cmdRing","%repRing","%predRing","%anyUE","%boolUE"],this.type)?suff=" λ":this.defaultValue?suff="%n"===this.type?" # = "+this.defaultValue.toString():" = "+this.defaultValue.toString():"%n"===this.type&&(suff=" #"),
this.labelString+suff):this.defSpecFragment()},BlockLabelFragment.prototype.blockSpecFragment=function(){return this.isDeleted?"":this.type||this.labelString},BlockLabelFragment.prototype.copy=function(){var ans=new BlockLabelFragment(this.labelString);return ans.type=this.type,ans.defaultValue=this.defaultValue,ans.options=this.options,ans.isReadOnly=this.isReadOnly,ans},BlockLabelFragment.prototype.isSingleInput=function(){return!this.isMultipleInput()&&"%upvar"!==this.type},BlockLabelFragment.prototype.isMultipleInput=function(){return!!this.type&&this.type.indexOf("%mult")>-1},BlockLabelFragment.prototype.isUpvar=function(){return!!this.type&&"%upvar"===this.type;
},BlockLabelFragment.prototype.setToSingleInput=function(){return this.type?void("%upvar"===this.type?this.type="%s":this.type=this.singleInputType()):null},BlockLabelFragment.prototype.setToMultipleInput=function(){return this.type?("%upvar"===this.type&&(this.type="%s"),void(this.type="%mult".concat(this.singleInputType()))):null},BlockLabelFragment.prototype.setToUpvar=function(){return this.type?void(this.type="%upvar"):null},BlockLabelFragment.prototype.singleInputType=function(){return this.type?this.isMultipleInput()?this.type.substr(5):this.type:null},BlockLabelFragment.prototype.setSingleInputType=function(type){this.type&&this.isMultipleInput()?this.type="%mult".concat(type):this.type=type;
},BlockLabelFragmentMorph.prototype=new StringMorph,BlockLabelFragmentMorph.prototype.constructor=BlockLabelFragmentMorph,BlockLabelFragmentMorph.uber=StringMorph.prototype,BlockLabelFragmentMorph.prototype.init=function(text){this.fragment=new BlockLabelFragment(text),this.fragment.type=null,this.sO=null,BlockLabelFragmentMorph.uber.init.call(this,text,null,SyntaxElementMorph.prototype.labelFontStyle,null,null,null,null,null,null,SyntaxElementMorph.prototype.labelFontName)},BlockLabelFragmentMorph.prototype.mouseEnter=function(){this.sO=this.shadowOffset,this.shadowOffset=this.sO.neg(),this.drawNew(),this.changed()},BlockLabelFragmentMorph.prototype.mouseLeave=function(){
this.shadowOffset=this.sO,this.drawNew(),this.changed()},BlockLabelFragmentMorph.prototype.mouseClickLeft=function(){var frag=this.fragment.copy(),myself=this,isPlaceHolder=this instanceof BlockLabelPlaceHolderMorph,isOnlyElement=this.parent.parseSpec(this.parent.blockSpec).length<2;new InputSlotDialogMorph(frag,null,function(){myself.updateBlockLabel(frag)},this,this.parent.definition.category).open(this instanceof BlockLabelFragmentMorph?"Edit label fragment":isPlaceHolder?"Create input name":"Edit input name",frag.labelString,this.world(),null,isPlaceHolder||isOnlyElement)},BlockLabelFragmentMorph.prototype.updateBlockLabel=function(newFragment){var prot=this.parentThatIsA(BlockMorph);
this.fragment=newFragment,prot&&prot.refreshPrototype()},BlockLabelFragmentMorph.prototype.userMenu=function(){var myself=this,symbolColor=new Color(100,100,130),menu=new MenuMorph(function(string){var tuple=myself.text.split("-");myself.changed(),tuple[0]="$"+string,myself.text=tuple.join("-"),myself.fragment.labelString=myself.text,myself.parent.parent.changed(),myself.drawNew(),myself.changed(),myself.parent.parent.fixLayout(),myself.parent.parent.changed()},null,this,this.fontSize);return SymbolMorph.prototype.names.forEach(function(name){menu.addItem([new SymbolMorph(name,menu.fontSize,symbolColor),name],name)}),menu.addLine(),menu.addItem("⏎ "+localize("new line"),"nl"),
menu},BlockLabelPlaceHolderMorph.prototype=new StringMorph,BlockLabelPlaceHolderMorph.prototype.constructor=BlockLabelPlaceHolderMorph,BlockLabelPlaceHolderMorph.uber=StringMorph.prototype,BlockLabelPlaceHolderMorph.prototype.plainLabel=!1,BlockLabelPlaceHolderMorph.prototype.init=function(){this.fragment=new BlockLabelFragment(""),this.fragment.type="%s",this.fragment.isDeleted=!0,this.isHighlighted=!1,this.isProtectedLabel=!0,BlockLabelFragmentMorph.uber.init.call(this,"+")},BlockLabelPlaceHolderMorph.prototype.drawNew=function(){var context,width,x,y,cx,cy;this.plainLabel&&(this.text=this.isHighlighted?" + ":""),this.image=newCanvas(),context=this.image.getContext("2d"),
context.font=this.font(),width=Math.max(context.measureText(this.text).width+Math.abs(this.shadowOffset.x),1),this.bounds.corner=this.bounds.origin.add(new Point(width,fontHeight(this.fontSize)+Math.abs(this.shadowOffset.y))),this.image.width=width,this.image.height=this.height(),this.isHighlighted&&(cx=Math.floor(width/2),cy=Math.floor(this.height()/2),context.fillStyle=this.color.toString(),context.beginPath(),context.arc(cx,1.2*cy,Math.min(cx,cy),radians(0),radians(360),!1),context.closePath(),context.fill()),context.font=this.font(),context.textAlign="left",context.textBaseline="bottom",this.shadowColor&&(x=Math.max(this.shadowOffset.x,0),y=Math.max(this.shadowOffset.y,0),
context.fillStyle=this.shadowColor.toString(),context.fillText(this.text,x,fontHeight(this.fontSize)+y)),x=Math.abs(Math.min(this.shadowOffset.x,0)),y=Math.abs(Math.min(this.shadowOffset.y,0)),context.fillStyle=this.isHighlighted?"white":this.color.toString(),context.fillText(this.text,x,fontHeight(this.fontSize)+y),this.parent&&(this.parent.fixLayout&&this.parent.fixLayout(),this.parent.parent instanceof PrototypeHatBlockMorph&&this.parent.parent.fixLayout())},BlockLabelPlaceHolderMorph.prototype.mouseEnter=function(){var hat=this.parentThatIsA(PrototypeHatBlockMorph);this.isHighlighted=!0,this.plainLabel&&hat?(hat.changed(),this.drawNew(),hat.changed()):(this.drawNew(),
this.changed())},BlockLabelPlaceHolderMorph.prototype.mouseLeave=function(){var hat=this.parentThatIsA(PrototypeHatBlockMorph);this.isHighlighted=!1,this.plainLabel&&hat?(hat.changed(),this.drawNew(),hat.changed()):(this.drawNew(),this.changed())},BlockLabelPlaceHolderMorph.prototype.mouseClickLeft=BlockLabelFragmentMorph.prototype.mouseClickLeft,BlockLabelPlaceHolderMorph.prototype.updateBlockLabel=BlockLabelFragmentMorph.prototype.updateBlockLabel,BlockInputFragmentMorph.prototype=new TemplateSlotMorph,BlockInputFragmentMorph.prototype.constructor=BlockInputFragmentMorph,BlockInputFragmentMorph.uber=TemplateSlotMorph.prototype,BlockInputFragmentMorph.prototype.init=function(text){
this.fragment=new BlockLabelFragment(text),this.fragment.type="%s",BlockInputFragmentMorph.uber.init.call(this,text)},BlockInputFragmentMorph.prototype.mouseClickLeft=BlockLabelFragmentMorph.prototype.mouseClickLeft,BlockInputFragmentMorph.prototype.updateBlockLabel=BlockLabelFragmentMorph.prototype.updateBlockLabel,InputSlotDialogMorph.prototype=new DialogBoxMorph,InputSlotDialogMorph.prototype.constructor=InputSlotDialogMorph,InputSlotDialogMorph.uber=DialogBoxMorph.prototype,InputSlotDialogMorph.prototype.isLaunchingExpanded=!1,InputSlotDialogMorph.prototype.init=function(fragment,target,action,environment,category){var scale=SyntaxElementMorph.prototype.scale,fh=fontHeight(10)/1.2*scale;
this.fragment=fragment||new BlockLabelFragment,this.textfield=null,this.types=null,this.slots=null,this.isExpanded=!1,this.category=category||"other",this.cachedRadioButton=null,this.noDelete=!1,BlockDialogMorph.uber.init.call(this,target,action,environment),this.types=new AlignmentMorph("row",this.padding),this.types.respectHiddens=!0,this.add(this.types),this.slots=new BoxMorph,this.slots.color=new Color(55,55,55),this.slots.borderColor=this.slots.color.lighter(50),this.slots.setExtent(new Point(24*(fh+10),10.4*(fh+10*scale))),this.add(this.slots),this.createSlotTypeButtons(),this.fixSlotsLayout(),this.addSlotsMenu(),this.createTypeButtons(),this.fixLayout();
},InputSlotDialogMorph.prototype.createTypeButtons=function(){var block,arrow,myself=this,clr=SpriteMorph.prototype.blockColor[this.category];block=new JaggedBlockMorph(localize("Title text")),block.setColor(clr),this.addBlockTypeButton(function(){myself.setType(null)},block,function(){return null===myself.fragment.type}),block=new JaggedBlockMorph("%inputName"),block.setColor(clr),this.addBlockTypeButton(function(){myself.setType("%s")},block,function(){return null!==myself.fragment.type}),arrow=new ArrowMorph("right",PushButtonMorph.prototype.fontSize+4,2),arrow.noticesTransparentClick=!0,this.types.add(arrow),this.types.fixLayout(),arrow.refresh=function(){
null===myself.fragment.type?(myself.isExpanded=!1,arrow.hide(),myself.drawNew()):(arrow.show(),myself.isExpanded?arrow.direction="down":arrow.direction="right",arrow.drawNew(),arrow.changed())},arrow.mouseClickLeft=function(){arrow.isVisible&&(myself.isExpanded=!myself.isExpanded,myself.types.children.forEach(function(c){c.refresh()}),myself.drawNew(),myself.edit())},arrow.refresh()},InputSlotDialogMorph.prototype.addTypeButton=BlockDialogMorph.prototype.addTypeButton,InputSlotDialogMorph.prototype.addBlockTypeButton=BlockDialogMorph.prototype.addBlockTypeButton,InputSlotDialogMorph.prototype.setType=function(fragmentType){this.textfield.choices=fragmentType?null:this.symbolMenu,
this.textfield.drawNew(),this.fragment.type=fragmentType||null,this.types.children.forEach(function(c){c.refresh()}),this.slots.children.forEach(function(c){c.refresh()}),this.edit()},InputSlotDialogMorph.prototype.getInput=function(){var lbl;return this.body instanceof InputFieldMorph&&(lbl=this.normalizeSpaces(this.body.getValue())),lbl?(this.fragment.labelString=lbl,contains(["%b","%boolUE"],this.fragment.type)?this.fragment.defaultValue=this.slots.defaultSwitch.evaluate():this.fragment.defaultValue=this.slots.defaultInputField.getValue(),lbl):(this.noDelete||(this.fragment.isDeleted=!0),null)},InputSlotDialogMorph.prototype.fixLayout=function(){var maxWidth,left=this.left(),th=fontHeight(this.titleFontSize)+2*this.titlePadding;
return this.isExpanded?(this.slots.show(),maxWidth=this.slots.width(),this.body.setPosition(this.position().add(new Point(this.padding+(maxWidth-this.body.width())/2,th+this.padding))),this.label.setLeft(left+this.padding+(maxWidth-this.label.width())/2),this.label.setTop(this.top()+(th-this.label.height())/2),this.types.fixLayout(),this.types.setTop(this.body.bottom()+this.padding),this.types.setLeft(left+this.padding+(maxWidth-this.types.width())/2),this.slots.setPosition(new Point(this.left()+this.padding,this.types.bottom()+this.padding)),this.slots.children.forEach(function(c){c.refresh()}),this.buttons.fixLayout(),this.buttons.setTop(this.slots.bottom()+this.padding),
this.buttons.setLeft(left+this.padding+(maxWidth-this.buttons.width())/2),this.silentSetHeight(this.buttons.bottom()-this.top()+this.padding),void this.silentSetWidth(this.slots.right()-this.left()+this.padding)):(this.slots&&this.slots.hide(),BlockDialogMorph.prototype.fixLayout.call(this))},InputSlotDialogMorph.prototype.open=function(title,defaultString,world,pic,noDeleteButton){var txt=new InputFieldMorph(defaultString),oldFlag=Morph.prototype.trackChanges;this.fragment.type||(txt.choices=this.symbolMenu),Morph.prototype.trackChanges=!1,this.isExpanded=this.isLaunchingExpanded,txt.setWidth(250),this.labelString=title,this.createLabel(),pic&&this.setPicture(pic),
this.addBody(txt),txt.drawNew(),this.textfield=txt,this.addButton("ok","OK"),noDeleteButton?this.noDelete=!0:this.addButton("deleteFragment","Delete"),this.addButton("cancel","Cancel"),this.fixLayout(),this.drawNew(),this.fixLayout(),this.popUp(world),this.add(this.types),Morph.prototype.trackChanges=oldFlag,this.changed()},InputSlotDialogMorph.prototype.symbolMenu=function(){var symbols=[],symbolColor=new Color(100,100,130),myself=this;return SymbolMorph.prototype.names.forEach(function(symbol){symbols.push([[new SymbolMorph(symbol,myself.fontSize,symbolColor),localize(symbol)],"$"+symbol])}),symbols.push(["⏎ "+localize("new line"),"$nl"]),symbols},InputSlotDialogMorph.prototype.deleteFragment=function(){
this.fragment.isDeleted=!0,this.accept()},InputSlotDialogMorph.prototype.createSlotTypeButtons=function(){var defLabel,defInput,defSwitch,myself=this,oldFlag=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,this.addSlotTypeButton("Object","%obj"),this.addSlotTypeButton("Text","%txt"),this.addSlotTypeButton("List","%l"),this.addSlotTypeButton("Number","%n"),this.addSlotTypeButton("Any type","%s"),this.addSlotTypeButton("Boolean (T/F)","%b"),this.addSlotTypeButton("Command\n(inline)","%cmdRing"),this.addSlotTypeButton("Reporter","%repRing"),this.addSlotTypeButton("Predicate","%predRing"),this.addSlotTypeButton("Command\n(C-shape)","%cs"),this.addSlotTypeButton("Any\n(unevaluated)","%anyUE"),
this.addSlotTypeButton("Boolean\n(unevaluated)","%boolUE"),this.slots.radioButtonSingle=this.addSlotArityButton(function(){myself.setSlotArity("single")},"Single input.",function(){return myself.fragment.isSingleInput()}),this.addSlotArityButton(function(){myself.setSlotArity("multiple")},"Multiple inputs (value is list of inputs)",function(){return myself.fragment.isMultipleInput()}),this.addSlotArityButton(function(){myself.setSlotArity("upvar")},"Upvar - make internal variable visible to caller",function(){return myself.fragment.isUpvar()}),defLabel=new StringMorph(localize("Default Value:")),defLabel.fontSize=this.slots.radioButtonSingle.fontSize,defLabel.setColor(new Color(255,255,255)),
defLabel.refresh=function(){myself.isExpanded&&contains(["%s","%n","%txt","%anyUE","%b","%boolUE"],myself.fragment.type)?defLabel.show():defLabel.hide()},this.slots.defaultInputLabel=defLabel,this.slots.add(defLabel),defInput=new InputFieldMorph(this.fragment.defaultValue),defInput.contents().fontSize=defLabel.fontSize,defInput.contrast=90,defInput.contents().drawNew(),defInput.setWidth(50),defInput.refresh=function(){myself.isExpanded&&contains(["%s","%n","%txt","%anyUE"],myself.fragment.type)?(defInput.show(),"%n"===myself.fragment.type?defInput.setIsNumeric(!0):defInput.setIsNumeric(!1)):defInput.hide()},this.slots.defaultInputField=defInput,this.slots.add(defInput),
defInput.drawNew(),defSwitch=new BooleanSlotMorph(this.fragment.defaultValue),defSwitch.refresh=function(){myself.isExpanded&&contains(["%b","%boolUE"],myself.fragment.type)?defSwitch.show():defSwitch.hide()},this.slots.defaultSwitch=defSwitch,this.slots.add(defSwitch),defSwitch.drawNew(),Morph.prototype.trackChanges=oldFlag},InputSlotDialogMorph.prototype.setSlotType=function(type){this.fragment.setSingleInputType(type),this.slots.children.forEach(function(c){c.refresh()}),this.edit()},InputSlotDialogMorph.prototype.setSlotArity=function(arity){"single"===arity?this.fragment.setToSingleInput():"multiple"===arity?this.fragment.setToMultipleInput():"upvar"===arity&&this.fragment.setToUpvar(),
this.slots.children.forEach(function(c){c.refresh()}),this.edit()},InputSlotDialogMorph.prototype.addSlotTypeButton=function(label,spec){var query,button,myself=this,action=function(){myself.setSlotType(spec)},element=new JaggedBlockMorph(spec);return query=function(){return myself.fragment.singleInputType()===spec},element.setCategory(this.category),element.rebuild(),button=new ToggleMorph("radiobutton",this,action,label,query,null,null,this.cachedRadioButton,element.fullImage(),"rebuild"),button.edge=this.buttonEdge/2,button.outline=this.buttonOutline/2,button.outlineColor=this.buttonOutlineColor,button.outlineGradient=this.buttonOutlineGradient,button.drawNew(),
button.fixLayout(),button.label.isBold=!1,button.label.setColor(new Color(255,255,255)),this.cachedRadioButton||(this.cachedRadioButton=button),this.slots.add(button),button},InputSlotDialogMorph.prototype.addSlotArityButton=function(action,label,query){var button=new ToggleMorph("radiobutton",this,action,label,query,null,null,this.cachedRadioButton);return button.edge=this.buttonEdge/2,button.outline=this.buttonOutline/2,button.outlineColor=this.buttonOutlineColor,button.outlineGradient=this.buttonOutlineGradient,button.drawNew(),button.fixLayout(),button.label.setColor(new Color(255,255,255)),this.slots.add(button),this.cachedRadioButton||(this.cachedRadioButton=button),
button},InputSlotDialogMorph.prototype.fixSlotsLayout=function(){var idx,col,slots=this.slots,scale=SyntaxElementMorph.prototype.scale,xPadding=10*scale,ypadding=14*scale,bh=(fontHeight(10)/1.2+15)*scale,ah=(fontHeight(10)/1.2+10)*scale,size=12,cols=[slots.left()+xPadding,slots.left()+slots.width()/3,slots.left()+2*slots.width()/3],rows=[slots.top()+ypadding,slots.top()+ypadding+bh,slots.top()+ypadding+2*bh,slots.top()+ypadding+3*bh,slots.top()+ypadding+4*bh,slots.top()+ypadding+5*bh,slots.top()+ypadding+5*bh+ah,slots.top()+ypadding+5*bh+2*ah],row=-1,oldFlag=Morph.prototype.trackChanges;for(Morph.prototype.trackChanges=!1,idx=0;idx<size;idx+=1)col=idx%3,idx%3===0&&(row+=1),
slots.children[idx].setPosition(new Point(cols[col],rows[row]));for(col=0,row=5,idx=size;idx<size+3;idx+=1)slots.children[idx].setPosition(new Point(cols[col],rows[row+idx-size]));this.slots.defaultInputLabel.setPosition(this.slots.radioButtonSingle.label.topRight().add(new Point(5,0))),this.slots.defaultInputField.setCenter(this.slots.defaultInputLabel.center().add(new Point(this.slots.defaultInputField.width()/2+this.slots.defaultInputLabel.width()/2+5,0))),this.slots.defaultSwitch.setCenter(this.slots.defaultInputLabel.center().add(new Point(this.slots.defaultSwitch.width()/2+this.slots.defaultInputLabel.width()/2+5,0))),Morph.prototype.trackChanges=oldFlag,
this.slots.changed()},InputSlotDialogMorph.prototype.addSlotsMenu=function(){var myself=this;this.slots.userMenu=function(){if(contains(["%s","%n","%txt","%anyUE"],myself.fragment.type)){var menu=new MenuMorph(myself),on="☑ ",off="☐ ";return menu.addItem("options...","editSlotOptions"),menu.addItem((myself.fragment.isReadOnly?on:off)+localize("read-only"),function(){myself.fragment.isReadOnly=!myself.fragment.isReadOnly}),menu}return Morph.prototype.userMenu.call(myself)}},InputSlotDialogMorph.prototype.editSlotOptions=function(){var myself=this;new DialogBoxMorph(myself,function(options){myself.fragment.options=options.trim()},myself).promptCode("Input Slot Options",myself.fragment.options,myself.world(),null,localize('Enter one option per line.\nOptionally use "=" as key/value delimiter and {} for submenus. e.g.\n   the answer=42'));
};InputSlotDialogMorph.prototype.hide=function(){this.isVisible=!1,this.changed()};InputSlotDialogMorph.prototype.show=function(){this.isVisible=!0,this.changed()},VariableDialogMorph.prototype=new DialogBoxMorph,VariableDialogMorph.prototype.constructor=VariableDialogMorph,VariableDialogMorph.uber=DialogBoxMorph.prototype,VariableDialogMorph.prototype.init=function(target,action,environment){this.types=null,this.isGlobal=!0,BlockDialogMorph.uber.init.call(this,target,action,environment),this.types=new AlignmentMorph("row",this.padding),this.add(this.types),this.createTypeButtons()},VariableDialogMorph.prototype.createTypeButtons=function(){var myself=this;this.addTypeButton(function(){
myself.setType("global")},"for all sprites",function(){return myself.isGlobal}),this.addTypeButton(function(){myself.setType("local")},"for this sprite only",function(){return!myself.isGlobal})},VariableDialogMorph.prototype.addTypeButton=BlockDialogMorph.prototype.addTypeButton,VariableDialogMorph.prototype.setType=function(varType){this.isGlobal="global"===varType,this.types.children.forEach(function(c){c.refresh()}),this.edit()},VariableDialogMorph.prototype.getInput=function(){var name=this.normalizeSpaces(this.body.getValue());return name?[name,this.isGlobal]:null},VariableDialogMorph.prototype.fixLayout=function(){var th=fontHeight(this.titleFontSize)+2*this.titlePadding;
this.body&&(this.body.setPosition(this.position().add(new Point(this.padding,th+this.padding))),this.silentSetWidth(this.body.width()+2*this.padding),this.silentSetHeight(this.body.height()+2*this.padding+th)),this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(th-this.label.height())/2)),this.types&&(this.types.fixLayout(),this.silentSetHeight(this.height()+this.types.height()+this.padding),this.silentSetWidth(Math.max(this.width(),this.types.width()+2*this.padding)),this.types.setCenter(this.center()),this.body?this.types.setTop(this.body.bottom()+this.padding):this.categories&&this.types.setTop(this.categories.bottom()+this.padding)),
this.buttons&&this.buttons.children.length>0&&(this.buttons.fixLayout(),this.silentSetHeight(this.height()+this.buttons.height()+this.padding),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding))},BlockExportDialogMorph.prototype=new DialogBoxMorph,BlockExportDialogMorph.prototype.constructor=BlockExportDialogMorph,BlockExportDialogMorph.uber=DialogBoxMorph.prototype,BlockExportDialogMorph.prototype.key="blockExport",BlockExportDialogMorph.prototype.init=function(serializer,blocks){var myself=this;this.serializer=serializer,this.blocks=blocks.slice(0),this.handle=null,BlockExportDialogMorph.uber.init.call(this,null,function(){
myself.exportBlocks()},null),this.labelString="Export blocks",this.createLabel(),this.buildContents()},BlockExportDialogMorph.prototype.buildContents=function(){var palette,x,y,block,checkBox,lastCat,myself=this,padding=4;palette=new ScrollFrameMorph(null,null,SpriteMorph.prototype.sliderColor),palette.color=SpriteMorph.prototype.paletteColor,palette.padding=padding,palette.isDraggable=!1,palette.acceptsDrops=!1,palette.contents.acceptsDrops=!1,x=palette.left()+padding,y=palette.top()+padding,SpriteMorph.prototype.categories.forEach(function(category){myself.blocks.forEach(function(definition){definition.category===category&&(lastCat&&category!==lastCat&&(y+=padding),
lastCat=category,block=definition.templateInstance(),checkBox=new ToggleMorph("checkbox",myself,function(){var idx=myself.blocks.indexOf(definition);idx>-1?myself.blocks.splice(idx,1):myself.blocks.push(definition)},null,function(){return contains(myself.blocks,definition)},null,null,null,block.fullImage()),checkBox.setPosition(new Point(x,y+(checkBox.top()-checkBox.toggleElement.top()))),palette.addContents(checkBox),y+=checkBox.fullBounds().height()+padding)})}),palette.scrollX(padding),palette.scrollY(padding),this.addBody(palette),this.addButton("ok","OK"),this.addButton("cancel","Cancel"),this.setExtent(new Point(220,300)),this.fixLayout()},BlockExportDialogMorph.prototype.popUp=function(wrrld){
var world=wrrld||this.target.world();world&&(BlockExportDialogMorph.uber.popUp.call(this,world),this.handle=new HandleMorph(this,200,220,this.corner,this.corner))},BlockExportDialogMorph.prototype.userMenu=function(){var menu=new MenuMorph(this,"select");return menu.addItem("all","selectAll"),menu.addItem("none","selectNone"),menu},BlockExportDialogMorph.prototype.selectAll=function(){this.body.contents.children.forEach(function(checkBox){checkBox.state||checkBox.trigger()})},BlockExportDialogMorph.prototype.selectNone=function(){this.blocks=[],this.body.contents.children.forEach(function(checkBox){checkBox.refresh()})},BlockExportDialogMorph.prototype.exportBlocks=function(){
var str=this.serializer.serialize(this.blocks,!0),ide=this.world().children[0];this.blocks.length>0?(str='<blocks app="'+this.serializer.app+'" version="'+this.serializer.version+'">'+str+"</blocks>",ide.saveXMLAs(str,(ide.projectName||localize("untitled"))+" "+localize("blocks"))):(new DialogBoxMorph).inform("Export blocks","no blocks were selected",this.world())},BlockExportDialogMorph.prototype.fixLayout=BlockEditorMorph.prototype.fixLayout,BlockImportDialogMorph.prototype=new DialogBoxMorph,BlockImportDialogMorph.prototype.constructor=BlockImportDialogMorph,BlockImportDialogMorph.uber=DialogBoxMorph.prototype,BlockImportDialogMorph.prototype.key="blockImport",
BlockImportDialogMorph.prototype.init=function(blocks,target,name){var myself=this;this.blocks=blocks.slice(0),this.handle=null,BlockExportDialogMorph.uber.init.call(this,target,function(){myself.importBlocks(name)},null),this.labelString=localize("Import blocks")+(name?": ":"")+name||"",this.createLabel(),this.buildContents()},BlockImportDialogMorph.prototype.buildContents=BlockExportDialogMorph.prototype.buildContents,BlockImportDialogMorph.prototype.popUp=BlockExportDialogMorph.prototype.popUp,BlockImportDialogMorph.prototype.userMenu=BlockExportDialogMorph.prototype.userMenu,BlockImportDialogMorph.prototype.selectAll=BlockExportDialogMorph.prototype.selectAll,
BlockImportDialogMorph.prototype.selectNone=BlockExportDialogMorph.prototype.selectNone,BlockImportDialogMorph.prototype.importBlocks=function(name){var ide=this.target.parentThatIsA(IDE_Morph);ide&&(this.blocks.length>0?(this.blocks.forEach(function(def){def.receiver=ide.stage,ide.stage.globalBlocks.push(def),ide.stage.replaceDoubleDefinitionsFor(def)}),ide.flushPaletteCache(),ide.refreshPalette(),ide.showMessage("Imported Blocks Module"+(name?": "+name:"")+".",2)):(new DialogBoxMorph).inform("Import blocks","no blocks were selected",this.world()))},BlockImportDialogMorph.prototype.fixLayout=BlockEditorMorph.prototype.fixLayout,BlockRemovalDialogMorph.prototype=new DialogBoxMorph,
BlockRemovalDialogMorph.prototype.constructor=BlockImportDialogMorph,BlockRemovalDialogMorph.uber=DialogBoxMorph.prototype,BlockRemovalDialogMorph.prototype.key="blockRemove",BlockRemovalDialogMorph.prototype.init=function(blocks,target){var myself=this;this.blocks=blocks.slice(0),this.handle=null,BlockExportDialogMorph.uber.init.call(this,target,function(){myself.removeBlocks()},null),this.labelString=localize("Remove unused blocks")+(name?": ":"")+name||"",this.createLabel(),this.buildContents()},BlockRemovalDialogMorph.prototype.buildContents=BlockExportDialogMorph.prototype.buildContents,BlockRemovalDialogMorph.prototype.popUp=BlockExportDialogMorph.prototype.popUp,
BlockRemovalDialogMorph.prototype.userMenu=BlockExportDialogMorph.prototype.userMenu,BlockRemovalDialogMorph.prototype.selectAll=BlockExportDialogMorph.prototype.selectAll,BlockRemovalDialogMorph.prototype.selectNone=BlockExportDialogMorph.prototype.selectNone,BlockRemovalDialogMorph.prototype.removeBlocks=function(){var ide=this.target.parentThatIsA(IDE_Morph);ide&&(this.blocks.length>0?(this.blocks.forEach(function(def){var idx=ide.stage.globalBlocks.indexOf(def);idx!==-1&&ide.stage.globalBlocks.splice(idx,1)}),ide.flushPaletteCache(),ide.refreshPalette(),ide.showMessage(this.blocks.length+" "+localize("unused block(s) removed"),2)):(new DialogBoxMorph).inform("Remove unused blocks","no blocks were selected",this.world()));
},BlockRemovalDialogMorph.prototype.fixLayout=BlockEditorMorph.prototype.fixLayout,modules.tables="2017-September-01";var Table,TableCellMorph,TableMorph,TableFrameMorph;Table.prototype.demo=function(aWorld){var dlg;this.fillWithTestData(),dlg=new TableDialogMorph(this),dlg.popUp(aWorld)},Table.prototype.changed=function(){this.lastChanged=Date.now()},Table.prototype.get=function(col,row){return col?row?col>this.colCount||row>this.rowCount?null:(this.contents[row-1]||[])[col-1]:this.colName(col):row?this.rowName(row):[this.rowCount]},Table.prototype.row=function(row){return this.contents[row-1]},Table.prototype.col=function(col){var i,dta=[],c=col-1;for(i=0;i<this.rowCount;i+=1)dta.push(this.contents[i][c]);
return dta},Table.prototype.colName=function(col){if(col>this.colCount)return null;var name=this.colNames[col-1];return void 0!==name?name:String.fromCharCode(64+(col%26||26)).repeat(Math.floor((col-1)/26)+1)},Table.prototype.rowName=function(row){return row>this.rowCount?null:this.rowNames[row-1]||row},Table.prototype.rows=function(){return this.rowCount},Table.prototype.cols=function(){return this.colCount},Table.prototype.columnNames=function(){return this.colNames},Table.prototype.set=function(data,col,row){this.contents[row-1][col-1]=data,this.changed()},Table.prototype.setRows=function(rowsArray,colNames,rowNames){this.contents=rowsArray,colNames&&(this.colNames=colNames),
rowNames&&(this.rowNames=rowNames),this.changed()},Table.prototype.setCols=function(colsArray,colNames,rowNames){var r,c;for(c=0;c<this.colCount;c+=1)for(r=0;r<this.rowCount;r+=1)this.contents[r][c]=colsArray[c][r];colNames&&(this.colNames=colNames),rowNames&&(this.rowNames=rowNames),this.changed()},Table.prototype.setColNames=function(array){this.colNames=array||[],this.changed()},Table.prototype.setRowNames=function(array){this.rowNames=array||[],this.changed()},Table.prototype.setColName=function(col,name){this.colNames[col+1]=name,this.changed()},Table.prototype.setRowName=function(row,name){this.rowNames[row+1]=name,this.changed()},Table.prototype.addRow=function(array,name){
array?this.contents[this.rowCount]=array:this.contents[this.rowCount]=new Array(this.rowCount),this.rowNames[this.rowCount]=name,this.rowCount+=1,this.changed()},Table.prototype.addCol=function(array,name){var i;if(array)for(i=0;i<this.col;i+=1)this.contents[i][this.colCount]=array[i];this.colNames[this.colCount]=name,this.colCount+=1,this.changed()},Table.prototype.toList=function(){return new List(this.contents.map(function(eachRow){return new List(eachRow)}))},Table.prototype.fillWithTestData=function(){var c,r;for(c=1;c<=this.colCount;c+=1)for(r=1;r<=this.rowCount;r+=1)this.set(this.colName(c)+this.rowName(r),c,r)},TableCellMorph.prototype=new Morph,TableCellMorph.prototype.constructor=TableCellMorph,
TableCellMorph.uber=Morph.prototype,TableCellMorph.prototype.listSymbol=ArgMorph.prototype.listIcon(),TableCellMorph.prototype.init=function(data,extent,isLabel){this.data=data,this.isLabel=isLabel||!1,TableCellMorph.uber.init.call(this,!0),this.noticesTransparentClick=!0,extent&&this.silentSetExtent(extent),this.drawNew()},TableCellMorph.prototype.setData=function(data,extent){this.data=data,extent&&!extent.eq(this.extent())?(this.silentSetExtent(extent),this.drawNew()):this.drawData()},TableCellMorph.prototype.getData=function(){return this.data instanceof Array?this.data[0]:this.data},TableCellMorph.prototype.drawNew=function(){this.image=newCanvas(this.extent()),
this.drawData()},TableCellMorph.prototype.drawData=function(lbl,bg){var txtWidth,txtHeight,x,y,dta=lbl||this.dataRepresentation(this.data),context=this.image.getContext("2d"),fontSize=SyntaxElementMorph.prototype.fontSize,empty=TableMorph.prototype.highContrast?"rgb(220, 220, 220)":"transparent",orphaned="rgb(217, 77, 17)",fontStyle=this.isLabel?this.data instanceof Array?"italic":"":this.shouldBeList()?"bold":"",font=fontStyle+" "+fontSize+"px Helvetica, Arial, sans-serif",background=bg||(this.isLabel?empty:this.shouldBeList()?orphaned:this.isOvershooting()?"white":isNil(this.data)?empty:"white"),foreground=!this.isLabel&&this.shouldBeList()?"white":"black",width=this.width(),height=this.height();
context.clearRect(0,0,width,height),context.fillStyle=background,this.shouldBeList()?(BoxMorph.prototype.outlinePath.call(this,context,SyntaxElementMorph.prototype.corner+1,0),context.fill()):this.isOvershooting()?(this.raggedBoxPath(context),context.fill()):context.fillRect(0,0,width,height),dta&&(dta instanceof HTMLCanvasElement?(x=Math.max((width-dta.width)/2,0),y=Math.max((height-dta.height)/2,0),context.shadowOffsetX=4,context.shadowOffsetY=4,context.shadowBlur=4,context.shadowColor="lightgray",context.drawImage(dta,x,y)):(context.font=font,context.textAlign="left",context.textBaseline="bottom",txtWidth=context.measureText(dta).width,txtHeight=fontHeight(fontSize),
context.fillStyle=foreground,x=Math.max((width-txtWidth)/2,0),y=Math.max((height-txtHeight)/2,0),context.fillText(dta,x,txtHeight+y)))},TableCellMorph.prototype.dataRepresentation=function(dta){return dta instanceof Morph?isSnapObject(dta)?dta.thumbnail(new Point(40,40)):dta.fullImageClassic():isString(dta)?dta.length>100?dta.slice(0,100)+"...":dta:"number"==typeof dta?dta.toString():"boolean"==typeof dta?SpriteMorph.prototype.booleanMorph.call(null,dta).fullImage():dta instanceof Array?this.dataRepresentation(dta[0]):dta instanceof Variable?this.dataRepresentation(dta.value):dta instanceof HTMLCanvasElement?dta:dta instanceof Context?dta.image():dta instanceof Costume?dta.thumbnail(new Point(40,40)):dta instanceof Sound?new SymbolMorph("notes",30).image:dta instanceof List?this.listSymbol:dta?dta.toString():0===dta?"0":null;
},TableCellMorph.prototype.raggedBoxPath=function(context){var width=this.width(),height=this.height(),x=.75*width,step=height/6,y=0;for(context.beginPath(),context.moveTo(0,0),context.lineTo(width,0),y=0;y<height;y+=2*step)context.lineTo(x,y+step),context.lineTo(width,y+2*step);context.lineTo(width,height),context.lineTo(0,height),context.closePath()},TableCellMorph.prototype.shouldBeList=function(){return this.data instanceof Array},TableCellMorph.prototype.isOvershooting=function(){return this.data instanceof Variable},TableCellMorph.prototype.mouseDoubleClick=function(pos){this.data instanceof Table||this.data instanceof List?new TableDialogMorph(this.data).popUp(this.world()):this.data instanceof Array&&this.data[0]instanceof List?new TableDialogMorph(this.data[0]).popUp(this.world()):this.escalateEvent("mouseDoubleClick",pos);
},TableCellMorph.prototype.mouseEnter=function(){var tm,x,c;this.isLabel&&(tm=this.parentThatIsA(TableMorph),x=tm.world().hand.left()-tm.left(),c=tm.columnAt(x),c>0&&(this.drawData(c,"rgb(220, 220, 250)"),this.changed()))},TableCellMorph.prototype.mouseLeave=function(){this.isLabel&&(this.drawData(),this.changed())},TableMorph.prototype=new FrameMorph,TableMorph.prototype.constructor=TableMorph,TableMorph.uber=FrameMorph.prototype,TableMorph.prototype.highContrast=!1,TableMorph.prototype.init=function(table,scrollBarSize,extent,startRow,startCol,globalColWidth,colWidths,rowHeight,colLabelHeight,padding){this.table=table,this.scrollBarSize=scrollBarSize||MorphicPreferences.scrollBarSize,
this.startRow=startRow||1,this.startCol=startCol||1,this.textHeight=Math.ceil(1.3*fontHeight(SyntaxElementMorph.prototype.fontSize)),this.rowHeight=rowHeight||this.textHeight,this.colWidths=colWidths||[],this.globalColWidth=globalColWidth||Math.ceil(3.5*this.textHeight),this.colLabelHeight=colLabelHeight||this.textHeight,this.padding=padding||SyntaxElementMorph.prototype.scale,this.tableVersion=this.table.lastChanged,this.hBar=null,this.vBar=null,this.rowLabelWidth=0,this.columns=[],this.rows=0,this.maxStartRow=null,this.maxStartCol=null,this.dragAnchor=null,this.resizeAnchor=null,this.resizeCol=null,this.resizeRow=null,this.wantsUpdate=!1,Morph.prototype.init.call(this,!0),
extent&&this.silentSetExtent(extent),this.initScrollBars(),this.drawNew()},TableMorph.prototype.initScrollBars=function(){var myself=this;this.hBar=new SliderMorph(1,null,null,null,"horizontal"),this.hBar.setHeight(this.scrollBarSize),this.hBar.action=function(num){myself.showData(num,null,!0)},this.hBar.isDraggable=!1,this.add(this.hBar),this.vBar=new SliderMorph(1,null,null,null,"vertical"),this.vBar.setWidth(this.scrollBarSize),this.vBar.action=function(num){myself.showData(null,num,!0)},this.vBar.isDraggable=!1,this.add(this.vBar)},TableMorph.prototype.updateScrollBars=function(){1===this.maxStartCol?this.hBar.hide():(this.hBar.show(),this.hBar.stop=this.maxStartCol,
this.hBar.value=this.startCol,this.hBar.size=Math.max(this.hBar.rangeSize()*this.columns.length/this.table.cols(),this.hBar.rangeSize()/10),this.hBar.drawNew()),this.vBar.stop=this.maxStartRow,this.vBar.value=this.startRow,1===this.maxStartRow?this.vBar.hide():(this.vBar.show(),this.vBar.size=Math.max(this.vBar.rangeSize()*this.rows/this.table.rows(),this.vBar.rangeSize()/10),this.vBar.drawNew())},TableMorph.prototype.drawNew=function(){var context,w,i;if(this.image=newCanvas(this.extent()),context=this.image.getContext("2d"),context.fillStyle="rgb(220, 220, 220)",BoxMorph.prototype.outlinePath.call(this,context,SyntaxElementMorph.prototype.corner+1,0),context.fill(),
this.rowLabelWidth=this.rowLabelsWidth(),this.columns=this.columnsLayout(),this.rows=this.visibleRows(),this.highContrast&&this.table.cols()>1){for(w=this.padding,i=this.startCol;i<=this.table.cols();i+=1)w+=this.colWidth(i)+this.padding;context.fillStyle="darkGray",context.fillRect(this.padding+this.rowLabelWidth,this.padding+this.colLabelHeight,w,(this.rowHeight+this.padding)*(this.table.rows()+1-this.startRow)+this.padding)}this.buildCells(),this.hBar.setWidth(this.width()-this.vBar.width()),this.hBar.setLeft(this.left()),this.hBar.setBottom(this.bottom()),this.vBar.setHeight(this.height()-this.hBar.height()),this.vBar.setRight(this.right()),this.vBar.setTop(this.top());
},TableMorph.prototype.buildCells=function(){var cell,r,c,pos=this.position();for(this.children=[],c=0;c<=this.columns.length;c+=1)for(r=0;r<=this.rows;r+=1)cell=new TableCellMorph(this.table.get(c?c+this.startCol-1:c,r?r+this.startRow-1:r),new Point(c?this.colWidth(c+this.startCol-1):this.rowLabelWidth,r?this.rowHeight:this.colLabelHeight),!(r&&c),!1),cell.setPosition(new Point(c?this.columns[c-1]:this.padding,r?2*this.padding+this.colLabelHeight+(r-1)*(this.rowHeight+this.padding):this.padding).add(pos)),this.add(cell),isSnapObject(cell.getData())&&(this.wantsUpdate=!0);this.add(this.hBar),this.add(this.vBar),this.updateScrollBars(),this.changed()},TableMorph.prototype.drawData=function(noScrollUpdate){
var cell,r,c,cellIdx=0;for(c=0;c<=this.columns.length;c+=1)for(r=0;r<=this.rows;r+=1)cell=this.children[cellIdx],cellIdx+=1,cell.setData(this.table.get(c?c+this.startCol-1:c,r?r+this.startRow-1:r)),isSnapObject(cell.getData())&&(this.wantsUpdate=!0);noScrollUpdate||this.updateScrollBars(),this.changed()},TableMorph.prototype.scroll=function(xSteps,ySteps){this.showData(Math.min(this.maxStartCol,Math.max(1,this.startCol+Math.round(xSteps))),Math.min(this.maxStartRow,Math.max(1,this.startRow+Math.round(ySteps)))),this.updateScrollBars()},TableMorph.prototype.showData=function(startCol,startRow,noScrollUpdate){var c=startCol||this.startCol,r=startRow||this.startRow;
if(c===this.startCol){if(r===this.startRow)return;this.startRow=r,this.rows=this.visibleRows(),this.drawData(noScrollUpdate)}else this.startCol=c,this.startRow=r,this.rows=this.visibleRows(),this.colWidths.length?(this.columns=this.columnsLayout(),this.buildCells()):this.drawData(noScrollUpdate)},TableMorph.prototype.step=function(){this.dragAnchor?this.shiftCells(this.world().hand.position()):this.resizeAnchor&&this.resizeCells(this.world().hand.position()),this.update()},TableMorph.prototype.update=function(){var oldCols,oldRows,version=this.table instanceof List?this.table.version(this.startRow,this.rows):this.table.lastChanged;(this.tableVersion!==version||this.wantsUpdate)&&(this.wantsUpdate=!1,
this.table instanceof List?(oldCols=this.columns.length,oldRows=this.rows,this.rowLabelWidth=this.rowLabelsWidth(),this.columns=this.columnsLayout(),this.rows=this.visibleRows(),this.columns.length!==oldCols||this.rows!==oldRows?this.buildCells():this.drawData()):this.drawData(),this.tableVersion=version)},TableMorph.prototype.rowLabelsWidth=function(){var ctx=newCanvas().getContext("2d");return ctx.font="italic "+SyntaxElementMorph.prototype.fontSize+"px Helvetica, Arial, sans-serif",Math.max(0,Math.max.apply(null,this.table.columnNames().map(function(name){return name?ctx.measureText(name).width:0})))||ctx.measureText(this.table.rows().toString()).width+6*SyntaxElementMorph.prototype.scale;
},TableMorph.prototype.columnsLayout=function(){var colNum,w,c=[],x=2*this.padding+this.rowLabelWidth;for(colNum=this.table.cols(),w=x;w<this.width()&&colNum>0;)w+=this.colWidth(colNum),colNum-=1;for(0===colNum&&w<this.width()?this.maxStartCol=1:this.maxStartCol=Math.min(colNum+2,this.table.cols()),this.startCol=Math.min(this.startCol,this.maxStartCol),colNum=this.startCol;x<this.width()&&colNum<this.table.cols()+this.startCol;)w=this.colWidth(colNum),c.push(x),x+=w,x+=this.padding,colNum+=1;return c},TableMorph.prototype.colWidth=function(col){return this.colWidths[col-1]||this.globalColWidth},TableMorph.prototype.visibleRows=function(){var possible,rest=this.height()-this.colLabelHeight-this.padding;
return rest<0?0:(possible=Math.ceil(rest/(this.rowHeight+this.padding)),this.maxStartRow=Math.max(1,this.table.rows()-possible+2),this.startRow=Math.min(this.startRow,this.maxStartRow),Math.min(this.table.rows(),possible))},TableMorph.prototype.globalExtent=function(){var i,w=this.rowLabelsWidth()+2,cols=this.table.cols();for(i=0;i<cols;i+=1)w+=this.colWidth(i+1),w+=this.padding;return 1===cols&&(w+=this.scrollBarSize,w+=2*this.padding),new Point(w+this.padding,this.colLabelHeight+2*this.padding+(this.rowHeight+this.padding)*this.table.rows())},TableMorph.prototype.mouseScroll=function(y,x){this.scroll(-(+x*MorphicPreferences.mouseScrollAmount/4),-(+y*MorphicPreferences.mouseScrollAmount));
},TableMorph.prototype.mouseDownLeft=function(pos){var rel=pos.subtract(this.position());rel.x<=this.rowLabelWidth||rel.y<=this.colLabelHeight?(16===this.world().currentKey?this.resizeCol=0:this.resizeCol=this.columnAt(rel.x),this.resizeRow=rel.y>this.colLabelHeight,this.resizeAnchor=pos):(this.resizeRow=null,this.dragAnchor=pos)},TableMorph.prototype.mouseClickLeft=function(pos){this.dragAnchor=null,this.resizeAnchor=null,this.resizeRow=null},TableMorph.prototype.mouseLeaveDragging=function(pos){this.dragAnchor=null,this.resizeAnchor=null,this.resizeRow=null},TableMorph.prototype.mouseDoubleClick=function(pos){this.parentThatIsA(TableDialogMorph)?this.escalateEvent("mouseDoubleClick",pos):new TableDialogMorph(this.table,this.globalColWidth,this.colWidths,this.rowHeight).popUp(this.world());
},TableMorph.prototype.shiftCells=function(pos){var delta=this.dragAnchor.subtract(pos),scrollX=Math.round(delta.x/this.globalColWidth),scrollY=Math.round(delta.y/this.rowHeight);(scrollX||scrollY)&&(this.scroll(scrollX,scrollY),this.dragAnchor=pos)},TableMorph.prototype.resizeCells=function(pos){var i,delta=pos.subtract(this.resizeAnchor);if(this.resizeCol)this.colWidths[this.resizeCol-1]=Math.max(16,(this.colWidths[this.resizeCol-1]||this.globalColWidth)+delta.x);else if(this.resizeRow)this.rowHeight=Math.max(16,this.rowHeight+delta.y);else for(this.globalColWidth=Math.max(16,this.globalColWidth+delta.x),i=0;i<this.colWidths.length;i+=1)this.colWidths[i]&&(this.colWidths[i]=Math.max(16,this.colWidths[i]+delta.x));
this.highContrast?this.drawNew():(this.rowLabelWidth=this.rowLabelsWidth(),this.columns=this.columnsLayout(),this.rows=this.visibleRows(),this.buildCells()),this.resizeAnchor=pos},TableMorph.prototype.columnAt=function(relativeX){var c=0;if(relativeX<this.columns[0])return 0;for(;relativeX>this.columns[c];)c+=1;return c+this.startCol-1},TableMorph.prototype.userMenu=function(){var menu=new MenuMorph(this);return this.parentThatIsA(TableDialogMorph)?(this.colWidths.length&&(menu.addItem("reset columns","resetColumns"),menu.addLine()),menu.addItem("open in another dialog...","openInDialog"),menu):(this.colWidths.length&&menu.addItem("reset columns","resetColumns"),
menu.addItem("list view...","showListView"),menu.addLine(),menu.addItem("open in dialog...","openInDialog"),menu)},TableMorph.prototype.resetColumns=function(){this.colWidths=[],this.highContrast?this.drawNew():(this.rowLabelWidth=this.rowLabelsWidth(),this.columns=this.columnsLayout(),this.rows=this.visibleRows(),this.buildCells())},TableMorph.prototype.openInDialog=function(){new TableDialogMorph(this.table,this.globalColWidth,this.colWidths,this.rowHeight).popUp(this.world())},TableMorph.prototype.showListView=function(){var view=this.parentThatIsAnyOf([SpriteBubbleMorph,SpeechBubbleMorph,CellMorph]);view&&(view instanceof SpriteBubbleMorph?(view.changed(),
view.drawNew(!0)):view instanceof SpeechBubbleMorph?(view.contents=new ListWatcherMorph(this.table),view.contents.step=view.contents.update,view.contents.expand(this.extent()),view.drawNew(!0)):(view.drawNew(!0),view.contentsMorph.expand(this.extent())),view.fixLayout())},TableMorph.prototype.show=function(){TableMorph.uber.show.call(this),this.updateScrollBars()},TableFrameMorph.prototype=new Morph,TableFrameMorph.prototype.constructor=TableFrameMorph,TableFrameMorph.uber=Morph.prototype,TableFrameMorph.prototype.init=function(tableMorph,noResize){this.tableMorph=tableMorph,this.handle=null,TableFrameMorph.uber.init.call(this,!0),this.color="transparent",this.noticesTransparentClick=!1,
this.bounds=this.tableMorph.bounds.copy(),this.add(this.tableMorph),noResize||(this.handle=new HandleMorph(this,80,25,null,null)),this.drawNew()},TableFrameMorph.prototype.fixLayout=function(){var ext=this.extent();this.tableMorph.extent().eq(ext)||(this.tableMorph.setExtent(this.extent()),this.parent&&this.parent.fixLayout&&this.parent.fixLayout())},TableFrameMorph.prototype.setExtent=function(aPoint,silently){TableFrameMorph.uber.setExtent.call(this,aPoint,silently),this.fixLayout()},TableFrameMorph.prototype.expand=function(maxExtent){var ext=this.tableMorph.globalExtent();maxExtent&&(ext=ext.min(maxExtent)),this.setExtent(ext),this.handle.setRight(this.right()),
this.handle.setBottom(this.bottom())},TableDialogMorph.prototype=new DialogBoxMorph,TableDialogMorph.prototype.constructor=TableDialogMorph,TableDialogMorph.uber=DialogBoxMorph.prototype,TableDialogMorph.prototype.init=function(data,globalColWidth,colWidths,rowHeight){this.handle=null,this.data=data,this.tableView=null,TableDialogMorph.uber.init.call(this),this.labelString="Table view",this.createLabel(),this.buildContents(data,globalColWidth,colWidths,rowHeight)},TableDialogMorph.prototype.buildContents=function(data,globalColWidth,colWidths,rowHeight){this.tableView=new TableMorph(data,null,null,null,null,globalColWidth,colWidths,rowHeight,null,null),this.addBody(new TableFrameMorph(this.tableView,!0)),
this.addButton("ok","OK")},TableDialogMorph.prototype.setInitialDimensions=function(){var world=this.world(),mex=world.extent().subtract(new Point(this.padding,this.padding)),th=fontHeight(this.titleFontSize)+3*this.titlePadding,bh=this.buttons.height();this.setExtent(this.tableView.globalExtent().add(new Point(2*this.padding,2*this.padding+th+bh)).min(mex).max(new Point(100,100))),this.setCenter(this.world().center())},TableDialogMorph.prototype.popUp=function(world){world&&(TableDialogMorph.uber.popUp.call(this,world),this.setInitialDimensions(),this.handle=new HandleMorph(this,100,100,this.corner,this.corner))},TableDialogMorph.prototype.fixLayout=BlockEditorMorph.prototype.fixLayout,
modules.symbols="2017-September-26";var SymbolMorph;SymbolMorph.prototype=new Morph,SymbolMorph.prototype.constructor=SymbolMorph,SymbolMorph.uber=Morph.prototype,SymbolMorph.prototype.names=["square","pointRight","stepForward","gears","file","fullScreen","normalScreen","smallStage","normalStage","turtle","stage","turtleOutline","pause","flag","octagon","cloud","cloudOutline","cloudGradient","turnRight","turnLeft","storage","poster","flash","brush","rectangle","rectangleSolid","circle","circleSolid","line","cross","crosshairs","paintbucket","eraser","pipette","speechBubble","speechBubbleOutline","turnBack","turnForward","arrowUp","arrowUpOutline","arrowLeft","arrowLeftOutline","arrowDown","arrowDownOutline","arrowRight","arrowRightOutline","robot","magnifyingGlass","magnifierOutline","notes","camera","location","footprints","keyboard","keyboardFilled"],
SymbolMorph.prototype.init=function(name,size,color,shadowOffset,shadowColor){this.isProtectedLabel=!1,this.isReadOnly=!0,this.name=name||"square",this.size=size||(0===size?0:50),this.shadowOffset=shadowOffset||new Point(0,0),this.shadowColor=shadowColor||null,SymbolMorph.uber.init.call(this,!0),this.color=color||new Color(0,0,0),this.drawNew()},SymbolMorph.prototype.setLabelColor=function(textColor,shadowColor,shadowOffset){this.shadowOffset=shadowOffset||new Point,this.shadowColor=shadowColor,this.setColor(textColor)},SymbolMorph.prototype.drawNew=function(){var ctx,x,y,sx,sy;this.image=newCanvas(new Point(this.symbolWidth()+Math.abs(this.shadowOffset.x),this.size+Math.abs(this.shadowOffset.y))),
this.silentSetWidth(this.image.width),this.silentSetHeight(this.image.height),ctx=this.image.getContext("2d"),sx=this.shadowOffset.x<0?0:this.shadowOffset.x,sy=this.shadowOffset.y<0?0:this.shadowOffset.y,x=this.shadowOffset.x<0?Math.abs(this.shadowOffset.x):0,y=this.shadowOffset.y<0?Math.abs(this.shadowOffset.y):0,this.shadowColor&&ctx.drawImage(this.symbolCanvasColored(this.shadowColor),sx,sy),ctx.drawImage(this.symbolCanvasColored(this.color),x,y)},SymbolMorph.prototype.symbolCanvasColored=function(aColor){if(this.name instanceof Costume)return this.name.thumbnail(new Point(this.symbolWidth(),this.size));var canvas=newCanvas(new Point(this.symbolWidth(),this.size));
switch(this.name){case"square":return this.drawSymbolStop(canvas,aColor);case"pointRight":return this.drawSymbolPointRight(canvas,aColor);case"stepForward":return this.drawSymbolStepForward(canvas,aColor);case"gears":return this.drawSymbolGears(canvas,aColor);case"file":return this.drawSymbolFile(canvas,aColor);case"fullScreen":return this.drawSymbolFullScreen(canvas,aColor);case"normalScreen":return this.drawSymbolNormalScreen(canvas,aColor);case"smallStage":return this.drawSymbolSmallStage(canvas,aColor);case"normalStage":return this.drawSymbolNormalStage(canvas,aColor);case"turtle":return this.drawSymbolTurtle(canvas,aColor);case"stage":return this.drawSymbolStop(canvas,aColor);
case"turtleOutline":return this.drawSymbolTurtleOutline(canvas,aColor);case"pause":return this.drawSymbolPause(canvas,aColor);case"flag":return this.drawSymbolFlag(canvas,aColor);case"octagon":return this.drawSymbolOctagon(canvas,aColor);case"cloud":return this.drawSymbolCloud(canvas,aColor);case"cloudOutline":return this.drawSymbolCloudOutline(canvas,aColor);case"cloudGradient":return this.drawSymbolCloudGradient(canvas,aColor);case"turnRight":return this.drawSymbolTurnRight(canvas,aColor);case"turnLeft":return this.drawSymbolTurnLeft(canvas,aColor);case"storage":return this.drawSymbolStorage(canvas,aColor);case"poster":return this.drawSymbolPoster(canvas,aColor);
case"flash":return this.drawSymbolFlash(canvas,aColor);case"brush":return this.drawSymbolBrush(canvas,aColor);case"rectangle":return this.drawSymbolRectangle(canvas,aColor);case"rectangleSolid":return this.drawSymbolRectangleSolid(canvas,aColor);case"circle":return this.drawSymbolCircle(canvas,aColor);case"circleSolid":return this.drawSymbolCircleSolid(canvas,aColor);case"line":return this.drawSymbolLine(canvas,aColor);case"cross":return this.drawSymbolCross(canvas,aColor);case"crosshairs":return this.drawSymbolCrosshairs(canvas,aColor);case"paintbucket":return this.drawSymbolPaintbucket(canvas,aColor);case"eraser":return this.drawSymbolEraser(canvas,aColor);case"pipette":
return this.drawSymbolPipette(canvas,aColor);case"speechBubble":return this.drawSymbolSpeechBubble(canvas,aColor);case"speechBubbleOutline":return this.drawSymbolSpeechBubbleOutline(canvas,aColor);case"turnBack":return this.drawSymbolTurnBack(canvas,aColor);case"turnForward":return this.drawSymbolTurnForward(canvas,aColor);case"arrowUp":return this.drawSymbolArrowUp(canvas,aColor);case"arrowUpOutline":return this.drawSymbolArrowUpOutline(canvas,aColor);case"arrowLeft":return this.drawSymbolArrowLeft(canvas,aColor);case"arrowLeftOutline":return this.drawSymbolArrowLeftOutline(canvas,aColor);case"arrowDown":return this.drawSymbolArrowDown(canvas,aColor);case"arrowDownOutline":
return this.drawSymbolArrowDownOutline(canvas,aColor);case"arrowRight":return this.drawSymbolArrowRight(canvas,aColor);case"arrowRightOutline":return this.drawSymbolArrowRightOutline(canvas,aColor);case"robot":return this.drawSymbolRobot(canvas,aColor);case"magnifyingGlass":return this.drawSymbolMagnifyingGlass(canvas,aColor);case"magnifierOutline":return this.drawSymbolMagnifierOutline(canvas,aColor);case"notes":return this.drawSymbolNotes(canvas,aColor);case"camera":return this.drawSymbolCamera(canvas,aColor);case"location":return this.drawSymbolLocation(canvas,aColor);case"footprints":return this.drawSymbolFootprints(canvas,aColor);case"keyboard":return this.drawSymbolKeyboard(canvas,aColor);
case"keyboardFilled":return this.drawSymbolKeyboardFilled(canvas,aColor);default:return canvas}},SymbolMorph.prototype.symbolWidth=function(){var size=this.size;if(this.name instanceof Costume)return size/this.name.height()*this.name.width();switch(this.name){case"pointRight":return Math.sqrt(size*size-Math.pow(size/2,2));case"location":return.6*size;case"flash":case"file":return.8*size;case"smallStage":case"normalStage":return 1.2*size;case"turtle":case"turtleOutline":case"stage":return 1.3*size;case"cloud":case"cloudGradient":case"cloudOutline":case"turnBack":case"turnForward":case"keyboard":case"keyboardFilled":return 1.6*size;case"turnRight":case"turnLeft":
return size/3*2;default:return size}},SymbolMorph.prototype.drawSymbolStop=function(canvas,color){var ctx=canvas.getContext("2d");return ctx.fillStyle=color.toString(),ctx.fillRect(0,0,canvas.width,canvas.height),canvas},SymbolMorph.prototype.drawSymbolPointRight=function(canvas,color){var ctx=canvas.getContext("2d");return ctx.fillStyle=color.toString(),ctx.beginPath(),ctx.moveTo(0,0),ctx.lineTo(canvas.width,Math.round(canvas.height/2)),ctx.lineTo(0,canvas.height),ctx.lineTo(0,0),ctx.closePath(),ctx.fill(),canvas},SymbolMorph.prototype.drawSymbolStepForward=function(canvas,color){var ctx=canvas.getContext("2d");return ctx.fillStyle=color.toString(),ctx.beginPath(),
ctx.moveTo(0,0),ctx.lineTo(.75*canvas.width,Math.round(canvas.height/2)),ctx.lineTo(0,canvas.height),ctx.lineTo(0,0),ctx.closePath(),ctx.fill(),ctx.fillRect(.75*canvas.width,0,.25*canvas.width,canvas.height),canvas},SymbolMorph.prototype.drawSymbolGears=function(canvas,color){var ctx=canvas.getContext("2d"),w=canvas.width,r=w/2,e=w/6;return ctx.strokeStyle=color.toString(),ctx.lineWidth=canvas.width/7,ctx.beginPath(),ctx.arc(r,r,w,radians(0),radians(360),!0),ctx.arc(r,r,1.5*e,radians(0),radians(360),!1),ctx.closePath(),ctx.clip(),ctx.moveTo(0,r),ctx.lineTo(w,r),ctx.stroke(),ctx.moveTo(r,0),ctx.lineTo(r,w),ctx.stroke(),ctx.moveTo(e,e),ctx.lineTo(w-e,w-e),ctx.stroke(),
ctx.moveTo(w-e,e),ctx.lineTo(e,w-e),ctx.stroke(),canvas},SymbolMorph.prototype.drawSymbolFile=function(canvas,color){var ctx=canvas.getContext("2d"),w=Math.min(canvas.width,canvas.height)/2;return ctx.fillStyle=color.toString(),ctx.beginPath(),ctx.moveTo(0,0),ctx.lineTo(w,0),ctx.lineTo(w,w),ctx.lineTo(canvas.width,w),ctx.lineTo(canvas.width,canvas.height),ctx.lineTo(0,canvas.height),ctx.closePath(),ctx.fill(),ctx.fillStyle=color.darker(25).toString(),ctx.beginPath(),ctx.moveTo(w,0),ctx.lineTo(canvas.width,w),ctx.lineTo(w,w),ctx.lineTo(w,0),ctx.closePath(),ctx.fill(),canvas},SymbolMorph.prototype.drawSymbolFullScreen=function(canvas,color){var ctx=canvas.getContext("2d"),h=canvas.height,c=canvas.width/2,off=canvas.width/20,w=canvas.width/2;
return ctx.strokeStyle=color.toString(),ctx.lineWidth=canvas.width/5,ctx.moveTo(c-off,c+off),ctx.lineTo(0,h),ctx.stroke(),ctx.strokeStyle=color.toString(),ctx.lineWidth=canvas.width/5,ctx.moveTo(c+off,c-off),ctx.lineTo(h,0),ctx.stroke(),ctx.fillStyle=color.toString(),ctx.beginPath(),ctx.moveTo(0,h),ctx.lineTo(0,h-w),ctx.lineTo(w,h),ctx.closePath(),ctx.fill(),ctx.fillStyle=color.toString(),ctx.beginPath(),ctx.moveTo(h,0),ctx.lineTo(h-w,0),ctx.lineTo(h,w),ctx.closePath(),ctx.fill(),canvas},SymbolMorph.prototype.drawSymbolNormalScreen=function(canvas,color){var ctx=canvas.getContext("2d"),h=canvas.height,c=canvas.width/2,off=canvas.width/20,w=canvas.width;return ctx.strokeStyle=color.toString(),
ctx.lineWidth=canvas.width/5,ctx.moveTo(c-3*off,c+3*off),ctx.lineTo(0,h),ctx.stroke(),ctx.strokeStyle=color.toString(),ctx.lineWidth=canvas.width/5,ctx.moveTo(c+3*off,c-3*off),ctx.lineTo(h,0),ctx.stroke(),ctx.fillStyle=color.toString(),ctx.beginPath(),ctx.moveTo(c+off,c-off),ctx.lineTo(w,c-off),ctx.lineTo(c+off,0),ctx.closePath(),ctx.fill(),ctx.fillStyle=color.toString(),ctx.beginPath(),ctx.moveTo(c-off,c+off),ctx.lineTo(0,c+off),ctx.lineTo(c-off,w),ctx.closePath(),ctx.fill(),canvas},SymbolMorph.prototype.drawSymbolSmallStage=function(canvas,color){var ctx=canvas.getContext("2d"),w=canvas.width,h=canvas.height,w2=w/2,h2=h/2;return ctx.fillStyle=color.darker(40).toString(),
ctx.fillRect(0,0,w,h),ctx.fillStyle=color.toString(),ctx.fillRect(w2,0,w2,h2),canvas},SymbolMorph.prototype.drawSymbolNormalStage=function(canvas,color){var ctx=canvas.getContext("2d"),w=canvas.width,h=canvas.height,w2=w/2,h2=h/2;return ctx.fillStyle=color.toString(),ctx.fillRect(0,0,w,h),ctx.fillStyle=color.darker(25).toString(),ctx.fillRect(w2,0,w2,h2),canvas},SymbolMorph.prototype.drawSymbolTurtle=function(canvas,color){var ctx=canvas.getContext("2d");return ctx.fillStyle=color.toString(),ctx.beginPath(),ctx.moveTo(0,0),ctx.lineTo(canvas.width,canvas.height/2),ctx.lineTo(0,canvas.height),ctx.lineTo(canvas.height/2,canvas.height/2),ctx.closePath(),ctx.fill(),
canvas},SymbolMorph.prototype.drawSymbolTurtleOutline=function(canvas,color){var ctx=canvas.getContext("2d");return ctx.strokeStyle=color.toString(),ctx.beginPath(),ctx.moveTo(0,0),ctx.lineTo(canvas.width,canvas.height/2),ctx.lineTo(0,canvas.height),ctx.lineTo(canvas.height/2,canvas.height/2),ctx.closePath(),ctx.stroke(),canvas},SymbolMorph.prototype.drawSymbolPause=function(canvas,color){var ctx=canvas.getContext("2d"),w=canvas.width/5;return ctx.fillStyle=color.toString(),ctx.fillRect(0,0,2*w,canvas.height),ctx.fillRect(3*w,0,2*w,canvas.height),canvas},SymbolMorph.prototype.drawSymbolFlag=function(canvas,color){var ctx=canvas.getContext("2d"),w=canvas.width,l=Math.max(w/12,1),h=canvas.height;
return ctx.lineWidth=l,ctx.strokeStyle=color.toString(),ctx.beginPath(),ctx.moveTo(l/2,0),ctx.lineTo(l/2,canvas.height),ctx.stroke(),ctx.lineWidth=h/2,ctx.beginPath(),ctx.moveTo(0,h/4),ctx.bezierCurveTo(.8*w,h/4,.1*w,.5*h,w,.5*h),ctx.stroke(),canvas},SymbolMorph.prototype.drawSymbolOctagon=function(canvas,color){var ctx=canvas.getContext("2d"),side=canvas.width,vert=(side-.383*side)/2;return ctx.fillStyle=color.toString(),ctx.beginPath(),ctx.moveTo(vert,0),ctx.lineTo(side-vert,0),ctx.lineTo(side,vert),ctx.lineTo(side,side-vert),ctx.lineTo(side-vert,side),ctx.lineTo(vert,side),ctx.lineTo(0,side-vert),ctx.lineTo(0,vert),ctx.closePath(),ctx.fill(),canvas},SymbolMorph.prototype.drawSymbolCloud=function(canvas,color){
var ctx=canvas.getContext("2d"),w=canvas.width,h=canvas.height,r1=2*h/5,r2=h/4,r3=3*h/10,r4=h/5;return ctx.fillStyle=color.toString(),ctx.beginPath(),ctx.arc(r2,h-r2,r2,radians(90),radians(259),!1),ctx.arc(w/20*5,h/9*4,r4,radians(165),radians(300),!1),ctx.arc(w/20*11,r1,r1,radians(200),radians(357),!1),ctx.arc(w-r3,h-r3,r3,radians(269),radians(90),!1),ctx.closePath(),ctx.fill(),canvas},SymbolMorph.prototype.drawSymbolCloudGradient=function(canvas,color){var gradient,ctx=canvas.getContext("2d"),w=canvas.width,h=canvas.height,r1=2*h/5,r2=h/4,r3=3*h/10,r4=h/5;return gradient=ctx.createRadialGradient(0,0,0,0,0,w),gradient.addColorStop(0,color.lighter(25).toString()),
gradient.addColorStop(1,color.darker(25).toString()),ctx.fillStyle=gradient,ctx.beginPath(),ctx.arc(r2,h-r2,r2,radians(90),radians(259),!1),ctx.arc(w/20*5,h/9*4,r4,radians(165),radians(300),!1),ctx.arc(w/20*11,r1,r1,radians(200),radians(357),!1),ctx.arc(w-r3,h-r3,r3,radians(269),radians(90),!1),ctx.closePath(),ctx.fill(),canvas},SymbolMorph.prototype.drawSymbolCloudOutline=function(canvas,color){var ctx=canvas.getContext("2d"),w=canvas.width,h=canvas.height,r1=2*h/5,r2=h/4,r3=3*h/10,r4=h/5;return ctx.strokeStyle=color.toString(),ctx.beginPath(),ctx.arc(r2+1,h-r2-1,r2,radians(90),radians(259),!1),ctx.arc(w/20*5,h/9*4,r4,radians(165),radians(300),!1),ctx.arc(w/20*11,r1+1,r1,radians(200),radians(357),!1),
ctx.arc(w-r3-1,h-r3-1,r3,radians(269),radians(90),!1),ctx.closePath(),ctx.stroke(),canvas},SymbolMorph.prototype.drawSymbolTurnRight=function(canvas,color){var ctx=canvas.getContext("2d"),w=canvas.width,l=Math.max(w/10,1),r=w/2;return ctx.lineWidth=l,ctx.strokeStyle=color.toString(),ctx.beginPath(),ctx.arc(r,2*r,r-l/2,radians(0),radians(-90),!1),ctx.stroke(),ctx.fillStyle=color.toString(),ctx.beginPath(),ctx.moveTo(w,r),ctx.lineTo(r,0),ctx.lineTo(r,2*r),ctx.closePath(),ctx.fill(),canvas},SymbolMorph.prototype.drawSymbolTurnLeft=function(canvas,color){var ctx=canvas.getContext("2d"),w=canvas.width,l=Math.max(w/10,1),r=w/2;return ctx.lineWidth=l,ctx.strokeStyle=color.toString(),
ctx.beginPath(),ctx.arc(r,2*r,r-l/2,radians(180),radians(-90),!0),ctx.stroke(),ctx.fillStyle=color.toString(),ctx.beginPath(),ctx.moveTo(0,r),ctx.lineTo(r,0),ctx.lineTo(r,2*r),ctx.closePath(),ctx.fill(),canvas},SymbolMorph.prototype.drawSymbolStorage=function(canvas,color){function drawDisk(bottom,fillTop){ctx.fillStyle=color.toString(),ctx.beginPath(),ctx.arc(w/2,bottom-h,r,radians(60),radians(120),!1),ctx.lineTo(0,bottom-2*unit),ctx.arc(w/2,bottom-h-2*unit,r,radians(120),radians(60),!0),ctx.closePath(),ctx.fill(),ctx.fillStyle=color.darker(25).toString(),ctx.beginPath(),fillTop&&ctx.arc(w/2,bottom-h-2*unit,r,radians(120),radians(60),!0),ctx.arc(w/2,bottom+6*unit+1,r,radians(60),radians(120),!0),
ctx.closePath(),fillTop?ctx.fill():ctx.stroke()}var ctx=canvas.getContext("2d"),w=canvas.width,h=canvas.height,r=canvas.height,unit=canvas.height/11;return ctx.strokeStyle=color.toString(),drawDisk(h),drawDisk(h-3*unit),drawDisk(h-6*unit,!1),canvas},SymbolMorph.prototype.drawSymbolPoster=function(canvas,color){var ctx=canvas.getContext("2d"),w=canvas.width,h=canvas.height,bottom=.75*h,edge=canvas.height/5;return ctx.fillStyle=color.toString(),ctx.strokeStyle=color.toString(),ctx.lineWidth=w/15,ctx.moveTo(w/2,h/3),ctx.lineTo(w/6,h),ctx.stroke(),ctx.moveTo(w/2,h/3),ctx.lineTo(w/2,h),ctx.stroke(),ctx.moveTo(w/2,h/3),ctx.lineTo(5*w/6,h),ctx.stroke(),ctx.fillRect(0,0,w,bottom),
ctx.clearRect(0,bottom,w,w/20),ctx.clearRect(w-edge,bottom-edge,edge+1,edge+1),ctx.fillStyle=color.darker(25).toString(),ctx.beginPath(),ctx.moveTo(w,bottom-edge),ctx.lineTo(w-edge,bottom-edge),ctx.lineTo(w-edge,bottom),ctx.closePath(),ctx.fill(),canvas},SymbolMorph.prototype.drawSymbolFlash=function(canvas,color){var ctx=canvas.getContext("2d"),w=canvas.width,w3=w/3,h=canvas.height,h3=h/3,off=h3/3;return ctx.fillStyle=color.toString(),ctx.beginPath(),ctx.moveTo(w3,0),ctx.lineTo(0,h3),ctx.lineTo(w3,h3),ctx.lineTo(0,2*h3),ctx.lineTo(w3,2*h3),ctx.lineTo(0,h),ctx.lineTo(w,2*h3-off),ctx.lineTo(2*w3,2*h3-off),ctx.lineTo(w,h3-off),ctx.lineTo(2*w3,h3-off),ctx.lineTo(w,0),
ctx.closePath(),ctx.fill(),canvas},SymbolMorph.prototype.drawSymbolBrush=function(canvas,color){var ctx=canvas.getContext("2d"),w=canvas.width,h=canvas.height,l=Math.max(w/30,.5);return ctx.fillStyle=color.toString(),ctx.lineWidth=2*l,ctx.beginPath(),ctx.moveTo(w/8*3,h/2),ctx.quadraticCurveTo(0,h/2,l,h-l),ctx.quadraticCurveTo(w/2,h,w/2,h/8*5),ctx.closePath(),ctx.fill(),ctx.lineJoin="round",ctx.lineCap="round",ctx.strokeStyle=color.toString(),ctx.moveTo(w/8*3,h/2),ctx.lineTo(.75*w,l),ctx.quadraticCurveTo(w,0,w-l,.25*h),ctx.stroke(),ctx.moveTo(w/2,h/8*5),ctx.lineTo(w-l,.25*h),ctx.stroke(),canvas},SymbolMorph.prototype.drawSymbolRectangle=function(canvas,color){
var ctx=canvas.getContext("2d"),w=canvas.width,h=canvas.width,l=Math.max(w/20,.5);return ctx.strokeStyle=color.toString(),ctx.lineWidth=2*l,ctx.beginPath(),ctx.moveTo(l,l),ctx.lineTo(w-l,l),ctx.lineTo(w-l,h-l),ctx.lineTo(l,h-l),ctx.closePath(),ctx.stroke(),canvas},SymbolMorph.prototype.drawSymbolRectangleSolid=function(canvas,color){var ctx=canvas.getContext("2d"),w=canvas.width,h=canvas.width;return ctx.fillStyle=color.toString(),ctx.beginPath(),ctx.moveTo(0,0),ctx.lineTo(w,0),ctx.lineTo(w,h),ctx.lineTo(0,h),ctx.closePath(),ctx.fill(),canvas},SymbolMorph.prototype.drawSymbolCircle=function(canvas,color){var ctx=canvas.getContext("2d"),w=canvas.width,l=Math.max(w/20,.5);
return ctx.strokeStyle=color.toString(),ctx.lineWidth=2*l,ctx.arc(w/2,w/2,w/2-l,radians(0),radians(360),!1),ctx.stroke(),canvas},SymbolMorph.prototype.drawSymbolCircleSolid=function(canvas,color){var ctx=canvas.getContext("2d"),w=canvas.width;return ctx.fillStyle=color.toString(),ctx.arc(w/2,w/2,w/2,radians(0),radians(360),!1),ctx.fill(),canvas},SymbolMorph.prototype.drawSymbolLine=function(canvas,color){var ctx=canvas.getContext("2d"),w=canvas.width,h=canvas.height,l=Math.max(w/20,.5);return ctx.strokeStyle=color.toString(),ctx.lineWidth=2*l,ctx.lineCap="round",ctx.moveTo(l,l),ctx.lineTo(w-l,h-l),ctx.stroke(),canvas},SymbolMorph.prototype.drawSymbolCross=function(canvas,color){
var ctx=canvas.getContext("2d"),w=canvas.width,l=Math.max(w/20,.5);return ctx.strokeStyle=color.toString(),ctx.lineWidth=2*l,ctx.lineCap="round",ctx.moveTo(l,w/2),ctx.lineTo(w-l,w/2),ctx.stroke(),ctx.moveTo(w/2,l),ctx.lineTo(w/2,w-l),ctx.stroke(),canvas},SymbolMorph.prototype.drawSymbolCrosshairs=function(canvas,color){var ctx=canvas.getContext("2d"),w=canvas.width,h=canvas.height,l=.5;return ctx.strokeStyle=color.toString(),ctx.lineWidth=2*l,ctx.moveTo(l,h/2),ctx.lineTo(w-l,h/2),ctx.stroke(),ctx.moveTo(w/2,l),ctx.lineTo(w/2,h-l),ctx.stroke(),ctx.moveTo(w/2,h/2),ctx.arc(w/2,w/2,w/3-l,radians(0),radians(360),!1),ctx.stroke(),canvas},SymbolMorph.prototype.drawSymbolPaintbucket=function(canvas,color){
var ctx=canvas.getContext("2d"),w=canvas.width,h=canvas.height,n=canvas.width/5,l=Math.max(w/30,.5);return ctx.strokeStyle=color.toString(),ctx.lineWidth=2*l,ctx.beginPath(),ctx.moveTo(2*n,n),ctx.lineTo(4*n,3*n),ctx.lineTo(3*n,4*n),ctx.quadraticCurveTo(2*n,h,n,4*n),ctx.quadraticCurveTo(0,3*n,n,2*n),ctx.closePath(),ctx.stroke(),ctx.lineWidth=l,ctx.moveTo(2*n,2.5*n),ctx.arc(2*n,2.5*n,l,radians(0),radians(360),!1),ctx.stroke(),ctx.moveTo(2*n,2.5*n),ctx.lineTo(2*n,n/2+l),ctx.stroke(),ctx.arc(1.5*n,n/2+l,n/2,radians(0),radians(180),!0),ctx.stroke(),ctx.moveTo(n,n/2+l),ctx.lineTo(n,2*n),ctx.stroke(),ctx.fillStyle=color.toString(),ctx.beginPath(),ctx.moveTo(3.5*n,3.5*n),
ctx.quadraticCurveTo(w,3.5*n,w-l,h),ctx.lineTo(w,h),ctx.quadraticCurveTo(w,2*n,2.5*n,1.5*n),ctx.lineTo(4*n,3*n),ctx.closePath(),ctx.fill(),canvas},SymbolMorph.prototype.drawSymbolEraser=function(canvas,color){var ctx=canvas.getContext("2d"),w=canvas.width,h=canvas.height,n=canvas.width/4,l=Math.max(w/20,.5);return ctx.strokeStyle=color.toString(),ctx.lineWidth=2*l,ctx.beginPath(),ctx.moveTo(3*n,l),ctx.lineTo(l,3*n),ctx.quadraticCurveTo(n,h,2*n,3*n),ctx.lineTo(w-l,n),ctx.closePath(),ctx.stroke(),ctx.fillStyle=color.toString(),ctx.beginPath(),ctx.moveTo(3*n,0),ctx.lineTo(1.5*n,1.5*n),ctx.lineTo(2.5*n,2.5*n),ctx.lineTo(w,n),ctx.closePath(),ctx.fill(),canvas},SymbolMorph.prototype.drawSymbolPipette=function(canvas,color){
var ctx=canvas.getContext("2d"),w=canvas.width,h=canvas.height,n=canvas.width/4,n2=n/2,l=Math.max(w/20,.5);return ctx.strokeStyle=color.toString(),ctx.lineWidth=2*l,ctx.beginPath(),ctx.moveTo(l,h-l),ctx.quadraticCurveTo(n2,h-n2,n2,h-n),ctx.lineTo(2*n,1.5*n),ctx.stroke(),ctx.beginPath(),ctx.moveTo(l,h-l),ctx.quadraticCurveTo(n2,h-n2,n,h-n2),ctx.lineTo(2.5*n,2*n),ctx.stroke(),ctx.fillStyle=color.toString(),ctx.arc(3*n,n,n-l,radians(0),radians(360),!1),ctx.fill(),ctx.beginPath(),ctx.moveTo(2*n,n),ctx.lineTo(3*n,2*n),ctx.stroke(),canvas},SymbolMorph.prototype.drawSymbolSpeechBubble=function(canvas,color){var ctx=canvas.getContext("2d"),w=canvas.width,h=canvas.height,n=canvas.width/3,l=Math.max(w/20,.5);
return ctx.fillStyle=color.toString(),ctx.lineWidth=2*l,ctx.beginPath(),ctx.moveTo(n,2*n),ctx.quadraticCurveTo(l,2*n,l,n),ctx.quadraticCurveTo(l,l,n,l),ctx.lineTo(2*n,l),ctx.quadraticCurveTo(w-l,l,w-l,n),ctx.quadraticCurveTo(w-l,2*n,2*n,2*n),ctx.lineTo(n/2,h-l),ctx.closePath(),ctx.fill(),canvas},SymbolMorph.prototype.drawSymbolSpeechBubbleOutline=function(canvas,color){var ctx=canvas.getContext("2d"),w=canvas.width,h=canvas.height,n=canvas.width/3,l=Math.max(w/20,.5);return ctx.strokeStyle=color.toString(),ctx.lineWidth=2*l,ctx.beginPath(),ctx.moveTo(n,2*n),ctx.quadraticCurveTo(l,2*n,l,n),ctx.quadraticCurveTo(l,l,n,l),ctx.lineTo(2*n,l),ctx.quadraticCurveTo(w-l,l,w-l,n),
ctx.quadraticCurveTo(w-l,2*n,2*n,2*n),ctx.lineTo(n/2,h-l),ctx.closePath(),ctx.stroke(),canvas},SymbolMorph.prototype.drawSymbolTurnBack=function(canvas,aColor){var ctx=canvas.getContext("2d"),w=canvas.width,h=canvas.height,w2=canvas.width/2,h2=canvas.height/2,l=Math.max(w/20,.5);return ctx.fillStyle=aColor.toString(),ctx.lineWidth=2*l,ctx.beginPath(),ctx.moveTo(0,h2),ctx.lineTo(w2,0),ctx.lineTo(w2,h),ctx.closePath(),ctx.fill(),ctx.lineWidth=3*l,ctx.strokeStyle=aColor.toString(),ctx.beginPath(),ctx.arc(w2,h,h2,radians(0),radians(-90),!0),ctx.stroke(),canvas},SymbolMorph.prototype.drawSymbolTurnForward=function(canvas,aColor){var ctx=canvas.getContext("2d"),w=canvas.width,h=canvas.height,w2=canvas.width/2,h2=canvas.height/2,l=Math.max(w/20,.5);
return ctx.fillStyle=aColor.toString(),ctx.lineWidth=2*l,ctx.beginPath(),ctx.moveTo(w,h2),ctx.lineTo(w2,0),ctx.lineTo(w2,h),ctx.closePath(),ctx.fill(),ctx.lineWidth=3*l,ctx.strokeStyle=aColor.toString(),ctx.beginPath(),ctx.arc(w2,h,h2,radians(-180),radians(-90),!1),ctx.stroke(),canvas},SymbolMorph.prototype.drawSymbolArrowUp=function(canvas,color){var ctx=canvas.getContext("2d"),w=canvas.width,h=canvas.height,n=canvas.width/2,l=Math.max(w/20,.5);return ctx.fillStyle=color.toString(),ctx.lineWidth=2*l,ctx.beginPath(),ctx.moveTo(l,n),ctx.lineTo(n,l),ctx.lineTo(w-l,n),ctx.lineTo(.65*w,n),ctx.lineTo(.65*w,h-l),ctx.lineTo(.35*w,h-l),ctx.lineTo(.35*w,n),ctx.closePath(),
ctx.fill(),canvas},SymbolMorph.prototype.drawSymbolArrowUpOutline=function(canvas,color){var ctx=canvas.getContext("2d"),w=canvas.width,h=canvas.height,n=canvas.width/2,l=Math.max(w/20,.5);return ctx.strokeStyle=color.toString(),ctx.lineWidth=2*l,ctx.beginPath(),ctx.moveTo(l,n),ctx.lineTo(n,l),ctx.lineTo(w-l,n),ctx.lineTo(.65*w,n),ctx.lineTo(.65*w,h-l),ctx.lineTo(.35*w,h-l),ctx.lineTo(.35*w,n),ctx.closePath(),ctx.stroke(),canvas},SymbolMorph.prototype.drawSymbolArrowDown=function(canvas,color){var ctx=canvas.getContext("2d"),w=canvas.width;return ctx.save(),ctx.translate(w,w),ctx.rotate(radians(180)),this.drawSymbolArrowUp(canvas,color),ctx.restore(),canvas},
SymbolMorph.prototype.drawSymbolArrowDownOutline=function(canvas,color){var ctx=canvas.getContext("2d"),w=canvas.width;return ctx.save(),ctx.translate(w,w),ctx.rotate(radians(180)),this.drawSymbolArrowUpOutline(canvas,color),ctx.restore(),canvas},SymbolMorph.prototype.drawSymbolArrowLeft=function(canvas,color){var ctx=canvas.getContext("2d"),w=canvas.width;return ctx.save(),ctx.translate(0,w),ctx.rotate(radians(-90)),this.drawSymbolArrowUp(canvas,color),ctx.restore(),canvas},SymbolMorph.prototype.drawSymbolArrowLeftOutline=function(canvas,color){var ctx=canvas.getContext("2d"),w=canvas.width;return ctx.save(),ctx.translate(0,w),ctx.rotate(radians(-90)),this.drawSymbolArrowUpOutline(canvas,color),
ctx.restore(),canvas},SymbolMorph.prototype.drawSymbolArrowRight=function(canvas,color){var ctx=canvas.getContext("2d"),w=canvas.width;return ctx.save(),ctx.translate(w,0),ctx.rotate(radians(90)),this.drawSymbolArrowUp(canvas,color),ctx.restore(),canvas},SymbolMorph.prototype.drawSymbolArrowRightOutline=function(canvas,color){var ctx=canvas.getContext("2d"),w=canvas.width;return ctx.save(),ctx.translate(w,0),ctx.rotate(radians(90)),this.drawSymbolArrowUpOutline(canvas,color),ctx.restore(),canvas},SymbolMorph.prototype.drawSymbolRobot=function(canvas,color){var ctx=canvas.getContext("2d"),w=canvas.width,h=canvas.height,n=canvas.width/6,n2=n/2,l=Math.max(w/20,.5);
return ctx.fillStyle=color.toString(),ctx.beginPath(),ctx.moveTo(n+l,n),ctx.lineTo(2*n,n),ctx.lineTo(2.5*n,1.5*n),ctx.lineTo(3.5*n,1.5*n),ctx.lineTo(4*n,n),ctx.lineTo(5*n-l,n),ctx.lineTo(4*n,3*n),ctx.lineTo(4*n,4*n-l),ctx.lineTo(2*n,4*n-l),ctx.lineTo(2*n,3*n),ctx.closePath(),ctx.fill(),ctx.beginPath(),ctx.moveTo(2.75*n,n+l),ctx.lineTo(2.4*n,n),ctx.lineTo(2.2*n,0),ctx.lineTo(3.8*n,0),ctx.lineTo(3.6*n,n),ctx.lineTo(3.25*n,n+l),ctx.closePath(),ctx.fill(),ctx.beginPath(),ctx.moveTo(2.5*n,4*n),ctx.lineTo(n,4*n),ctx.lineTo(n2+l,h),ctx.lineTo(2*n,h),ctx.closePath(),ctx.fill(),ctx.beginPath(),ctx.moveTo(3.5*n,4*n),ctx.lineTo(5*n,4*n),ctx.lineTo(w-(n2+l),h),ctx.lineTo(4*n,h),
ctx.closePath(),ctx.fill(),ctx.beginPath(),ctx.moveTo(n,n),ctx.lineTo(l,1.5*n),ctx.lineTo(l,3.25*n),ctx.lineTo(1.5*n,3.5*n),ctx.closePath(),ctx.fill(),ctx.beginPath(),ctx.moveTo(5*n,n),ctx.lineTo(w-l,1.5*n),ctx.lineTo(w-l,3.25*n),ctx.lineTo(4.5*n,3.5*n),ctx.closePath(),ctx.fill(),canvas},SymbolMorph.prototype.drawSymbolMagnifyingGlass=function(canvas,color){var gradient,ctx=canvas.getContext("2d"),w=canvas.width,h=canvas.height,r=.3*w,x=2*w/3-Math.sqrt(r),y=h/3+Math.sqrt(r),l=Math.max(w/5,.5);return ctx.strokeStyle=color.toString(),gradient=ctx.createRadialGradient(x,y,0,x+r,y+r,w),gradient.addColorStop(0,color.inverted().lighter(50).toString()),gradient.addColorStop(1,color.inverted().darker(25).toString()),
ctx.fillStyle=gradient,ctx.arc(x,y,r,radians(0),radians(360),!1),ctx.fill(),ctx.lineWidth=l/2,ctx.arc(x,y,r,radians(0),radians(360),!1),ctx.stroke(),ctx.lineWidth=l,ctx.beginPath(),ctx.moveTo(l/2,h-l/2),ctx.lineTo(x-Math.sqrt(r+l),y+Math.sqrt(r+l)),ctx.closePath(),ctx.stroke(),canvas},SymbolMorph.prototype.drawSymbolMagnifierOutline=function(canvas,color){var ctx=canvas.getContext("2d"),w=canvas.width,h=canvas.height,r=.3*w,x=2*w/3-Math.sqrt(r),y=h/3+Math.sqrt(r),l=Math.max(w/5,.5);return ctx.strokeStyle=color.toString(),ctx.lineWidth=.5*l,ctx.arc(x,y,r,radians(0),radians(360),!1),ctx.stroke(),ctx.lineWidth=l,ctx.beginPath(),ctx.moveTo(l/2,h-l/2),ctx.lineTo(x-Math.sqrt(r+l),y+Math.sqrt(r+l)),
ctx.closePath(),ctx.stroke(),canvas},SymbolMorph.prototype.drawSymbolNotes=function(canvas,color){var ctx=canvas.getContext("2d"),size=canvas.width,r=size/6,l=Math.max(r/3,1);return ctx.strokeStyle=color.toString(),ctx.fillStyle=color.toString(),ctx.arc(r,size-r,r,radians(0),radians(360),!1),ctx.fill(),ctx.arc(size-r,size-2*r,r,radians(0),radians(360),!1),ctx.fill(),ctx.beginPath(),ctx.moveTo(2*r-l,r),ctx.lineTo(size,0),ctx.lineTo(size,r),ctx.lineTo(2*r-l,2*r),ctx.closePath(),ctx.fill(),ctx.lineWidth=l,ctx.beginPath(),ctx.moveTo(2*r-l/2,size-r),ctx.lineTo(2*r-l/2,r+l),ctx.stroke(),ctx.beginPath(),ctx.moveTo(size-l/2,size-2*r),ctx.lineTo(size-l/2,l),ctx.stroke(),
canvas},SymbolMorph.prototype.drawSymbolCamera=function(canvas,color){var ctx=canvas.getContext("2d"),w=canvas.width,h=canvas.width,r=.16*w,l=Math.max(w/20,.5);return ctx.lineWidth=2*l,ctx.fillStyle=color.toString(),ctx.beginPath(),ctx.moveTo(l,5*h/6),ctx.lineTo(w-l,5*h/6),ctx.lineTo(w-l,h/4),ctx.lineTo(3*w/4,h/4),ctx.lineTo(5*w/8,l),ctx.lineTo(3*w/8,l),ctx.lineTo(w/4,h/4),ctx.lineTo(l,h/4),ctx.closePath(),ctx.fill(),ctx.save(),ctx.globalCompositeOperation="destination-out",ctx.beginPath(),ctx.arc(w/2,h/2,r,radians(0),radians(360),!1),ctx.fill(),ctx.restore(),canvas},SymbolMorph.prototype.drawSymbolLocation=function(canvas,color){var ctx=canvas.getContext("2d"),w=canvas.width,h=canvas.height,r=w/2;
return ctx.fillStyle=color.toString(),ctx.beginPath(),ctx.arc(r,r,r,radians(-210),radians(30),!1),ctx.lineTo(r,h),ctx.closePath(),ctx.fill(),ctx.globalCompositeOperation="destination-out",ctx.beginPath(),ctx.arc(r,r,.5*r,radians(0),radians(360),!1),ctx.closePath(),ctx.fill(),canvas},SymbolMorph.prototype.drawSymbolFootprints=function(canvas,color){var ctx=canvas.getContext("2d"),w=canvas.width,u=w/10,r=1.5*u;return ctx.fillStyle=color.toString(),ctx.beginPath(),ctx.arc(r,r,r,radians(-200),radians(0),!1),ctx.lineTo(2*r,5.5*u),ctx.lineTo(u,6*u),ctx.closePath(),ctx.fill(),ctx.beginPath(),ctx.arc(2.25*u,6.75*u,u,radians(-40),radians(-170),!1),ctx.closePath(),ctx.fill(),
ctx.beginPath(),ctx.arc(w-r,4.5*u,r,radians(-180),radians(20),!1),ctx.lineTo(w-u,8.5*u),ctx.lineTo(w-2*r,8*u),ctx.closePath(),ctx.fill(),ctx.beginPath(),ctx.arc(w-2.25*u,9*u,u,radians(0),radians(-150),!1),ctx.closePath(),ctx.fill(),canvas},SymbolMorph.prototype.drawSymbolKeyboard=function(canvas,color){var row,col,ctx=canvas.getContext("2d"),h=canvas.height,u=h/10,k=h/5;for(ctx.fillStyle=color.toString(),row=0;row<2;row+=1)for(col=0;col<5;col+=1)ctx.fillRect((u+k)*col+u,(u+k)*row+u,k,k);return ctx.fillRect(4*u,7*u,4*k,k),canvas},SymbolMorph.prototype.drawSymbolKeyboardFilled=function(canvas,color){var row,col,ctx=canvas.getContext("2d"),w=canvas.width,h=canvas.height,u=h/10,k=h/5;
for(ctx.fillStyle=color.toString(),ctx.fillRect(0,0,w,h),ctx.globalCompositeOperation="destination-out",row=0;row<2;row+=1)for(col=0;col<5;col+=1)ctx.fillRect((u+k)*col+u,(u+k)*row+u,k,k);return ctx.fillRect(4*u,7*u,4*k,k),canvas},modules.xml="2017-November-15";var ReadStream,XML_Element;ReadStream.prototype.nonSpace=/\S|$/g,ReadStream.prototype.nonWord=/[\s\>\/\=]|$/g,ReadStream.prototype.next=function(count){var element,start;return void 0===count?(element=this.contents[this.index],this.index+=1,element):(start=this.index,this.index+=count,this.contents.slice(start,this.index))},ReadStream.prototype.peek=function(){return this.contents[this.index]},ReadStream.prototype.skip=function(count){
this.index+=count||1},ReadStream.prototype.atEnd=function(){return this.index>this.contents.length-1},ReadStream.prototype.upTo=function(str){var i=this.contents.indexOf(str,this.index);return i===-1?"":this.contents.slice(this.index,this.index=i)},ReadStream.prototype.peekUpTo=function(str){var i=this.contents.indexOf(str,this.index);return i===-1?"":this.contents.slice(this.index,i)},ReadStream.prototype.skipSpace=function(){this.nonSpace.lastIndex=this.index;var result=this.nonSpace.exec(this.contents);result&&(this.index=result.index)},ReadStream.prototype.word=function(){this.nonWord.lastIndex=this.index;var result=this.nonWord.exec(this.contents);return result?this.contents.slice(this.index,this.index=result.index):"";
},XML_Element.prototype=Object.create(Node.prototype),XML_Element.prototype.constructor=XML_Element,XML_Element.uber=Node.prototype,XML_Element.prototype.indentation="  ",XML_Element.prototype.init=function(tag,contents,parent){this.tag=tag||"unnamed",this.attributes={},this.contents=contents||"",XML_Element.uber.init.call(this),parent&&parent.addChild(this)},XML_Element.prototype.require=function(tagName){var child=this.childNamed(tagName);if(!child)throw new Error("Missing required element <"+tagName+">!");return child},XML_Element.prototype.childNamed=function(tagName){return detect(this.children,function(child){return child.tag===tagName})},XML_Element.prototype.childrenNamed=function(tagName){
return this.children.filter(function(child){return child.tag===tagName})},XML_Element.prototype.parentNamed=function(tagName){return this.tag===tagName?this:this.parent?this.parent.parentNamed(tagName):null},XML_Element.prototype.toString=function(isFormatted,indentationLevel){var key,i,result="",indent="",level=indentationLevel||0;if(isFormatted){for(i=0;i<level;i+=1)indent+=this.indentation;result+=indent}result+="<"+this.tag;for(key in this.attributes)Object.prototype.hasOwnProperty.call(this.attributes,key)&&this.attributes[key]&&(result+=" "+key+'="'+this.escape(this.attributes[key])+'"');return this.contents.length||this.children.length?(result+=">",result+=this.escape(this.contents),
this.children.forEach(function(element){isFormatted&&(result+="\n"),result+=element.toString(isFormatted,level+1)}),isFormatted&&this.children.length&&(result+="\n"+indent),result+="</"+this.tag+">"):result+="/>",result},XML_Element.prototype.escape=function(string,ignoreQuotes){var i,ch,src=isNil(string)?"":string.toString(),result="";for(i=0;i<src.length;i+=1)switch(ch=src[i]){case"'":result+="&apos;";break;case'"':result+=ignoreQuotes?ch:"&quot;";break;case"<":result+="&lt;";break;case">":result+="&gt;";break;case"&":result+="&amp;";break;case"\n":result+="&#xD;";break;case"~":result+="&#126;";break;default:result+=ch}return result},XML_Element.prototype.unescape=function(string){
return string.replace(/&(amp|apos|quot|lt|gt|#xD|#126);/g,function(_,name){switch(name){case"amp":return"&";case"apos":return"'";case"quot":return'"';case"lt":return"<";case"gt":return">";case"#xD":return"\n";case"#126":return"~";default:console.warn("unreachable")}})},XML_Element.prototype.parseString=function(string){var stream=new ReadStream(string);stream.upTo("<"),stream.skip(),this.parseStream(stream)},XML_Element.prototype.parseStream=function(stream){var key,value,ch,child;for(this.tag=stream.word(),stream.skipSpace(),ch=stream.peek();">"!==ch&&"/"!==ch;){if(key=stream.word(),stream.skipSpace(),"="!==stream.next())throw new Error('Expected "=" after attribute name');
if(stream.skipSpace(),ch=stream.next(),'"'!==ch&&"'"!==ch)throw new Error("Expected single- or double-quoted attribute value");value=stream.upTo(ch),stream.skip(1),stream.skipSpace(),this.attributes[key]=this.unescape(value),ch=stream.peek()}if("/"!==ch){if(">"!==stream.next())throw new Error('Expected ">" after tag name and attributes');for(;!stream.atEnd();)if(ch=stream.next(),"<"===ch){if("/"===stream.peek()){if(stream.skip(),stream.word()!==this.tag)throw new Error("Expected to close "+this.tag);return stream.upTo(">"),stream.skip(),void(this.contents=this.unescape(this.contents))}child=new XML_Element(null,null,this),child.parseStream(stream)}else this.contents+=ch;
}else if(stream.skip(),">"!==stream.next())throw new Error('Expected ">" after "/" in empty tag')},modules.store="2017-December-01",XML_Serializer.prototype.idProperty="serializationID",XML_Serializer.prototype.mediaIdProperty="serializationMediaID",XML_Serializer.prototype.mediaDetectionProperty="isMedia",XML_Serializer.prototype.version=1,XML_Serializer.prototype.serialize=function(object,forBlocksLibrary){var xml;return this.flush(),this.flushMedia(),this.isExportingBlocksLibrary=forBlocksLibrary,xml=this.store(object),this.flush(),xml},XML_Serializer.prototype.store=function(object,mediaID){return isNil(object)||!object.toXML?"":this.isCollectingMedia&&object[this.mediaDetectionProperty]?(this.addMedia(object,mediaID),
this.format('<ref mediaID="@"></ref>',object[this.mediaIdProperty])):object[this.idProperty]?this.format('<ref id="@"></ref>',object[this.idProperty]):(this.add(object),object.toXML(this,mediaID).replace("~",this.format('id="@"',object[this.idProperty])))},XML_Serializer.prototype.mediaXML=function(){var xml="<media>",myself=this;return this.media.forEach(function(object){var str=object.toXML(myself).replace("~",myself.format('mediaID="@"',object[myself.mediaIdProperty]));xml+=str}),xml+"</media>"},XML_Serializer.prototype.add=function(object){return object[this.idProperty]?-1:(this.contents.push(object),object[this.idProperty]=this.contents.length,this.contents.length);
},XML_Serializer.prototype.addMedia=function(object,mediaID){return object[this.mediaIdProperty]?-1:(this.media.push(object),mediaID?object[this.mediaIdProperty]=mediaID+"_"+object.name:object[this.mediaIdProperty]=this.media.length,this.media.length)},XML_Serializer.prototype.at=function(integer){return this.contents[integer-1]},XML_Serializer.prototype.flush=function(){var myself=this;this.contents.forEach(function(obj){delete obj[myself.idProperty]}),this.contents=[]},XML_Serializer.prototype.flushMedia=function(){var myself=this;this.media instanceof Array&&this.media.forEach(function(obj){delete obj[myself.mediaIdProperty]}),this.media=[],this.isExportingBlocksLibrary=!1;
},XML_Serializer.prototype.escape=XML_Element.prototype.escape,XML_Serializer.prototype.unescape=XML_Element.prototype.unescape,XML_Serializer.prototype.format=function(string){var value,myself=this,i=-1,values=arguments;return string.replace(/[@$%]([\d]+)?/g,function(spec,index){return index=parseInt(index,10),isNaN(index)?(i+=1,value=values[i+1]):value=values[index+1],"@"===spec?myself.escape(value):"$"===spec?myself.escape(value,!0):value})},XML_Serializer.prototype.load=function(xmlString){throw nop(xmlString),new Error("loading should be implemented in heir of XML_Serializer")},XML_Serializer.prototype.parse=function(xmlString){var element=new XML_Element;
return element.parseString(xmlString),element};var SnapSerializer;SnapSerializer.prototype=new XML_Serializer,SnapSerializer.prototype.constructor=SnapSerializer,SnapSerializer.uber=XML_Serializer.prototype,SnapSerializer.prototype.app="Snap! 4.1, http://snap.berkeley.edu",SnapSerializer.prototype.thumbnailSize=new Point(160,120),SnapSerializer.prototype.watcherLabels={xPosition:"x position",yPosition:"y position",direction:"direction",getScale:"size",getTempo:"tempo",getLastAnswer:"answer",getLastMessage:"message",getTimer:"timer",getCostumeIdx:"costume #",reportMouseX:"mouse x",reportMouseY:"mouse y",reportThreadCount:"processes"},SnapSerializer.prototype.init=function(){
this.project={},this.objects={},this.mediaDict={}},XML_Serializer.prototype.mediaXML=function(name){var xml='<media name="'+(name||"untitled")+'" app="'+this.app+'" version="'+this.version+'">',myself=this;return this.media.forEach(function(object){var str=object.toXML(myself).replace("~",myself.format('mediaID="@"',object[myself.mediaIdProperty]));xml+=str}),xml+"</media>"},SnapSerializer.prototype.load=function(xmlString,ide){return this.loadProjectModel(this.parse(xmlString),ide)},SnapSerializer.prototype.loadProjectModel=function(xmlNode,ide){var appInfo=xmlNode.attributes.app,app=appInfo?appInfo.split(" ")[0]:null;return ide&&app&&app!==this.app.split(" ")[0]&&ide.inform(app+" Project","This project has been created by a different app:\n\n"+app+"\n\nand may be incompatible or fail to load here."),
this.rawLoadProjectModel(xmlNode)},SnapSerializer.prototype.rawLoadProjectModel=function(xmlNode){var model,nameID,myself=this,project={sprites:{}};if(this.project=project,model={project:xmlNode},+xmlNode.attributes.version>this.version)throw"Project uses newer version of Serializer";if(this.objects={},project.name=model.project.attributes.name,!project.name){for(nameID=1;Object.prototype.hasOwnProperty.call(localStorage,"-snap-project-Untitled "+nameID);)nameID+=1;project.name="Untitled "+nameID}return model.notes=model.project.childNamed("notes"),model.notes&&(project.notes=model.notes.contents),model.globalVariables=model.project.childNamed("variables"),project.globalVariables=new VariableFrame,
model.stage=model.project.require("stage"),StageMorph.prototype.frameRate=0,project.stage=new StageMorph(project.globalVariables),Object.prototype.hasOwnProperty.call(model.stage.attributes,"id")&&(this.objects[model.stage.attributes.id]=project.stage),model.stage.attributes.name&&(project.stage.name=model.stage.attributes.name),"true"===model.stage.attributes.scheduled&&(project.stage.fps=30,StageMorph.prototype.frameRate=30),model.pentrails=model.stage.childNamed("pentrails"),model.pentrails&&(project.pentrails=new Image,project.pentrails.onload=function(){if(project.stage.trailsCanvas){normalizeCanvas(project.stage.trailsCanvas);var context=project.stage.trailsCanvas.getContext("2d");
context.drawImage(project.pentrails,0,0),project.stage.changed()}},project.pentrails.src=model.pentrails.contents),project.stage.setTempo(model.stage.attributes.tempo),StageMorph.prototype.dimensions=new Point(480,360),model.stage.attributes.width&&(StageMorph.prototype.dimensions.x=Math.max(+model.stage.attributes.width,240)),model.stage.attributes.height&&(StageMorph.prototype.dimensions.y=Math.max(+model.stage.attributes.height,180)),project.stage.setExtent(StageMorph.prototype.dimensions),SpriteMorph.prototype.useFlatLineEnds="flat"===model.stage.attributes.lines,BooleanSlotMorph.prototype.isTernary="false"!==model.stage.attributes.ternary,project.stage.isThreadSafe="true"===model.stage.attributes.threadsafe,
StageMorph.prototype.enableCodeMapping="true"===model.stage.attributes.codify,StageMorph.prototype.enableInheritance="false"!==model.stage.attributes.inheritance,StageMorph.prototype.enableSublistIDs="true"===model.stage.attributes.sublistIDs,model.hiddenPrimitives=model.project.childNamed("hidden"),model.hiddenPrimitives&&model.hiddenPrimitives.contents.split(" ").forEach(function(sel){sel&&(StageMorph.prototype.hiddenPrimitives[sel]=!0)}),model.codeHeaders=model.project.childNamed("headers"),model.codeHeaders&&model.codeHeaders.children.forEach(function(xml){StageMorph.prototype.codeHeaders[xml.tag]=xml.contents}),model.codeMappings=model.project.childNamed("code"),
model.codeMappings&&model.codeMappings.children.forEach(function(xml){StageMorph.prototype.codeMappings[xml.tag]=xml.contents}),model.globalBlocks=model.project.childNamed("blocks"),model.globalBlocks&&(this.loadCustomBlocks(project.stage,model.globalBlocks,!0),this.populateCustomBlocks(project.stage,model.globalBlocks,!0)),this.loadObject(project.stage,model.stage),model.sprites=model.stage.require("sprites"),project.sprites[project.stage.name]=project.stage,model.sprites.childrenNamed("sprite").forEach(function(model){myself.loadValue(model)}),myself.project.stage.children.forEach(function(sprite){var exemplar,anchor;sprite.inheritanceInfo&&(exemplar=myself.project.sprites[sprite.inheritanceInfo.exemplar],
exemplar&&sprite.setExemplar(exemplar),sprite.inheritedAttributes=sprite.inheritanceInfo.delegated||[]),sprite.nestingInfo&&(anchor=myself.project.sprites[sprite.nestingInfo.anchor],anchor&&anchor.attachPart(sprite),sprite.rotatesWithAnchor="true"===sprite.nestingInfo.synch)}),myself.project.stage.children.forEach(function(sprite){var costume;sprite.nestingInfo&&(sprite.nestingScale=+(sprite.nestingInfo.scale||sprite.scale),delete sprite.nestingInfo),["scripts","costumes","sounds"].forEach(function(att){sprite.inheritsAttribute(att)&&sprite.refreshInheritedAttribute(att)}),sprite.inheritsAttribute("costumes")&&(costume=sprite.costumes.asArray()[sprite.inheritanceInfo.costumeNumber-1],
costume&&(costume.loaded?sprite.wearCostume(costume,!0):costume.loaded=function(){sprite.wearCostume(costume,!0),this.loaded=!0})),delete sprite.inheritanceInfo}),model.globalVariables&&this.loadVariables(project.globalVariables,model.globalVariables),this.objects={},model.sprites.childrenNamed("watcher").forEach(function(model){var watcher,color,target,hidden,extX,extY;color=myself.loadColor(model.attributes.color),target=Object.prototype.hasOwnProperty.call(model.attributes,"scope")?project.sprites[model.attributes.scope]:null,hidden=Object.prototype.hasOwnProperty.call(model.attributes,"hidden")&&"false"!==model.attributes.hidden,watcher=Object.prototype.hasOwnProperty.call(model.attributes,"var")?new WatcherMorph(model.attributes.var,color,isNil(target)?project.globalVariables:target.variables,model.attributes.var,hidden):new WatcherMorph(localize(myself.watcherLabels[model.attributes.s]),color,target,model.attributes.s,hidden),
watcher.setStyle(model.attributes.style||"normal"),"slider"===watcher.style&&(watcher.setSliderMin(model.attributes.min||"1",!0),watcher.setSliderMax(model.attributes.max||"100",!0)),watcher.setPosition(project.stage.topLeft().add(new Point(+model.attributes.x||0,+model.attributes.y||0))),project.stage.add(watcher),watcher.onNextStep=function(){this.currentValue=null},watcher.currentValue instanceof List&&(extX=model.attributes.extX,extX&&watcher.cellMorph.contentsMorph.setWidth(+extX),extY=model.attributes.extY,extY&&watcher.cellMorph.contentsMorph.setHeight(+extY),watcher.cellMorph.contentsMorph.handle.drawNew())}),myself.project.stage.children.forEach(function(sprite){
sprite.inheritedMethodsCache=[]}),this.objects={},project},SnapSerializer.prototype.loadBlocks=function(xmlString,targetStage){var model,stage=new StageMorph;if(this.project={stage:stage,sprites:{},targetStage:targetStage},model=this.parse(xmlString),+model.attributes.version>this.version)throw"Module uses newer version of Serializer";return this.loadCustomBlocks(stage,model,!0),this.populateCustomBlocks(stage,model,!0),this.objects={},stage.globalBlocks.forEach(function(def){def.receiver=null}),this.objects={},this.project={},this.mediaDict={},stage.globalBlocks},SnapSerializer.prototype.loadSprites=function(xmlString,ide){var model,project,myself=this;if(project=this.project={
globalVariables:ide.globalVariables,stage:ide.stage,sprites:{}},project.sprites[project.stage.name]=project.stage,model=this.parse(xmlString),+model.attributes.version>this.version)throw"Module uses newer version of Serializer";model.childrenNamed("sprite").forEach(function(model){var sprite=new SpriteMorph(project.globalVariables);model.attributes.id&&(myself.objects[model.attributes.id]=sprite),model.attributes.name&&(sprite.name=ide.newSpriteName(model.attributes.name),project.sprites[sprite.name]=sprite),model.attributes.color&&(sprite.color=myself.loadColor(model.attributes.color)),model.attributes.pen&&(sprite.penPoint=model.attributes.pen),project.stage.add(sprite),
ide.sprites.add(sprite),sprite.scale=parseFloat(model.attributes.scale||"1"),sprite.rotationStyle=parseFloat(model.attributes.rotation||"1"),sprite.isDraggable="false"!==model.attributes.draggable,sprite.isVisible="true"!==model.attributes.hidden,sprite.heading=parseFloat(model.attributes.heading)||0,sprite.drawNew(),sprite.gotoXY(+model.attributes.x||0,+model.attributes.y||0),myself.loadObject(sprite,model)}),project.stage.children.forEach(function(sprite){var exemplar,anchor;sprite.inheritanceInfo&&(exemplar=project.sprites[sprite.inheritanceInfo.exemplar],exemplar&&sprite.setExemplar(exemplar)),sprite.nestingInfo&&(anchor=project.sprites[sprite.nestingInfo.anchor],
anchor&&anchor.attachPart(sprite),sprite.rotatesWithAnchor="true"===sprite.nestingInfo.synch)}),project.stage.children.forEach(function(sprite){delete sprite.inheritanceInfo,sprite.nestingInfo&&(sprite.nestingScale=+(sprite.nestingInfo.scale||sprite.scale),delete sprite.nestingInfo)}),this.objects={},this.project={},this.mediaDict={},ide.createCorral(),ide.fixLayout()},SnapSerializer.prototype.loadMedia=function(xmlString){return this.loadMediaModel(this.parse(xmlString))},SnapSerializer.prototype.loadMediaModel=function(xmlNode){var myself=this,model=xmlNode;if(this.mediaDict={},+model.attributes.version>this.version)throw"Module uses newer version of Serializer";
return model.children.forEach(function(model){myself.loadValue(model)}),this.mediaDict},SnapSerializer.prototype.loadObject=function(object,model){var blocks=model.require("blocks"),dispatches=model.childNamed("dispatches");model.attributes.instrument&&(object.instrument=+model.attributes.instrument),this.loadInheritanceInfo(object,model),this.loadNestingInfo(object,model),object.inheritanceInfo&&object.inheritanceInfo.delegated instanceof Array&&contains(object.inheritanceInfo.delegated,"costumes")||this.loadCostumes(object,model),object.inheritanceInfo&&object.inheritanceInfo.delegated instanceof Array&&contains(object.inheritanceInfo.delegated,"sounds")||this.loadSounds(object,model),
this.loadCustomBlocks(object,blocks),dispatches&&this.loadCustomBlocks(object,dispatches,!1,!0),this.populateCustomBlocks(object,blocks),this.loadVariables(object.variables,model.require("variables"),object),object.inheritanceInfo&&object.inheritanceInfo.delegated instanceof Array&&contains(object.inheritanceInfo.delegated,"scripts")||this.loadScripts(object,object.scripts,model.require("scripts"))},SnapSerializer.prototype.loadInheritanceInfo=function(object,model){var delegated,info=model.childNamed("inherit");info&&(object.inheritanceInfo=info.attributes,delegated=info.childNamed("list"),delegated&&(object.inheritanceInfo.delegated=this.loadValue(delegated).asArray()),
object.inheritanceInfo.costumeNumber=model.attributes.costume)},SnapSerializer.prototype.loadNestingInfo=function(object,model){var info=model.childNamed("nest");info&&(object.nestingInfo=info.attributes)},SnapSerializer.prototype.loadCostumes=function(object,model){var costume,costumes=model.childNamed("costumes");costumes&&(object.costumes=this.loadValue(costumes.require("list")),object.costumes.type="costume"),Object.prototype.hasOwnProperty.call(model.attributes,"costume")&&(costume=object.costumes.asArray()[model.attributes.costume-1],costume&&(costume.loaded?object.wearCostume(costume,!0):costume.loaded=function(){object.wearCostume(costume,!0),this.loaded=!0;
}))},SnapSerializer.prototype.loadSounds=function(object,model){var sounds=model.childNamed("sounds");sounds&&(object.sounds=this.loadValue(sounds.require("list")),object.sounds.type="sound")},SnapSerializer.prototype.loadVariables=function(varFrame,element,object){var myself=this;element.children.forEach(function(child){var v,value;"variable"===child.tag&&(value=child.children[0],v=new Variable,v.isTransient="true"===child.attributes.transient,v.value=v.isTransient||!value?0:myself.loadValue(value,object),varFrame.vars[child.attributes.name]=v)})},SnapSerializer.prototype.loadCustomBlocks=function(object,element,isGlobal,isDispatch){var myself=this;element.children.forEach(function(child){
var definition,names,inputs,vars,header,code,trans,comment,i;"block-definition"===child.tag&&(definition=new CustomBlockDefinition(child.attributes.s||"",object),definition.category=child.attributes.category||"other",definition.type=child.attributes.type||"command",definition.isGlobal=isGlobal===!0,isDispatch?object.inheritedMethodsCache.push(definition):definition.isGlobal?object.globalBlocks.push(definition):object.customBlocks.push(definition),names=definition.parseSpec(definition.spec).filter(function(str){return"%"===str.charAt(0)&&str.length>1}).map(function(str){return str.substr(1)}),definition.names=names,inputs=child.childNamed("inputs"),inputs&&(i=-1,
inputs.children.forEach(function(child){var options=child.childNamed("options");"input"===child.tag&&(i+=1,definition.declarations[names[i]]=[child.attributes.type,contains(["%b","%boolUE"],child.attributes.type)?child.contents?"true"===child.contents:null:child.contents,options?options.contents:void 0,"true"===child.attributes.readonly])})),vars=child.childNamed("variables"),vars&&(definition.variableNames=myself.loadValue(vars.require("list")).asArray()),header=child.childNamed("header"),header&&(definition.codeHeader=header.contents),code=child.childNamed("code"),code&&(definition.codeMapping=code.contents),trans=child.childNamed("translations"),trans&&definition.updateTranslations(trans.contents),
comment=child.childNamed("comment"),comment&&(definition.comment=myself.loadComment(comment)))})},SnapSerializer.prototype.populateCustomBlocks=function(object,element,isGlobal){var myself=this;element.children.forEach(function(child,index){var definition,script,scripts;"block-definition"===child.tag&&(definition=isGlobal?object.globalBlocks[index]:object.customBlocks[index],script=child.childNamed("script"),script&&(definition.body=new Context(null,script?myself.loadScript(script,object):null,null,object),definition.body.inputs=definition.names.slice(0)),scripts=child.childNamed("scripts"),scripts&&(definition.scripts=myself.loadScriptsArray(scripts,object)),
delete definition.names)})},SnapSerializer.prototype.loadScripts=function(object,scripts,model){var myself=this,scale=SyntaxElementMorph.prototype.scale;scripts.cachedTexture=IDE_Morph.prototype.scriptsPaneTexture,model.children.forEach(function(child){var element;if("script"===child.tag){if(element=myself.loadScript(child,object),!element)return;element.setPosition(new Point((+child.attributes.x||0)*scale,(+child.attributes.y||0)*scale).add(scripts.topLeft())),scripts.add(element),element.fixBlockColor(null,!0),element.allComments().forEach(function(comment){comment.align(element)})}else if("comment"===child.tag){if(element=myself.loadComment(child),!element)return;
element.setPosition(new Point((+child.attributes.x||0)*scale,(+child.attributes.y||0)*scale).add(scripts.topLeft())),scripts.add(element)}})},SnapSerializer.prototype.loadScriptsArray=function(model,object){var myself=this,scale=SyntaxElementMorph.prototype.scale,scripts=[];return model.children.forEach(function(child){var element;if("script"===child.tag){if(element=myself.loadScript(child,object),!element)return;element.setPosition(new Point((+child.attributes.x||0)*scale,(+child.attributes.y||0)*scale)),scripts.push(element),element.fixBlockColor(null,!0)}else if("comment"===child.tag){if(element=myself.loadComment(child),!element)return;element.setPosition(new Point((+child.attributes.x||0)*scale,(+child.attributes.y||0)*scale)),
scripts.push(element)}}),scripts},SnapSerializer.prototype.loadScript=function(model,object){var topBlock,block,nextBlock,myself=this;return model.children.forEach(function(child){if(nextBlock=myself.loadBlock(child,!1,object)){if(block){if(!(block.nextBlock&&nextBlock instanceof CommandBlockMorph))return console.log("SNAP: expecting a command but getting a reporter:\n  "+block.blockSpec+"\n  "+nextBlock.blockSpec),topBlock;block.nextBlock(nextBlock)}else topBlock=nextBlock;block=nextBlock}}),topBlock},SnapSerializer.prototype.loadComment=function(model){var comment=new CommentMorph(model.contents),scale=SyntaxElementMorph.prototype.scale;return comment.isCollapsed="true"===model.attributes.collapsed,
comment.setTextWidth(+model.attributes.w*scale),comment},SnapSerializer.prototype.loadBlock=function(model,isReporter,object){var block,info,inputs,isGlobal,receiver,migration,migrationOffset=0;if("block"===model.tag){if(Object.prototype.hasOwnProperty.call(model.attributes,"var"))return SpriteMorph.prototype.variableBlock(model.attributes.var);block=SpriteMorph.prototype.blockForSelector(model.attributes.s),migration=SpriteMorph.prototype.blockMigrations[model.attributes.s],migration&&(migrationOffset=migration.offset)}else if("custom-block"===model.tag){if(isGlobal=!model.attributes.scope,receiver=isGlobal?this.project.stage:object,isGlobal?(info=detect(receiver.globalBlocks,function(block){
return block.blockSpec()===model.attributes.s}),!info&&this.project.targetStage&&(info=detect(this.project.targetStage.globalBlocks,function(block){return block.blockSpec()===model.attributes.s}))):info=detect(receiver.customBlocks,function(block){return block.blockSpec()===model.attributes.s})||(receiver.inheritedMethodsCache?detect(receiver.inheritedMethodsCache,function(block){return block.blockSpec()===model.attributes.s}):null),!info)return this.obsoleteBlock(isReporter);block="command"===info.type?new CustomCommandBlockMorph(info,!1):new CustomReporterBlockMorph(info,"predicate"===info.type,!1)}return null===block&&(block=this.obsoleteBlock(isReporter)),
block.isDraggable=!0,inputs=block.inputs(),model.children.forEach(function(child,i){"variables"===child.tag?this.loadVariables(block.variables,child,object):"comment"===child.tag?(block.comment=this.loadComment(child),block.comment.block=block):"receiver"===child.tag?nop():this.loadInput(child,inputs[i+migrationOffset],block,object)},this),block.cachedInputs=null,block},SnapSerializer.prototype.obsoleteBlock=function(isReporter){var block=isReporter?new ReporterBlockMorph:new CommandBlockMorph;return block.selector="errorObsolete",block.color=new Color(200,0,20),block.setSpec("Obsolete!"),block.isDraggable=!0,block},SnapSerializer.prototype.loadInput=function(model,input,block,object){
var inp,val,myself=this;if(!isNil(input))if("script"===model.tag)inp=this.loadScript(model,object),inp&&(input.add(inp),input.fixLayout());else if("autolambda"===model.tag&&model.children[0])inp=this.loadBlock(model.children[0],!0,object),inp&&(input.silentReplaceInput(input.children[0],inp),input.fixLayout());else if("list"===model.tag){for(;input.inputs().length>0;)input.removeInput();model.children.forEach(function(item){input.addInput(),myself.loadInput(item,input.children[input.children.length-2],input,object)}),input.fixLayout()}else"block"===model.tag||"custom-block"===model.tag?block.silentReplaceInput(input,this.loadBlock(model,!0,object)):"color"===model.tag?input.setColor(this.loadColor(model.contents)):(val=this.loadValue(model),
isNil(val)||isNil(input)||!input.setContents||input.setContents(this.loadValue(model)))},SnapSerializer.prototype.loadValue=function(model,object){function record(){Object.prototype.hasOwnProperty.call(model.attributes,"id")&&(myself.objects[model.attributes.id]=v),Object.prototype.hasOwnProperty.call(model.attributes,"mediaID")&&(myself.mediaDict[model.attributes.mediaID]=v)}var v,i,lst,items,el,center,image,name,audio,option,bool,origin,myself=this;switch(model.tag){case"ref":if(Object.prototype.hasOwnProperty.call(model.attributes,"id"))return this.objects[model.attributes.id];if(Object.prototype.hasOwnProperty.call(model.attributes,"mediaID"))return this.mediaDict[model.attributes.mediaID];
throw new Error("expecting a reference id");case"l":return(option=model.childNamed("option"))?[option.contents]:(bool=model.childNamed("bool"),bool?this.loadValue(bool):model.contents);case"bool":return"true"===model.contents;case"list":return model.attributes.hasOwnProperty("linked")?(v=new List,v.isLinked=!0,record(),lst=v,items=model.childrenNamed("item"),items.forEach(function(item,i){var value=item.children[0];value?v.first=myself.loadValue(value,object):v.first=0;var tail=model.childNamed("list")||model.childNamed("ref");tail?v.rest=myself.loadValue(tail,object):i<items.length-1&&(v.rest=new List,v=v.rest,v.isLinked=!0)}),lst):(v=new List,record(),v.contents=model.childrenNamed("item").map(function(item){
var value=item.children[0];return value?myself.loadValue(value,object):0}),v);case"sprite":return v=new SpriteMorph(myself.project.globalVariables),model.attributes.id&&(myself.objects[model.attributes.id]=v),model.attributes.name&&(v.name=model.attributes.name,myself.project.sprites[model.attributes.name]=v),model.attributes.idx&&(v.idx=+model.attributes.idx),model.attributes.color&&(v.color=myself.loadColor(model.attributes.color)),model.attributes.pen&&(v.penPoint=model.attributes.pen),myself.project.stage.add(v),v.scale=parseFloat(model.attributes.scale||"1"),v.rotationStyle=parseFloat(model.attributes.rotation||"1"),v.isDraggable="false"!==model.attributes.draggable,
v.isVisible="true"!==model.attributes.hidden,v.heading=parseFloat(model.attributes.heading)||0,v.drawNew(),v.gotoXY(+model.attributes.x||0,+model.attributes.y||0),myself.loadObject(v,model),v;case"context":return v=new Context(null),record(),el=model.childNamed("origin"),el&&(el=el.childNamed("ref")||el.childNamed("sprite"),el&&(v.origin=this.loadValue(el))),el=model.childNamed("receiver"),el&&(el=el.childNamed("ref")||el.childNamed("sprite"),el&&(v.receiver=this.loadValue(el))),origin=v.origin||v.receiver||object,el=model.childNamed("script"),el?v.expression=this.loadScript(el,origin):(el=model.childNamed("block")||model.childNamed("custom-block"),el?v.expression=this.loadBlock(el,null,origin):(el=model.childNamed("l"),
el&&(bool=el.childNamed("bool"),bool?v.expression=new BooleanSlotMorph(this.loadValue(bool)):v.expression=new InputSlotMorph(el.contents)))),v.expression instanceof BlockMorph&&(i=0,v.expression.allEmptySlots().forEach(function(slot){i+=1,slot instanceof MultiArgMorph?slot.bindingID=["arguments"]:slot.bindingID=i}),v.emptySlots=i),el=model.childNamed("inputs"),el&&el.children.forEach(function(item){"input"===item.tag&&v.inputs.push(item.contents)}),el=model.childNamed("variables"),el&&this.loadVariables(v.variables,el,origin),el=model.childNamed("context"),el&&(v.outerContext=this.loadValue(el,origin)),v.outerContext&&v.receiver&&!v.outerContext.variables.parentFrame&&(v.outerContext.variables.parentFrame=v.receiver.variables),
v;case"costume":return center=new Point,Object.prototype.hasOwnProperty.call(model.attributes,"center-x")&&(center.x=parseFloat(model.attributes["center-x"])),Object.prototype.hasOwnProperty.call(model.attributes,"center-y")&&(center.y=parseFloat(model.attributes["center-y"])),Object.prototype.hasOwnProperty.call(model.attributes,"name")&&(name=model.attributes.name),Object.prototype.hasOwnProperty.call(model.attributes,"image")&&(image=new Image,0!==model.attributes.image.indexOf("data:image/svg+xml")||MorphicPreferences.rasterizeSVGs?(v=new Costume(null,name,center),image.onload=function(){var canvas=newCanvas(new Point(image.width,image.height),!0),context=canvas.getContext("2d");
context.drawImage(image,0,0),v.contents=canvas,v.version=+new Date,"function"==typeof v.loaded?v.loaded():v.loaded=!0}):(v=new SVG_Costume(null,name,center),image.onload=function(){v.contents=image,v.version=+new Date,"function"==typeof v.loaded?v.loaded():v.loaded=!0}),image.src=model.attributes.image),record(),v;case"sound":return audio=new Audio,audio.src=model.attributes.sound,v=new Sound(audio,model.attributes.name),Object.prototype.hasOwnProperty.call(model.attributes,"mediaID")&&(myself.mediaDict[model.attributes.mediaID]=v),record(),v}},SnapSerializer.prototype.loadColor=function(colorString){var c=(colorString||"").split(",");return new Color(parseFloat(c[0]),parseFloat(c[1]),parseFloat(c[2]),parseFloat(c[3]));
},SnapSerializer.prototype.openProject=function(project,ide){var sprite,stage=ide.stage,sprites=[];project&&project.stage&&(ide.projectName=project.name,ide.projectNotes=project.notes||"",ide.globalVariables&&(ide.globalVariables=project.globalVariables),stage&&stage.destroy(),ide.add(project.stage),ide.stage=project.stage,sprites=ide.stage.children.filter(function(child){return child instanceof SpriteMorph}),sprites.sort(function(x,y){return x.idx-y.idx}),ide.sprites=new List(sprites),sprite=sprites[0]||project.stage,sizeOf(this.mediaDict)>0?(ide.hasChangedMedia=!1,this.mediaDict={}):ide.hasChangedMedia=!0,project.stage.drawNew(),ide.createCorral(),ide.selectSprite(sprite),
ide.fixLayout(),ide.world().keyboardReceiver=project.stage)},StageMorph.prototype.toXML=function(serializer){function code(key){var str="";return Object.keys(StageMorph.prototype[key]).forEach(function(selector){str+="<"+selector+">"+XML_Element.prototype.escape(StageMorph.prototype[key][selector])+"</"+selector+">"}),str}var thumbdata,thumbnail=normalizeCanvas(this.thumbnail(SnapSerializer.prototype.thumbnailSize),!0),ide=this.parentThatIsA(IDE_Morph);try{thumbdata=thumbnail.toDataURL("image/png")}catch(error){thumbdata=null}return this.removeAllClones(),serializer.format('<project name="@" app="@" version="@"><notes>$</notes><thumbnail>$</thumbnail><stage name="@" width="@" height="@" costume="@" tempo="@" threadsafe="@" %lines="@" ternary="@" codify="@" inheritance="@" sublistIDs="@" scheduled="@" ~><pentrails>$</pentrails><costumes>%</costumes><sounds>%</sounds><variables>%</variables><blocks>%</blocks><scripts>%</scripts><sprites>%</sprites></stage><hidden>$</hidden><headers>%</headers><code>%</code><blocks>%</blocks><variables>%</variables></project>',ide&&ide.projectName?ide.projectName:localize("Untitled"),serializer.app,serializer.version,ide&&ide.projectNotes?ide.projectNotes:"",thumbdata,this.name,StageMorph.prototype.dimensions.x,StageMorph.prototype.dimensions.y,this.getCostumeIdx(),this.getTempo(),this.isThreadSafe,this.instrument?' instrument="'+parseInt(this.instrument)+'" ':"",SpriteMorph.prototype.useFlatLineEnds?"flat":"round",BooleanSlotMorph.prototype.isTernary,this.enableCodeMapping,this.enableInheritance,this.enableSublistIDs,0!==StageMorph.prototype.frameRate,normalizeCanvas(this.trailsCanvas,!0).toDataURL("image/png"),serializer.store(this.costumes,this.name+"_cst"),serializer.store(this.sounds,this.name+"_snd"),serializer.store(this.variables),serializer.store(this.customBlocks),serializer.store(this.scripts),serializer.store(this.children),Object.keys(StageMorph.prototype.hiddenPrimitives).reduce(function(a,b){
return a+" "+b},""),code("codeHeaders"),code("codeMappings"),serializer.store(this.globalBlocks),ide&&ide.globalVariables?serializer.store(ide.globalVariables):"")},SpriteMorph.prototype.toXML=function(serializer){var stage=this.parentThatIsA(StageMorph),ide=stage?stage.parentThatIsA(IDE_Morph):null,idx=ide?ide.sprites.asArray().indexOf(this)+1:0,noCostumes=this.inheritsAttribute("costumes"),noSounds=this.inheritsAttribute("sounds"),noScripts=this.inheritsAttribute("scripts");return serializer.format('<sprite name="@" idx="@" x="@" y="@" heading="@" scale="@" rotation="@"% draggable="@"% costume="@" color="@,@,@" pen="@" ~>%%'+(noCostumes?"%":"<costumes>%</costumes>")+(noSounds?"%":"<sounds>%</sounds>")+"<blocks>%</blocks><variables>%</variables>"+(this.exemplar?"<dispatches>%</dispatches>":"%")+(noScripts?"%":"<scripts>%</scripts>")+"</sprite>",this.name,idx,this.xPosition(),this.yPosition(),this.heading,this.scale,this.rotationStyle,this.instrument?' instrument="'+parseInt(this.instrument)+'" ':"",this.isDraggable,this.isVisible?"":' hidden="true"',this.getCostumeIdx(),this.color.r,this.color.g,this.color.b,this.penPoint,this.exemplar?'<inherit exemplar="'+this.exemplar.name+'">'+(this.inheritedAttributes.length?serializer.store(new List(this.inheritedAttributes)):"")+"</inherit>":"",this.anchor?'<nest anchor="'+this.anchor.name+'" synch="'+this.rotatesWithAnchor+(this.scale===this.nestingScale?"":'" scale="'+this.nestingScale)+'"/>':"",noCostumes?"":serializer.store(this.costumes,this.name+"_cst"),noSounds?"":serializer.store(this.sounds,this.name+"_snd"),this.customBlocks?serializer.store(this.customBlocks):"",serializer.store(this.variables),this.exemplar?serializer.store(this.inheritedMethods()):"",noScripts?"":serializer.store(this.scripts));
},Costume.prototype[XML_Serializer.prototype.mediaDetectionProperty]=!0,Costume.prototype.toXML=function(serializer){return serializer.format('<costume name="@" center-x="@" center-y="@" image="@" ~/>',this.name,this.rotationCenter.x,this.rotationCenter.y,this instanceof SVG_Costume?this.contents.src:normalizeCanvas(this.contents).toDataURL("image/png"))},Sound.prototype[XML_Serializer.prototype.mediaDetectionProperty]=!0,Sound.prototype.toXML=function(serializer){return serializer.format('<sound name="@" sound="@" ~/>',this.name,this.toDataURL())},VariableFrame.prototype.toXML=function(serializer){var myself=this;return Object.keys(this.vars).reduce(function(vars,v){
var dta,val=myself.vars[v].value;return dta=myself.vars[v].isTransient?serializer.format('<variable name="@" transient="true"/>',v):void 0===val||null===val?serializer.format('<variable name="@"/>',v):serializer.format('<variable name="@">%</variable>',v,"object"==typeof val?isSnapObject(val)?"":serializer.store(val):"boolean"==typeof val?serializer.format("<bool>$</bool>",val):serializer.format("<l>$</l>",val)),vars+dta},"")},WatcherMorph.prototype.toXML=function(serializer){var isVar=this.target instanceof VariableFrame,isList=this.currentValue instanceof List,color=this.readoutColor,position=this.parent?this.topLeft().subtract(this.parent.topLeft()):this.topLeft();
return this.isTemporary()?"":serializer.format('<watcher% % style="@"% x="@" y="@" color="@,@,@"%%/>',isVar&&this.target.owner||!isVar&&this.target?serializer.format(' scope="@"',isVar?this.target.owner.name:this.target.name):"",serializer.format(isVar?'var="@"':'s="@"',this.getter),this.style,isVar&&"slider"===this.style?serializer.format(' min="@" max="@"',this.sliderMorph.start,this.sliderMorph.stop):"",position.x,position.y,color.r,color.g,color.b,isList?serializer.format(' extX="@" extY="@"',this.cellMorph.contentsMorph.width(),this.cellMorph.contentsMorph.height()):"",this.isVisible?"":' hidden="true"')},ScriptsMorph.prototype.toXML=function(serializer){
return this.children.reduce(function(xml,child){return child instanceof BlockMorph?xml+child.toScriptXML(serializer,!0):child instanceof CommentMorph&&!child.block?xml+child.toXML(serializer):xml},"")},BlockMorph.prototype.toXML=BlockMorph.prototype.toScriptXML=function(serializer,savePosition){var position,xml,scale=SyntaxElementMorph.prototype.scale,block=this;position=this.parent?this.topLeft().subtract(this.parent.topLeft()):this.topLeft(),xml=savePosition?serializer.format('<script x="@" y="@">',position.x/scale,position.y/scale):"<script>";do xml+=block.toBlockXML(serializer),block=block.nextBlock();while(block);return xml+="</script>"},BlockMorph.prototype.toBlockXML=function(serializer){
return serializer.format('<block s="@">%%</block>',this.selector,serializer.store(this.inputs()),this.comment?this.comment.toXML(serializer):"")},ReporterBlockMorph.prototype.toXML=function(serializer){return"reportGetVar"===this.selector?serializer.format('<block var="@"/>',this.blockSpec):this.toBlockXML(serializer)},ReporterBlockMorph.prototype.toScriptXML=function(serializer,savePosition){var position,scale=SyntaxElementMorph.prototype.scale;return position=this.parent?this.topLeft().subtract(this.parent.topLeft()):this.topLeft(),savePosition?serializer.format('<script x="@" y="@">%</script>',position.x/scale,position.y/scale,this.toXML(serializer)):serializer.format("<script>%</script>",this.toXML(serializer));
},CustomCommandBlockMorph.prototype.toBlockXML=function(serializer){var scope=this.isGlobal?void 0:"local";return serializer.format('<custom-block s="@"%>%%%</custom-block>',this.semanticSpec,this.isGlobal?"":serializer.format(' scope="@"',scope),serializer.store(this.inputs()),this.isGlobal&&this.definition.variableNames.length&&!serializer.isExportingBlocksLibrary?"<variables>"+this.variables.toXML(serializer)+"</variables>":"",this.comment?this.comment.toXML(serializer):"")},CustomReporterBlockMorph.prototype.toBlockXML=CustomCommandBlockMorph.prototype.toBlockXML,CustomBlockDefinition.prototype.toXML=function(serializer){function encodeScripts(array){return array.reduce(function(xml,element){
return element instanceof BlockMorph?xml+element.toScriptXML(serializer,!0):element instanceof CommentMorph&&!element.block?xml+element.toXML(serializer):xml},"")}var myself=this;return serializer.format('<block-definition s="@" type="@" category="@">%'+(this.variableNames.length?"<variables>%</variables>":"@")+"<header>@</header><code>@</code><translations>@</translations><inputs>%</inputs>%%</block-definition>",this.spec,this.type,this.category||"other",this.comment?this.comment.toXML(serializer):"",this.variableNames.length?serializer.store(new List(this.variableNames)):"",this.codeHeader||"",this.codeMapping||"",this.translationsAsText(),Object.keys(this.declarations).reduce(function(xml,decl){
return xml+serializer.format('<input type="@"$>$%</input>',myself.declarations[decl][0],myself.declarations[decl][3]?' readonly="true"':"",myself.declarations[decl][1],myself.declarations[decl][2]?"<options>"+myself.declarations[decl][2]+"</options>":"")},""),this.body?serializer.store(this.body.expression):"",this.scripts.length>0?"<scripts>"+encodeScripts(this.scripts)+"</scripts>":"")},ArgMorph.prototype.toXML=function(){return"<l/>"},BooleanSlotMorph.prototype.toXML=function(){return"boolean"==typeof this.value?"<l><bool>"+this.value+"</bool></l>":"<l/>"},InputSlotMorph.prototype.toXML=function(serializer){return this.constant?serializer.format("<l><option>$</option></l>",this.constant):serializer.format("<l>$</l>",this.contents().text);
},TemplateSlotMorph.prototype.toXML=function(serializer){return serializer.format("<l>$</l>",this.contents())},CommandSlotMorph.prototype.toXML=function(serializer){var block=this.children[0];return block instanceof BlockMorph?block instanceof ReporterBlockMorph?serializer.format("<autolambda>%</autolambda>",serializer.store(block)):serializer.store(block):"<script></script>"},FunctionSlotMorph.prototype.toXML=CommandSlotMorph.prototype.toXML,MultiArgMorph.prototype.toXML=function(serializer){return serializer.format("<list>%</list>",serializer.store(this.inputs()))},ArgLabelMorph.prototype.toXML=function(serializer){return serializer.format("%",serializer.store(this.inputs()[0]));
},ColorSlotMorph.prototype.toXML=function(serializer){return serializer.format("<color>$,$,$,$</color>",this.color.r,this.color.g,this.color.b,this.color.a)},List.prototype.toXML=function(serializer,mediaContext){var xml,value,item;if(this.isLinked){if(xml='<list linked="linked" ~>',StageMorph.prototype.enableSublistIDs)return value=this.first,isNil(value)||(xml+=serializer.format("<item>%</item>","object"==typeof value?isSnapObject(value)?"":serializer.store(value,mediaContext):"boolean"==typeof value?serializer.format("<bool>$</bool>",value):serializer.format("<l>$</l>",value))),isNil(this.rest)||(xml+=serializer.store(this.rest,mediaContext)),xml+"</list>";
item=this;do value=item.first,isNil(value)||(xml+=serializer.format("<item>%</item>","object"==typeof value?isSnapObject(value)?"":serializer.store(value,mediaContext):"boolean"==typeof value?serializer.format("<bool>$</bool>",value):serializer.format("<l>$</l>",value))),item=item.rest;while(!isNil(item));return xml+"</list>"}return serializer.format("<list ~>%</list>",this.contents.reduce(function(xml,item){return xml+serializer.format("<item>%</item>","object"==typeof item?isSnapObject(item)?"":serializer.store(item,mediaContext):"boolean"==typeof item?serializer.format("<bool>$</bool>",item):serializer.format("<l>$</l>",item))},""))},Context.prototype.toXML=function(serializer){
return this.isContinuation?"":serializer.format("<context ~><inputs>%</inputs><variables>%</variables>%<receiver>%</receiver><origin>%</origin>%</context>",this.inputs.reduce(function(xml,input){return xml+serializer.format("<input>$</input>",input)},""),this.variables?serializer.store(this.variables):"",this.expression?serializer.store(this.expression):"",this.receiver?serializer.store(this.receiver):"",this.receiver?serializer.store(this.origin):"",this.outerContext?serializer.store(this.outerContext):"")},CommentMorph.prototype.toXML=function(serializer){var position,scale=SyntaxElementMorph.prototype.scale;return this.block?serializer.format('<comment w="@" collapsed="@">%</comment>',this.textWidth()/scale,this.isCollapsed,serializer.escape(this.text())):(position=this.parent?this.topLeft().subtract(this.parent.topLeft()):this.topLeft(),
serializer.format('<comment x="@" y="@" w="@" collapsed="@">%</comment>',position.x/scale,position.y/scale,this.textWidth()/scale,this.isCollapsed,serializer.escape(this.text())))},modules.cloud="2015-December-15";var Cloud,SnapCloud=new Cloud("https://snap.apps.miosoft.com/SnapCloud");Cloud.prototype.clear=function(){this.username=null,this.password=null,this.session=null,this.limo=null,this.route=null,this.api={}},Cloud.prototype.hasProtocol=function(){return 0===this.url.toLowerCase().indexOf("http")},Cloud.prototype.setRoute=function(username){var i,routes=20,userNum=0;for(i=0;i<username.length;i+=1)userNum+=username.charCodeAt(i);userNum=userNum%routes+1,
this.route=".sc1m"+(userNum<10?"0":"")+userNum},Cloud.prototype.signup=function(username,email,callBack,errorCall){var request=new XMLHttpRequest,myself=this;try{request.open("GET",(this.hasProtocol()?"":"http://")+this.url+"SignUp?Username="+encodeURIComponent(username)+"&Email="+encodeURIComponent(email),!0),request.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),request.withCredentials=!0,request.onreadystatechange=function(){4===request.readyState&&(request.responseText?0===request.responseText.indexOf("ERROR")?errorCall.call(this,request.responseText,"Signup"):callBack.call(null,request.responseText,"Signup"):errorCall.call(null,myself.url+"SignUp",localize("could not connect to:")));
},request.send(null)}catch(err){errorCall.call(this,err.toString(),"Snap!Cloud")}},Cloud.prototype.getPublicProject=function(id,callBack,errorCall){var request=new XMLHttpRequest,myself=this;try{request.open("GET",(this.hasProtocol()?"":"http://")+this.url+"RawPublic?"+id,!0),request.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),request.withCredentials=!0,request.onreadystatechange=function(){4===request.readyState&&(request.responseText?0===request.responseText.indexOf("ERROR")?errorCall.call(this,request.responseText):callBack.call(null,request.responseText):errorCall.call(null,myself.url+"Public",localize("could not connect to:")))},
request.send(null)}catch(err){errorCall.call(this,err.toString(),"Snap!Cloud")}},Cloud.prototype.resetPassword=function(username,callBack,errorCall){var request=new XMLHttpRequest,myself=this;try{request.open("GET",(this.hasProtocol()?"":"http://")+this.url+"ResetPW?Username="+encodeURIComponent(username),!0),request.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),request.withCredentials=!0,request.onreadystatechange=function(){4===request.readyState&&(request.responseText?0===request.responseText.indexOf("ERROR")?errorCall.call(this,request.responseText,"Reset Password"):callBack.call(null,request.responseText,"Reset Password"):errorCall.call(null,myself.url+"ResetPW",localize("could not connect to:")));
},request.send(null)}catch(err){errorCall.call(this,err.toString(),"Snap!Cloud")}},Cloud.prototype.login=function(username,password,callBack,errorCall){var request=new XMLHttpRequest,usr=JSON.stringify({__h:password,__u:username}),myself=this;this.setRoute(username);try{request.open("POST",(this.hasProtocol()?"":"http://")+this.url+"?SESSIONGLUE="+this.route,!0),request.setRequestHeader("Content-Type","application/json; charset=utf-8"),request.setRequestHeader("SESSIONGLUE",this.route),request.withCredentials=!0,request.onreadystatechange=function(){4===request.readyState&&(request.responseText?(myself.api=myself.parseAPI(request.responseText),myself.session=request.getResponseHeader("MioCracker").split(";")[0],
myself.limo=this.getResponseHeader("miocracker").substring(9,this.getResponseHeader("miocracker").indexOf("=")),myself.api.logout?(myself.username=username,myself.password=password,callBack.call(null,myself.api,"Snap!Cloud")):errorCall.call(null,request.responseText,"connection failed")):errorCall.call(null,myself.url,localize("could not connect to:")))},request.send(usr)}catch(err){errorCall.call(this,err.toString(),"Snap!Cloud")}},Cloud.prototype.reconnect=function(callBack,errorCall){return this.username&&this.password?void this.login(this.username,this.password,callBack,errorCall):void this.message("You are not logged in")},Cloud.prototype.saveProject=function(ide,callBack,errorCall){
var pdata,media,size,mediaSize,myself=this;if(ide.serializer.isCollectingMedia=!0,pdata=ide.serializer.serialize(ide.stage),media=ide.hasChangedMedia?ide.serializer.mediaXML(ide.projectName):null,ide.serializer.isCollectingMedia=!1,ide.serializer.flushMedia(),mediaSize=media?media.length:0,size=pdata.length+mediaSize,mediaSize>10485760)throw(new DialogBoxMorph).inform("Snap!Cloud - Cannot Save Project","The media inside this project exceeds 10 MB.\nPlease reduce the size of costumes or sounds.\n",ide.world(),ide.cloudIcon(null,new Color(180,0,0))),new Error("Project media exceeds 10 MB size limit");try{ide.serializer.parse(pdata)}catch(err){throw ide.showMessage("Serialization of program data failed:\n"+err),
new Error("Serialization of program data failed:\n"+err)}if(null!==media)try{ide.serializer.parse(media)}catch(err){throw ide.showMessage("Serialization of media failed:\n"+err),new Error("Serialization of media failed:\n"+err)}ide.serializer.isCollectingMedia=!1,ide.serializer.flushMedia(),ide.showMessage("Uploading "+Math.round(size/1024)+" KB..."),myself.reconnect(function(){myself.callService("saveProject",function(response,url){callBack.call(null,response,url),myself.disconnect(),ide.hasChangedMedia=!1},errorCall,[ide.projectName,pdata,media,pdata.length,media?media.length:0])},errorCall)},Cloud.prototype.getProjectList=function(callBack,errorCall){var myself=this;
this.reconnect(function(){myself.callService("getProjectList",function(response,url){callBack.call(null,response,url),myself.disconnect()},errorCall)},errorCall)},Cloud.prototype.changePassword=function(oldPW,newPW,callBack,errorCall){var myself=this;this.reconnect(function(){myself.callService("changePassword",function(response,url){callBack.call(null,response,url),myself.disconnect()},errorCall,[hex_sha512(oldPW),hex_sha512(newPW)])},errorCall)},Cloud.prototype.logout=function(callBack,errorCall){this.clear(),this.callService("logout",callBack,errorCall)},Cloud.prototype.disconnect=function(){this.callService("logout",nop,nop)},Cloud.prototype.callURL=function(url,callBack,errorCall){
var stickyUrl,request=new XMLHttpRequest,myself=this;try{stickyUrl=url+"&SESSIONGLUE="+this.route+"&_Limo="+this.limo,request.open("GET",stickyUrl,!0),request.withCredentials=!0,request.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),request.setRequestHeader("MioCracker",this.session),request.setRequestHeader("SESSIONGLUE",this.route),request.onreadystatechange=function(){if(4===request.readyState)if(request.responseText){var responseList=myself.parseResponse(request.responseText);callBack.call(null,responseList,url)}else errorCall.call(null,url,"no response from:")},request.send(null)}catch(err){errorCall.call(this,err.toString(),url)}},
Cloud.prototype.callService=function(serviceName,callBack,errorCall,args){var stickyUrl,postDict,request=new XMLHttpRequest,service=this.api[serviceName],myself=this;if(!this.session)return void errorCall.call(null,"You are not connected","Cloud");if(!service)return void errorCall.call(null,"service "+serviceName+" is not available","API");args&&args.length>0&&(postDict={},service.parameters.forEach(function(parm,idx){postDict[parm]=args[idx]}));try{stickyUrl=this.url+"/"+service.url+"&SESSIONGLUE="+this.route+"&_Limo="+this.limo,request.open(service.method,stickyUrl,!0),request.withCredentials=!0,request.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),
request.setRequestHeader("MioCracker",this.session),request.setRequestHeader("SESSIONGLUE",this.route),request.onreadystatechange=function(){if(4===request.readyState){var responseList=[];if(request.responseText&&0===request.responseText.indexOf("ERROR"))return void errorCall.call(this,request.responseText,localize("Service:")+" "+localize(serviceName));"login"===serviceName&&(myself.api=myself.parseAPI(request.responseText)),responseList="getRawProject"===serviceName?request.responseText:myself.parseResponse(request.responseText),callBack.call(null,responseList,service.url)}},request.send(this.encodeDict(postDict))}catch(err){errorCall.call(this,err.toString(),service.url);
}},Cloud.prototype.parseAPI=function(src){var services,api={};return services=src.split(" "),services.forEach(function(service){var parms,entries=service.split("&"),serviceDescription={};entries.forEach(function(entry){var pair=entry.split("="),key=decodeURIComponent(pair[0]).toLowerCase(),val=decodeURIComponent(pair[1]);"service"===key?api[val]=serviceDescription:"parameters"===key?(parms=val.split(","),(1!==parms.length||parms[0])&&(serviceDescription.parameters=parms)):serviceDescription[key]=val})}),api},Cloud.prototype.parseResponse=function(src){var lines,ans=[];return src?(lines=src.split(" "),lines.forEach(function(service){var entries=service.split("&"),dict={};
entries.forEach(function(entry){var pair=entry.split("="),key=decodeURIComponent(pair[0]),val=decodeURIComponent(pair[1]);dict[key]=val}),ans.push(dict)}),ans):ans},Cloud.prototype.parseDict=function(src){var dict={};return src?(src.split("&").forEach(function(entry){var pair=entry.split("="),key=decodeURIComponent(pair[0]),val=decodeURIComponent(pair[1]);dict[key]=val}),dict):dict},Cloud.prototype.encodeDict=function(dict){var pair,key,str="";if(!dict)return null;for(key in dict)dict.hasOwnProperty(key)&&(pair=encodeURIComponent(key)+"="+encodeURIComponent(dict[key]),str.length>0&&(str+="&"),str+=pair);return str},Cloud.prototype.message=function(string){alert(string);
};var hex_sha512=function(hex_sha512){function hex_sha512(s){return CryptoJS.SHA512(str2rstr_utf8(s)).toString(CryptoJS.enc.Hex)}function str2rstr_utf8(input){for(var x,y,output="",i=-1;++i<input.length;)x=input.charCodeAt(i),y=i+1<input.length?input.charCodeAt(i+1):0,55296<=x&&x<=56319&&56320<=y&&y<=57343&&(x=65536+((1023&x)<<10)+(1023&y),i++),x<=127?output+=String.fromCharCode(x):x<=2047?output+=String.fromCharCode(192|x>>>6&31,128|63&x):x<=65535?output+=String.fromCharCode(224|x>>>12&15,128|x>>>6&63,128|63&x):x<=2097151&&(output+=String.fromCharCode(240|x>>>18&7,128|x>>>12&63,128|x>>>6&63,128|63&x));return output}var CryptoJS=CryptoJS||function(a,g){var m={},e=m.lib={},q=e.Base=function(){
function a(){}return{extend:function(b){a.prototype=this;var d=new a;return b&&d.mixIn(b),d.$super=this,d},create:function(){var a=this.extend();return a.init.apply(a,arguments),a},init:function(){},mixIn:function(a){for(var k in a)a.hasOwnProperty(k)&&(this[k]=a[k]);a.hasOwnProperty("toString")&&(this.toString=a.toString)},clone:function(){return this.$super.extend(this)}}}(),r=e.WordArray=q.extend({init:function(a,b){a=this.words=a||[],this.sigBytes=b!=g?b:4*a.length},toString:function(a){return(a||n).stringify(this)},concat:function(a){var b=this.words,d=a.words,c=this.sigBytes,a=a.sigBytes;if(this.clamp(),c%4)for(var i=0;i<a;i++)b[c+i>>>2]|=(d[i>>>2]>>>24-8*(i%4)&255)<<24-8*((c+i)%4);else if(65535<d.length)for(i=0;i<a;i+=4)b[c+i>>>2]=d[i>>>2];else b.push.apply(b,d);
return this.sigBytes+=a,this},clamp:function(){var k=this.words,b=this.sigBytes;k[b>>>2]&=4294967295<<32-8*(b%4),k.length=a.ceil(b/4)},clone:function(){var a=q.clone.call(this);return a.words=this.words.slice(0),a},random:function(k){for(var b=[],d=0;d<k;d+=4)b.push(4294967296*a.random()|0);return r.create(b,k)}}),y=m.enc={},n=y.Hex={stringify:function(a){for(var b=a.words,a=a.sigBytes,d=[],c=0;c<a;c++){var i=b[c>>>2]>>>24-8*(c%4)&255;d.push((i>>>4).toString(16)),d.push((15&i).toString(16))}return d.join("")},parse:function(a){for(var b=a.length,d=[],c=0;c<b;c+=2)d[c>>>3]|=parseInt(a.substr(c,2),16)<<24-4*(c%8);return r.create(d,b/2)}},l=y.Latin1={stringify:function(a){
for(var b=a.words,a=a.sigBytes,d=[],c=0;c<a;c++)d.push(String.fromCharCode(b[c>>>2]>>>24-8*(c%4)&255));return d.join("")},parse:function(a){for(var b=a.length,d=[],c=0;c<b;c++)d[c>>>2]|=(255&a.charCodeAt(c))<<24-8*(c%4);return r.create(d,b)}},da=y.Utf8={stringify:function(a){try{return decodeURIComponent(escape(l.stringify(a)))}catch(b){throw Error("Malformed UTF-8 data")}},parse:function(a){return l.parse(unescape(encodeURIComponent(a)))}},h=e.BufferedBlockAlgorithm=q.extend({reset:function(){this._data=r.create(),this._nDataBytes=0},_append:function(a){"string"==typeof a&&(a=da.parse(a)),this._data.concat(a),this._nDataBytes+=a.sigBytes},_process:function(k){
var b=this._data,d=b.words,c=b.sigBytes,i=this.blockSize,l=c/(4*i),l=k?a.ceil(l):a.max((0|l)-this._minBufferSize,0),k=l*i,c=a.min(4*k,c);if(k){for(var h=0;h<k;h+=i)this._doProcessBlock(d,h);h=d.splice(0,k),b.sigBytes-=c}return r.create(h,c)},clone:function(){var a=q.clone.call(this);return a._data=this._data.clone(),a},_minBufferSize:0});e.Hasher=h.extend({init:function(){this.reset()},reset:function(){h.reset.call(this),this._doReset()},update:function(a){return this._append(a),this._process(),this},finalize:function(a){return a&&this._append(a),this._doFinalize(),this._hash},clone:function(){var a=h.clone.call(this);return a._hash=this._hash.clone(),a},blockSize:16,
_createHelper:function(a){return function(b,d){return a.create(d).finalize(b)}},_createHmacHelper:function(a){return function(b,d){return ea.HMAC.create(a,d).finalize(b)}}});var ea=m.algo={};return m}(Math);!function(a){var g=CryptoJS,m=g.lib,e=m.Base,q=m.WordArray,g=g.x64={};g.Word=e.extend({init:function(a,e){this.high=a,this.low=e}}),g.WordArray=e.extend({init:function(e,y){e=this.words=e||[],this.sigBytes=y!=a?y:8*e.length},toX32:function(){for(var a=this.words,e=a.length,n=[],l=0;l<e;l++){var g=a[l];n.push(g.high),n.push(g.low)}return q.create(n,this.sigBytes)},clone:function(){for(var a=e.clone.call(this),g=a.words=this.words.slice(0),n=g.length,l=0;l<n;l++)g[l]=g[l].clone();
return a}})}(),function(){function a(){return q.create.apply(q,arguments)}var g=CryptoJS,m=g.lib.Hasher,e=g.x64,q=e.Word,r=e.WordArray,e=g.algo,y=[a(1116352408,3609767458),a(1899447441,602891725),a(3049323471,3964484399),a(3921009573,2173295548),a(961987163,4081628472),a(1508970993,3053834265),a(2453635748,2937671579),a(2870763221,3664609560),a(3624381080,2734883394),a(310598401,1164996542),a(607225278,1323610764),a(1426881987,3590304994),a(1925078388,4068182383),a(2162078206,991336113),a(2614888103,633803317),a(3248222580,3479774868),a(3835390401,2666613458),a(4022224774,944711139),a(264347078,2341262773),a(604807628,2007800933),a(770255983,1495990901),a(1249150122,1856431235),a(1555081692,3175218132),a(1996064986,2198950837),a(2554220882,3999719339),a(2821834349,766784016),a(2952996808,2566594879),a(3210313671,3203337956),a(3336571891,1034457026),a(3584528711,2466948901),a(113926993,3758326383),a(338241895,168717936),a(666307205,1188179964),a(773529912,1546045734),a(1294757372,1522805485),a(1396182291,2643833823),a(1695183700,2343527390),a(1986661051,1014477480),a(2177026350,1206759142),a(2456956037,344077627),a(2730485921,1290863460),a(2820302411,3158454273),a(3259730800,3505952657),a(3345764771,106217008),a(3516065817,3606008344),a(3600352804,1432725776),a(4094571909,1467031594),a(275423344,851169720),a(430227734,3100823752),a(506948616,1363258195),a(659060556,3750685593),a(883997877,3785050280),a(958139571,3318307427),a(1322822218,3812723403),a(1537002063,2003034995),a(1747873779,3602036899),a(1955562222,1575990012),a(2024104815,1125592928),a(2227730452,2716904306),a(2361852424,442776044),a(2428436474,593698344),a(2756734187,3733110249),a(3204031479,2999351573),a(3329325298,3815920427),a(3391569614,3928383900),a(3515267271,566280711),a(3940187606,3454069534),a(4118630271,4000239992),a(116418474,1914138554),a(174292421,2731055270),a(289380356,3203993006),a(460393269,320620315),a(685471733,587496836),a(852142971,1086792851),a(1017036298,365543100),a(1126000580,2618297676),a(1288033470,3409855158),a(1501505948,4234509866),a(1607167915,987167468),a(1816402316,1246189591)],n=[];
!function(){for(var l=0;80>l;l++)n[l]=a()}(),e=e.SHA512=m.extend({_doReset:function(){this._hash=r.create([a(1779033703,4089235720),a(3144134277,2227873595),a(1013904242,4271175723),a(2773480762,1595750129),a(1359893119,2917565137),a(2600822924,725511199),a(528734635,4215389547),a(1541459225,327033209)])},_doProcessBlock:function(a,e){for(var h=this._hash.words,g=h[0],k=h[1],b=h[2],d=h[3],c=h[4],i=h[5],m=h[6],h=h[7],q=g.high,r=g.low,W=k.high,K=k.low,X=b.high,L=b.low,Y=d.high,M=d.low,Z=c.high,N=c.low,$=i.high,O=i.low,aa=m.high,P=m.low,ba=h.high,Q=h.low,t=q,o=r,E=W,C=K,F=X,D=L,T=Y,G=M,u=Z,p=N,R=$,H=O,S=aa,I=P,U=ba,J=Q,v=0;80>v;v++){var z=n[v];if(16>v)var s=z.high=0|a[e+2*v],f=z.low=0|a[e+2*v+1];else{
var s=n[v-15],f=s.high,w=s.low,s=(w<<31|f>>>1)^(w<<24|f>>>8)^f>>>7,w=(f<<31|w>>>1)^(f<<24|w>>>8)^(f<<25|w>>>7),B=n[v-2],f=B.high,j=B.low,B=(j<<13|f>>>19)^(f<<3|j>>>29)^f>>>6,j=(f<<13|j>>>19)^(j<<3|f>>>29)^(f<<26|j>>>6),f=n[v-7],V=f.high,A=n[v-16],x=A.high,A=A.low,f=w+f.low,s=s+V+(f>>>0<w>>>0?1:0),f=f+j,s=s+B+(f>>>0<j>>>0?1:0),f=f+A,s=s+x+(f>>>0<A>>>0?1:0);z.high=s,z.low=f}var V=u&R^~u&S,A=p&H^~p&I,z=t&E^t&F^E&F,fa=o&C^o&D^C&D,w=(o<<4|t>>>28)^(t<<30|o>>>2)^(t<<25|o>>>7),B=(t<<4|o>>>28)^(o<<30|t>>>2)^(o<<25|t>>>7),j=y[v],ga=j.high,ca=j.low,j=J+((u<<18|p>>>14)^(u<<14|p>>>18)^(p<<23|u>>>9)),x=U+((p<<18|u>>>14)^(p<<14|u>>>18)^(u<<23|p>>>9))+(j>>>0<J>>>0?1:0),j=j+A,x=x+V+(j>>>0<A>>>0?1:0),j=j+ca,x=x+ga+(j>>>0<ca>>>0?1:0),j=j+f,x=x+s+(j>>>0<f>>>0?1:0),f=B+fa,z=w+z+(f>>>0<B>>>0?1:0),U=S,J=I,S=R,I=H,R=u,H=p,p=G+j|0,u=T+x+(p>>>0<G>>>0?1:0)|0,T=F,G=D,F=E,D=C,E=t,C=o,o=j+f|0,t=x+z+(o>>>0<j>>>0?1:0)|0;
}r=g.low=r+o|0,g.high=q+t+(r>>>0<o>>>0?1:0)|0,K=k.low=K+C|0,k.high=W+E+(K>>>0<C>>>0?1:0)|0,L=b.low=L+D|0,b.high=X+F+(L>>>0<D>>>0?1:0)|0,M=d.low=M+G|0,d.high=Y+T+(M>>>0<G>>>0?1:0)|0,N=c.low=N+p|0,c.high=Z+u+(N>>>0<p>>>0?1:0)|0,O=i.low=O+H|0,i.high=$+R+(O>>>0<H>>>0?1:0)|0,P=m.low=P+I|0,m.high=aa+S+(P>>>0<I>>>0?1:0)|0,Q=h.low=Q+J|0,h.high=ba+U+(Q>>>0<J>>>0?1:0)|0},_doFinalize:function(){var a=this._data,e=a.words,h=8*this._nDataBytes,g=8*a.sigBytes;e[g>>>5]|=128<<24-g%32,e[(g+128>>>10<<5)+31]=h,a.sigBytes=4*e.length,this._process(),this._hash=this._hash.toX32()},blockSize:32}),g.SHA512=m._createHelper(e),g.HmacSHA512=m._createHmacHelper(e)}();return hex_sha512}({}),saveAs=saveAs||function(e){
if(!("undefined"==typeof e||"undefined"!=typeof navigator&&/MSIE [1-9]\./.test(navigator.userAgent))){var t=e.document,n=function(){return e.URL||e.webkitURL||e},r=t.createElementNS("http://www.w3.org/1999/xhtml","a"),o="download"in r,a=function(e){var t=new MouseEvent("click");e.dispatchEvent(t)},i=/constructor/i.test(e.HTMLElement)||e.safari,f=/CriOS\/[\d]+/.test(navigator.userAgent),u=function(t){(e.setImmediate||e.setTimeout)(function(){throw t},0)},s="application/octet-stream",d=4e4,c=function(e){var t=function(){"string"==typeof e?n().revokeObjectURL(e):e.remove()};setTimeout(t,d)},l=function(e,t,n){t=[].concat(t);for(var r=t.length;r--;){var o=e["on"+t[r]];
if("function"==typeof o)try{o.call(e,n||e)}catch(a){u(a)}}},p=function(e){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob([String.fromCharCode(65279),e],{type:e.type}):e},v=function(t,u,d){d||(t=p(t));var y,v=this,w=t.type,m=w===s,h=function(){l(v,"writestart progress write writeend".split(" "))},S=function(){if((f||m&&i)&&e.FileReader){var r=new FileReader;return r.onloadend=function(){var t=f?r.result:r.result.replace(/^data:[^;]*;/,"data:attachment/file;"),n=e.open(t,"_blank");n||(e.location.href=t),t=void 0,v.readyState=v.DONE,h()},r.readAsDataURL(t),void(v.readyState=v.INIT)}if(y||(y=n().createObjectURL(t)),
m)e.location.href=y;else{var o=e.open(y,"_blank");o||(e.location.href=y)}v.readyState=v.DONE,h(),c(y)};return v.readyState=v.INIT,o?(y=n().createObjectURL(t),void setTimeout(function(){r.href=y,r.download=u,a(r),h(),c(y),v.readyState=v.DONE})):void S()},w=v.prototype,m=function(e,t,n){return new v(e,t||e.name||"download",n)};return"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(e,t,n){return t=t||e.name||"download",n||(e=p(e)),navigator.msSaveOrOpenBlob(e,t)}:(w.abort=function(){},w.readyState=w.INIT=0,w.WRITING=1,w.DONE=2,w.error=w.onwritestart=w.onprogress=w.onwrite=w.onabort=w.onerror=w.onwriteend=null,m)}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);
"undefined"!=typeof module&&module.exports?module.exports.saveAs=saveAs:"undefined"!=typeof define&&null!==define&&null!==define.amd&&define("FileSaver.js",[],function(){return saveAs}),snapsrc.snap.tao=function(message){alert(message)},disableRetinaSupport();var world,elementCanvas=$container.find(".world");return world=new WorldMorph(elementCanvas[0]),snapsrc.snap.world=world,world.worldCanvas.focus(),(new IDE_Morph).openIn(world),world.panelLeft=panel_Left,world.xmlString=getSnapProjectScript,world.leftReducer=function(){return panel_Left.setPaletteWidth(1),1},world.leftExpand=function(){return panel_Left.setPaletteWidth(200),200},$container.find(".world").css({
position:"absolute"}),world.width=world.clientWidth,world.height=world.clientHeight,$container.find(".world")[1]&&$container.find($container.find(".world")[1].remove()),world.importator=function(){var myself=world.children[0],inp=document.createElement("input");myself.filePicker&&(document.body.removeChild(myself.filePicker),myself.filePicker=null),inp.type="file",inp.style.color="transparent",inp.style.backgroundColor="transparent",inp.style.border="none",inp.style.outline="none",inp.style.position="absolute",inp.style.top="0px",inp.style.left="0px",inp.style.width="0px",inp.style.height="0px",inp.style.display="none",inp.addEventListener("change",function(){
document.body.removeChild(inp),myself.filePicker=null,world.hand.processDrop(inp.files)},!1),document.body.appendChild(inp),myself.filePicker=inp,inp.click()},loop(),panel_Left},snapsrc}),define("SnapForTao/runtime/js/renderer",["taoQtiItem/portableLib/jquery_2_1_1","taoQtiItem/portableLib/OAT/util/html","SnapForTao/runtime/js/lib/snapsrc"],function($,html,snapsrc){"use strict";function renderSnap(id,$container,config){var snapInstance;$container.find(".snapy").append('<canvas class="world" tabindex="1" ><p>Your browser doesn\'t support canvas.</p></canvas>'),snapInstance=snapsrc.snap(id,$container,config),"nonVisible"==config.panelSizer?snapsrc.snap.world.leftReducer():snapsrc.snap.world.leftExpand(),
$container.find(".world").css("position","relative")}return{render:function(id,container,config,assetManager){var $container=$(container);renderSnap(id,$container,config),html.render($container.find(".prompt"))},renderSnap:function(id,container,config){renderSnap(id,$(container),config)}}}),function(){function n(n,t,e){e=(e||0)-1;for(var r=n?n.length:0;++e<r;)if(n[e]===t)return e;return-1}function t(t,e){var r=typeof e;if(t=t.l,"boolean"==r||null==e)return t[e]?0:-1;"number"!=r&&"string"!=r&&(r="object");var u="number"==r?e:b+e;return t=(t=t[r])&&t[u],"object"==r?t&&-1<n(t,e)?0:-1:t?0:-1}function e(n){var t=this.l,e=typeof n;if("boolean"==e||null==n)t[n]=!0;else{
"number"!=e&&"string"!=e&&(e="object");var r="number"==e?n:b+n,t=t[e]||(t[e]={});"object"==e?(t[r]||(t[r]=[])).push(n):t[r]=!0}}function r(n){return n.charCodeAt(0)}function u(n,t){for(var e=n.m,r=t.m,u=-1,o=e.length;++u<o;){var a=e[u],i=r[u];if(a!==i){if(a>i||"undefined"==typeof a)return 1;if(a<i||"undefined"==typeof i)return-1}}return n.n-t.n}function o(n){var t=-1,r=n.length,u=n[0],o=n[r/2|0],a=n[r-1];if(u&&"object"==typeof u&&o&&"object"==typeof o&&a&&"object"==typeof a)return!1;for(u=l(),u.false=u.null=u.true=u.undefined=!1,o=l(),o.k=n,o.l=u,o.push=e;++t<r;)o.push(n[t]);return o}function a(n){return"\\"+Y[n]}function i(){return v.pop()||[]}function l(){return y.pop()||{
k:null,l:null,m:null,false:!1,n:0,null:!1,number:null,object:null,push:null,string:null,true:!1,undefined:!1,o:null}}function f(n){return"function"!=typeof n.toString&&"string"==typeof(n+"")}function c(n){n.length=0,v.length<w&&v.push(n)}function p(n){var t=n.l;t&&p(t),n.k=n.l=n.m=n.object=n.number=n.string=n.o=null,y.length<w&&y.push(n)}function s(n,t,e){t||(t=0),"undefined"==typeof e&&(e=n?n.length:0);var r=-1;e=e-t||0;for(var u=Array(0>e?0:e);++r<e;)u[r]=n[t+r];return u}function g(e){function v(n){return n&&"object"==typeof n&&!qe(n)&&we.call(n,"__wrapped__")?n:new y(n)}function y(n,t){this.__chain__=!!t,this.__wrapped__=n}function w(n){function t(){if(r){
var n=s(r);je.apply(n,arguments)}if(this instanceof t){var o=nt(e.prototype),n=e.apply(o,n||arguments);return xt(n)?n:o}return e.apply(u,n||arguments)}var e=n[0],r=n[2],u=n[4];return ze(t,n),t}function Y(n,t,e,r,u){if(e){var o=e(n);if("undefined"!=typeof o)return o}if(!xt(n))return n;var a=he.call(n);if(!V[a]||!Le.nodeClass&&f(n))return n;var l=Te[a];switch(a){case L:case z:return new l(+n);case W:case M:return new l(n);case J:return o=l(n.source,S.exec(n)),o.lastIndex=n.lastIndex,o}if(a=qe(n),t){var p=!r;r||(r=i()),u||(u=i());for(var g=r.length;g--;)if(r[g]==n)return u[g];o=a?l(n.length):{}}else o=a?s(n):Ye({},n);return a&&(we.call(n,"index")&&(o.index=n.index),
we.call(n,"input")&&(o.input=n.input)),t?(r.push(n),u.push(o),(a?Xe:tr)(n,function(n,a){o[a]=Y(n,t,e,r,u)}),p&&(c(r),c(u)),o):o}function nt(n){return xt(n)?Se(n):{}}function tt(n,t,e){if("function"!=typeof n)return Ht;if("undefined"==typeof t||!("prototype"in n))return n;var r=n.__bindData__;if("undefined"==typeof r&&(Le.funcNames&&(r=!n.name),r=r||!Le.funcDecomp,!r)){var u=be.call(n);Le.funcNames||(r=!A.test(u)),r||(r=B.test(u),ze(n,r))}if(!1===r||!0!==r&&1&r[1])return n;switch(e){case 1:return function(e){return n.call(t,e)};case 2:return function(e,r){return n.call(t,e,r)};case 3:return function(e,r,u){return n.call(t,e,r,u)};case 4:return function(e,r,u,o){
return n.call(t,e,r,u,o)}}return Mt(n,t)}function et(n){function t(){var n=l?a:this;if(u){var h=s(u);je.apply(h,arguments)}return(o||c)&&(h||(h=s(arguments)),o&&je.apply(h,o),c&&h.length<i)?(r|=16,et([e,p?r:-4&r,h,null,a,i])):(h||(h=arguments),f&&(e=n[g]),this instanceof t?(n=nt(e.prototype),h=e.apply(n,h),xt(h)?h:n):e.apply(n,h))}var e=n[0],r=n[1],u=n[2],o=n[3],a=n[4],i=n[5],l=1&r,f=2&r,c=4&r,p=8&r,g=e;return ze(t,n),t}function rt(e,r){var u=-1,a=ht(),i=e?e.length:0,l=i>=_&&a===n,f=[];if(l){var c=o(r);c?(a=t,r=c):l=!1}for(;++u<i;)c=e[u],0>a(r,c)&&f.push(c);return l&&p(r),f}function ot(n,t,e,r){r=(r||0)-1;for(var u=n?n.length:0,o=[];++r<u;){var a=n[r];if(a&&"object"==typeof a&&"number"==typeof a.length&&(qe(a)||dt(a))){
t||(a=ot(a,t,e));var i=-1,l=a.length,f=o.length;for(o.length+=l;++i<l;)o[f++]=a[i]}else e||o.push(a)}return o}function at(n,t,e,r,u,o){if(e){var a=e(n,t);if("undefined"!=typeof a)return!!a}if(n===t)return 0!==n||1/n==1/t;if(n===n&&!(n&&X[typeof n]||t&&X[typeof t]))return!1;if(null==n||null==t)return n===t;var l=he.call(n),p=he.call(t);if(l==T&&(l=G),p==T&&(p=G),l!=p)return!1;switch(l){case L:case z:return+n==+t;case W:return n!=+n?t!=+t:0==n?1/n==1/t:n==+t;case J:case M:return n==ie(t)}if(p=l==$,!p){var s=we.call(n,"__wrapped__"),g=we.call(t,"__wrapped__");if(s||g)return at(s?n.__wrapped__:n,g?t.__wrapped__:t,e,r,u,o);if(l!=G||!Le.nodeClass&&(f(n)||f(t)))return!1;
if(l=!Le.argsObject&&dt(n)?oe:n.constructor,s=!Le.argsObject&&dt(t)?oe:t.constructor,l!=s&&!(jt(l)&&l instanceof l&&jt(s)&&s instanceof s)&&"constructor"in n&&"constructor"in t)return!1}for(l=!u,u||(u=i()),o||(o=i()),s=u.length;s--;)if(u[s]==n)return o[s]==t;var h=0,a=!0;if(u.push(n),o.push(t),p){if(s=n.length,h=t.length,(a=h==s)||r)for(;h--;)if(p=s,g=t[h],r)for(;p--&&!(a=at(n[p],g,e,r,u,o)););else if(!(a=at(n[h],g,e,r,u,o)))break}else nr(t,function(t,i,l){return we.call(l,i)?(h++,a=we.call(n,i)&&at(n[i],t,e,r,u,o)):void 0}),a&&!r&&nr(n,function(n,t,e){return we.call(e,t)?a=-1<--h:void 0});return u.pop(),o.pop(),l&&(c(u),c(o)),a}function it(n,t,e,r,u){(qe(t)?Dt:tr)(t,function(t,o){
var a,i,l=t,f=n[o];if(t&&((i=qe(t))||er(t))){for(l=r.length;l--;)if(a=r[l]==t){f=u[l];break}if(!a){var c;e&&(l=e(f,t),c="undefined"!=typeof l)&&(f=l),c||(f=i?qe(f)?f:[]:er(f)?f:{}),r.push(t),u.push(f),c||it(f,t,e,r,u)}}else e&&(l=e(f,t),"undefined"==typeof l&&(l=t)),"undefined"!=typeof l&&(f=l);n[o]=f})}function lt(n,t){return n+de(Fe()*(t-n+1))}function ft(e,r,u){var a=-1,l=ht(),f=e?e.length:0,s=[],g=!r&&f>=_&&l===n,h=u||g?i():s;for(g&&(h=o(h),l=t);++a<f;){var v=e[a],y=u?u(v,a,e):v;(r?!a||h[h.length-1]!==y:0>l(h,y))&&((u||g)&&h.push(y),s.push(v))}return g?(c(h.k),p(h)):u&&c(h),s}function ct(n){return function(t,e,r){var u={};if(e=v.createCallback(e,r,3),qe(t)){
r=-1;for(var o=t.length;++r<o;){var a=t[r];n(u,a,e(a,r,t),t)}}else Xe(t,function(t,r,o){n(u,t,e(t,r,o),o)});return u}}function pt(n,t,e,r,u,o){var a=1&t,i=4&t,l=16&t,f=32&t;if(!(2&t||jt(n)))throw new le;l&&!e.length&&(t&=-17,l=e=!1),f&&!r.length&&(t&=-33,f=r=!1);var c=n&&n.__bindData__;return c&&!0!==c?(c=s(c),c[2]&&(c[2]=s(c[2])),c[3]&&(c[3]=s(c[3])),!a||1&c[1]||(c[4]=u),!a&&1&c[1]&&(t|=8),!i||4&c[1]||(c[5]=o),l&&je.apply(c[2]||(c[2]=[]),e),f&&Ee.apply(c[3]||(c[3]=[]),r),c[1]|=t,pt.apply(null,c)):(1==t||17===t?w:et)([n,t,e,r,u,o])}function st(){Q.h=F,Q.b=Q.c=Q.g=Q.i="",Q.e="t",Q.j=!0;for(var n,t=0;n=arguments[t];t++)for(var e in n)Q[e]=n[e];t=Q.a,Q.d=/^[^,]+/.exec(t)[0],
n=ee,t="return function("+t+"){",e=Q;var r="var n,t="+e.d+",E="+e.e+";if(!t)return E;"+e.i+";";e.b?(r+="var u=t.length;n=-1;if("+e.b+"){",Le.unindexedChars&&(r+="if(s(t)){t=t.split('')}"),r+="while(++n<u){"+e.g+";}}else{"):Le.nonEnumArgs&&(r+="var u=t.length;n=-1;if(u&&p(t)){while(++n<u){n+='';"+e.g+";}}else{"),Le.enumPrototypes&&(r+="var G=typeof t=='function';"),Le.enumErrorProps&&(r+="var F=t===k||t instanceof Error;");var u=[];if(Le.enumPrototypes&&u.push('!(G&&n=="prototype")'),Le.enumErrorProps&&u.push('!(F&&(n=="message"||n=="name"))'),e.j&&e.f)r+="var C=-1,D=B[typeof t]&&v(t),u=D?D.length:0;while(++C<u){n=D[C];",u.length&&(r+="if("+u.join("&&")+"){"),
r+=e.g+";",u.length&&(r+="}"),r+="}";else if(r+="for(n in t){",e.j&&u.push("m.call(t, n)"),u.length&&(r+="if("+u.join("&&")+"){"),r+=e.g+";",u.length&&(r+="}"),r+="}",Le.nonEnumShadows){for(r+="if(t!==A){var i=t.constructor,r=t===(i&&i.prototype),f=t===J?I:t===k?j:L.call(t),x=y[f];",k=0;7>k;k++)r+="n='"+e.h[k]+"';if((!(r&&x[n])&&m.call(t,n))",e.j||(r+="||(!x[n]&&t[n]!==A[n])"),r+="){"+e.g+"}";r+="}"}return(e.b||Le.nonEnumArgs)&&(r+="}"),r+=e.c+";return E",n("d,j,k,m,o,p,q,s,v,A,B,y,I,J,L",t+r+"}")(tt,q,ce,we,d,dt,qe,kt,Q.f,pe,X,$e,M,se,he)}function gt(n){return Ve[n]}function ht(){var t=(t=v.indexOf)===zt?n:t;return t}function vt(n){return"function"==typeof n&&ve.test(n);
}function yt(n){var t,e;return!(!(n&&he.call(n)==G&&(t=n.constructor,!jt(t)||t instanceof t))||!Le.argsClass&&dt(n)||!Le.nodeClass&&f(n))&&(Le.ownLast?(nr(n,function(n,t,r){return e=we.call(r,t),!1}),!1!==e):(nr(n,function(n,t){e=t}),"undefined"==typeof e||we.call(n,e)))}function mt(n){return He[n]}function dt(n){return n&&"object"==typeof n&&"number"==typeof n.length&&he.call(n)==T||!1}function bt(n,t,e){var r=We(n),u=r.length;for(t=tt(t,e,3);u--&&(e=r[u],!1!==t(n[e],e,n)););return n}function _t(n){var t=[];return nr(n,function(n,e){jt(n)&&t.push(e)}),t.sort()}function wt(n){for(var t=-1,e=We(n),r=e.length,u={};++t<r;){var o=e[t];u[n[o]]=o}return u}function jt(n){
return"function"==typeof n}function xt(n){return!(!n||!X[typeof n])}function Ct(n){return"number"==typeof n||n&&"object"==typeof n&&he.call(n)==W||!1}function kt(n){return"string"==typeof n||n&&"object"==typeof n&&he.call(n)==M||!1}function Et(n){for(var t=-1,e=We(n),r=e.length,u=Zt(r);++t<r;)u[t]=n[e[t]];return u}function Ot(n,t,e){var r=-1,u=ht(),o=n?n.length:0,a=!1;return e=(0>e?Be(0,o+e):e)||0,qe(n)?a=-1<u(n,t,e):"number"==typeof o?a=-1<(kt(n)?n.indexOf(t,e):u(n,t,e)):Xe(n,function(n){return++r<e?void 0:!(a=n===t)}),a}function St(n,t,e){var r=!0;if(t=v.createCallback(t,e,3),qe(n)){e=-1;for(var u=n.length;++e<u&&(r=!!t(n[e],e,n)););}else Xe(n,function(n,e,u){
return r=!!t(n,e,u)});return r}function At(n,t,e){var r=[];if(t=v.createCallback(t,e,3),qe(n)){e=-1;for(var u=n.length;++e<u;){var o=n[e];t(o,e,n)&&r.push(o)}}else Xe(n,function(n,e,u){t(n,e,u)&&r.push(n)});return r}function It(n,t,e){if(t=v.createCallback(t,e,3),!qe(n)){var r;return Xe(n,function(n,e,u){return t(n,e,u)?(r=n,!1):void 0}),r}e=-1;for(var u=n.length;++e<u;){var o=n[e];if(t(o,e,n))return o}}function Dt(n,t,e){if(t&&"undefined"==typeof e&&qe(n)){e=-1;for(var r=n.length;++e<r&&!1!==t(n[e],e,n););}else Xe(n,t,e);return n}function Nt(n,t,e){var r=n,u=n?n.length:0;if(t=t&&"undefined"==typeof e?t:tt(t,e,3),qe(n))for(;u--&&!1!==t(n[u],u,n););else{if("number"!=typeof u)var o=We(n),u=o.length;else Le.unindexedChars&&kt(n)&&(r=n.split(""));
Xe(n,function(n,e,a){return e=o?o[--u]:--u,t(r[e],e,a)})}return n}function Bt(n,t,e){var r=-1,u=n?n.length:0,o=Zt("number"==typeof u?u:0);if(t=v.createCallback(t,e,3),qe(n))for(;++r<u;)o[r]=t(n[r],r,n);else Xe(n,function(n,e,u){o[++r]=t(n,e,u)});return o}function Pt(n,t,e){var u=-1/0,o=u;if("function"!=typeof t&&e&&e[t]===n&&(t=null),null==t&&qe(n)){e=-1;for(var a=n.length;++e<a;){var i=n[e];i>o&&(o=i)}}else t=null==t&&kt(n)?r:v.createCallback(t,e,3),Xe(n,function(n,e,r){e=t(n,e,r),e>u&&(u=e,o=n)});return o}function Rt(n,t,e,r){var u=3>arguments.length;if(t=v.createCallback(t,r,4),qe(n)){var o=-1,a=n.length;for(u&&(e=n[++o]);++o<a;)e=t(e,n[o],o,n)}else Xe(n,function(n,r,o){
e=u?(u=!1,n):t(e,n,r,o)});return e}function Ft(n,t,e,r){var u=3>arguments.length;return t=v.createCallback(t,r,4),Nt(n,function(n,r,o){e=u?(u=!1,n):t(e,n,r,o)}),e}function Tt(n){var t=-1,e=n?n.length:0,r=Zt("number"==typeof e?e:0);return Dt(n,function(n){var e=lt(0,++t);r[t]=r[e],r[e]=n}),r}function $t(n,t,e){var r;if(t=v.createCallback(t,e,3),qe(n)){e=-1;for(var u=n.length;++e<u&&!(r=t(n[e],e,n)););}else Xe(n,function(n,e,u){return!(r=t(n,e,u))});return!!r}function Lt(n,t,e){var r=0,u=n?n.length:0;if("number"!=typeof t&&null!=t){var o=-1;for(t=v.createCallback(t,e,3);++o<u&&t(n[o],o,n);)r++}else if(r=t,null==r||e)return n?n[0]:h;return s(n,0,Pe(Be(0,r),u))}function zt(t,e,r){
if("number"==typeof r){var u=t?t.length:0;r=0>r?Be(0,u+r):r||0}else if(r)return r=Kt(t,e),t[r]===e?r:-1;return n(t,e,r)}function qt(n,t,e){if("number"!=typeof t&&null!=t){var r=0,u=-1,o=n?n.length:0;for(t=v.createCallback(t,e,3);++u<o&&t(n[u],u,n);)r++}else r=null==t||e?1:Be(0,t);return s(n,r)}function Kt(n,t,e,r){var u=0,o=n?n.length:u;for(e=e?v.createCallback(e,r,1):Ht,t=e(t);u<o;)r=u+o>>>1,e(n[r])<t?u=r+1:o=r;return u}function Wt(n,t,e,r){return"boolean"!=typeof t&&null!=t&&(r=e,e="function"!=typeof t&&r&&r[t]===n?null:t,t=!1),null!=e&&(e=v.createCallback(e,r,3)),ft(n,t,e)}function Gt(){for(var n=1<arguments.length?arguments:arguments[0],t=-1,e=n?Pt(ar(n,"length")):0,r=Zt(0>e?0:e);++t<e;)r[t]=ar(n,t);
return r}function Jt(n,t){var e=-1,r=n?n.length:0,u={};for(t||!r||qe(n[0])||(t=[]);++e<r;){var o=n[e];t?u[o]=t[e]:o&&(u[o[0]]=o[1])}return u}function Mt(n,t){return 2<arguments.length?pt(n,17,s(arguments,2),null,t):pt(n,1,null,null,t)}function Vt(n,t,e){var r,u,o,a,i,l,f,c=0,p=!1,s=!0;if(!jt(n))throw new le;if(t=Be(0,t)||0,!0===e)var g=!0,s=!1;else xt(e)&&(g=e.leading,p="maxWait"in e&&(Be(t,e.maxWait)||0),s="trailing"in e?e.trailing:s);var v=function(){var e=t-(ir()-a);0<e?l=Ce(v,e):(u&&me(u),e=f,u=l=f=h,e&&(c=ir(),o=n.apply(i,r),l||u||(r=i=null)))},y=function(){l&&me(l),u=l=f=h,(s||p!==t)&&(c=ir(),o=n.apply(i,r),l||u||(r=i=null))};return function(){if(r=arguments,
a=ir(),i=this,f=s&&(l||!g),!1===p)var e=g&&!l;else{u||g||(c=a);var h=p-(a-c),m=0>=h;m?(u&&(u=me(u)),c=a,o=n.apply(i,r)):u||(u=Ce(y,h))}return m&&l?l=me(l):l||t===p||(l=Ce(v,t)),e&&(m=!0,o=n.apply(i,r)),!m||l||u||(r=i=null),o}}function Ht(n){return n}function Ut(n,t,e){var r=!0,u=t&&_t(t);t&&(e||u.length)||(null==e&&(e=t),o=y,t=n,n=v,u=_t(t)),!1===e?r=!1:xt(e)&&"chain"in e&&(r=e.chain);var o=n,a=jt(o);Dt(u,function(e){var u=n[e]=t[e];a&&(o.prototype[e]=function(){var t=this.__chain__,e=this.__wrapped__,a=[e];if(je.apply(a,arguments),a=u.apply(n,a),r||t){if(e===a&&xt(a))return this;a=new o(a),a.__chain__=t}return a})})}function Qt(){}function Xt(n){return function(t){
return t[n]}}function Yt(){return this.__wrapped__}e=e?ut.defaults(Z.Object(),e,ut.pick(Z,R)):Z;var Zt=e.Array,ne=e.Boolean,te=e.Date,ee=e.Function,re=e.Math,ue=e.Number,oe=e.Object,ae=e.RegExp,ie=e.String,le=e.TypeError,fe=[],ce=e.Error.prototype,pe=oe.prototype,se=ie.prototype,ge=e._,he=pe.toString,ve=ae("^"+ie(he).replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/toString| for [^\]]+/g,".*?")+"$"),ye=re.ceil,me=e.clearTimeout,de=re.floor,be=ee.prototype.toString,_e=vt(_e=oe.getPrototypeOf)&&_e,we=pe.hasOwnProperty,je=fe.push,xe=pe.propertyIsEnumerable,Ce=e.setTimeout,ke=fe.splice,Ee=fe.unshift,Oe=function(){try{var n={},t=vt(t=oe.defineProperty)&&t,e=t(n,n,n)&&t;
}catch(r){}return e}(),Se=vt(Se=oe.create)&&Se,Ae=vt(Ae=Zt.isArray)&&Ae,Ie=e.isFinite,De=e.isNaN,Ne=vt(Ne=oe.keys)&&Ne,Be=re.max,Pe=re.min,Re=e.parseInt,Fe=re.random,Te={};Te[$]=Zt,Te[L]=ne,Te[z]=te,Te[K]=ee,Te[G]=oe,Te[W]=ue,Te[J]=ae,Te[M]=ie;var $e={};$e[$]=$e[z]=$e[W]={constructor:!0,toLocaleString:!0,toString:!0,valueOf:!0},$e[L]=$e[M]={constructor:!0,toString:!0,valueOf:!0},$e[q]=$e[K]=$e[J]={constructor:!0,toString:!0},$e[G]={constructor:!0},function(){for(var n=F.length;n--;){var t,e=F[n];for(t in $e)we.call($e,t)&&!we.call($e[t],e)&&($e[t][e]=!1)}}(),y.prototype=v.prototype;var Le=v.support={};!function(){var n=function(){this.x=1},t={0:1,length:1},r=[];
n.prototype={valueOf:1,y:1};for(var u in new n)r.push(u);for(u in arguments);Le.argsClass=he.call(arguments)==T,Le.argsObject=arguments.constructor==oe&&!(arguments instanceof Zt),Le.enumErrorProps=xe.call(ce,"message")||xe.call(ce,"name"),Le.enumPrototypes=xe.call(n,"prototype"),Le.funcDecomp=!vt(e.WinRTError)&&B.test(g),Le.funcNames="string"==typeof ee.name,Le.nonEnumArgs=0!=u,Le.nonEnumShadows=!/valueOf/.test(r),Le.ownLast="x"!=r[0],Le.spliceObjects=(fe.splice.call(t,0,1),!t[0]),Le.unindexedChars="xx"!="x"[0]+oe("x")[0];try{Le.nodeClass=!(he.call(document)==G&&!({toString:0}+""))}catch(o){Le.nodeClass=!0}}(1),v.templateSettings={escape:/<%-([\s\S]+?)%>/g,evaluate:/<%([\s\S]+?)%>/g,
interpolate:I,variable:"",imports:{_:v}},Se||(nt=function(){function n(){}return function(t){if(xt(t)){n.prototype=t;var r=new n;n.prototype=null}return r||e.Object()}}());var ze=Oe?function(n,t){U.value=t,Oe(n,"__bindData__",U)}:Qt;Le.argsClass||(dt=function(n){return n&&"object"==typeof n&&"number"==typeof n.length&&we.call(n,"callee")&&!xe.call(n,"callee")||!1});var qe=Ae||function(n){return n&&"object"==typeof n&&"number"==typeof n.length&&he.call(n)==$||!1},Ke=st({a:"z",e:"[]",i:"if(!(B[typeof z]))return E",g:"E.push(n)"}),We=Ne?function(n){return xt(n)?Le.enumPrototypes&&"function"==typeof n||Le.nonEnumArgs&&n.length&&dt(n)?Ke(n):Ne(n):[]}:Ke,Ge={a:"g,e,K",
i:"e=e&&typeof K=='undefined'?e:d(e,K,3)",b:"typeof u=='number'",v:We,g:"if(e(t[n],n,g)===false)return E"},Je={a:"z,H,l",i:"var a=arguments,b=0,c=typeof l=='number'?2:a.length;while(++b<c){t=a[b];if(t&&B[typeof t]){",v:We,g:"if(typeof E[n]=='undefined')E[n]=t[n]",c:"}}"},Me={i:"if(!B[typeof t])return E;"+Ge.i,b:!1},Ve={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},He=wt(Ve),Ue=ae("("+We(He).join("|")+")","g"),Qe=ae("["+We(Ve).join("")+"]","g"),Xe=st(Ge),Ye=st(Je,{i:Je.i.replace(";",";if(c>3&&typeof a[c-2]=='function'){var e=d(a[--c-1],a[c--],2)}else if(c>2&&typeof a[c-1]=='function'){e=a[--c]}"),g:"E[n]=e?e(E[n],t[n]):t[n]"}),Ze=st(Je),nr=st(Ge,Me,{
j:!1}),tr=st(Ge,Me);jt(/x/)&&(jt=function(n){return"function"==typeof n&&he.call(n)==K});var er=_e?function(n){if(!n||he.call(n)!=G||!Le.argsClass&&dt(n))return!1;var t=n.valueOf,e=vt(t)&&(e=_e(t))&&_e(e);return e?n==e||_e(n)==e:yt(n)}:yt,rr=ct(function(n,t,e){we.call(n,e)?n[e]++:n[e]=1}),ur=ct(function(n,t,e){(we.call(n,e)?n[e]:n[e]=[]).push(t)}),or=ct(function(n,t,e){n[e]=t}),ar=Bt,ir=vt(ir=te.now)&&ir||function(){return(new te).getTime()},lr=8==Re(j+"08")?Re:function(n,t){return Re(kt(n)?n.replace(D,""):n,t||0)};return v.after=function(n,t){if(!jt(t))throw new le;return function(){return 1>--n?t.apply(this,arguments):void 0}},v.assign=Ye,v.at=function(n){var t=arguments,e=-1,r=ot(t,!0,!1,1),t=t[2]&&t[2][t[1]]===n?1:r.length,u=Zt(t);
for(Le.unindexedChars&&kt(n)&&(n=n.split(""));++e<t;)u[e]=n[r[e]];return u},v.bind=Mt,v.bindAll=function(n){for(var t=1<arguments.length?ot(arguments,!0,!1,1):_t(n),e=-1,r=t.length;++e<r;){var u=t[e];n[u]=pt(n[u],1,null,null,n)}return n},v.bindKey=function(n,t){return 2<arguments.length?pt(t,19,s(arguments,2),null,n):pt(t,3,null,null,n)},v.chain=function(n){return n=new y(n),n.__chain__=!0,n},v.compact=function(n){for(var t=-1,e=n?n.length:0,r=[];++t<e;){var u=n[t];u&&r.push(u)}return r},v.compose=function(){for(var n=arguments,t=n.length;t--;)if(!jt(n[t]))throw new le;return function(){for(var t=arguments,e=n.length;e--;)t=[n[e].apply(this,t)];return t[0]}},
v.constant=function(n){return function(){return n}},v.countBy=rr,v.create=function(n,t){var e=nt(n);return t?Ye(e,t):e},v.createCallback=function(n,t,e){var r=typeof n;if(null==n||"function"==r)return tt(n,t,e);if("object"!=r)return Xt(n);var u=We(n),o=u[0],a=n[o];return 1!=u.length||a!==a||xt(a)?function(t){for(var e=u.length,r=!1;e--&&(r=at(t[u[e]],n[u[e]],null,!0)););return r}:function(n){return n=n[o],a===n&&(0!==a||1/a==1/n)}},v.curry=function(n,t){return t="number"==typeof t?t:+t||n.length,pt(n,4,null,null,null,t)},v.debounce=Vt,v.defaults=Ze,v.defer=function(n){if(!jt(n))throw new le;var t=s(arguments,1);return Ce(function(){n.apply(h,t)},1)},v.delay=function(n,t){
if(!jt(n))throw new le;var e=s(arguments,2);return Ce(function(){n.apply(h,e)},t)},v.difference=function(n){return rt(n,ot(arguments,!0,!0,1))},v.filter=At,v.flatten=function(n,t,e,r){return"boolean"!=typeof t&&null!=t&&(r=e,e="function"!=typeof t&&r&&r[t]===n?null:t,t=!1),null!=e&&(n=Bt(n,e,r)),ot(n,t)},v.forEach=Dt,v.forEachRight=Nt,v.forIn=nr,v.forInRight=function(n,t,e){var r=[];nr(n,function(n,t){r.push(t,n)});var u=r.length;for(t=tt(t,e,3);u--&&!1!==t(r[u--],r[u],n););return n},v.forOwn=tr,v.forOwnRight=bt,v.functions=_t,v.groupBy=ur,v.indexBy=or,v.initial=function(n,t,e){var r=0,u=n?n.length:0;if("number"!=typeof t&&null!=t){var o=u;for(t=v.createCallback(t,e,3);o--&&t(n[o],o,n);)r++;
}else r=null==t||e?1:t||r;return s(n,0,Pe(Be(0,u-r),u))},v.intersection=function(){for(var e=[],r=-1,u=arguments.length,a=i(),l=ht(),f=l===n,s=i();++r<u;){var g=arguments[r];(qe(g)||dt(g))&&(e.push(g),a.push(f&&g.length>=_&&o(r?e[r]:s)))}var f=e[0],h=-1,v=f?f.length:0,y=[];n:for(;++h<v;){var m=a[0],g=f[h];if(0>(m?t(m,g):l(s,g))){for(r=u,(m||s).push(g);--r;)if(m=a[r],0>(m?t(m,g):l(e[r],g)))continue n;y.push(g)}}for(;u--;)(m=a[u])&&p(m);return c(a),c(s),y},v.invert=wt,v.invoke=function(n,t){var e=s(arguments,2),r=-1,u="function"==typeof t,o=n?n.length:0,a=Zt("number"==typeof o?o:0);return Dt(n,function(n){a[++r]=(u?t:n[t]).apply(n,e)}),a},v.keys=We,v.map=Bt,v.mapValues=function(n,t,e){
var r={};return t=v.createCallback(t,e,3),tr(n,function(n,e,u){r[e]=t(n,e,u)}),r},v.max=Pt,v.memoize=function(n,t){if(!jt(n))throw new le;var e=function(){var r=e.cache,u=t?t.apply(this,arguments):b+arguments[0];return we.call(r,u)?r[u]:r[u]=n.apply(this,arguments)};return e.cache={},e},v.merge=function(n){var t=arguments,e=2;if(!xt(n))return n;if("number"!=typeof t[2]&&(e=t.length),3<e&&"function"==typeof t[e-2])var r=tt(t[--e-1],t[e--],2);else 2<e&&"function"==typeof t[e-1]&&(r=t[--e]);for(var t=s(arguments,1,e),u=-1,o=i(),a=i();++u<e;)it(n,t[u],r,o,a);return c(o),c(a),n},v.min=function(n,t,e){var u=1/0,o=u;if("function"!=typeof t&&e&&e[t]===n&&(t=null),null==t&&qe(n)){
e=-1;for(var a=n.length;++e<a;){var i=n[e];i<o&&(o=i)}}else t=null==t&&kt(n)?r:v.createCallback(t,e,3),Xe(n,function(n,e,r){e=t(n,e,r),e<u&&(u=e,o=n)});return o},v.omit=function(n,t,e){var r={};if("function"!=typeof t){var u=[];nr(n,function(n,t){u.push(t)});for(var u=rt(u,ot(arguments,!0,!1,1)),o=-1,a=u.length;++o<a;){var i=u[o];r[i]=n[i]}}else t=v.createCallback(t,e,3),nr(n,function(n,e,u){t(n,e,u)||(r[e]=n)});return r},v.once=function(n){var t,e;if(!jt(n))throw new le;return function(){return t?e:(t=!0,e=n.apply(this,arguments),n=null,e)}},v.pairs=function(n){for(var t=-1,e=We(n),r=e.length,u=Zt(r);++t<r;){var o=e[t];u[t]=[o,n[o]]}return u},v.partial=function(n){
return pt(n,16,s(arguments,1))},v.partialRight=function(n){return pt(n,32,null,s(arguments,1))},v.pick=function(n,t,e){var r={};if("function"!=typeof t)for(var u=-1,o=ot(arguments,!0,!1,1),a=xt(n)?o.length:0;++u<a;){var i=o[u];i in n&&(r[i]=n[i])}else t=v.createCallback(t,e,3),nr(n,function(n,e,u){t(n,e,u)&&(r[e]=n)});return r},v.pluck=ar,v.property=Xt,v.pull=function(n){for(var t=arguments,e=0,r=t.length,u=n?n.length:0;++e<r;)for(var o=-1,a=t[e];++o<u;)n[o]===a&&(ke.call(n,o--,1),u--);return n},v.range=function(n,t,e){n=+n||0,e="number"==typeof e?e:+e||1,null==t&&(t=n,n=0);var r=-1;t=Be(0,ye((t-n)/(e||1)));for(var u=Zt(t);++r<t;)u[r]=n,n+=e;return u},v.reject=function(n,t,e){
return t=v.createCallback(t,e,3),At(n,function(n,e,r){return!t(n,e,r)})},v.remove=function(n,t,e){var r=-1,u=n?n.length:0,o=[];for(t=v.createCallback(t,e,3);++r<u;)e=n[r],t(e,r,n)&&(o.push(e),ke.call(n,r--,1),u--);return o},v.rest=qt,v.shuffle=Tt,v.sortBy=function(n,t,e){var r=-1,o=qe(t),a=n?n.length:0,f=Zt("number"==typeof a?a:0);for(o||(t=v.createCallback(t,e,3)),Dt(n,function(n,e,u){var a=f[++r]=l();o?a.m=Bt(t,function(t){return n[t]}):(a.m=i())[0]=t(n,e,u),a.n=r,a.o=n}),a=f.length,f.sort(u);a--;)n=f[a],f[a]=n.o,o||c(n.m),p(n);return f},v.tap=function(n,t){return t(n),n},v.throttle=function(n,t,e){var r=!0,u=!0;if(!jt(n))throw new le;return!1===e?r=!1:xt(e)&&(r="leading"in e?e.leading:r,
u="trailing"in e?e.trailing:u),H.leading=r,H.maxWait=t,H.trailing=u,Vt(n,t,H)},v.times=function(n,t,e){n=-1<(n=+n)?n:0;var r=-1,u=Zt(n);for(t=tt(t,e,1);++r<n;)u[r]=t(r);return u},v.toArray=function(n){return n&&"number"==typeof n.length?Le.unindexedChars&&kt(n)?n.split(""):s(n):Et(n)},v.transform=function(n,t,e,r){var u=qe(n);if(null==e)if(u)e=[];else{var o=n&&n.constructor;e=nt(o&&o.prototype)}return t&&(t=v.createCallback(t,r,4),(u?Xe:tr)(n,function(n,r,u){return t(e,n,r,u)})),e},v.union=function(){return ft(ot(arguments,!0,!0))},v.uniq=Wt,v.values=Et,v.where=At,v.without=function(n){return rt(n,s(arguments,1))},v.wrap=function(n,t){return pt(t,16,[n])},v.xor=function(){
for(var n=-1,t=arguments.length;++n<t;){var e=arguments[n];if(qe(e)||dt(e))var r=r?ft(rt(r,e).concat(rt(e,r))):e}return r||[]},v.zip=Gt,v.zipObject=Jt,v.collect=Bt,v.drop=qt,v.each=Dt,v.eachRight=Nt,v.extend=Ye,v.methods=_t,v.object=Jt,v.select=At,v.tail=qt,v.unique=Wt,v.unzip=Gt,Ut(v),v.clone=function(n,t,e,r){return"boolean"!=typeof t&&null!=t&&(r=e,e=t,t=!1),Y(n,t,"function"==typeof e&&tt(e,r,1))},v.cloneDeep=function(n,t,e){return Y(n,!0,"function"==typeof t&&tt(t,e,1))},v.contains=Ot,v.escape=function(n){return null==n?"":ie(n).replace(Qe,gt)},v.every=St,v.find=It,v.findIndex=function(n,t,e){var r=-1,u=n?n.length:0;for(t=v.createCallback(t,e,3);++r<u;)if(t(n[r],r,n))return r;
return-1},v.findKey=function(n,t,e){var r;return t=v.createCallback(t,e,3),tr(n,function(n,e,u){return t(n,e,u)?(r=e,!1):void 0}),r},v.findLast=function(n,t,e){var r;return t=v.createCallback(t,e,3),Nt(n,function(n,e,u){return t(n,e,u)?(r=n,!1):void 0}),r},v.findLastIndex=function(n,t,e){var r=n?n.length:0;for(t=v.createCallback(t,e,3);r--;)if(t(n[r],r,n))return r;return-1},v.findLastKey=function(n,t,e){var r;return t=v.createCallback(t,e,3),bt(n,function(n,e,u){return t(n,e,u)?(r=e,!1):void 0}),r},v.has=function(n,t){return!!n&&we.call(n,t)},v.identity=Ht,v.indexOf=zt,v.isArguments=dt,v.isArray=qe,v.isBoolean=function(n){return!0===n||!1===n||n&&"object"==typeof n&&he.call(n)==L||!1;
},v.isDate=function(n){return n&&"object"==typeof n&&he.call(n)==z||!1},v.isElement=function(n){return n&&1===n.nodeType||!1},v.isEmpty=function(n){var t=!0;if(!n)return t;var e=he.call(n),r=n.length;return e==$||e==M||(Le.argsClass?e==T:dt(n))||e==G&&"number"==typeof r&&jt(n.splice)?!r:(tr(n,function(){return t=!1}),t)},v.isEqual=function(n,t,e,r){return at(n,t,"function"==typeof e&&tt(e,r,2))},v.isFinite=function(n){return Ie(n)&&!De(parseFloat(n))},v.isFunction=jt,v.isNaN=function(n){return Ct(n)&&n!=+n},v.isNull=function(n){return null===n},v.isNumber=Ct,v.isObject=xt,v.isPlainObject=er,v.isRegExp=function(n){return n&&X[typeof n]&&he.call(n)==J||!1},v.isString=kt,
v.isUndefined=function(n){return"undefined"==typeof n},v.lastIndexOf=function(n,t,e){var r=n?n.length:0;for("number"==typeof e&&(r=(0>e?Be(0,r+e):Pe(e,r-1))+1);r--;)if(n[r]===t)return r;return-1},v.mixin=Ut,v.noConflict=function(){return e._=ge,this},v.noop=Qt,v.now=ir,v.parseInt=lr,v.random=function(n,t,e){var r=null==n,u=null==t;return null==e&&("boolean"==typeof n&&u?(e=n,n=1):u||"boolean"!=typeof t||(e=t,u=!0)),r&&u&&(t=1),n=+n||0,u?(t=n,n=0):t=+t||0,e||n%1||t%1?(e=Fe(),Pe(n+e*(t-n+parseFloat("1e-"+((e+"").length-1))),t)):lt(n,t)},v.reduce=Rt,v.reduceRight=Ft,v.result=function(n,t){if(n){var e=n[t];return jt(e)?n[t]():e}},v.runInContext=g,v.size=function(n){
var t=n?n.length:0;return"number"==typeof t?t:We(n).length},v.some=$t,v.sortedIndex=Kt,v.template=function(n,t,e){var r=v.templateSettings;n=ie(n||""),e=Ze({},e,r);var u,o=Ze({},e.imports,r.imports),r=We(o),o=Et(o),i=0,l=e.interpolate||N,f="__p+='",l=ae((e.escape||N).source+"|"+l.source+"|"+(l===I?O:N).source+"|"+(e.evaluate||N).source+"|$","g");n.replace(l,function(t,e,r,o,l,c){return r||(r=o),f+=n.slice(i,c).replace(P,a),e&&(f+="'+__e("+e+")+'"),l&&(u=!0,f+="';"+l+";\n__p+='"),r&&(f+="'+((__t=("+r+"))==null?'':__t)+'"),i=c+t.length,t}),f+="';",l=e=e.variable,l||(e="obj",f="with("+e+"){"+f+"}"),f=(u?f.replace(x,""):f).replace(C,"$1").replace(E,"$1;"),f="function("+e+"){"+(l?"":e+"||("+e+"={});")+"var __t,__p='',__e=_.escape"+(u?",__j=Array.prototype.join;function print(){__p+=__j.call(arguments,'')}":";")+f+"return __p}";
try{var c=ee(r,"return "+f).apply(h,o)}catch(p){throw p.source=f,p}return t?c(t):(c.source=f,c)},v.unescape=function(n){return null==n?"":ie(n).replace(Ue,mt)},v.uniqueId=function(n){var t=++m;return ie(null==n?"":n)+t},v.all=St,v.any=$t,v.detect=It,v.findWhere=It,v.foldl=Rt,v.foldr=Ft,v.include=Ot,v.inject=Rt,Ut(function(){var n={};return tr(v,function(t,e){v.prototype[e]||(n[e]=t)}),n}(),!1),v.first=Lt,v.last=function(n,t,e){var r=0,u=n?n.length:0;if("number"!=typeof t&&null!=t){var o=u;for(t=v.createCallback(t,e,3);o--&&t(n[o],o,n);)r++}else if(r=t,null==r||e)return n?n[u-1]:h;return s(n,Be(0,u-r))},v.sample=function(n,t,e){return n&&"number"!=typeof n.length?n=Et(n):Le.unindexedChars&&kt(n)&&(n=n.split("")),
null==t||e?n?n[lt(0,n.length-1)]:h:(n=Tt(n),n.length=Pe(Be(0,t),n.length),n)},v.take=Lt,v.head=Lt,tr(v,function(n,t){var e="sample"!==t;v.prototype[t]||(v.prototype[t]=function(t,r){var u=this.__chain__,o=n(this.__wrapped__,t,r);return u||null!=t&&(!r||e&&"function"==typeof t)?new y(o,u):o})}),v.VERSION="2.4.1",v.prototype.chain=function(){return this.__chain__=!0,this},v.prototype.toString=function(){return ie(this.__wrapped__)},v.prototype.value=Yt,v.prototype.valueOf=Yt,Xe(["join","pop","shift"],function(n){var t=fe[n];v.prototype[n]=function(){var n=this.__chain__,e=t.apply(this.__wrapped__,arguments);return n?new y(e,n):e}}),Xe(["push","reverse","sort","unshift"],function(n){
var t=fe[n];v.prototype[n]=function(){return t.apply(this.__wrapped__,arguments),this}}),Xe(["concat","slice","splice"],function(n){var t=fe[n];v.prototype[n]=function(){return new y(t.apply(this.__wrapped__,arguments),this.__chain__)}}),Le.spliceObjects||Xe(["pop","shift","splice"],function(n){var t=fe[n],e="splice"==n;v.prototype[n]=function(){var n=this.__chain__,r=this.__wrapped__,u=t.apply(r,arguments);return 0===r.length&&delete r[0],n||e?new y(u,n):u}}),v}var h,v=[],y=[],m=0,d={},b=+new Date+"",_=75,w=40,j=" \t\v\f \ufeff\n\r\u2028\u2029 ᠎             　",x=/\b__p\+='';/g,C=/\b(__p\+=)''\+/g,E=/(__e\(.*?\)|\b__t\))\+'';/g,O=/\$\{([^\\}]*(?:\\.[^\\}]*)*)\}/g,S=/\w*$/,A=/^\s*function[ \n\r\t]+\w/,I=/<%=([\s\S]+?)%>/g,D=RegExp("^["+j+"]*0+(?=.$)"),N=/($^)/,B=/\bthis\b/,P=/['\n\r\t\u2028\u2029\\]/g,R="Array Boolean Date Error Function Math Number Object RegExp String _ attachEvent clearTimeout isFinite isNaN parseInt setTimeout".split(" "),F="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" "),T="[object Arguments]",$="[object Array]",L="[object Boolean]",z="[object Date]",q="[object Error]",K="[object Function]",W="[object Number]",G="[object Object]",J="[object RegExp]",M="[object String]",V={};
V[K]=!1,V[T]=V[$]=V[L]=V[z]=V[W]=V[G]=V[J]=V[M]=!0;var H={leading:!1,maxWait:0,trailing:!1},U={configurable:!1,enumerable:!1,value:null,writable:!1},Q={a:"",b:null,c:"",d:"",e:"",v:null,g:"",h:null,support:null,i:"",j:!1},X={boolean:!1,function:!0,object:!0,number:!1,string:!1,undefined:!1},Y={"\\":"\\","'":"'","\n":"n","\r":"r","\t":"t","\u2028":"u2028","\u2029":"u2029"},Z=X[typeof window]&&window||this,nt=X[typeof exports]&&exports&&!exports.nodeType&&exports,tt=X[typeof module]&&module&&!module.nodeType&&module,et=tt&&tt.exports===nt&&nt,rt=X[typeof global]&&global;!rt||rt.global!==rt&&rt.window!==rt||(Z=rt);var ut=g();"function"==typeof define&&"object"==typeof define.amd&&define.amd?(Z._=ut,
define("taoQtiItem/portableLib/lodash",[],function(){return ut})):nt&&tt?et?(tt.exports=ut)._=ut:nt._=ut:Z._=ut}.call(this),define("taoQtiItem/portableLib/OAT/util/EventMgr",["taoQtiItem/portableLib/lodash"],function(_){"use strict";return function(){var events={};this.get=function(event){return event&&events[event]?_.clone(events[event]):[]},this.on=function(event,callback){var name,tokens=event.split(".");tokens[0]&&(name=tokens.shift(),events[name]=events[name]||[],events[name].push({ns:tokens,callback:callback}))},this.off=function(event){event&&events[event]&&(events[event]=[])},this.trigger=function(event,data){events[event]&&_.forEach(events[event],function(e){
e.callback.apply({type:event,ns:[]},data)})}}}),define("taoQtiItem/portableLib/OAT/util/event",["taoQtiItem/portableLib/OAT/util/EventMgr"],function(EventMgr){return{addEventMgr:function(instance){var eventMgr=new EventMgr;instance.on=function(event,callback){eventMgr.on(event,callback)},instance.off=function(event){eventMgr.off(event)},instance.trigger=function(event,data){eventMgr.trigger(event,data)}}}}),define("SnapForTao/runtime/SnapForTao.amd",["qtiCustomInteractionContext","taoQtiItem/portableLib/jquery_2_1_1","SnapForTao/runtime/js/renderer","SnapForTao/runtime/js/lib/snapsrc","taoQtiItem/portableLib/OAT/util/event","taoQtiItem/portableLib/lodash"],function(qtiCustomInteractionContext,$,renderer,snapsrc,event,_){
"use strict";var SnapForTao={id:-1,getTypeIdentifier:function(){return"SnapForTao"},initialize:function(id,dom,config,assetManager){event.addEventMgr(this);var customSnapContext={};event.addEventMgr(customSnapContext);var _this=this;this.id=id,this.dom=dom,this.config=config||{},this.config.customSnapContext=customSnapContext,customSnapContext.on("rawDefinitionChange",function(value){_this.trigger("scriptSaverChange",[value])}),renderer.render(this.id,this.dom,this.config,assetManager),qtiCustomInteractionContext.notifyReady(this),this.on("panelSizerChange",function(level){_this.config.panelSizer=level,renderer.renderSnap(_this.id,_this.dom,_this.config),"nonVisible"==level?snapsrc.snap.world.leftReducer():snapsrc.snap.world.leftExpand();
}),this.on("testLimiterChange",function(limiter){_this.config.testlimiter=limiter,renderer.renderSnap(_this.id,_this.dom,_this.config)}),this.on("scriptImporterChange",function(){snapsrc.snap.world.importator(),renderer.renderSnap(_this.id,_this.dom,_this.config)})},setResponse:function(response){},getResponse:function(){var $container=$(this.dom),canvasArrLenght=$container.find(".world").length;canvasArrLenght-=1;var canvas=$container.find(".world")[canvasArrLenght],dataURL=canvas.toDataURL(),value=dataURL+$container.find(".compteur").html();return{base:{string:value}}},resetResponse:function(){},destroy:function(config){var $container=$(this.dom);$container.off().empty();
},setSerializedState:function(state){},getSerializedState:function(){return{}}};qtiCustomInteractionContext.register(SnapForTao)}),define(["SnapForTao/runtime/SnapForTao.amd"],function(PCI){return PCI});
//# sourceMappingURL=SnapForTao.min.js.map